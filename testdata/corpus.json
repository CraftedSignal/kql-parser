[
  {
    "source": "AzureMonitor",
    "name": "Cache hit ratio",
    "query": "// Author: Microsoft Azure\n// Display name: Cache hit ratio\n// Description: Statistics of Cache hit/miss ratio.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Diagnostics\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize Cache_Miss=countif(Cache  == \"miss\"), Cache_Hit=countif(Cache == \"hit\") by bin(TimeGenerated, 15m)\n| extend Ratio=Cache_Hit / (Cache_Hit + Cache_Miss)\n| project-away Cache_Hit , Cache_Miss \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Client TLS versions",
    "query": "// Author: Microsoft Azure\n// Display name: Client TLS versions\n// Description: Breakdown of client TLS versions in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Diagnostics\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize count(CorrelationId) by ClientTlsVersion, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Error reasons breakdown",
    "query": "// Author: Microsoft Azure\n// Display name: Error reasons breakdown\n// Description: Breakdown of all error reasons in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Errors\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| where IsRequestSuccess == false\n| summarize count(CorrelationId) by LastErrorReason, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Get failed requests due to issues not related to the backend",
    "query": "// Author: Microsoft Azure\n// Display name: Get failed requests due to issues not related to the backend\n// Description: Get the logs of failed requests due to issues not related to the backend (e.g., API Mangement policies configuration, rate limit exceeded, client disconnection).\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Errors\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| where IsRequestSuccess == false\n| where isnull(BackendResponseCode) or BackendResponseCode \u003c 400\n| where ResponseCode \u003e= 400"
  },
  {
    "source": "AzureMonitor",
    "name": "Get failed requests due to issues related to the backend",
    "query": "// Author: Microsoft Azure\n// Display name: Get failed requests due to issues related to the backend\n// Description: Get the logs of failed requests due to backend issues.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Errors\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| where IsRequestSuccess == false\n| where BackendResponseCode \u003e= 400"
  },
  {
    "source": "AzureMonitor",
    "name": "Last 100 failed requests",
    "query": "// Author: Microsoft Azure\n// Display name: Last 100 failed requests\n// Description: Get the logs of the last 100 failed requests.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Errors\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| where IsRequestSuccess == false\n| top 100 by TimeGenerated desc| where ResponseCode \u003e= 400"
  },
  {
    "source": "AzureMonitor",
    "name": "Backend latency",
    "query": "// Author: Microsoft Azure\n// Display name: Backend latency\n// Description: Statistics of time (in miliseconds) spent in backend IO.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Latency\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize Average=avg(BackendTime), Median=percentile(BackendTime, 50), 90th_Percentile=percentile(BackendTime, 90) by bin(TimeGenerated, 15m) \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Client latency",
    "query": "// Author: Microsoft Azure\n// Display name: Client latency\n// Description: Statistics of time (in miliseconds) spent in client IO.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Latency\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize Average=avg(ClientTime), Median=percentile(ClientTime, 50), 90th_Percentile=percentile(ClientTime, 90) by bin(TimeGenerated, 15m) \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Overall latency",
    "query": "// Author: Microsoft Azure\n// Display name: Overall latency\n// Description: Statistics of overall latency (in miliseconds) between the time API Mangement starts receiving a request and the time API Management finishes sending the response back to the client.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Latency\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize Average=avg(TotalTime), Median=percentile(TotalTime, 50), 90th_Percentile=percentile(TotalTime, 90) by bin(TimeGenerated, 15m) \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Bandwidth consumed",
    "query": "// Author: Microsoft Azure\n// Display name: Bandwidth consumed\n// Description: Total bandwidth consumed in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Performance\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| extend bandwidth = RequestSize + ResponseSize \n| summarize sum(bandwidth) by bin(TimeGenerated, 15m), _ResourceId \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Logs of the last 100 calls",
    "query": "// Author: Microsoft Azure\n// Display name: Logs of the last 100 calls\n// Description: Get the logs of the most recent 100 calls in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Usage\n\nApiManagementGatewayLogs\n| top 100 by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Number of calls by APIs",
    "query": "// Author: Microsoft Azure\n// Display name: Number of calls by APIs\n// Description: View the number of calls per API in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Usage\n\n//Calls by API ID\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize count(CorrelationId) by ApiId"
  },
  {
    "source": "AzureMonitor",
    "name": "Number of requests",
    "query": "// Author: Microsoft Azure\n// Display name: Number of requests\n// Description: Count the total number of calls across all APIs in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Usage\n\n//Total number of call per resource\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize count(CorrelationId) by _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Request sizes",
    "query": "// Author: Microsoft Azure\n// Display name: Request sizes\n// Description: Statistics of request sizes in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Usage\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize Average=avg(RequestSize), Median=percentile(RequestSize, 50), 90th_Percentile=percentile(RequestSize, 90) by bin(TimeGenerated, 5m) \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Response sizes",
    "query": "// Author: Microsoft Azure\n// Display name: Response sizes\n// Description: Statistics of response sizes in the last 24 hours.\n// Categories: Azure Resources\n// Resource types: API Management services\n// Topic: Usage\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| summarize Average=avg(ResponseSize), Median=percentile(ResponseSize, 50), 90th_Percentile=percentile(ResponseSize, 90) by bin(TimeGenerated, 5m) \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "App logs for each App Service",
    "query": "// Author: Microsoft Azure\n// Display name: App logs for each App Service\n// Description: Breakdown of log levels for each App Service.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: App Logs\n\nAppServiceAppLogs \n| project CustomLevel, _ResourceId\n| summarize count() by CustomLevel, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Count app logs by severity",
    "query": "// Author: Microsoft Azure\n// Display name: Count app logs by severity\n// Description: Bar chart of app log severities over time.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: App Logs\n\nAppServiceAppLogs \n| summarize count()  by CustomLevel, bin(TimeGenerated, 1h), _ResourceId\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Error and exception count",
    "query": "// Author: Microsoft Azure\n// Display name: Error and exception count\n// Description: Show a column chart of the number of the logs containing warnings or errors in the last hour, per application.\n// Categories: Azure Resources,Applications\n// Resource types: App Services\n// Topic: App Logs\n\nFunctionAppLogs \n| where TimeGenerated \u003e ago(1h)\n| where Level == \"Warning\" or Level == \"Error\"\n| summarize count_per_app = count() by _ResourceId\n| sort by count_per_app desc \n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Show application logs from Function Apps",
    "query": "// Author: Microsoft Azure\n// Display name: Show application logs from Function Apps\n// Description: A list of application logs, sorted by time (latest logs shown first).\n// Categories: Azure Resources,Applications\n// Resource types: App Services\n// Topic: App Logs\n\nFunctionAppLogs \n| project TimeGenerated, HostInstanceId, Message, _ResourceId\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs with warnings or exceptions",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs with warnings or exceptions\n// Description: A list of logs which contain warnings or exceptions (latest logs shown first).\n// Categories: Azure Resources,Applications\n// Resource types: App Services\n// Topic: App Logs\n\nFunctionAppLogs\n| where Level == \"Warning\" or Level == \"Error\"\n| project TimeGenerated, HostInstanceId, Level, Message, _ResourceId\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Audit Logs relating to unexpected users",
    "query": "// Author: Microsoft Azure\n// Display name: Audit Logs relating to unexpected users\n// Description: List Audit Logs for users who logged in that aren't a listed user.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Audit Logs\n\nAppServiceAuditLogs\n| where UserDisplayName != \"user@company.com\""
  },
  {
    "source": "AzureMonitor",
    "name": "File Audit Logs relating to a Delete operation",
    "query": "// Author: Microsoft Azure\n// Display name: File Audit Logs relating to a \"Delete\" operation\n// Description: List File Audit Logs that has a \"Delete\" operation.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Audit Logs\n\nAppServiceFileAuditLogs\n| where OperationName == \"Delete\""
  },
  {
    "source": "AzureMonitor",
    "name": "Line chart of response times",
    "query": "// Author: Microsoft Azure\n// Display name: Line chart of response times\n// Description: Time series of mean response time (over 5 minute intervals).\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Azure Metrics\n\nAzureMetrics \n| extend timeBin = bin(TimeGenerated, 5m) \n| summarize ResponseTime = sumif(Average, MetricName==\"AverageResponseTime\") by timeBin, bin(TimeGenerated, 1h) \n| sort by TimeGenerated desc \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Pie chart of HTTP response codes",
    "query": "// Author: Microsoft Azure\n// Display name: Pie chart of HTTP response codes\n// Description: Breakdown of response codes for each metric, over the last 12 hours.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Azure Metrics\n\nAzureMetrics \n| where TimeGenerated \u003e ago(12h)  \n| where MetricName in (\"Http2xx\", \"Http3xx\", \"Http4xx\", \"Http5xx\") \n| summarize sum(Total) by MetricName  \n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Find console logs relating to application startup",
    "query": "// Author: Microsoft Azure\n// Display name: Find console logs relating to application startup\n// Description: List console logs that contain the term \"starting\".\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Console Logs\n\nAppServiceConsoleLogs \n| where tolower(ResultDescription) contains \"starting\""
  },
  {
    "source": "AzureMonitor",
    "name": "App Service Health",
    "query": "// Author: Microsoft Azure\n// Display name: App Service Health\n// Description: Time series of App Service Health (over 5 minute intervals).\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Incoming requests\n\nAppServiceHTTPLogs \n| summarize (count() - countif(ScStatus \u003e= 500)) * 100.0 / count() by bin(TimeGenerated, 5m), _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Failure Categorization",
    "query": "// Author: Microsoft Azure\n// Display name: Failure Categorization\n// Description: Categorize all requests which resulted in 5xx.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Incoming requests\n\nAppServiceHTTPLogs \n//| where ResourceId = \"MyResourceId\" // Uncomment to get results for a specific resource Id when querying over a group of Apps\n| where ScStatus \u003e= 500\n| reduce by strcat(CsMethod, ':\\\\', CsUriStem)"
  },
  {
    "source": "AzureMonitor",
    "name": "Response times of requests",
    "query": "// Author: Microsoft Azure\n// Display name: Response times of requests\n// Description: Avg \u0026 90, 95 and 99 percentile response times (in milliseconds) per App Service.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Incoming requests\n\nAppServiceHTTPLogs \n| summarize avg(TimeTaken), percentiles(TimeTaken, 90, 95, 99) by _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 5 Clients",
    "query": "// Author: Microsoft Azure\n// Display name: Top 5 Clients\n// Description: Top 5 clients which are generating traffic.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Incoming requests\n\nAppServiceHTTPLogs\n| top-nested of _ResourceId by dummy=max(0), // Display results for each resource (App)\n  top-nested 5 of UserAgent by count()\n| project-away dummy // Remove dummy line from the result set"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 5 Machines",
    "query": "// Author: Microsoft Azure\n// Display name: Top 5 Machines\n// Description: Top 5 machines which are generating traffic.\n// Categories: Azure Resources\n// Resource types: App Services\n// Topic: Incoming requests\n\nAppServiceHTTPLogs\n| top-nested of _ResourceId by dummy=max(0), // Display results for each resource (App)\n  top-nested 5 of CIp by count()\n| project-away dummy // Remove dummy line from the result set"
  },
  {
    "source": "AzureMonitor",
    "name": "Count of denied access from IP Security Audit Logs by resource in the last 7 days",
    "query": "// Author: Microsoft Azure\r\n// Display name: Count of denied access from IP Security Audit Logs by resource in the last 7 days\r\n// Description: Gets count for logs with denied access result from IP Security Audit Logs in the last 7 days by Resource, CsHost, CIp, and Details.\r\n// Categories: Security,Audit,Azure Resources\r\n// Resource types: App Services\r\n// Topic: Security\r\n\r\nAppServiceIPSecAuditLogs\r\r\n| where TimeGenerated \u003e ago(7d)\r\r\n| where Result == \"Denied\"\r\r\n| summarize count() by  _ResourceId, CsHost, CIp, Details"
  },
  {
    "source": "AzureMonitor",
    "name": "Function Error rate",
    "query": "// Author: Microsoft Azure\n// Display name: Function Error rate\n// Description: Summarizing functions success and errors per hour.\n// Categories: Azure Resources,Applications\n// Resource types: App Services\n// Topic: Usage and Performance\n\nFunctionAppLogs\n| where Category startswith \"Function.\" and Message startswith \"Executed \"\n| parse Message with \"Executed '\" Name \"' (\"  Result \", Id=\" Id \", Duration=\" Duration:long \"ms)\"\n// | where Name == \"MyFunction\" // Use this to restrict to a specific function\n| summarize count() by bin(TimeGenerated, 1h), Name, Result, _ResourceId\n| order by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Function activity over time",
    "query": "// Author: Microsoft Azure\n// Display name: Function activity over time\n// Description: Line chart showing trend of Function requests volume, per Function over time.\n// Categories: Azure Resources,Applications\n// Resource types: App Services\n// Topic: Usage and Performance\n\nFunctionAppLogs\n//| where _ResourceId == \"MyResourceId\" // Uncomment and enter a resource ID to get results for a specific resource\n| where Category startswith \"Function.\" and Message startswith \"Executed \"\n| summarize count() by bin(TimeGenerated, 1h), FunctionName // Aggregate by hour\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Function results",
    "query": "// Author: Microsoft Azure\n// Display name: Function results\n// Description: Individual Function invocation results in the last hour (latest logs shown first).\n// Categories: Azure Resources,Applications\n// Resource types: App Services\n// Topic: Usage and Performance\n\nFunctionAppLogs\n| where TimeGenerated \u003e ago(1h)\n| where Category startswith \"Function.\" and Message startswith \"Executed \"\n| parse Message with \"Executed '\" Name \"' (\"  Result \", Id=\" Id \", Duration=\" Duration:long \"ms)\"\n| project TimeGenerated, FunctionName, Result, FunctionInvocationId, Duration, _ResourceId\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Slow Functions",
    "query": "// Author: Microsoft Azure\n// Display name: Slow Functions\n// Description: List of Function invocations that took longer than threshold.\n// Categories: Azure Resources,Applications\n// Resource types: App Services\n// Topic: Usage and Performance\n\nlet threshold=1000; // let operator defines a constant that can be further used in the query\nFunctionAppLogs\n| where Category startswith \"Function.\" and Message startswith \"Executed \"\n| parse Message with \"Executed '\" Name \"' (\"  Result \", Id=\" Id \", Duration=\" Duration:long \"ms)\"\n| project TimeGenerated, FunctionName, Result, FunctionInvocationId, Duration, _ResourceId\n| where Duration \u003e threshold // Duration is recorded in milliseconds\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Page views trend",
    "query": "// Author: Microsoft Azure\n// Display name: Page views trend\n// Description: Chart the page views count, during the last day.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Browsing data\n\nAppPageViews\n| where ClientType == 'Browser'\n| summarize count_sum = sum(ItemCount) by bin(TimeGenerated,30m), _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Slowest pages",
    "query": "// Author: Microsoft Azure\n// Display name: Slowest pages\n// Description: What are the 3 slowest pages, and how slow are they?\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Browsing data\n\nAppPageViews\n| where notempty(DurationMs) and ClientType == 'Browser'\n| extend total_duration=DurationMs*ItemCount\n| summarize avg_duration=(sum(total_duration)/sum(ItemCount)) by OperationName\n| top 3 by avg_duration desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 3 browser exceptions",
    "query": "// Author: Microsoft Azure\n// Display name: Top 3 browser exceptions\n// Description: What were the highest reported exceptions today?\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Browsing data\n\nAppExceptions\n| where notempty(ClientBrowser) and ClientType == 'Browser'\n| summarize total_exceptions = sum(ItemCount) by ProblemId\n| top 3 by total_exceptions desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Operations performance",
    "query": "// Author: Microsoft Azure\n// Display name: Operations performance\n// Description: Calculate request count and duration by operations.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Performance\n\nAppRequests\n| summarize RequestsCount=sum(ItemCount), AverageDuration=avg(DurationMs), percentiles(DurationMs, 50, 95, 99) by OperationName, _ResourceId // you can replace 'OperationName' with another value to segment by a different property\n| order by RequestsCount desc // order from highest to lower (descending)"
  },
  {
    "source": "AzureMonitor",
    "name": "Request count trend",
    "query": "// Author: Microsoft Azure\n// Display name: Request count trend\n// Description: Chart Request count over the last day.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Performance\n\nAppRequests\n| summarize totalCount=sum(ItemCount) by bin(TimeGenerated, 30m), _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Response time buckets",
    "query": "// Author: Microsoft Azure\n// Display name: Response time buckets\n// Description: Show how many requests are in each performance-bucket.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Performance\n\nAppRequests\n| summarize requestCount=sum(ItemCount), avgDuration=avg(DurationMs) by PerformanceBucket\n| order by avgDuration asc // sort by average request duration\n| project-away avgDuration // no need to display avgDuration, we used it only for sorting results\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Response time trend",
    "query": "// Author: Microsoft Azure\n// Display name: Response time trend\n// Description: Chart request duration over the last 12 hours.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Performance\n\nAppRequests\n| where TimeGenerated \u003e ago(12h) \n| summarize avgRequestDuration=avg(DurationMs) by bin(TimeGenerated, 10m), _ResourceId // use a time grain of 10 minutes\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 countries by traffic",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 countries by traffic\n// Description: Chart the amount of requests from the top 10 countries.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Performance\n\nAppRequests\n| summarize CountByCountry=count() by ClientCountryOrRegion\n| top 10 by CountByCountry\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Exceptions causing request failures",
    "query": "// Author: Microsoft Azure\n// Display name: Exceptions causing request failures\n// Description: Find which exceptions led to failed requests in the past hour.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Reports failures\n\nAppRequests\n| where TimeGenerated \u003e ago(1h) and Success == false\n| join kind= inner (\nAppExceptions\n| where TimeGenerated \u003e ago(1h)\n) on OperationId\n| project exceptionType = Type, failedMethod = Method, requestName = Name, requestDuration = DurationMs, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed operations",
    "query": "// Author: Microsoft Azure\n// Display name: Failed operations\n// Description: Calculate how many times operations failed, and how many users were impacted.\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Reports failures\n\nAppRequests\n| where Success == false\n| summarize failedCount=sum(ItemCount), impactedUsers=dcount(UserId) by OperationName, _ResourceId\n| order by failedCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed requests  top 10",
    "query": "// Author: Microsoft Azure\n// Display name: Failed requests â€“ top 10\n// Description: What are the 3 slowest pages, and how slow are they?\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Reports failures\n\nAppRequests\n| where Success == false\n| summarize failedCount=sum(ItemCount) by Name\n| top 10 by failedCount desc\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Failing dependencies",
    "query": "// Author: Microsoft Azure\n// Display name: Failing dependencies\n// Description: Which 5 dependencies failed the most today?\n// Categories: Applications\n// Resource types: Application Insights\n// Topic: Reports failures\n\nAppDependencies\n| where Success == false\n| summarize totalCount=sum(ItemCount) by DependencyType\n| top 5 by totalCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Errors by URI",
    "query": "// Author: Microsoft Azure\n// Display name: Errors by URI\n// Description: Number of errors by URI.\n// Categories: Network\n// Resource types: Application gateways\n// Topic: Analytics\n\nAzureDiagnostics\n| where ResourceType == \"APPLICATIONGATEWAYS\" and OperationName == \"ApplicationGatewayAccess\" and httpStatus_d \u003e 399\n| summarize AggregatedValue = count() by requestUri_s, _ResourceId\n| sort by AggregatedValue desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Errors by user agent",
    "query": "// Author: Microsoft Azure\n// Display name: Errors by user agent\n// Description: Number of errors by user agent.\n// Categories: Network\n// Resource types: Application gateways\n// Topic: Analytics\n\nAzureDiagnostics\n| where ResourceType == \"APPLICATIONGATEWAYS\" and OperationName == \"ApplicationGatewayAccess\" and httpStatus_d \u003e 399\n| summarize AggregatedValue = count() by userAgent_s, _ResourceId\n| sort by AggregatedValue desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Client IPs",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Client IPs\n// Description: Count of requests per client IP.\n// Categories: Network\n// Resource types: Application gateways\n// Topic: Analytics\n\nAzureDiagnostics\n| where ResourceType == \"APPLICATIONGATEWAYS\" and OperationName == \"ApplicationGatewayAccess\"\n| summarize AggregatedValue = count() by clientIP_s\n| top 10 by AggregatedValue"
  },
  {
    "source": "AzureMonitor",
    "name": "Top HTTP versions",
    "query": "// Author: Microsoft Azure\n// Display name: Top HTTP versions\n// Description: Count of request per HTTP version.\n// Categories: Network\n// Resource types: Application gateways\n// Topic: Analytics\n\nAzureDiagnostics\n| where ResourceType == \"APPLICATIONGATEWAYS\" and OperationName == \"ApplicationGatewayAccess\"\n| summarize AggregatedValue = count() by httpVersion_s\n| top 10 by AggregatedValue"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed requests per hour",
    "query": "// Author: Microsoft Azure\n// Display name: Failed requests per hour\n// Description: Count of requests to which Application Gateway responded with an error.\n// Categories: Network\n// Resource types: Application gateways\n// Topic: Incoming requests\n\nAzureDiagnostics\n| where ResourceType == \"APPLICATIONGATEWAYS\" and OperationName == \"ApplicationGatewayAccess\" and httpStatus_d \u003e 399\n| summarize AggregatedValue = count() by bin(TimeGenerated, 1h), _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "NonSSL requests per hour",
    "query": "// Author: Microsoft Azure\n// Display name: Non-SSL requests per hour\n// Description: Count of the Non-SSL requests on the Application Gateway.\n// Categories: Network\n// Resource types: Application gateways\n// Topic: Incoming requests\n\nAzureDiagnostics\n| where ResourceType == \"APPLICATIONGATEWAYS\" and OperationName == \"ApplicationGatewayAccess\" and sslEnabled_s == \"off\"\n| summarize AggregatedValue = count() by bin(TimeGenerated, 1h), _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Requests per hour",
    "query": "// Author: Microsoft Azure\n// Display name: Requests per hour\n// Description: Count of the incoming requests on the Application Gateway.\n// Categories: Network\n// Resource types: Application gateways\n// Topic: Incoming requests\n\nAzureDiagnostics\n| where ResourceType == \"APPLICATIONGATEWAYS\" and OperationName == \"ApplicationGatewayAccess\"\n| summarize AggregatedValue = count() by bin(TimeGenerated, 1h), _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Azure Automation jobs that are Completed",
    "query": "// Author: Microsoft Azure\n// Display name: Azure Automation jobs that are Completed\n// Description: List all automation jobs that got completed.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Automation Jobs\n\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.AUTOMATION\" and Category == \"JobLogs\" and ResultType == \"Completed\" \n| project TimeGenerated , RunbookName_s , ResultType , _ResourceId , JobId_g"
  },
  {
    "source": "AzureMonitor",
    "name": "Azure Automation jobs that are failed suspended or stopped",
    "query": "// Author: Microsoft Azure\n// Display name: Azure Automation jobs that are failed, suspended, or stopped\n// Description: List all the automation jobs that failed , suspended or stopped.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Automation Jobs\n\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.AUTOMATION\" and Category == \"JobLogs\" and (ResultType == \"Failed\" or ResultType == \"Stopped\" or ResultType == \"Suspended\") \n| project TimeGenerated , RunbookName_s , ResultType , _ResourceId , JobId_g"
  },
  {
    "source": "AzureMonitor",
    "name": "Find logs reporting errors in automation jobs from the last day",
    "query": "// Author: Microsoft Azure\n// Display name: Find logs reporting errors in automation jobs from the last day\n// Description: List all the errors in the automation jobs.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Automation Jobs\n\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.AUTOMATION\" \n| where StreamType_s == \"Error\" \n| project TimeGenerated, Category, JobId_g, OperationName, RunbookName_s, ResultDescription, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Runbook completed successfully with errors",
    "query": "// Author: Microsoft Azure\n// Display name: Runbook completed successfully with errors\n// Description: List all jobs that completed with errors.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Automation Jobs\n\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.AUTOMATION\" and Category == \"JobStreams\" and StreamType_s == \"Error\" \n| project TimeGenerated , RunbookName_s , StreamType_s , _ResourceId , ResultDescription , JobId_g"
  },
  {
    "source": "AzureMonitor",
    "name": "View historical job status",
    "query": "// Author: Microsoft Azure\n// Display name: View historical job status\n// Description: List all automation jobs.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Automation Jobs\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.AUTOMATION\" and Category == \"JobLogs\" and ResultType != \"started\"\n| summarize AggregatedValue = count() by ResultType, bin(TimeGenerated, 1h) , RunbookName_s , JobId_g, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers list",
    "query": "// Author: Microsoft Azure\n// Display name: Computers list\n// Description: List of computers with Azure Update Management deployed.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Azure Update Management\n\nHeartbeat\n| where TimeGenerated\u003eago(12h) and OSType==\"Linux\" and notempty(Computer)\n| summarize arg_max(TimeGenerated, Solutions, Computer, ResourceId, ComputerEnvironment, VMUUID) by SourceComputerId\n| where Solutions has \"updates\"\n| extend vmuuId=VMUUID, azureResourceId=ResourceId, osType=1, environment=iff(ComputerEnvironment=~\"Azure\", 1, 2), scopedToUpdatesSolution=true, lastUpdateAgentSeenTime=\"\"\n| join kind=leftouter\n(\n   Update\n    | where TimeGenerated\u003eago(5h) and OSType==\"Linux\" and SourceComputerId in ((Heartbeat\n    | where TimeGenerated\u003eago(12h) and OSType==\"Linux\" and notempty(Computer)\n    | summarize arg_max(TimeGenerated, Solutions) by SourceComputerId\n    | where Solutions has \"updates\"\n    | distinct SourceComputerId))\n    | summarize hint.strategy=partitioned arg_max(TimeGenerated, UpdateState, Classification, Product, Computer, ComputerEnvironment) by SourceComputerId, Product, ProductArch\n    | summarize Computer=any(Computer), ComputerEnvironment=any(ComputerEnvironment), missingCriticalUpdatesCount=countif(Classification has \"Critical\" and UpdateState=~\"Needed\"), missingSecurityUpdatesCount=countif(Classification has \"Security\" and UpdateState=~\"Needed\"), missingOtherUpdatesCount=countif(Classification !has \"Critical\" and Classification !has \"Security\" and UpdateState=~\"Needed\"), lastAssessedTime=max(TimeGenerated), lastUpdateAgentSeenTime=\"\" by SourceComputerId\n    | extend compliance=iff(missingCriticalUpdatesCount \u003e 0 or missingSecurityUpdatesCount \u003e 0, 2, 1)\n    | extend ComplianceOrder=iff(missingCriticalUpdatesCount \u003e 0 or missingSecurityUpdatesCount \u003e 0 or missingOtherUpdatesCount \u003e 0, 1, 3)\n)\non SourceComputerId\n| project id=SourceComputerId, displayName=Computer, sourceComputerId=SourceComputerId, scopedToUpdatesSolution=true, missingCriticalUpdatesCount=coalesce(missingCriticalUpdatesCount, -1), missingSecurityUpdatesCount=coalesce(missingSecurityUpdatesCount, -1), missingOtherUpdatesCount=coalesce(missingOtherUpdatesCount, -1), compliance=coalesce(compliance, 4), lastAssessedTime, lastUpdateAgentSeenTime, osType=1, environment=iff(ComputerEnvironment=~\"Azure\", 1, 2), ComplianceOrder=coalesce(ComplianceOrder, 2)\n| union(Heartbeat\n| where TimeGenerated\u003eago(12h) and OSType=~\"Windows\" and notempty(Computer)\n| summarize arg_max(TimeGenerated, Solutions, Computer, ResourceId, ComputerEnvironment, VMUUID) by SourceComputerId\n| where Solutions has \"updates\"\n| extend vmuuId=VMUUID, azureResourceId=ResourceId, osType=2, environment=iff(ComputerEnvironment=~\"Azure\", 1, 2), scopedToUpdatesSolution=true, lastUpdateAgentSeenTime=\"\"\n| join kind=leftouter\n(\n    Update\n    | where TimeGenerated\u003eago(14h) and OSType!=\"Linux\" and SourceComputerId in ((Heartbeat\n    | where TimeGenerated\u003eago(12h) and OSType=~\"Windows\" and notempty(Computer)\n    | summarize arg_max(TimeGenerated, Solutions) by SourceComputerId\n    | where Solutions has \"updates\"\n    | distinct SourceComputerId))\n    | summarize hint.strategy=partitioned arg_max(TimeGenerated, UpdateState, Classification, Title, Optional, Approved, Computer, ComputerEnvironment) by Computer, SourceComputerId, UpdateID\n    | summarize Computer=any(Computer), ComputerEnvironment=any(ComputerEnvironment), missingCriticalUpdatesCount=countif(Classification has \"Critical\" and UpdateState=~\"Needed\" and Approved!=false), missingSecurityUpdatesCount=countif(Classification has \"Security\" and UpdateState=~\"Needed\" and Approved!=false), missingOtherUpdatesCount=countif(Classification !has \"Critical\" and Classification !has \"Security\" and UpdateState=~\"Needed\" and Optional==false and Approved!=false), lastAssessedTime=max(TimeGenerated), lastUpdateAgentSeenTime=\"\" by SourceComputerId\n    | extend compliance=iff(missingCriticalUpdatesCount \u003e 0 or missingSecurityUpdatesCount \u003e 0, 2, 1)\n    | extend ComplianceOrder=iff(missingCriticalUpdatesCount \u003e 0 or missingSecurityUpdatesCount \u003e 0 or missingOtherUpdatesCount \u003e 0, 1, 3)\n)\non SourceComputerId\n| project id=SourceComputerId, displayName=Computer, sourceComputerId=SourceComputerId, scopedToUpdatesSolution=true, missingCriticalUpdatesCount=coalesce(missingCriticalUpdatesCount, -1), missingSecurityUpdatesCount=coalesce(missingSecurityUpdatesCount, -1), missingOtherUpdatesCount=coalesce(missingOtherUpdatesCount, -1), compliance=coalesce(compliance, 4), lastAssessedTime, lastUpdateAgentSeenTime, osType=2, environment=iff(ComputerEnvironment=~\"Azure\", 1, 2), ComplianceOrder=coalesce(ComplianceOrder, 2))\n| order by ComplianceOrder asc, missingCriticalUpdatesCount desc, missingSecurityUpdatesCount desc, missingOtherUpdatesCount desc, displayName asc\n| project-away ComplianceOrder"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing updates list",
    "query": "// Author: Microsoft Azure\n// Display name: Missing updates list\n// Description: Get a list of all updates that are missing.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Azure Update Management\n\nUpdate\n| where TimeGenerated\u003eago(5h) and OSType==\"Linux\" and SourceComputerId in ((Heartbeat\n| where TimeGenerated\u003eago(12h) and OSType==\"Linux\" and notempty(Computer)\n| summarize arg_max(TimeGenerated, Solutions) by SourceComputerId\n| where Solutions has \"updates\"\n| distinct SourceComputerId))\n| summarize hint.strategy=partitioned arg_max(TimeGenerated, UpdateState, Classification, BulletinUrl, BulletinID) by SourceComputerId, Product, ProductArch\n| where UpdateState=~\"Needed\"\n| project-away UpdateState, TimeGenerated\n| summarize computersCount=dcount(SourceComputerId, 2), ClassificationWeight=max(iff(Classification has \"Critical\", 4, iff(Classification has \"Security\", 2, 1))) by id=strcat(Product, \"_\", ProductArch), displayName=Product, productArch=ProductArch, classification=Classification, InformationId=BulletinID, InformationUrl=tostring(split(BulletinUrl, \";\", 0)[0]), osType=1\n| union(Update\n| where TimeGenerated\u003eago(14h) and OSType!=\"Linux\" and (Optional==false or Classification has \"Critical\" or Classification has \"Security\") and SourceComputerId in ((Heartbeat\n| where TimeGenerated\u003eago(12h) and OSType=~\"Windows\" and notempty(Computer)\n| summarize arg_max(TimeGenerated, Solutions) by SourceComputerId\n| where Solutions has \"updates\"\n| distinct SourceComputerId))\n| summarize hint.strategy=partitioned arg_max(TimeGenerated, UpdateState, Classification, Title, KBID, PublishedDate, Approved) by Computer, SourceComputerId, UpdateID\n| where UpdateState=~\"Needed\" and Approved!=false\n| project-away UpdateState, Approved, TimeGenerated\n| summarize computersCount=dcount(SourceComputerId, 2), displayName=any(Title), publishedDate=min(PublishedDate), ClassificationWeight=max(iff(Classification has \"Critical\", 4, iff(Classification has \"Security\", 2, 1))) by id=strcat(UpdateID, \"_\", KBID), classification=Classification, InformationId=strcat(\"KB\", KBID), InformationUrl=iff(isnotempty(KBID), strcat(\"https://support.microsoft.com/kb/\", KBID), \"\"), osType=2)\n| sort by ClassificationWeight desc, computersCount desc, displayName asc\n| extend informationLink=(iff(isnotempty(InformationId) and isnotempty(InformationUrl), toobject(strcat('{ \"uri\": \"', InformationUrl, '\", \"text\": \"', InformationId, '\", \"target\": \"blank\" }')), toobject('')))\n| project-away ClassificationWeight, InformationId, InformationUrl"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing updates summary",
    "query": "// Author: Microsoft Azure\n// Display name: Missing updates summary\n// Description: Get a summary of missing updates by category.\n// Categories: Azure Resources\n// Resource types: Automation accounts\n// Topic: Azure Update Management\n\nUpdate\n| where TimeGenerated\u003eago(5h) and OSType==\"Linux\" and SourceComputerId in ((Heartbeat\n| where TimeGenerated\u003eago(12h) and OSType==\"Linux\" and notempty(Computer)\n| summarize arg_max(TimeGenerated, Solutions) by SourceComputerId\n| where Solutions has \"updates\"\n| distinct SourceComputerId))\n| summarize hint.strategy=partitioned arg_max(TimeGenerated, UpdateState, Classification) by Computer, SourceComputerId, Product, ProductArch\n| where UpdateState=~\"Needed\"\n| summarize by Product, ProductArch, Classification\n| union (Update\n| where TimeGenerated\u003eago(14h) and OSType!=\"Linux\" and (Optional==false or Classification has \"Critical\" or Classification has \"Security\") and SourceComputerId in ((Heartbeat\n| where TimeGenerated\u003eago(12h) and OSType=~\"Windows\" and notempty(Computer)\n| summarize arg_max(TimeGenerated, Solutions) by SourceComputerId\n| where Solutions has \"updates\"\n| distinct SourceComputerId))\n| summarize hint.strategy=partitioned arg_max(TimeGenerated, UpdateState, Classification, Approved) by Computer, SourceComputerId, UpdateID\n| where UpdateState=~\"Needed\" and Approved!=false\n| summarize by UpdateID, Classification )\n| summarize allUpdatesCount=count(), criticalUpdatesCount=countif(Classification has \"Critical\"), securityUpdatesCount=countif(Classification has \"Security\"), otherUpdatesCount=countif(Classification !has \"Critical\" and Classification !has \"Security\")"
  },
  {
    "source": "AzureMonitor",
    "name": "Patch installation failure for your machines",
    "query": "// Author: Microsoft Azure\n// Display name: Patch installation failure for your machines\n// Description: List for each machine the installation status of the updates where the installation was not successful.\n// Categories: Virtual Machines,Security\n// Resource types: Automation accounts\n// Topic: Azure Update Management\n\nUpdateRunProgress\n| where TimeGenerated\u003eago(1d) \n| where InstallationStatus == \"NotStarted\" \n| summarize by Title, InstallationStatus, SourceComputerId, UpdateId, Computer\n| join kind= inner (\n    UpdateRunProgress\n    | where TimeGenerated\u003eago(1d) \n    | where InstallationStatus != \"NotStarted\" \n    | summarize by Title, InstallationStatus, SourceComputerId, UpdateId, Computer\n) on UpdateId \n| where InstallationStatus1 != \"Succeed\"\n| summarize by Title, InstallationStatus, Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of updates available across machines",
    "query": "// Author: Microsoft Azure\n// Display name: Summary of updates available across machines\n// Description: Count of updates available under various categories for each machine.\n// Categories: Virtual Machines,Security\n// Resource types: Automation accounts\n// Topic: Azure Update Management\n\nUpdateSummary \n| where TimeGenerated\u003eago(14h) \n| summarize by Computer, CriticalUpdatesMissing, SecurityUpdatesMissing, OtherUpdatesMissing, TotalUpdatesMissing"
  },
  {
    "source": "AzureMonitor",
    "name": "Updates available for Linux machines",
    "query": "// Author: Microsoft Azure\n// Display name: Updates available for Linux machines\n// Description: List the Linux package version updates available by their classification and for each Computer.\n// Categories: Virtual Machines,Security\n// Resource types: Automation accounts\n// Topic: Azure Update Management\n\nUpdate\n| where TimeGenerated\u003eago(14h) \n| where UpdateState =~ \"Needed\" and OSType == \"Linux\" \n| summarize by Computer, Classification, Product, ProductVersion"
  },
  {
    "source": "AzureMonitor",
    "name": "Updates available for Windows machines",
    "query": "// Author: Microsoft Azure\n// Display name: Updates available for Windows machines\n// Description: List the Windows update KBIDs available by their classification and for each Computer.\n// Categories: Virtual Machines,Security\n// Resource types: Automation accounts\n// Topic: Azure Update Management\n\nUpdate\n| where TimeGenerated\u003eago(14h) \n| where UpdateState =~ \"Needed\" and OSType != \"Linux\" \n| summarize by Computer, Classification, Product, KBID"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AADDomainServicesAccountLogon table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AADDomainServicesAccountLogon table\n// Description: Lists the latest logs in AADDomainServicesAccountLogon table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAADDomainServicesAccountLogon\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AADDomainServicesAccountManagement table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AADDomainServicesAccountManagement table\n// Description: Lists the latest logs in AADDomainServicesAccountManagement table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAADDomainServicesAccountManagement\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AADDomainServicesDirectoryServiceAccess table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AADDomainServicesDirectoryServiceAccess table\n// Description: Lists the latest logs in AADDomainServicesDirectoryServiceAccess table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAADDomainServicesDirectoryServiceAccess\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AADDomainServicesLogonLogoff table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AADDomainServicesLogonLogoff table\n// Description: Lists the latest logs in AADDomainServicesLogonLogoff table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAADDomainServicesLogonLogoff\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AADDomainServicesPolicyChange table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AADDomainServicesPolicyChange table\n// Description: Lists the latest logs in AADDomainServicesPolicyChange table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAADDomainServicesPolicyChange\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AADDomainServicesPrivilegeUse table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AADDomainServicesPrivilegeUse table\n// Description: Lists the latest logs in AADDomainServicesPrivilegeUse table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAADDomainServicesPrivilegeUse\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AADDomainServicesSystemSecurity table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AADDomainServicesSystemSecurity table\n// Description: Lists the latest logs in AADDomainServicesSystemSecurity table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAADDomainServicesSystemSecurity\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AzureActivity table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AzureActivity table\n// Description: Lists the latest logs in AzureActivity table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAzureActivity\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Show logs from AzureMetrics table",
    "query": "// Author: Microsoft Azure\n// Display name: Show logs from AzureMetrics table\n// Description: Lists the latest logs in AzureMetrics table, sorted by time (latest first).\n// Categories: Azure Resources\n// Resource types: Azure AD Domain Services\n// Topic: Preview Data\n\nAzureMetrics\n| top 10 by TimeGenerated"
  },
  {
    "source": "AzureMonitor",
    "name": "Provisioned objects by day",
    "query": "// Author: Microsoft Azure\r\n// Display name: Provisioned objects by day\r\n// Description: Summarizes for each day the number of created objects per day.\r\n// Categories: Audit\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Audit\r\n\r\nAADProvisioningLogs\r\r\n| where TimeGenerated \u003e ago(7d)\r\r\n| where ResultType == \"Success\"\r\r\n| where Action == \"Create\"\r\r\n| parse SourceIdentity with * \"\\\"identityType\\\":\\\"\" Type \"\\\"\" *\r\r\n| extend Type = tolower(Type)\r\r\n| summarize count() by Type, bin(TimeGenerated, 1d)\r\r\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Provisioning actions for the last week",
    "query": "// Author: Microsoft Azure\r\n// Display name: Provisioning actions for the last week\r\n// Description: Shows the number of users and groups created, updated, disabled, and deleted in the past 7 days.\r\n// Categories: Audit\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Audit\r\n\r\nAADProvisioningLogs\r\r\n| where TimeGenerated \u003e ago(7d)\r\r\n| where ResultType == \"Success\"\r\r\n| parse SourceIdentity with * \"\\\"identityType\\\":\\\"\" Type \"\\\"\" *\r\r\n| extend Type = tolower(Type)\r\r\n| summarize count() by Type, Action\r\r\n| order by Type, Action"
  },
  {
    "source": "AzureMonitor",
    "name": "Provisioning errors",
    "query": "// Author: Microsoft Azure\r\n// Display name: Provisioning errors\r\n// Description: Shows the count per error code and when were they last seen.\r\n// Categories: Audit\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Audit\r\n\r\nAADProvisioningLogs\r\r\n| where ResultType == \"Failure\"\r\r\n| summarize Occurrences=count(), LastSeen=max(TimeGenerated) by ResultSignature\r\r\n| order by LastSeen"
  },
  {
    "source": "AzureMonitor",
    "name": "Inactive Service Principals",
    "query": "// Author: Microsoft Azure\r\n// Display name: Inactive Service Principals\r\n// Description: Service principals that had no sign-ins for the last 30d.\r\n// Categories: Security\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Security\r\n\r\nAADServicePrincipalSignInLogs\r\r\n| where TimeGenerated \u003e ago(90d)\r\r\n| where ResultType == 0\r\r\n| summarize LastSignIn = max(TimeGenerated) by ServicePrincipalId\r\r\n| where LastSignIn \u003c ago(30d)"
  },
  {
    "source": "AzureMonitor",
    "name": "Most active IP Addresses",
    "query": "// Author: Microsoft Azure\r\n// Display name: Most active IP Addresses\r\n// Description: Get list of top 100 most active IP addresses for the last day.\r\n// Categories: Security\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Security\r\n\r\nAADNonInteractiveUserSignInLogs\r\r\n| where TimeGenerated \u003e ago(1d)\r\r\n| summarize CountPerIPAddress = count() by IPAddress\r\r\n| order by CountPerIPAddress desc\r\r\n| take 100"
  },
  {
    "source": "AzureMonitor",
    "name": "Most active Managed Identities",
    "query": "// Author: Microsoft Azure\r\n// Display name: Most active Managed Identities\r\n// Description: Gets list of top 100 most active managed identities for the last day.\r\n// Categories: Security\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Security\r\n\r\nAADManagedIdentitySignInLogs\r\r\n| where TimeGenerated \u003e ago(1d)\r\r\n| summarize CountPerManagedIdentity = count() by ServicePrincipalId\r\r\n| order by CountPerManagedIdentity desc\r\r\n| take 100"
  },
  {
    "source": "AzureMonitor",
    "name": "Most active Service Principals",
    "query": "// Author: Microsoft Azure\r\n// Display name: Most active Service Principals\r\n// Description: Gets list of top 100 most active service principals for the last day.\r\n// Categories: Security\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Security\r\n\r\nAADServicePrincipalSignInLogs\r\r\n| where TimeGenerated \u003e ago(1d)\r\r\n| summarize CountPerServicePrincipal = count() by ServicePrincipalId\r\r\n| order by CountPerServicePrincipal desc\r\r\n| take 100"
  },
  {
    "source": "AzureMonitor",
    "name": "Users with multiple cities",
    "query": "// Author: Microsoft Azure\r\n// Display name: Users with multiple cities\r\n// Description: Get list of users that signed in from multiple cities for the last day.\r\n// Categories: Security\r\n// Resource types: Azure Active Directory Logs\r\n// Topic: Security\r\n\r\nAADNonInteractiveUserSignInLogs\r\r\n| where TimeGenerated \u003e ago(1d)\r\r\n| extend City = parse_json(LocationDetails).city\r\r\n| summarize CountPerCity = dcount(tostring(City)) by UserId\r\r\n| where CountPerCity \u003e 1\r\r\n| order by CountPerCity desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed operations",
    "query": "// Author: Microsoft Azure\n// Display name: Failed operations\n// Description: List all reports of failed operations, over the past hour.\n// Categories: audit\n// Resource types: Azure Activity logs\n// Topic: Activity logs\n\nAzureActivity \n| where TimeGenerated \u003e ago(1h)  \n| where ActivityStatus == \"Failed\""
  },
  {
    "source": "AzureMonitor",
    "name": "Latest 50 logs",
    "query": "// Author: Microsoft Azure\n// Display name: Latest 50 logs\n// Description: Show the latest Azure Activity logs for this resource.\n// Categories: audit\n// Resource types: Azure Activity logs\n// Topic: Activity logs\n\nAzureActivity \n| top 50 by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "NSGCreateOpenAllowAll",
    "query": "// This Query returns NSGs with rules open to the internet at VM creation (where VM and NSG are created together)\nAzureActivity \n| where OperationNameValue =~ \"Microsoft.Network/networkSecurityGroups/write\"\n    and ActivityStatusValue == \"Accept\"\n| extend SecurityRules_ = todynamic(parse_json(tostring(parse_json(tostring(Properties_d.responseBody)).properties)).securityRules)\n| mv-expand SecurityRules_\n| extend SourceAddressPrefix_ = tostring(parse_json(tostring(parse_json(tostring(SecurityRules_)).properties)).sourceAddressPrefix) \n| extend SourceAddressPrefixes_ = tostring(parse_json(tostring(parse_json(tostring(SecurityRules_)).properties)).sourceAddressPrefixes)\n| extend Access = tostring(parse_json(tostring(parse_json(tostring(SecurityRules_)).properties)).access)\n| extend Port = tostring(parse_json(tostring(parse_json(tostring(SecurityRules_)).properties)).destinationPortRange)\n| where SourceAddressPrefix_ == '*' or SourceAddressPrefixes_ == '' or SourceAddressPrefixes_ == '0.0.0.0/0' \n| where Access == \"Allow\"\n| extend NsgName = split(_ResourceId, '/')[8] \n| extend NsgRule = split(_ResourceId, '/')[10] \n| project TimeGenerated, \n          NsgName, \n          NsgRule, \n          ResourceGroup, \n          SourceAddressPrefix_, \n          SourceAddressPrefixes_,\n\t\t  Port,\n          Caller,\n          CallerIpAddress"
  },
  {
    "source": "AzureMonitor",
    "name": "NSGUpdateOpenAllowAll",
    "query": "// This Query returns NSGs with rules that have been updated\nAzureActivity \n| where OperationNameValue =~ \"Microsoft.Network/networkSecurityGroups/securityRules/write\"\n| where ActivityStatusValue == \"Accept\"\n| extend SourceAddressPrefix_ = tostring(parse_json(tostring(parse_json(tostring(Properties_d.responseBody)).properties)).sourceAddressPrefix) \n| extend SourceAddressPrefixes_ = tostring(parse_json(tostring(parse_json(tostring(Properties_d.requestbody)).properties)).sourceAddressPrefixes)\n| extend Access = tostring(parse_json(tostring(parse_json(tostring(parse_json(Properties).responseBody)).properties)).access)\n| extend Port = tostring(parse_json(tostring(parse_json(tostring(parse_json(Properties).responseBody)).properties)).destinationPortRange) \n| where SourceAddressPrefix_ == '*'\n    or SourceAddressPrefixes_ == ''\n    or SourceAddressPrefixes_ == '0.0.0.0/0' \n| where Access == \"Allow\"\n| extend NsgName = split(_ResourceId, '/')[8] \n| extend NsgRule = split(_ResourceId, '/')[10] \n| project TimeGenerated, \n    NsgName, \n    NsgRule, \n    ResourceGroup, \n    SourceAddressPrefix_, \n    SourceAddressPrefixes_,\n    Port,\n    Caller,\n    CallerIpAddress"
  },
  {
    "source": "AzureMonitor",
    "name": "Operations status",
    "query": "// Author: Microsoft Azure\n// Display name: Operations' status\n// Description: Show the latest Azure activity log for each operation.\n// Categories: audit\n// Resource types: Azure Activity logs\n// Topic: Activity logs\n\nAzureActivity \n| summarize arg_max(TimeGenerated, *) by OperationName"
  },
  {
    "source": "AzureMonitor",
    "name": "Recent Azure Activity logs",
    "query": "// Author: Microsoft Azure\n// Display name: Recent Azure Activity logs\n// Description: Display all Azure Activity logs from the last hour.\n// Categories: audit\n// Resource types: Azure Activity logs\n// Topic: Activity logs\n\nAzureActivity \n| where Level == \"Error\" or Level == \"Warning\"\n| project TimeGenerated, Level, ResourceProvider, ActivityStatus, Caller, Category, Properties, CorrelationId"
  },
  {
    "source": "AzureMonitor",
    "name": "resource write operations",
    "query": "// Author: Martin Ehrnst\n// Display name: Resource write operations\n// Description: List all resource changes in your subscription. Can be used to track resource drift, etc. Policy definition writes are excluded\n// Categories: audit\n// Resource types: Azure Activity logs\n// Topic: Activity logs\n\nAzureActivity\n| where Authorization_d.action has \"write\"\n| where CategoryValue == \"Administrative\"\n| where ActivityStatusValue == \"Success\"\n| where OperationNameValue !in (\n\"MICROSOFT.AUTHORIZATION/POLICYDEFINITIONS/WRITE\",\n\"MICROSOFT.AUTHORIZATION/POLICYSETDEFINITIONS/WRITE\",\n\"MICROSOFT.AUTHORIZATION/POLICYASSIGNMENTS/WRITE\")"
  },
  {
    "source": "AzureMonitor",
    "name": "Most recent container log entries",
    "query": "// Author: Microsoft Azure\n// Display name: Most recent application console log entries across containers\n// Description: Shows the most recent console ouput logs in a form similar to seen in the Log Stream\n// Categories: Azure Container Apps\n// Resource types: Container Apps\n// Topic: Application Logs\n\nContainerAppConsoleLogs_CL \n| top 500 by _timestamp_d\n| project\n    TimeGenerated,\n    RevisionName_s,\n    Instance=strcat(\"â€¦\", substring(ContainerId_s, -5, 5)),\n    Log_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Review audit log events",
    "query": "// Author: Microsoft Azure\n// Display name: Review audit log events\n// Description: Identify audit events for your server.\n// Categories: Workloads,Audit\n// Resource types: Azure Database for MariaDB servers\n// Topic: Audit\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORMARIADB\" \n| where Category == 'MySqlAuditLogs'\n| project TimeGenerated, LogicalServerName_s, event_subclass_s, event_time_t, user_s , ip_s , sql_text_s \n| order by TimeGenerated asc"
  },
  {
    "source": "AzureMonitor",
    "name": "Execution time exceeding a threshold",
    "query": "// Author: Microsoft Azure\n// Display name: Execution time exceeding a threshold\n// Description: Identify queries that their run time exceeds 10 seconds.\n// Categories: Workloads\n// Resource types: Azure Database for MariaDB servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORMARIADB\" \n| where Category == 'MySqlSlowLogs'\n| project TimeGenerated, LogicalServerName_s, start_time_t , query_time_d, sql_text_s \n| where query_time_d \u003e 10 // You may change the time threshold"
  },
  {
    "source": "AzureMonitor",
    "name": "Show Querys statistics",
    "query": "// Author: Microsoft Azure\n// Display name: Show Query's statistics\n// Description: Construct a summary statistics table by query.\n// Categories: Workloads\n// Resource types: Azure Database for MariaDB servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORMARIADB\" \n| where Category == 'MySqlSlowLogs'\n| project TimeGenerated, LogicalServerName_s, start_time_t , query_time_d, sql_text_s \n| summarize count(), min(query_time_d), max(query_time_d), avg(query_time_d), stdev(query_time_d), percentile(query_time_d, 95) by LogicalServerName_s ,sql_text_s \n|  top 50  by percentile_query_time_d_95 desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Show the Slowest queries",
    "query": "// Author: Microsoft Azure\n// Display name: Show the Slowest queries\n// Description: Identify top 5 slowest queries.\n// Categories: Workloads\n// Resource types: Azure Database for MariaDB servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORMARIADB\" \n| where Category == 'MySqlSlowLogs'\n| project TimeGenerated, LogicalServerName_s, start_time_t , query_time_d, sql_text_s \n| top 5 by query_time_d desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Review audit log events",
    "query": "// Author: Microsoft Azure\n// Display name: Review audit log events\n// Description: Identify audit events for your server.\n// Categories: Workloads,Audit\n// Resource types: Azure Database for MySQL servers\n// Topic: Audit\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORMYSQL\"\n| where Category == 'MySqlAuditLogs'\n| project TimeGenerated, LogicalServerName_s, event_subclass_s, event_time_t, user_s , ip_s , sql_text_s \n| order by TimeGenerated asc"
  },
  {
    "source": "AzureMonitor",
    "name": "Execution time exceeding a threshold",
    "query": "// Author: Microsoft Azure\n// Display name: Execution time exceeding a threshold\n// Description: Identify queries that their run time exceeds 10 seconds.\n// Categories: Workloads\n// Resource types: Azure Database for MySQL servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORMYSQL\"\n| where Category == 'MySqlSlowLogs'\n| project TimeGenerated, LogicalServerName_s, start_time_t , query_time_d, sql_text_s \n| where query_time_d \u003e 10 //You may change the time threshold"
  },
  {
    "source": "AzureMonitor",
    "name": "Show Querys statistics",
    "query": "// Author: Microsoft Azure\n// Display name: Show Query's statistics\n// Description: Construct a summary statistics table by query.\n// Categories: Workloads\n// Resource types: Azure Database for MySQL servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider ==  \"MICROSOFT.DBFORMYSQL\"\n| where Category == 'MySqlSlowLogs'\n| project TimeGenerated, LogicalServerName_s, start_time_t , query_time_d, sql_text_s \n| summarize count(), min(query_time_d), max(query_time_d), avg(query_time_d), stdev(query_time_d), percentile(query_time_d, 95) by LogicalServerName_s ,sql_text_s \n|  top 50  by percentile_query_time_d_95 desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Show the Slowest queries",
    "query": "// Author: Microsoft Azure\n// Display name: Show the Slowest queries\n// Description: Identify top 5 slowest queries.\n// Categories: Workloads\n// Resource types: Azure Database for MySQL servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORMYSQL\" \n| where Category == 'MySqlSlowLogs'\n| project TimeGenerated, LogicalServerName_s, start_time_t , query_time_d, sql_text_s \n| top 5 by query_time_d desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Audit logs for tables and event types",
    "query": "// Author: Microsoft Azure\n// Display name: Audit logs for table(s) and event type(s)\n// Description: Search for audit logs for a specific table and event type DDL. Other event types are READ, WRITE, FUNCTION, MISC. It requires audit logs enabled. [https://docs.microsoft.com/azure/postgresql/concepts-audit].\n// Categories: Workloads,Audit\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Audit Logs\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORPOSTGRESQL\" \n| where Category == \"PostgreSQLLogs\"\n| where Message contains \"AUDIT:\" \n| where Message contains \"table name\" and Message contains \"DDL\""
  },
  {
    "source": "AzureMonitor",
    "name": "Audit logs",
    "query": "// Author: Microsoft Azure\n// Display name: Audit logs\n// Description: Get all audit logs. It requires audit logs to be enabled [https://docs.microsoft.com/azure/postgresql/concepts-audit].\n// Categories: Workloads,Audit\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Audit Logs\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORPOSTGRESQL\" \n| where Category == \"PostgreSQLLogs\"\n| where Message contains \"AUDIT:\""
  },
  {
    "source": "AzureMonitor",
    "name": "Autovacuum events",
    "query": "// Author: Microsoft Azure\n// Display name: Autovacuum events\n// Description: Search for autovacuum events over the last 24 hours. It requires parameter 'log_autovacuum_min_duration' enabled.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(1d) \n| where ResourceProvider ==\"MICROSOFT.DBFORPOSTGRESQL\" \n| where Category == \"PostgreSQLLogs\"\n| where Message contains \"automatic vacuum\""
  },
  {
    "source": "AzureMonitor",
    "name": "Deadlocks",
    "query": "// Author: Microsoft Azure\n// Display name: Deadlocks\n// Description: Search for deadlock events.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORPOSTGRESQL\" \n| where Category == \"PostgreSQLLogs\"\n| where Message contains \"deadlock detected\""
  },
  {
    "source": "AzureMonitor",
    "name": "Execution count trends",
    "query": "// Author: Microsoft Azure\n// Display name: Execution count trends\n// Description: Execution trend by query aggregated by 15 minute-intervals.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreRuntimeStatistics\"\n| where user_id_s != \"10\" //exclude azure system user\n| summarize sum(toint(calls_s)) by  tostring(query_id_d), bin(TimeGenerated, 15m)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Lock contention",
    "query": "// Author: Microsoft Azure\n// Display name: Lock contention\n// Description: Search for lock contention. It requires log_lock_waits=ON and depends on deadlock_timeout setting.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORPOSTGRESQL\" \n| where Message contains \"still waiting for ShareLock on transaction\""
  },
  {
    "source": "AzureMonitor",
    "name": "Query statistics",
    "query": "// Author: Microsoft Azure\n// Display name: Query statistics\n// Description: Construct a summary statistics table by query.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreRuntimeStatistics\"\n| where user_id_s != \"10\" //exclude azure system user\n| summarize sum(toint(calls_s)), min(todouble(min_time_s)),max(todouble(max_time_s)),avg(todouble(mean_time_s)),percentile(todouble(mean_time_s),95) by  db_id_s ,query_id_d\n| order by percentile_mean_time_s_95 desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "Server restarts",
    "query": "// Author: Microsoft Azure\n// Display name: Server restarts\n// Description: Search for server shut down and server ready events.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(7d)\n| where ResourceProvider ==\"MICROSOFT.DBFORPOSTGRESQL\" \n| where Category == \"PostgreSQLLogs\"\n| where Message contains \"database system was shut down at\" or Message contains \"database system is ready to accept\""
  },
  {
    "source": "AzureMonitor",
    "name": "Top wait events",
    "query": "// Author: Microsoft Azure\n// Display name: Top wait events\n// Description: Identify top 5 wait events by queries.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreWaitStatistics\"\n| where user_id_s != \"10\" //exclude azure system user\n| where query_id_d != 0\n| summarize sum(toint(calls_s)) by event_s, query_id_d, bin(TimeGenerated, 15m)\n| top 5 by sum_calls_s desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "Wait event trends",
    "query": "// Author: Microsoft Azure\n// Display name: Wait event trends\n// Description: Display wait event trends over time.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreWaitStatistics\"\n| where user_id_s != \"10\" //exclude azure system user\n| extend query_id_s = tostring(query_id_d)\n| summarize sum(toint(calls_s)) by event_s, query_id_s, bin(TimeGenerated, 15m) // You may change the time threshold \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Find Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Find Errors\n// Description: Search for errors in the last 6 hours.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Errors\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(6h)\n| where Category == \"PostgreSQLLogs\"\n| where  errorLevel_s contains \"error\""
  },
  {
    "source": "AzureMonitor",
    "name": "Queries waiting",
    "query": "// Author: Microsoft Azure\n// Display name: Queries waiting\n// Description: Identify if slowest queries wait on anything.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Performance\n\nlet top5 = AzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n//| where LogicalServerName_s == \"your server name\" // you can run this query for a specific server \n| where Category == \"QueryStoreRuntimeStatistics\"\n| where user_id_s != \"10\" //exclude azure system user\n| summarize avg(todouble(mean_time_s)) by db_id_s ,query_id_d\n| order by avg_mean_time_s desc nulls last \n| project query_id_d , db_id_s\n| take 5;\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreWaitStatistics\"\n| extend query_id_s = tostring(query_id_d)\n| join top5 on query_id_d\n| summarize sum(toint(calls_s)) by event_s, query_id_s, bin(TimeGenerated, 15m)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Queries with execution time exceeding a threshold",
    "query": "// Author: Microsoft Azure\n// Display name: Queries with execution time exceeding a threshold\n// Description: Identify queries that take longer than 10 seconds. The query store normalizes actual queries to aggregate similar queries. By default, entries are aggregated every 15 mins. Query utilizes mean execution time every 15 mins and other query statistics such as max, min can be used as appropriate.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreRuntimeStatistics\"\n| where user_id_s != \"10\" //exclude azure system user\n| project TimeGenerated, LogicalServerName_s , mean_time_s , db_id_s , start_time_t , query_id_d\n| where todouble(mean_time_s) \u003e 10000 // You may change the time threshold"
  },
  {
    "source": "AzureMonitor",
    "name": "Slowest queries",
    "query": "// Author: Microsoft Azure\n// Display name: Slowest queries\n// Description: Identify top 5 slowest queries.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Performance\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreRuntimeStatistics\"\n| where user_id_s != \"10\" //exclude azure system user\n| summarize avg(todouble(mean_time_s)) by db_id_s ,query_id_d\n| top 5 by avg_mean_time_s desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Compare two periods for query execution times",
    "query": "// Author: Microsoft Azure\n// Display name: Compare two periods for query execution times\n// Description: Identify queries that have a latency difference exceeding a threshold.\n// Categories: Workloads\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Troubleshooting\n\nlet queryExecutionPrev24h = AzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreRuntimeStatistics\"\n//| where LogicalServerName_s == \"your server name\" // you can run this query for a specific server | extend timestamp_new = make_datetime(start_time_t)\n// change range of baseline period based on your needs\n| where timestamp_new \u003e= ago(48h) and timestamp_new \u003c ago(24h)\n| summarize prevTimeAvg = avg(todecimal(mean_time_s)), prevTimeMax=max(todecimal(mean_time_s)), prevTimeMinTimeStamp=min(timestamp_new), prevTimeMaxTimeStamp=max(timestamp_new), prevTimeExecutionCount=sum(toint(calls_s)) by query_id_d;\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DBFORPOSTGRESQL\"\n| where Category == \"QueryStoreRuntimeStatistics\"\n//| where LogicalServerName_s == \"your server name\" // you can run this query for a specific server \n| extend timestamp_new = make_datetime(start_time_t)\n// change range of current period based on your needs\n| where timestamp_new \u003e= ago(24h)\n| summarize currentTimeAvg=avg(todecimal(mean_time_s)), max(todecimal(mean_time_s)), min(timestamp_new), max(timestamp_new) , currentTimeExecutionCount = sum(toint(calls_s)) by query_id_d\n| join kind=inner\n    queryExecutionPrev24h\non query_id_d\n| extend latencyDiff = currentTimeAvg - prevTimeAvg\n| extend latencyDiffPercent = (((prevTimeAvg-currentTimeAvg)/prevTimeAvg)*100)\n| extend executionCountDiff = (((todecimal(prevTimeExecutionCount)-todecimal(currentTimeExecutionCount))/todecimal(prevTimeExecutionCount)))*100\n| project query_id_d, latencyDiff, latencyDiffPercent, currentTimeAvg, prevTimeAvg, currentTimeExecutionCount, prevTimeExecutionCount,executionCountDiff\n// change your threshold of difference between two periods based on your needs\n| where latencyDiffPercent \u003c -10\n| order by latencyDiffPercent desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Unauthorized connections",
    "query": "// Author: Microsoft Azure\n// Display name: Unauthorized connections\n// Description: Search for unauthorized (rejected) connection attempts.\n// Categories: Workloads,Security\n// Resource types: Azure Database for PostgreSQL servers\n// Topic: Troubleshooting\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.DBFORPOSTGRESQL\" \n| where Category == \"PostgreSQLLogs\"\n| where Message contains \"password authentication failed\" or Message contains \"no pg_hba.conf entry for host\""
  },
  {
    "source": "AzureMonitor",
    "name": "Job run times",
    "query": "// Author: Pantalones411\n// Display name: Average Job Run Time by jobId\n// Description: This query provides the average delta of runStart and runSucceeded times in 10 minute bins\n// Categories: Azure Resources\n// Resource types: Azure Databricks Services\t\n// Topic: Performance\n\nlet allJobs = DatabricksJobs \n\t| where ActionName == \"runStart\"\n\t| extend runid = extractjson('$runId', RequestParams)\n\t| extend jobid = extractjson('$jobId', RequestParams)\n\t| project jobid, runid,TimeGenerated,ActionName\n\t\t| join kind=inner (DatabricksJobs\n\t\t| where ActionName == 'runSucceeded'\n\t\t| extend runid = extractjson('$runId', RequestParams)\n\t\t| extend jobid = extractjson('$jobId', RequestParams)\n\t\t| project jobid, runid,TimeGenerated,ActionName\n\t\t) on runid;\nallJobs\n\t| extend timediff = TimeGenerated1-TimeGenerated\n\t| extend Success_Seconds = split(timediff,':')[0] * 3600 + split(timediff,':')[1] * 60 + split(timediff,':')[2]\n\t| summarize avg(Success_Seconds) by jobid, bin(TimeGenerated, 10m)"
  },
  {
    "source": "AzureMonitor",
    "name": "DigitalTwin API Latency",
    "query": "// Author: Microsoft Azure\n// Display name: DigitalTwin API Latency\n// Description: Time to complete DigitalTwin operations by type over time.\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Diagnostics\n\nlet grain = 5m;\nADTDigitalTwinsOperation\n| summarize avg(toint(DurationMs)) by OperationName, bin(TimeGenerated, grain)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Model API Latency",
    "query": "// Author: Microsoft Azure\n// Display name: Model API Latency\n// Description: Time to complete Model operations by type over time.\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Diagnostics\n\nlet grain = 5m;\nADTModelsOperation\n| summarize avg(toint(DurationMs)) by OperationName, bin(TimeGenerated, grain)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Query API Latency",
    "query": "// Author: Microsoft Azure\n// Display name: Query API Latency\n// Description: Time to complete Query operations by type over time.\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Diagnostics\n\nlet grain = 5m;\nADTQueryOperation\n| summarize avg(toint(DurationMs)) by OperationName, bin(TimeGenerated, grain)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "DigitalTwin Error Summary",
    "query": "// Author: Microsoft Azure\n// Display name: DigitalTwin Error Summary\n// Description: List of all DigitalTwin call errors.\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Errors\n\nADTDigitalTwinsOperation\n| where ResultType != 'Success'"
  },
  {
    "source": "AzureMonitor",
    "name": "Model Error Summary",
    "query": "// Author: Microsoft Azure\n// Display name: Model Error Summary\n// Description: List of all Model call errors.\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Errors\n\nADTModelsOperation\n| where ResultType != 'Success'"
  },
  {
    "source": "AzureMonitor",
    "name": "Query Error Summary",
    "query": "// Author: Microsoft Azure\n// Display name: Query Error Summary\n// Description: List of all Query call errors.\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Errors\n\nADTQueryOperation\n| where ResultType != 'Success'"
  },
  {
    "source": "AzureMonitor",
    "name": "DigitalTwin API Usage",
    "query": "// Author: Microsoft Azure\n// Display name: DigitalTwin API Usage\n// Description: Count of DigitalTwin APIs by type (read, write and delete).\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Usage\n\nADTDigitalTwinsOperation\n| summarize count() by OperationName\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "EventRoutes API Usage",
    "query": "// Author: Microsoft Azure\n// Display name: EventRoutes API Usage\n// Description: Count of EventRoute APIs by type (read, write and delete).\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Usage\n\nADTEventRoutesOperation\n| summarize count() by OperationName\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Model API Usage",
    "query": "// Author: Microsoft Azure\n// Display name: Model API Usage\n// Description: Count of Model APIs by type (read, write and delete).\n// Categories: Audit,Azure Monitor\n// Resource types: Azure Digital Twins\n// Topic: Usage\n\nADTModelsOperation\n| summarize count() by OperationName\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Are there any failures",
    "query": "// Author: Microsoft Azure\n// Display name: Are there any failures?\n// Description: Count of failed MHSM pool requests by status code.\n// Categories: Security\n// Resource types: Azure Key Vault Managed HSMs\n// Topic: Usage and Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\"\n| where ResourceType == \"MANAGEDHSMS\"\n| where httpStatusCode_d \u003e= 300 and not(OperationName == \"Authentication\" and httpStatusCode_d == 401)\n| summarize count() by requestUri_s, ResultSignature, _ResourceId\n// ResultSignature contains HTTP status, e.g. \"OK\" or \"Forbidden\"\n// httpStatusCode_d contains HTTP status code returned by the request (e.g.  200, 300 or 401)\n// requestUri_s contains the URI of the request"
  },
  {
    "source": "AzureMonitor",
    "name": "Are there any slow requests",
    "query": "// Author: Microsoft Azure\n// Display name: Are there any slow requests?\n// Description: List of MHSM pool requests that took longer than 1sec.\n// Categories: Security\n// Resource types: Azure Key Vault Managed HSMs\n// Topic: Usage and Diagnostics\n\nlet threshold = 1000; // Let operator define a constant that can be further used in the query\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\"\n| where ResourceType == \"MANAGEDHSMS\"\n| where DurationMs \u003e threshold\n| summarize count() by OperationName, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "How active has this MHSM pool been",
    "query": "// Author: Microsoft Azure\n// Display name: How active has this MHSM pool been?\n// Description: Line chart showing trend of MHSM pool requests volume, per operation over time.\n// Categories: Security\n// Resource types: Azure Key Vault Managed HSMs\n// Topic: Usage and Diagnostics\n\n// MHSM pool diagnostic currently stores logs in AzureDiagnostics table which stores logs for multiple services.\n// Filter on ResourceProvider for logs specific to a service.\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\"\n| where ResourceType == \"MANAGEDHSMS\"\n| summarize count() by bin(TimeGenerated, 1h), OperationName // Aggregate by hour\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "How fast is this MHSM pool serving requests",
    "query": "// Author: Microsoft Azure\n// Display name: How fast is this MHSM pool serving requests?\n// Description: Line chart showing trend of request duration over time using different aggregations.\n// Categories: Security\n// Resource types: Azure Key Vault Managed HSMs\n// Topic: Usage and Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\"\n| where ResourceType == \"MANAGEDHSMS\"\n| summarize avg(DurationMs) by requestUri_s, bin(TimeGenerated, 1h) // requestUri_s contains the URI of the request\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "What changes occurred last month",
    "query": "// Author: Microsoft Azure\n// Display name: What changes occurred last month?\n// Description: Lists all update and patch requests from the last 30 days.\n// Categories: Security\n// Resource types: Azure Key Vault Managed HSMs\n// Topic: Usage and Diagnostics\n\n// MHSM pool diagnostic currently stores logs in AzureDiagnostics table which stores logs for multiple services.\n// Filter on ResourceProvider for logs specific to a service.\nAzureDiagnostics\n| where TimeGenerated \u003e ago(30d) // Time range specified in the query. Overrides time picker in portal.\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\"\n| where ResourceType == \"MANAGEDHSMS\"\n| where OperationName == \"ManagedHsmPut\" or OperationName == \"ManagedHsmPatch\"\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Who is calling this MHSM pool",
    "query": "// Author: Microsoft Azure\n// Display name: Who is calling this KeyVault?\n// Description: List of callers identified by their IP address with their request count.\n// Categories: Security\n// Resource types: Azure Key Vault Managed HSMs\n// Topic: Usage and Diagnostics\n\n// MHSM pool diagnostic currently stores logs in AzureDiagnostics table which stores logs for multiple services.\n// Filter on ResourceProvider for logs specific to a service.\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\"\n| where ResourceType == \"MANAGEDHSMS\"\n| summarize count() by CallerIPAddress"
  },
  {
    "source": "AzureMonitor",
    "name": "Autoscale failed operations",
    "query": "// Author: Microsoft Azure\n// Display name: Autoscale failed operations\n// Description: List all reports of failed operations, over the last day.\n// Categories: Azure Monitor,Audit\n// Resource types: Azure Monitor autoscale settings\n// Topic: Autoscale\n\nAutoscaleScaleActionsLog \n| where TimeGenerated \u003e ago(24h)  \n| where ResultType == \"Failed\""
  },
  {
    "source": "AzureMonitor",
    "name": "Autoscale operation status",
    "query": "// Author: Microsoft Azure\n// Display name: Autoscale operation status\n// Description: Lists latest Autoscale operations, scale direction, instance count and it's status.\n// Categories: Azure Monitor\n// Resource types: Azure Monitor autoscale settings\n// Topic: Autoscale\n\nAutoscaleScaleActionsLog\n| project TimeGenerated, ResourceId, CurrentInstanceCount, NewInstanceCount, ScaleDirection, ResultType\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Display top Autoscale 50 logs",
    "query": "// Author: Microsoft Azure\n// Display name: Display top Autoscale 50 logs\n// Description: Show the latest Azure Autoscale logs in the last 24 hours.\n// Categories: Azure Monitor\n// Resource types: Azure Monitor autoscale settings\n// Topic: Autoscale\n\nAutoscaleScaleActionsLog \n| where TimeGenerated \u003e ago(24h) \n| limit 50"
  },
  {
    "source": "AzureMonitor",
    "name": "Review Autoscale evaluations",
    "query": "// Author: Microsoft Azure\n// Display name: Review Autoscale evaluations\n// Description: Counts Autoscale evaluations in the last hour.\n// Categories: Azure Monitor\n// Resource types: Azure Monitor autoscale settings\n// Topic: Autoscale\n\nAutoscaleEvaluationsLog\n| where TimeGenerated \u003e ago(1h)\n| summarize count() by ResourceId, Profile, OperationName, EvaluationResult"
  },
  {
    "source": "AzureMonitor",
    "name": "Show the application logs which contain the error or exception terms",
    "query": "// Author: Microsoft Azure\n// Display name: Show the application logs which contain the \"error\" or \"exception\" terms\n// Description: Show the application logs which contain the \"error\" or \"exception\" terms in the last hour.\n// Categories: Azure Resources\n// Resource types: Azure Spring Cloud\n// Topic: App Logs\n\nAppPlatformLogsforSpring\n| where TimeGenerated \u003e ago(1h)\n| where Log contains \"error\" or Log contains \"exception\"\n| project TimeGenerated , ServiceName , AppName , InstanceName , Log , _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Show the error and exception number of each application",
    "query": "// Author: Microsoft Azure\n// Display name: Show the error and exception number of each application\n// Description: Show a pie chart of the number of the logs containing the \"error\" or \"exception\" terms in the last 24 hours, per application.\n// Categories: Azure Resources\n// Resource types: Azure Spring Cloud\n// Topic: App Logs\n\nAppPlatformLogsforSpring \n| where TimeGenerated \u003e ago(24h)\n| where Log contains \"error\" or Log contains \"exception\"\n| extend FullAppName = strcat(ServiceName, \"/\", AppName)\n| summarize count_per_app = count() by FullAppName, ServiceName, AppName, _ResourceId\n| sort by count_per_app desc \n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Show the config server logs",
    "query": "// Author: Microsoft Azure\n// Display name: Show the config server logs\n// Description: Filter the config server logs with the log level.\n// Categories: Azure Resources\n// Resource types: Azure Spring Cloud\n// Topic: System Logs\n\nAppPlatformSystemLogs \n| where TimeGenerated \u003e ago(1h)\n| where LogType == \"ConfigServer\" and Level in (\"WARN\", \"ERROR\")\n| project TimeGenerated , Level , ServiceName , Thread , Stack , Log , _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Pool resize failures",
    "query": "// Author: Microsoft Azure\n// Display name: Pool resize failures\n// Description: List pool resize failures by error code and time.\n// Categories: Azure Resources\n// Resource types: Batch accounts\n// Topic: Pools\n\nAzureDiagnostics\n| where OperationName==\"PoolResizeCompleteEvent\"\n| where resultCode_s==\"Failure\" // Filter only on failed pool resizes\n| summarize by poolName=id_s, resultCode=resultCode_s, resultMessage=resultMessage_s, operationTime=startTime_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Pool resizes",
    "query": "// Author: Microsoft Azure\n// Display name: Pool resizes\n// Description: List resize times by pool and result code (success or failure).\n// Categories: Azure Resources\n// Resource types: Batch accounts\n// Topic: Pools\n\nAzureDiagnostics\n| where OperationName==\"PoolResizeCompleteEvent\"\n| summarize operationTimes=make_list(startTime_s) by poolName=id_s, resultCode=resultCode_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed tasks per job",
    "query": "// Author: Microsoft Azure\n// Display name: Failed tasks per job\n// Description: Lists failed tasks by parent job.\n// Categories: Azure Resources\n// Resource types: Batch accounts\n// Topic: Tasks\n\nAzureDiagnostics\n| where OperationName==\"TaskFailEvent\"\n| summarize failedTaskList=make_list(id_s) by jobId=jobId_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Successful tasks per job",
    "query": "// Author: Microsoft Azure\n// Display name: Successful tasks per job\n// Description: Provides the number of successful tasks per job.\n// Categories: Azure Resources\n// Resource types: Batch accounts\n// Topic: Tasks\n\nAzureDiagnostics\n| where OperationName==\"TaskCompleteEvent\"\n| where executionInfo_exitCode_d==0 // Your application may use an exit code other than 0 to denote a successful operation\n| summarize successfulTasks=count(id_s) by jobId=jobId_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Task durations",
    "query": "// Author: Microsoft Azure\n// Display name: Task durations\n// Description: Gives the elapsed time of tasks in seconds, from task start to task complete.\n// Categories: Azure Resources\n// Resource types: Batch accounts\n// Topic: Tasks\n\nAzureDiagnostics\n| where OperationName==\"TaskCompleteEvent\"\n| extend taskId=id_s, ElapsedTime=datetime_diff('second', executionInfo_endTime_t, executionInfo_startTime_t) // For longer running tasks, consider changing 'second' to 'minute' or 'hour'\n| summarize taskList=make_list(taskId) by ElapsedTime"
  },
  {
    "source": "AzureMonitor",
    "name": "DisplayDirectLineChannelResponseCodesLineChart",
    "query": "// Author: Microsoft Azure\r\n// Display name: DisplayDirectLineChannelResponseCodesLineChart\r\n// Description: Display a Line Chart showing Direct Line channel requests response codes over a period of time.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(12h)\r\r\n| where Channel == \"directline\"\r\r\n| summarize count() by ResultCode, bin(TimeGenerated, 10m)\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "DisplayRequestsDurationLineChart",
    "query": "// Author: Microsoft Azure\r\n// Display name: DisplayRequestsDurationLineChart\r\n// Description: Display a Line Chart showing requests response times/duration over a period of time.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nlet start_time = ago(12h);\r\r\nlet end_time = now();\r\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e start_time and TimeGenerated \u003c= end_time\r\r\n| summarize DurationMs = avg(duration)  by bin(TimeGenerated, 10m)\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "DisplayResponseCodesLineChart",
    "query": "// Author: Microsoft Azure\r\n// Display name: DisplayResponseCodesLineChart\r\n// Description: Display a Line Chart showing requests response status codes over a period of time.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(6h)\r\r\n| summarize count() by ResultCode, bin(TimeGenerated, 10m)\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "DisplayResponseCodesPieChart",
    "query": "// Author: Microsoft Azure\r\n// Display name: DisplayResponseCodesPieChart\r\n// Description: Display a Pie Chart showing requests response status codes.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(12h)  \r\r\n| summarize count() by resultCode      \r\r\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "GetChannelToBotRequestsLogs",
    "query": "// Author: Microsoft Azure\r\n// Display name: GetChannelToBotRequestsLogs\r\n// Description: Gets a distinct list of all the requests from Direct Line channels to the bot.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(6h)\r\r\n| where Category == 'ABSChannelToBotRequests'\r\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "GetDirectLineChannelLogs",
    "query": "// Author: Microsoft Azure\r\n// Display name: GetDirectLineChannelLogs\r\n// Description: Retrieve all logs associated with Direct Line channel.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\n// This query helps retrieve logs associated with Direct Line channel.\r\r\n// You can replace \"directline\" with any channel whose logs you \r\r\n// would like to retrieve such as facebook, slack, etc. \r\r\n\r\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(12h)\r\r\n| where Channel == \"directline\"\r\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "GetFailedChannelsToBotRequests",
    "query": "// Author: Microsoft Azure\r\n// Display name: GetFailedChannelsToBotRequests\r\n// Description: Gets a distinct list of all the unsuccessful requests to bot from channels.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(12h)\r\r\n| where ResultCode !startswith \"2\"\r\r\n| where Category == 'ABSChannelToBotRequests'\r\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "GetFailedRequestsToDependencies",
    "query": "// Author: Microsoft Azure\r\n// Display name: GetFailedRequestsToDependencies\r\n// Description: Gets a distinct list of all the unsuccessful requests to dependencies.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(12h)\r\r\n| where ResultCode !startswith \"2\"\r\r\n| where Category == 'ABSDependenciesRequests'\r\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "GetRequestsToDependenciesLogs",
    "query": "// Author: Microsoft Azure\r\n// Display name: GetRequestsToDependenciesLogs\r\n// Description: Gets a distinct list of all the requests to dependencies.\r\n// Categories: Azure Resources\r\n// Resource types: Bot Services\r\n// Topic: Diagnostics\r\n\r\nABSBotRequests\r\r\n| where TimeGenerated \u003e ago(6h)\r\r\n| where Category == 'ABSDependenciesRequests'\r\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "4XX error rate by URL",
    "query": "// Author: Microsoft Azure\n// Display name: 4XX error rate by URL\n// Description: Show 4XX error rate by URL.\n// Categories: Network\n// Resource types: CDN profiles\n// Topic: Errors\n\n// Request errors rate by URL\n// Count number of requests with error responses by URL. \n// Summarize number of requests by URL, and status codes are 4XX\nAzureDiagnostics\n| where OperationName == \"Microsoft.Cdn/Profiles/AccessLog/Write\" and Category == \"AzureCdnAccessLog\" and isReceivedFromClient_b == true\n| extend Is4XX = (toint(httpStatusCode_d ) \u003e= 400 and toint(httpStatusCode_d ) \u003c 500)\n| summarize 4xxrate = (1.0 * countif(Is4XX)  / count()) * 100 by requestUri_s, bin(TimeGenerated, 1h)"
  },
  {
    "source": "AzureMonitor",
    "name": "Request errors by user agent",
    "query": "// Author: Microsoft Azure\n// Display name: Request errors by user agent\n// Description: Count number of requests with error responses by user agent.\n// Categories: Network\n// Resource types: CDN profiles\n// Topic: Errors\n\n// Request errors by user agent \n// Count number of requests with error responses by user agent. \n// Summarize number of requests per user agent and status codes \u003e= 400\nAzureDiagnostics\n| where OperationName == \"Microsoft.Cdn/Profiles/AccessLog/Write\" and Category == \"AzureCdnAccessLog\" \n| where isReceivedFromClient_b == true\n| where toint(httpStatusCode_d) \u003e= 400\n| summarize RequestCount = count() by UserAgent = userAgent_s, StatusCode = httpStatusCode_d , Resource\n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Requests per hour",
    "query": "// Author: Microsoft Azure\n// Display name: Requests per hour\n// Description: Render line chart showing total request per hour.\n// Categories: Network\n// Resource types: CDN profiles\n// Topic: Usage\n\n// Requests per hour \n// Render line chart showing total requests per hour \n// Summarize number of requests per hour \n// Change bins resolution from 1hr to 5m to get real time results)\nAzureDiagnostics \n| where OperationName == \"Microsoft.Cdn/Profiles/AccessLog/Write\" and Category == \"AzureCdnAccessLog\" \n| where isReceivedFromClient_b == \"true\"\n| summarize RequestCount = count() by bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 URL request count",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 URL request count\n// Description: Show top 10 URLs by request count.\n// Categories: Network\n// Resource types: CDN profiles\n// Topic: Usage\n\n// top URLs by request count\n// Render line chart showing total requests per hour . \n// Summarize number of requests per hour \nAzureDiagnostics\n | where ResourceProvider == \"MICROSOFT.CDN\" and Category == \"FrontDoorAccessLog\"\n | summarize UserRequestCount = count() by requestUri_s\n | order by UserRequestCount\n | limit 10"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 client Ips and http versions",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 client Ips and http versions\n// Description: Show top 10 client IPs and http versions.\n// Categories: Network\n// Resource types: CDN profiles\n// Topic: Usage\n\n// Top 10 client IPs and http versions \n// Show top 10 client IPs and http versions. \n// Summarize top 10 client ips and http versions\nAzureDiagnostics\n| where OperationName == \"Microsoft.Cdn/Profiles/AccessLog/Write\" and Category == \"AzureCdnAccessLog\"\n| where isReceivedFromClient_b == true\n| summarize RequestCount = count() by ClientIP = clientIp_s, HttpVersion = httpVersion_s, Resource\n| top 10 by RequestCount \n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Traffic by URL",
    "query": "// Author: Microsoft Azure\n// Display name: Traffic by URL\n// Description: Show egress from CDN edge by URL.\n// Categories: Network\n// Resource types: CDN profiles\n// Topic: Usage\n\n// Change bins resolution from 1hr to 5m to get real time results)\n// CDN edge response traffic by URL\nAzureDiagnostics\n| where OperationName == \"Microsoft.Cdn/Profiles/AccessLog/Write\" and Category == \"AzureCdnAccessLog\" \n| where isReceivedFromClient_b == true\n| summarize ResponseBytes = sum(toint(responseBytes_s)) by requestUri_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Unique IP request count",
    "query": "// Author: Microsoft Azure\n// Display name: Unique IP request count\n// Description: Show Unique IP request count.\n// Categories: Network\n// Resource types: CDN profiles\n// Topic: Usage\n\nAzureDiagnostics\n| where OperationName == \"Microsoft.Cdn/Profiles/AccessLog/Write\"and Category == \"AzureCdnAccessLog\"\n| where isReceivedFromClient_b == true\n| summarize dcount(clientIp_s) by bin(TimeGenerated, 1h)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "List Distinct Chat Operations",
    "query": "// Author: Microsoft Azure\r\n// Display name: List Distinct Chat Operations\r\n// Description: Returns all distinct combinations of Chat operation / version pairs.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Audit\r\n\r\nACSChatIncomingOperations\r\r\n| distinct OperationName, OperationVersion"
  },
  {
    "source": "AzureMonitor",
    "name": "List Distinct SMS Operations",
    "query": "// Author: Microsoft Azure\r\n// Display name: List Distinct SMS Operations\r\n// Description: Returns all distinct combinations of SMS operation / version pairs.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Audit\r\n\r\nACSSMSIncomingOperations\r\r\n| distinct OperationName, OperationVersion"
  },
  {
    "source": "AzureMonitor",
    "name": "Chat Operation Result Counts",
    "query": "// Author: Microsoft Azure\r\n// Display name: Chat Operation Result Counts\r\n// Description: For every Chat operation, count the types of returned results.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Diagnostics\r\n\r\nACSChatIncomingOperations\r\r\n| summarize Count = count() by OperationName, ResultType //, ResultSignature // This can also be uncommented to determine the count of each ResultSignature for each ResultType \r\r\n| order by OperationName asc, Count desc"
  },
  {
    "source": "AzureMonitor",
    "name": "SMS Operation Result Counts",
    "query": "// Author: Microsoft Azure\r\n// Display name: SMS Operation Result Counts\r\n// Description: For every SMS operation, count the types of returned results.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Diagnostics\r\n\r\nACSSMSIncomingOperations\r\r\n| summarize Count = count() by OperationName, ResultType //, ResultSignature // This can also be uncommented to determine the count of each ResultSignature for each ResultType \r\r\n| order by OperationName asc, Count desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Chat Operational Errors",
    "query": "// Author: Microsoft Azure\r\n// Display name: Chat Operational Errors\r\n// Description: List every Chat error ordered by recency.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Errors\r\n\r\nACSChatIncomingOperations\r\r\n| where ResultType == \"Failed\"\r\r\n| project TimeGenerated, OperationName, OperationVersion, ResultSignature, ResultDescription\r\r\n| order by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "SMS Operational Errors",
    "query": "// Author: Microsoft Azure\r\n// Display name: SMS Operational Errors\r\n// Description: List every SMS error ordered by recency.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Errors\r\n\r\nACSSMSIncomingOperations\r\r\n| where ResultType == \"Failed\"\r\r\n| project TimeGenerated, OperationName, OperationVersion, ResultSignature, ResultDescription\r\r\n| order by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Calculate Chat Operation Duration Percentiles",
    "query": "// Author: Microsoft Azure\r\n// Display name: Calculate Chat Operation Duration Percentiles\r\n// Description: Calculates the 90th, 95th, and 99th percentiles of run duration in ms for each Chat operation. It can be customized to be run for a single operation, or for other percentiles.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Performance\r\n\r\nACSChatIncomingOperations\r\r\n// where OperationName == \"\u003coperation\u003e\" // This can be uncommented and specified to calculate only a single operation's duration percentiles\r\r\n| summarize percentiles(DurationMs, 90, 95, 99) by OperationName, OperationVersion // calculate 90th, 95th, and 99th percentiles of each Operation"
  },
  {
    "source": "AzureMonitor",
    "name": "Calculate SMS Operation Duration Percentiles",
    "query": "// Author: Microsoft Azure\r\n// Display name: Calculate SMS Operation Duration Percentiles\r\n// Description: Calculates the 90th, 95th, and 99th percentiles of run duration in ms for each SMS operation. It can be customized to be run for a single operation, or for other percentiles.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Performance\r\n\r\nACSSMSIncomingOperations\r\r\n// where OperationName == \"\u003coperation\u003e\" // This can be uncommented and specified to calculate only a single operation's duration percentiles\r\r\n| summarize percentiles(DurationMs, 90, 95, 99) by OperationName, OperationVersion // calculate 90th, 95th, and 99th percentiles of each Operation"
  },
  {
    "source": "AzureMonitor",
    "name": "Get Long Calls",
    "query": "// Author: Microsoft Azure\r\n// Display name: Get Long Calls\r\n// Description: Retrive all the calls that lasted longer than an hours.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Usage\r\n\r\nACSBillingUsage\r\n| where tolower(UsageType) == \"audio\" // only look at records that are calls\r\n| extend Length = EndTime - StartTime\r\n| where Length \u003e 1h // return if the call is greater than an hour"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 5 IP Addresses per Chat Operation",
    "query": "// Author: Microsoft Azure\r\n// Display name: Top 5 IP Addresses per Chat Operation\r\n// Description: For every Chat operation, fetch the 5 IP addresses that have called that operaiton the most.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Usage\r\n\r\nACSChatIncomingOperations\r\r\n// | where OperationName == \"\u003coperation\u003e\" // This can be uncommented and specified to calculate only a single operation's count\r\r\n| top-nested of OperationName by dummy=max(0), // For all the Operations...\r\r\n  top-nested 5 of CallerIpAddress by count() // List the IP address that have called that operation the most\r\r\n| project-away dummy // Remove dummy line from the result set"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 5 IP Addresses per SMS Operation",
    "query": "// Author: Microsoft Azure\r\n// Display name: Top 5 IP Addresses per SMS Operation\r\n// Description: For every SMS operation, fetch the 5 IP addresses that have called that operaiton the most.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Usage\r\n\r\nACSSMSIncomingOperations\r\r\n// | where OperationName == \"\u003coperation\u003e\" // This can be uncommented and specified to calculate only a single operation's count\r\r\n| top-nested of OperationName by dummy=max(0), // For all the Operations...\r\r\n  top-nested 5 of CallerIpAddress by count() // List the IP address that have called that operation the most\r\r\n| project-away dummy // Remove dummy line from the result set"
  },
  {
    "source": "AzureMonitor",
    "name": "Weekly Record Count Breakdown",
    "query": "// Author: Microsoft Azure\r\n// Display name: Weekly Record Count Breakdown\r\n// Description: Over the past week, get the unique number of usage records for each mode each day.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Usage\r\n\r\nACSBillingUsage\r\r\n| where TimeGenerated \u003e startofday(ago(7d)) and TimeGenerated \u003c startofday(now()) // look at the usage for the past 7 full days\r\r\n| summarize Occurences=dcount(RecordId) by UsageType, bin(TimeGenerated, 1d) // count the number of unique records for each type of usage\r\r\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Weekly Usage Breakdown",
    "query": "// Author: Microsoft Azure\r\n// Display name: Weekly Usage Breakdown\r\n// Description: Over the past week, get the total usage for each mode each day.\r\n// Categories: Azure Resources\r\n// Resource types: Communication Services\r\n// Topic: Usage\r\n\r\nACSBillingUsage\r\r\n| where TimeGenerated \u003e startofday(ago(7d)) and TimeGenerated \u003c startofday(now()) // look at the usage for the past 7 full days\r\r\n| summarize Usage=sum(Quantity) by UsageType, bin(TimeGenerated, 1d) // count the number of units for each type of usage for each day\r\r\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Show login events reported over the last hour",
    "query": "// Author: Microsoft Azure\n// Display name: Show login events reported over the last hour\n// Description: A list of login event logs, sorted by time (earliest logs shown first).\n// Categories: Containers\n// Resource types: Container registries\n// Topic: App Logs\n\nContainerRegistryLoginEvents\n| where TimeGenerated \u003e ago(1h)\n| sort by TimeGenerated asc"
  },
  {
    "source": "AzureMonitor",
    "name": "Show registry events reported over the last hour",
    "query": "// Author: Microsoft Azure\n// Display name: Show registry events reported over the last hour\n// Description: A list of registry event logs, sorted by time (earliest logs shown first).\n// Categories: Containers\n// Resource types: Container registries\n// Topic: App Logs\n\nContainerRegistryRepositoryEvents\n| where TimeGenerated \u003e ago(1h)\n| sort by TimeGenerated asc"
  },
  {
    "source": "AzureMonitor",
    "name": "Which tables have logs",
    "query": "// Author: Microsoft Azure\n// Display name: Which tables have logs?\n// Description: Lists all tables that contain logs.\n// Categories: Azure Resources\n// Resource types: Container registries\n// Topic: Preview Data\n\n// If no results were found, try selecting another time range using the Time Picker in the top bar\nunion withsource = Tables *\n| where TimeGenerated \u003e ago(24h)\n| distinct Tables"
  },
  {
    "source": "AzureMonitor",
    "name": "Collections with throttles 429 in past 24 hours",
    "query": "// Author: Microsoft Azure\n// Display name: Collections with throttles (429) in past 24 hours\n// Description: Identify collections and operations that have received 429 (throttles), which occur when consumed throughput (RU/s) exceeds provisioned throughput.\n// Categories: Azure Resources\n// Resource types: Cosmos DB\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e= ago(24hr)\n| where Category == \"DataPlaneRequests\"\n| where statusCode_s == 429 \n| summarize numberOfThrottles = count() by databaseName_s, collectionName_s, requestResourceType_s, _ResourceId, bin(TimeGenerated, 1hr)\n| order by numberOfThrottles"
  },
  {
    "source": "AzureMonitor",
    "name": "Consumed RUs in last 24 hours",
    "query": "// Author: Microsoft Azure\n// Display name: Consumed RU/s in last 24 hours\n// Description: Identify consumed RU/s on Cosmos databases and collections.\n// Categories: Azure Resources\n// Resource types: Cosmos DB\n// Topic: Diagnostics\n\n//You can compare the RU/s consumption with your provisioned RU/s to determine if you should scale up or down RU/s based on your workload.\nAzureDiagnostics\n| where TimeGenerated \u003e= ago(24hr)\n| where Category == \"DataPlaneRequests\"\n//| where collectionName_s == \"CollectionToAnalyze\" //Replace to target the query to a collection\n| summarize ConsumedRUsPerMinute = sum(todouble(requestCharge_s)) by collectionName_s, _ResourceId, bin(TimeGenerated, 1m)\n| project TimeGenerated , ConsumedRUsPerMinute , collectionName_s, _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Top logical partition keys by storage",
    "query": "// Author: Microsoft Azure\n// Display name: Top logical partition keys by storage\n// Description: Identify largest logical partition key values. PartitionKeyStatistics will emit data for top logical partition keys by storage.\n// Categories: Azure Resources\n// Resource types: Cosmos DB\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where Category == \"PartitionKeyStatistics\"\n//| where collectionName_s == \"CollectionToAnalyze\" //Replace to target the query to a collection\n| summarize arg_max(TimeGenerated, *) by databaseName_s, collectionName_s, partitionKey_s, _ResourceId //Get the latest storage size\n| extend utilizationOf20GBLogicalPartition = sizeKb_d / 20000000 //20GB\n| project TimeGenerated, databaseName_s , collectionName_s , partitionKey_s, sizeKb_d, utilizationOf20GBLogicalPartition, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Top operations by consumed Request Units RUs in last 24 hours",
    "query": "// Author: Microsoft Azure\n// Display name: Top operations by consumed Request Units (RUs) in last 24 hours\n// Description: Identify top operations on Cosmos resources by count and consumed RU per operation.\n// Categories: Azure Resources\n// Resource types: Cosmos DB\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e= ago(24h)\n| where Category == \"DataPlaneRequests\"\n| summarize numberOfOperations = count(), totalConsumedRU = sum(todouble(requestCharge_s)) by databaseName_s, collectionName_s, OperationName, requestResourceType_s, requestResourceId_s, _ResourceId\n| extend averageRUPerOperation = totalConsumedRU / numberOfOperations \n| order by numberOfOperations"
  },
  {
    "source": "AzureMonitor",
    "name": "Top queries by consumed Request Units RUs in last 24 hours",
    "query": "// Author: Microsoft Azure\n// Display name: Top queries by consumed Request Units (RUs) in last 24 hours\n// Description: Identify top queries on Cosmos resources by count and RU charge of each query.\n// Categories: Azure Resources\n// Resource types: Cosmos DB\n// Topic: Diagnostics\n\nlet queryRUChargeData = AzureDiagnostics\n| where Category == \"DataPlaneRequests\"\n| where OperationName == \"Query\"\n| project requestCharge_s, activityId_g, databaseName_s, collectionName_s, requestResourceType_s, requestResourceId_s, OperationName, TimeGenerated, callerId_s, clientIpAddress_s, userAgent_s;\nAzureDiagnostics\n| where Category == \"QueryRuntimeStatistics\"\n| join queryRUChargeData on $left.activityId_g == $right.activityId_g\n| summarize numberOfTimesRun = count(), totalConsumedRU = sum(todouble(requestCharge_s1)) by databaseName_s, collectionName_s, OperationName1, requestResourceType_s1, requestResourceId_s1, querytext_s, callerId_s1, clientIpAddress_s1, userAgent_s1, _ResourceId, bin(TimeGenerated1, 1min) //bin by 1 minute\n| extend averageRUPerExecution = totalConsumedRU / numberOfTimesRun\n| order by averageRUPerExecution desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Chart of daily received snapshots",
    "query": "// Author: Microsoft Azure\n// Display name: Chart of daily received snapshots\n// Description: A time chart of the daily snapshots count, over the past week.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Audit\n\n// Failed, In Progress and Succeeded Received Snapshots\nMicrosoftDataShareReceivedSnapshotLog \n| where TimeGenerated \u003e ago(7d)  \n| summarize count() by bin(TimeGenerated, 1d), Status , _ResourceId // Aggregating by day //Click \"Table\" to see resource's name.\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Chart of daily sent snapshots",
    "query": "// Author: Microsoft Azure\n// Display name: Chart of daily sent snapshots\n// Description: A time chart of recent snapshots count, succeeded VS failed.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Audit\n\n//Succeeded VS Failed\nMicrosoftDataShareSentSnapshotLog \n| where TimeGenerated \u003e ago(30d)  \n| summarize count() by bin(TimeGenerated, 1d), Status, _ResourceId // Aggregating by day //Click \"Table\" to see resource's name.\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "List sent snapshots by duration",
    "query": "// Author: Microsoft Azure\n// Display name: List sent snapshots by duration\n// Description: A list of the snapshots sorted by duration time over the last 7 days.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Audit\n\nMicrosoftDataShareSentSnapshotLog\n| where TimeGenerated \u003e ago(7d) \n| where StartTime != \"\" and EndTime  != \"\" \n| project StartTime , EndTime , DurationSeconds =(todatetime(EndTime)-todatetime(StartTime))/1s , ResourceName = split(_ResourceId,\"/accounts/\",1) \n| sort by DurationSeconds desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "Count failed received snapshots",
    "query": "// Author: Microsoft Azure\n// Display name: Count failed received snapshots\n// Description: Count of failed snapshots over the last 7 days.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Errors\n\nMicrosoftDataShareReceivedSnapshotLog\n| where TimeGenerated \u003e ago(7d)  \n| where Status == \"Failed\" \n| summarize count() by _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Count failed sent snapshots",
    "query": "// Author: Microsoft Azure\n// Display name: Count failed sent snapshots\n// Description: Total count of failed snapshots over the last 7 days.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Errors\n\nMicrosoftDataShareSentSnapshotLog\n| where TimeGenerated \u003e ago(7d)  \n| where Status == \"Failed\" \n| summarize count() by _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Frequent errors in received snapshots",
    "query": "// Author: Microsoft Azure\n// Display name: Frequent errors in received snapshots\n// Description: Top 10 most frequent errors over the last 7 days.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Errors\n\nMicrosoftDataShareReceivedSnapshotLog \n| where TimeGenerated \u003e ago(7d)  \n| where Status == \"Failed\" \n| summarize count() by _ResourceId, DataSetType // Counting failed logs per datasettype\n| top 10 by count_ desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "Frequent errors in sent snapshots",
    "query": "// Author: Microsoft Azure\n// Display name: Frequent errors in sent snapshots\n// Description: List top 10 errors over the last 7 days.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Errors\n\nMicrosoftDataShareSentSnapshotLog \n| where TimeGenerated \u003e ago(7d)  \n| where Status == \"Failed\" \n| summarize count() by _ResourceId, DataSetType// Counting failed logs per datasettype\n| top 10 by count_ desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "List received snapshots by duration",
    "query": "// Author: Microsoft Azure\n// Display name: List received snapshots by duration\n// Description: A list of the snapshots sorted by duration time, over the last 7 days.\n// Categories: Audit\n// Resource types: Data Shares\n// Topic: Performance\n\nMicrosoftDataShareReceivedSnapshotLog\n| where TimeGenerated \u003e ago(7d)  \n| where StartTime != \"\" and EndTime  != \"\"\n| project StartTime , EndTime , DurationSeconds =(todatetime(EndTime)-todatetime(StartTime))/1s, ResourceName = split(_ResourceId,\"/accounts/\",1)// use split to get a part of the _ResourceId  \n| sort by DurationSeconds desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed or canceled pipelines",
    "query": "// Author: David Reynolds @ Microsoft\n// Display name: Failed or canceled pipelines\n// Description: Alerts when an ADF pipeline does not complete successfully\n// Categories: Azure Data Factory\n// Resource types: Azure Data Factory\n// Topic: Alert\n\nADFPipelineRun \n| where Status != \"Queued\" and Status != \"InProgress\" and Status != \"Succeeded\" and Status != \"Canceling\"\n| where PipelineName in (    // list pipelines to monitor here\n    \"Pipeline Name 1\",\n    \"Pipeline Name 2\",\n    \"Pipeline Name 3\",\n    \"Pipeline Name 4\")\n| project TimeGenerated, PipelineName, Status, Start, End, Parameters"
  },
  {
    "source": "AzureMonitor",
    "name": "Long running pipelines",
    "query": "// Author: David Reynolds @ Microsoft\n// Display name: Long running pipelines\n// Description: Alerts when an ADF pipeline runs longer than an hour\n// Categories: Azure Data Factory\n// Resource types: Azure Data Factory\n// Topic: Alert\n\nADFPipelineRun \n| where Status != \"Queued\" and Status != \"Canceling\"\n| where PipelineName == \"Pipeline name 1\"                    // replace with the name of the pipeline you wish to monitor\n| extend ActualEnd = case(End \u003c datetime(1990), now(), End)  // running pipelines do not have an end time yet, so treat it as now\n| summarize arg_max(TimeGenerated, *) by RunId\n| extend Runtime = ActualEnd - Start\n| where Runtime \u003e timespan(1h)\n| project TimeGenerated, PipelineName, Status, Runtime, Start, End, Parameters\n| order by Runtime desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Pipeline changed",
    "query": "// Author: David Reynolds @ Microsoft\n// Display name: ADF Pipeline Added/Modified/Deleted\n// Description: Alerts when an ADF pipeline is added, changed, or deleted\n// Categories: Azure Data Factory\n// Resource types: Azure Data Factory\n// Topic: Alert\n\nAzureActivity \n| where OperationNameValue in (\"MICROSOFT.DATAFACTORY/FACTORIES/PIPELINES/WRITE\",\"MICROSOFT.DATAFACTORY/FACTORIES/PIPELINES/DELETE\")\n| summarize arg_max(TimeGenerated, *) by CorrelationId\n| extend Res=tostring(Properties_d.resource),\n         Op=tostring(trim_start(\"MICROSOFT.DATAFACTORY/FACTORIES/PIPELINES/\", OperationNameValue))\n| where Res has \"ADF Name\"                        // replace with the name of your ADF\n| project TimeGenerated, ResourceGroup, Caller, Res, ActivityStatusValue, Op"
  },
  {
    "source": "AzureMonitor",
    "name": "Activity Runs Availability",
    "query": "// Author: Microsoft Azure\n// Display name: Activity Runs Availability\n// Description: Gives the availability of the Activity Runs.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Availability\n\nADFActivityRun    \n| where Status != 'InProgress' and Status != 'Queued'\n| where FailureType != 'UserError'\n| summarize availability = 100.00 - (100.00*countif(Status != 'Succeeded') / count())  by bin(TimeGenerated, 1h)), _ResourceId\n| order by TimeGenerated asc\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "PipelineRuns Availability",
    "query": "// Author: Microsoft Azure\n// Display name: PipelineRuns Availability\n// Description: Gives the availability of the Pipeline Runs.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Availability\n\nADFPipelineRun    \n| where Status != 'InProgress' and Status != 'Queued'\n| where FailureType != 'UserError'\n| summarize availability = 100.00 - (100.00*countif(Status != 'Succeeded') / count())  by bin(TimeGenerated, 1h)), _ResourceId\n| order by TimeGenerated asc\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "TriggerRuns Availability",
    "query": "// Author: Microsoft Azure\n// Display name: TriggerRuns Availability\n// Description: Gives the availability of the Trigger Runs.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Availability\n\nADFTriggerRun    \n| where Status != 'Running' and Status != 'Waiting' and Status != 'WaitingOnDependency'\n| where TriggerFailureType != 'UserError'\n| summarize availability = 100.00 - (100.00*countif(Status != 'Succeeded') / count())  by bin(TimeGenerated, 1h)), _ResourceId\n| order by TimeGenerated asc\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Activity runs Top 5 Failures",
    "query": "// Author: Microsoft Azure\n// Display name: Activity runs Top 5 Failures\n// Description: Returns Top 5 Activitys failing with systemErrors.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Diagnostics\n\nlet name = ADFActivityRun\n| where Status != 'InProgress' and Status != 'Queued'\n| where FailureType != 'UserError'\n| summarize failureCount = countif(Status != 'Succeeded') by ActivityName\n| top 5 by failureCount desc nulls last\n| where failureCount != 0\n| project ActivityName;\nADFActivityRun \n| where TimeGenerated \u003e= ago(24h)\n| where Status != 'InProgress' and Status != 'Queued'\n| where FailureType != 'UserError'\n| where ActivityName  in (name)\n| summarize failureCount = countif(Status != 'Succeeded') by bin(TimeGenerated, 1h), ActivityName\n| order by TimeGenerated asc\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Pipeline runs Top 5 Failures",
    "query": "// Author: Microsoft Azure\n// Display name: Pipeline runs Top 5 Failures\n// Description: Returns Top 5 pipelines failing with systemErrors.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Diagnostics\n\nlet name = ADFPipelineRun\n| where Status != 'InProgress' and Status != 'Queued'\n| where FailureType != 'UserError'\n| summarize failureCount = countif(Status != 'Succeeded') by PipelineName\n| top 5 by failureCount desc nulls last\n| where failureCount != 0\n| project PipelineName;\nADFPipelineRun \n| where TimeGenerated \u003e= ago(24h)\n| where Status != 'InProgress' and Status != 'Queued'\n| where FailureType != 'UserError'\n| where PipelineName  in (name)\n| summarize failureCount = countif(Status != 'Succeeded') by bin(TimeGenerated, 1h), PipelineName\n| order by TimeGenerated asc\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Trigger runs Top 5 Failures",
    "query": "// Author: Microsoft Azure\n// Display name: Trigger runs Top 5 Failures\n// Description: Returns Top 5 Triggers failing with systemErrors.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Diagnostics\n\nlet name = ADFTriggerRun\n| where Status != 'Running' and Status != 'Waiting' and Status != 'WaitingOnDependency'\n| where TriggerFailureType != 'UserError'\n| summarize failureCount = countif(Status != 'Succeeded') by TriggerName\n| top 5 by failureCount desc nulls last\n| where failureCount != 0\n| project TriggerName;\nADFTriggerRun \n| where TimeGenerated \u003e= ago(24h)\n| where Status != 'Running' and Status != 'Waiting' and Status != 'WaitingOnDependency'\n| where TriggerFailureType != 'UserError'\n| where TriggerName  in (name)\n| summarize failureCount = countif(Status != 'Succeeded') by bin(TimeGenerated, 1h), TriggerName\n| order by TimeGenerated asc\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Activity runs latest Status",
    "query": "// Author: Microsoft Azure\n// Display name: Activity runs latest Status\n// Description: Returns latest Status of Activity runs.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Performance\n\nADFActivityRun\n| summarize argmax(TimeGenerated, * ) by ActivityRunId, Status, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Pipeline runs latest Status",
    "query": "// Author: Microsoft Azure\n// Display name: Pipeline runs latest Status\n// Description: Returns latest Status of pipeline runs.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Performance\n\nADFPipelineRun\n| summarize argmax(TimeGenerated, * ) by RunId, Status, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Trigger runs latest Status",
    "query": "// Author: Microsoft Azure\n// Display name: Trigger runs latest Status\n// Description: Returns latest Status of Trigger runs.\n// Categories: Azure Resources\n// Resource types: Data factories\n// Topic: Performance\n\nADFTriggerRun\n| summarize argmax(TimeGenerated, * ) by TriggerId, Status, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "API Requests Being Throttled",
    "query": "// Author: aliyoussefi\n// Display name: API Requests Being Throttled\n// Description: Count of API calls over a given amount of time. Variables are of type datetime\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: API, Health, Resiliency\n\nrequests \n| where timestamp between (_fromStartTime .. _toEndTime) //datetime\n| where resultCode == \"429\" and success == \"False\""
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - API Calls",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - API Calls\n// Description: Count of API calls over a given amount of time. Variables are of type datetime\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: API\n\nrequests\n| where timestamp between (_fromStartTime .. _toEndTime) //datetime\n| count"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - API Pass Rate",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - API Pass Rate\n// Description: Percentage of API successfulness over a given amount of time. Variables are datetime\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: API, Health, Resiliency\nrequests\n| where timestamp between (_fromStartTime .. _toEndTime) //datetime\n| summarize CountFailed = countif(success == false), Count = count()\n| project round(100.0 * (Count - CountFailed) / Count, 2)"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - Most Used Entities",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center - Total Operations by Entity\n// Description: This chart shows how many operations (create, update, deletes, reads) have occurred in the environment with a Dataverse database grouped by table over the specified time.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Usage\ndependencies\n| where timestamp between (_fromStartTime .. _toEndTime)\n| where user_Id != \"00000000-0000-0000-0000-000000000000\"\n| where isempty(operation_SyntheticSource)\n| where type in  (\"SDKCreate\", \"SDKUpdate\", \"SDKRetrieve\", \"SDKDelete\")\n| summarize sumDimension = count() by name, type\n| top 10 by sumDimension"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - Most active users performing operations",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - Most active users performing operations\n// Description: Most active users performing CRUD operations over a given amount of time. Variables are datetime\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: API\ndependencies\n| where timestamp between (_fromStartTime .. _toEndTime) //datetime\n| where user_Id != \"00000000-0000-0000-0000-000000000000\"\n| where isempty(operation_SyntheticSource)\n| where type in  (\"SDKCreate\", \"SDKUpdate\", \"SDKRetrieve\", \"SDKDelete\")\n| summarize sumDimension = count() by user_Id, type\n| top 10 by sumDimension"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - Plug-In Executions",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - Plug-In Executions\n// Description: Count of Plug-in executions over a given amount of time. Variables are datetime\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: API\ndependencies\n| where timestamp between (_fromStartTime .. _toEndTime) //datetime\n| where type == \"Plugin\"\n| count"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - Top plug-ins by failures",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - Top plug-ins by failures\n// Description: Top plug-ins with failures over a given amount of time. Variables are datetime\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: API\ndependencies\n| where timestamp between(_fromStartTime .. _toEndTime) //datetime\n| where type == \"Plugin\"\n| extend cd = parse_json(customDimensions)\n| summarize PerceivedErrors = countif(success==\"False\") by name\n| top 10 by name"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - Total Operations",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - Total Operations\n// Description: Total Operations This chart shows how many operations (create, update, deletes, reads) have occurred in the environment with a Dataverse database over the specified time. Variables are datetime\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: API\ndependencies\n| where timestamp between (_fromStartTime .. _toEndTime) //datetime\n| where type in  (\"SDKCreate\", \"SDKUpdate\", \"SDKRetrieve\", \"SDKDelete\")\n    | where user_Id != \"00000000-0000-0000-0000-000000000000\"\n    | where isempty(operation_SyntheticSource)\n| make-series \nRequests = count() default = 0 on timestamp in range(_fromStartTime, _toEndTime, 1h) by type\n| mvexpand timestamp to typeof(datetime), Requests to typeof(long)"
  },
  {
    "source": "AzureMonitor",
    "name": "ServiceBus Exceptions with Column Chart",
    "query": "// Author: aliyoussefi\n// Display name: ServiceBus Exceptions with Column Chart\n// Description: visualization of exceptions encountered when delivering to registered service bus endpoint\n// Categories: Dataverse\n// Resource types: Dataverse, Azure Service Bus\n// Topic: Other errors and failures\n\nexceptions\n| where timestamp between (ago(30d)..now())\n| extend cd = parse_json(customDimensions)\n| where cd.exceptionSource has 'ServiceBus.WebhookPlugin'\n| project timestamp, outerMessage, cd.correlationId, cd.entityName, cd.organizationId\n| summarize count() by bin(timestamp, 1d)\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Timeout Correlation IDs by Table",
    "query": "// Author: Jeff Thompson and Darrin Devine\n// Display name: timeout correlation id's by table\n// Description: timeout correlation id's by table\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\n\nexceptions\n| where timestamp \u003e= ago(1d)\n| where outerMessage has \"timeout\"\n| extend Table= tostring(customDimensions.entityName)\n| where Table == 'enter Table'\n| where userId == 'enter UserId'\n| project timestamp, user_Id, customDimensions.correlationId"
  },
  {
    "source": "AzureMonitor",
    "name": "Timeouts Per Day Per Hour",
    "query": "// Author: Jeff Thompson and Darrin Devine\n// Display name: timeouts per day per hour\n// Description: timeouts per day per hour\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\nexceptions\n| where timestamp \u003e= ago(14d)\n| where outerMessage has \"timeout\"\n| summarize count() by bin(timestamp,1h)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Timeouts Per Hour Per Table",
    "query": "// Author: Jeff Thompson and Darrin Devine\n// Display name: timeouts per hour per table\n// Description: timeouts per hour per table\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\nexceptions\n| where timestamp \u003e= ago(7d)\n| where outerMessage has \"timeout\"\n| extend Table= tostring(customDimensions.entityName)\n| summarize count(),dcount(user_Id) by Table,bin(timestamp,1h)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Timeouts and Distinct Users by Table",
    "query": "// Author: Jeff Thompson and Darrin Devine\n// Display name: timeouts and distinct users by Table\n// Description: summary of timeout exceptions by distinct user id\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\nexceptions\n| where timestamp \u003e= ago(14d)\n| where outerMessage has \"timeout\"\n| extend Table= tostring(customDimensions.entityName)\n| summarize count(),dcount(user_Id) by Table,problemId\n| order by count_ desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Timeouts by Table and UserId",
    "query": "// Author: Jeff Thompson and Darrin Devine\n// Display name: timeouts by Table and UserId\n// Description: timeouts by Table and UserId\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\n\nexceptions\n| where timestamp \u003e= ago(14d)\n| where outerMessage has \"timeout\"\n| extend Table= tostring(customDimensions.entityName)\n| summarize count() by Table,user_Id\n| order by count_ desc"
  },
  {
    "source": "AzureMonitor",
    "name": "API Pass Rate",
    "query": "// Author: aliyoussefi\n// Display name: API Pass Rate\n// Description: This chart shows the API pass rate as percentage of total API calls that were made in the environment with a Dataverse database over the specified time.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Performance, Health, Resiliency\n\nrequests\n| where timestamp between (_fromStartTime .. _toEndTime)\n| summarize CountFailed = countif(success == false), Count = count()\n| project round(100.0 * (Count - CountFailed) / Count, 2)"
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of mobile page load duration in percentiles",
    "query": "// Author: aliyoussefi\n// Display name: Summary of mobile page load duration in percentiles\n// Description: Summary of Table and View load duration in 50%, 75% and 95% percentiles in last 30 days.\n// Categories: Azure Resources\n// Resource types: Dataverse\n// Topic: Page performance\n\npageViews\n|where timestamp between(ago(30d).. now())\n| extend cd = parse_json(customDimensions)\n| where cd.isBoot == 'false'\n|summarize\n    WarmPageCounts=countif(tostring(cd.loadType)==\"1\"),\n    ColdPageCounts=countif(tostring(cd.loadType)==\"0\"),\n    Mobile=countif(tostring(cd.hostType) == \"MobileApplication\"),\n    PageLoadCount = count(), \n    UserCount = dcount(user_AuthenticatedId), \n    (P50,P75,P95)=percentiles(duration,50,75,95) by bin(timestamp,1d)\n|project startTime = timestamp ,P50, P75,P95,PageLoadCount, Mobile, UserCount, WarmPageCounts, ColdPageCounts\n|order by startTime asc nulls last\n|render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of page load duration in percentiles",
    "query": "// Author: aliyoussefi\n// Display name: Summary of page load duration in percentiles\n// Description: Summary of Table and View load duration in 50%, 75% and 95% percentiles in last 30 days.\n// Categories: Azure Resources\n// Resource types: Dataverse\n// Topic: Page performance\n\npageViews\n|where timestamp between(ago(30d).. now())\n| extend cd = parse_json(customDimensions)\n| where cd.isBoot == 'false'\n|summarize\n    WarmPageCounts=countif(tostring(cd.loadType)==\"1\"),\n    ColdPageCounts=countif(tostring(cd.loadType)==\"0\"),\n    Mobile=countif(tostring(cd.hostType) == \"MobileApplication\"),\n    PageLoadCount = count(), \n    UserCount = dcount(user_AuthenticatedId), \n    (P50,P75,P95)=percentiles(duration,50,75,95) by bin(timestamp,1d)\n|project startTime = timestamp ,P50, P75,P95,PageLoadCount, Mobile, UserCount, WarmPageCounts, ColdPageCounts\n|order by startTime asc nulls last\n|render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Slowest Pages last 30 days",
    "query": "// Author: aliyoussefi\n// Display name: Top 10 Slowest Pages last 30 days\n// Description: Summary of Table and View load duration.\n// Categories: Azure Resources\n// Resource types: Dataverse\n// Topic: Page performance\n\n// Slowest pages \n// What are the 10 slowest pages, and how slow are they? \npageViews\n|where timestamp between(ago(30d)..now())\n| where notempty(duration)\n| extend total_duration=duration*itemCount\n| summarize avg_duration=(sum(total_duration)/sum(itemCount)) by operation_Name\n| top 10 by avg_duration desc\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Warm and Cold Form Load Data by Table",
    "query": "// Author: Jeff Thompson\n// Display name: Warm and Cold Form Load Data by Table\n// Description: Shows loads, avg duration, p90 duration for both cold and warm loads and by table.\n// Categories: Azure Resources\n// Resource types: Dataverse\n// Topic: Page performance\n// Revision: ddevine-msft 5/24/2024 \n\n// warm and cold form Load data by Table\nlet start = datetime('2024-5-1 00:00'); //Enter Start Date\nlet end = datetime('2024-5-30 23:59'); //Enter End Date\nlet table = dynamic(['lead', 'contact', 'account','opportunity']); // Enter list of tables to evaluate\npageViews\n| where timestamp between(start..end) //\u003e= ago(1d)\n| where name startswith \"EditForm Load\"\n| extend LoadType = todouble(customDimensions.loadType)\n| extend LoadTypeName = case( LoadType in (0,1), 'Cold', LoadType in (2,3) , 'Warm', 'Other')\n| extend syncRequestTime = todouble(customDimensions.syncRequestTime)\n| extend Table = tostring(customDimensions.entityName)\n| where Table in (table)\n| where LoadTypeName == 'Warm'\n| extend  ['Host Type'] = tostring(customDimensions.hostType)\n| summarize ['Warm Loads']=count(), ['Warm Avg MS']=round(avg(duration)), ['Warm P90 MS']=round(percentile(duration,90)),['Avg Warm Sync Request MS']=round(avg(syncRequestTime)) by Table\n|join kind = fullouter \n(pageViews\n| where timestamp between(start..end) \n| where name startswith \"EditForm Load\"\n| extend LoadType = todouble(customDimensions.loadType)\n| extend LoadTypeName = case( LoadType in (0,1), 'Cold', LoadType in (2,3) , 'Warm', 'Other')\n| extend syncRequestTime = todouble(customDimensions.syncRequestTime)\n| extend Table = tostring(customDimensions.entityName)\n| where Table in (table)\n| where LoadTypeName == 'Cold'\n| extend  ['Host Type'] = tostring(customDimensions.hostType)\n| summarize ['Cold Loads']=count(), ['Cold Avg MS']=round(avg(duration)), ['Cold P90 MS']=round(percentile(duration,90)), ['Avg Cold Sync Request MS']=round(avg(syncRequestTime)) by Table) \non Table\n| project ['Table Name']= coalesce(Table,Table1),['Warm Loads'], ['Cold Loads'], ['Warm Avg MS'], ['Cold Avg MS'], ['Warm P90 MS'], ['Cold P90 MS'],['Avg Cold Sync Request MS'],['Avg Warm Sync Request MS']"
  },
  {
    "source": "AzureMonitor",
    "name": "Count Request Operation Verbs by User last 24 hours",
    "query": "// Author: aliyoussefi\n// Display name: Count Request Operation Verbs last 24 hours by user\n// Description: Summary of Dataverse requests by verb over the last 24 hours by user\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Request Diagnostics\n\nrequests\n| where timestamp \u003e ago(1d)\n| extend operation1 = split(operation_Name, \" \")[0]\n| project timestamp,operation_Name, url, success, duration, user_Id, session_Id, operation_Id, operation1\n| summarize OperationCount = count() by UserId = user_Id,Operation = tostring(operation1)\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Count Request Operation Verbs last 24 hours",
    "query": "// Author: aliyoussefi\n// Display name: Count Request Operation Verbs last 24 hours\n// Description: Summary of Dataverse requests by verb over the last 24 hours\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Request Diagnostics\n\nrequests\n| where timestamp \u003e ago(1d)\n| extend operation1 = split(operation_Name, \" \")[0]\n| project timestamp,operation_Name, url, success, duration, user_Id, session_Id, operation_Id, operation1\n| summarize OperationCount = count() by Operation = tostring(operation1)\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Dependency Performance by Country",
    "query": "// Author: Sam Danesis\n// Display name: Summarization of dependencies latency by country or region\n// Description: Summarization of dependencies latency by country or region \n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Dependency Diagnostics\n\ndependencies\n| extend cd = parse_json(customDimensions)\n| project stall = cd[\"stall\"], client_CountryOrRegion, download = cd[\"download\"], Duration = cd[\"duration\"]\n| extend downloadstall = todouble(stall),DDL = todouble(download), DDuration = todouble(Duration)\n| extend total = downloadstall + DDL + DDuration\n| summarize percentile(total),90) by client_CountryOrRegion"
  },
  {
    "source": "AzureMonitor",
    "name": "Timechart of CRUD Operations over last 24 hours",
    "query": "// Author: aliyoussefi\n// Display name: Timechart of CRUD Operations over last 24 hours\n// Description: Summary of Dataverse CRUD operations by SDK Message over the last 24 hours. Results can be drilled down by user_Id which is Azure AD Object Id.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Dependency Diagnostics\n\n//Operations view (CRUD) - All operations by all users by duration\nlet crudTable = dependencies\n| where timestamp between (ago(1d) .. now())\n| where type in (\"SDKCreate\", \"SDKUpdate\", \"SDKRetrieve\",\"SDKRetrieveMultiple\", \"SDKDelete\");\n//| where user_Id != \"00000000-0000-0000-0000-000000000000\";\nlet splitTable = () {\n    crudTable\n    | extend dimension = column_ifexists('user_Id', '')\n    | extend dimension = iif(isempty(dimension), \"\u003cundefined\u003e\", dimension)\n};\nlet cohortedTable = splitTable\n    | summarize events_Counts = count() by bin(timestamp, 1h), type, dimension;\ncohortedTable\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "API Pass Rate",
    "query": "// Author: aliyoussefi\n// Display name: Top 10 Failing Dependencies\n// Description: Summary of failing dependencies\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\ndependencies\n| where timestamp \u003e ago(7d)\n| where success == false\n| summarize ['Failing Dependencies'] = count() by ['Dependency'] = name\n| top 10 by ['Failing Dependencies'] desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed Power Automate to Dataverse Requests",
    "query": "// Author: aliyoussefi\n// Display name: Failed Power Automate to Dataverse Requests\n// Description: List unsuccessful calls to the Dataverse API from Power Automate.\n// Categories: Azure Resources,Applications\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\nrequests\n| where timestamp between(ago(30d).. now()) //last 30 days\n| extend cd=parse_json(customDimensions)\n| where cd.userAgent has \"Microsoft Flow\" and success == \"False\""
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of Plugins by Total Execution, Errors and Duration",
    "query": "// Author: aliyoussefi\n// Display name: Summary of Plugins by Total Execution, Errors and Duration\n// Description: Summary of Plugins by Total Execution, Errors and Duration\n// Categories: Dataverse,Server,BusinessLogic\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\ndependencies\n| where timestamp between(ago(30d).. now())\n| where type == \"Plugin\"\n| extend cd = parse_json(customDimensions)\n| summarize TotalExecution = count(), PerceivedErrors = countif(success==\"False\"),\n            Slow3s = countif(duration \u003e=3000),Slow5s = countif(duration \u003e=5000),        \n            Slow8s = countif(duration \u003e=8000),Slow15s = countif(duration \u003e=15000),Slow30s = countif(duration \u003e=30000), maxExecutionTime = max(duration)\n  by name"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Failing Dependencies",
    "query": "// Author: aliyoussefi\n// Display name: Top 10 Failing Dependencies\n// Description: Summary of failing dependencies\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\ndependencies\n| where timestamp \u003e ago(7d)\n| where success == false\n| summarize ['Failing Dependencies'] = count() by ['Dependency'] = name\n| top 10 by ['Failing Dependencies'] desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top Plug-Ins by Failures",
    "query": "// Author: aliyoussefi\n// Display name: Summary of Plugins by Total Execution, Errors and Duration\n// Description: Summary of Plugins by Total Execution, Errors and Duration\n// Categories: Dataverse,Server,BusinessLogic\n// Resource types: Dataverse\n// Topic: Other errors and failures\n\ndependencies\n| where timestamp between(ago(30d).. now())\n| where type == \"Plugin\"\n| extend cd = parse_json(customDimensions)\n| summarize TotalExecution = count(), PerceivedErrors = countif(success==\"False\"),\n            Slow3s = countif(duration \u003e=3000),Slow5s = countif(duration \u003e=5000),        \n            Slow8s = countif(duration \u003e=8000),Slow15s = countif(duration \u003e=15000),Slow30s = countif(duration \u003e=30000), maxExecutionTime = max(duration)\n  by name"
  },
  {
    "source": "AzureMonitor",
    "name": "Unique session count by user over last 24 hours",
    "query": "// Author: aliyoussefi\n// Display name: Unique session count by user over last 24 hours drilled down by hour\n// Description: Summary of Sessions by Users over last 24 hour drilled down by hour. Returns timestamp, user and session count.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Session Diagnostics\n\n// Unique session count by user over last 24 hours drilled down by hour\nrequests\n| where timestamp \u003e ago(1d)\n| summarize sessions = dcount(session_Id) by bin(timestamp, 1h), user_Id"
  },
  {
    "source": "AzureMonitor",
    "name": "Unique user count over last 24 hours",
    "query": "// Author: aliyoussefi\n// Display name: Unique user count over last 24 hours drilled down by hour\n// Description: Summary ofy Users over last 24 hour drilled down by hour. Returns timestamp and user count.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Session Diagnostics\n\n// Unique user count over last 24 hours drilled down by hour\nrequests\n| where timestamp \u003e ago(1d)\n| summarize UniqueUsers = dcount(user_Id) by bin(timestamp, 1h)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Active Users by Browser",
    "query": "// Author: aliyoussefi\n// Display name: Active Users by Browser\n// Description: Number of active users by Browser.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Usage\nlet start = startofday(_fromStartTime);\nrequests\n| where timestamp \u003e= start\n| where customDimensions.userAgent != \"\" and user_Id != \"00000000-0000-0000-0000-000000000000\" and session_Id != \"00000000-0000-0000-0000-000000000000\"\n| where customDimensions.userAgent !has \"microsoft-flow\" and customDimensions.userAgent !has \"Flow-RP\"\n| summarize count() by tostring(customDimensions.userAgent)"
  },
  {
    "source": "AzureMonitor",
    "name": "Active Users",
    "query": "// Author: aliyoussefi\n// Display name: Active Users\n// Description: Number of active users (unique users) who performed an operation that caused one of these SDK calls: Retrieve, Retrieve Multiple, Delete, Create, and Update.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Usage\n\nlet start = startofday(_fromStartTime);\nunion customEvents, pageViews\n| where timestamp \u003e= start\n| summarize Users = dcount(user_Id), Sessions = dcount(session_Id), Views = count()\n| project Users"
  },
  {
    "source": "AzureMonitor",
    "name": "Most Active Users Performing Operations",
    "query": "// Author: aliyoussefi\n// Display name: Most Active Users\n// Description: Performing Operations List of most active users who performed an operation that caused a Create, Update, Read, or Delete SDK call in the Dynamics 365 environment over the selected time period.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Usage\n\ndependencies\n| where timestamp between (_fromStartTime .. _toEndTime)\n| where user_Id != \"00000000-0000-0000-0000-000000000000\"\n| where isempty(operation_SyntheticSource)\n| where type in  (\"SDKCreate\", \"SDKUpdate\", \"SDKRetrieve\", \"SDKDelete\")\n| summarize sumDimension = count() by user_Id, type\n| top 10 by sumDimension"
  },
  {
    "source": "AzureMonitor",
    "name": "Total Operations",
    "query": "// Author: aliyoussefi\n// Display name: Total Operations\n// Description: This chart shows how many operations (create, update, deletes, reads) have occurred in the environment with a Dataverse database over the specified time.\n// Categories: Dataverse\n// Resource types: Dataverse\n// Topic: Usage\n\ndependencies\n| where timestamp between (_fromStartTime .. _toEndTime)\n| where type in  (\"SDKCreate\", \"SDKUpdate\", \"SDKRetrieve\", \"SDKDelete\")\n| make-series \nRequests = count() default = 0 on timestamp in range(_fromStartTime, _toEndTime, 1h) by type\n| mvexpand timestamp to typeof(datetime), Requests to typeof(long)"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - Active Users by Browser",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - Active Users by Browser\n// Description: Active Users by Browser over a given time. Variables are datetime\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: User Activity\n\nlet start = startofday(_fromStartTime); //Variables are datetime\nrequests\n| where timestamp \u003e= start\n| where customDimensions.userAgent != \"\" and user_Id != \"00000000-0000-0000-0000-000000000000\" and session_Id != \"00000000-0000-0000-0000-000000000000\"\n| where customDimensions.userAgent !has \"microsoft-flow\" and customDimensions.userAgent !has \"Flow-RP\"\n| summarize count() by tostring(customDimensions.userAgent)"
  },
  {
    "source": "AzureMonitor",
    "name": "Power Platform Admin Center Analytics - Active Users",
    "query": "// Author: aliyoussefi\n// Display name: Power Platform Admin Center Analytics - Active Users\n// Description: Summary of Active Users for use within a Card\n// Categories: Power Platform Admin Center Analytics\n// Resource types: Dataverse\n// Topic: User Activity\n\nlet start = startofday(_fromStartTime); //datetime\nunion customEvents, pageViews\n| where timestamp \u003e= start\n| summarize Users = dcount(user_Id), Sessions = dcount(session_Id), Views = count()\n| project Users"
  },
  {
    "source": "AzureMonitor",
    "name": "Delivery failures by domain and error",
    "query": "// Author: Microsoft Azure\n// Display name: Delivery failures by domain and error\n// Description: Delivery failures logs by domain name and error message.\n// Categories: Azure Resources\n// Resource types: Event Grid Domains\n// Topic: Diagnostics\n\nAegDeliveryFailureLogs \n| parse Message with * \", httpStatusCode=\" HttpStatusCode \",\" * \"., errorMessage=\" ErrorMessage \",\" *\n| parse _ResourceId with * \"/domains/\" DomainName \n| project TimeGenerated, _ResourceId, DomainName, TenantId, EventSubscriptionName, SubResourceName, OperationName, HttpStatusCode, ErrorMessage\n| summarize by _ResourceId, DomainName, SubResourceName, EventSubscriptionName, ErrorMessage"
  },
  {
    "source": "AzureMonitor",
    "name": "Publish failures by domain and error",
    "query": "// Author: Microsoft Azure\n// Display name: Publish failures by domain and error\n// Description: Publish failures logs by domain name and error message.\n// Categories: Azure Resources\n// Resource types: Event Grid Domains\n// Topic: Diagnostics\n\nAegPublishFailureLogs \n| parse Message with * \"), httpStatusCode=\" HttpStatusCode \",\" * \", errorMessage=\" ErrorMessage \n| parse _ResourceId with * \"/domains/\" DomainName\n| project TimeGenerated, _ResourceId, DomainName, TenantId, OperationName, HttpStatusCode, ErrorMessage\n| summarize by _ResourceId, DomainName, HttpStatusCode, ErrorMessage"
  },
  {
    "source": "AzureMonitor",
    "name": "Domains Average Delivery Latency",
    "query": "// Author: Microsoft Azure\n// Display name: Domains Average Delivery Latency\n// Description: Average Delivery Latency summarized by Domains, Event Subscriptions and SubResourceName.\n// Categories: Azure Resources\n// Resource types: Event Grid Domains\n// Topic: Performance\n\nAegDeliveryFailureLogs\n| parse _ResourceId with * \"/domains/\" DomainName\n| where DomainName != \"\" // and DomainName == \"YOUR_DOMAIN_NAME\"\n| parse Message with * \", latencyInMs=\" LatencyInMilliSecond \",\" *\n| summarize AverageDeliveryLatencyInMs = avg(todouble(LatencyInMilliSecond)) by DomainName, EventSubscriptionName, SubResourceName\n// Uncomment to filter by a specific Domain Name"
  },
  {
    "source": "AzureMonitor",
    "name": "Delivery failures by topic and error",
    "query": "// Author: Microsoft Azure\n// Display name: Delivery failures by topic and error\n// Description: Delivery failures logs by topic name and error message.\n// Categories: Azure Resources\n// Resource types: Event Grid Topics\n// Topic: Diagnostics\n\nAegDeliveryFailureLogs \n| parse Message with * \", httpStatusCode=\" HttpStatusCode \",\" * \"., errorMessage=\" ErrorMessage \",\" *\n| parse _ResourceId with * \"/topics/\" TopicName \n| project TimeGenerated, _ResourceId, TopicName, TenantId, EventSubscriptionName, OperationName, HttpStatusCode, ErrorMessage\n| summarize by _ResourceId, TopicName, ErrorMessage"
  },
  {
    "source": "AzureMonitor",
    "name": "Publish failures by topic and error",
    "query": "// Author: Microsoft Azure\n// Display name: Publish failures by topic and error\n// Description: Publish failures logs by topic name and error message.\n// Categories: Azure Resources\n// Resource types: Event Grid Topics\n// Topic: Diagnostics\n\nAegPublishFailureLogs \n| parse Message with * \"), httpStatusCode=\" HttpStatusCode \",\" * \", errorMessage=\" ErrorMessage \n| parse _ResourceId with * \"/topics/\" TopicName \n| project TimeGenerated, _ResourceId, TopicName, TenantId, OperationName, HttpStatusCode, ErrorMessage\n| summarize by _ResourceId, TopicName, HttpStatusCode, ErrorMessage"
  },
  {
    "source": "AzureMonitor",
    "name": "Topics Average Delivery Latency",
    "query": "// Author: Microsoft Azure\n// Display name: Topics Average Delivery Latency\n// Description: Average Delivery Latency summarized by Topics, Event Subscriptions.\n// Categories: Azure Resources\n// Resource types: Event Grid Topics\n// Topic: Performance\n\nAegDeliveryFailureLogs\n| parse _ResourceId with * \"/topics/\" TopicName\n| where TopicName!= \"\" // and TopicName == \"YOUR_TOPIC_NAME\"\n| parse Message with * \", latencyInMs=\" LatencyInMilliSecond \",\" *\n| summarize AverageDeliveryLatencyInMs = avg(todouble(LatencyInMilliSecond)) by TopicName, EventSubscriptionName\n// Uncomment to filter for a specific Topic Name"
  },
  {
    "source": "AzureMonitor",
    "name": "Access to keyvault  key not found",
    "query": "// Author: Microsoft Azure\n// Display name: Access to keyvault - key not found\n// Description: Summarizes the access to keyvault when key is not found.\n// Categories: Azure Resources\n// Resource types: Event Hubs\n// Topic: Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.EVENTHUB\" \n| where Category == \"Error\" and OperationName == \"wrapkey\"\n| project Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Duration of Capture failure",
    "query": "// Author: Microsoft Azure\n// Display name: Duration of Capture failure\n// Description: Summarizes the duaration of failure on Capture.\n// Categories: Azure Resources\n// Resource types: Event Hubs\n// Topic: Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.EVENTHUB\"\n| where Category == \"ArchiveLogs\"\n| summarize count() by \"failures\", \"durationInSeconds\""
  },
  {
    "source": "AzureMonitor",
    "name": "Errors in the last 7 days",
    "query": "// Author: Microsoft Azure\n// Display name: Errors in the last 7 days\n// Description: This lists all the errors for the last 7 days.\n// Categories: Azure Resources\n// Resource types: Event Hubs\n// Topic: Errors\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(7d)\n| where ResourceProvider ==\"MICROSOFT.EVENTHUB\"\n| where Category == \"OperationalLogs\"\n| summarize count() by \"EventName\""
  },
  {
    "source": "AzureMonitor",
    "name": "Join request for client",
    "query": "// Author: Microsoft Azure\n// Display name: Join request for client\n// Description: Summarized the status of join request for client.\n// Categories: Azure Resources\n// Resource types: Event Hubs\n// Topic: Kafka\n\nAzureDiagnostics // Need to turn on the Capture for this \n| where ResourceProvider == \"MICROSOFT.EVENTHUB\"\n|  project \"OperationName\""
  },
  {
    "source": "AzureMonitor",
    "name": "Operation performed with keyvault",
    "query": "// Author: Microsoft Azure\n// Display name: Operation performed with keyvault\n// Description: Summarizes the operation performed with keyvault to disable or restore the key.\n// Categories: Azure Resources\n// Resource types: Event Hubs\n// Topic: Usage\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.EVENTHUB\"\n| where Category == \"info\" and OperationName == \"disable\" or OperationName == \"restore\"\n| project Message"
  },
  {
    "source": "AzureMonitor",
    "name": "BGP informational messages",
    "query": "// Author: Microsoft Azure\n// Display name: BGP informational messages\n// Description: BGP informational messages by level, resource type and network.\n// Categories: Network\n// Resource types: ExpressRoute circuits\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where Level == \"Informational\"\n| project TimeGenerated , ResourceId, Level, ResourceType , network_s , path_s"
  },
  {
    "source": "AzureMonitor",
    "name": "BGP route table",
    "query": "// Author: Microsoft Azure\n// Display name: BGP route table\n// Description: BPG route table learned over last 12 hours.\n// Categories: Network\n// Resource types: ExpressRoute circuits\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(12h)\n| where ResourceType == \"EXPRESSROUTECIRCUITS\"\n| project TimeGenerated , ResourceType , network_s , path_s , OperationName"
  },
  {
    "source": "AzureMonitor",
    "name": "ExpressRoute Circuit ArpAvailablility graph",
    "query": "// Author: Microsoft Azure\n// Display name: ExpressRoute Circuit ArpAvailablility graph\n// Description: Traffic graph for ArpAvailability (5 minutes).\n// Categories: Azure Monitor,Network\n// Resource types: ExpressRoute circuits\n// Topic: Diagnostics\n\nAzureMetrics\n| where MetricName == \"ArpAvailability\"\n| summarize by Average, bin(TimeGenerated, 5m), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "ExpressRoute Circuit BGP availability",
    "query": "// Author: Microsoft Azure\n// Display name: ExpressRoute Circuit BGP availability\n// Description: Traffic graph for BgpAvailability (5 minutes).\n// Categories: Azure Monitor,Network\n// Resource types: ExpressRoute circuits\n// Topic: Diagnostics\n\nAzureMetrics\n| where MetricName == \"BgpAvailability\"\n| summarize by Average, bin(TimeGenerated, 5m), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "ExpressRoute Circuit BitsInPerSecond traffic graph",
    "query": "// Author: Microsoft Azure\n// Display name: ExpressRoute Circuit BitsInPerSecond traffic graph\n// Description: Traffic graph BitsInPerSecond (last one hour).\n// Categories: Azure Monitor,Network\n// Resource types: ExpressRoute circuits\n// Topic: Diagnostics\n\nAzureMetrics\n| where MetricName == \"BitsInPerSecond\"\n| summarize by Average, bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "ExpressRoute Circuit BitsOutPerSecond traffic graph",
    "query": "// Author: Microsoft Azure\n// Display name: ExpressRoute Circuit BitsOutPerSecond traffic graph\n// Description: Traffic graph BitsOutPerSecond (last one hour).\n// Categories: Azure Monitor,Network\n// Resource types: ExpressRoute circuits\n// Topic: Diagnostics\n\nAzureMetrics\n| where MetricName == \"BitsOutPerSecond\"\n| summarize by Average, bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Application rule log data",
    "query": "// Author: Microsoft Azure\r\n// Display name: Application rule log data\r\n// Description: Parses the application rule log data.\r\n// Categories: Network,Security\r\n// Resource types: Firewalls\r\n// Topic: Firewall Logs\r\n\r\nAzureDiagnostics\r\n| where Category == \"AzureFirewallApplicationRule\"\r\n//using :int makes it easier to pars but later we'll convert to string \r\r\n//as we're not interested to do mathematical functions on these fields\r\n//this first parse statement is valid for all entries as they all start with this format\r\n| parse msg_s with Protocol \" request from \" SourceIP \":\" SourcePortInt:int \" \" TempDetails\r\n//case 1: for records that end with: \"was denied. Reason: SNI TLS extension was missing.\"\r\n| parse TempDetails with \"was \" Action1 \". Reason: \" Rule1\r\n//case 2: for records that end with\r\n//\"to ocsp.digicert.com:80. Action: Allow. Rule Collection: RC1. Rule: Rule1\"\r\n//\"to v10.vortex-win.data.microsoft.com:443. Action: Deny. No rule matched. Proceeding with default action\"\r\n| parse TempDetails with \"to \" FQDN \":\" TargetPortInt:int \". Action: \" Action2 \".\" *\r\n//case 2a: for records that end with:\r\n//\"to ocsp.digicert.com:80. Action: Allow. Rule Collection: RC1. Rule: Rule1\"\r\n| parse TempDetails with * \". Rule Collection: \" RuleCollection2a \". Rule:\" Rule2a\r\n//case 2b: for records that end with:\r\n//for records that end with: \"to v10.vortex-win.data.microsoft.com:443. Action: Deny. No rule matched. Proceeding with default action\"\r\n| parse TempDetails with * \"Deny.\" RuleCollection2b \". Proceeding with\" Rule2b\r\n| extend SourcePort = tostring(SourcePortInt)\r\n|extend TargetPort = tostring(TargetPortInt)\r\n//make sure we only have Allowed / Deny in the Action Field\r\n | extend Action1 = case(Action1 == \"Deny\",\"Deny\",\"Unknown Action\")\r\n| extend Action = case(Action2 == \"\",Action1,Action2),\r\n    Rule = case(Rule2a == \"\",case(Rule1 == \"\",case(Rule2b == \"\",\"N/A\", Rule2b),Rule1),Rule2a), \r\n    RuleCollection = case(RuleCollection2b == \"\",case(RuleCollection2a == \"\",\"No rule matched\",RuleCollection2a),RuleCollection2b),\r\n    FQDN = case(FQDN == \"\", \"N/A\", FQDN),\r\n    TargetPort = case(TargetPort == \"\", \"N/A\", TargetPort)\r\n| project TimeGenerated, msg_s, Protocol, SourceIP, SourcePort, FQDN, TargetPort, Action ,RuleCollection, Rule"
  },
  {
    "source": "AzureMonitor",
    "name": "Network rule log data",
    "query": "// Author: Microsoft Azure\n// Display name: Network rule log data\n// Description: Parses the network rule log data.\n// Categories: Network,Security\n// Resource types: Firewalls\n// Topic: Firewall Logs\n\nAzureDiagnostics\n| where Category == \"AzureFirewallNetworkRule\"\n//using :int makes it easier to pars but later we'll convert to string as we're not interested to do mathematical functions on these fields\n//case 1: for records that look like this:\n//TCP request from 10.0.2.4:51990 to 13.69.65.17:443. Action: Deny//Allow\n//UDP request from 10.0.3.4:123 to 51.141.32.51:123. Action: Deny/Allow\n//TCP request from 193.238.46.72:50522 to 40.119.154.83:3389 was DNAT'ed to 10.0.2.4:3389\n| parse msg_s with Protocol \" request from \" SourceIP \":\" SourcePortInt:int \" to \" TargetIP \":\" TargetPortInt:int *\n//case 1a: for regular network rules\n//TCP request from 10.0.2.4:51990 to 13.69.65.17:443. Action: Deny/Allow\n//UDP request from 10.0.3.4:123 to 51.141.32.51:123. Action: Deny/Allow\n| parse msg_s with * \". Action: \" Action1a\n//case 1b: for NAT rules\n//TCP request from 193.238.46.72:50522 to 40.119.154.83:3389 was DNAT'ed to 10.0.2.4:3389\n| parse msg_s with * \" was \" Action1b \" to \" NatDestination\n//case 2: for ICMP records\n//ICMP request from 10.0.2.4 to 10.0.3.4. Action: Allow\n| parse msg_s with Protocol2 \" request from \" SourceIP2 \" to \" TargetIP2 \". Action: \" Action2\n| extend\nSourcePort = tostring(SourcePortInt),\nTargetPort = tostring(TargetPortInt)\n| extend \n    Action = case(Action1a == \"\", case(Action1b == \"\",Action2,Action1b), Action1a),\n    Protocol = case(Protocol == \"\", Protocol2, Protocol),\n    SourceIP = case(SourceIP == \"\", SourceIP2, SourceIP),\n    TargetIP = case(TargetIP == \"\", TargetIP2, TargetIP),\n    //ICMP records don't have port information\n    SourcePort = case(SourcePort == \"\", \"N/A\", SourcePort),\nTargetPort = case(TargetPort == \"\", \"N/A\", TargetPort),\n    //Regular network rules don't have a DNAT destination\n    NatDestination = case(NatDestination == \"\", \"N/A\", NatDestination)\n| project TimeGenerated, msg_s, Protocol, SourceIP,SourcePort,TargetIP,TargetPort,Action, NatDestination"
  },
  {
    "source": "AzureMonitor",
    "name": "Threat Intelligence rule log data",
    "query": "// Author: Microsoft Azure\r\n// Display name: Threat Intelligence rule log data\r\n// Description: Parses the Threat Intelligence rule log data.\r\n// Categories: Network,Security\r\n// Resource types: Firewalls\r\n// Topic: Firewall Logs\r\n\r\nAzureDiagnostics\r\n| where OperationName  == \"AzureFirewallThreatIntelLog\"\r\n| parse msg_s with Protocol \" request from \" SourceIP \":\" SourcePortInt:int \" to \" TargetIP \":\" TargetPortInt:int *\r\n| parse msg_s with * \". Action: \" Action \".\" Message\r\n| parse msg_s with Protocol2 \" request from \" SourceIP2 \" to \" TargetIP2 \". Action: \" Action2\r\n| extend SourcePort = tostring(SourcePortInt),TargetPort = tostring(TargetPortInt)\r\n| extend Protocol = case(Protocol == \"\", Protocol2, Protocol),SourceIP = case(SourceIP == \"\", SourceIP2, SourceIP),TargetIP = case(TargetIP == \"\", TargetIP2, TargetIP),SourcePort = case(SourcePort == \"\", \"N/A\", SourcePort),TargetPort = case(TargetPort == \"\", \"N/A\", TargetPort)\r\n| sort by TimeGenerated desc \r\n| project TimeGenerated, msg_s, Protocol, SourceIP,SourcePort,TargetIP,TargetPort,Action,Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Request errors by host and path",
    "query": "// Author: Microsoft Azure\n// Display name: Request errors by host and path\n// Description: Count number of requests with error responses by host and path.\n// Categories: Network\n// Resource types: Front Doors\n// Topic: Errors\n\n// Summarize number of requests by host, path, and status codes \u003e= 400\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorAccessLog\"\n| where isReceivedFromClient_b == true\n| where toint(httpStatusCode_s) \u003e= 400\n| extend ParsedUrl = parseurl(requestUri_s)\n| summarize RequestCount = count() by Host = tostring(ParsedUrl.Host), Path = tostring(ParsedUrl.Path), StatusCode = httpStatusCode_s\n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Request errors by user agent",
    "query": "// Author: Microsoft Azure\n// Display name: Request errors by user agent\n// Description: Count number of requests with error responses by user agent.\n// Categories: Network\n// Resource types: Front Doors\n// Topic: Errors\n\n// Summarize number of requests per user agent and status codes \u003e= 400\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorAccessLog\"\n| where isReceivedFromClient_b == true\n| where toint(httpStatusCode_s) \u003e= 400\n| summarize RequestCount = count() by UserAgent = userAgent_s, StatusCode = httpStatusCode_s , Resource\n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Firewall blocked request count per hour",
    "query": "// Author: Microsoft Azure\n// Display name: Firewall blocked request count per hour\n// Description: Count number of firewall blocked requests per hour.\n// Categories: Network,Security\n// Resource types: Front Doors\n// Topic: Firewall Audit\n\n// Summarize number of firewall blocked requests per hour by policy\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorWebApplicationFirewallLog\"\n| where action_s == \"Block\"\n| summarize RequestCount = count() by bin(TimeGenerated, 1h), Policy = policy_s, PolicyMode = policyMode_s, Resource\n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Firewall request count by host path rule and action",
    "query": "// Author: Microsoft Azure\n// Display name: Firewall request count by host, path, rule, and action\n// Description: Count firewall processed requests by host, path, rule, and action taken.\n// Categories: Network,Security\n// Resource types: Front Doors\n// Topic: Firewall Audit\n\n// Summarize request count by host, path, rule, and action\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorWebApplicationFirewallLog\"\n| extend ParsedUrl = parseurl(requestUri_s)\n| summarize RequestCount = count() by Host = tostring(ParsedUrl.Host), Path = tostring(ParsedUrl.Path), RuleName = ruleName_s, Action = action_s \n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 20 blocked clients by IP and rule",
    "query": "// Author: Microsoft Azure\n// Display name: Top 20 blocked clients by IP and rule\n// Description: Show top 20 blocked clients by IP and rule name.\n// Categories: Network,Security\n// Resource types: Front Doors\n// Topic: Firewall Audit\n\n// Summarize top 20 blocked clients by IP and rule\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorWebApplicationFirewallLog\"\n| where action_s == \"Block\"\n| summarize RequestCount = count() by ClientIP = clientIP_s, UserAgent = userAgent_s, RuleName = ruleName_s ,Resource\n| top 20 by RequestCount \n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Forwarded backend requests by routing rule",
    "query": "// Author: Microsoft Azure\n// Display name: Forwarded backend requests by routing rule\n// Description: Count number of requests for each routing rule and backend host per minute.\n// Categories: Network\n// Resource types: Front Doors\n// Topic: Usage and Diagnostics\n\n// Summarize number of requests per minute for each routing rule and backend host\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorAccessLog\"\n| summarize RequestCount = count() by bin(TimeGenerated, 1m), Resource,\n RoutingRuleName = routingRuleName_s, BackendHostname = backendHostname_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Requests per hour",
    "query": "// Author: Microsoft Azure\n// Display name: Requests per hour\n// Description: Render line chart showing total requests per hour for each FrontDoor resource.\n// Categories: Network\n// Resource types: Front Doors\n// Topic: Usage and Diagnostics\n\n// Summarize number of requests per hour for each FrontDoor resource\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorAccessLog\"\n| where isReceivedFromClient_b == true\n| summarize RequestCount = count() by bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 client IPs and http versions",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 client IPs and http versions\n// Description: Show top 10 client IPs and http versions.\n// Categories: Network\n// Resource types: Front Doors\n// Topic: Usage and Diagnostics\n\n// Summarize top 10 client ips and http versions\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.NETWORK\" and Category == \"FrontdoorAccessLog\"\n| where isReceivedFromClient_b == true\n| summarize RequestCount = count() by ClientIP = clientIp_s, HttpVersion = httpVersion_s, Resource\n| top 10 by RequestCount \n| order by RequestCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Active Topologies Summary",
    "query": "// Author: Microsoft Azure\r\n// Display name: Active Topologies Summary\r\n// Description: Returns the current number of Storm Supervisors for your cluster.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightStormTopologyMetrics\r\r\n/| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where Status == \"ACTIVE\"\r\r\n| summarize arg_max(TimeGenerated, *) by TopologyId\r\r\n| sort by TimeGenerated desc\r\r\n| project TopologyId, Uptime, WorkersTotal, ExecutorsTotal, TasksTotal, ReplicationCount, AssignedTotalMemMB"
  },
  {
    "source": "AzureMonitor",
    "name": "Current number of Storm Supervisors",
    "query": "// Author: Microsoft Azure\r\n// Display name: Current number of Storm Supervisors\r\n// Description: Returns the current number of Storm Supervisors for your cluster.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightStormMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where MetricName == \"nimbus-num-supervisors-Value\"\r\r\n| summarize arg_max(TimeGenerated, *)"
  },
  {
    "source": "AzureMonitor",
    "name": "HMaster Error Logs",
    "query": "// Author: Microsoft Azure\r\n// Display name: HMaster Error Logs\r\n// Description: All HMasterogs of trace level Error within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHBaseLogs \r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| where LogType == 'HBaseMasterLog' //can set which type of logs you want to see (ex: HBaseMasterLog, HBaseRegionServerLog, etc.)\r\r\n| where LogLevel == 'ERROR' //set which LogLevels you want to see (ex: \"ERROR\",\"WARN\",\"INFO)\r\r\n| take 10"
  },
  {
    "source": "AzureMonitor",
    "name": "Hadoop And Yarn Metrics List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Hadoop And Yarn Metrics List\r\n// Description: Returns the names of all metrics that have been collected in the HDInsightHadoopAndYarnMetrics table for the last 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHadoopAndYarnMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by MetricName //displays each possible metric name and a value\r\r\n| project MetricName, any_MetricValue"
  },
  {
    "source": "AzureMonitor",
    "name": "Hadoop and Yarn Log Types List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Hadoop and Yarn Log Types List\r\n// Description: Returns Hadoop and Yarn related Log types.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHadoopAndYarnLogs\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by LogType //displays each type of log that has entered workspace in specified timeframe\r\r\n| project LogType, any_LogLevel, any_Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Hive And LLAP Metrics List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Hive And LLAP Metrics List\r\n// Description: Returns the names of all metrics that have been collected in the HDInsightHiveAndLLAPMetrics table for the last 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHiveAndLLAPMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by MetricName //displays each possible metric name and a value\r\r\n| project MetricName, any_MetricValue"
  },
  {
    "source": "AzureMonitor",
    "name": "Hive Server 2 Log Level Count List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Hive Server 2 Log Level Count List\r\n// Description: Renders a timechart to show the amount of records for each log level in the Hive Server 2 logs within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHiveAndLLAPLogs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where LogType == \"HiveServer2Log\" //can set which type of logs you want to see (ex: HiveServer2Log, HiveMetastoreLog, WebHCatLog, ZeppelingLog, etc.)\r\r\n| summarize count() by LogLevel, bin(TimeGenerated, 30m)//set the time bucket for the counts\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Hive Server 2 Metrics View",
    "query": "// Author: Microsoft Azure\r\n// Display name: Hive Server 2 Metrics View\r\n// Description: Projects all Hive Server 2 metrics to their own column to make queries easier.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHiveAndLLAP\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where MetricNamespace == '\tHadoop:service=hiveserver2,name=hiveserver2' //switch MetricNamespace value to switch to a different MetricNamespace view\r\r\n| evaluate pivot(MetricName, avg(MetricValue), TimeGenerated)"
  },
  {
    "source": "AzureMonitor",
    "name": "Hive and LLAP Log Types List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Hive and LLAP Log Types List\r\n// Description: Returns Hive and LLAP related Log types.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHiveAndLLAPLogs\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by LogType //displays each type of log that has entered workspace in specified timeframe\r\r\n| project LogType, any_LogLevel, any_Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Kafka Messages In Per Second",
    "query": "// Author: Microsoft Azure\r\n// Display name: Kafka Messages In Per Second\r\n// Description: Returns the Messages In Per Sec metric values for each broker within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightKafkaMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h) //if you want to query farther back in time you can increase this value.\r\r\n| where MetricName == \"MessagesInPerSec\"\r\r\n| summarize avg(MetricValue) by  HostName, bin(TimeGenerated, 5m)//you can select different values for the time bucket to gain insights over different time periods, if you query over a larger timeframe, you may want to increase the bucket size"
  },
  {
    "source": "AzureMonitor",
    "name": "Kafka Server Error Logs",
    "query": "// Author: Microsoft Azure\r\n// Display name: Kafka Server Error Logs\r\n// Description: All Kafka Server logs of trace level Error within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightKafkaLogs \r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| where LogType == 'KafkaServerLog' //can set which type of logs you want to see (ex: KafkaServerLog, KafkaControllerLog)\r\r\n| where LogLevel == 'ERROR' //set which LogLevels you want to see\r\r\n| take 1000"
  },
  {
    "source": "AzureMonitor",
    "name": "Kafka Server Log Level Counts",
    "query": "// Author: Microsoft Azure\r\n// Display name: Kafka Server Log Level Counts\r\n// Description: Renders a timechart to show the amount of records for each log level in the  Kafka Server logs within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightKafkaLogs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where LogType == \"KafkaServerLog\" //can set which type of logs you want to see (ex: KafkaServerLog, KafkaControllerLog)\r\r\n| summarize count() by LogLevel, bin(TimeGenerated, 30m)//set the time bucket for the counts\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Kafka Underreplicated Partitions",
    "query": "// Author: Microsoft Azure\r\n// Display name: Kafka Underreplicated Partitions\r\n// Description: Renders a timechart to display the amount of Underreplicated Partitions in the cluster within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightKafkaMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| where MetricName == \"UnderReplicatedPartitions\"\r\r\n| summarize MaxValue = max(MetricValue) by HostName, bin(TimeGenerated, 5m) //gets the max amount of URPs in the selected time interval for each host\r\r\n| summarize UnderReplicatedPartitions=sum(MaxValue) by bin(TimeGenerated, 5m) //sums the value for each host to get overall number of URPs\r\r\n| render timechart //shows URP value over time"
  },
  {
    "source": "AzureMonitor",
    "name": "List HBase Log Types",
    "query": "// Author: Microsoft Azure\r\n// Display name: List HBase Log Types\r\n// Description: All HBase Log Types that entered the workspace within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHBaseLogs\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by LogType //displays each type of log that has entered workspace in specified timeframe\r\r\n| project LogType, any_LogLevel, any_Message"
  },
  {
    "source": "AzureMonitor",
    "name": "List Kafka Log Types",
    "query": "// Author: Microsoft Azure\r\n// Display name: List Kafka Log Types\r\n// Description: All Kafka Log Types that have entered the workspace within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightKafkaLogs\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by LogType //displays each type of log that has entered workspace in specified timeframe\r\r\n| project LogType, any_LogLevel, any_Message"
  },
  {
    "source": "AzureMonitor",
    "name": "List Storm Log Types",
    "query": "// Author: Microsoft Azure\r\n// Display name: List Storm Log Types\r\n// Description: All Storm Log Types that entered the workspace within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightStormLogs\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by LogType //displays each type of log that has entered workspace in specified timeframe\r\r\n| project LogType, any_LogLevel, any_Message"
  },
  {
    "source": "AzureMonitor",
    "name": "List all HBase Metrics",
    "query": "// Author: Microsoft Azure\r\n// Display name: List all HBase Metrics\r\n// Description: Returns the names of all metrics that have been collected in the HDInsightHBaseMetrics table for the last 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHBaseMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| distinct MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "List all Kafka Metrics",
    "query": "// Author: Microsoft Azure\r\n// Display name: List all Kafka Metrics\r\n// Description: Returns the names of all metrics that have been collected in the HDInsightKafkaMetrics table for the last 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightKafkaMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by MetricName //displays each possible metric name and a value\r\r\n| project MetricName, any_MetricValue"
  },
  {
    "source": "AzureMonitor",
    "name": "Number of Active Hive Sources",
    "query": "// Author: Microsoft Azure\r\n// Display name: Number of Active Hive Sources\r\n// Description: Returns the current number of active Hive sources for your cluster.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHiveAndLLAPMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where MetricName == \"NumActiveSources\"\r\r\n| summarize arg_max(TimeGenerated, *)"
  },
  {
    "source": "AzureMonitor",
    "name": "Number of Completed Spark Applications",
    "query": "// Author: Microsoft Azure\r\n// Display name: Number of Completed Spark Applications\r\n// Description: Returns the number of Spark Applications that have completed for your cluster.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkApplicationEvents\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| where isnotempty(CompletionTime)\r\r\n| count"
  },
  {
    "source": "AzureMonitor",
    "name": "Number of Unhealthy Node Managers",
    "query": "// Author: Microsoft Azure\r\n// Display name: Number of Unhealthy Node Managers\r\n// Description: Returns the current number of unhealthy node managers for your cluster.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHadoopAndYarnMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where MetricName == \"NumUnhealthyNMs\"\r\r\n| summarize arg_max(TimeGenerated, *)"
  },
  {
    "source": "AzureMonitor",
    "name": "Number of dead region servers",
    "query": "// Author: Microsoft Azure\r\n// Display name: Number of dead region servers\r\n// Description: Returns the current number of dead region servers for your cluster.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHBaseMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(30m)\r\r\n| where MetricNamespace == \"Hadoop:service=HBase,name=Master,sub=Server\" //specifies namespace of metric\r\r\n| where MetricName == \"numDeadRegionServers\"   \r\r\n| extend TagsJson = parse_json(Tags) //parsing the Tags to find the Active HMaster\r\r\n| where TagsJson[\"tag.isActiveMaster\"] == true\r\r\n| summarize arg_max(TimeGenerated, *)"
  },
  {
    "source": "AzureMonitor",
    "name": "Region Server Log LevelCounts",
    "query": "// Author: Microsoft Azure\r\n// Display name: Region Server Log LevelCounts\r\n// Description: Renders a timechart to show the amount of records for each log level in the Region Server logs within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHBaseLogs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where LogType == \"HBaseRegionServerLog\" //can set which type of logs you want to see (ex: HBaseMasterLog, HBaseRegionServerLog, etc.)\r\r\n| summarize count() by LogLevel, bin(TimeGenerated, 30m)//set the time bucket for the counts\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Region Server Metrics View",
    "query": "// Author: Microsoft Azure\r\n// Display name: Region Server Metrics View\r\n// Description: Projects all Region Server metrics to their own column to make queries easier.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHBaseMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where MetricNamespace == 'Hadoop:service=HBase,name=RegionServer,sub=Server' //switch MetricNamespace value to switch to a different MetricNamespace view\r\r\n| evaluate pivot(MetricName, avg(MetricValue), TimeGenerated)"
  },
  {
    "source": "AzureMonitor",
    "name": "Resource Manager Log Level Count List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Resource Manager Log Level Count List\r\n// Description: Renders a timechart to show the amount of records for each log level in the Resource Manager logs within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHadoopAndYarnLogs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where LogType == \"ResourceManager\" //can set which type of logs you want to see (ex: ResourceManager, NodeManager, TimelineServer, etc.)\r\r\n| summarize count() by LogLevel, bin(TimeGenerated, 30m)//set the time bucket for the counts\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Resource Manager Metrics View",
    "query": "// Author: Microsoft Azure\r\n// Display name: Resource Manager Metrics View\r\n// Description: Projects all Resource Manager metrics to their own column to make queries easier.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightHadoopAndYarnMetrics\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where MetricNamespace contains 'Hadoop:service=ResourceManager' //switch MetricNamespace value to switch to a different MetricNamespace view\r\r\n| evaluate pivot(MetricName, avg(MetricValue), TimeGenerated)"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Application Deploy Mode And Master Summary",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Application Deploy Mode And Master Summary\r\n// Description: Renders a column chart that shows the number of Spark applications for each deploy mode and master combination.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkEnvironmentEvents\r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize count() by strcat(SparkDeployMode, \"/\", SparkMaster)\r\r\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Driver Log Level Count List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Driver Log Level Count List\r\n// Description: Renders a timechart to show the amount of records for each log level in the Driver logs within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkLogs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where LogType == \"SparkDriverLog\" //can set which type of logs you want to see (ex: SparkDriverLog, SparkExecutorLog, SparkThriftDriverLog, JupyterLog)\r\r\n| summarize count() by LogLevel, bin(TimeGenerated, 30m)//set the time bucket for the counts\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Executor Max Core Usage",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Executor Max Core Usage\r\n// Description: Returns the max cores used by each Executor.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkExecutorEvents\r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize max(ExecutorCores) by ClusterDnsName, ExecutorId"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Executor Max Memory",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Executor Max Memory\r\n// Description: Renders a column chart that shows the max memory used by Executor for an application on your Spark cluster.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkBlockManagerEvents\r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n//| where ApplicationId == '\u003cyour application id\u003e' // remove the preceding \"//\" and specify your application id to see its logs\r\r\n| where TimeGenerated\u003e ago(24h)\r\r\n| summarize max(MaxMemory) by ExecutorId\r\r\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Job Statuses",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Job Statuses\r\n// Description: Returns a summary of the Spark jobs running for your application.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkJobEvents\r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n//| where ApplicationId == '\u003cyour application id\u003e'\r\r\n| where isnotnull(SubmissionTime)\r\r\n| join kind=fullouter (\r\r\n    HDInsightSparkJobEvents\r\r\n\t//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n\t//| where ApplicationId == '\u003cyour application id\u003e'\r\r\n    | where isnotnull(CompletionTime) \r\r\n) on ClusterDnsName, ApplicationId, JobId\r\r\n|order by ApplicationId, JobId asc \r\r\n| extend CompletionTime = CompletionTime1\r\r\n| extend JobResult = JobResult1\r\r\n| extend Duration = iff(isempty(CompletionTime), \"In Progress\", tostring(datetime_diff(\"Millisecond\",CompletionTime, SubmissionTime)))\r\r\n| project TimeGenerated, ApplicationId, JobId, Duration, JobResult, StageIds"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Log Types List",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Log Types List\r\n// Description: Returns Spark related Log types.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkLogs\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| summarize any(*) by LogType //displays each type of log that has entered workspace in specified timeframe\r\r\n| project LogType, any_LogLevel, any_Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark SQL Query Status Summary",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark SQL Query Status Summary\r\n// Description: Returns a summary of the Spark SQL queries running for your application.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkSQLExecutionEvents \r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n//| where ApplicationId == '\u003cyour application id\u003e'\r\r\n| where isnotnull(StartTime)\r\r\n| join kind=fullouter (\r\r\n    HDInsightSparkSQLExecutionEvents\r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n//| where ApplicationId == '\u003cyour application id\u003e'\r\r\n    | where isnotnull(EndTime) \r\r\n) on ClusterDnsName, ApplicationId, ExecutionId\r\r\n|order by ApplicationId, ExecutionId asc \r\r\n| extend EndTime = EndTime1\r\r\n| extend Duration = iff(isempty(EndTime), \"In Progress\", tostring(datetime_diff(\"Millisecond\",EndTime, StartTime)))\r\r\n| project TimeGenerated, ApplicationId, ExecutionId, Duration, PhysicalPlanDescription, SparkPlanInfo"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Stage Status Summary",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Stage Status Summary\r\n// Description: Returns a summary of the Spark stages running for your application.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkStageEvents\r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n//| where ApplicationId == '\u003cyour application id\u003e'\r\r\n| extend Duration = iff(isnotempty(CompletionTime), datetime_diff(\"Millisecond\", CompletionTime, SubmissionTime), datetime_diff(\"Millisecond\", now(), SubmissionTime))\r\r\n| project TimeGenerated, ApplicationId, StageId, Duration, FailureReason, Details, RDDInfo"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Stage Task Metrics",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Stage Task Metrics\r\n// Description: Returns the metrics for the tasks related to the stage you specify.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkStageTaskAccumulables \r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n//| where ApplicationId == '\u003cyour application id\u003e' and ParentId == '\u003cstage id\u003e'\r\r\n| where Entity == \"task\"\r\r\n//| where MetricName contains \"{MetricName}\" //remove the preceding \"//\" and specify a metric name if you want to only view that metrics value\r\r\n| project TimeGenerated, ApplicationId, EntityId, MetricName, MetricValue"
  },
  {
    "source": "AzureMonitor",
    "name": "Spark Task Result Summary",
    "query": "// Author: Microsoft Azure\r\n// Display name: Spark Task Result Summary\r\n// Description: Returns a summary of the task results by result type\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightSparkTaskEvents\r\r\n//| where ClusterDnsName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n//| where ApplicationId == '\u003cyour application id\u003e' and ParentId == '\u003cstage id\u003e'\r\r\n| summarize count() by EndReason"
  },
  {
    "source": "AzureMonitor",
    "name": "Storm Nimbus Error Logs",
    "query": "// Author: Microsoft Azure\r\n// Display name: Storm Nimbus Error Logs\r\n// Description: All Strom Nimbus Logs of trace level Error within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightStormLogs \r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n| where LogType == 'StormNimbusLog' //can set which type of logs you want to see (ex: StormNimbusLog, StormSupervisorLog)\r\r\n| where LogLevel == 'ERROR' //set which LogLevels you want to see\r\r\n| take 1000"
  },
  {
    "source": "AzureMonitor",
    "name": "Storm Nimbus Log Level Counts",
    "query": "// Author: Microsoft Azure\r\n// Display name: Storm Nimbus Log Level Counts\r\n// Description: Renders a timechart to show the amount of records for each log level in the Nimbus logs within the past 24 hours.\r\n// Categories: Workloads\r\n// Resource types: HDInsight Clusters\r\n// Topic: Workloads\r\n\r\nHDInsightStormLogs\r\r\n| where TimeGenerated \u003e ago(24h)\r\r\n//| where ClusterName == '\u003cyour cluster name\u003e' // remove the preceding \"//\" and specify your cluster name to see its logs\r\r\n| where LogType == \"StormNimbusLog\" //can set which type of logs you want to see (ex: StormNimbusLog, StormSupervisorLog)\r\r\n| summarize count() by LogLevel, bin(TimeGenerated, 30m)//set the time bucket for the counts\r\r\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Dead endpoints",
    "query": "// Author: Microsoft Azure\n// Display name: Dead endpoints\n// Description: Identify dead or unhealthy endpoints byt the number times the issue was reported, as well as the reason why.\n// Categories: Azure Resources\n// Resource types: IoT Hub\n// Topic: Availability\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DEVICES\" and ResourceType == \"IOTHUBS\"\n| where Category == \"Routes\" and OperationName in (\"endpointDead\", \"endpointUnhealthy\")\n| extend parsed_json = parse_json(properties_s)\n| extend Endpoint   = tostring(parsed_json.endpointName), Reason =tostring(parsed_json.details) \n| summarize count() by Endpoint, OperationName, Reason, _ResourceId\n| order by count_ desc"
  },
  {
    "source": "AzureMonitor",
    "name": "SDK version of devices",
    "query": "// Author: Microsoft Azure\n// Display name: SDK version of devices\n// Description: List of devices and their SDK versions.\n// Categories: Azure Resources\n// Resource types: IoT Hub\n// Topic: Diagnostics\n\n// this query works on device connection or when your device uses device to cloud twin operations\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DEVICES\" and ResourceType == \"IOTHUBS\"\n| where Category == \"Connections\" or  Category == \"D2CTwinOperations\"\n| extend parsed_json = parse_json(properties_s) \n| extend SDKVersion = tostring(parsed_json.sdkVersion) , DeviceId = tostring(parsed_json.deviceId)\n| distinct DeviceId, SDKVersion, TimeGenerated, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Connectvity errors",
    "query": "// Author: Microsoft Azure\n// Display name: Connectivity errors\n// Description: Identify device connection errors.\n// Categories: Azure Resources\n// Resource types: IoT Hub\n// Topic: Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DEVICES\" and ResourceType == \"IOTHUBS\"\n| where Category == \"Connections\" and Level == \"Error\""
  },
  {
    "source": "AzureMonitor",
    "name": "Devices with most throttling errors",
    "query": "// Author: Microsoft Azure\n// Display name: Devices with most throttling errors\n// Description: Identify devices that made the most requests resulting in throttling errors.\n// Categories: Azure Resources\n// Resource types: IoT Hub\n// Topic: Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DEVICES\" and ResourceType == \"IOTHUBS\"\n| where ResultType == \"429001\"\n| extend DeviceId = tostring(parse_json(properties_s).deviceId)\n| summarize count() by DeviceId, Category , _ResourceId\n| order by count_ desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Error summary",
    "query": "// Author: Microsoft Azure\n// Display name: Error summary\n// Description: Count of errors across all operations by type.\n// Categories: Azure Resources\n// Resource types: IoT Hub\n// Topic: Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DEVICES\" and ResourceType == \"IOTHUBS\"\n| where Level == \"Error\"\n| summarize count() by ResultType, ResultDescription, Category, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Recently connected devices",
    "query": "// Author: Microsoft Azure\n// Display name: Recently connected devices\n// Description: List of devices that IoT Hub saw connect in the specified time period.\n// Categories: Azure Resources\n// Resource types: IoT Hub\n// Topic: Usage\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.DEVICES\" and ResourceType == \"IOTHUBS\"\n| where Category == \"Connections\" and OperationName == \"deviceConnect\"\n| extend DeviceId = tostring(parse_json(properties_s).deviceId)\n| summarize max(TimeGenerated) by DeviceId, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "List all input deserialization errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all input deserialization errors\n// Description: Shows errors caused due to malformed events that could not be deserialized by the job.\n// Categories: Security\n// Resource types: Key vaults\n// Topic: Input data Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType in (\"InputDeserializerError.InvalidData\", \"InputDeserializerError.TypeConversionError\", \"InputDeserializerError.MissingColumns\", \"InputDeserializerError.InvalidHeader\", \"InputDeserializerError.InvalidCompressionType\")\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Are there any failures",
    "query": "// Author: Microsoft Azure\n// Display name: Are there any failures?\n// Description: Count of failed KeyVault requests by status code.\n// Categories: Security\n// Resource types: Key vaults\n// Topic: Usage and Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\" \n| where httpStatusCode_d \u003e= 300 and not(OperationName == \"Authentication\" and httpStatusCode_d == 401)\n| summarize count() by requestUri_s, ResultSignature, _ResourceId\n// ResultSignature contains HTTP status, e.g. \"OK\" or \"Forbidden\"\n// httpStatusCode_d contains HTTP status code returned by the request (e.g.  200, 300 or 401)\n// requestUri_s contains the URI of the request"
  },
  {
    "source": "AzureMonitor",
    "name": "Are there any slow requests",
    "query": "// Author: Microsoft Azure\n// Display name: Are there any slow requests?\n// Description: List of KeyVault requests that took longer than 1sec.\n// Categories: Security\n// Resource types: Key vaults\n// Topic: Usage and Diagnostics\n\nlet threshold=1000; // let operator defines a constant that can be further used in the query\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\" \n| where DurationMs \u003e threshold\n| summarize count() by OperationName, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "How active has this KeyVault been",
    "query": "// Author: Microsoft Azure\n// Display name: How active has this KeyVault been?\n// Description: Line chart showing trend of KeyVault requests volume, per operation over time.\n// Categories: Security\n// Resource types: Key vaults\n// Topic: Usage and Diagnostics\n\n// KeyVault diagnostic currently stores logs in AzureDiagnostics table which stores logs for multiple services. \n// Filter on ResourceProvider for logs specific to a service.\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\" \n| summarize count() by bin(TimeGenerated, 1h), OperationName // Aggregate by hour\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "How fast is this KeyVault serving requests",
    "query": "// Author: Microsoft Azure\n// Display name: How fast is this KeyVault serving requests?\n// Description: Line chart showing trend of request duration over time using different aggregations.\n// Categories: Security\n// Resource types: Key vaults\n// Topic: Usage and Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\" \n| summarize avg(DurationMs) by requestUri_s, bin(TimeGenerated, 1h) // requestUri_s contains the URI of the request\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "What changes occurred last month",
    "query": "// Author: Microsoft Azure\n// Display name: What changes occurred last month?\n// Description: Lists all update and patch requests from the last 30 days.\n// Categories: Security\n// Resource types: Key vaults\n// Topic: Usage and Diagnostics\n\n// KeyVault diagnostic currently stores logs in AzureDiagnostics table which stores logs for multiple services. \n// Filter on ResourceProvider for logs specific to a service.\nAzureDiagnostics\n| where TimeGenerated \u003e ago(30d) // Time range specified in the query. Overrides time picker in portal.\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\" \n| where OperationName == \"VaultPut\" or OperationName == \"VaultPatch\"\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Who is calling this KeyVault",
    "query": "// Author: Microsoft Azure\n// Display name: Who is calling this KeyVault?\n// Description: List of callers identified by their IP address with their request count.\n// Categories: Security\n// Resource types: Key vaults\n// Topic: Usage and Diagnostics\n\n// KeyVault diagnostic currently stores logs in AzureDiagnostics table which stores logs for multiple services. \n// Filter on ResourceProvider for logs specific to a service.\nAzureDiagnostics\n| where ResourceProvider ==\"MICROSOFT.KEYVAULT\"\n| summarize count() by CallerIPAddress"
  },
  {
    "source": "AzureMonitor",
    "name": "Container Lifecycle Information",
    "query": "// Author: Microsoft Azure\n// Display name: Container Lifecycle Information\n// Description: List all of a container's lifecycle information.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Audit\n\nContainerInventory\n| project Computer, Name, Image, ImageTag, ContainerState, CreatedTime, StartedTime, FinishedTime\n| top 200 by FinishedTime desc"
  },
  {
    "source": "AzureMonitor",
    "name": "kube-audit",
    "query": "// Author: hjgraca\n// Display name: Kube-audit diagnostics logs\n// Description: Kubernetes auditing provides a security-relevant chronological set of records documenting the sequence of activities that have affected system by individual users, administrators or other components of the system\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Topic: Audit\n\nAzureDiagnostics\n| where Category == 'kube-audit' and parse_json(log_s).level == \"RequestResponse\"\n| order by TimeGenerated desc \n| project log_s, parse_json(log_s).stageTimestamp, parse_json(log_s).user, parse_json(log_s).verb"
  },
  {
    "source": "AzureMonitor",
    "name": "List all the pods count with phase",
    "query": "// Author: Microsoft Azure\n// Display name: List all the pods count with phase\n// Description: View pod phase counts based on all phases: Failed, Pending, Unknown, Running, or Succeeded.\n// Categories: Containers\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Availability\n\n//Customize endDateTime, startDateTime to select different time range\n   let endDateTime = now();\n    let startDateTime = ago(1h);\n    let trendBinSize = 1m;\n    KubePodInventory\n    | where TimeGenerated \u003c endDateTime\n    | where TimeGenerated \u003e= startDateTime\n    | distinct ClusterName, TimeGenerated, _ResourceId\n    | summarize ClusterSnapshotCount = count() by bin(TimeGenerated, trendBinSize), ClusterName, _ResourceId\n    | join hint.strategy=broadcast (\n        KubePodInventory\n        | where TimeGenerated \u003c endDateTime\n        | where TimeGenerated \u003e= startDateTime\n        | distinct ClusterName, Computer, PodUid, TimeGenerated, PodStatus, _ResourceId\n        | summarize TotalCount = count(), //Calculating count for per pod status\n                    PendingCount = sumif(1, PodStatus =~ 'Pending'),\n                    RunningCount = sumif(1, PodStatus =~ 'Running'),\n                    SucceededCount = sumif(1, PodStatus =~ 'Succeeded'),\n                    FailedCount = sumif(1, PodStatus =~ 'Failed')\n                 by ClusterName, bin(TimeGenerated, trendBinSize), _ResourceId\n    ) on ClusterName, TimeGenerated, _ResourceId\n    | extend UnknownCount = TotalCount - PendingCount - RunningCount - SucceededCount - FailedCount\n    | project TimeGenerated, _ResourceId,\n    TotalCount = todouble(TotalCount) / ClusterSnapshotCount,\n              PendingCount = todouble(PendingCount) / ClusterSnapshotCount,\n              RunningCount = todouble(RunningCount) / ClusterSnapshotCount,\n              SucceededCount = todouble(SucceededCount) / ClusterSnapshotCount,\n              FailedCount = todouble(FailedCount) / ClusterSnapshotCount,\n              UnknownCount = todouble(UnknownCount) / ClusterSnapshotCount"
  },
  {
    "source": "AzureMonitor",
    "name": "Readiness status per Node",
    "query": "// Author: Microsoft Azure\n// Display name: Readiness status per Node\n// Description: For all your cluster view count of all the nodes by readiness.\n// Categories: Containers\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Availability\n\n//Customize startDateTime, endDateTime to select custom time range\nlet endDateTime = now();\nlet startDateTime = ago(1h);\nlet trendBinSize = 1m;\nKubeNodeInventory\n| where TimeGenerated \u003c endDateTime\n| where TimeGenerated \u003e= startDateTime\n| distinct ClusterName, Computer, _ResourceId,TimeGenerated\n| summarize ClusterSnapshotCount = count() by bin(TimeGenerated, trendBinSize), ClusterName, Computer, _ResourceId\n| join hint.strategy=broadcast kind=inner (\n    KubeNodeInventory //this calculating ready node count.\n    | where TimeGenerated \u003c endDateTime\n    | where TimeGenerated \u003e= startDateTime\n    | summarize TotalCount = count(), ReadyCount = sumif(1, Status contains ('Ready'))\n                by ClusterName, Computer,  bin(TimeGenerated, trendBinSize), _ResourceId //calculating NotReadyCount\n    | extend NotReadyCount = TotalCount - ReadyCount\n) on ClusterName, Computer, _ResourceId, TimeGenerated\n //projecting all the fields\n| project   TimeGenerated, ClusterName, Computer, ReadyCount = todouble(ReadyCount) / ClusterSnapshotCount, \n            NotReadyCount = todouble(NotReadyCount) / ClusterSnapshotCount, _ResourceId\n| order by ClusterName asc, Computer asc, TimeGenerated desc, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "List container logs per namespace",
    "query": "// Author: Microsoft Azure\n// Display name: List container logs per namespace\n// Description: View container logs from all the namespaces in the cluster.\n// Categories: Containers\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Container Logs\n\n\nlet notBefore=ago(1h);\nContainerLog\n| where TimeGenerated \u003e notBefore\n|join kind=leftouter (\nKubePodInventory\n| distinct Computer, ClusterId, ServiceName, ControllerName, ContainerID, ContainerName, Name, Namespace, ClusterName\n| project-rename PodName=Name\n)//KubePodInventory Contains pod metadata\non ContainerID\n| extend ContainerName = split(ContainerName, \"/\")[1] // KubePodInventory stores ContainerName in format PodUI/container name, hence we split\n| sort by TimeGenerated\n| project TimeGenerated, Namespace, PodName, ContainerName, LogEntry, LogEntrySource"
  },
  {
    "source": "AzureMonitor",
    "name": "Billable Log Data by logtype",
    "query": "// Author: Microsoft Azure\n// Display name: Billable Log Data by log-type\n// Description: See container logs billable data for the last 7d ,segregated by log-type.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Costing\n\n// Set the requested time, anytime greater than 15d can take longer\nlet billableTimeView = 7d;  \n//Join ContainerLog on KubePodInventory for LogEntry source\nContainerLog\n| join(KubePodInventory | where TimeGenerated \u003e startofday(ago(billableTimeView)))on ContainerID\n| where TimeGenerated \u003e startofday(ago(billableTimeView))\n| summarize Total=sum(_BilledSize)/ 1000 by bin(TimeGenerated, 1d), LogEntrySource"
  },
  {
    "source": "AzureMonitor",
    "name": "Billable Log Data pernamespace",
    "query": "// Author: Microsoft Azure\n// Display name: Billable Log Data per-namespace\n// Description: See container logs billable data for the last 7d, segregated by namespace.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Costing\n\nlet billableTimeView = 7d; // Set the requested time - 30d can take some time. \nContainerLog\n|join(KubePodInventory | where TimeGenerated \u003e startofday(ago(billableTimeView)))\non ContainerID\n|where TimeGenerated \u003e startofday(ago(billableTimeView))\n| summarize Total=sum(_BilledSize)/ 1000 by bin(TimeGenerated, 1d), Namespace"
  },
  {
    "source": "AzureMonitor",
    "name": "Container Insight solution billable data",
    "query": "// Author: Microsoft Azure\n// Display name: Container Insight solution billable data\n// Description: See total billable data from Container Insights solution.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Topic: Costing\n\n//This includes billable data for all solutions in the workspace, see for Container Insights solution\nUsage\n| where TimeGenerated \u003e startofday(ago(30d))\n| where IsBillable == true\n| summarize TotalVolumeGB = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), Solution\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Environment variable enriching",
    "query": "// Author: Microsoft Azure\n// Display name: Environment variable enriching\n// Description: View data ingested by environment variables per hour.\n// Categories: Containers\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Costing\n\n//Update the TimeGenerated to customize the timerange\nContainerInventory\n| where TimeGenerated \u003e ago(1h)\n| summarize envvarsMB = sum(string_size(EnvironmentVar)) / (1000. * 1000.)"
  },
  {
    "source": "AzureMonitor",
    "name": "View data ingested by completed jobs",
    "query": "// Author: Microsoft Azure\n// Display name: View data ingested by completed jobs\n// Description: View data ingested size by jobs that are completed.\n// Categories: Containers,Workloads,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Costing\n\n//Modify StartTime to customize TimeRange for completedjobs inventory.\nlet startTime = ago(1h);\n//Find all the jobs which are completed\nlet kpi = KubePodInventory\n| where TimeGenerated \u003e startTime\n| where _IsBillable == true\n| where PodStatus in (\"Succeeded\", \"Failed\")\n| where ControllerKind == \"Job\";\n//Find the the billable data for the jobs\nlet containerInventory = ContainerInventory\n| where TimeGenerated \u003e startTime\n| where _IsBillable == true\n| summarize BillableDataMBytes = sum(_BilledSize)/ (1000. * 1000.) by ContainerID;\n//Join on both the tables to calculate the billable data \nlet containerInventoryMB = containerInventory\n| join kpi on $left.ContainerID == $right.ContainerID\n| summarize MB=sum(BillableDataMBytes);\nlet kpiMB = kpi\n| summarize MB = sum(_BilledSize)/ (1000. * 1000.);\nunion\n(containerInventoryMB),(kpiMB)\n| summarize doneJobsInventoryMB=sum(MB)"
  },
  {
    "source": "AzureMonitor",
    "name": "Image inventory",
    "query": "// Author: Microsoft Azure\n// Display name: Image inventory\n// Description: Lists all the container image with their status.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Diagnostics\n\nContainerImageInventory\n| summarize AggregatedValue = count() by Image, ImageTag, Running, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Instances Avg CPU usage growth from last week",
    "query": "// Author: Microsoft Azure\n// Display name: Instances Avg CPU usage growth from last week\n// Description: Show Avg CPU growth by instance in the last week by descending order.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Topic: Diagnostics\n\n//Show which instances grew CPU usage from last week to current\nPerf\n| where TimeGenerated \u003e ago(7d) //This week Average CPU Usage Nano Cores\n| where ObjectName == \"K8SContainer\" and CounterName == \"cpuUsageNanoCores\"\n| summarize ThisWeekAvgCPU = avg(CounterValue) by InstanceName, _ResourceId\n| join kind= leftouter (\n    //Previous week Average CPU Usage Nano Cores\n    Perf\n    | where TimeGenerated \u003e ago(14d) and TimeGenerated \u003c= ago(7d)\n    | where ObjectName == \"K8SContainer\" and CounterName == \"cpuUsageNanoCores\"\n    | summarize PrevWeekAvgCPU = avg(CounterValue) by InstanceName, _ResourceId\n) on InstanceName, _ResourceId\n| extend InstanceNameParts = split(InstanceName, \"/\")  //array of the parts of the instance name\n| extend ShortInstanceName = InstanceNameParts[(array_length(InstanceNameParts)-1)] //extract the last part of the instance name\n| extend ThisWeekAvgCPU = round(ThisWeekAvgCPU,0) \n| extend PrevWeekAvgCPU = round(iff(isempty(PrevWeekAvgCPU),0.0,PrevWeekAvgCPU),0) //When doing join with kind=leftouter, missing matches has empty value. To calculate growth, it should be converted to zero. In this case, empty value means that instance did not exist in the previous week\n| extend AvgCPUGrowth = round(ThisWeekAvgCPU - PrevWeekAvgCPU , 0) //Calculate growth\n| project-away InstanceName1,InstanceNameParts //Remove redundant fields\n| order by AvgCPUGrowth desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Kubernetes events",
    "query": "// Author: Microsoft Azure\n// Display name: Kubernetes events\n// Description: Lists all the Kubernetes events.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Diagnostics\n\nKubeEvents\n| where TimeGenerated \u003e ago(7d) \n| where not(isempty(Namespace))\n| top 200 by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Prometheus disk read per second per node",
    "query": "// Author: Microsoft Azure\n// Display name: Prometheus disk read per second per node\n// Description: View Prometheus disk read metrics from the default kubernetes namespace as timechart.\n// Categories: Containers,Workloads,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Diagnostics\n\n// Update TimeGenerated field for custom time range\nInsightsMetrics\n| where Namespace == 'container.azm.ms/diskio'\n| where TimeGenerated \u003e ago(1h)\n| where Name == 'reads'\n| extend Tags = todynamic(Tags)\n| extend HostName = tostring(Tags.hostName), Device = Tags.name\n| extend NodeDisk = strcat(Device, \"/\", HostName)\n| order by NodeDisk asc, TimeGenerated asc\n| serialize //calculating the PreVal, PrevTimeGenerated to render the chart.\n| extend PrevVal = iif(prev(NodeDisk) != NodeDisk, 0.0, prev(Val)), PrevTimeGenerated = iif(prev(NodeDisk) != NodeDisk, datetime(null), prev(TimeGenerated))\n| where isnotnull(PrevTimeGenerated) and PrevTimeGenerated != TimeGenerated\n//Calculating the rate for disk using PreVal\n| extend Rate = iif(PrevVal \u003e Val, Val / (datetime_diff('Second', TimeGenerated, PrevTimeGenerated) * 1), iif(PrevVal == Val, 0.0, (Val - PrevVal) / (datetime_diff('Second', TimeGenerated, PrevTimeGenerated) * 1)))\n| where isnotnull(Rate)\n| project TimeGenerated, NodeDisk, Rate, _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Avg node CPU usage percentage per minute",
    "query": "// Author: Microsoft Azure\n// Display name: Avg node CPU usage percentage per minute\n// Description: For your cluster view avg node CPU usage percentage per minute over the last hour.\n// Categories: Containers\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Performance\n\n//Modify the startDateTime \u0026 endDateTime to customize the timerange\nlet endDateTime = now();\nlet startDateTime = ago(1h);\nlet trendBinSize = 1m;\nlet capacityCounterName = 'cpuCapacityNanoCores';\nlet usageCounterName = 'cpuUsageNanoCores';\nKubeNodeInventory\n| where TimeGenerated \u003c endDateTime\n| where TimeGenerated \u003e= startDateTime\n// cluster filter would go here if multiple clusters are reporting to the same Log Analytics workspace\n| distinct ClusterName, Computer, _ResourceId\n| join hint.strategy=shuffle (\n  Perf\n  | where TimeGenerated \u003c endDateTime\n  | where TimeGenerated \u003e= startDateTime\n  | where ObjectName == 'K8SNode'\n  | where CounterName == capacityCounterName\n  | summarize LimitValue = max(CounterValue) by Computer, CounterName, bin(TimeGenerated, trendBinSize)\n  | project Computer, CapacityStartTime = TimeGenerated, CapacityEndTime = TimeGenerated + trendBinSize, LimitValue\n) on Computer\n| join kind=inner hint.strategy=shuffle (\n  Perf\n  | where TimeGenerated \u003c endDateTime + trendBinSize\n  | where TimeGenerated \u003e= startDateTime - trendBinSize\n  | where ObjectName == 'K8SNode'\n  | where CounterName == usageCounterName\n  | project Computer, UsageValue = CounterValue, TimeGenerated\n) on Computer\n| where TimeGenerated \u003e= CapacityStartTime and TimeGenerated \u003c CapacityEndTime\n| project ClusterName, Computer, TimeGenerated, UsagePercent = UsageValue * 100.0 / LimitValue, _ResourceId\n| summarize AggregatedValue = avg(UsagePercent) by bin(TimeGenerated, trendBinSize), ClusterName, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Avg node memory usage percentage per minute",
    "query": "// Author: Microsoft Azure\n// Display name: Avg node memory usage percentage per minute\n// Description: For your cluster view avg node memory usage percentage per minute over the last hour.\n// Categories: Containers\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Performance\n\nlet endDateTime = now();\nlet startDateTime = ago(1h);\nlet trendBinSize = 1m;\nlet capacityCounterName = 'memoryCapacityBytes';\nlet usageCounterName = 'memoryRssBytes';\nKubeNodeInventory\n| where TimeGenerated \u003c endDateTime\n| where TimeGenerated \u003e= startDateTime\n// cluster filter would go here if multiple clusters are reporting to the same Log Analytics workspace\n| distinct ClusterName, Computer, _ResourceId\n| join hint.strategy=shuffle (\n  Perf\n  | where TimeGenerated \u003c endDateTime\n  | where TimeGenerated \u003e= startDateTime\n  | where ObjectName == 'K8SNode'\n  | where CounterName == capacityCounterName\n  | summarize LimitValue = max(CounterValue) by Computer, CounterName, bin(TimeGenerated, trendBinSize)\n  | project Computer, CapacityStartTime = TimeGenerated, CapacityEndTime = TimeGenerated + trendBinSize, LimitValue\n) on Computer\n| join kind=inner hint.strategy=shuffle (\n  Perf\n  | where TimeGenerated \u003c endDateTime + trendBinSize\n  | where TimeGenerated \u003e= startDateTime - trendBinSize\n  | where ObjectName == 'K8SNode'\n  | where CounterName == usageCounterName\n  | project Computer, UsageValue = CounterValue, TimeGenerated\n) on Computer\n| where TimeGenerated \u003e= CapacityStartTime and TimeGenerated \u003c CapacityEndTime\n| project ClusterName, Computer, TimeGenerated, UsagePercent = UsageValue * 100.0 / LimitValue, _ResourceId\n| summarize AggregatedValue = avg(UsagePercent) by bin(TimeGenerated, trendBinSize), ClusterName, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Container CPU",
    "query": "// Author: Microsoft Azure\n// Display name: Container CPU\n// Description: View all the container CPU usage averaged over 30mins.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Topic: Performance\n\n//Select the Line chart display option: can we calculate percentage?\nPerf\n| where ObjectName == \"K8SContainer\" and CounterName == \"cpuUsageNanoCores\"\n| summarize AvgCPUUsageNanoCores = avg(CounterValue) by bin(TimeGenerated, 30m), InstanceName, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Container memory",
    "query": "// Author: Microsoft Azure\n// Display name: Container memory\n// Description: View container CPU averaged over 30 mins intervals.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Topic: Performance\n\n//Select the Line chart display option: can we calculate percentage?\nlet threshold = 75000000; // choose a threshold \nPerf\n| where ObjectName == \"K8SContainer\" and CounterName == \"memoryRssBytes\"\n| summarize AvgUsedRssMemoryBytes = avg(CounterValue) by bin(TimeGenerated, 30m), InstanceName, _ResourceId\n| where AvgUsedRssMemoryBytes \u003e threshold \n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Maximum node disk",
    "query": "// Author: Microsoft Azure\n// Display name: Maximum node disk\n// Description: Max node disk usage averaged over 30 mins intervals.\n// Categories: Containers,Azure Resources\n// Resource types: Kubernetes services\n// Solutions: ContainerInsights\n// Topic: Performance\n\n//InsightMetrics contains all the custom metrics for Container Insights solution\nInsightsMetrics // Replace Name with your custom metric\n| where Name == \"used_percent\" and Namespace == \"container.azm.ms/disk\" \n| summarize val= max(Val) by bin(TimeGenerated, 15m), _ResourceId\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Most Requested ResourceIds",
    "query": "// Author: Microsoft Azure\r\n// Display name: Most Requested ResourceIds\r\n// Description: Most queried resources over the last 24 hours.\r\n// Categories: Audit,Azure Monitor\r\n// Resource types: Log Analytics workspaces\r\n// Topic: Audit\r\n\r\nLAQueryLogs\r\r\n| extend reqContext = parse_json(RequestContext)\r\r\n| extend datasources = array_concat(reqContext[\"resources\"], reqContext[\"workspaces\"], reqContext[\"applications\"])\r\r\n| mv-expand datasources\r\r\n| summarize reqCount = count() by tostring(datasources)\r\r\n| order by reqCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Request Count by ResponseCode",
    "query": "// Author: Microsoft Azure\r\n// Display name: Request Count by ResponseCode\r\n// Description: Request count by response code within 1 min buckets in last 1 hour.\r\n// Categories: Audit,Azure Monitor\r\n// Resource types: Log Analytics workspaces\r\n// Topic: Audit\r\n\r\nLAQueryLogs\r\r\n| where TimeGenerated \u003e ago(1h)\r\r\n| summarize count() by tostring(ResponseCode), bin(TimeGenerated, 1m)\r\r\n| render columnchart with (kind=stacked)"
  },
  {
    "source": "AzureMonitor",
    "name": "Throttled Users",
    "query": "// Author: Microsoft Azure\r\n// Display name: Throttled Users\r\n// Description: Get a list of throttled users with their request count in last 24 hours.\r\n// Categories: Audit,Azure Monitor\r\n// Resource types: Log Analytics workspaces\r\n// Topic: Audit\r\n\r\nLAQueryLogs\r\r\n| where ResponseCode == \"429\"\r\r\n| summarize reqCount = count() by AADObjectId\r\r\n| order by reqCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 longest time range queries",
    "query": "// Author: Microsoft Azure\r\n// Display name: Top 10 longest time range queries\r\n// Description: Get top 10 queries that scanned the longest time range in last 24 hours.\r\n// Categories: Audit,Azure Monitor\r\n// Resource types: Log Analytics workspaces\r\n// Topic: Audit\r\n\r\nLAQueryLogs\r\r\n| extend DataProcessedTimeRange = format_timespan(StatsDataProcessedEnd - StatsDataProcessedStart, 'dd.hh:mm:ss:FF')\r\r\n| top 10 by DataProcessedTimeRange desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 resource intensive queries",
    "query": "// Author: Microsoft Azure\r\n// Display name: Top 10 resource intensive queries\r\n// Description: Get top 10 resource intesive queries (based on CPU consumption) in last 24 hours.\r\n// Categories: Audit,Azure Monitor\r\n// Resource types: Log Analytics workspaces\r\n// Topic: Audit\r\n\r\nLAQueryLogs\r\r\n| top 10 by StatsCPUTimeMs desc nulls last"
  },
  {
    "source": "AzureMonitor",
    "name": "Unauthorized Users",
    "query": "// Author: Microsoft Azure\r\n// Display name: Unauthorized Users\r\n// Description: Get a list of unauthorized users with their request count in last 24 hours.\r\n// Categories: Audit,Azure Monitor\r\n// Resource types: Log Analytics workspaces\r\n// Topic: Audit\r\n\r\nLAQueryLogs\r\r\n| where ResponseCode == \"403\"\r\r\n| summarize reqCount = count() by AADObjectId\r\r\n| order by reqCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Most used tables",
    "query": "// Author: Evgeny Ternovsky, Rafi Rabo\n// Display name: Most used tables\n// Description: Counts and lists the tables that were used.\n// Categories: Audit,Azure Monitor\n// Resource types: Log Analytics workspaces\n// Topic: Usage\n\nlet timerange = 7d; // Replace with time period over which to look\n// List of tables that were used\nlet validTables=(\n    Usage // Consider changing to workspace(\"MyLogAnalyticsWS\").Usage , replace with the name of the workspace for which the metric is to be evaluated\n    | where TimeGenerated \u003e ago(timerange)\n    | distinct DataType\n);\nLAQueryLogs\n| where TimeGenerated \u003e ago(timerange)\n| where QueryText has_any (validTables)\n| extend queryLine = split(QueryText, \"\\n\")\n| mv-expand queryLine\n| extend dummy=1\n| join kind=inner (validTables | extend dummy=1) on dummy\n| extend isTableUsed=iff(queryLine has DataType, 1, 0)\n| summarize sum(isTableUsed) by DataType\n| order by sum_isTableUsed desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Number of queries run over a set time frame",
    "query": "// Author: Evgeny Ternovsky, Rafi Rabo\n// Display name: Number of queries run over a set time frame\n// Description: Counts the number of queries that ran over a set time frame.\n// Categories: Audit,Azure Monitor\n// Resource types: Log Analytics workspaces\n// Topic: Usage\n\nlet startDate = todatetime('2020-10-01T01:00:00.000Z');\nlet endDate   = todatetime('2020-10-02T23:59:59.999Z');\nLAQueryLogs\n| where TimeGenerated between (startDate .. endDate)\n| count"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 users by tables access",
    "query": "// Author: Evgeny Ternovsky, Rafi Rabo\n// Display name: Top 10 users by table access\n// Description: Lists top 10 users by the distinct count of tables that were accessed.\n// Categories: Audit,Azure Monitor\n// Resource types: Log Analytics workspaces\n// Topic: Usage\n\nlet timerange = 7d; //replace with time period over which to look\n// List of tables that were used\nlet validTables=(\n    Usage // Consider changing to workspace(\"MyLogAnalyticsWS\").Usage , replace with the name of the workspace for which the metric is to be evaluated\n    | where TimeGenerated \u003e ago(timerange)\n    | distinct DataType\n);\nLAQueryLogs\n| where TimeGenerated \u003e ago(timerange)\n| where QueryText has_any (validTables)\n| extend queryLine = split(QueryText, \"\\n\")\n| mv-expand queryLine\n| extend dummy=1\n| join kind=inner (validTables | extend dummy=1) on dummy\n| where queryLine has DataType\n| summarize dcount(DataType) by AADEmail\n| top 10 by dcount_DataType desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 users by total access",
    "query": "// Author: Evgeny Ternovsky, Rafi Rabo\n// Display name: Top 10 users by total access\n// Description: Lists top 10 users by the number of accesses to tables.\n// Categories: Audit,Azure Monitor\n// Resource types: Log Analytics workspaces\n// Topic: Usage\n\nlet timerange = 7d; //replace with time period over which to look\n// List of tables that were used\nlet validTables=(\n    Usage // Consider changing to workspace(\"MyLogAnalyticsWS\").Usage , replace with the name of the workspace for which the metric is to be evaluated\n    | where TimeGenerated \u003e ago(timerange)\n    | distinct DataType\n);\nLAQueryLogs\n| where TimeGenerated \u003e ago(timerange)\n| where QueryText has_any (validTables)\n| extend queryLine = split(QueryText, \"\\n\")\n| mv-expand queryLine\n| extend dummy=1\n| join kind=inner (validTables | extend dummy=1) on dummy\n| extend isTableUsed=iff(queryLine has DataType, 1, 0)\n| summarize numTablesAccessed = sum(isTableUsed) by AADEmail\n| top 10 by numTablesAccessed desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Users who ran queries",
    "query": "// Author: Evgeny Ternovsky, Rafi Rabo\n// Display name: Users who ran queries\n// Description: Lists all users who ran any number of queries in the last 24 hours.\n// Categories: Audit,Azure Monitor\n// Resource types: Log Analytics workspaces\n// Topic: Usage\n\nLAQueryLogs\n| where TimeGenerated \u003e ago(24h)\n| distinct AADEmail"
  },
  {
    "source": "AzureMonitor",
    "name": "Total billable executions",
    "query": "// Author: Microsoft Azure\n// Display name: Total billable executions\n// Description: Total billable executions by operation name.\n// Categories: Azure Resources\n// Resource types: Logic Apps\n// Topic: Costing\n\n// Total billable executions\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.LOGIC\"\n| where Category == \"WorkflowRuntime\" \n| where OperationName has \"workflowTriggerStarted\" or OperationName has \"workflowActionStarted\" \n| summarize dcount(resource_runId_s) by OperationName, resource_workflowName_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Logic App execution distribution by status",
    "query": "// Author: Microsoft Azure\n// Display name: Logic App execution distribution by status\n// Description: Completed executions by workflow,status and error.\n// Categories: Azure Resources\n// Resource types: Logic Apps\n// Topic: Diagnostics\n\n//logic app execution status summary\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.LOGIC\"\n| where OperationName has \"workflowRunCompleted\"\n| summarize dcount(resource_runId_s) by resource_workflowName_s, status_s, error_code_s\n| project LogicAppName = resource_workflowName_s , NumberOfExecutions = dcount_resource_runId_s , RunStatus = status_s , Error = error_code_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Logic App execution distribution by workflows",
    "query": "// Author: Microsoft Azure\n// Display name: Logic App execution distribution by workflows\n// Description: Hourly timechart for Logic App execution, distribution by workflows.\n// Categories: Azure Resources\n// Resource types: Logic Apps\n// Topic: Diagnostics\n\n// Hourly Time chart for Logic App execution distribution by workflows\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.LOGIC\"\n| where Category == \"WorkflowRuntime\"\n| where OperationName has \"workflowRunStarted\"\n| summarize dcount(resource_runId_s) by bin(TimeGenerated, 1h), resource_workflowName_s\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Triggered failuers count",
    "query": "// Author: Microsoft Azure\n// Display name: Triggered failuers count\n// Description: Show Action/Trigger failures for all Logic App executions by Resource name.\n// Categories: Azure Resources\n// Resource types: Logic Apps\n// Topic: Errors\n\n//Action/Trigger failures for all Logic App executions\nAzureDiagnostics\n| where ResourceProvider  == \"MICROSOFT.LOGIC\"  \n| where Category == \"WorkflowRuntime\" \n| where status_s == \"Failed\" \n| where OperationName has \"workflowActionCompleted\" or OperationName has \"workflowTriggerCompleted\" \n| extend ResourceName = coalesce(resource_actionName_s, resource_triggerName_s) \n| extend ResourceCategory = substring(OperationName, 34, strlen(OperationName) - 43) | summarize dcount(resource_runId_s) by code_s, ResourceName, resource_workflowName_s, ResourceCategory, _ResourceId\n| project ResourceCategory, ResourceName , FailureCount = dcount_resource_runId_s , ErrorCode = code_s, LogicAppName = resource_workflowName_s, _ResourceId \n| order by FailureCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Connection_monitor_status",
    "query": "let ConnectionMonitor = 'Name_of_connection_monitor';\nlet Status = NWConnectionMonitorTestResult\n  | where ConnectionMonitorResourceId contains ConnectionMonitor\n  | summarize TestTime=max(TimeGenerated) by TestGroupName, TestResult\n  | extend Status=replace_regex(TestResult, @'Fail', @'failed') //replacements to use icon fields\n  | extend Status=replace_regex(Status, @'Pass', @'Available') //replacements to use icon fields\n  | project TestGroupName, Status, TestTime;\nlet AvgRoundTripTimeMs = NWConnectionMonitorTestResult\n  | where TimeGenerated {TimeRange} //TimeRange workbook parameter\n  | where ConnectionMonitorResourceId contains ConnectionMonitor\n  | summarize AvgRoundTripMs=round(avg(AvgRoundTripTimeMs),2) by TestGroupName;\nlet SerieRoundTripTimeMs = NWConnectionMonitorTestResult //for using a spark-bar column\n  | where TimeGenerated {TimeRange}\n  | where ConnectionMonitorResourceId contains ConnectionMonitor\n  | make-series round(avg(AvgRoundTripTimeMs),2) on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by TestGroupName\n  | project TestGroupName, RoundTripMsSerie=avg_AvgRoundTripTimeMs;\nlet MinRoundTripTimeMs = NWConnectionMonitorTestResult\n  | where TimeGenerated {TimeRange}\n  | where ConnectionMonitorResourceId contains ConnectionMonitor\n  | summarize arg_min(AvgRoundTripTimeMs, *) by TestGroupName\n  | project TestGroupName, MinRoundTripMs=round(AvgRoundTripTimeMs, 2);\nlet MaxRoundTripTimeMs = NWConnectionMonitorTestResult\n  | where TimeGenerated {TimeRange}\n  | where ConnectionMonitorResourceId contains ConnectionMonitor\n  | summarize arg_max(AvgRoundTripTimeMs, *) by TestGroupName\n  | project TestGroupName, MaxRoundTripMs=round(AvgRoundTripTimeMs, 2);\nlet History = NWConnectionMonitorTestResult //for using a spark-bar column\n  | where TimeGenerated {TimeRange}\n  | where ConnectionMonitorResourceId contains ConnectionMonitor\n  | extend Status=replace_regex(TestResult, @'Fail', @'0')\n  | extend Status=replace_regex(Status, @'Pass', @'1')\n  | extend Status=todouble(Status)\n  | make-series History=avg(Status) on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by TestGroupName\n  | project TestGroupName, History;\nNWConnectionMonitorTestResult\n| where TimeGenerated {TimeRange}\n| where ConnectionMonitorResourceId contains ConnectionMonitor\n| distinct TestGroupName\n| join kind=inner ( Status ) on TestGroupName\n| join kind=inner ( AvgRoundTripTimeMs ) on TestGroupName\n| join kind=inner ( SerieRoundTripTimeMs ) on TestGroupName\n| join kind=inner ( MinRoundTripTimeMs ) on TestGroupName\n| join kind=inner ( MaxRoundTripTimeMs ) on TestGroupName\n| join kind=inner ( History ) on TestGroupName\n| sort by TestGroupName asc\n| project ConnectivityTest=TestGroupName, Status, TestTime, AvgRoundTripMs, MinRoundTripMs, MaxRoundTripMs,RoundTripMsSerie, History"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed tests",
    "query": "// Author: Microsoft Azure\r\n// Display name: Failed tests\r\n// Description: Gets failed distinct source, destination, test group and test configuration for each resource.\r\n// Categories: Network\r\n// Resource types: Network Watcher - Connection Monitor\r\n// Topic: Audit\r\n\r\nNWConnectionMonitorTestResult \r\r\n| where TimeGenerated \u003e ago(24h) \r\r\n| where TestResult == \"Fail\"\r\r\n| distinct _ResourceId, SourceName, DestinationName, TestGroupName, TestConfigurationName"
  },
  {
    "source": "AzureMonitor",
    "name": "Path diagnostics",
    "query": "// Author: Microsoft Azure\r\n// Display name: Path diagnostics\r\n// Description: Gets path or all hops along with identified issues between given source and destination of a resource.\r\n// Categories: Network\r\n// Resource types: Network Watcher - Connection Monitor\r\n// Topic: Diagnostics\r\n\r\n// For specific results, insert values in the let statements and uncomment the where filters within the query\r\r\n// let connectionMonitorResourceId = \"\u003cConnection Monitor Resource Id\u003e\";\r\r\n// let sourceName = \"\u003cSource Name\u003e\";\r\r\n// let destinationName = \"\u003cDestination Name\u003e\";\r\r\n// let testGroupName = \"\u003cTest Group Name\u003e\";\r\r\n// let testConfigurationName = \"\u003cTest Configuration Name\u003e\";\r\r\nNWConnectionMonitorPathResult \r\r\n| where TimeGenerated \u003e ago(24h) \r\r\n// | where ConnectionMonitorResourceId has connectionMonitorResourceId\r\r\n// | where SourceName has sourceName\r\r\n// | where DestinationName has destinationName\r\r\n// | where TestGroupName has testGroupName\r\r\n// | where TestConfigurationName has testConfigurationName\r\r\n| project TimeGenerated, ConnectionMonitorResourceId, PathTestResult, SourceName, SourceAddress, DestinationName, DestinationAddress, Hops\r\r\n| order by TimeGenerated desc;"
  },
  {
    "source": "AzureMonitor",
    "name": "Tests performance",
    "query": "// Author: Microsoft Azure\r\n// Display name: Tests performance\r\n// Description: Gets loss percentage and average latency between given source and destination of a resource.\r\n// Categories: Network\r\n// Resource types: Network Watcher - Connection Monitor\r\n// Topic: Performance\r\n\r\n// For specific results, insert values in the let statements and uncomment the where filters within the query\r\r\n// let connectionMonitorResourceId = \"\u003cConnection Monitor Resource Id\u003e\";\r\r\n// let sourceName = \"\u003cSource Name\u003e\";\r\r\n// let destinationName = \"\u003cDestination Name\u003e\";\r\r\n// let testGroupName = \"\u003cTest Group Name\u003e\";\r\r\n// let testConfigurationName = \"\u003cTest Configuration Name\u003e\";\r\r\nNWConnectionMonitorTestResult \r\r\n| where TimeGenerated \u003e ago(24h) \r\r\n// | where ConnectionMonitorResourceId has connectionMonitorResourceId\r\r\n// | where SourceName has sourceName\r\r\n// | where DestinationName has destinationName\r\r\n// | where TestGroupName has testGroupName\r\r\n// | where TestConfigurationName has testConfigurationName\r\r\n| extend LossPercent = ChecksFailed * 100 / ChecksTotal\r\r\n| project TimeGenerated, ConnectionMonitorResourceId, TestResult, AvgRoundTripTimeMs, LossPercent, SourceName, SourceAddress, DestinationName, DestinationAddress\r\r\n| order by TimeGenerated desc;"
  },
  {
    "source": "AzureMonitor",
    "name": "Cloud flow runs with direct link to flow run",
    "query": "// Author: aliyoussefi\n// Display name: Display cloud flow runs with direct link\n// Description: Display all cloud flow runs with a direct link to the cloud flow run for troubleshooting\n// Categories: Power Platform\n// Resource types: Power Automate\n// Topic:  Troubleshooting\n\nrequests \n| where customDimensions.resourceProvider == 'Cloud Flow'\n| extend data = todynamic(tostring(customDimensions.Data))\n| project timestamp, operation_Id,  operation_ParentId, success, duration, customDimensions.signalCategory, name, data.FlowDisplayName, data.tags.xrmWorkflowId , data.tags.createdBy, \ndata, customDimensions, directlink=strcat(\"https://make.powerautomate.com/environments/\", data.tags.environmentName, \"/flows/\",  name, \"/runs/\", operation_Id)"
  },
  {
    "source": "AzureMonitor",
    "name": "Cloud flows in use",
    "query": "// Author: aliyoussefi\n// Display name: Display types of flows used over a span of time\n// Description: Summary of Power Automate flows by name over timespan.\n// Categories: Power Platform\n// Resource types: Power Automate\n// Topic:  Usage Analytics\n\nrequests\n| where timestamp \u003e ago(1h)\n| extend requestData = todynamic(tostring(customDimensions.Data))\n| join kind=leftouter (dependencies | where type == \"Cloud Flow/Cloud flow triggers\" | project TriggerName = name, target) on $left.name == $right.target\n| summarize FlowDisplayNameRuns = count() by tostring(requestData.FlowDisplayName), TriggerName, tostring(requestData.FlowDisplayName), tostring(requestData.tags.createdBy)\n| project TriggerName,  tostring(requestData_FlowDisplayName), FlowDisplayNameRuns, requestData_tags_createdBy"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed cloud flows",
    "query": "// Author: aliyoussefi\n// Display name: Display unsuccessful cloud flow runs with direct link\n// Description: Display unsuccessful cloud flow runs with a direct link to the cloud flow run for troubleshooting\n// Categories: Power Platform\n// Resource types: Power Automate\n// Topic:  Troubleshooting\ndependencies \n| where success == false\n| extend error = todynamic(tostring(customDimensions.error))\n| extend tags = todynamic(tostring(customDimensions.tags))\n| project \n    timestamp, \n    target, \n    operation_Id, \n    operation_ParentId, \n    name, \n    error.code, \n    error.message, \n    customDimensions.signalCategory,\n    tags.capabilities,\n    tags.environmentName,\n    directlink=strcat(\"https://make.powerautomate.com/environments/\", tags.environmentName, \"/flows/\",  target, \"/runs/\", operation_ParentId)"
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of flow runs statuses",
    "query": "// Author: Alok Sriwastaw\n// Display name: Display cloud flow runs with grouped by statuses\n// Description: Summary of Power Automate flow runs grouped into total runs, success and failures over timespan.\n// Categories: Power Platform\n// Resource types: Power Automate\n// Topic:  Usage Analytics\n\nrequests\n| extend cd = parse_json(customDimensions)\n| where cd.resourceProvider has \"Cloud Flow\"\n| extend data = parse_json(tostring(cd.Data))\n| extend FlowName = tostring(data.FlowDisplayName)\n|summarize nRun = count(), nFailed = countif(success==false) by FlowName\n| extend nSuccess = nRun-toint(nFailed)\n| project FlowName, nRun,nSuccess,nFailed\n| order by toint(nRun) desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Types of cloud flows in use",
    "query": "// Author: aliyoussefi\n// Display name: Display types of triggers used over a span of time\n// Description: Summary of Power Automate triggers by trigger type over timespan.\n// Categories: Power Platform\n// Resource types: Power Automate\n// Topic:  Usage Analytics\n\ndependencies\n| where timestamp {_TimeRange:value}\n| where type == \"Cloud Flow/Cloud flow triggers\"\n| summarize count() by name"
  },
  {
    "source": "AzureMonitor",
    "name": "Backup Items by Vault and Backup item type",
    "query": "// Author: Microsoft Azure\n// Display name: Backup Items by Vault and Backup item type\n// Description: View the different types of items being backed up.\n// Categories: IT \u0026 Management Tools\n// Resource types: Recovery Services vaults\n// Topic: Backup Items\n\nCoreAzureBackup\n//get all backup items\n| where OperationName == \"BackupItem\"\n//remove duplicate records if any\n| summarize arg_max(TimeGenerated, *) by BackupItemUniqueId, ResourceId\n// summarize backup items by type\n| summarize NumberOfItems=count(BackupItemUniqueId) by BackupItemType"
  },
  {
    "source": "AzureMonitor",
    "name": "Backup Items with Protection Status modified",
    "query": "// Author: Microsoft Azure\n// Display name: Backup Items with Protection Status modified\n// Description: Find out if the protection status for any Backup Item has been modified in the selected time range.\n// Categories: IT \u0026 Management Tools,Security\n// Resource types: Recovery Services vaults\n// Topic: Backup Settings Changes\n\n//Get Backup Items and their Protection State at the start of the selected time range.\nlet BackupItemsAtStartOfPeriod = CoreAzureBackup\n| where OperationName == \"BackupItem\" \n| summarize arg_min(TimeGenerated, *) by BackupItemUniqueId \n| project BackupItemUniqueId , OldProtectionState=BackupItemProtectionState;\n\n//Get Backup Items and their Protection State at the end of the selected time range.\nlet BackupItemsAtEndOfPeriod = CoreAzureBackup \n| where OperationName == \"BackupItem\" \n| summarize arg_max(TimeGenerated, *) by BackupItemUniqueId \n| project BackupItemUniqueId , NewProtectionState=BackupItemProtectionState;\n\n//List Backup Items for which Protection State has been modified in the selected time range.\nBackupItemsAtStartOfPeriod \n| join (BackupItemsAtEndOfPeriod) on BackupItemUniqueId \n| where OldProtectionState != NewProtectionState"
  },
  {
    "source": "AzureMonitor",
    "name": "Policies with retention duration modified",
    "query": "// Author: Microsoft Azure\n// Display name: Policies with retention duration modified\n// Description: Find out if the retention duration of any policy has been modified in the selected time range.\n// Categories: IT \u0026 Management Tools,Security\n// Resource types: Recovery Services vaults\n// Topic: Backup Settings Changes\n\n//Get all Policies by Vault and Retention Duration, at the start of the selected time range.\nlet PoliciesAtStartOfPeriod = AddonAzureBackupPolicy\n| where OperationName == \"Policy\" \n|  summarize arg_min(TimeGenerated, *) by PolicyUniqueId,ResourceId \n| project PolicyUniqueId, ResourceId, DailyRetentionDuration1=DailyRetentionDuration, WeeklyRetentionDuration1=WeeklyRetentionDuration, MonthlyRetentionDuration1=MonthlyRetentionDuration, YearlyRetentionDuration1=YearlyRetentionDuration;\n\n//Get all Policies by Vault and Retention Duration, at the end of the selected time range\nlet PoliciesAtEndOfPeriod = AddonAzureBackupPolicy\n| where OperationName == \"Policy\"\n|  summarize arg_max(TimeGenerated, *) by PolicyUniqueId,ResourceId\n| project PolicyUniqueId, ResourceId, DailyRetentionDuration2=DailyRetentionDuration, WeeklyRetentionDuration2=WeeklyRetentionDuration, MonthlyRetentionDuration2=MonthlyRetentionDuration, YearlyRetentionDuration2=YearlyRetentionDuration;\n\n//Get all Policies for which Daily/Weekly/Monthly/Yearly Retention Duration has been modified in the selected time range\nPoliciesAtStartOfPeriod\n| join (PoliciesAtEndOfPeriod) on PolicyUniqueId, ResourceId\n | where DailyRetentionDuration1!=DailyRetentionDuration2 or WeeklyRetentionDuration1!=WeeklyRetentionDuration2 or MonthlyRetentionDuration1!=MonthlyRetentionDuration2 or YearlyRetentionDuration1!=YearlyRetentionDuration2"
  },
  {
    "source": "AzureMonitor",
    "name": "All Failed Jobs",
    "query": "// Author: Microsoft Azure\n// Display name: All Failed Jobs\n// Description: View all failed jobs in the selected time range.\n// Categories: Audit\n// Resource types: Recovery Services vaults\n// Topic: Jobs\n\nAddonAzureBackupJobs\n| summarize arg_max(TimeGenerated,*) by JobUniqueId\n| where JobStatus == \"Failed\""
  },
  {
    "source": "AzureMonitor",
    "name": "All Successful Jobs",
    "query": "// Author: Microsoft Azure\n// Display name: All Successful Jobs\n// Description: View all successful jobs in the selected time range.\n// Categories: Audit\n// Resource types: Recovery Services vaults\n// Topic: Jobs\n\nAddonAzureBackupJobs\n| summarize arg_max(TimeGenerated,*) by JobUniqueId\n| where JobStatus == \"Completed\""
  },
  {
    "source": "AzureMonitor",
    "name": "Distribution of Backup Jobs by Status",
    "query": "// Author: Microsoft Azure\n// Display name: Distribution of Backup Jobs by Status\n// Description: View the number of completed and failed Backup Jobs in the selected time range.\n// Categories: IT \u0026 Management Tools\n// Resource types: Recovery Services vaults\n// Topic: Jobs\n\nAddonAzureBackupJobs\n//Get all Backup Jobs\n| where JobOperation  == \"Backup\"\n//Remove duplicate records if any\n| summarize arg_max(TimeGenerated, *) by JobUniqueId\n//Summarize by Job Status\n| summarize count(JobUniqueId) by JobStatus"
  },
  {
    "source": "AzureMonitor",
    "name": "Distribution of Restore Jobs by Status",
    "query": "// Author: Microsoft Azure\n// Display name: Distribution of Restore Jobs by Status\n// Description: View the number of completed and failed Restore Jobs in the selected time range.\n// Categories: IT \u0026 Management Tools\n// Resource types: Recovery Services vaults\n// Topic: Jobs\n\nAddonAzureBackupJobs\n//Get all Restore Jobs\n| where JobOperation  in~ (\"Restore\",\"Recovery\") \n//Remove duplicate records if any\n| summarize arg_max(TimeGenerated, *) by JobUniqueId\n//Summarize by Job Status\n| summarize count(JobUniqueId) by JobStatus"
  },
  {
    "source": "AzureMonitor",
    "name": "Cloud Storage Consumed per Backup Item",
    "query": "// Author: Microsoft Azure\n// Display name: Cloud Storage Consumed per Backup Item\n// Description: View the total Cloud Storage consumed by each Backup Item.\n// Categories: IT \u0026 Management Tools\n// Resource types: Recovery Services vaults\n// Topic: Usage\n\nCoreAzureBackup\n//Get all Backup Items\n| where OperationName == \"BackupItem\"\n//Get distinct Backup Items\n| distinct BackupItemUniqueId, BackupItemFriendlyName\n| join kind=leftouter(AddonAzureBackupStorage\n| where OperationName == \"StorageAssociation\"\n//Get latest record for each Backup Item\n| summarize arg_max(TimeGenerated, *) by BackupItemUniqueId \n| project BackupItemUniqueId , StorageConsumedInMBs) on BackupItemUniqueId\n| project BackupItemUniqueId , BackupItemFriendlyName , StorageConsumedInMBs \n| sort by StorageConsumedInMBs desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Trend of total Cloud Storage consumed",
    "query": "// Author: Microsoft Azure\n// Display name: Trend of total Cloud Storage consumed\n// Description: View the daily trend of total (cumulative) Cloud Storage consumed.\n// Categories: IT \u0026 Management Tools\n// Resource types: Recovery Services vaults\n// Topic: Usage\n\nAddonAzureBackupStorage\n| where OperationName == \"StorageAssociation\"\n//Get total Cloud Storage being consumed per Backup Item at the end of each day\n| summarize TotalStoragePerBackupItemPerDay=sum(StorageConsumedInMBs) by BackupItemUniqueId, Day=bin(TimeGenerated,1d)\n//Get total Cloud Storage being consumed at the end of each day\n| summarize TotalStorage=sum(TotalStoragePerBackupItemPerDay) by Day\n| sort by Day asc\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Loading Data",
    "query": "// Author: Microsoft Azure\n// Display name: Loading Data\n// Description: Monitor data loading in the last hour.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Diagnostics\n\nAzureMetrics\n| where ResourceProvider == \"MICROSOFT.SQL\"\n| where TimeGenerated \u003e= ago(60min)\n| where MetricName in ('log_write_percent')\n| parse _ResourceId with * \"/microsoft.sql/servers/\" Resource// subtract Resource name for _ResourceId\n| summarize Log_Maximum_last60mins = max(Maximum), Log_Minimum_last60mins = min(Minimum), Log_Average_last60mins = avg(Average) by Resource, MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "Wait stats",
    "query": "// Author: Microsoft Azure\n// Display name: Wait stats\n// Description: Wait stats over the last hour, by Logical Server and Database.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.SQL\"\n| where TimeGenerated \u003e= ago(60min)\n| parse _ResourceId with * \"/microsoft.sql/servers/\" LogicalServerName \"/databases/\" DatabaseName\n| summarize Total_count_60mins = sum(delta_waiting_tasks_count_d) by LogicalServerName, DatabaseName, wait_type_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Avg CPU usage",
    "query": "// Author: Microsoft Azure\n// Display name: Avg CPU usage\n// Description: Avg CPU usage in the last hour by resource name.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Performance\n\n//consistently high averages could indicate a customer needs to move to a larger SKU\nAzureMetrics\n| where ResourceProvider == \"MICROSOFT.SQL\" // /DATABASES\n| where TimeGenerated \u003e= ago(60min)\n| where MetricName in ('cpu_percent') \n| parse _ResourceId with * \"/microsoft.sql/servers/\" Resource  // subtract Resource name for _ResourceId\n| summarize CPU_Maximum_last15mins = max(Maximum), CPU_Minimum_last15mins = min(Minimum), CPU_Average_last15mins = avg(Average) by Resource , MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "Performance troubleshooting",
    "query": "// Author: Microsoft Azure\n// Display name: Performance troubleshooting\n// Description: Potentially query or deadlock on the system that could lead to poor performance.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Performance\n\n//potentially a query or deadlock on the system that could lead to poor performance\nAzureMetrics\n| where ResourceProvider == \"MICROSOFT.SQL\"\n| where TimeGenerated \u003e=ago(60min)\n| where MetricName in ('deadlock')\n| parse _ResourceId with * \"/microsoft.sql/servers/\" Resource // subtract Resource name for _ResourceId\n| summarize Deadlock_max_60Mins = max(Maximum) by Resource, MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "Loading Data",
    "query": "// Author: Microsoft Azure\n// Display name: Loading Data\n// Description: Monitor data loading in the last hour.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Diagnostics\n\nAzureMetrics\n| where ResourceProvider == \"MICROSOFT.SQL\"\n| where TimeGenerated \u003e= ago(60min)\n| where MetricName in ('log_write_percent')\n| parse _ResourceId with * \"/microsoft.sql/servers/\" Resource// subtract Resource name for _ResourceId\n| summarize Log_Maximum_last60mins = max(Maximum), Log_Minimum_last60mins = min(Minimum), Log_Average_last60mins = avg(Average) by Resource, MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "Wait stats",
    "query": "// Author: Microsoft Azure\n// Display name: Wait stats\n// Description: Wait stats over the last hour, by Logical Server and Database.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.SQL\"\n| where TimeGenerated \u003e= ago(60min)\n| parse _ResourceId with * \"/microsoft.sql/servers/\" LogicalServerName \"/databases/\" DatabaseName\n| summarize Total_count_60mins = sum(delta_waiting_tasks_count_d) by LogicalServerName, DatabaseName, wait_type_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Avg CPU usage",
    "query": "// Author: Microsoft Azure\n// Display name: Avg CPU usage\n// Description: Avg CPU usage in the last hour by resource name.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Performance\n\n//consistently high averages could indicate a customer needs to move to a larger SKU\nAzureMetrics\n| where ResourceProvider == \"MICROSOFT.SQL\" // /DATABASES\n| where TimeGenerated \u003e= ago(60min)\n| where MetricName in ('cpu_percent') \n| parse _ResourceId with * \"/microsoft.sql/servers/\" Resource  // subtract Resource name for _ResourceId\n| summarize CPU_Maximum_last15mins = max(Maximum), CPU_Minimum_last15mins = min(Minimum), CPU_Average_last15mins = avg(Average) by Resource , MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "Performance troubleshooting",
    "query": "// Author: Microsoft Azure\n// Display name: Performance troubleshooting\n// Description: Potentially query or deadlock on the system that could lead to poor performance.\n// Categories: Databases\n// Resource types: SQL databases.SQL Servers\n// Topic: Performance\n\n//potentially a query or deadlock on the system that could lead to poor performance\nAzureMetrics\n| where ResourceProvider == \"MICROSOFT.SQL\"\n| where TimeGenerated \u003e=ago(60min)\n| where MetricName in ('deadlock')\n| parse _ResourceId with * \"/microsoft.sql/servers/\" Resource // subtract Resource name for _ResourceId\n| summarize Deadlock_max_60Mins = max(Maximum) by Resource, MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "Display all active intelligent insights",
    "query": "// Author: Microsoft Azure\n// Display name: Display all active intelligent insights\n// Description: Display all active performance issues detected by intelligent insights. Please note that SQLInsights log needs to be enabled for each database monitored.\n// Categories: IT \u0026 Management Tools\n// Resource types: SQL managed instances\n// Topic: Intelligent insights\n\nAzureDiagnostics\n| where Category == \"SQLInsights\" and status_s == \"Active\"\n| distinct rootCauseAnalysis_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Workload continously hitting CPU limits",
    "query": "// Author: Microsoft Azure\n// Display name: Workload continously hitting CPU limits\n// Description: Intelligent insights report detecting the workload behavor as continously hitting CPU limits. Please note that SQLInsights log needs to be enabled for each database monitored.\n// Categories: IT \u0026 Management Tools\n// Resource types: SQL managed instances\n// Topic: Intelligent insights\n\nlet alert_run_interval = 1h;\nlet insights_string = \"hitting its CPU limits\";\nAzureDiagnostics\n| where Category == \"SQLInsights\" and status_s == \"Active\"\n| where TimeGenerated \u003e ago(alert_run_interval)\n| where rootCauseAnalysis_s contains insights_string\n| distinct _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "CPU utilization threshold above 95 on managed instances",
    "query": "// Author: Microsoft Azure\n// Display name: CPU utilization threshold above 95% on managed instances\n// Description: Display all managed instances with CPU threshold being over 95% of treshold.\n// Categories: IT \u0026 Management Tools\n// Resource types: SQL managed instances\n// Topic: Utilization\n\nlet cpu_percentage_threshold = 95;\nlet time_threshold = ago(1h);\nAzureDiagnostics\n| where Category == \"ResourceUsageStats\" and TimeGenerated \u003e time_threshold\n| summarize avg_cpu = max(todouble(avg_cpu_percent_s)) by _ResourceId\n| where avg_cpu \u003e cpu_percentage_threshold"
  },
  {
    "source": "AzureMonitor",
    "name": "Storage on managed instances above 90",
    "query": "// Author: Microsoft Azure\n// Display name: Storage on managed instances above 90%\n// Description: Display all managed instances with storage utilization above 90%.\n// Categories: IT \u0026 Management Tools\n// Resource types: SQL managed instances\n// Topic: Utilization\n\nlet storage_percentage_threshold = 90;\nAzureDiagnostics\n| where Category ==\"ResourceUsageStats\"\n| summarize (TimeGenerated, calculated_storage_percentage) = arg_max(TimeGenerated, todouble(storage_space_used_mb_s) *100 / todouble (reserved_storage_mb_s))\n   by _ResourceId\n| where calculated_storage_percentage \u003e storage_percentage_threshold"
  },
  {
    "source": "AzureMonitor",
    "name": "Keyvault access attempt  key not found",
    "query": "// Author: Microsoft Azure\n// Display name: Keyvault access attempt - key not found\n// Description: Summarizes the access to keyvault when key is not found.\n// Categories: Security\n// Resource types: Service Bus\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.SERVICEBUS\" \n| where Category == \"Error\" and OperationName == \"wrapkey\"\n| project Message, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Management operations in the last 7 days",
    "query": "// Author: Microsoft Azure\n// Display name: Management operations in the last 7 days\n// Description: This lists all the management calls for the last 7 days.\n// Categories: Azure Monitor\n// Resource types: Service Bus\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(7d)\n| where ResourceProvider ==\"MICROSOFT.SERVICEBUS\"\n| where Category == \"OperationalLogs\"\n| summarize count() by EventName_s, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Errors summary",
    "query": "// Author: Microsoft Azure\n// Display name: Errors summary\n// Description: Summarizes all the errors seen in the last 7 days.\n// Categories: Azure Monitor\n// Resource types: Service Bus\n// Topic: Errors\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(7d)\n| where ResourceProvider ==\"MICROSOFT.SERVICEBUS\"\n| where Category == \"Error\" \n| summarize count() by EventName_s, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Keyvault performed operational",
    "query": "// Author: Microsoft Azure\n// Display name: Keyvault performed operational\n// Description: Summarizes the operation performed with keyvault to disable or restore the key.\n// Categories: Security\n// Resource types: Service Bus\n// Topic: Security\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.SERVICEBUS\"\n| where (Category == \"info\" and (OperationName == \"disable\" or OperationName == \"restore\"))\n| project Message, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "AutoDeleted entities",
    "query": "// Author: Microsoft Azure\n// Display name: AutoDeleted entities\n// Description: Summary of all the entities that have been auto-deleted.\n// Categories: Audit\n// Resource types: Service Bus\n// Topic: Usage\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.SERVICEBUS\"\n| where Category == \"OperationalLogs\"\n| where EventName_s startswith \"AutoDelete\"\n| summarize count() by EventName_s, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Frequent operations chart",
    "query": "// Author: Microsoft Azure\n// Display name: Frequent operations chart\n// Description: A pie chart of operations used over the last 3 days.\n// Categories: IT \u0026 Management Tools\n// Resource types: Storage accounts\n// Topic: Audit\n\nStorageBlobLogs\n| where TimeGenerated \u003e ago(3d)\n| summarize count() by OperationName\n| sort by count_ desc \n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Show anonymous requests",
    "query": "// Author: Microsoft Azure\n// Display name: Show anonymous requests\n// Description: List all requests with anonymous access over the last 3 days.\n// Categories: IT \u0026 Management Tools\n// Resource types: Storage accounts\n// Topic: Audit\n\nStorageBlobLogs\n| where TimeGenerated \u003e ago(3d) and AuthenticationType == \"Anonymous\"\n| project TimeGenerated, OperationName, AuthenticationType, Uri"
  },
  {
    "source": "AzureMonitor",
    "name": "Most common errors",
    "query": "// Author: Microsoft Azure\n// Display name: Most common errors\n// Description: List 10 most common errors over the last 3 days.\n// Categories: IT \u0026 Management Tools\n// Resource types: Storage accounts\n// Topic: Errors\n\nStorageBlobLogs\n| where TimeGenerated \u003e ago(3d) and StatusText !contains \"Success\"\n| summarize count() by StatusText\n| top 10 by count_ desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Operations causing most errors",
    "query": "// Author: Microsoft Azure\n// Display name: Operations causing most errors\n// Description: List top 10 operations causing the most errors over the last 3 days.\n// Categories: IT \u0026 Management Tools\n// Resource types: Storage accounts\n// Topic: Errors\n\nStorageBlobLogs\n| where TimeGenerated \u003e ago(3d) and StatusText !contains \"Success\"\n| summarize count() by OperationName\n| top 10 by count_ desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Operations causing server side throttling",
    "query": "// Author: Microsoft Azure\n// Display name: Operations causing server side throttling\n// Description: List all operations causing server side throttling errors over the last 3 days.\n// Categories: IT \u0026 Management Tools\n// Resource types: Storage accounts\n// Topic: Errors\n\nStorageBlobLogs\n| where TimeGenerated \u003e ago(3d) and StatusText contains \"ServerBusy\"\n| project TimeGenerated, OperationName, StatusCode, StatusText"
  },
  {
    "source": "AzureMonitor",
    "name": "Operations with the highest latency",
    "query": "// Author: Microsoft Azure\n// Display name: Operations with the highest latency\n// Description: List top 10 operations with the longest end to end latency over the last 3 days.\n// Categories: IT \u0026 Management Tools\n// Resource types: Storage accounts\n// Topic: Performance\n\nStorageBlobLogs\n| where TimeGenerated \u003e ago(3d)\n| top 10 by DurationMs desc\n| project TimeGenerated, OperationName, DurationMs, ServerLatencyMs, ClientLatencyMs = DurationMs - ServerLatencyMs"
  },
  {
    "source": "AzureMonitor",
    "name": "Events that arrived early",
    "query": "// Author: Microsoft Azure\n// Display name: Events that arrived early\n// Description: Shows errors due to events where difference between Application time and Arrival time is greater than 5 minutes.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Input data Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType == \"EarlyInputEvent\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "Events that arrived late",
    "query": "// Author: Microsoft Azure\n// Display name: Events that arrived late\n// Description: Shows errors due to events where difference between application time and arrival time is greater than the late arrival policy.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Input data Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and  parse_json(properties_s).DataErrorType == \"LateInputEvent\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "Events that arrived out of order",
    "query": "// Author: Microsoft Azure\n// Display name: Events that arrived out of order\n// Description: Shows errors due to events that arrive out of order according to the out-of-order policy.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Input data Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType == \"OutOfOrderEvent\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all InvalidInputTimeStamp errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all InvalidInputTimeStamp errors\n// Description: Shows errors caused due to events where value of the TIMESTAMP BY expression can't be converted to datetime.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Input data Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and  parse_json(properties_s).DataErrorType == \"InvalidInputTimeStamp\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all InvalidInputTimeStampKey errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all InvalidInputTimeStampKey errors\n// Description: Shows errors caused due to events where value of the TIMESTAMP BY OVER timestampColumn is NULL.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Input data Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and  parse_json(properties_s).DataErrorType == \"InvalidInputTimeStampKey\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all input data errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all input data errors\n// Description: Shows all errors that occurred while processing the data from inputs.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Input data Errors\n\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).Type == \"DataError\" \n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all input deserialization errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all input deserialization errors\n// Description: Shows errors caused due to malformed events that could not be deserialized by the job.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Input data Errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType in (\"InputDeserializerError.InvalidData\", \"InputDeserializerError.TypeConversionError\", \"InputDeserializerError.MissingColumns\", \"InputDeserializerError.InvalidHeader\", \"InputDeserializerError.InvalidCompressionType\")\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "All logs with level Error",
    "query": "// Author: Microsoft Azure\n// Display name: All logs with level \"Error\"\n// Description: Shows all logs that are likely to have negatively impacted your job.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Other errors and failures\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and Level == \"Error\" \n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "Operations that have Failed",
    "query": "// Author: Microsoft Azure\n// Display name: Operations that have \"Failed\"\n// Description: Shows all operations on your job that have resulted in a failure.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Other errors and failures\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and status_s == \"Failed\" \n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "Output Throttling logs Cosmos DB Power BI Event Hubs",
    "query": "// Author: Microsoft Azure\n// Display name: Output Throttling logs (Cosmos DB, Power BI, Event Hubs)\n// Description: Shows all instances where writing to one of your outputs was throttled by the destination service.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Other errors and failures\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).Type in (\"DocumentDbOutputAdapterWriteThrottlingError\", \"EventHubOutputAdapterEventHubThrottlingError\", \"PowerBIServiceThrottlingError\", \"PowerBIServiceThrottlingError\")\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of Failed operations in the last 7 days",
    "query": "// Author: Microsoft Azure\n// Display name: Summary of 'Failed' operations in the last 7 days\n// Description: Summary of 'Failed' operations in the last 7 days.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Other errors and failures\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(7d) //last 7 days\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and status_s == \"Failed\" \n| summarize Count=count(), sampleEvent=any(properties_s) by JobName=Resource"
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of all data errors in the last 7 days",
    "query": "// Author: Microsoft Azure\n// Display name: Summary of all data errors in the last 7 days\n// Description: Summary of all data errors in the last 7 days.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Other errors and failures\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(7d) //last 7 days\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).Type == \"DataError\"\n| extend DataErrorType = tostring(parse_json(properties_s).DataErrorType)\n| summarize Count=count(), sampleEvent=any(properties_s)  by DataErrorType, JobName=Resource"
  },
  {
    "source": "AzureMonitor",
    "name": "Summary of all errors in the last 7 days",
    "query": "// Author: Microsoft Azure\n// Display name: Summary of all errors in the last 7 days\n// Description: Summary of all errors in the last 7 days.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Other errors and failures\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(7d) //last 7 days\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\"\n| extend ErrorType = tostring(parse_json(properties_s).Type)\n| summarize Count=count(), sampleEvent=any(properties_s)  by ErrorType, JobName=Resource"
  },
  {
    "source": "AzureMonitor",
    "name": "Transient input and output errors",
    "query": "// Author: Microsoft Azure\n// Display name: Transient input and output errors\n// Description: Shows all errors related to input and output that are intermittent in nature.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Other errors and failures\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).Type in (\"AzureFunctionOutputAdapterTransientError\", \"BlobInputAdapterTransientError\", \"DataLakeOutputAdapterTransientError\", \"DocumentDbOutputAdapterTransientError\", \"EdgeHubOutputAdapterEdgeHubTransientError\", \"EventHubBasedInputInvalidOperationTransientError\", \"EventHubBasedInputOperationCanceledTransientError\", \"EventHubBasedInputTimeoutTransientError\", \"EventHubBasedInputTransientError\", \"EventHubOutputAdapterEventHubTransientError\", \"InputProcessorTransientFailure\", \"OutputProcessorTransientError\", \"ReferenceDataInputAdapterTransientError\", \"ServiceBusOutputAdapterTransientError\", \"TableOutputAdapterTransientError\")\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "All output data errors",
    "query": "// Author: Microsoft Azure\n// Display name: All output data errors\n// Description: Shows all errors that occurred while writing the results of the query to the outputs in your job.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Output data errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType in (\"OutputDataConversionError.RequiredColumnMissing\", \"OutputDataConversionError.ColumnNameInvalid\", \"OutputDataConversionError.TypeConversionError\", \"OutputDataConversionError.RecordExceededSizeLimit\", \"OutputDataConversionError.DuplicateKey\")\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all ColumnNameInvalid errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all ColumnNameInvalid errors\n// Description: Shows errors where the output record produced by your job has a column name that doesn't map to a column in your output.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Output data errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType == \"OutputDataConversionError.ColumnNameInvalid\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all DuplicateKey errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all DuplicateKey errors\n// Description: Shows errors where the output record produced by job contains a column with the same name as a System column.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Output data errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType == \"OutputDataConversionError.DuplicateKey\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all RecordExceededSizeLimit errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all RecordExceededSizeLimit errors\n// Description: Shows errors where the size of the output record produced by your job is greater than the supported output size.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Output data errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and  parse_json(properties_s).DataErrorType == \"OutputDataConversionError.RecordExceededSizeLimit\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all RequiredColumnMissing errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all RequiredColumnMissing errors\n// Description: Shows all errors where the output record produced by your job has a missing column.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Output data errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType == \"OutputDataConversionError.RequiredColumnMissing\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "List all TypeConversionError errors",
    "query": "// Author: Microsoft Azure\n// Display name: List all TypeConversionError errors\n// Description: Shows errors where the output record produced by your job has a column can't be converted to a valid type in the output.\n// Categories: Azure Resources\n// Resource types: Stream Analytics jobs\n// Topic: Output data errors\n\nAzureDiagnostics\n| where ResourceProvider == \"MICROSOFT.STREAMANALYTICS\" and parse_json(properties_s).DataErrorType == \"OutputDataConversionError.TypeConversionError\"\n| project TimeGenerated, Resource, Region_s, OperationName, properties_s, Level"
  },
  {
    "source": "AzureMonitor",
    "name": "Endpoints with monitoring Status down",
    "query": "// Author: Microsoft Azure\n// Display name: Endpoints with monitoring Status down\n// Description: Find the reason why the monitoring status of Azure Traffic Manager endpoints is down.\n// Categories: Network\n// Resource types: Traffic Manager profiles\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where ResourceType == \"TRAFFICMANAGERPROFILES\"  and Category  == \"ProbeHealthStatusEvents\"\n| where Status_s == \"Down\"\n| project TimeGenerated, EndpointName_s, Status_s, ResultDescription, SubscriptionId , _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "BGP route updates",
    "query": "// Author: Microsoft Azure\n// Display name: BGP route updates \n// Description: BGP route updates over the last 24 hours.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(24h)\n| where Category == \"RouteDiagnosticLog\" and OperationName == \"BgpRouteUpdate\""
  },
  {
    "source": "AzureMonitor",
    "name": "Failed P2S connections",
    "query": "// Author: Microsoft Azure\n// Display name: Failed P2S connections \n// Description: Failed P2S connections in the last 12 hours. \n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Diagnostics\n\nAzureDiagnostics \n| where TimeGenerated \u003e ago(12h)\n| where Category == \"P2SDiagnosticLog\" and Message has \"Connection failed\"\n| project TimeGenerated, Resource ,Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Gateway configuration changes",
    "query": "// Author: Microsoft Azure\n// Display name: Gateway configuration changes \n// Description: Successful gateway configuration changes made by administrator during the last 24 hours. \n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Diagnostics\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(24h)\n| where Category == \"GatewayDiagnosticLog\" and operationStatus_s == \"Success\" and configuration_ConnectionTrafficType_s == \"Internet\"\n| project TimeGenerated, Resource, OperationName, Message, operationStatus_s"
  },
  {
    "source": "AzureMonitor",
    "name": "IKE log events",
    "query": "// Author: Daniel Mauser (Microsoft)\n// Display name: IKE logs events\n// Description: IKe log events from the last 30 minutes\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Diagnostics\n\nAzureDiagnostics \n| where Category == \"IKEDiagnosticLog\" \n| where TimeGenerated \u003e ago(30m) \n// 1) Use Time range to look for issues on specific time range. Useful for finding root cause of IPSec connection issues.\n//| where TimeGenerated \u003e= datetime(2020-09-18 15:43) and TimeGenerated \u003c= datetime(2020-09-18 15:45) // Set a time range.\n| where Message contains \"SESSION_ID\"\n| extend SessionID = extract(\"{(.*)}\", 1, Message), RemoteIP = extract(\"Remote (.*?):\", 1, Message), LocalIP = extract(\"Local (.*?):\", 1, Message), IKEMessage = extract(\"Local .*00: (.*)\", 1, Message), GWIN = extract(\"\\\\d\",0,instance_s)\n//| parse Message with \"SESSION_ID :{\" SESSION_ID \"} Remote \" Remote \":\" RemotePort \": Local \" Local \":\" LocalPort \": [\" Direction \"]\" Message\n// 2) Narrow down to dump IKE events only for remote by specify remote VPN IP. It is useful for scenarios when VPN is connected has multiple S2S VPN Connections.\n//| where RemoteIP == \"104.215.122.58\"\n// 3) This is useful to filter on Active-Active Azure VPN GW Scenarios and Azure Virtual WAN\n// | where GWIN == \"0\" // Filters Gateway Instance (GW_IN) 0 just change from 0 to 1 to filter second VPN Gateway instance\n// 4) Narrow down to specific session ID\n//| where SessionID == \"F71C1B4E-17C2-4028-961B-AA1BED2E6C4D\" \n| project TimeGenerated, GWIN, SessionID, RemoteIP, LocalIP, IKEMessage\n| sort by TimeGenerated asc    // Change to \"desc\" to invert most recent event first"
  },
  {
    "source": "AzureMonitor",
    "name": "S2S tunnel connect and disconnect events",
    "query": "// Author: Microsoft Azure\n// Display name: S2S tunnel connect/disconnect events  \n// Description: S2S tunnel connect/disconnect events during the last 24 hours.  \n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Diagnostics\nAzureDiagnostics \n| where TimeGenerated \u003e ago(24h)\n| where Category == \"TunnelDiagnosticLog\" and (status_s == \"Connected\" or status_s == \"Disconnected\")\n| project TimeGenerated, Resource , status_s, remoteIP_s, stateChangeReason_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Successful P2S connections",
    "query": "// Author: Microsoft Azure\n// Display name: Successful P2S connections \n// Description: Successful P2S connections in the last 12 hours.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Diagnostics\n\nAzureDiagnostics \n| where TimeGenerated \u003e ago(12h)\n| where Category == \"P2SDiagnosticLog\" and Message has \"Connection successful\"\n| project TimeGenerated, Resource ,Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Gateway throughput",
    "query": "// Author: Microsoft Azure\n// Display name: Gateway throughput \n// Description: Aggregate gateway throughput in Bytes/sec. \n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Performance\nAzureMetrics \n| where TimeGenerated \u003e ago(24h)\n| where MetricName == \"AverageBandwidth\"\n| summarize by Average, bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "P2S bandwidth utilization",
    "query": "// Author: Microsoft Azure\n// Display name: P2S bandwidth utilization\n// Description: Average P2S bandwidth utilization during the last 12 hours in bits/second. \n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Performance\n\nAzureMetrics\n| where TimeGenerated \u003e ago(24h)\n| where MetricName == \"P2SBandwidth\" \n| summarize by Average, bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "P2S connection count",
    "query": "// Author: Microsoft Azure\n// Display name: P2S connection count \n// Description: Active P2S connection count for the last 30 days.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: Performance\n\nAzureMetrics \n| where TimeGenerated \u003e ago(30d)\n| where MetricName == \"P2SConnectionCount\"\n| summarize by Maximum, bin(TimeGenerated,1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "BGP route updates",
    "query": "// Author: Microsoft Azure\n// Display name: BGP route updates\n// Description: BGP route updates over the last 24 hours.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(24h)\n| where Category == \"RouteDiagnosticLog\" and OperationName == \"BgpRouteUpdate\""
  },
  {
    "source": "AzureMonitor",
    "name": "Failed P2S connections",
    "query": "// Author: Microsoft Azure\n// Display name: Failed P2S connections\n// Description: Failed P2S connections in the last 12 hours.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureDiagnostics \n| where TimeGenerated \u003e ago(12h)\n| where Category == \"P2SDiagnosticLog\" and Message has \"Connection failed\"\n| project TimeGenerated, Resource ,Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Gateway configuration changes",
    "query": "// Author: Microsoft Azure\n// Display name: Gateway configuration changes\n// Description: Successful gateway configuration changes made by administrator during the last 24 hours.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureDiagnostics\n| where TimeGenerated \u003e ago(24h)\n| where Category == \"GatewayDiagnosticLog\" and operationStatus_s == \"Success\" and configuration_ConnectionTrafficType_s == \"Internet\"\n| project TimeGenerated, Resource, OperationName, Message, operationStatus_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Gateway throughput",
    "query": "// Author: Microsoft Azure\n// Display name: Gateway throughput\n// Description: Aggregate gateway throughput in Bytes/sec.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureMetrics \n| where TimeGenerated \u003e ago(24h)\n| where MetricName == \"AverageBandwidth\"\n| summarize by Average, bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "P2S bandwidth utilization",
    "query": "// Author: Microsoft Azure\n// Display name: P2S bandwidth utilization\n// Description: Average P2S bandwidth utilization during the last 12 hours in bits/second.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureMetrics\n| where TimeGenerated \u003e ago(24h)\n| where MetricName == \"P2SBandwidth\" \n| summarize by Average, bin(TimeGenerated, 1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "P2S connection count",
    "query": "// Author: Microsoft Azure\n// Display name: P2S connection count\n// Description: Active P2S connection count for the last 30 days.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureMetrics \n| where TimeGenerated \u003e ago(30d)\n| where MetricName == \"P2SConnectionCount\"\n| summarize by Maximum, bin(TimeGenerated,1h), Resource\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "S2S tunnel connetdisconnect events",
    "query": "// Author: Microsoft Azure\n// Display name: S2S tunnel connet/disconnect events\n// Description: S2S tunnel connet/disconnect events during the last 24 hours.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureDiagnostics \n| where TimeGenerated \u003e ago(24h)\n| where Category == \"TunnelDiagnosticLog\" and (status_s == \"Connected\" or status_s == \"Disconnected\")\n| project TimeGenerated, Resource , status_s, remoteIP_s, stateChangeReason_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Successful P2S connections",
    "query": "// Author: Microsoft Azure\n// Display name: Successful P2S connections\n// Description: Successful P2S connections in the last 12 hours.\n// Categories: Network\n// Resource types: Virtual Network Gateways\n// Topic: VPN Gateway\n\nAzureDiagnostics \n| where TimeGenerated \u003e ago(12h)\n| where Category == \"P2SDiagnosticLog\" and Message has \"Connection successful\"\n| project TimeGenerated, Resource ,Message"
  },
  {
    "source": "AzureMonitor",
    "name": "Track VM Availability using Heartbeat",
    "query": "// Author: Microsoft Azure\n// Display name: Track VM Availability using Heartbeat\n// Description: Display the VM's reported availability during the last hour.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Availability\n\nInsightsMetrics\n| where TimeGenerated \u003e ago(1h)\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"Computer\"\n| where Name == \"Heartbeat\"\n| summarize heartbeat_count = count() by bin(TimeGenerated, 5m), Computer\n| extend alive=iff(heartbeat_count \u003e 2, 1.0, 0.0) //computer considered \"down\" if it has 2 or fewer heartbeats in 5 min interval\n| project TimeGenerated, alive, Computer\n| render timechart with (ymin = 0, ymax = 1)"
  },
  {
    "source": "AzureMonitor",
    "name": "Bottom 10 Free disk space ",
    "query": "// Author: Microsoft Azure\n// Display name: Bottom 10 Free disk space %\n// Description: Bottom 10 Free disk space % by computer.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Performance\n\nInsightsMetrics\n| where TimeGenerated \u003e ago(24h)\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"LogicalDisk\" and Name == \"FreeSpacePercentage\"\n| summarize P90 = percentile(Val, 90) by Computer\n| top 10 by P90 asc"
  },
  {
    "source": "AzureMonitor",
    "name": "Chart CPU usage trends by computer",
    "query": "// Author: Microsoft Azure\n// Display name: Chart CPU usage trends by computer\n// Description: Calculate CPU usage patterns over the last hour, chart by percentiles.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Performance\n\nInsightsMetrics\n| where TimeGenerated \u003e ago(1h)\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"Processor\"\n| where Name == \"UtilizationPercentage\"\n| summarize avg(Val) by bin(TimeGenerated, 5m), Computer //split up by computer\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Logical disk space  below threshold",
    "query": "// Author: Microsoft Azure\n// Display name: Logical disk space % below threshold\n// Description: Logical disk space % below threshold.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Performance\n\nlet _minValue = 10; // Set the minValue according to your needs\nInsightsMetrics\n| where TimeGenerated \u003e= ago(1h) // choose time to observe \n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"LogicalDisk\" and Name == \"FreeSpacePercentage\"\n| where Val \u003c= _minValue\n| extend t=parse_json(Tags)\n| summarize avg(Val) by bin(TimeGenerated, 10m), Computer, tostring(t[\"vm.azm.ms/mountId\"])\n| sort by avg_Val asc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Virtual Machines by CPU utilization",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Virtual Machines by CPU utilization\n// Description: Top 10 Virtual Machines by CPU utilization.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Performance\n\nInsightsMetrics\n| where TimeGenerated \u003e ago(1h)\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"Processor\" and Name == \"UtilizationPercentage\"\n| summarize P90 = percentile(Val, 90) by Computer\n| top 10 by P90"
  },
  {
    "source": "AzureMonitor",
    "name": "Virtual Machine available memory",
    "query": "// Author: Microsoft Azure\n// Display name: Virtual Machine available memory\n// Description: Virtual Machine available memory.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Performance\n\nInsightsMetrics\n| where TimeGenerated \u003e ago(1h)\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"Memory\"\n| where Name == \"AvailableMB\"\n| summarize avg(Val) by bin(TimeGenerated, 5m), Computer\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Virtual Machine free disk space",
    "query": "// Author: Microsoft Azure\n// Display name: Virtual Machine free disk space\n// Description: Show the latest report of free disk space, per instance.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Performance\n\nInsightsMetrics\n| where TimeGenerated \u003e ago(1h)\n| where Origin == \"vm.azm.ms\"\n| where Namespace == \"LogicalDisk\"\n| where Name == \"FreeSpaceMB\"\n| extend t=parse_json(Tags)\n| summarize arg_max(TimeGenerated, *) by tostring(t[\"vm.azm.ms/mountId\"]), Computer // arg_max over TimeGenerated returns the latest record\n| project Computer, TimeGenerated, t[\"vm.azm.ms/mountId\"], Val"
  },
  {
    "source": "AzureMonitor",
    "name": "What data is being collected",
    "query": "// Author: Microsoft Azure\n// Display name: What data is being collected?\n// Description: List the collected performance counters and object types.\n// Categories: Virtual Machines\n// Resource types: Virtual machine scale sets\n// Topic: Performance\n\nInsightsMetrics\n| where Origin == \"vm.azm.ms\"\n| summarize by Namespace, Name"
  },
  {
    "source": "AzureMonitor",
    "name": "Check running process by name",
    "query": "// Author: Rafael Canto @ KXP Consulting\n// Display name: Check running process by name\n// Description: Query process by name (can be used to verify if it's running). Example using mysqld can be used to monitor the service.\n// Categories: virtual machines,resources\n// Resource types: Virtual Machines\n// Topic: Alert\n\nVMProcess \n| where TimeGenerated \u003e ago(1h) and DisplayName == \"mysqld\""
  },
  {
    "source": "AzureMonitor",
    "name": "Not reporting VMs",
    "query": "// Author: Microsoft Azure\n// Display name: Not reporting VMs\n// Description: VMs that have not reported a heartbeat in the last 5 minutes.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Availability\n\nHeartbeat \n| where TimeGenerated \u003e ago(24h)\n| summarize LastCall = max(TimeGenerated) by Computer, _ResourceId\n| where LastCall \u003c ago(5m)"
  },
  {
    "source": "AzureMonitor",
    "name": "Shut down Virtual Machines",
    "query": "// Author: Microsoft Azure\n// Display name: Shut down Virtual Machines\n// Description: Virtual Machines successfully shut down in the last 10 minutes.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Availability\n\nAzureActivity\n| where TimeGenerated \u003e ago(10m)\n| where OperationName == \"Deallocate Virtual Machine\" and ActivityStatus == \"Succeeded\""
  },
  {
    "source": "AzureMonitor",
    "name": "Track VM availability",
    "query": "// Author: Microsoft Azure\n// Display name: Track VM availability\n// Description: Display the VM's reported availability during the last day.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Availability\n\nHeartbeat\n| where TimeGenerated \u003e ago(1d)\n| summarize heartbeat_count = count() by bin(TimeGenerated, 30m), Computer, _ResourceId // bin is used to set the time grain to 30 minutes\n| extend alive=iff(heartbeat_count \u003e 0, true, false)\n| sort by TimeGenerated asc // sort the results by time (ascending order)"
  },
  {
    "source": "AzureMonitor",
    "name": "Automatic update configuration is disabled",
    "query": "// Author: Microsoft Azure\n// Display name: Automatic update configuration is disabled\n// Description: Computers with automatic update disabled.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdateSummary\n| where WindowsUpdateSetting == \"Manual\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Automatic update configuration",
    "query": "// Author: Microsoft Azure\n// Display name: Automatic update configuration\n// Description: Automatic update configuration.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdateSummary\n| summarize AggregatedValue = count() by WindowsUpdateSetting, Computer, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Computer with missing updates",
    "query": "// Author: Microsoft Azure\n// Display name: Computer with missing updates\n// Description: All computers with missing updates.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdate\n|where OSType != \"Linux\" and UpdateState == \"Needed\" and Optional == \"false\" \n| project TimeGenerated, Computer, Title, KBID, Classification, MSRCSeverity, PublishedDate, _ResourceId\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Distinct missing updates cross computers",
    "query": "// Author: Microsoft Azure\n// Display name: Distinct missing updates cross computers\n// Description: Distinct missing updates across all computers.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdate\n| where OSType != \"Linux\" and UpdateState == \"Needed\" and Optional == \"false\" \n| distinct Title, Computer, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Find Linux kernel events",
    "query": "// Author: Microsoft Azure\n// Display name: Find Linux kernel events\n// Description: Find events reported by Linux kernel process, regarding killed processes.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Diagnostics\n\nSyslog\n| where ProcessName == \"kernel\" and SyslogMessage contains \"Killed process\""
  },
  {
    "source": "AzureMonitor",
    "name": "Malware detection",
    "query": "// Author: Microsoft Azure\n// Display name: Malware detection\n// Description: Malware detected grouped by threat.\n// Categories: Security\n// Resource types: Virtual machines\n// Solutions: AntiMalware\n// Topic: Diagnostics\n\nProtectionStatus\n| where ThreatStatus != \"No threats detected\" \n| summarize AggregatedValue = count() by Threat, Computer, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing critical security updates",
    "query": "// Author: Microsoft Azure\n// Display name: Missing critical security updates\n// Description: All computers that are missing critical updates or security updates.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdate\n|where  OSType != \"Linux\" and UpdateState == \"Needed\" and Optional == \"false\" and (Classification == \"Security Updates\" or Classification == \"Critical Updates\") \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing required updates for server",
    "query": "// Author: Microsoft Azure\n// Display name: Missing required updates for server\n// Description: Missing updates for a specific computer \"ComputerName\" (replace with your own computer name).\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nlet ComputerName = \"Enter your computer name here\";\nUpdate\n|where OSType != \"Linux\" and UpdateState == \"Needed\" and Optional == \"false\" and Computer == ComputerName\n| project TimeGenerated, Computer, Title, KBID, Product, MSRCSeverity, PublishedDate, _ResourceId\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing security or critical where update is manual",
    "query": "// Author: Microsoft Azure\n// Display name: Missing security or critical where update is manual\n// Description: Critical or security updates needed by machines where updates are manually applied.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdate\n| where OSType != \"Linux\" and UpdateState == \"Needed\" and Optional == \"false\"\n |where (Classification == \"Security Updates\" or Classification == \"Critical Updates\")\n| join kind=inner (UpdateSummary |where WindowsUpdateSetting == \"Manual\" |distinct Computer) on Computer \n| distinct KBID, Computer, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing update rollups",
    "query": "// Author: Microsoft Azure\n// Display name: Missing update rollups\n// Description: All computers with missing update rollups.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdate\n| where OSType != \"Linux\" and Optional == \"false\" and Classification == \"Update Rollups\" and UpdateState == \"Needed\" \n| project TimeGenerated, Computer, Title, KBID, Classification, MSRCSeverity, PublishedDate, _ResourceId\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing update specific product",
    "query": "// Author: Microsoft Azure\n// Display name: Missing update specific product\n// Description: WSUS computer membership.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Diagnostics\n\nUpdateSummary\n| summarize AggregatedValue = count() by WSUSServer, Computer, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "Protection Status updates",
    "query": "// Author: Microsoft Azure\n// Display name: Protection Status updates\n// Description: Protection Status updates per day.\n// Categories: Security\n// Resource types: Virtual machines\n// Solutions: AntiMalware\n// Topic: Diagnostics\n\nProtectionStatus\n| summarize AggregatedValue = count(ScanDate) by bin(TimeGenerated, 1d), Computer, _ResourceId\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Search in multiple tables",
    "query": "// Author: Microsoft Azure\n// Display name: Search in multiple tables\n// Description: Search both Syslog and Event tables for the term \"login\".\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Diagnostics\n\nsearch in (Syslog, Event) \"login\"\n| where TimeGenerated \u003e ago(1h) // return records from the last hour"
  },
  {
    "source": "AzureMonitor",
    "name": "Show the trend of a selected event",
    "query": "// Author: Microsoft Azure\n// Display name: Show the trend of a selected event\n// Description: Chart how many times an event was reported along the last day.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Diagnostics\n\nEvent\n| where EventID == 44 // this ID indicates Windows Update started downloading an update\n| summarize count() by bin(TimeGenerated, 1h), Computer, _ResourceId // bin is used to set the time grain to 1 hour\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Signatures out of date",
    "query": "// Author: Microsoft Azure\n// Display name: Signatures out of date\n// Description: Devices with Signatures out of date.\n// Categories: Security\n// Resource types: Virtual machines\n// Solutions: AntiMalware\n// Topic: Diagnostics\n\nProtectionStatus\n| summarize Rank = max(ProtectionStatusRank) by Computer, _ResourceId\n| where Rank == \"250\""
  },
  {
    "source": "AzureMonitor",
    "name": "Stopped Windows services",
    "query": "// Author: Microsoft Azure\n// Display name: Stopped Windows services\n// Description: Find all windows services that stopped in the last 30 minutes.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Diagnostics\n\nConfigurationChange  // (relies on the Change Tracking solution): \n| where ConfigChangeType == \"WindowsServices\" and SvcChangeType == \"State\"\n| where SvcPreviousState == \"Running\" and SvcState == \"Stopped\"\n| where SvcStartupType == \"Auto\" and TimeGenerated \u003e ago(30m)"
  },
  {
    "source": "AzureMonitor",
    "name": "Using wildcards",
    "query": "// Author: Microsoft Azure\n// Display name: Using wild-cards\n// Description: Search for terms that follow the pattern \"corp*.com\".\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Diagnostics\n\nsearch in (Event) \"corp*.com\" // Search terms that follow the pattern \"corp\"-something-\".com\", such as \"corp.mydomain.com\"\n| take 50 // return only 50 results (not guaranteed to be the latest)"
  },
  {
    "source": "AzureMonitor",
    "name": "Error event on computer missing security co critical update",
    "query": "// Author: Microsoft Azure\n// Display name: Error event on computer missing security co critical update\n// Description: Error events for machines that are missing critical or security required updates.\n// Categories: IT \u0026 Management Tools\n// Resource types: Virtual machines\n// Solutions: Updates\n// Topic: Errors\n\nEvent\n| where EventLevelName == \"error\"\n    | join kind=inner (Update |where (Classification == \"Security Updates\" or Classification == \"Critical Updates\") and UpdateState == \"Needed\" and Optional == \"false\" | distinct Computer) on Computer \n    | sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Reported errors",
    "query": "// Author: Microsoft Azure\n// Display name: Reported errors\n// Description: Show error events from the last hour.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Errors\n\nunion Event, Syslog // Event table stores Windows event records, Syslog stores Linux records\n| where TimeGenerated \u003e ago(1h)\n| where EventLevelName == \"Error\" // EventLevelName is used in the Event (Windows) records\nor SeverityLevel== \"err\" // SeverityLevel is used in Syslog (Linux) records"
  },
  {
    "source": "AzureMonitor",
    "name": "Bottom 10 Free disk space ",
    "query": "// Author: Microsoft Azure\n// Display name: Bottom 10 Free disk space %\n// Description: Bottom 10 Free disk space % by computer, for the last 7 days.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Performance\n\nPerf\n| where TimeGenerated \u003e ago(7d)\n| where (ObjectName == \"Logical Disk\" or ObjectName == \"LogicalDisk\") and CounterName contains \"%\" and InstanceName != \"_Total\" and InstanceName != \"HarddiskVolume1\"\n| project TimeGenerated, Computer, ObjectName, CounterName, InstanceName, CounterValue \n| summarize arg_max(TimeGenerated, *) by Computer\n| top 10 by CounterValue desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Chart CPU usage trends",
    "query": "// Author: Microsoft Azure\n// Display name: Chart CPU usage trends\n// Description: Calculate CPU usage patterns over the last day, chart by percentiles.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Performance\n\nPerf\n| where CounterName == \"% Processor Time\"\n| where ObjectName == \"Processor\"\n| summarize avg(CounterValue) by bin(TimeGenerated, 15min), Computer, _ResourceId // bin is used to set the time grain to 15 minutes\n| render timechart\n// Perf table stores performance counters for Windows and Linux computers\n// Counters are specified using ObjectName (performance object), InstanceName and CounterName\n// % Processor Time captures CPU activity, ObjectNames can be Processor, Process and Process Information"
  },
  {
    "source": "AzureMonitor",
    "name": "Logical disk space  below threshold",
    "query": "// Author: Microsoft Azure\n// Display name: Logical disk space % below threshold:\n// Description: Show avg % of free Logical disk space over 10 minutes.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Performance\n\nlet _minValue = 10; // Set the minValue according to your needs\nPerf\n| where ObjectName == \"LogicalDisk\" and CounterName == \"% Free Space\" // the object name used in Windows records\n| where TimeGenerated \u003e= ago(30m) // choose time to observe \n| where CounterValue \u003c= _minValue\n| summarize avg(CounterValue) by bin(TimeGenerated, 10m), Computer, InstanceName"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Virtual Machines by CPU utilization",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Virtual Machines by CPU utilization\n// Description: Find top 10 VM by CPU utilization in the last 7 days.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Performance\n\nPerf\n| where TimeGenerated \u003e ago(7d)\n| where CounterName == \"% Processor Time\" and InstanceName == \"_Total\" \n| project TimeGenerated, Computer, ObjectName, CounterName, InstanceName, round(CounterValue, 2)\n| summarize arg_max(TimeGenerated, *) by Computer\n| top 10 by CounterValue"
  },
  {
    "source": "AzureMonitor",
    "name": "Virtual Machine available memory",
    "query": "// Author: Microsoft Azure\n// Display name: Virtual Machine available memory\n// Description: Chart the VM's available memory over time.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Performance\n\nPerf\n| where ObjectName == \"Memory\" and\n(CounterName == \"Available MBytes Memory\" or // the name used in Linux records\nCounterName == \"Available MBytes\") // the name used in Windows records\n|  summarize avg(CounterValue) by bin(TimeGenerated, 15min), Computer, _ResourceId // bin is used to set the time grain to 15 minutes\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Virtual Machine free disk space",
    "query": "// Author: Microsoft Azure\n// Display name: Virtual Machine free disk space\n// Description: Show the latest report of free disk space, per instance.\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Performance\n\nPerf\n| where ObjectName == \"LogicalDisk\" or // the object name used in Windows records\nObjectName == \"Logical Disk\" // the object name used in Linux records\n| where CounterName == \"Free Megabytes\"\n| summarize arg_max(TimeGenerated, *) by InstanceName // arg_max over TimeGenerated returns the latest record\n| project TimeGenerated, InstanceName, CounterValue, Computer, _ResourceId"
  },
  {
    "source": "AzureMonitor",
    "name": "What data is being collected",
    "query": "// Author: Microsoft Azure\n// Display name: What data is being collected?\n// Description: List the collected performance counters and object types (Process, Memory, Processorâ€¦)\n// Categories: Virtual Machines\n// Resource types: Virtual machines\n// Topic: Performance\n\nPerf\n| summarize by ObjectName, CounterName"
  },
  {
    "source": "AzureMonitor",
    "name": "Linux failed logins",
    "query": "// Author: Microsoft Azure\n// Display name: Linux failed logins\n// Description: Find reports of Linux accounts that failed to login.\n// Categories: Virtual Machines,Security\n// Resource types: Virtual machines\n// Topic: Security\n\nLinuxAuditLog\n| where RecordType == 'user_login' and res != 'success'\n| summarize count() by acct // count the reported security events for each account\n// This query requires the Security solution"
  },
  {
    "source": "AzureMonitor",
    "name": "Members added to security groups",
    "query": "// Author: Microsoft Azure\n// Display name: Members added to security groups\n// Description: Who was added to security-enabled group over the last day?\n// Categories: Virtual Machines,Security\n// Resource types: Virtual machines\n// Topic: Security\n\nSecurityEvent\n| where EventID in (4728, 4732, 4756) // these event IDs indicate a member was added to a security-enabled group\n| summarize count() by SubjectAccount, Computer, _ResourceId\n// This query requires the Security solution"
  },
  {
    "source": "AzureMonitor",
    "name": "Missing security or critical updates",
    "query": "// Author: Microsoft Azure\n// Display name: Missing security or critical updates\n// Description: Count how many security or other critical updates are missing.\n// Categories: Virtual Machines,Security\n// Resource types: Virtual machines\n// Topic: Security\n\nUpdate\n| where Classification in (\"Security Updates\", \"Critical Updates\")\n| where UpdateState == 'Needed' and Optional == false and Approved == true\n| summarize count() by Classification, Computer, _ResourceId\n// This query requires the Security or Update solutions"
  },
  {
    "source": "AzureMonitor",
    "name": "Uses of clear text password",
    "query": "// Author: Microsoft Azure\n// Display name: Uses of clear text password\n// Description: List all accounts that logged on using a clear-text password over the last day.\n// Categories: Virtual Machines,Security\n// Resource types: Virtual machines\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4624 // event ID 4624: \"an account was successfully logged on\",\n| where LogonType == 8 // logon type 8: \"NetworkCleartext\"\n| summarize count() by TargetAccount, Computer, _ResourceId // count the reported security events for each account\n// This query requires the Security solution"
  },
  {
    "source": "AzureMonitor",
    "name": "Windows failed logins",
    "query": "// Author: Microsoft Azure\n// Display name: Windows failed logins\n// Description: Find reports of Windows accounts that failed to login.\n// Categories: Virtual Machines,Security\n// Resource types: Virtual machines\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4625\n| summarize count() by TargetAccount, Computer, _ResourceId // count the reported security events for each account\n// This query requires the Security solution"
  },
  {
    "source": "AzureMonitor",
    "name": "Connection Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Connection Errors\n// Description: List of errors by CorrelationId for connections established in the last 24 hours. (Advanced query).\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// This query correlates WVDConnections, WVDErrors and WVDCheckpoints and exposes detailed information across all users. \n// Recommendation is to add a WHERE clause and filter down for a specific user which you are troubleshooting an issue for. \n// | where UserName == \"ReplaceUserName\" \nWVDConnections \n| where TimeGenerated \u003e ago (24h) \n| project-away TenantId,SourceSystem  \n| summarize arg_max(TimeGenerated, *), StartTime =  min(iff(State== 'Started', TimeGenerated , datetime(null) )), ConnectTime = min(iff(State== 'Connected', TimeGenerated , datetime(null) ))   by CorrelationId  \n| join kind=leftouter (WVDErrors\n    |summarize Errors=makelist(pack('Code', Code, 'CodeSymbolic', CodeSymbolic, 'Time', TimeGenerated, 'Message', Message ,'ServiceError', ServiceError, 'Source', Source)) by CorrelationId  \n    ) on CorrelationId\n| join kind=leftouter (WVDCheckpoints\n    | summarize Checkpoints=makelist(pack('Time', TimeGenerated, 'Name', Name, 'Parameters', Parameters, 'Source', Source)) by CorrelationId  \n    | mv-apply Checkpoints on (  \n        order by todatetime(Checkpoints['Time']) asc\n        | summarize Checkpoints=makelist(Checkpoints)\n        )\n    ) on CorrelationId  \n| project-away CorrelationId1, CorrelationId2  \n| order by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Connection Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Connection Errors\n// Description: Bar Chart of top 10 none service-related connection errors by user count in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// Query top 10 connection errors by number of users experiencing a specific error. \n// Alternatively replace \"UserName\" in the query by \"CorrelationID\" to see how often the error has occurred. \n// The \"CorrelationId\" is unique for each connection attempt. \n// The flag on \"ServiceError\" helps to focus on issues that are more likely mitigated by administrative tasks. \n// Change the ActivityType based on the issues you are troubleshooting. \nWVDErrors \n| where TimeGenerated \u003e ago(24h) \n| where ServiceError == \"false\" \n| where ActivityType == \"Connection\"  \n| summarize UserCount = count(UserName) by CodeSymbolic \n| sort by UserCount desc \n| top 10 by UserCount \n| render barchart  \n// Go to https://aka.ms/wvdgetstarted and review additional guidance for diagnostics in the How To section.\n// Our troubleshooting guidance has information on escalation paths."
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Feed  Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Feed  Errors\n// Description: Bar Chart of top 10 none service-related feed errors by user count in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// Query top 10 feed errors by number of users experiencing a specific error when subscribing to list of applications.\n// Alternatively replace \"UserName\" in the query by \"CorrelationID\" to see how often the error has occurred.\n// The \"CorrelationId\" is unique for each connection attempt. \n// The flag on ServiceError helps to focus on issues that are more likely mitigated by administrative tasks. \n// Change the ActivityType based on the issues you are troubleshooting. \nWVDErrors\n| where TimeGenerated \u003e ago(24h)\n| where ServiceError == \"false\" \n| where ActivityType == \"Feed\"  \n| summarize UserCount = count(UserName) by CodeSymbolic \n| sort by UserCount desc \n| top 10 by UserCount \n| render barchart  \n// Go to https://aka.ms/wvdgetstarted and review additional guidance for diagnostics in the How To section.\n// Our troubleshooting guidance has information on escalation paths."
  },
  {
    "source": "AzureMonitor",
    "name": "Published applications used",
    "query": "// Author: Microsoft Azure\n// Display name: Published applications used\n// Description: Bar chart of remote applications users have executed from the remote desktop client.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Usage\n\n// The checkpoints table keeps track of any application or desktop a user has started from the remote desktop client UI. \n// Note: The Windows Virtual Desktop service doesn't have information of started applications for a published desktop in the remote session. \nWVDCheckpoints  \n| where TimeGenerated \u003e ago(7d) \n| where Name == \"LaunchExecutable\" \n| extend App = parse_json(Parameters).filename \n| summarize Usage = count(UserName) by tostring(App) \n| sort by Usage desc \n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Eventlog Parsing",
    "query": "// Author: Billy York www.cloudsma.com\n// Display name: FSLogix Profile Event Log\n// Description: parsing the FSLogix Event Log\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - FSLogix\n// Topic: Event log\nEvent\n| where Source == 'FSLogix-Apps'\n| where EventID == 25\n| parse RenderedDescription with * \"Username: \" UserName:string \" \"*"
  },
  {
    "source": "AzureMonitor",
    "name": "Profile Load Time by SessionHost",
    "query": "// Author: Billy York www.cloudsma.com\n// Display name: Min, Max, Average WVD Profile Load time\n// Description: Average profile load time by session host.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - FSLogix\n// Topic: Performance\nSecurityEvent\n| where EventID == 4624\n| where AccountType == \"User\"\n| where LogonType == 3\n| project UserName = TargetAccount, Computer, LogonTime=TimeGenerated, TimeCollected\n| extend UserName = replace(@\"CORP.DOMAIN.COM\\\\\", @\"\", UserName)\n| extend UserName = replace(@\"CORP\\\\\", @\"\", UserName)\n| join(Event\n| where Source == 'FSLogix-Apps'\n| where EventID == 25\n| parse RenderedDescription with * \"Username: \" UserName:string \" \"*\n| project UserName, Computer, LoadTime=TimeGenerated) on UserName, Computer\n| extend ProfileLoad = datetime_diff('second',LoadTime,LogonTime)\n| where ProfileLoad \u003e 0\n| where ProfileLoad \u003c 1800\n| summarize avg(ProfileLoad), min(ProfileLoad), max(ProfileLoad) by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Profile Load Time by User",
    "query": "// Author: Billy York www.cloudsma.com\n// Display name: Min, Max, Average WVD Profile Load time\n// Description: Average profile load time by user.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - FSLogix\n// Topic: Performance\nSecurityEvent\n| where EventID == 4624\n| where AccountType == \"User\"\n| where LogonType == 3\n| project UserName = TargetAccount, Computer, LogonTime=TimeGenerated, TimeCollected\n| extend UserName = replace(@\"CORP.DOMAIN.COM\\\\\", @\"\", UserName)\n| extend UserName = replace(@\"CORP\\\\\", @\"\", UserName)\n| join(Event\n| where Source == 'FSLogix-Apps'\n| where EventID == 25\n| parse RenderedDescription with * \"Username: \" UserName:string \" \"*\n| project UserName, Computer, LoadTime=TimeGenerated) on UserName, Computer\n| extend ProfileLoad = datetime_diff('second',LoadTime,LogonTime)\n| where ProfileLoad \u003e 0\n| where ProfileLoad \u003c 1800\n| summarize avg(ProfileLoad), min(ProfileLoad), max(ProfileLoad) by UserName"
  },
  {
    "source": "AzureMonitor",
    "name": "Profile Load Time on specific hostpool",
    "query": "// Author: Billy York www.cloudsma.com\n// Display name: Min, Max, Average WVD Profile Load time\n// Description: Average profile load time a specific Hostpool.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - FSLogix\n// Topic: Performance\nSecurityEvent\n| where EventID == 4624\n| where AccountType == \"User\"\n| where LogonType == 3\n| project UserName = TargetAccount, Computer, LogonTime=TimeGenerated, TimeCollected\n| extend UserName = replace(@\"CORP.DOMAIN.COM\\\\\", @\"\", UserName)\n| extend UserName = replace(@\"CORP\\\\\", @\"\", UserName)\n| join(Event\n| where Source == 'FSLogix-Apps'\n| where EventID == 25\n| parse RenderedDescription with * \"Username: \" UserName:string \" \"*\n| project UserName, Computer, LoadTime=TimeGenerated) on UserName, Computer\n| extend ProfileLoad = datetime_diff('second',LoadTime,LogonTime)\n| where ProfileLoad \u003e 0\n| where ProfileLoad \u003c 1800\n| where Computer has \"prd-eus-poolprefix\"  //change to computername of specific hostpool\n| summarize avg(ProfileLoad), min(ProfileLoad), max(ProfileLoad)"
  },
  {
    "source": "AzureMonitor",
    "name": "Connection Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Connection Errors\n// Description: List of errors by CorrelationId for connections established in the last 24 hours. (Advanced query).\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// This query correlates WVDConnections, WVDErrors and WVDCheckpoints and exposes detailed information across all users. \n// Recommendation is to add a WHERE clause and filter down for a specific user which you are troubleshooting an issue for. \n// | where UserName == \"ReplaceUserName\" \nWVDConnections \n| where TimeGenerated \u003e ago (24h) \n| project-away TenantId,SourceSystem  \n| summarize arg_max(TimeGenerated, *), StartTime =  min(iff(State== 'Started', TimeGenerated , datetime(null) )), ConnectTime = min(iff(State== 'Connected', TimeGenerated , datetime(null) ))   by CorrelationId  \n| join kind=leftouter (WVDErrors\n    |summarize Errors=makelist(pack('Code', Code, 'CodeSymbolic', CodeSymbolic, 'Time', TimeGenerated, 'Message', Message ,'ServiceError', ServiceError, 'Source', Source)) by CorrelationId  \n    ) on CorrelationId\n| join kind=leftouter (WVDCheckpoints\n    | summarize Checkpoints=makelist(pack('Time', TimeGenerated, 'Name', Name, 'Parameters', Parameters, 'Source', Source)) by CorrelationId  \n    | mv-apply Checkpoints on (  \n        order by todatetime(Checkpoints['Time']) asc\n        | summarize Checkpoints=makelist(Checkpoints)\n        )\n    ) on CorrelationId  \n| project-away CorrelationId1, CorrelationId2  \n| order by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Connection Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Connection Errors\n// Description: Bar Chart of top 10 none service-related connection errors by user count in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// Query top 10 connection errors by number of users experiencing a specific error. \n// Alternatively replace \"UserName\" in the query by \"CorrelationID\" to see how often the error has occurred. \n// The \"CorrelationId\" is unique for each connection attempt. \n// The flag on \"ServiceError\" helps to focus on issues that are more likely mitigated by administrative tasks. \n// Change the ActivityType based on the issues you are troubleshooting. \nWVDErrors \n| where TimeGenerated \u003e ago(24h) \n| where ServiceError == \"false\" \n| where ActivityType == \"Connection\"  \n| summarize UserCount = count(UserName) by CodeSymbolic \n| sort by UserCount desc \n| top 10 by UserCount \n| render barchart  \n// Go to https://aka.ms/wvdgetstarted and review additional guidance for diagnostics in the How To section.\n// Our troubleshooting guidance has information on escalation paths."
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Feed  Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Feed  Errors\n// Description: Bar Chart of top 10 none service-related feed errors by user count in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// Query top 10 feed errors by number of users experiencing a specific error when subscribing to list of applications.\n// Alternatively replace \"UserName\" in the query by \"CorrelationID\" to see how often the error has occurred.\n// The \"CorrelationId\" is unique for each connection attempt. \n// The flag on ServiceError helps to focus on issues that are more likely mitigated by administrative tasks. \n// Change the ActivityType based on the issues you are troubleshooting. \nWVDErrors\n| where TimeGenerated \u003e ago(24h)\n| where ServiceError == \"false\" \n| where ActivityType == \"Feed\"  \n| summarize UserCount = count(UserName) by CodeSymbolic \n| sort by UserCount desc \n| top 10 by UserCount \n| render barchart  \n// Go to https://aka.ms/wvdgetstarted and review additional guidance for diagnostics in the How To section.\n// Our troubleshooting guidance has information on escalation paths."
  },
  {
    "source": "AzureMonitor",
    "name": "Average session logon time",
    "query": "// Author: Microsoft Azure\n// Display name: Average session logon time\n// Description: Average session logon time by Hostpool.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Host pools\n// Topic: Performance\n\n// Lists average session logon time by hostpool \nWVDConnections  \n| where TimeGenerated \u003e ago(24h)  \n| where State == \"Started\"  \n| project CorrelationId , UserName, ConnectionType , StartTime=TimeGenerated, _ResourceId \n| join (WVDConnections\n    | where State == \"Connected\"  \n    | project EndTime=TimeGenerated, CorrelationId)  \n    on CorrelationId  \n| project Duration = EndTime - StartTime, _ResourceId  \n| summarize AvgDuration=avg(Duration) by _ResourceId\n| extend Multi=split(_ResourceId, \"/\")  \n| project AvgDuration, ResourceGroup=Multi[4], HostPool=Multi[8]  \n| sort by AvgDuration desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Average Session Duration by hostpool",
    "query": "// Author: Microsoft Azure\n// Display name: Average Session Duration by hostpool\n// Description: Lists hostpools by average session duration in the past 7 days.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Host pools\n// Topic: Usage\n\n// Query average session duration per hostpool to determine the usage on hostpools for the past 7 days\nWVDConnections  \n| where TimeGenerated \u003e ago(7d) \n| where State == \"Connected\"\n| project ResourceAlias, CorrelationId, StartTime=TimeGenerated, _ResourceId\n| join kind = leftouter (WVDConnections  \n    | where State == \"Completed\"  \n    | project EndTime=TimeGenerated, CorrelationId)  \n    on CorrelationId  \n| project Duration =EndTime - StartTime, _ResourceId \n| summarize AvgDuration=avg(Duration) by _ResourceId\n| sort by AvgDuration asc\n| extend Multi=split(_ResourceId, \"/\")\n| project AvgDuration, ResourceGroup=Multi[4], HostPool=Multi[8]"
  },
  {
    "source": "AzureMonitor",
    "name": "Client OS",
    "query": "// Author: Microsoft Azure\n// Display name: Client OS\n// Description: Bar Chart of OS used on client devices in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Host pools\n// Topic: Usage\n\n// Use this query to understand which OS version users have installed on their devices they are connecting from. \n// Count is by unique users there where connected in the specified timeframe. \nWVDConnections  \n| where TimeGenerated \u003e ago(24h) \n| summarize UserCount=dcount(UserName) by ClientOS \n| sort by UserCount desc \n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Published applications used",
    "query": "// Author: Microsoft Azure\n// Display name: Published applications used\n// Description: Bar chart of remote applications users have executed from the remote desktop client.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Usage\n\n// The checkpoints table keeps track of any application or desktop a user has started from the remote desktop client UI. \n// Note: The Windows Virtual Desktop service doesn't have information of started applications for a published desktop in the remote session. \nWVDCheckpoints  \n| where TimeGenerated \u003e ago(7d) \n| where Name == \"LaunchExecutable\" \n| extend App = parse_json(Parameters).filename \n| summarize Usage = count(UserName) by tostring(App) \n| sort by Usage desc \n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "RD Client version",
    "query": "// Author: Microsoft Azure\n// Display name: RD Client version\n// Description: List of RD client versions used in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Host pools\n// Topic: Usage\n\n// Use this query to understand which client version users are using. \n// Count is by unique users there where connected in the specified timeframe. \nWVDConnections  \n| where TimeGenerated \u003e ago(24h) \n| summarize UserCount=dcount(UserName) by ClientType, ClientVersion \n| sort by ClientVersion, ClientType, UserCount desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Session duration",
    "query": "// Author: Microsoft Azure\n// Display name: Session duration\n// Description: Lists users by session duration in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Host pools\n// Topic: Usage\n\n// The \"State\" provides information on the connection stage of an actitivity.\n// The delta between \"Connected\" and \"Completed\" provides the connection time for a specific connection.\nWVDConnections \n| where TimeGenerated \u003e ago(24h) \n| where State == \"Connected\"  \n| project CorrelationId , UserName, ConnectionType , StartTime=TimeGenerated  \n| join (WVDConnections  \n    | where State == \"Completed\"  \n    | project EndTime=TimeGenerated, CorrelationId)  \n    on CorrelationId  \n| project Duration = EndTime - StartTime, ConnectionType, UserName  \n| sort by Duration desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 average session duration by user",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 average session duration by user\n// Description: Lists top 10 active users by average session duration and connection type in the past 7 days.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Host pools\n// Topic: Usage\n\n// Query average session duration time for all users that have been active in the past 7 days. \n// Connection activities have 3 states. In this query the delta between \"Connected\" and \"Completed\".\nWVDConnections  \n| where TimeGenerated \u003e ago(7d)  \n| where State == \"Connected\"  \n| project CorrelationId , UserName, ConnectionType , StartTime=TimeGenerated  \n| join (WVDConnections  \n    | where State == \"Completed\"  \n    | project EndTime=TimeGenerated, CorrelationId)  \n    on CorrelationId  \n| project Duration =EndTime - StartTime, ConnectionType, UserName  \n| summarize AVGDuration=avg(Duration) by UserName \n| sort by AVGDuration desc \n| limit 10"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 most active users",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 most active users\n// Description: Lists top 10 users by session duration in the past 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Host pools\n// Topic: Usage\n\n// Query the most active users by total session duration. \n// The session duration is the delta between \"Connected\" and \"Completed\" state.\nWVDConnections \n| where TimeGenerated \u003e ago(24h)\n| where State == \"Connected\" \n| project CorrelationId , UserName, ConnectionType , StartTime=TimeGenerated \n| join (WVDConnections \n    | where State == \"Completed\" \n    | project EndTime=TimeGenerated, CorrelationId) \n    on CorrelationId \n| extend SessionDuration = EndTime - StartTime\n| summarize Duration = sum(SessionDuration) by UserName, ConnectionType\n| sort by Duration desc\n| limit 10"
  },
  {
    "source": "AzureMonitor",
    "name": "Connection Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Connection Errors\n// Description: List of errors by CorrelationId for connections established in the last 24 hours. (Advanced query).\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// This query correlates WVDConnections, WVDErrors and WVDCheckpoints and exposes detailed information across all users. \n// Recommendation is to add a WHERE clause and filter down for a specific user which you are troubleshooting an issue for. \n// | where UserName == \"ReplaceUserName\" \nWVDConnections \n| where TimeGenerated \u003e ago (24h) \n| project-away TenantId,SourceSystem  \n| summarize arg_max(TimeGenerated, *), StartTime =  min(iff(State== 'Started', TimeGenerated , datetime(null) )), ConnectTime = min(iff(State== 'Connected', TimeGenerated , datetime(null) ))   by CorrelationId  \n| join kind=leftouter (WVDErrors\n    |summarize Errors=makelist(pack('Code', Code, 'CodeSymbolic', CodeSymbolic, 'Time', TimeGenerated, 'Message', Message ,'ServiceError', ServiceError, 'Source', Source)) by CorrelationId  \n    ) on CorrelationId\n| join kind=leftouter (WVDCheckpoints\n    | summarize Checkpoints=makelist(pack('Time', TimeGenerated, 'Name', Name, 'Parameters', Parameters, 'Source', Source)) by CorrelationId  \n    | mv-apply Checkpoints on (  \n        order by todatetime(Checkpoints['Time']) asc\n        | summarize Checkpoints=makelist(Checkpoints)\n        )\n    ) on CorrelationId  \n| project-away CorrelationId1, CorrelationId2  \n| order by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Connection Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Connection Errors\n// Description: Bar Chart of top 10 none service-related connection errors by user count in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// Query top 10 connection errors by number of users experiencing a specific error. \n// Alternatively replace \"UserName\" in the query by \"CorrelationID\" to see how often the error has occurred. \n// The \"CorrelationId\" is unique for each connection attempt. \n// The flag on \"ServiceError\" helps to focus on issues that are more likely mitigated by administrative tasks. \n// Change the ActivityType based on the issues you are troubleshooting. \nWVDErrors \n| where TimeGenerated \u003e ago(24h) \n| where ServiceError == \"false\" \n| where ActivityType == \"Connection\"  \n| summarize UserCount = count(UserName) by CodeSymbolic \n| sort by UserCount desc \n| top 10 by UserCount \n| render barchart  \n// Go to https://aka.ms/wvdgetstarted and review additional guidance for diagnostics in the How To section.\n// Our troubleshooting guidance has information on escalation paths."
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 Feed  Errors",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 Feed  Errors\n// Description: Bar Chart of top 10 none service-related feed errors by user count in the last 24 hours.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Errors\n\n// Query top 10 feed errors by number of users experiencing a specific error when subscribing to list of applications.\n// Alternatively replace \"UserName\" in the query by \"CorrelationID\" to see how often the error has occurred.\n// The \"CorrelationId\" is unique for each connection attempt. \n// The flag on ServiceError helps to focus on issues that are more likely mitigated by administrative tasks. \n// Change the ActivityType based on the issues you are troubleshooting. \nWVDErrors\n| where TimeGenerated \u003e ago(24h)\n| where ServiceError == \"false\" \n| where ActivityType == \"Feed\"  \n| summarize UserCount = count(UserName) by CodeSymbolic \n| sort by UserCount desc \n| top 10 by UserCount \n| render barchart  \n// Go to https://aka.ms/wvdgetstarted and review additional guidance for diagnostics in the How To section.\n// Our troubleshooting guidance has information on escalation paths."
  },
  {
    "source": "AzureMonitor",
    "name": "Published applications used",
    "query": "// Author: Microsoft Azure\n// Display name: Published applications used\n// Description: Bar chart of remote applications users have executed from the remote desktop client.\n// Categories: Windows Virtual Desktop\n// Resource types: Windows Virtual Desktop - Application groups.Windows Virtual Desktop - Host pools.Windows Virtual Desktop - Workspaces\n// Topic: Usage\n\n// The checkpoints table keeps track of any application or desktop a user has started from the remote desktop client UI. \n// Note: The Windows Virtual Desktop service doesn't have information of started applications for a published desktop in the remote session. \nWVDCheckpoints  \n| where TimeGenerated \u003e ago(7d) \n| where Name == \"LaunchExecutable\" \n| extend App = parse_json(Parameters).filename \n| summarize Usage = count(UserName) by tostring(App) \n| sort by Usage desc \n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Common categories in Azure diagnostics",
    "query": "// Author: Microsoft Azure\n// Display name: Common categories in Azure diagnostics\n// Description: Count the number of logs reported per category.\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Azure diagnostics\n\nAzureDiagnostics \n| summarize countLogsPerCategory=count() by Category  \n| sort by countLogsPerCategory"
  },
  {
    "source": "AzureMonitor",
    "name": "Errors in automation jobs",
    "query": "// Author: Microsoft Azure\n// Display name: Errors in automation jobs\n// Description: Find logs reporting errors in automation jobs from the last day.\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Azure diagnostics\n\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.AUTOMATION\"  \n| where StreamType_s == \"Error\" \n| project TimeGenerated, Category, JobId_g, OperationName, RunbookName_s, ResultDescription"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed backup jobs",
    "query": "// Author: Microsoft Azure\n// Display name: Failed backup jobs\n// Description: Find logs reported failed backup jobs from the last day.\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Azure diagnostics\n\nAzureDiagnostics  \n| where ResourceProvider == \"MICROSOFT.RECOVERYSERVICES\" and Category == \"AzureBackupReport\"  \n| where OperationName == \"Job\" and JobOperation_s == \"Backup\" and JobStatus_s == \"Failed\" \n| project TimeGenerated, JobUniqueId_g, JobStartDateTime_s, JobOperation_s, JobOperationSubType_s, JobStatus_s , JobFailureCode_s, JobDurationInSecs_s , AdHocOrScheduledJob_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Latest metrics",
    "query": "// Author: Microsoft Azure\n// Display name: Latest metrics\n// Description: Show the latest metrics reports for each reported metric.\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Azure diagnostics\n\nAzureMetrics \n| summarize arg_max(TimeGenerated, UnitName, Total, Count, Maximum, Minimum, Average) by MetricName"
  },
  {
    "source": "AzureMonitor",
    "name": "Network security events",
    "query": "// Author: Microsoft Azure\n// Display name: Network security events\n// Description: Find Network security events reporting blocked incoming traffic.\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Azure diagnostics\n\nAzureDiagnostics \n| where ResourceProvider == \"MICROSOFT.NETWORK\"  \n| where Category == \"NetworkSecurityGroupEvent\"  \n| where direction_s == \"In\" and type_s == \"block\""
  },
  {
    "source": "AzureMonitor",
    "name": "Availability rate",
    "query": "// Author: Microsoft Azure\n// Display name: Availability rate\n// Description: Calculate the availability rate of each connected computer.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Availability\n\nHeartbeat\n// bin_at is used to set the time grain to 1 hour, starting exactly 24 hours ago\n| summarize heartbeatPerHour = count() by bin_at(TimeGenerated, 1h, ago(24h)), Computer\n| extend availablePerHour = iff(heartbeatPerHour \u003e 0, true, false)\n| summarize totalAvailableHours = countif(availablePerHour == true) by Computer\n| extend availabilityRate = totalAvailableHours*100.0/24"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers availability today",
    "query": "// Author: Microsoft Azure\n// Display name: Computers availability today\n// Description: Chart the number of computers sending logs, each hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Availability\n\nHeartbeat\n| summarize dcount(ComputerIP) by bin(TimeGenerated, 1h)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Last heartbeat of each computer",
    "query": "// Author: Microsoft Azure\n// Display name: Last heartbeat of each computer\n// Description: Show the last heartbeat sent by each computer.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Availability\n\nHeartbeat\n| summarize arg_max(TimeGenerated, *) by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "List heartbeats",
    "query": "// Author: Microsoft Azure\n// Display name: List heartbeats\n// Description: List all computer heartbeats from the last hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Availability\n\nHeartbeat\n| where TimeGenerated \u003e ago(1h)"
  },
  {
    "source": "AzureMonitor",
    "name": "Unavailable computers",
    "query": "// Author: Microsoft Azure\n// Display name: Unavailable computers\n// Description: List all known computers that didn't send a heartbeat in the last 5 hours.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Availability\n\nHeartbeat\n| summarize LastHeartbeat=max(TimeGenerated) by Computer\n| where LastHeartbeat \u003c ago(5h)"
  },
  {
    "source": "AzureMonitor",
    "name": "CPU usage trends over the last day",
    "query": "// Author: Microsoft Azure\n// Display name: CPU usage trends over the last day\n// Description: Calculate CPU usage patterns across all computers, chart by percentiles.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Performance\n\nPerf\n| where ObjectName == \"Processor\" and CounterName == \"% Processor Time\" and InstanceName == \"_Total\"\n| summarize percentiles(CounterValue, 50, 90, 99) by bin(TimeGenerated, 1h)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Memory and CPU usage",
    "query": "// Author: Microsoft Azure\n// Display name: Memory and CPU usage\n// Description: Chart all computers' used memory and CPU, over the last hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Performance\n\nPerf\n| where TimeGenerated \u003e ago(1h)\n| where (CounterName == \"% Processor Time\" and InstanceName == \"_Total\") or CounterName == \"% Used Memory\"\n| project TimeGenerated, CounterName, CounterValue\n| summarize avg(CounterValue) by CounterName, bin(TimeGenerated, 1m)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Top 10 computers with the highest disk space",
    "query": "// Author: Microsoft Azure\n// Display name: Top 10 computers with the highest disk space\n// Description: Show the top 10 computers with the highest available disk space.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Performance\n\nPerf\n| where CounterName == \"Free Megabytes\" and InstanceName == \"_Total\"\n| summarize arg_max(TimeGenerated, *) by Computer\n| top 10 by CounterValue"
  },
  {
    "source": "AzureMonitor",
    "name": "What data is being collected",
    "query": "// Author: Microsoft Azure\n// Display name: What data is being collected?\n// Description: List the collected performance counters and object types (Process, Memory, Processor).\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Performance\n\nPerf\n| summarize by ObjectName, CounterName"
  },
  {
    "source": "AzureMonitor",
    "name": "Billable performance data",
    "query": "// Author: Microsoft Azure\n// Display name: Billable performance data\n// Description: Calculate the volume of billable data (in GB) for Perf data, over the last day.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Usage\n\nUsage\n| where TimeGenerated \u003e ago(1d)\n| where IsBillable == true\n| where DataType == \"Perf\"\n| summarize TotalVolumeGB = sum(Quantity) / 1024"
  },
  {
    "source": "AzureMonitor",
    "name": "Ingested volume spikes and slopes  by Azure resource",
    "query": "// Author: Microsoft Azure\n// Display name: Ingested volume spikes and slopes - by Azure resource\n// Description: List the identified ingestion volume spikes and the slope of each spike (positive is upward spike, negative is downward).\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Usage\n\nlet StartTime = ago(6h);\nlet EndTime = now();\nlet MinRSquare = 0.8; // Tune the sensitivity of the detection sensor\nunion *\n| where TimeGenerated between (StartTime .. EndTime)\n// Create a time series of data volume by resource id\n| where isempty(_ResourceId) == False\n| make-series RatioSeries=sum(_BilledSize) default=0 on TimeGenerated in range(StartTime, EndTime, 10m) by _ResourceId\n// Apply a 2-line regression to the time series\n| extend (RSquare2, SplitIdx, Variance2, RVariance2, LineFit2) = series_fit_2lines(RatioSeries)\n// Find out if our 2-line is trending up or down\n| extend (Slope, Interception, RSquare, Variance, RVariance, LineFit) = series_fit_line(LineFit2)\n// Check whether the line fit reaches the threshold\n| where RSquare2 \u003e MinRSquare and Slope != 0\n| project _ResourceId, Slope"
  },
  {
    "source": "AzureMonitor",
    "name": "Ingestion volume spikes  by Solution and data type",
    "query": "// Author: Microsoft Azure\n// Display name: Ingestion volume spikes - by Solution and data type\n// Description: Check for ingestion volume spikes per Solution and data type, in the last 24 hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Usage\n\nlet StartTime = ago(24h);\nlet EndTime = now();\nlet MinRSquare =0.8; // Tune the sensitivity of the detection sensor\nUsage\n| where TimeGenerated between (StartTime .. EndTime)\n// Create a time series of data volume by solution and data type\n| make-series RatioSeries=sum(Quantity/1024) default=0 on TimeGenerated in range(StartTime, EndTime,10m) by Solution, DataType\n// Apply a 2-line regression to the time series\n| extend (RSquare2, SplitIdx, Variance2, RVariance2, LineFit2) = series_fit_2lines(RatioSeries)\n// Find out if our 2-line is trending up or down\n| extend (Slope, Interception, RSquare, Variance, RVariance, LineFit) = series_fit_line(LineFit2)\n// Check whether the line fit reaches the threshold\n| project Solution, DataType, Spike = iff(RSquare2 \u003e MinRSquare and Slope != 0, \"Spike detected\", \"No spike\")"
  },
  {
    "source": "AzureMonitor",
    "name": "Total workspace ingestion over the last 24 hours",
    "query": "// Author: Microsoft Azure\n// Display name: Total workspace ingestion over the last 24 hours\n// Description: Volume (GB) of all data ingested to this workspace, over the last 24 hours.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Usage\n\nUsage\n|where TimeGenerated \u003e ago(24h)\n|summarize TotalIngestionVolGB = sum(Quantity)/1024.0"
  },
  {
    "source": "AzureMonitor",
    "name": "Total workspace ingestion volume timechart last day",
    "query": "// Author: Microsoft Azure\n// Display name: Total workspace ingestion volume timechart, last day\n// Description: Chart the workspace ingestion volume of the last day.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Usage\n\nunion *\n| where TimeGenerated \u003e ago(1d)\n| summarize TotalVolumeGB = sum(_BilledSize)/1024/1024/1024 by bin(TimeGenerated,10m)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Usage by data types",
    "query": "// Author: Microsoft Azure\n// Display name: Usage by data types\n// Description: Chart the amount of logs reported for each data type, today.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Usage\n\nUsage\n| summarize count_per_type=count() by DataType\n| sort by count_per_type desc\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Volume of solutions data",
    "query": "// Author: Microsoft Azure\n// Display name: Volume of solutions' data\n// Description: Chart the volume of data (in Mb) sent by each solution.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Usage\n\nUsage\n| summarize total_MBytes=sum(Quantity) by Solution\n| sort by total_MBytes desc nulls last\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Agent latency spikes  Heartbeat table",
    "query": "// Author: Microsoft Azure\n// Display name: Agent latency spikes - Heartbeat table\n// Description: Check for agent latency spikes in the ingestion of Heartbeats in the last 24 hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Health\n\n// This query calculates ingestion duration every 10 minutes, and looks for spikes\nlet StartTime = ago(24h);\nlet EndTime = now();\nlet MinRSquare = 0.9; // Tune the sensitivity of the detection sensor. Higher numbers make the detector more sensitive\nHeartbeat\n| where TimeGenerated between (StartTime .. EndTime)\n// calculate ingestion duration in seconds\n| extend AgentLatencySeconds = (_TimeReceived-TimeGenerated)/1s\n// Create a time series\n| make-series RatioSeries=avg(AgentLatencySeconds) default=0 on TimeGenerated in range(StartTime , EndTime,10m)\n// Apply a 2-line regression to the time series\n| extend (RSquare2, SplitIdx, Variance2, RVariance2, LineFit2) = series_fit_2lines(RatioSeries)\n// Find out if our 2-line is trending up or down\n|extend (Slope, Interception, RSquare, Variance, RVariance, LineFit) = series_fit_line(LineFit2)\n// Check whether the line fit reaches the threshold, and if the spike represents an increase (rather than a decrease)\n| project PatternMatch = iff(RSquare2 \u003e MinRSquare and Slope\u003e0, \"Spike detected\", \"No spike\")"
  },
  {
    "source": "AzureMonitor",
    "name": "Agent latency spikes  by data type",
    "query": "// Author: Microsoft Azure\n// Display name: Agent latency spikes - by data type\n// Description: Check for agent latency spikes per data type, in the last 24 hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Health\n\nlet StartTime = ago(24h);\nlet EndTime = now();\nlet MinRSquare = 0.8; // Tune the sensitivity of the detection sensor\nunion withsource=source_table *\n| where TimeGenerated between (StartTime .. EndTime)\n// calculate ingestion duration in seconds\n| extend AgentLatencySeconds = (_TimeReceived-TimeGenerated)/1s\n// Create a time series for each source table\n| make-series RatioSeries=avg(AgentLatencySeconds) default=0 on TimeGenerated in range(StartTime, EndTime,10m) by source_table\n// Apply a 2-line regression to the time series\n| extend (RSquare2, SplitIdx, Variance2, RVariance2, LineFit2) = series_fit_2lines(RatioSeries)\n// Find out if our 2-line is trending up or down\n| extend (Slope, Interception, RSquare, Variance, RVariance, LineFit) = series_fit_line(LineFit2)\n// Check whether the line fit reaches the threshold, and if the spike represents an increase (rather than a decrease)\n| project source_table, PatternMatch = iff(RSquare2 \u003e MinRSquare and Slope\u003e0, \"Spike detected\", \"No spike\")"
  },
  {
    "source": "AzureMonitor",
    "name": "Ingestion latency endtoend spikes  Heartbeat table",
    "query": "// Author: Microsoft Azure\n// Display name: Ingestion latency (end-to-end) spikes - Heartbeat table\n// Description: Check for latency spikes in the ingestion of Heartbeats in the last 24 hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Health\n\n// This query calculates ingestion duration every 10 minutes, and looks for spikes\nlet StartTime = ago(24h);\nlet EndTime = now();\nlet MinRSquare = 0.9; // Tune the sensitivity of the detection sensor. Higher numbers make the detector more sensitive\nHeartbeat\n| where TimeGenerated between (StartTime .. EndTime)\n// calculate ingestion duration in seconds\n| extend IngestionDurationSeconds = (ingestion_time()-TimeGenerated)/1s\n// Create a time series\n| make-series RatioSeries=avg(IngestionDurationSeconds) default=0 on TimeGenerated in range(StartTime , EndTime,10m)\n// Apply a 2-line regression to the time series\n| extend (RSquare2, SplitIdx, Variance2, RVariance2, LineFit2) = series_fit_2lines(RatioSeries)\n// Find out if our 2-line is trending up or down\n|extend (Slope, Interception, RSquare, Variance, RVariance, LineFit) = series_fit_line(LineFit2)\n// Check whether the line fit reaches the threshold, and if the spike represents an increase (rather than a decrease)\n| project PatternMatch = iff(RSquare2 \u003e MinRSquare and Slope\u003e0, \"Spike detected\", \"No spike\")"
  },
  {
    "source": "AzureMonitor",
    "name": "Ingestion latency endtoend spikes  by data type",
    "query": "// Author: Microsoft Azure\n// Display name: Ingestion latency (end-to-end) spikes - by data type\n// Description: Check for ingestion latency spikes per data type, in the last 24 hour.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Health\n\nlet StartTime = ago(24h);\nlet EndTime = now();\nlet MinRSquare = 0.8; // Tune the sensitivity of the detection sensor\nunion withsource=source_table *\n| where TimeGenerated between (StartTime .. EndTime)\n// calculate ingestion duration in seconds\n| extend IngestionDurationSeconds = (ingestion_time()-TimeGenerated)/1s\n// Create a time series for each source table\n| make-series RatioSeries=avg(IngestionDurationSeconds) default=0 on TimeGenerated in range(StartTime, EndTime,10m) by source_table\n// Apply a 2-line regression to the time series\n| extend (RSquare2, SplitIdx, Variance2, RVariance2, LineFit2) = series_fit_2lines(RatioSeries)\n// Find out if our 2-line is trending up or down\n| extend (Slope, Interception, RSquare, Variance, RVariance, LineFit) = series_fit_line(LineFit2)\n// Check whether the line fit reaches the threshold, and if the spike represents an increase (rather than a decrease)\n| project source_table, PatternMatch = iff(RSquare2 \u003e MinRSquare and Slope\u003e0, \"Spike detected\", \"No spike\")"
  },
  {
    "source": "AzureMonitor",
    "name": "Ingestion latency endtoend timechart  Event table",
    "query": "// Author: Microsoft Azure\n// Display name: Ingestion latency (end-to-end) timechart - Event table\n// Description: Chart the latency of ingestion to the Event table in the last 1 day.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Health\n\nEvent\n| where TimeGenerated \u003e ago(1d)\n| project TimeGenerated, IngestionDurationSeconds = (ingestion_time()-TimeGenerated)/1s\n| render timechart title = \"Ingestion latency: Event table\""
  },
  {
    "source": "AzureMonitor",
    "name": "Total agent latency timechart last day",
    "query": "// Author: Microsoft Azure\n// Display name: Total agent latency timechart, last day\n// Description: Chart the median (50th percentile) agent latency over the last day.\n// Categories: monitor\n// Resource types: Azure Monitor\n// Solutions: LogManagement\n// Topic: Health\n\nunion *\n| where TimeGenerated \u003e ago(1d)\n| extend AgentLatencySeconds = (_TimeReceived-TimeGenerated)/1s\n| summarize percentile(AgentLatencySeconds, 50) by bin(TimeGenerated,1h)\n| render timechart"
  },
  {
    "source": "AzureMonitor",
    "name": "ExtractExamples",
    "query": "// Author: CliveW-MSFT \n// Display name: How to extract Subscription or ResourceGroup from _ResourceID\n// Description: Demo on methods to extract data using KQL.  AzureActivity data used as an example.  Three methods are shown to extract the same data.  Key words: Split, Extract and Parse\n// Categories: Azure Monitor\n// Resource types: Azure Monitor\n// Topic: Extract\n\nAzureActivity\n| extend subId =  split(_ResourceId,\"/\").[2]\n| extend resGr =  split(_ResourceId,\"/\").[4]\n| project _ResourceId, subId, resGr\n\nAzureActivity\n| parse _ResourceId with * '/subscriptions/' subId '/' *\n| parse _ResourceId with * '/resourcegroups/' resGr '/' *\n| distinct  subId, resGr\n\nAzureActivity\n| extend subId = extract(@\"/subscriptions/(.*?)/\", 1,_ResourceId)\n| extend resGr = extract(@\"/resourcegroups/(.*?)/\", 1,_ResourceId)\n| project subId, resGr\n\n\n// Just do a regex lookup  \nAzureActivity\n| where _ResourceId matches regex @\"/subscriptions/(.*?)/\""
  },
  {
    "source": "AzureMonitor",
    "name": "Run a casesensitive search",
    "query": "// Author: Microsoft Azure\n// Display name: Run a case-sensitive search\n// Description: Search the AzureDiagnostics table for logs that contain the term \"JIT\".\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Search through the logs\n\nsearch kind=case_sensitive in (AzureDiagnostics) \"*JIT*\""
  },
  {
    "source": "AzureMonitor",
    "name": "Search a table for a specific term",
    "query": "// Author: Microsoft Azure\n// Display name: Search a table for a specific term\n// Description: Search AzureMetrics table for the term \"CPU\".\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Search through the logs\n\nsearch in (AzureMetrics) \"CPU\"// search is case-insensitive"
  },
  {
    "source": "AzureMonitor",
    "name": "Search a term through all logs",
    "query": "// Author: Microsoft Azure\n// Display name: Search a term through all logs\n// Description: Search the term \"Network\" across all tables.\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Search through the logs\n\nsearch \"Network\"// search is case-insensitive \n| where TimeGenerated \u003e ago(30m)"
  },
  {
    "source": "AzureMonitor",
    "name": "Search in multiple tables",
    "query": "// Author: Microsoft Azure\n// Display name: Search in multiple tables\n// Description: Search AzureDiagnostics, AzureMetrics and AzureActivity for logs that contain \"fail\".\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Search through the logs\n\nsearch in (AzureDiagnostics, AzureMetrics, AzureActivity) \"*fail*\""
  },
  {
    "source": "AzureMonitor",
    "name": "Search multiple terms",
    "query": "// Author: Microsoft Azure\n// Display name: Search multiple terms\n// Description: Search the AzureActivity table for logs that contain \"err\" or \"warn\".\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Search through the logs\n\nsearch in (AzureActivity) \"*err*\" or \"*warn*\" \n| where TimeGenerated \u003e ago(1h)"
  },
  {
    "source": "AzureMonitor",
    "name": "Show latest logs from all tables",
    "query": "// Author: Microsoft Azure\n// Display name: Show latest logs from all tables\n// Description: Search all logs from all tables, and return the last 500 logs.\n// Categories: resources\n// Resource types: Azure Monitor\n// Topic: Search through the logs\n\n// returns every column from every table. We recommend you always scope your queries to specific tables or time range. Un-scoped queries may take a while to complete and may return too many results. \nsearch *  \n| top 500 by TimeGenerated// return the latest 500 results"
  },
  {
    "source": "AzureMonitor",
    "name": "AD Recommendations by AffectedObjectType",
    "query": "// Author: Microsoft Azure\n// Display name: AD Recommendations by AffectedObjectType\n// Description: Count AD recommendations with failed result by affected object type.\n// Categories: workloads\n// Solutions: ADAssessment\n// Topic: Diagnostics\n\nADAssessmentRecommendation \n| where RecommendationResult == \"Failed\" \n| summarize AggregatedValue = count() by AffectedObjectType"
  },
  {
    "source": "AzureMonitor",
    "name": "AD Recommendations by Computer",
    "query": "// Author: Microsoft Azure\n// Display name: AD Recommendations by Computer\n// Description: Count AD recommendations with failed result by computer.\n// Categories: workloads\n// Solutions: ADAssessment\n// Topic: Diagnostics\n\nADAssessmentRecommendation \n| where RecommendationResult == \"Failed\" \n| summarize AggregatedValue = count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "AD Recommendations by Domain",
    "query": "// Author: Microsoft Azure\n// Display name: AD Recommendations by Domain\n// Description: Count AD recommendations with failed result by domain.\n// Categories: workloads\n// Solutions: ADAssessment\n// Topic: Diagnostics\n\nADAssessmentRecommendation \n| where RecommendationResult == \"Failed\" \n| summarize AggregatedValue = count() by Domain"
  },
  {
    "source": "AzureMonitor",
    "name": "AD Recommendations by DomainController",
    "query": "// Author: Microsoft Azure\n// Display name: AD Recommendations by DomainController\n// Description: Count AD recommendations with failed result by domain controller.\n// Categories: workloads\n// Solutions: ADAssessment\n// Topic: Diagnostics\n\nADAssessmentRecommendation \n| where RecommendationResult == \"Failed\" \n| summarize AggregatedValue = count() by DomainController"
  },
  {
    "source": "AzureMonitor",
    "name": "AD Recommendations by Focus Area",
    "query": "// Author: Microsoft Azure\n// Display name: AD Recommendations by Focus Area\n// Description: Count all AD reccomendations by focus area.\n// Categories: workloads\n// Solutions: ADAssessment\n// Topic: Diagnostics\n\nADAssessmentRecommendation \n| summarize AggregatedValue = count() by FocusArea"
  },
  {
    "source": "AzureMonitor",
    "name": "AD Recommendations by Forest",
    "query": "// Author: Microsoft Azure\n// Display name: AD Recommendations by Forest\n// Description: Count AD recommendations with failed result by forest.\n// Categories: workloads\n// Solutions: ADAssessment\n// Topic: Diagnostics\n\nADAssessmentRecommendation \n| where RecommendationResult == \"Failed\" \n| summarize AggregatedValue = count() by Forest"
  },
  {
    "source": "AzureMonitor",
    "name": "How many times did each unique AD Recommendation trigger",
    "query": "// Author: Microsoft Azure\n// Display name: How many times did each unique AD Recommendation trigger?\n// Description: Count AD recommendations with failed result by recommendation.\n// Categories: workloads\n// Solutions: ADAssessment\n// Topic: Diagnostics\n\nADAssessmentRecommendation \n| where RecommendationResult == \"Failed\" \n| summarize AggregatedValue = count() by Recommendation"
  },
  {
    "source": "AzureMonitor",
    "name": "High priority AD Assessment security recommendations",
    "query": "// Author: Microsoft Azure\n// Display name: High priority AD Assessment security recommendations\n// Description: Latest high priority security recommendation with result failed by recommendation Id.\n// Categories: security\n// Solutions: ADAssessment\n// Topic: Security\n\nADAssessmentRecommendation\n| where FocusArea == 'Security and Compliance' and RecommendationResult == 'Failed' and RecommendationScore\u003e=35\n| summarize arg_max(TimeGenerated, *) by RecommendationId"
  },
  {
    "source": "AzureMonitor",
    "name": "All configuration changes",
    "query": "// Author: Microsoft Azure\n// Display name: All configuration changes\n// Description: Lists all configuration changes sorted by time (newest first).\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationChange\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Recent stopped auto services",
    "query": "// Author: Microsoft Azure\n// Display name: Recent stopped auto services\n// Description: Shows most recent services that were set to Auto but reported as being stopped.\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationData\n| where ConfigDataType == \"WindowsServices\" and SvcStartupType == \"Auto\"\n| where SvcState == \"Stopped\"\n| summarize arg_max(TimeGenerated, *) by SoftwareName, Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Removed software changes",
    "query": "// Author: Microsoft Azure\n// Display name: Removed software changes\n// Description: Shows change records for removed software.\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationChange\n| where ConfigChangeType == \"Software\" and ChangeCategory == \"Removed\"\n| order by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Service changes",
    "query": "// Author: Microsoft Azure\n// Display name: Service changes\n// Description: Lists service changes sorted by time (newest first).\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationChange\n| where ConfigChangeType == \"Services\"\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Software change count per category",
    "query": "// Author: Microsoft Azure\n// Display name: Software change count per category\n// Description: Count software changes by change category.\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationChange\n| where ConfigChangeType == \"Software\"\n| summarize AggregatedValue = count() by ChangeCategory"
  },
  {
    "source": "AzureMonitor",
    "name": "Software change type per computer",
    "query": "// Author: Microsoft Azure\n// Display name: Software change type per computer\n// Description: Count software changes by computer.\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationChange \n| where ConfigChangeType == \"Software\"\n| summarize AggregatedValue = count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Software changes",
    "query": "// Author: Microsoft Azure\n// Display name: Software changes\n// Description: Lists software changes sorted by time (newest first).\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationChange\n| where ConfigChangeType == \"Software\"\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Stopped services",
    "query": "// Author: Microsoft Azure\n// Display name: Stopped services\n// Description: Lists stopped service changes sorted by time.\n// Categories: management\n// Solutions: ChangeTracking\n// Topic: Diagnostics\n\nConfigurationChange \n| where ConfigChangeType == \"WindowsServices\" and SvcState == \"Stopped\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Container Insight solution billable data",
    "query": "// Author: Microsoft Azure\n// Display name: Container Insight solution billable data\n// Description: See total billable data from Container Insights solution.\n// Categories: container,resources\n// Solutions: ContainerInsights\n// Topic: Costing\n\n//This includes billable data for all solutions in the workspace, see for Container Insights solution\nUsage\n| where TimeGenerated \u003e startofday(ago(30d))\n| where IsBillable == true\n| summarize TotalVolumeGB = sum(Quantity) / 1000 by bin(TimeGenerated, 1d), Solution\n| render barchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Distinct Clients Resolving Malicious Domains",
    "query": "// Author: Microsoft Azure\n// Display name: Distinct Clients Resolving Malicious Domains\n// Description: Distinct clients resolving malicious domains.\n// Categories: security\n// Solutions: DnsAnalytics\n// Topic: Security\n\nDnsEvents\n| where SubType == 'LookupQuery' and isnotempty(MaliciousIP)\n| summarize count() by ClientIP"
  },
  {
    "source": "AzureMonitor",
    "name": "All Events in the past hour",
    "query": "// Author: Microsoft Azure\n// Display name: All Events in the past hour\n// Description: All Events in the past hour.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent\n| where TimeGenerated \u003e ago(1h)\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "All Syslog by facility",
    "query": "// Author: Microsoft Azure\n// Display name: All Syslog by facility\n// Description: All Syslog by facility.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nSyslog \n| summarize count() by Facility"
  },
  {
    "source": "AzureMonitor",
    "name": "All Syslog by process name",
    "query": "// Author: Microsoft Azure\n// Display name: All Syslog by process name\n// Description: All Syslog by process name.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nSyslog \n| summarize count() by ProcessName"
  },
  {
    "source": "AzureMonitor",
    "name": "All Syslog",
    "query": "// Author: Microsoft Azure\n// Display name: All Syslog\n// Description: Last 100 Syslog.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nSyslog \n| top 100 by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers restartsshutdowns",
    "query": "// Author: Microsoft Azure\n// Display name: Computers restarts/shutdowns\n// Description: List restart and shutdowns events for all monitor computers.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent\n| where  EventLog == \"System\" and Source == \"User32\" and EventID == 1074\n| search \"shutdown\"\n| sort by TimeGenerated desc \n| project TimeGenerated, Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Count IIS log entries by HTTP request method",
    "query": "// Author: Microsoft Azure\n// Display name: Count IIS log entries by HTTP request method\n// Description: Count IIS log entries by HTTP request method.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog \n| summarize count() by csMethod"
  },
  {
    "source": "AzureMonitor",
    "name": "Count IIS log entries by client IP address",
    "query": "// Author: Microsoft Azure\n// Display name: Count IIS log entries by client IP address\n// Description: Count IIS log entries by client IP address.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog \n| summarize count() by cIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Count of IIS log entries by URL",
    "query": "// Author: Microsoft Azure\n// Display name: Count of IIS log entries by URL\n// Description: Count of IIS log entries by URL requested by client.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog \n| summarize count() by csUriStem"
  },
  {
    "source": "AzureMonitor",
    "name": "Count of IIS log entries by host",
    "query": "// Author: Microsoft Azure\n// Display name: Count of IIS log entries by host\n// Description: Count of IIS log entries by host requested by client.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog \n| summarize count() by csHost"
  },
  {
    "source": "AzureMonitor",
    "name": "Count of warning events",
    "query": "// Author: Microsoft Azure\n// Display name: Count of warning events\n// Description: Count of warning events by event ID.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent \n| where EventLevelName == \"warning\" \n| summarize count() by EventID"
  },
  {
    "source": "AzureMonitor",
    "name": "Display breakdown respond codes",
    "query": "// Author: Microsoft Azure\n// Display name: Display breakdown respond codes\n// Description: Display breakdown respond codes.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog \n| summarize count() by scStatus"
  },
  {
    "source": "AzureMonitor",
    "name": "Events by event ID",
    "query": "// Author: Microsoft Azure\n// Display name: Events by event ID\n// Description: Top 10 events by event ID.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent \n| summarize count() by EventID\n| top 10 by count_"
  },
  {
    "source": "AzureMonitor",
    "name": "Events by event source",
    "query": "// Author: Microsoft Azure\n// Display name: Events by event source\n// Description: Events by event source.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent\n| summarize count() by Source"
  },
  {
    "source": "AzureMonitor",
    "name": "Events in OM between 2000 to 3000",
    "query": "// Author: Microsoft Azure\n// Display name: Events in OM between 2000 to 3000\n// Description: Operation manger events with IDs in range of 2000 to 3000.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent \n| where EventLog == \"Operations Manager\" and (EventID \u003e= 2000 and EventID \u003c= 3000) \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Events started",
    "query": "// Author: Microsoft Azure\n// Display name: Events started\n// Description: Events started by event ID.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent\n| where RenderedDescription contains \"started\" \n| summarize count() by EventID"
  },
  {
    "source": "AzureMonitor",
    "name": "IIS log entries for client IP",
    "query": "// Author: Microsoft Azure\n// Display name: IIS log entries for client IP\n// Description: IIS log entries for a client IP.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog \n| where cIP == \"192.168.0.1\" // Enter Client IP here\n| project csUriStem, scBytes, csBytes, TimeTaken, scStatus, TimeGenerated\n| top 100 by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "List IIS log entries",
    "query": "// Author: Microsoft Azure\n// Display name: List IIS log entries\n// Description: Last 50 IIS log entries.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog\n| top 50 by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Show 404 pages list",
    "query": "// Author: Microsoft Azure\n// Display name: Show 404 pages list\n// Description: Show 404 pages list.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nW3CIISLog \n| where scStatus == 404\n| summarize count() by csUriStem\n| sort by count_ desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Warning events",
    "query": "// Author: Microsoft Azure\n// Display name: Warning events\n// Description: Warning events sortd by time.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent \n| where EventLevelName == \"warning\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Windows Firewall policy settings changed by machines",
    "query": "// Author: Microsoft Azure\n// Display name: Windows Firewall policy settings changed by machines\n// Description: Windows Firewall policy settings changed by machines.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent \n| where EventLog == \"Microsoft-Windows-Windows Firewall With Advanced Security/Firewall\" and EventID == 2008 \n| summarize count() by Computer \n| limit 10000"
  },
  {
    "source": "AzureMonitor",
    "name": "Windows Firewall policy settings",
    "query": "// Author: Microsoft Azure\n// Display name: Windows Firewall policy settings\n// Description: Windows Firewall policy settings changed.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Diagnostics\n\nEvent\n| where EventLog == \"Microsoft-Windows-Windows Firewall With Advanced Security/Firewall\" and EventID == 2008 \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "All Syslog with errors",
    "query": "// Author: Microsoft Azure\n// Display name: All Syslog with errors\n// Description: Last 100 Syslog with erros.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Errors\n\nSyslog \n| where SeverityLevel == \"err\" or  SeverityLevel == \"error\"\n| top 100 by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Servers with internal server error",
    "query": "// Author: Microsoft Azure\n// Display name: Servers with internal server error\n// Description: Show servers throwing internal server error.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Errors\n\nW3CIISLog\n| where scStatus == \"500\"  \n| summarize count() by sComputerName"
  },
  {
    "source": "AzureMonitor",
    "name": "Average HTTP request time by client IP",
    "query": "// Author: Microsoft Azure\n// Display name: Average HTTP request time by client IP\n// Description: Average HTTP request time by client IP address.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Performance\n\nW3CIISLog \n| summarize avg(TimeTaken) by cIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Average HTTP request time",
    "query": "// Author: Microsoft Azure\n// Display name: Average HTTP request time\n// Description: Average HTTP request time for HTTP method.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Performance\n\nW3CIISLog \n| summarize avg(TimeTaken) by csMethod"
  },
  {
    "source": "AzureMonitor",
    "name": "Maximum time taken for each page",
    "query": "// Author: Microsoft Azure\n// Display name: Maximum time taken for each page\n// Description: Find maximum time taken for each page.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Performance\n\nW3CIISLog \n| summarize max(TimeTaken) by csUriStem"
  },
  {
    "source": "AzureMonitor",
    "name": "Bytes received by each IIS computer",
    "query": "// Author: Microsoft Azure\n// Display name: Bytes received by each IIS computer\n// Description: Total bytes received by each IIS computer.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Usage\n\nW3CIISLog \n| summarize sum_csBytes = sum(csBytes) by Computer \n| top 500 by sum_csBytes desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Bytes responded to clients by each IIS server IP",
    "query": "// Author: Microsoft Azure\n// Display name: Bytes responded to clients by each IIS server IP\n// Description: Total bytes responded to clients by each IIS server IP address.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Usage\n\nW3CIISLog \n| summarize sum(scBytes) by sIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Count IIS log entries by HTTP user agent",
    "query": "// Author: Microsoft Azure\n// Display name: Count IIS log entries by HTTP user agent\n// Description: Count IIS log entries by HTTP user agent.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Usage\n\nW3CIISLog \n| summarize count() by csUserAgent"
  },
  {
    "source": "AzureMonitor",
    "name": "Total bytes traffic by client IP",
    "query": "// Author: Microsoft Azure\n// Display name: Total bytes traffic by client IP\n// Description: Total bytes sent and received by client IP address.\n// Categories: virtualmachines\n// Solutions: LogManagement\n// Topic: Usage\n\nW3CIISLog \n| summarize BytesSent = sum(csBytes), BytesReceived = sum(scBytes) by cIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed AS2 Messages by Receive Partner",
    "query": "// Author: Microsoft Azure\n// Display name: Failed AS2 Messages by Receive Partner\n// Description: Counts AS2 failed messages by receive partner.\n// Categories: resources\n// Solutions: LogicAppB2B\n// Topic: AS2 Message\n\nsearch OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"AS2Message\" and event_record_messageProperties_messageId_s in ((union *\n| where OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true or (event_recordType_s == \"AS2MDN\" and (iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true or event_record_messageProperties_statusCode_s == \"Rejected\"))\n| summarize AggregatedValue = count() by event_record_messageProperties_correlationMessageId_s))\n| summarize AggregatedValue = count() by event_record_agreementProperties_receiverPartnerName_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed AS2 Messages by Send Partner",
    "query": "// Author: Microsoft Azure\n// Display name: Failed AS2 Messages by Send Partner\n// Description: Counts AS2 failed messages by send partner.\n// Categories: resources\n// Solutions: LogicAppB2B\n// Topic: AS2 Message\n\nsearch OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"AS2Message\" and event_record_messageProperties_messageId_s in ((union *\n| where OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true or (event_recordType_s == \"AS2MDN\" and (iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true or event_record_messageProperties_statusCode_s == \"Rejected\"))\n| summarize AggregatedValue = count() by event_record_messageProperties_correlationMessageId_s))\n| summarize AggregatedValue = count() by event_record_agreementProperties_senderPartnerName_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed AS2 Messages by Workflow",
    "query": "// Author: Microsoft Azure\n// Display name: Failed AS2 Messages by Workflow\n// Description: Counts AS2 failed messages by workflow.\n// Categories: resources\n// Solutions: LogicAppB2B\n// Topic: AS2 Message\n\nsearch OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"AS2Message\" and event_record_messageProperties_messageId_s in ((union *\n| where OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true or (event_recordType_s == \"AS2MDN\" and (iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true or event_record_messageProperties_statusCode_s == \"Rejected\"))\n| summarize AggregatedValue = count() by event_record_messageProperties_correlationMessageId_s))\n| summarize AggregatedValue = count() by source_workflow_name_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed X12 Messages by Receive Partner",
    "query": "// Author: Microsoft Azure\n// Display name: Failed X12 Messages by Receive Partner\n// Description: Counts X12 failed messages by receive partner.\n// Categories: resources\n// Solutions: LogicAppB2B\n// Topic: X12 Message\n\nsearch OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSet\" and event_record_messageProperties_messageType_s != \"997\" and event_record_messageProperties_messageType_s != \"999\" and event_record_messageProperties_correlationMessageId_s in ((union *\n| where (OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSetAcknowledgment\" and event_record_messageProperties_statusCode_s != \"Accepted\" and event_record_messageProperties_direction_s == \"Receive\") or (OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSet\" and event_record_messageProperties_messageType_s != \"997\" and event_record_messageProperties_messageType_s != \"999\" and event_record_messageProperties_direction_s == \"Receive\" and iff(isnotnull(toint(event_record_messageProperties_isFunctionalAcknowledgmentExpected_b)), event_record_messageProperties_isFunctionalAcknowledgmentExpected_b == true, event_record_messageProperties_isFunctionalAcknowledgmentExpected_b == \"true\") == true and iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true)\n| summarize AggregatedValue = count() by event_record_messageProperties_correlationMessageId_s))\n| summarize AggregatedValue = count() by event_record_agreementProperties_receiverPartnerName_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed X12 Messages by Send Partner",
    "query": "// Author: Microsoft Azure\n// Display name: Failed X12 Messages by Send Partner\n// Description: Counts X12 failed messages by send partner.\n// Categories: resources\n// Solutions: LogicAppB2B\n// Topic: X12 Message\n\nsearch OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSet\" and event_record_messageProperties_messageType_s != \"997\" and event_record_messageProperties_messageType_s != \"999\" and event_record_messageProperties_correlationMessageId_s in ((union *\n| where (OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSetAcknowledgment\" and event_record_messageProperties_statusCode_s != \"Accepted\" and event_record_messageProperties_direction_s == \"Receive\") or (OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSet\" and event_record_messageProperties_messageType_s != \"997\" and event_record_messageProperties_messageType_s != \"999\" and event_record_messageProperties_direction_s == \"Receive\" and iff(isnotnull(toint(event_record_messageProperties_isFunctionalAcknowledgmentExpected_b)), event_record_messageProperties_isFunctionalAcknowledgmentExpected_b == true, event_record_messageProperties_isFunctionalAcknowledgmentExpected_b == \"true\") == true and iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true)\n| summarize AggregatedValue = count() by event_record_messageProperties_correlationMessageId_s))\n| summarize AggregatedValue = count() by event_record_agreementProperties_senderPartnerName_s"
  },
  {
    "source": "AzureMonitor",
    "name": "Failed X12 Messages by Workflow",
    "query": "// Author: Microsoft Azure\n// Display name: Failed X12 Messages by Workflow\n// Description: Counts X12 failed messages by workflow.\n// Categories: resources\n// Solutions: LogicAppB2B\n// Topic: X12 Message\n\nsearch OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSet\" and event_record_messageProperties_messageType_s != \"997\" and event_record_messageProperties_messageType_s != \"999\" and event_record_messageProperties_correlationMessageId_s in ((union *\n| where (OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSetAcknowledgment\" and event_record_messageProperties_statusCode_s != \"Accepted\" and event_record_messageProperties_direction_s == \"Receive\") or (OperationName == \"Microsoft.Logic/integrationAccounts/trackingEvents\" and event_recordType_s == \"X12TransactionSet\" and event_record_messageProperties_messageType_s != \"997\" and event_record_messageProperties_messageType_s != \"999\" and event_record_messageProperties_direction_s == \"Receive\" and iff(isnotnull(toint(event_record_messageProperties_isFunctionalAcknowledgmentExpected_b)), event_record_messageProperties_isFunctionalAcknowledgmentExpected_b == true, event_record_messageProperties_isFunctionalAcknowledgmentExpected_b == \"true\") == true and iff(isnotnull(toint(event_record_messageProperties_isMessageFailed_b)), event_record_messageProperties_isMessageFailed_b == true, event_record_messageProperties_isMessageFailed_b == \"true\") == true)\n| summarize AggregatedValue = count() by event_record_messageProperties_correlationMessageId_s))\n| summarize AggregatedValue = count() by source_workflow_name_s"
  },
  {
    "source": "AzureMonitor",
    "name": "How many times did each unique SQL Recommendation trigger",
    "query": "// Author: Microsoft Azure\n// Display name: How many times did each unique SQL Recommendation trigger?\n// Description: Count SQL recommendations with failed result by recommendation.\n// Categories: workloads\n// Solutions: SQLAssessment\n// Topic: Diagnostics\n\nSQLAssessmentRecommendation\n| where RecommendationResult == \"Failed\"\n| summarize AggregatedValue = count() by Recommendation"
  },
  {
    "source": "AzureMonitor",
    "name": "SQL Recommendations by AffectedObjectType",
    "query": "// Author: Microsoft Azure\n// Display name: SQL Recommendations by AffectedObjectType\n// Description: Count SQL recommendations with failed result by affected object type.\n// Categories: workloads\n// Solutions: SQLAssessment\n// Topic: Diagnostics\n\nSQLAssessmentRecommendation\n| where RecommendationResult == \"Failed\"\n| summarize AggregatedValue = count() by AffectedObjectType"
  },
  {
    "source": "AzureMonitor",
    "name": "SQL Recommendations by Computer",
    "query": "// Author: Microsoft Azure\n// Display name: SQL Recommendations by Computer\n// Description: Count SQL recommendations with failed result by computer.\n// Categories: workloads\n// Solutions: SQLAssessment\n// Topic: Diagnostics\n\nSQLAssessmentRecommendation\n| where RecommendationResult == \"Failed\"\n| summarize AggregatedValue = count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "SQL Recommendations by Database",
    "query": "// Author: Microsoft Azure\n// Display name: SQL Recommendations by Database\n// Description: Count SQL recommendations with failed result by database.\n// Categories: workloads\n// Solutions: SQLAssessment\n// Topic: Diagnostics\n\nSQLAssessmentRecommendation\n| where RecommendationResult == \"Failed\"\n| summarize AggregatedValue = count() by DatabaseName"
  },
  {
    "source": "AzureMonitor",
    "name": "SQL Recommendations by Focus Area",
    "query": "// Author: Microsoft Azure\n// Display name: SQL Recommendations by Focus Area\n// Description: Count all SQL reccomendations by focus area.\n// Categories: workloads\n// Solutions: SQLAssessment\n// Topic: Diagnostics\n\nSQLAssessmentRecommendation\n| summarize AggregatedValue = count() by FocusArea"
  },
  {
    "source": "AzureMonitor",
    "name": "SQL Recommendations by Instance",
    "query": "// Author: Microsoft Azure\n// Display name: SQL Recommendations by Instance\n// Description: Count SQL recommendations with failed result by instance.\n// Categories: workloads\n// Solutions: SQLAssessment\n// Topic: Diagnostics\n\nSQLAssessmentRecommendation\n| where RecommendationResult == \"Failed\"\n| summarize AggregatedValue = count() by SqlInstanceName"
  },
  {
    "source": "AzureMonitor",
    "name": "High priority SQL Assessment recommendations",
    "query": "// Author: Microsoft Azure\n// Display name: High priority SQL Assessment recommendations\n// Description: Latest high priority security recommendation with result failed by recommendation Id.\n// Categories: security\n// Solutions: SQLAssessment\n// Topic: Security\n\nSQLAssessmentRecommendation\n| where FocusArea == 'Security and Compliance' and RecommendationResult == 'Failed' and RecommendationScore\u003e=35\n| summarize arg_max(TimeGenerated, *) by RecommendationId"
  },
  {
    "source": "AzureMonitor",
    "name": "Accounts Who Terminated Microsoft Antimalware",
    "query": "// Author: Microsoft Azure\n// Display name: Accounts Who Terminated Microsoft Antimalware\n// Description: Accounts which terminated Microsoft Antimalware.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4689\n| where Process has \"MsMpEng.exe\" or ParentProcessName has \"MsMpEng.exe\"\n| summarize TerminationCount = count() by Account"
  },
  {
    "source": "AzureMonitor",
    "name": "All Security Activities",
    "query": "// Author: Microsoft Azure\n// Display name: All Security Activities\n// Description: Security activities sorted by time (newest first).\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| project TimeGenerated, Account, Activity, Computer\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Change or Reset Passwords Attempts",
    "query": "// Author: Microsoft Azure\n// Display name: Change or Reset Passwords Attempts\n// Description: Counts change/reset paswords attempts per target account.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID in (4723, 4724)\n| summarize count() by TargetAccount"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With Cleaned Event Logs",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With Cleaned Event Logs\n// Description: Computers with cleaned event logs.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID in (1102, 517) and EventSourceName == 'Microsoft-Windows-Eventlog'\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With Failed Linux User Password Change",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With Failed Linux User Password Change\n// Description: Lists computers wih failed Linux user password change.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSyslog\n| where Facility == 'authpriv' and ((SyslogMessage has 'passwd:chauthtok' and SyslogMessage has 'authentication failure') or SyslogMessage has 'password change failed')\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With New Linux Group Created",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With New Linux Group Created\n// Description: Lists computers with new Linux group created.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSyslog\n| where Facility == 'authpriv' and SyslogMessage has 'new group'\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With System Audit Policy Changes",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With System Audit Policy Changes\n// Description: System audit policy changed events by computer.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4719\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With Users Added to Linux Group",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With Users Added to Linux Group\n// Description: Lists computers with users added to Linux group.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSyslog\n| where Facility == 'authpriv' and SyslogMessage has 'to group' and (SyslogMessage has 'add' or SyslogMessage has 'added')\n| summarize by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Devices Where Hash Was Executed",
    "query": "// Author: Microsoft Azure\n// Display name: Devices Where Hash Was Executed\n// Description: Devices where hash.exe was executed more than 5 times.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4688\n| where Process has \"hash.exe\" or ParentProcessName has \"hash.exe\"\n| summarize ExecutionCount = count() by Computer\n| where ExecutionCount \u003e 5"
  },
  {
    "source": "AzureMonitor",
    "name": "Devices Where The Microsoft Antimalware Process Terminated",
    "query": "// Author: Microsoft Azure\n// Display name: Devices Where The Microsoft Antimalware Process Terminated\n// Description: Devices which terminated Microsoft Antimalware.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4689 \n| where Process has \"MsMpEng.exe\" or ParentProcessName has \"MsMpEng.exe\"\n| summarize TerminationCount = count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Devices With Security Log Cleared",
    "query": "// Author: Microsoft Azure\n// Display name: Devices With Security Log Cleared\n// Description: Devices with securtiy log cleared.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 1102\n| summarize LogClearedCount = count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Distinct Malicious IP Addresses Accessed",
    "query": "// Author: Microsoft Azure\n// Display name: Distinct Malicious IP Addresses Accessed\n// Description: Distinct malicious IP addresses accessed.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nunion isfuzzy=true (WireData\n| where Direction == 'Outbound'), (WindowsFirewall\n| where CommunicationDirection == 'SEND'), (CommonSecurityLog\n| where CommunicationDirection == 'Outbound')\n| where isnotempty(MaliciousIP)\n| summarize by MaliciousIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Domain Security Policy Changes",
    "query": "// Author: Microsoft Azure\n// Display name: Domain Security Policy Changes\n// Description: Counts events of domain policy changed.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4739\n| summarize count() by DomainPolicyChanged"
  },
  {
    "source": "AzureMonitor",
    "name": "Groups Created or Modified",
    "query": "// Author: Microsoft Azure\n// Display name: Groups Created or Modified\n// Description: Groups created or modified per target account.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID in (4727, 4731, 4735, 4737, 4754, 4755)\n| summarize count() by TargetAccount"
  },
  {
    "source": "AzureMonitor",
    "name": "Locked Accounts",
    "query": "// Author: Microsoft Azure\n// Display name: Locked Accounts\n// Description: Counts locked acounts by target account.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4740\n| summarize count() by TargetAccount"
  },
  {
    "source": "AzureMonitor",
    "name": "Members Added to Security Enabled Groups",
    "query": "// Author: Microsoft Azure\n// Display name: Members Added to Security Enabled Groups\n// Description: Members added to the security enabled groups.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID in (4728, 4732, 4756)\n| summarize count() by SubjectAccount"
  },
  {
    "source": "AzureMonitor",
    "name": "Process Names Executed",
    "query": "// Author: Microsoft Azure\n// Display name: Process Names Executed\n// Description: Lists number of executions per process.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 4688\n| summarize ExecutionCount = count() by NewProcessName"
  },
  {
    "source": "AzureMonitor",
    "name": "Remote Procedure Call Attempts",
    "query": "// Author: Microsoft Azure\n// Display name: Remote Procedure Call Attempts\n// Description: Counts remote procedure call attempts per computer.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 5712\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Security Activities on the Device for Admin",
    "query": "// Author: Microsoft Azure\n// Display name: Security Activities on the Device for Admin\n// Description: Security activities on a specific device for administrator sorted by time (newest first).\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent \n//| where Computer == \"COMPUTER01.contoso.com\"  // Replace with a specific computer name\n| where TargetUserName == \"Administrator\"\n| project TimeGenerated, Account, Activity, Computer\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Security Activities on the Device",
    "query": "// Author: Microsoft Azure\n// Display name: Security Activities on the Device\n// Description: Security activities on a specific device sorted by time (newest first).\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent \n//| where Computer == \"COMPUTER01.contoso.com\" // Replace with a specific computer name\n| project TimeGenerated, Account, Activity, Computer\n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Suspicious Executables",
    "query": "// Author: Microsoft Azure\n// Display name: Suspicious Executables\n// Description: Lists suspicious executables.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID == 8002 and Fqbn == '-'\n| summarize ExecutionCountHash=count() by FileHash\n| where ExecutionCountHash \u003c= 5"
  },
  {
    "source": "AzureMonitor",
    "name": "User Accounts Changed",
    "query": "// Author: Microsoft Azure\n// Display name: User Accounts Changed\n// Description: Counts user account changes per target account.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security\n\nSecurityEvent\n| where EventID in (4720, 4722)\n| summarize by TargetAccount"
  },
  {
    "source": "AzureMonitor",
    "name": "Accounts Failed to Logon",
    "query": "// Author: Microsoft Azure\n// Display name: Accounts Failed to Logon\n// Description: Counts failed logons by target account.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4625\n| summarize count() by TargetAccount"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With Failed Ssh Logons",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With Failed Ssh Logons\n// Description: Lists computers with failed ssh logons.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSyslog\n| where (Facility == 'authpriv' and SyslogMessage has 'sshd:auth' and SyslogMessage has 'authentication failure') or (Facility == 'auth' and ((SyslogMessage has 'Failed' and SyslogMessage has 'invalid user' and SyslogMessage has 'ssh2') or SyslogMessage has 'error: PAM: Authentication failure'))\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With Failed Su Logons",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With Failed Su Logons\n// Description: Lists computers with failed su logons.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSyslog\n| where (Facility == 'authpriv' and SyslogMessage has 'su:auth' and SyslogMessage has 'authentication failure') or (Facility == 'auth' and SyslogMessage has 'FAILED SU')\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With Failed Sudo Logons",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With Failed Sudo Logons\n// Description: Lists computers with failed sudo logons.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSyslog\n| where (Facility == 'authpriv' and SyslogMessage has 'sudo:auth' and (SyslogMessage has 'authentication failure' or SyslogMessage has 'conversation failed')) or ((Facility == 'auth' or Facility == 'authpriv') and SyslogMessage has 'user NOT in sudoers')\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Computers With Guest Account Logons",
    "query": "// Author: Microsoft Azure\n// Display name: Computers With Guest Account Logons\n// Description: Computers with logons from guest accounts.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4624 and TargetUserName == 'Guest' and LogonType in (10, 3)\n| summarize count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Logon Activity by Account",
    "query": "// Author: Microsoft Azure\n// Display name: Logon Activity by Account\n// Description: Logon activity by account.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4624\n| summarize LogonCount = count() by Account"
  },
  {
    "source": "AzureMonitor",
    "name": "Logon Activity by Device With More Than 10 Logons",
    "query": "// Author: Microsoft Azure\n// Display name: Logon Activity by Device With More Than 10 Logons\n// Description: Counts logon activities per devices with more than 10 logons.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4624\n| summarize LogonCount = count() by Computer\n| where LogonCount \u003e 10"
  },
  {
    "source": "AzureMonitor",
    "name": "Logon Activity by Device",
    "query": "// Author: Microsoft Azure\n// Display name: Logon Activity by Device\n// Description: Counts logon activities per device.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4624\n| summarize LogonCount = count() by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "Logon Activity for Users With 5 times Activity",
    "query": "// Author: Microsoft Azure\n// Display name: Logon Activity for Users With 5 times Activity\n// Description: Logon activity for accounts with less than 5 logons.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4624\n| summarize LogonCount = count() by Account\n| where LogonCount \u003c 5"
  },
  {
    "source": "AzureMonitor",
    "name": "Logons With Clear Text Password",
    "query": "// Author: Microsoft Azure\n// Display name: Logons With Clear Text Password\n// Description: Logons with clear text password by target account.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4624 and LogonType == 8\n| summarize count() by TargetAccount"
  },
  {
    "source": "AzureMonitor",
    "name": "Remoted Logged Accounts on Devices",
    "query": "// Author: Microsoft Azure\n// Display name: Remoted Logged Accounts on Devices\n// Description: Remoted logged accounts on a specific device.\n// Categories: security\n// Solutions: SecurityInsights\n// Topic: Security logon\n\nSecurityEvent\n| where EventID == 4624 and (LogonTypeName == \"3 - Network\" or LogonTypeName == \"10 - RemoteInteractive\")\n//| where Computer == \"Computer01.contoso.com\" // Replace with a specific computer name\n| summarize RemoteLogonCount = count() by Account"
  },
  {
    "source": "AzureMonitor",
    "name": "All incidents created today",
    "query": "// Author: Microsoft Azure\n// Display name: All incidents created today\n// Description: Retrieves all Incident work items generated in this solution during the last day.\n// Categories: management\n// Solutions: ServiceDesk\n// Topic: Usage\n\nServiceDesk_CL\n|where  ServiceDeskWorkItemType_s == \"Incident\" and CreatedDate_t \u003e bin(now(), 1d) \n| summarize arg_max(TimeGenerated, *) by ServiceDeskId_s \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "All incidents",
    "query": "// Author: Microsoft Azure\n// Display name: All incidents\n// Description: Retrieves all Incident work items generated in this solution.\n// Categories: management\n// Solutions: ServiceDesk\n// Topic: Usage\n\nServiceDesk_CL\n| where  ServiceDeskWorkItemType_s == \"Incident\" \n| summarize arg_max(TimeGenerated, *) by ServiceDeskId_s \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "All security incidents",
    "query": "// Author: Microsoft Azure\n// Display name: All security incidents\n// Description: Retrieves all Security Incident work items generated in this solution.\n// Categories: management\n// Solutions: ServiceDesk\n// Topic: Usage\n\nServiceDesk_CL\n| where  ServiceDeskWorkItemType_s == \"SecurityIncident\" \n| summarize arg_max(TimeGenerated, *) by ServiceDeskId_s \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "All work items created today",
    "query": "// Author: Microsoft Azure\n// Display name: All work items created today\n// Description: Retrieves all work items generated in this solution during the last day.\n// Categories: management\n// Solutions: ServiceDesk\n// Topic: Usage\n\nServiceDesk_CL\n| where  CreatedDate_t \u003e bin(now(), 1d) \n| summarize arg_max(TimeGenerated, *) by ServiceDeskId_s \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "All work items",
    "query": "// Author: Microsoft Azure\n// Display name: All work items\n// Description: Retrieves all work items generated in this solution.\n// Categories: management\n// Solutions: ServiceDesk\n// Topic: Usage\n\nServiceDesk_CL\n| summarize arg_max(TimeGenerated, *) by ServiceDeskId_s \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Hardware Alert",
    "query": "// Author: Microsoft Azure\n// Display name: Hardware Alert\n// Description: SurfaceHubHardwareAlert.\n// Categories: workloads\n// Solutions: SurfaceHub\n// Topic: Diagnostics\n\nDeviceHardwareHealth\n|where EventName == \"CameraInUnexpectedState\" or EventName == \"WiredIngestInUnexpectedState\" or EventName == \"WiredTouchInUnexpectedState\" or EventName == \"WifiDirectInUnexpectedState\" or EventName == \"MicInUnexpectedState\" or EventName == \"WiredTouchInUnexpectedState\" or EventName == \"SpeakersInUnexpectedState\" or EventName == \"WirelessCardInUnexpectedState\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Hardware Minor",
    "query": "// Author: Microsoft Azure\n// Display name: Hardware Minor\n// Description: SurfaceHub hardware minor.\n// Categories: workloads\n// Solutions: SurfaceHub\n// Topic: Diagnostics\n\nDeviceHardwareHealth \n|where EventName != \"CameraInUnexpectedState\" and EventName != \"WiredIngestInUnexpectedState\" and EventName != \"WiredTouchInUnexpectedState\" and EventName != \"WifiDirectInUnexpectedState\" and EventName != \"MicInUnexpectedState\" and EventName != \"WiredTouchInUnexpectedState\" and EventName != \"SpeakersInUnexpectedState\" and EventName != \"WirelessCardInUnexpectedState\" \n| sort by TimeGenerated des"
  },
  {
    "source": "AzureMonitor",
    "name": "Cleanup Failure",
    "query": "// Author: Microsoft Azure\n// Display name: Cleanup Failure\n// Description: SurfaceHub cleanup failure.\n// Categories: workloads\n// Solutions: SurfaceHub\n// Topic: Error\n\nDeviceCleanup\n| where State == \"Fatal\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Exchange Error",
    "query": "// Author: Microsoft Azure\n// Display name: Exchange Error\n// Description: SurfaceHub Exchange error.\n// Categories: workloads\n// Solutions: SurfaceHub\n// Topic: Error\n\nDeviceCalendar\n| where EventName == \"activesynchealth\" and SyncStatus != \"Healthy\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Skype Error",
    "query": "// Author: Microsoft Azure\n// Display name: Skype Error\n// Description: SurfaceHub Skype error.\n// Categories: workloads\n// Solutions: SurfaceHub\n// Topic: Error\n\nDeviceSkypeHeartbeat\n| where State == \"Unhealthy\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Software Alert",
    "query": "// Author: Microsoft Azure\n// Display name: Software Alert\n// Description: SurfaceHub software error.\n// Categories: workloads\n// Solutions: SurfaceHub\n// Topic: Error\n\nDeviceHealth\n| where EventName == \"CriticalProcessStatus\" and State == \"Unhealthy\" \n| sort by TimeGenerated desc"
  },
  {
    "source": "AzureMonitor",
    "name": "Devices pending reboot to complete update",
    "query": "// Author: Microsoft Azure\n// Display name: Devices pending reboot to complete update\n// Description: Devices with pending reboot to complete update.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSDeploymentStatus\n| where DetailedStatus == \"Reboot pending\"\n| summarize arg_max(TimeGenerated, *) by ComputerID, UpdateClassification\n| project Computer, ComputerID, DetailedStatus, ReleaseName, UpdateCategory, UpdateClassification, LastScan"
  },
  {
    "source": "AzureMonitor",
    "name": "Distribution of device OS Edition",
    "query": "// Author: Microsoft Azure\n// Display name: Distribution of device OS Edition\n// Description: Counts devices by OS edition.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSUpdateStatus\n| summarize arg_max(TimeGenerated, *) by ComputerID\n| project TimeGenerated, ComputerID, OSEdition\n| summarize dcount(ComputerID) by OSEdition"
  },
  {
    "source": "AzureMonitor",
    "name": "Distribution of device Servicing Branch",
    "query": "// Author: Microsoft Azure\n// Display name: Distribution of device Servicing Branch\n// Description: Pie chart of devices distribution by servicing branch.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSUpdateStatus\n| summarize arg_max(TimeGenerated, *) by ComputerID\n| project ComputerID, OSServicingBranch\n| summarize dcount(ComputerID) by OSServicingBranch\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Feature Update Deferral Configurations",
    "query": "// Author: Microsoft Azure\n// Display name: Feature Update Deferral Configurations\n// Description: Chart of device count by feature update deferral configurations.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSUpdateStatus\n| summarize arg_max(TimeGenerated, *) by ComputerID\n| project TimeGenerated, ComputerID, FeatureDeferralDays\n| summarize dcount(ComputerID) by FeatureDeferralDays\n| sort by FeatureDeferralDays asc\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Feature Update Pause Configurations",
    "query": "// Author: Microsoft Azure\n// Display name: Feature Update Pause Configurations\n// Description: Count devices by feature update pause configurations.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSUpdateStatus\n| summarize arg_max(TimeGenerated, *) by ComputerID\n| project TimeGenerated, ComputerID, FeaturePauseState\n| summarize dcount(ComputerID) by FeaturePauseState"
  },
  {
    "source": "AzureMonitor",
    "name": "Quality Update Deferral Configurations",
    "query": "// Author: Microsoft Azure\n// Display name: Quality Update Deferral Configurations\n// Description: Chart of device count by quality update deferral configurations.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSUpdateStatus\n| summarize arg_max(TimeGenerated, *) by ComputerID\n| project TimeGenerated, ComputerID, QualityDeferralDays\n| summarize dcount(ComputerID) by QualityDeferralDays\n| sort by QualityDeferralDays asc\n| render columnchart"
  },
  {
    "source": "AzureMonitor",
    "name": "Quality Update Pause Configurations",
    "query": "// Author: Microsoft Azure\n// Display name: Quality Update Pause Configurations\n// Description: Count devices by quality update pause configurations.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSUpdateStatus\n| summarize arg_max(TimeGenerated, *) by ComputerID\n| project TimeGenerated, ComputerID, QualityPauseState\n| summarize dcount(ComputerID) by QualityPauseState"
  },
  {
    "source": "AzureMonitor",
    "name": "Update deployment failures",
    "query": "// Author: Microsoft Azure\n// Display name: Update deployment failures\n// Description: Update deployment failures by device and update classification.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Diagnostics\n\nWaaSDeploymentStatus\n| where DeploymentStatus == \"Failed\"\n| summarize arg_max(TimeGenerated, *) by ComputerID, UpdateClassification \n| project Computer, ComputerID, ReleaseName, UpdateCategory, UpdateClassification, DeploymentError, DeploymentErrorCode"
  },
  {
    "source": "AzureMonitor",
    "name": "Devices with a Safeguard Hold",
    "query": "// Author: Microsoft Azure\n// Display name: Devices with a Safeguard Hold\n// Description: This query shows the device data for all devices that are impacted by safeguard holds.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Errors\n\nWaaSDeploymentStatus\n| where DetailedStatus == \"Safeguard Hold\"\n| summarize arg_max(TimeGenerated, *) by ComputerID, UpdateClassification\n| project TimeGenerated, DetailedStatus, ComputerID, ReleaseName, UpdateCategory, UpdateClassification"
  },
  {
    "source": "AzureMonitor",
    "name": "Target build distribution of devices with a safeguard hold",
    "query": "// Author: Microsoft Azure\n// Display name: Target build distribution of devices with a safeguard hold\n// Description: Pie chart of target build distribution of devices impacted by safeguards.\n// Categories: desktopanalytics\n// Solutions: WaaSUpdateInsights\n// Topic: Errors\n\nWaaSDeploymentStatus\n| where DetailedStatus == \"Safeguard Hold\"\n| summarize count(ComputerID) by TargetBuild\n| render piechart"
  },
  {
    "source": "AzureMonitor",
    "name": "Agents that provide wire data",
    "query": "// Author: Microsoft Azure\n// Display name: Agents that provide wire data\n// Description: Agents providing wire data and sum of total bytes for each agent.\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| summarize sum(TotalBytes) by Computer"
  },
  {
    "source": "AzureMonitor",
    "name": "All Outbound communications by Remote IP Address",
    "query": "// Author: Microsoft Azure\n// Display name: All Outbound communications by Remote IP Address\n// Description: All Outbound communications by Remote IP Address.\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| where  Direction == \"Outbound\"\n| summarize count() by RemoteIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Amount of Network Traffic by Process",
    "query": "// Author: Microsoft Azure\n// Display name: Amount of Network Traffic by Process\n// Description: Amount of Network Traffic (in Bytes) by Process.\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| summarize sum(TotalBytes) by ProcessName"
  },
  {
    "source": "AzureMonitor",
    "name": "Bytes received by Protocol Name",
    "query": "// Author: Microsoft Azure\n// Display name: Bytes received by Protocol Name\n// Description: Bytes received by Protocol Name (transport-level protocol, only some are recognized).\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| where Direction == \"Inbound\"\n| summarize sum(ReceivedBytes) by ProtocolName"
  },
  {
    "source": "AzureMonitor",
    "name": "Bytes sent by Application Protocol",
    "query": "// Author: Microsoft Azure\n// Display name: Bytes sent by Application Protocol\n// Description: Bytes sent by Application Protocol.\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| where Direction == \"Outbound\"\n| summarize sum(SentBytes) by ApplicationProtocol"
  },
  {
    "source": "AzureMonitor",
    "name": "IP Addresses of the agents providing wire data",
    "query": "// Author: Microsoft Azure\n// Display name: IP Addresses of the agents providing wire data\n// Description: IP Addresses of the agents providing wire data.\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| summarize count() by LocalIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Processes that initiated or received network traffic",
    "query": "// Author: Microsoft Azure\n// Display name: Processes that initiated or received network traffic\n// Description: Processes that initiated or received network traffic.\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| distinct ProcessName"
  },
  {
    "source": "AzureMonitor",
    "name": "Remote IP addresses that have communicated with agents on the subnet 100008 any direction",
    "query": "// Author: Microsoft Azure\n// Display name: Remote IP addresses that have communicated with agents on the subnet '10.0.0.0/8' (any direction)\n// Description: Remote IP addresses that have communicated with agents on the subnet '10.0.0.0/8' (any direction).\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData  \n| where LocalSubnet == \"10.0.0.0/8\" \n| summarize count() by RemoteIP"
  },
  {
    "source": "AzureMonitor",
    "name": "Total bytes by IP version",
    "query": "// Author: Microsoft Azure\n// Display name: Total bytes by IP version\n// Description: Total bytes by IP version (IPv4 or IPv6).\n// Categories: virtualmachines\n// Solutions: WireData2\n// Topic: Diagnostics\n\nWireData\n| summarize sum(TotalBytes) by IPVersion"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit - Show OperationName and OperationCount",
    "query": "// Show OperationName and OperationCount\r\n// See here: https://github.com/rod-trent/SentinelKQL/blob/master/IntuneActivityTypes.txt\r\nIntuneAuditLogs\r\n| summarize OperationCount=count() by OperationName \r\n| sort by OperationNumberdesc"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ChangesinConfigurationProfiles",
    "query": "IntuneAuditLogs\n| where OperationName contains \"patch\"\n| extend User = todynamic(Properties).Actor.UPN\n| extend Apps = todynamic(Properties).Actor.ApplicationName\n| extend Device = todynamic(Properties).TargetObjectIds\n//| extend Policy = todynamic(Properties).TargetDisplayNames\n| extend Policy = replace_regex(tostring(todynamic(Properties).TargetDisplayNames), @'[\"\\[\\]]', \"\")\n| mv-expand todynamic(Properties).Targets[0].ModifiedProperties\n| extend Configuration = todynamic(Properties_Targets_0_ModifiedProperties).Name\n| extend ['New Value'] = todynamic(Properties_Targets_0_ModifiedProperties).New\n| extend ['Old Value'] = todynamic(Properties_Targets_0_ModifiedProperties).Old\n| project TimeGenerated, Policy, Configuration, ['New Value'], ['Old Value'], User"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-DeletedDevices",
    "query": "IntuneAuditLogs\n| where OperationName contains \"Delete Manageddevice\"\n| extend User = todynamic(Properties).Actor.UPN\n| extend Application = todynamic(Properties).Actor.ApplicationName\n| extend Device = replace_regex(tostring(todynamic(Properties).TargetObjectIds), @'[\"\\[\\]]', \"\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-NumberOfDeviceWipesAndDeletions",
    "query": "Description: \nShows the Number of device Wipes and Deletions Actions in Intune.\n\nQuery:\n\nIntuneAuditLogs\n| where TimeGenerated \u003e ago(30d)\n| where OperationName contains \"Wipe\" or OperationName contains \"Delete\"\n| extend OperationType = iif(OperationName contains \"Wipe\", \"Wipe\", \"Delete\")\n| summarize Count = count() by OperationType"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ShowClientCertificates",
    "query": "// Show client certificates that have been created, changed or deleted in Intune and who initiated that.\r\nIntuneAuditLogs\r\n| where OperationName has \"ClientCertificate\"\r\n| extend User = tostring(todynamic(Properties).Actor.UPN)\r\n| extend DeviceId = tostring(todynamic(Properties).TargetObjectIds[0])\r\n| join kind=leftouter IntuneDevices on DeviceId // DeviceName from IntuneDevices\r\n| distinct TimeGenerated, User, DeviceName, OperationName\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ShowDeletedDevices",
    "query": "// Show devices that have been deleted from Intune and who initiated that.\r\nIntuneAuditLogs\r\n| where OperationName has \"Delete ManagedDevice\"\r\n| extend User = tostring(todynamic(Properties).Actor.UPN)\r\n| extend DeviceId = tostring(todynamic(Properties).TargetObjectIds[0])\r\n| join kind=leftouter IntuneDevices on DeviceId // DeviceName from IntuneDevices\r\n| distinct TimeGenerated, User, DeviceName\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ShowEnableLostModeDevices",
    "query": "// Show devices for which the enableLostMode was activated and who initiated that.\r\nIntuneAuditLogs\r\n| where OperationName has \"enableLostMode\"\r\n| extend User = tostring(todynamic(Properties).Actor.UPN)\r\n| extend DeviceId = tostring(todynamic(Properties).TargetObjectIds[0])\r\n| join kind=leftouter IntuneDevices on DeviceId // DeviceName from IntuneDevices\r\n| distinct TimeGenerated, User, DeviceName\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ShowFeatureUpdatePolicies",
    "query": "// Show changes to Feature Update Policies and who created or changed them.\r\nIntuneAuditLogs\r\n| where OperationName has \"WindowsFeatureUpdateProfile\"\r\n| extend User = todynamic(Properties).Actor.UPN\r\n| extend ['Name of Policy'] = todynamic(Properties).TargetDisplayNames[0]\r\n| extend Changes = todynamic(Properties).Targets[0].ModifiedProperties[0].Name\r\n| project ['Name of Policy'], Changes, User"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ShowLocatedDevices",
    "query": "// Show Devices for which the option â€œLocate Deviceâ€œ was used.\r\nIntuneAuditLogs\r\n| where OperationName has \"locateDevice\"\r\n| extend User = tostring(todynamic(Properties).Actor.UPN)\r\n| extend DeviceId = tostring(todynamic(Properties).TargetObjectIds[0])\r\n| join kind=leftouter IntuneDevices on DeviceId // DeviceName from IntuneDevices\r\n| distinct TimeGenerated, User, DeviceName\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ShowRemoteLockedDevices",
    "query": "// Show devices that have been remote locked and who initiated that.\r\nIntuneAuditLogs\r\n| where OperationName has \"remoteLock\"\r\n| extend User = todynamic(Properties).Actor.UPN\r\n| extend IntuneDeviceID = todynamic(Properties).TargetObjectIds[0]\r\n| project TimeGenerated, IntuneDeviceID, User\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-ShowWhatActionstookplacefromwhichAppOrUser",
    "query": "// Audit Actions\r\nIntuneAuditLogs\r\n| parse Properties with * ',\"TargetDisplayNames\":[\"' Object '\"],' *\r\n| where Object != \"\"\r\n| extend User = todynamic(Properties).Actor.UPN\r\n| extend ['Azure Application'] = todynamic(Properties).Actor.ApplicationName\r\n| extend DeviceID = replace_regex(tostring(todynamic(Properties).TargetObjectIds), @'[\"\\[\\]]', \"\")\r\n| project OperationName, DeviceID, ['Task'] = Object, ['Azure Application'], User"
  },
  {
    "source": "KQL_Intune",
    "name": "Audit-WipedDevices",
    "query": "// Show a list of Devices that have recieved the Wipe command in Intune and also display who or which application has wiped a device.\nIntuneAuditLogs\n| where OperationName contains \"wipe\"\n| extend User = todynamic(Properties).Actor.UPN // Show the user (initiator) if present.\n| extend Application = todynamic(Properties).Actor.ApplicationName // Show the application (initiator) if present.\n| extend Device = replace_regex(tostring(todynamic(Properties).TargetObjectIds), @'[\"\\[\\]]', \"\") // Show target device."
  },
  {
    "source": "KQL_Intune",
    "name": "Compliance - Intune devices that are compliant with OS, OS Version",
    "query": "// Intune devices that are compliant with OS, OS Version, and number of devices\r\n// See here: https://github.com/rod-trent/SentinelKQL/blob/master/IntuneisCompliantByOSandOSVersion.txt\r\nIntuneDeviceComplianceOrg \r\n| where isnotempty(DeviceName)\r\n| where ComplianceState == \"Compliant\"\r\n| summarize count() by OSDescription, OSVersion"
  },
  {
    "source": "KQL_Intune",
    "name": "Compliance - List of Devices that have DeviceHealthThreatLevel Status of Secured",
    "query": "// List of Devices that have DeviceHealthThreatLevel Status of Secured\r\nIntuneDeviceComplianceOrg\r\n| where isnotempty(DeviceHealthThreatLevel)\r\n| where DeviceHealthThreatLevel == \"Secured\"\r\n| project DeviceName, UserName , DeviceHealthThreatLevel"
  },
  {
    "source": "KQL_Intune",
    "name": "Compliance-NotcompliantDevices",
    "query": "IntuneDeviceComplianceOrg\n| where todatetime(LastContact) \u003e ago(30d)\n| where ComplianceState == \"Not compliant\"\n| summarize arg_max(TimeGenerated, *) by DeviceName\n| project ComplianceState, DeviceName, LastContact"
  },
  {
    "source": "KQL_Intune",
    "name": "Compliance-NumberAndListOfCompanyOwnedDevicesWithComplianceStatus",
    "query": "// Count of Company owned Devices that are Compliant or Not compliant\r\nIntuneDeviceComplianceOrg\r\n| where todatetime(LastContact) \u003e ago(30d)\r\n| where ComplianceState == \"Not compliant\" // Change to \"Compliant\" if you want to count only Compliant Devices\r\n| where OwnerType == \"Company\"\r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| project ComplianceState, DeviceName, LastContact\r\n| summarize count(DeviceName)\r\n\r\n// Create a List with all devices:\r\nIntuneDeviceComplianceOrg\r\n| where todatetime(LastContact) \u003e ago(30d)\r\n| where ComplianceState == \"Not compliant\" // Change to \"Compliant\" if you want to count only Compliant Devices\r\n| where OwnerType == \"Company\"\r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| project ComplianceState, DeviceName, LastContact, OS"
  },
  {
    "source": "KQL_Intune",
    "name": "Compliance-NumberOfActiveDevicesInTheLast7And30Days",
    "query": "let Monthly = \nIntuneDeviceComplianceOrg\n| where todatetime(LastContact) \u003e ago(30d)\n| summarize arg_max(TimeGenerated, *) by DeviceName\n| summarize count(DeviceName)\n| extend CustomName=\"Active Devices\"\n| extend MonthlyCount=count_DeviceName;\nlet Weekly=\nIntuneDeviceComplianceOrg\n| where todatetime(LastContact) \u003e ago(7d)\n| summarize arg_max(TimeGenerated, *) by DeviceName\n| summarize count(DeviceName)\n| extend CustomName=\"Active Devices\"\n| extend WeeklyCount=count_DeviceName;\nMonthly\n| join kind=inner Weekly on CustomName\n| project-rename ['Last 30 Days']=MonthlyCount, ['Last 7 Days'] = WeeklyCount, Description=CustomName\n| project Description,['Last 7 Days'],['Last 30 Days']"
  },
  {
    "source": "KQL_Intune",
    "name": "Compliance-NumberOfCompanyOwnedDevicesThatAreCompliantOrNotCompliant",
    "query": "// Number of Company owned Devices that are Compliant or Not Compliant summarized by OS Platform\r\nlet notcompliant =\r\n    IntuneDeviceComplianceOrg\r\n    | where ComplianceState == \"Not compliant\"\r\n    | where OwnerType == \"Company\"\r\n    | where OSDescription != \"\"\r\n    | summarize arg_max(TimeGenerated, *) by DeviceName\r\n    | project ComplianceState, DeviceName, LastContact, OSDescription, OS\r\n    | summarize count(DeviceName) by OSDescription;\r\nlet compliant =\r\n    IntuneDeviceComplianceOrg\r\n    | where ComplianceState == \"Compliant\"\r\n    | where OwnerType == \"Company\"\r\n    | where OSDescription != \"\"\r\n    | summarize arg_max(TimeGenerated, *) by DeviceName\r\n    | project ComplianceState, DeviceName, LastContact, OSDescription, OS\r\n    | summarize count(DeviceName) by OSDescription;\r\nnotcompliant\r\n| join kind=inner compliant on OSDescription\r\n| project-rename\r\n    [\"Compliant\"]=count_DeviceName1,\r\n    [\"Not Compliant\"]=count_DeviceName,\r\n    [\"Platform\"]=OSDescription\r\n| project [\"Platform\"], [\"Compliant\"], [\"Not Compliant\"]\r\n| sort by Compliant desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Compliance-NumberofDeviceswithDeviceHealthThreatLevelStatus",
    "query": "// Number of Devices with DeviceHealthThreatLevel Status\r\nlet secured =\r\nIntuneDeviceComplianceOrg\r\n| where isnotempty(DeviceHealthThreatLevel)\r\n| where DeviceHealthThreatLevel == \"Secured\"\r\n| distinct DeviceName, UserName , DeviceHealthThreatLevel\r\n| summarize count(DeviceName)\r\n| extend ['Number of Devices'] = count_DeviceName\r\n| extend Status = \"Secured\";\r\nlet notsecured =\r\nIntuneDeviceComplianceOrg\r\n| where isnotempty(DeviceHealthThreatLevel)\r\n| where DeviceHealthThreatLevel == \"Not Secured\"\r\n| distinct  DeviceName, UserName , DeviceHealthThreatLevel\r\n| summarize count(DeviceName)\r\n| extend ['Number of Devices'] = count_DeviceName\r\n| extend Status = \"Not Secured\";\r\nlet unknown =\r\nIntuneDeviceComplianceOrg\r\n| where isnotempty(DeviceHealthThreatLevel)\r\n| where DeviceHealthThreatLevel == \"Unknown\"\r\n| distinct  DeviceName, UserName , DeviceHealthThreatLevel\r\n| summarize count(DeviceName)\r\n| extend ['Number of Devices'] = count_DeviceName\r\n| extend Status = \"Unknown\";\r\nsecured\r\n| union notsecured, unknown\r\n| project Status, ['Number of Devices']\r\n| sort by ['Number of Devices']"
  },
  {
    "source": "KQL_Intune",
    "name": "Device - Translate OS Build to Version",
    "query": "IntuneDevices\n| where OS contains \"Windows\"\n| summarize arg_max(TimeGenerated, *) by DeviceName\n| where todatetime(LastContact) \u003e ago(30d) \n| extend WindowsVersion = case(OSVersion contains '19041', \"20H1\", \n                                OSVersion contains '19042', \"20H2\",    \n                                OSVersion contains '19043', \"21H1\", \n                                OSVersion contains '19044', \"21H2\",\n                                OSVersion contains '18363', \"1909\",\n                                OSVersion contains '22000', \"Win11 21H2\",\n                                \"Unknown\")\n| summarize Count=count() by OSVersion, WindowsVersion\n| sort by Count desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Device - Visualize device compliance",
    "query": "// Visualize device compliance (compliant, non-compliant, managed by Config Manager, not evaluated or in grace period) per week over time\r\nIntuneDevices\r\n| where TimeGenerated \u003e ago (30d)\r\n| summarize arg_max(DeviceName, *) by DeviceName\r\n| where isnotempty(CompliantState)\r\n| summarize ComplianceCount=count()by CompliantState\r\n| render piechart \r\n    with (title=\"Device compliance\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-CompareOSBuildTodayAndYesterday",
    "query": "// Compare OS Version changes between yesterday and today. It will calculate the difference (number of devices) between two days.\nlet Yesterday=\nIntuneDevices\n| where TimeGenerated \u003c ago(1d) \n| summarize arg_max(TimeGenerated, *) by DeviceName\n| where todatetime(LastContact) \u003e ago(30d) \n| summarize count() by OSVersion\n| sort by OSVersion desc\n| extend CustomName = OSVersion\n| extend Version_Yesterday = count_;\nlet Today=\nIntuneDevices \n| summarize arg_max(TimeGenerated, *) by DeviceName\n| where todatetime(LastContact) \u003e ago(30d) \n| summarize count() by OSVersion\n| sort by OSVersion desc\n| extend CustomName = OSVersion\n| extend Version_Today = count_;\nYesterday\n| join kind=inner Today on OSVersion\n| project CustomName, Version_Today, Version_Yesterday, Difference = Version_Today-Version_Yesterday\n| sort by CustomName desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-CountdownEndofLife21H1",
    "query": "// Show the number of windows devices on 21H1, the date of EOL for 21H1 as well as a countdown in days.\r\nIntuneDevices \r\n| where OS has \"Windows\"\r\n| extend Build = split(OSVersion, \".\")[2]\r\n| where Build contains \"19043\"\r\n| where SkuFamily == \"Enterprise\"\r\n| summarize count(DeviceName) by tostring(Build)\r\n| extend ['21H1 Enterprise - End of servicing'] = todatetime('2022-12-13')\r\n| extend ['Countdown in Days'] = datetime_diff('day', now(), ['21H1 Enterprise - End of servicing'])"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-DevicesAndPrimaryUser",
    "query": "// List of Devices and the assigned PrimaryUser. Filtering devices without a PrimaryUser.\r\nIntuneDevices\r\n//| where OS == \"Windows\"\r\n| where PrimaryUser !startswith \"000000\"\r\n| project DeviceName, PrimaryUser"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-DevicesRegisteredButNotManagedByIntune",
    "query": "// Devices that are registered in Intune but not managed by it. Also shows User and Device Name as well when it was registered Intune.\r\nIntuneDevices \r\n| where DeviceState != \"Managed\"\r\n| where SourceSystem == \"Microsoft Intune\"\r\n| distinct UserName, DeviceName, SerialNumber, ['Joined Intune Date:'] = CreatedDate, JoinType"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-DevicesWithoutPrimaryUser",
    "query": "// List of Devices with no PrimaryUser\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where PrimaryUser startswith \"000000\"\r\n| project DeviceName, PrimaryUser"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-EndofLife",
    "query": "// Show EOL Dates and the number of devices effected for Win 11 21H2, Win 10 21H2, 21H1 and also 20H2.\r\nlet Windows11_21H2 =\r\n    IntuneDevices \r\n    | where OS has \"Windows\"\r\n    | extend Build = split(OSVersion, \".\")[2]\r\n    | where Build contains \"22000\"\r\n    | summarize count(DeviceName) by tostring(Build)\r\n    | extend ['Win11_21H2 Home, Pro - End of servicing'] = \"2023-10-10\" \r\n    | extend ['Win11_21H2 Enterprise - End of servicing'] = \"2024-10-08\" \r\n    | extend CustomName=\"Number of Devices\";\r\nlet 21H2 =\r\n    IntuneDevices \r\n    | where OS has \"Windows\"\r\n    | extend Build = split(OSVersion, \".\")[2]\r\n    | where Build contains \"19044\"\r\n    | summarize count(DeviceName) by tostring(Build)\r\n    | extend ['21H2 Home, Pro - End of servicing'] = \"2023-06-13\" \r\n    | extend ['21H2 Enterprise - End of servicing'] = \"2024-06-11\" \r\n    | extend CustomName=\"Number of Devices\";\r\nlet 21H1 =\r\n    IntuneDevices \r\n    | where OS has \"Windows\"\r\n    | extend Build = split(OSVersion, \".\")[2]\r\n    | where Build contains \"19043\"\r\n    | summarize count(DeviceName) by tostring(Build)\r\n    | extend ['21H1 Home, Pro - End of servicing'] = \"2022-12-13\" \r\n    | extend ['21H1 Enterprise - End of servicing'] = \"2022-12-13\" \r\n    | extend CustomName=\"Number of Devices\";\r\nlet 20H2 =\r\n    IntuneDevices \r\n    | where OS has \"Windows\"\r\n    | extend Build = split(OSVersion, \".\")[2]\r\n    | where Build contains \"19042\"\r\n    | summarize count(DeviceName) by tostring(Build)\r\n    | extend ['20H2 Home, Pro - End of servicing'] = \"End of servicing\" \r\n    | extend ['20H2 Enterprise - End of servicing'] = \"2023-05-09\" \r\n    | extend CustomName=\"Number of Devices\";\r\n21H2\r\n| join kind=inner 21H1 on CustomName\r\n| join kind=inner 20H2 on CustomName\r\n| join kind=inner Windows11_21H2 on CustomName\r\n| project \r\n    ['Number of Devices with 21H2'] = count_DeviceName, ['21H2 Home, Pro - End of servicing'], ['21H2 Enterprise - End of servicing'],\r\n    ['Number of Devices with 21H1'] = count_DeviceName1, ['21H1 Home, Pro - End of servicing'], ['21H1 Enterprise - End of servicing'],\r\n    ['Number of Devices with 20H2'] = count_DeviceName2,  ['20H2 Home, Pro - End of servicing'], ['20H2 Enterprise - End of servicing'],\r\n    ['Number of Devices with Win11_21H2'] = count_DeviceName3, ['Win11_21H2 Home, Pro - End of servicing'], ['Win11_21H2 Enterprise - End of servicing']"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-FreeStorage",
    "query": "// Show the percentage of free storage on devices\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where StorageFree != \"0\" and StorageTotal != \"0\"\r\n| where DeviceName != \"User deleted for this device\" and DeviceName != \"\"\r\n| extend ['Free Storage'] = StorageFree\r\n| extend ['Total Storage'] = StorageTotal\r\n| extend Percentage = round(todouble(StorageFree) * 100 / todouble(StorageTotal), 2)\r\n| distinct DeviceName, ['Free Storage'], ['Total Storage'], Percentage, UPN\r\n| sort by Percentage asc"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-JoinTypes",
    "query": "// Show all devices and Join Types\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where isnotempty(JoinType)\r\n| distinct JoinType, DeviceName, DeviceRegistrationState\r\n\r\n// Show only Hybrid Azure AD Joined Devices:\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where isnotempty(JoinType)\r\n| where JoinType has \"Hybrid\" \r\n| distinct JoinType, DeviceName, DeviceRegistrationState\r\n\r\n// Show only Azure AD Joined Devices:\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where isnotempty(JoinType)\r\n| where JoinType == \"Azure AD joined\" \r\n| distinct JoinType, DeviceName, DeviceRegistrationState\r\n\r\n// Show only Azure AD registered Devices:\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where isnotempty(JoinType)\r\n| where JoinType == \"Azure AD registered\" \r\n| distinct JoinType, DeviceName, DeviceRegistrationState"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-LastTimeTheDeviceWasActive",
    "query": "// Show a list of devices and timestamp the last time they successfully connected to Intune.\nIntuneDeviceComplianceOrg\n| where todatetime(LastContact) \u003e ago(30d)\n| extend Date=format_datetime(todatetime(LastContact), \"dd.MM.yyyy\")\n| extend Time=format_datetime(todatetime(LastContact), \"hh:mm tt\")\n| extend ['Last successful connection']=strcat(Date,\" \",Time)\n| project DeviceName, ['Last successful connection']\n| project-rename ['Name of the Device'] = DeviceName"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-ListofDevicesThatAreNotBitlockerEncrypted",
    "query": "// Show a list of devices whose the OS Drive is not bitlocker encrypted.\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where EncryptionStatusString == \"False\"\r\n| where Ownership == \"Corporate\"\r\n| where CompliantState == \"Noncompliant\"\r\n| project DeviceName, EncryptionStatusString, CompliantState"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-ListofallDevicesthatwhereaddedtoIntunewithOSPlatforminformation",
    "query": "// List of all Devices that where added to Intune with OS Platform information in a specific timeframe\r\nIntuneDevices\r\n| where CreatedDate contains \"2022-06\" # You can change the month and year if you want or delete the line completely\r\n| where Ownership == \"Corporate\"\r\n| project DeviceName, OS, OSVersion, UserName, CreatedDate\r\n| summarize count(DeviceName) by OS"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-NumberOfDevicesAndManufacturers",
    "query": "// List of device models and Manufacturers and number of devices for each model\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| summarize count(DeviceName) by Model, Manufacturer"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-NumberOfDevicesThatAreManagedByIntuneOrAreCoManaged",
    "query": "// Number of devices that are managed by Intune or are Co-managed\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| summarize count(DeviceName) by ManagedBy"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-ShowallWindowsVersionsandNumberofDeviceswitheachVersion",
    "query": "// Show all Windows Versions and Number of Devices with each Version\nIntuneDevices\n| where OS contains \"Windows\"\n| summarize arg_max(TimeGenerated, *) by DeviceName\n| where todatetime(LastContact) \u003e ago(30d) \n| extend WindowsVersion = case(\n    OSVersion contains '19041', \"20H1\", \n    OSVersion contains '19042', \"20H2\",    \n    OSVersion contains '19043', \"21H1\", \n    OSVersion contains '19044', \"21H2\",\n    OSVersion contains '18363', \"1909\",\n    OSVersion contains '22000', \"Win11 21H2\",\n    OSVersion contains '22621', \"Win11 Insider (22H2)\",\n    \"Unknown\")\n| summarize ['Number of Devices']=count(DeviceName) by WindowsVersion\n| distinct WindowsVersion, ['Number of Devices'] \n| sort by ['Number of Devices'] desc\n//| where WindowsVersion != \"Unknown\" // Activate this line to show only Devices that have reported the Windows Version"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-ShowiOSDeviceswithJailbreak",
    "query": "// Jailbroken devices in Intune\r\nIntuneDevices \r\n| where OS == \"iOS/iPadOS\"\r\n| where Ownership == \"Corporate\"\r\n| where JailBroken == \"True\"\r\n| project JailBroken, DeviceName, UPN"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-SignIns",
    "query": "// This query uses logs from Azure.\r\n// Show Device Logins for Azure joined devices. Result will show success, failure, login status, error codes as well as the location (Country, State, City) of the device.\r\nSigninLogs\r\n| where OperationName == \"Sign-in activity\"\r\n| where UserDisplayName != \"On-Premises Directory Synchronization Service Account\"\r\n| where isnotempty(Status)\r\n| extend Login_Status = tostring(todynamic(Status).errorCode) // Check the error code here: https://login.microsoftonline.com/error\r\n| extend Login_Status_Info = tostring(todynamic(Status).failureReason)\r\n| extend Device_Join_Status = tostring(todynamic(DeviceDetail).trustType)\r\n| extend location_country = tostring(todynamic(LocationDetails).countryOrRegion)\r\n| extend location_city = tostring(todynamic(LocationDetails).city)\r\n| extend location_state = tostring(todynamic(LocationDetails).state)\r\n| extend Location = strcat(location_country, \" \", \"/\", \" \", location_state, \" \", \"/\",\" \", location_city)\r\n| extend Authentication_Method = tostring(todynamic(AuthenticationDetails).[0].authenticationMethod)\r\n| extend Authentication_Detail = tostring(todynamic(AuthenticationDetails).[0].authenticationStepResultDetail)\r\n| extend Authentication_Success = tostring(todynamic(AuthenticationDetails).[0].succeeded)\r\n| where isnotempty(Device_Join_Status) \r\n| where AppDisplayName == \"Windows Sign In\"\r\n| project TimeGenerated, UserDisplayName, AppDisplayName, Login_Status, Login_Status_Info, Device_Join_Status, Location,  Authentication_Method, Authentication_Detail, Authentication_Success"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-StaleDevice",
    "query": "Description:\nThis query lists each device registered in Intune with its most recent contact time, filtering out devices that have contacted within the 90 days.\n\nQuery:\n\nIntuneDevices\n| extend LastContactTime = todatetime(LastContact)\n| where LastContactTime \u003c ago(90d)\n| summarize arg_max(LastContactTime, *) by DeviceName"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-UnsupportedAndroidVersions",
    "query": "// Out-of-support Android Versions\r\nIntuneDevices \r\n| where OS has \"Android\"\r\n| extend Version = todecimal(OSVersion)\r\n| where Version \u003c 10\r\n| where DeviceName != \"User deleted for this device\"\r\n| where Ownership == \"Corporate\"\r\n| project DeviceName, UserName , Version, Ownership"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-UnsupportediOSVersions",
    "query": "// Out-of-support iOS Versions\r\nIntuneDevices \r\n| where OS has \"iOS\"\r\n| extend Version = todecimal(OSVersion)\r\n| where Version \u003c 13\r\n| where DeviceName != \"User deleted for this device\"\r\n| where Ownership == \"Corporate\"\r\n| project DeviceName, Version, Ownership"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-VisualizeAndroidVersions",
    "query": "// Visualize Android Versions and filtering for devices that had a connection to intune in the last 30 days.\r\nIntuneDevices\r\n| where OS contains \"Android\"\r\n| where todatetime(LastContact) \u003e ago(30d) \r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| summarize Versionen=count() by OSVersion\r\n| sort by Versionen desc \r\n| render piechart with (title=\"Android Versions\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-VisualizeNumberofDeviceswithdifferentSKU",
    "query": "// Visualize Number of Devices with different SKU (Pro and Enterprise Versions)\r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| where todatetime(LastContact) \u003e ago(30d) // filter for devices that have contacted intune in the last 30 days\r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| summarize Number=count() by SkuFamily\r\n| render piechart"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-VisualizeTheJoinType",
    "query": "// Visualize the join type (Azure AD joined, Azure AD registered or Hybrid joined) of your MEM/Intune devices per week\r\n// See here: https://github.com/reprise99/Sentinel-Queries/blob/main/Intune/IntuneDevices-VisualizeDeviceJoinTypebyWeek.kql\r\nIntuneDevices\r\n| where todatetime(LastContact) \u003e ago (30d) // Filter only devices the have contacted Intune in the last 30 days\r\n| summarize arg_max(TimeGenerated, *) by DeviceName, startofweek(TimeGenerated)\r\n| where OS == \"Windows\"\r\n| summarize JoinSummary=count()by JoinType, startofweek(TimeGenerated)\r\n| where isnotempty(JoinType)\r\n| render columnchart\r\n    with (\r\n    kind=unstacked,\r\n    ytitle=\"Device Count\",\r\n    xtitle=\"Week\",\r\n    title=\"Device Number by join type per week\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-VisualizeWhenYourDevicesLastContactedIntune",
    "query": "// Visualize when your devices last contacted Intune\r\n// See here: https://github.com/reprise99/Sentinel-Queries/blob/main/Intune/IntuneDevices-VisualizeLastContact.kql\r\nIntuneDevices\r\n| where TimeGenerated \u003e ago(90d)\r\n| where isnotempty(LastContact)\r\n//Retrieve latest record for each DeviceId\r\n| summarize arg_max(TimeGenerated, *) by DeviceId\r\n//Convert string to datetime format\r\n| extend LastContactTime = todatetime(LastContact)\r\n| project DeviceId, LastContactTime\r\n//Exclude devices reporting as 0001-01-01\r\n| where LastContactTime \u003c\u003e todatetime('0001-01-01T00:00:00Z')\r\n//Group by month and render chart\r\n| summarize ['Device Count']=count()by startofmonth(LastContactTime)\r\n| render columnchart with (title=\"Intune devices by last contact time\", xtitle=\"Month\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-VisualizeWindowsVersions",
    "query": "// Visualize Windows Versions and filtering for devices that had a connection to intune in the last 30 days.\r\nIntuneDevices\r\n| where OS contains \"Windows\"\r\n| where todatetime(LastContact) \u003e ago(30d) \r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| summarize Versionen=count() by OSVersion\r\n| sort by Versionen desc \r\n| render piechart with ( title=\"Windows Build Versions\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-VisualizetheWindowsBuildNumbersandthenumberofDevices",
    "query": "// Visualize the Windows Build Numbers and the number of Devices \r\nIntuneDevices\r\n| where OS == \"Windows\"\r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| where todatetime(LastContact) \u003e ago(30d) // Include only Devices that had a connection with Intune in the last 30 days.\r\n| summarize Devices = count() by OSVersion\r\n| where OSVersion != \"0.0.0.0\" // Exclude devices that have not reported the Windows Build.\r\n| sort by Devices\r\n| render columnchart // Visualize the output.\r\n    with (\r\n    kind=unstacked,\r\n    ytitle=\"Device Count\",\r\n    xtitle=\"Windows Build\",\r\n    title=\"Number of Devices by Windows Build\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-iOSDevicesWithoutLatestOSVersion",
    "query": "Description:\niOS Devices that do not support the latest OS version. Example with Version 17.2.1. Adjust the version accordingly.\n\nQuery:\n\nIntuneDevices\n| where OS contains \"iOS\"\n| extend VersionArray = split(OSVersion, \".\")\n| extend MajorVersion = toint(VersionArray[0]), MinorVersion = toint(VersionArray[1]), PatchVersion = toint(VersionArray[2])\n| where MajorVersion \u003c 17 or (MajorVersion == 17 and MinorVersion \u003c 2) or (MajorVersion == 17 and MinorVersion == 2 and PatchVersion \u003c 1)\n| project DeviceName, OS, OSVersion"
  },
  {
    "source": "KQL_Intune",
    "name": "Device-iOSVersions",
    "query": "// Number of iPhones and iPads on Version 14, 15, 16\r\nlet version_16 =\r\nIntuneDevices \r\n| where OS == \"iOS/iPadOS\"\r\n| where OSVersion contains  \"16\"\r\n| summarize ['iOS 16'] = count(DeviceName)\r\n| extend Dummy = \"Number of Devices\";\r\nlet version_15 =\r\nIntuneDevices \r\n| where OS == \"iOS/iPadOS\"\r\n| where OSVersion contains  \"15\"\r\n| summarize ['iOS 15'] = count(DeviceName)\r\n| extend Dummy = \"Number of Devices\";\r\nlet version_14 =\r\nIntuneDevices\r\n| where OS == \"iOS/iPadOS\"\r\n| where OSVersion contains  \"14\"\r\n| summarize ['iOS 14'] = count(DeviceName)\r\n| extend Dummy = \"Number of Devices\";\r\nversion_16\r\n| join kind=inner version_15 on Dummy \r\n| join kind=inner version_14 on Dummy \r\n| distinct Dummy, ['iOS 14'], ['iOS 15'], ['iOS 16']"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-AutopilotDuration",
    "query": "// Show how long the Autopilot process took in seconds and minutes. Result also shows DeviceName for further troubleshooting if needed.\r\nIntuneOperationalLogs\r\n| extend DeviceId = tostring(todynamic(Properties).DeviceId)\r\n| extend Time_Seconds = todynamic(Properties).TimeDiff\r\n| extend Autopilot = todynamic(Properties).IsAutopilot\r\n| extend Status = todynamic(Properties).Status\r\n| extend Time_Minutes = Time_Seconds/60\r\n| where Status == \"Completed\"\r\n| where isnotempty(Autopilot)\r\n| join kind=leftouter IntuneDevices on DeviceId \r\n| project ['Is Autopilot?'] = Autopilot, Status, DeviceName, Time_Minutes, Time_Seconds"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-DidUserReachDesktop",
    "query": "// Shows Devices where User did not reach Desktop even though Auopilot was successful. Result also shows DeviceName for further troubleshooting if needed.\r\nIntuneOperationalLogs\r\n| extend DeviceId = tostring(todynamic(Properties).DeviceId)\r\n| extend DidUserReachDesktop = todynamic(Properties).DidUserReachDesktop\r\n| extend Autopilot = todynamic(Properties).IsAutopilot\r\n| where isnotempty(DidUserReachDesktop)\r\n| join kind=leftouter IntuneDevices on DeviceId \r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| project DeviceName, Autopilot, DidUserReachDesktop"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-ESPEnrollmentsWithProfileName",
    "query": "IntuneOperationalLogs \r\n| where TimeGenerated \u003e ago(30d) \r\n| where OperationName == \"ESPEnrollment\" // Filter for devices with ESP Enrollment\r\n| extend Type = todynamic(Properties).EnrollmentTypeMessage\r\n| extend ESPPolicy = todynamic(Properties).ESPPolicyName // Show ESP Profile if present\r\n| where Type != \"\"\r\n| summarize count(OperationName) by tostring(Type), tostring(ESPPolicy)\r\n| project Type, ESPPolicy, count_OperationName"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-EnrollmentTypes",
    "query": "IntuneOperationalLogs \r\n| where TimeGenerated \u003e ago(30d) // look for devices that were active in the last 30 days\r\n| where OperationName == \"Enrollment\" // Filter for enrollments\r\n| extend Type = todynamic(Properties).EnrollmentType // Look into properties for the enrollment type\r\n| summarize count(OperationName) by tostring(Type)"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-LatestDeviceEnrollments",
    "query": "// Show a list of Devices, with Device Name, Result and OS that have been enrolled to Intune.\nIntuneOperationalLogs \n| where TimeGenerated \u003e ago(7d) // Change the value in () as you desire e.g. 12h, 10d, 30d. d = day, h = hour.\n| extend DeviceId = tostring(todynamic(Properties).IntuneDeviceId)\n| extend OS = tostring(todynamic(Properties).Os)\n| where Result == \"Success\"\n| where OperationName has \"Enrollment\"\n//| where OS == \"Windows\" // You can filter by OS Platform e.g. iOS, Android, Windows. Just replace the vaule between the \" \" and delete the // infront of |.\n| join kind=leftouter IntuneDevices on DeviceId // DeviceName from IntuneDevices. Can be delayed.\n| project TimeGenerated, DeviceId, DeviceName, Result, OperationName, OS\n| summarize TimeGenerated = max(TimeGenerated) by DeviceId, DeviceName, Result, OperationName, OS\n| sort by TimeGenerated desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-NumberOfSuccessfulEnrollmentsbyOS",
    "query": "// Number of Successful Enrollments by OS\r\n// See here: https://github.com/rod-trent/SentinelKQL/blob/master/IntuneCountofSuccessfulEnrollmentsbyOS.txt\r\nIntuneOperationalLogs \r\n| where OperationName == \"Enrollment\" and Result == \"Success\"\r\n| extend OS = tostring(todynamic(Properties).Os\r\n| summarize count() by OS\r\n\r\n// Failed enrollments\r\nIntuneOperationalLogs \r\n| where OperationName == \"Enrollment\" and Result == \"Failed\"\r\n| extend OS = tostring(todynamic(Properties).Os\r\n| summarize count() by OS"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-OSBuildDuringAutopilot",
    "query": "// Show the OS Build of Windows during Autopilot. Result also shows DeviceName for analyzing any future update or upgrade events.\r\nIntuneOperationalLogs\r\n| extend DeviceId = tostring(todynamic(Properties).DeviceId)\r\n| extend Version = todynamic(Properties).Version\r\n| where isnotempty(Version)\r\n| join kind=leftouter IntuneDevices on DeviceId \r\n| summarize arg_max(TimeGenerated, *) by DeviceName\r\n| project DeviceName, ['OS Build during Autopilot'] = Version"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-ShowIntuneEnrollmentNotSupportedDevices",
    "query": "//Intune Enrollment Failure Reasons - Devices not supported by time, failure type, and operating system\r\nIntuneOperationalLogs\r\n| extend FailureCategory_ = todynamic(Properties).FailureCategory\r\n| where FailureCategory_ == \"DeviceNotSupported\"\r\n| extend OS = todynamic(Properties).Os\r\n| extend Reason = todynamic(Properties).FailureReason\r\n| extend Type = todynamic(Properties).EnrollmentType\r\n| extend DeviceId = tostring(todynamic(Properties).AADDeviceId)\r\n| project FailureCategory_ , Reason, Type, OS, DeviceId"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-ShowUsersThatAbandonedTheIntuneEnrollment",
    "query": "// Show Users that abandoned the Intune Enrollment\r\n// Inspiration: https://github.com/rod-trent/SentinelKQL/blob/master/Intune-Enrollmentsabandonedbytheuser.txt\r\nIntuneOperationalLogs\r\n| where TimeGenerated \u003e ago(7d) // Change the value in () as you desire e.g. 12h, 10d, 30d. d = day, h = hour.\r\n| where OperationName == \"Enrollment\" \r\n| where Result == \"Fail\"\r\n| extend EnrollmentType = tostring(todynamic(Properties).EnrollmentType)\r\n| extend FailureReason = tostring(todynamic(Properties).FailureReason)\r\n| extend OS = tostring(todynamic(Properties).Os)\r\n| extend OSVersion = tostring(todynamic(Properties).OsVersion)\r\n| extend UserID = tostring(todynamic(Properties).IntuneUserId) // You will find the User in your Azure AD.\r\n| where FailureReason == \"UserAbandonment\"\r\n| project\r\n    TimeGenerated,\r\n    FailureReason,\r\n    UserID,\r\n    OS,\r\n    OSVersion,\r\n    OperationName,\r\n    EnrollmentType\r\n| sort by TimeGenerated desc"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-VisualizeEnrollmentStatistics",
    "query": "// Visualize Enrollment Statistics (Success and Fail) over time\r\nIntuneOperationalLogs\r\n| where  OperationName == \"Enrollment\"\r\n| where TimeGenerated \u003e ago(365d)\r\n| extend DeviceId = tostring(todynamic(Properties).IntuneDeviceId)\r\n| join kind=leftouter IntuneDevices on DeviceId \r\n| summarize arg_max(DeviceId, *) by DeviceId, startofweek(TimeGenerated)\r\n//| where Result == \"Success\" // Filter for success or Fail\r\n| summarize EnrollmentCount=count()by Result, startofweek(TimeGenerated)\r\n| render timechart  \r\n    with (\r\n    ytitle=\"Device Count\",\r\n    xtitle=\"Week\",\r\n    title=\"Enrollments per week over time\")"
  },
  {
    "source": "KQL_Intune",
    "name": "Operational-VisualizefailedDeviceDeployments",
    "query": "// Visualize failed Device Deployments\r\nIntuneOperationalLogs \r\n| extend OS = tostring(todynamic(Properties).Os)\r\n| where OS == \"Windows\"\r\n| extend DeviceId = tostring(todynamic(Properties).AADDeviceId)\r\n| where Result == \"Fail\"\r\n| join kind=leftouter IntuneDevices on DeviceId\r\n| project TimeGenerated, DeviceId, DeviceName\r\n| summarize TimeGenerated = max(TimeGenerated) by DeviceId, DeviceName\r\n| summarize [\"Number of devices that failed deployment\"] = count() by DeviceId, DeviceName, TimeGenerated\r\n| render timechart \r\n   with (\r\n    kind=unstacked,\r\n    ytitle=\"Device Count\",\r\n    xtitle=\"Date\",\r\n    title=\"Number of devices that failed deployment\")"
  },
  {
    "source": "SlimKQL",
    "name": "Advanced Vishing KQL Detection",
    "query": "// Advanced Vishing KQL Detection\n\n// https://www.linkedin.com/posts/0x534c_cybersecurity-teams-vishing-activity-7275032953850597377-bCT1?utm_source=share\u0026utm_medium=member_desktop\n// https://www.trendmicro.com/en_us/research/24/l/darkgate-malware.html\n\n// This post follows up on my previous discussion, \"Vishing via Microsoft Teams Facilitates DarkGate Malware Intrusion.\" In just two clicks, you can download the PSTN usage log from the Teams admin portal and upload it to Azure Data Explorer (ADX). By running the KQL query below, you can identify potential indicators of a Vishing attack.ðŸŽ¯\n\nTeamsCallLog\n| where ['Call Direction'] == \"Inbound\"\n\n// Corporate users with high inbound calls and low call duration - Vishing Attacks Indicator (1)\n// Identify receiver UPN and check against inbound email flow for the UPN\n| summarize Callers=dcount(['Caller ID']), CallDuration=dcount(['Duration Seconds']) by UPN\n\n// External Caller IDs with high inbound calls and low call duration - Vishing Attacks Indicator (2)\n| summarize Receivers=dcount(UPN), CallDuration=dcount(['Duration Seconds']) by ['Caller ID']\n\n//"
  },
  {
    "source": "SlimKQL",
    "name": "Azure Cloud Security Monitoring",
    "query": "// Azure Cloud Security Monitoring\n// https://www.linkedin.com/pulse/azure-cloud-security-monitoring-steven-lim-vf6ac/\n\n// Detect new blob with allowBlobPublicAccess enabled\n\nAzureActivity\n| where OperationNameValue startswith \"MICROSOFT.STORAGE/STORAGEACCOUNTS/\"\n| extend allowBlobPublicAccess = tostring(parse_json(tostring(parse_json(tostring(Properties_d.requestbody)).properties)).allowBlobPublicAccess)\n| where isnotempty(allowBlobPublicAccess)\n| where allowBlobPublicAccess == \"true\"\n| extend ResourceName = tostring(parse_json(Properties).resource)\n| extend CallerUPN = tostring(parse_json(Properties).caller)\n| project SubscriptionId, CallerIpAddress, CallerUPN, ResourceName, allowBlobPublicAccess\n\n// Detect new public IP address creation\n\nAzureActivity\n| where OperationNameValue startswith \"Microsoft.Network/publicIPAddresses/write\"\n| where ActivityStatusValue == \"Succeeded\" \n\n// Detect NSG creation or deletion\n\nAzureActivity\n| where OperationNameValue =~ \"Microsoft.Network/networkSecurityGroups/securityRules/delete\" or \nOperationNameValue =~ \"Microsoft.Network/networkSecurityGroups/securityRules/write\"\n| where ActivityStatusValue == \"Accept\"\n| extend NsgName = split(_ResourceId, '/')[8], NsgRule = split(_ResourceId, '/')[10]\n| project TimeGenerated, NsgName, NsgRule, ResourceGroup, Caller, CallerIpAddress, _ResourceId\n\n// Detect Azure VM password reset (Lateral movement technique)\n\nExposureGraphEdges\n| where EdgeLabel contains \"contains\"\n| where TargetNodeName contains \"PasswordReset\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| project SourceNodeName, TargetNodeName, NodeProperties, EntityIds \n\n// Detect Privilege Escalation on Azure Service Principal\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) \nand NodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4\n| extend AccountID = tostring(NodeProperties.rawData.accountObjectId)\n| distinct AccountID;\nCloudAppEvents\n| where ActivityType == \"Add\"\n| where ActionType == @\"Add service principal credentials.\"\n| where AccountId has_any(CriticalIdentities)\n\n// Detect Azure API spray attacks\n\nlet threshold=5;\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| where IsRequestSuccess == \"false\"\n| summarize Count=count() by CallerIpAddress\n| sort by Count desc\n| where Count \u003e threshold\n\n// Detect Azure API Secrets Extraction\n\nCloudAuditEvents\n| where Timestamp \u003e ago(30d)\n| where OperationName == \"Microsoft.ApiManagement/service/tenant/listSecrets/action\"\n| extend SubscriptionID = tostring(RawEventData.subscriptionId)\n| extend PrincipalOID = tostring(RawEventData.principalOid)\n| extend ApplicationID = tostring(RawEventData.applicationId)\n| extend HttpRequest = tostring(RawEventData.httpRequest)\n| extend Properties = tostring(RawEventData.properties)\n| project Timestamp, OperationName, PrincipalOID, SubscriptionID, ApplicationID, HttpRequest, Properties \n\n// Detect Azure VM DNS Threat\n\nDnsEvents\n| where IPAddresses != \"\"\n| join ThreatIntelligenceIndicator on $left.Name == $right.DomainName\n| where ConfidenceScore \u003e 50\n\n// MITRE ATT\u0026CK Mapping\n\n// T1530 - Data from Cloud Storage Object\n// T1583.003 - Acquire Infrastructure: Cloud Account\n// T1562.004 - Impair Defenses: Disable or Modify System Firewall\n// T1078.004 - Valid Accounts: Cloud Accounts\n// T1110.003 - Brute Force: Password Spraying\n// T1530 - Data from Cloud Storage Object\n// T1071.004 - Application Layer Protocol: DNS"
  },
  {
    "source": "SlimKQL",
    "name": "Azure Resource Graph Explorer - KQL Change Analysis",
    "query": "//Azure Resource Graph Explorer - KQL Change Analysis\n//https://www.linkedin.com/feed/update/urn:li:activity:7171786606188724224/\n\n//Identifying who made a change to your Azure resources during a security investigation and how the change was made just became easier! With Change Analysis, you can now see who initiated the change and with which client that change was made, for changes across all your tenants and subscriptions. You can try it out by querying the â€œresourcechangesâ€ or â€œresourcecontainerchangesâ€ tables in Azure Resource Graph. Check out the below article for list of KQL change analysis queries\n\n//Summarization of Resource Changes past 7 days\n\nresourcechanges\n| extend changeTime = todatetime (properties.changeAttributes.timestamp), targetResourceId = tostring(properties.targetResourceId), changeType = tostring (properties.changeType), changedBy = tostring(properties.changeAttributes. changedBy), changedByType = properties.changeAttributes.changedByType, clientType = tostring (properties.changeAttributes.clientType)\n| where changeTime \u003e ago(7d)\n| project changeType, changedBy, changedByType, clientType\n| summarize count() by changedBy, changeType, clientType\n| order by count_ desc\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the fields and operations in the KQL query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The changedBy and changedByType fields can help identify if valid accounts are being used for unauthorized changes.\n// T1098 - Account Manipulation:\n// The changeType field can indicate if there are changes related to account settings or permissions.\n// T1003 - Credential Dumping:\n// If the clientType indicates a suspicious client, it might be related to credential dumping activities.\n// T1071 - Application Layer Protocol:\n// The clientType field can also help identify if unusual protocols are being used for changes.\n// T1566 - Phishing:\n// If the changedBy field shows unexpected users making changes, it might indicate compromised accounts due to phishing."
  },
  {
    "source": "SlimKQL",
    "name": "Azure Storage Blob - Misconfiguration Check",
    "query": "// Azure Resource Graph\n// Azure Storage Blob - Misconfiguration Check\n// https://www.linkedin.com/posts/activity-7184079321605529600-Obcd/\n\nresources\n| where type == \"Microsoft.Storage/storageAccounts\"\n| extend allowBlobPublicAccess = parse_json(properties).allowBlobPublicAccess\n| project subscriptionId, resourceGroup, name, allowBlobPublicAccess\n\n\n// MITRE ATT\u0026CK Mapping\n\n// The query is primarily focused on identifying misconfigurations that could lead to unauthorized access. The relevant MITRE ATT\u0026CK techniques include:\n// T1530 - Data from Cloud Storage Object: This technique involves adversaries accessing data stored in cloud storage services. By identifying storage accounts with public blob access, you can detect potential exposure of sensitive data1."
  },
  {
    "source": "SlimKQL",
    "name": "Check for Azure Outdated Security Protocols",
    "query": "// Azure: Deprecation of Outdated Security Protocols\n\n// On October 31 2024, Azure Resource Manager will be retiring support for TLS 1.0 and TLS 1.1. After that date, any incoming calls to Azure using TLS 1.0/1.1 will fail. This is part of anâ€¯Azure-wide initiative to enhance security. Do you know any of Azure cloud native services are still running the outdated security protocols ? You still have time to remediate by running the below KQL to tell you which services is still running the outdated protocols ðŸ˜‰\n\n//Azure: Depreciation of outdated security protocol by 31 Oct 2024\n\nlet TLSVersion = \"1.0\"; \nsearch in (ApiManagementGatewayLogs, AzureDiagnostics, SQLSecurityAuditEvents,\nStorageBlobLogs, StorageFileLogs, StorageQueueLogs, StorageTableLogs)\nTimeGenerated between (ago(30d) .. now())\nand (\nClientTlsVersion has TLSVersion\nor tlsVersion_s has TLSVersion\nor client_tls_version_name_s has TLSVersion\nor TlsVersion has TLSVersion\n)\n\n// Retirement: Migrating to TLS 1.2+ with the Deprecation of Outdated Security Protocols\n// Link: https://azure.microsoft.com/en-us/updates/v2/migrating-to-tls-12-with-deprecation-of-outdated-security-protocols"
  },
  {
    "source": "SlimKQL",
    "name": "Check for Entra Legacy TLS Login",
    "query": "// Check for Entra Legacy TLS Login\n\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where ResultType == \"0\"\n| mv-expand todynamic(AuthenticationProcessingDetails)\n| where AuthenticationProcessingDetails.key has \"Legacy TLS (TLS 1.0, 1.1, 3DES)\"\n| where AuthenticationProcessingDetails.value has \"True\"\n| summarize LegacyLogin=count() by UserPrincipalName\n| sort by LegacyLogin desc \n\n// Retirement: Migrating to TLS 1.2+ with the Deprecation of Outdated Security Protocols\n// https://azure.microsoft.com/en-us/updates/v2/migrating-to-tls-12-with-deprecation-of-outdated-security-protocols"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Commvault Exploitation in Azure",
    "query": "// https://thehackernews.com/2025/05/commvault-confirms-hackers-exploited.html\n// https://kb.commvault.com/article/87661\n\nlet CommVaultIOC = dynamic([\"108.69.148.100\", \"128.92.80.210\", \n\"184.153.42.129\", \"108.6.189.53\", \"159.242.42.20\"]);\nlet AzureActivityResult =\nAzureActivity\n| where TimeGenerated \u003e ago(90d)\n| where CallerIpAddress has_any(CommVaultIOC);\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where IPAddress has_any(CommVaultIOC)\n| union AzureActivityResult"
  },
  {
    "source": "SlimKQL",
    "name": "Monitor Azure API Secrets Extraction",
    "query": "// Monitor Azure API Secrets Extraction\n// https://www.linkedin.com/posts/activity-7199783025038008320-PSqg/\n\n// Compromised Azure API secrets pose significant risks, including the potential for unauthorized access to confidential data within Azure services, which could result in a data breach. Additionally, attackers may modify settings or interrupt services, causing operational downtime. Consequently, it is crucial for security teams to oversee the management of Azure API secret extractions. The recent integration of the CloudAuditEvents advanced hunting table into DefenderXDR enables the monitoring of activities such as the extraction of Azure API secrets, ensuring that actions undertaken by cloud administrators are verified and authorized.\n\nCloudAuditEvents\n| where Timestamp \u003e ago(30d)\n| where OperationName == \"Microsoft.ApiManagement/service/tenant/listSecrets/action\"\n| extend SubscriptionID = tostring(RawEventData.subscriptionId)\n| extend PrincipalOID = tostring(RawEventData.principalOid)\n| extend ApplicationID = tostring(RawEventData.applicationId)\n| extend HttpRequest = tostring(RawEventData.httpRequest)\n| extend Properties = tostring(RawEventData.properties)\n| project Timestamp, OperationName, PrincipalOID, SubscriptionID, ApplicationID, HttpRequest, Properties \n\n\n// MITRE ATT\u0026CK Mapping\n\n// The operation Microsoft.ApiManagement/service/tenant/listSecrets/action involves listing secrets, which can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1070.004 - Indicator Removal on Host: File Deletion:\n// This technique involves adversaries attempting to delete or alter generated artifacts on a host system, including logs or captured files. Listing secrets could be a precursor to such actions.\n// T1552.001 - Unsecured Credentials: Credentials In Files:\n// This technique involves adversaries searching for credentials in files. Listing secrets can be part of this process, as secrets often contain sensitive information like credentials.\n// T1078 - Valid Accounts:\n// Adversaries may use valid accounts to access and list secrets. This technique involves the use of legitimate credentials to gain access to resources.\n// T1087.001 - Account Discovery: Local Account:\n// This technique involves adversaries enumerating accounts to understand the environment. Listing secrets can help in discovering accounts and their associated secrets."
  },
  {
    "source": "SlimKQL",
    "name": "regreSSHion - Remote Unauthenticated Code Execution Vulnerability in OpenSSH server",
    "query": "// regreSSHion - Remote Unauthenticated Code Execution Vulnerability in OpenSSH server\n// https://www.linkedin.com/posts/activity-7213658125323681793-p0wl/\n\n// Azure Resource Graph KQL Query to check Azure Linux server running OpenSSH: \n\nresources\n| where type =~ 'Microsoft.Compute/virtualMachines'\n| extend osType = properties.storageProfile.osDisk.osType\n| where osType =~ 'Linux'\n| mvexpand sshKey = properties.osProfile.linuxConfiguration.ssh.publicKeys\n| where sshKey.keyData contains 'ssh-rsa' or sshKey.keyData contains 'ssh-dss'\n| project name, location, osType, sshKey.keyData\n\n// Microsoft Defender for Endpoint device discovery capabilities KQL to detect Linux machines (probably with SSH enabled) connected to on-prem \u0026 cloud environments (Not onboarded to MDE) to further identify any other possible attack surface.\n\nDeviceInfo\n| where OnboardingStatus != \"Onboarded\"\n| where OSPlatform == \"Linux\"\n| where DeviceName != \"\"\n| where DeviceCategory == \"Endpoint\"\n\n// MITRE ATT\u0026CK Mapping\n\n// T1078.003: Valid Accounts: SSH 1\n// T1136.001: Create Account: Local Account 1\n// T1082: System Information Discovery 1\n// T1018: Remote System Discovery 1"
  },
  {
    "source": "SlimKQL",
    "name": "ANY.RUN Obfuscated BAT Dropper Delivers NetSupport RAT post",
    "query": "// ANY.RUN Obfuscated BAT Dropper Delivers NetSupport RAT post\n// https://www.linkedin.com/posts/any-run_obfuscated-virustotal-powershell-activity-7336393368698028034-cayg/\n\nlet QueryLookup = 1h;\nlet ObfuscatedBAT =\nDeviceProcessEvents\n| where Timestamp \u003e ago(QueryLookup)\n| where InitiatingProcessFileName =~ \"cmd.exe\" and \nInitiatingProcessCommandLine has \".bat\"\n| where FileName =~ \"powershell.exe\" and \nProcessCommandLine has \"-WindowsStyle Hidden\" and \nProcessCommandLine has \"Invoke-WebRequest\"\n| distinct DeviceName;\nDeviceRegistryEvents\n| where Timestamp \u003e ago(QueryLookup)\n| where ActionType == \"RegistryValueSet\"\n| where RegistryKey has \"\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run\"\n| where RegistryValueData has \"client32.exe\"\n| where DeviceName has_any(ObfuscatedBAT)"
  },
  {
    "source": "SlimKQL",
    "name": "APT Stealth Falcon - CVE-2025-33053 Detection",
    "query": "// APT Stealth Falcon - CVE-2025-33053 Detection\n// https://research.checkpoint.com/2025/stealth-falcon-zero-day/\n\nlet QueryPeriod = 1h;\nlet DevicewithDotURL =\nDeviceFileEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where ActionType == \"FileCreated\"\n| where tolower(FileName) endswith \".url\"\n| distinct DeviceName;\nDeviceProcessEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where InitiatingProcessFileName =~ \"iediagcmd.exe\" and FileName =~ \"route.exe\"\n| where FolderPath startswith \"\\\\\"\n| where DeviceName has_any(DevicewithDotURL)"
  },
  {
    "source": "SlimKQL",
    "name": "ATP Detection for Critical Identities",
    "query": "// ATP Detection for Critical Identities\n// https://www.linkedin.com/posts/activity-7190937404625584128-hgdO/\n\n// Custom DefenderXDR detection for CloudApp Advanced Threat Protection for Tier 0 Critical Identities giving you a comprehensive all-round threat monitoring. \n\nlet HighlyPrivilegedAdmins =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and \nNodeProperties.rawData.criticalityLevel.criticalityLevel==0 \n| extend EntraObjectID = NodeProperties.rawData.accountObjectId\n| project EntraObjectID;\nCloudAppEvents\n| where ActionType == \"AtpDetection\"\n| extend DetectionMethod = tostring(RawEventData.DetectionMethod)\n| extend AccountUpn = RawEventData.UserId\n| where AccountUpn has_any(HighlyPrivilegedAdmins)\n\n//MITRE ATT\u0026CK Mapping\n//Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query is identifying and monitoring highly privileged accounts, which aligns with the technique of using valid accounts for persistence and privilege escalation1.\n// T1071 - Application Layer Protocol:\n// The CloudAppEvents table and the AtpDetection action type suggest monitoring for suspicious activities in cloud applications, which can involve the use of application layer protocols2.\n// T1087 - Account Discovery:\n// The query involves discovering highly privileged accounts, which aligns with the technique of account discovery3.\n// T1057 - Process Discovery:\n// The detection method and user ID extensions indicate monitoring for specific processes or actions taken by privileged accounts4."
  },
  {
    "source": "SlimKQL",
    "name": "Active Directory Domain Services Elevation of Privilege Vulnerability (CVE-2025-21293)",
    "query": "// Active Directory Domain Services Elevation of Privilege Vulnerability (CVE-2025-21293) CVSS 8.8\n\n// https://birkep.github.io/posts/Windows-LPE/\n\nlet WindowsServer =\nDeviceInfo\n| where DeviceType == \"Server\" and OSPlatform has \"windows\"\n| distinct DeviceName;\nlet DLLLoaded =\nDeviceEvents\n| where Timestamp \u003e ago(3h)\n| where DeviceName has_any (WindowsServer)\n| where ActionType == @\"DriverLoad\"\n| where FileName endswith \".dll\"\n| distinct FileName;\nDeviceRegistryEvents\n| where ActionType == @\"RegistryKeyCreated\" or ActionType == @\"RegistryValueSet\"\n| where RegistryValueName has_any(DLLLoaded) or RegistryValueData has_any(DLLLoaded)"
  },
  {
    "source": "SlimKQL",
    "name": "Any.Run Corrupt File Zero Day Attack",
    "query": "// Any.Run Corrupt File Zero Day Attack\n\n// https://www.linkedin.com/posts/0x534c_httpsxcomanyrunappstatus1861024272463909018-activity-7269357711639633920-4xZK/\n\n// ð—–ð˜‚ð˜€ð˜ð—¼ð—º ð— ð——ð—¢ ð—žð—¤ð—Ÿ ð——ð—²ð˜ð—²ð—°ð˜ð—¶ð—¼ð—» ð—³ð—¼ð—¿ ð—½ð—¼ð˜ð—²ð—»ð˜ð—¶ð—®ð—¹ ð—­ð—˜ð—¥ð—¢-ð——ð—”ð—¬ ð—”ð˜ð˜ð—®ð—°ð—¸:\n\nEmailAttachmentInfo\n| where Timestamp\u003e ago(1h)\n| where FileName endswith \".docx\"\n| where FileType == \"zip\" or FileType == \"unknown;\"\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\""
  },
  {
    "source": "SlimKQL",
    "name": "Azure AI Security Finding Report",
    "query": "// Azure AI Security Finding Report\n\nExposureGraphEdges \n| where TargetNodeCategories[0] == \"AI\"\n| where SourceNodeCategories[1] == \"security_finding\"\n| extend FindingDate = parse_json(EdgeProperties)[\"rawData\"][\"publishedDate\"]\n| extend SecurityRiskLevel = parse_json(EdgeProperties)[\"rawData\"][\"risk\"][\"riskLevel\"]\n| project FindingDate, SecurityRiskLevel, TargetNodeName, SourceNodeName"
  },
  {
    "source": "SlimKQL",
    "name": "Blob URI Unique Domain Count",
    "query": "// Blob URI Unique Domain Count\n\nDeviceFileEvents\n| where TimeGenerated \u003e ago(90d)\n| where FileOriginUrl startswith \"blob:https://\"\n| extend dURL = trim_start(\"blob:https\", FileOriginUrl)\n| extend dURL2 = strcat(\"https\" , dURL)\n| extend Domain = tostring(parse_url(dURL2).Host)\n| summarize Count=count() by Domain\n| sort by Count desc"
  },
  {
    "source": "SlimKQL",
    "name": "BlueAlpha GammaDrop Detection",
    "query": "// BlueAlpha GammaDrop Detection\n// https://www.recordedfuture.com/research/bluealpha-abuses-cloudflare-tunneling-service\n\n// BlueAlpha, a state-sponsored cyber threat group linked to the Russian FSB, has been active since 2014. Insikt Group has observed, via recent malware sample submissions to Recorded Future Public Sandbox, BlueAlpha abusing Cloudflare Tunnels for GammaDrop staging infrastructure. These tunnels have been leveraged by malicious .lnk files to download and execute GammaDrop.\n\nlet DeviceLNKCreation =\nDeviceFileEvents\n| where ActionType == @\"FileCreated\"\n| where FileName endswith \".lnk\"\n| invoke FileProfile(SHA1,100)\n| where GlobalPrevalence \u003c 10\n// Detect low prevalence LNK file extracted from archive\n| distinct DeviceName;\nDeviceNetworkEvents\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost endswith \".trycloudflare.com\"\n| where DeviceName has_any(DeviceLNKCreation)\n// Endpoint with new low prevalence LNK created connecting to trycloudflare\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-26234 and CVE-2024-29988",
    "query": "//  CVE-2024-26234 and CVE-2024-29988\n// ðŸš¨Patching Prioritization - Zero-Day ExploitsðŸš¨\n// https://www.linkedin.com/posts/activity-7183738500502990848-9rdu/\n\n// Using DefenderXDR Exposure Management to determine the list of devices accessible by critical identities holding highly privilege roles and that the devices are also vulnerable to both CVE-2024-26234 and CVE-2024-29988 that currently exploited in malware attacks. As critical identities are part of your organization attack surface areas holding keys to your tenant, plugging this hole significantly reduce your organization risk against the Zero-Day exploits. ðŸ«¡\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet CriticalDevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-26234\" or CveId == \"CVE-2024-29988\"\n| where DeviceName has_any (CriticalDevices)\n\n// MITRE ATT\u0026CK Mapping\n// The KQL code is designed to identify critical identities and devices, and then check for specific vulnerabilities on those devices. The associated MITRE ATT\u0026CK techniques include:\n\n// T1078: Valid Accounts\n// T1078.001: Valid Accounts: Local Accounts\n// T1078.003: Valid Accounts: Local Administrator Accounts\n// T1190: Exploit Public-Facing Application\n// T1210: Exploitation of Remote Services"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-29510 Ghostscript library RCE bug Exploited",
    "query": "// CVE-2024-29510 Ghostscript library RCE bug Exploited\n// https://www.linkedin.com/posts/activity-7216125838516178945-R-rj/\n\n// Artifex Ghostscript before 10.03.1 allows memory corruption, and SAFER sandbox bypass, via format string injection with a uniprint device. Ghostscript comes pre-installed on many Linux distributions and is used by various document conversion software.\n\n// MDE KQL to check impacted Windows/Linux workstations:\n\nDeviceTvmSoftwareInventory\n| where SoftwareName contains \"ghostscript\" and SoftwareVersion != \"10.03.1\"\n\n// MITRE ATT\u0026CK Mapping\n// This query aligns with the following MITRE ATT\u0026CK techniques:\n\n// T1082 - System Information Discovery: Attackers may use this technique to gather information about the software installed on a system, which can include identifying outdated or vulnerable versions1.\n// T1518.001 - Software Discovery: This technique involves adversaries attempting to identify software installed on a system, which can help them understand the environment and identify potential targets2.\n// By identifying devices with outdated versions of â€œghostscript,â€ this query helps in detecting potential vulnerabilities that adversaries might exploit."
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-3094 with CVSS Score 10",
    "query": "//CVE-2024-3094 with CVSS Score 10\n//https://www.linkedin.com/posts/activity-7179670729532092416-b5Yb/\n\n//CVE-2024-3094 with CVSS Score 10/10\n\n//Cyber defenders take note there is a supply chain compromise on the popular Linux XZ utils, if you have Linux running on Azure with Microsoft Defender for Cloud (MDC) enabled, run the below interim KQL to check if your Azure Cloud Linux servers are impacted and the latter KQL when Microsoft update their TVM database for this critical CVE.ðŸ«¡\n\n//Interim KQL:\n\nDeviceTvmSoftwareInventory \n| where SoftwareName contains \"xz\"\n| where SoftwareVersion contains \"5.6.\"\n\n//KQL to use when Microsoft update their TVM database definitions:\n\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-3094\"\n\n//CISA Alert:\n//https://lnkd.in/gAkiCfBS\n\n//Red Hat Alert:\n//https://lnkd.in/g2BGRGTy\n\n// MITRE ATT\u0026CK Mapping\n\n// T1082 - System Information Discovery: This technique involves gathering information about the system, including software inventory.\n// T1518.001 - Software Discovery: This technique involves discovering software installed on the system.\n// T1592.002 - Gather Victim Host Information: This technique involves gathering information about vulnerabilities on the host.\n// T1587.001 - Develop Capabilities: This technique involves developing exploits for discovered vulnerabilities.\n// These mappings help in understanding how the KQL queries align with the MITRE ATT\u0026CK framework, providing insights into potential adversary behaviors and techniques."
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-38063 CVSS 9.8 Prioritization",
    "query": "// CVE-2024-38063 CVSS 9.8 Prioritization\n// Linkedin Post: https://www.linkedin.com/posts/0x534c_defenderxdr-exposuremanagement-mde-activity-7229516269274685443-fTwM/\n// An attacker can remotely exploit this vulnerability by sending specially crafted IPv6 packets to a target host. No user interaction is needed, making it a â€˜0-clickâ€™ vulnerability. Only IPv6 packets can be used to exploit this critical vulnerability.\n\n// It is important to identify privileged admin endpoints that are running IPv6 and are internet-facing. Prioritizing the patching of these endpoints is crucial, as they hold the keys to your systems.\n\n// Using DefenderXDR Exposure Management and Microsoft Defender for Endpoint schema information, we are able to determine these important group of endpoints to be prioritize for patching.\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet CriticalDevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nlet VulnerableCriticalDevices =\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-38063\"\n| where DeviceName has_any (CriticalDevices)\n| distinct DeviceName;\nDeviceNetworkInfo\n| where Timestamp \u003e ago(30d)\n| mv-expand todynamic(IPAddresses)\n| extend IP = tostring(IPAddresses.IPAddress)\n| where IPAddresses has \"Public\" and IP contains \":\" // IPv6 Public Facing\n| where DeviceName has_any(VulnerableCriticalDevices) // Critical Devices\n\n// MSRC Security Updates (CVE-2024-38063)\n// Link: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-38063\n\n// #DefenderXDR #ExposureManagement #MDE #IPv6 #CriticalVulnerability \n\n// MITRE ATT\u0026CK Mapping\n\n// T1078: Valid Accounts - Identifying critical accounts that could be targeted.\n// T1078: Valid Accounts - Identifying devices that can be accessed using valid accounts.\n// T1078.003: Local Accounts - Identifying local admin accounts on devices.\n// T1190: Exploit Public-Facing Application - Identifying devices vulnerable to exploitation.\n// T1049: System Network Connections Discovery - Identifying network connections.\n// T1016: System Network Configuration Discovery - Identifying network configurations.\n\n// This KQL query sequence is designed to identify critical identities and devices, determine their vulnerabilities, and find public-facing IPv6\n// addresses. The associated MITRE ATT\u0026CK techniques include Valid Accounts, Exploit Public-Facing Application, System Network Connections\n// Discovery, and System Network Configuration Discovery."
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-38112 ZERO-DAY TRICKS IN dot URL TO LURE VICTIMS",
    "query": "// CVE-2024-38112 ZERO-DAY TRICKS IN dot URL TO LURE VICTIMS\n// https://www.linkedin.com/posts/activity-7217706847808499713-AGPd/\n\nDefenders using Sentinel or DefenderXDR can create the below MDE KQL detection to monitor such attack from Outlook and Teams:\n\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".url\" or FileName endswith \".URL\"\n| where InitiatingProcessFileName contains \"outlook.exe\" or \nInitiatingProcessFileName contains \"teams.exe\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the KQL query is likely detecting suspicious file creation activities that could be associated with phishing or malicious link delivery via email or collaboration tools. Here are the relevant MITRE ATT\u0026CK techniques:\n\n// T1566.001 - Phishing: Spearphishing Attachment:\n// Description: This technique involves sending emails with malicious attachments to gain access to a victimâ€™s system.\n// Relevance: The query looks for .url files created by outlook.exe, which could indicate a phishing attempt via email.\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// Description: This technique involves using web protocols for command and control.\n// Relevance: .url files can be used to direct victims to malicious websites, potentially for command and control purposes.\n\n// T1204.002 - User Execution: Malicious File:\n// Description: This technique involves tricking users into executing malicious files.\n// Relevance: .url files created by teams.exe could be used to deliver malicious links through collaboration tools.\n\n// T1105 - Ingress Tool Transfer:\n// Description: This technique involves transferring tools or files from an external system into a compromised environment.\n// Relevance: .url files could be used to download additional malicious payloads.\n\n// The KQL query is designed to detect potential phishing or malicious link delivery activities by monitoring the creation of .url files initiated by email and collaboration applications. This detection aligns with several MITRE ATT\u0026CK techniques related to phishing, user execution, and command and control."
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-38200 NTLM Exposure Detection",
    "query": "// CVE-2024-38200 NTLM Exposure Detection\n// Linkedin Post: https://www.linkedin.com/posts/0x534c_microsoft-discloses-unpatched-office-flaw-activity-7229115791139348480-X_Hi/\n// Microsoft has disclosed a high-severity vulnerability affecting Office 2016 that could expose NTLM hashes to a remote attacker. Microsoft's exploitability assessment says that exploitation of CVE-2024-38200 is less likely, MITRE has tagged the likelihood of exploitation for this type of weakness as highly probable.\n\n// The below KQL uses DefenderXDR Exposure Management to check the presence of NTLM hash on the endpoint and if it successfully made an outbound NTLM authentication to internet public IP which indicates high probability of NTLM hash exposure. Upon detection, SecOps should request user to change credential as a precaution until the endpoint is patched. \n\nlet EndpointWithNTLMHash = \nExposureGraphEdges\n| where EdgeLabel == @\"has credentials of\"\n| where EdgeProperties.rawData.ntlmHash.ntlmHash == \"true\"\n| distinct SourceNodeName;\nlet VulnerableEndpoint =\nDeviceTvmSoftwareInventory\n| where SoftwareName contains \"office_\" and SoftwareVendor == \"microsoft\"\n| where DeviceName has_any (EndpointWithNTLMHash)\n| distinct DeviceName;\nDeviceNetworkEvents\n| where RemotePort == \"445\" and RemoteIPType == \"Public\"\n| where ActionType == \"ConnectionSuccess\"\n| where DeviceName has_any (VulnerableEndpoint)\n\n// MSRC - Microsoft Office Spoofing Vulnerability (Recently Updated)\n// https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-38200\n\n// https://www.bleepingcomputer.com/news/security/microsoft-discloses-unpatched-office-flaw-that-exposes-ntlm-hashes/\n\n// MITRE ATT\u0026CK Mapping\n\n// Credential Dumping (T1003): Identifying endpoints with NTLM hashes.\n// Exploitation for Client Execution (T1203): Identifying vulnerable endpoints with specific software.\n// Remote Services (T1021): Monitoring network events for successful connections on port 445.\n\n// These mappings help in understanding the potential threats and tactics being monitored by the KQL query."
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-38475 Apache HTTP Server Improper Escaping of Output Vulnerability",
    "query": "// CVE-2024-38475 Apache HTTP Server Improper Escaping of Output Vulnerability\n// https://www.cisa.gov/news-events/alerts/2025/05/01/cisa-adds-two-known-exploited-vulnerabilities-catalog\n\nlet FixedVersion = dynamic([\"2.4.60\",\"2.4.61\",\"2.4.62\",\"2.4.63\"]);\nDeviceProcessEvents\n| where TimeGenerated \u003e ago(90d)\n| where InitiatingProcessVersionInfoProductName has \"Apache HTTP Server\"\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where not (InitiatingProcessVersionInfoProductVersion has_any(FixedVersion))\n| project DeviceName, InitiatingProcessVersionInfoProductName, InitiatingProcessVersionInfoProductVersion"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-43451 Zero-Day (NTLM Hash Disclosure Spoofing Vulnerability)",
    "query": "// CVE-2024-43451 Zero-Day (NTLM Hash Disclosure Spoofing Vulnerability)\n// https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-43451\n// In Microsoftâ€™s November 2024 Patch Tuesday, one of the actively exploited zero-day vulnerabilities is CVE-2024-43451. This flaw exposes a userâ€™s NTLMv2 hash, which is used for credential validation in Windows environments. Attackers can use these hashes to authenticate as legitimate users, gaining access to applications and data they have permissions for. The vulnerability affects all Windows versions and requires minimal user interaction to exploit. Simply selecting or inspecting a file could trigger the vulnerability, according to Microsoft.\n// This vulnerability was publicly disclosed by Israel Yeshurun of ClearSky Cyber Security. According to the Microsoft advisory FAQ, it relates to the underlying MSHTML, EdgeHTML, and scripting platforms, which are still supported despite the retirement of Internet Explorer 11 and Microsoft Edge Legacy.\n// Based on this advisory information, I have developed an advanced hunting DefenderXDR KQL to monitor MDE endpoints for NTLM hash activity and Edge WebView usage, along with NTLM over SMB connections to the internet. If this rule triggers, Defender should prompt the user to reset their credentials immediately. The KQL code can be downloaded from my SlimKQL GitHub Repository, which is featured on my LinkedIn profile. (Search for â€œCVE-2024-43451â€)\n\nlet EndpointWithNTLMHash = \nExposureGraphEdges\n| where EdgeLabel == @\"has credentials of\"\n| where EdgeProperties.rawData.ntlmHash.ntlmHash == \"true\"\n// Endpoint with NTLM hash stored\n| distinct SourceNodeName;\nlet VulnerableEndpoint =\nDeviceTvmSoftwareInventory\n// https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-43451 FAQ\n| where SoftwareName == \"edge_webview2_runtime\" or\nSoftwareName == \"internet_explorer\"\n| where DeviceName has_any (EndpointWithNTLMHash)\n| distinct DeviceName;\nDeviceNetworkEvents\n// NTLM over SMB connection\n| where RemotePort == \"445\" and RemoteIPType == \"Public\"\n| where ActionType == \"ConnectionSuccess\"\n| where DeviceName has_any (VulnerableEndpoint)\n\n// Revised Version v2\n\nlet DeviceLNKCreation =\nDeviceFileEvents\n| where ActionType == @\"FileCreated\"\n| where FileName endswith \".lnk\"\n| distinct DeviceName;\nDeviceNetworkEvents\n// NTLM authentication over SMB connection\n| where RemotePort == \"445\" and RemoteIPType == \"Public\"\n| where ActionType == \"ConnectionSuccess\"\n| where DeviceName has_any (DeviceLNKCreation)\n\n// T1550.002: Use Alternate Authentication Material: Pass the Hash"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-43452 PoC Detection",
    "query": "// CVE-2024-43452 PoC Detection\n\n// As the year begins, we've encountered a second significant Windows exploit. A Proof of Concept (PoC) has been released for CVE-2024-43452, a Windows Registry Elevation of Privilege vulnerability (CVSS 7.5) affecting Windows 11 23H2. This PoC, created by Mateusz Jurczyk from Google Project Zero, was inspired by Gabriel Landauâ€™s research on registry vulnerabilities. (Link available in the comments)\n// CVE-2024-43452 PoC: https://project-zero.issues.chromium.org/issues/42451731\n//Fellow defenders, I have developed an advanced hunting DefenderXDR KQL to detect the use of this PoC with high accuracy. Deploy it wisely to prevent abuse by red teams and threat actors.\n\nlet VulnerableEndpoint =\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-43452\"\n| distinct DeviceName;\nlet ExeWithLP =\nDeviceFileEvents\n| where ActionType == @\"FileCreated\"\n| where FileName endswith \".exe\"\n| invoke FileProfile(\"SHA1\",1000)\n| where GlobalPrevalence \u003c= 50\n| join kind=leftouter DeviceFileCertificateInfo on SHA1\n| where SignatureState == @\"Unsigned\"\n| distinct FileName; // An unsual low prevalence unsigned .exe created\nlet EPwithCMDRun =\nDeviceEvents \n| where InitiatingProcessCommandLine has \".exe\" and InitiatingProcessCommandLine has \".dat\"\n| where FileName has_any(ExeWithLP)\n| distinct DeviceName; // Command line execution with low prevalence exe and .dat file\nDeviceNetworkEvents\n| where RemotePort == \"445\"\n| where ActionType == \"ConnectionSuccess\"\n| where DeviceName has_any (EPwithCMDRun) // Successful outbound SMB connection\n| where DeviceName has_any (VulnerableEndpoint) // Not Patch - Vulnerable\n\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-49039 Windows Task Scheduler Elevation of Privilege Vulnerability",
    "query": "// Zero-Day ðŸª² CVE-2024-49039\n// https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-49039\n// A KQL query to detect an authenticated attacker who initially runs a low-privilege AppContainer, which is later elevated with privileges, referencing the Microsoft CVE-2024-49039 Windows Task Scheduler Elevation of Privilege Vulnerability.\n\nlet VulnerableEndpoint = \nDeviceTvmSoftwareVulnerabilities\n| where CveId == \"CVE-2024-49039\"\n| distinct DeviceName;\nlet VulnerableEPwithAppContainer =\nDeviceProcessEvents\n| where ProcessCommandLine contains \"/appcontainer\"\n| where DeviceName has_any(VulnerableEndpoint)\n| distinct DeviceName;\nDeviceProcessEvents\n| where DeviceName has_any(VulnerableEPwithAppContainer)\n| where ProcessTokenElevation == \"TokenElevationTypeFull\""
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-7971 Patch Prioritization",
    "query": "// CVE-2024-7971 Patch Prioritization\n\n//Google has addressed a high-severity Chrome vulnerability that is currently being actively exploited. Itâ€™s crucial to identify which of your global administrators are using a vulnerable version of Chrome, especially if their credential cookies are stored on their endpoints. Given that threat actors are exploiting this flaw, itâ€™s strongly recommended to patch the global admin endpoints immediately to significantly reduce the attack surface.\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) \nand NodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4\n| where NodeProperties has \"Global Administrator\"\n| distinct NodeName;\nlet VulnerableEndPointwithBCookie =\nExposureGraphEdges\n| where EdgeLabel == @\"has credentials of\"\n| where EdgeProperties has \"BrowserCookies\"\n| where TargetNodeName has_any (CriticalIdentities)\n| distinct SourceNodeName;\nDeviceTvmSoftwareVulnerabilities\n| where CveId == \"CVE-2024-7971\"\n| where DeviceName has_any (VulnerableEndPointwithBCookie)\n\n// MITRE ATT\u0026CK Mapping\n\n// T1078.004: Valid Accounts: Cloud Accounts\n// T1539: Steal Web Session Cookie\n// T1190: Exploit Public-Facing Application\n\n//These mappings help in understanding the potential tactics and techniques adversaries might use, based on the identified vulnerabilities and critical identities in your environment."
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-20188 CVSS 10 out of 10",
    "query": "// https://www.bleepingcomputer.com/news/security/cisco-fixes-max-severity-ios-xe-flaw-letting-attackers-hijack-devices/\n// https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-wlc-file-uplpd-rHZG9UfC\n\nDeviceInfo\n| where Vendor has \"cisco\"\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where Model has \"catalyst\" \n| where OSDistribution == \"CiscoXE\""
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-21298 Zero-Click RCE",
    "query": "// https://msrc.microsoft.com/update-guide/en-US/advisory/CVE-2025-21298\n\nlet InboundRTF =\nEmailAttachmentInfo\n| where FileType == \"rtf\"\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\" and LatestDeliveryAction != \"Blocked\"\n| distinct FileName;\nlet VulnerableEP =\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2025-21298\"\n| distinct DeviceName;\nDeviceFileEvents \n| where ActionType == \"FileCreated\" and FileName endswith \".rtf\"\n| where InitiatingProcessFileName == \"outlook.exe\"\n| where parse_json(AdditionalFields)[\"FileType\"] == 'Rtf'\n| where FileName has_any(InboundRTF) and DeviceName has_any(VulnerableEP)"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-22224 (CVSS 9.3 CRITICAL) Internet facing VMware server discovery",
    "query": "// CVE-2025-22224 (CVSS 9.3 CRITICAL) Internet facing VMware server discovery\n\n// https://www.bleepingcomputer.com/news/security/over-37-000-vmware-esxi-servers-vulnerable-to-ongoing-attacks/\n\nlet InternetFacing =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nDeviceProcessEvents\n| where Timestamp \u003e ago(30d)\n| where FileName has \"vmtoolsd\"\n| summarize arg_max(Timestamp, *) by DeviceId\n| where DeviceId has_any(InternetFacing)"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-24054 NTLM Exploit in the Wild Detection",
    "query": "// CVE-2025-24054: NTLM Exploit in the Wild\n\nDeviceFileEvents \n| where ActionType == \"FileCreated\" and FileName endswith \".library-ms\"\n| where parse_json(AdditionalFields)[\"FileType\"] has \"library-ms\"\n| where InitiatingProcessUniqueId != 0\n| join DeviceNetworkEvents on InitiatingProcessUniqueId"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-29824 PipeMagic Detection",
    "query": "// https://www.microsoft.com/en-us/security/blog/2025/04/08/exploitation-of-clfs-zero-day-leads-to-ransomware-activity/\n\nDeviceEvents\n| where ActionType == \"NamedPipeEvent\"\n| extend PipeName = tostring(parse_json(AdditionalFields)[\"PipeName\"])\n| where isnotempty(PipeName)\n| where PipeName matches regex \n@\"\\\\\\\\\\.\\\\pipe\\\\1\\.[0-9A-Fa-f]{32}\""
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-32705 Out-of-bounds Read Detection",
    "query": "// CVE-2025-32705 Out-of-bounds Read Detection\n\nlet InboundMailAttachment =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(1h)\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\" and LatestDeliveryAction != \"Blocked\"\n| distinct FileName;\nlet VulnerableEP =\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2025-32705\"\n| distinct DeviceName;\nlet MailAttachmentOpen =\nDeviceFileEvents\n| where Timestamp \u003e ago(1h) \n| where ActionType == \"FileCreated\"\n| where InitiatingProcessFileName == \"outlook.exe\"\n| where FileName has_any(InboundMailAttachment) and DeviceName has_any(VulnerableEP)\n| distinct DeviceName;\nDeviceEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == \"ReadProcessMemoryApiCall\"\n| where DeviceName has_any(MailAttachmentOpen)"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-4664 Chrome flaw with public exploit",
    "query": "// CVE-2025-4664 Chrome flaw with public exploit\n// https://www.bleepingcomputer.com/news/security/cisa-tags-recently-patched-chrome-bug-as-actively-exploited-zero-day/\n// https://www.bleepingcomputer.com/news/security/google-fixes-high-severity-chrome-flaw-with-public-exploit/\n\nDeviceProcessEvents\n| where Timestamp \u003e ago(30d)\n| where ProcessVersionInfoProductName == \"Google Chrome\"\n| where ProcessVersionInfoProductVersion != \"136.0.7103.114\"\n| summarize arg_max(Timestamp, *) by DeviceId\n| summarize VulnerableVersionCount=count() by ProcessVersionInfoProductVersion\n| sort by VulnerableVersionCount desc"
  },
  {
    "source": "SlimKQL",
    "name": "CVSS 9.8 Rockwell Automation Impacted by High-Severity log4net Vulnerability",
    "query": "// https://securityonline.info/9-8-cvss-score-rockwell-automation-impacted-by-high-severity-log4net-vulnerability/\n// https://www.rockwellautomation.com/en-us/trust-center/security-advisories/advisory.SD1728.html\n\nDeviceInfo\n| where Vendor has \"rockwell\"\n| summarize arg_max(TimeGenerated, *) by DeviceId"
  },
  {
    "source": "SlimKQL",
    "name": "Chrome extension stealth persistence detection",
    "query": "// Chrome extension stealth persistence detection\n\n// Published article from @Syntax-Err0r at https://github.com/Syntax-Err0r\n// https://syntax-err0r.github.io/Silently_Install_Chrome_Extension.html\n\n// Iâ€™ve just come across an intriguing method to silently install Chrome extensions for persistence, avoiding common IOCs. This technique doesnâ€™t require command line parameters or registry edits, making it stealthier than traditional methods. To help detect this type of persistence, Iâ€™ve also crafted a KQL query. Stay ahead of the curve and ensure your defenses are up to date!\n\nlet EPNewChromeConfig =\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName has \"Secure Preferences\" and FolderPath has \"Chrome\"\n| distinct DeviceName;\nDeviceFileEvents\n| where ActionType == \"FileCreated\" and FileName endswith \".crx\"\n| where DeviceName has_any(EPNewChromeConfig)\n| summarize arg_max(Timestamp, *) by SHA1\n| where isnotempty(SHA1)\n| invoke FileProfile(SHA1,10000)\n| where GlobalPrevalence \u003c= 100\n\n// The MITRE ATT\u0026CK technique for malicious Chrome extensions is categorized under T1176: Browser Extensions"
  },
  {
    "source": "SlimKQL",
    "name": "ClickFix social engineering attack detection",
    "query": "// ClickFix social engineering attack detection\n// https://www.proofpoint.com/us/blog/threat-insight/security-brief-clickfix-social-engineering-technique-floods-threat-landscape\n// Threat actors are increasingly using 'ClickFix' social engineering attacks to deploy malware. Proofpoint's latest analysis reveals multiple campaigns since March 2024, targeting popular software like Microsoft Word and Google Chrome. Malware such as AsyncRAT, Danabot, DarkGate, Lumma Stealer, and NetSupport have been identified.\n\nDeviceEvents\n| where (ActionType == \"GetClipboardData\" and InitiatingProcessFileName has \"powershell.exe\") or\n(InitiatingProcessCommandLine has \"powershell\" and InitiatingProcessCommandLine has \"-enc\")"
  },
  {
    "source": "SlimKQL",
    "name": "CloudApp Privilege OAuth Grant",
    "query": "//CloudApp Privilege OAuth Grant\n//https://www.linkedin.com/feed/update/urn:li:activity:7167157961109303296/\n\n//Custom KQL Defender detection rule running at continuous NRT (Near Real-Time) detecting assignments of high privileged permissions to OAuth application in seconds!\n\nCloudAppEvents\n| where ActionType == \"Consent to application.\" and AccountType == \"Admin\"\n| extend AdminUPN = tostring(RawEventData.UserId)\n| extend ConsentData = tostring(RawEventData.ModifiedProperties)\n| project Timestamp, AdminUPN, ActionType, ObjectName, ConsentData, ReportId\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query is primarily focused on detecting administrative consent to applications, which can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may leverage valid accounts to gain access to and interact with systems, including using administrative accounts to consent to applications.\n// Detection: Monitoring for unusual or unauthorized use of administrative accounts, especially for actions like consenting to applications, can help detect this technique.\n\n// T1098 - Account Manipulation:\n// Description: Adversaries may manipulate accounts to maintain access to systems, including granting consent to applications that may provide additional access or capabilities.\n// Detection: Detecting changes in account permissions or consent to applications by administrative accounts can indicate potential account manipulation.\n\n// T1071 - Application Layer Protocol:\n// Description: Adversaries may use application layer protocols to communicate with systems under their control, including using OAuth tokens obtained through consent to applications.\n// Detection: Monitoring for unusual application consent activities can help identify potential misuse of application layer protocols.\n\n// By mapping the KQL query to these MITRE ATT\u0026CK techniques, you can better understand the potential threats and improve your detection capabilities."
  },
  {
    "source": "SlimKQL",
    "name": "CloudApp Suspicious Copilot Agent Detection",
    "query": "// CloudApp Suspicious Copilot Agent Detection\n\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where Application == @\"Microsoft 365\"\n| where ActionType in (\"BotCreate\", \"BotUpdateOperation-BotPublish\")\n| where UncommonForUser has \"ISP\" or UncommonForUser has \"CountryCode\"\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Cobalt Strike HTTPS beaconing over Microsoft Graph API",
    "query": "// Cobalt Strike HTTPS beaconing over Microsoft Graph API\n// https://www.linkedin.com/posts/activity-7186027037558505472-3pMe/\n\n// Interesting observation if you have MDE or MDC enabled, running the below KQL query help me to visualize some important graph elevated traffics run by my privilege role admins. This is something worth monitoring for potential threat, e.g looking at the InitiatingProcessFileName \u0026 InitiatingProcessCommandLine \n\nDeviceNetworkEvents\n| where RemoteUrl contains \"graph.microsoft.com\"\n| where InitiatingProcessTokenElevation == @\"TokenElevationTypeFull\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the criteria in the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The query filters for network events involving â€œgraph.microsoft.comâ€, which is a web service. This aligns with the use of web protocols for communication1.\n\n// T1078 - Valid Accounts:\n// The filter for InitiatingProcessTokenElevation == @\"TokenElevationTypeFull\" suggests the use of elevated privileges. This can be associated with the use of valid accounts with higher privileges2.\n\n// T1078.003 - Valid Accounts: Local Accounts:\n\n// If the elevated token is associated with a local account, this technique is relevant2. These mappings help in identifying and categorizing the detected activities within the MITRE ATT\u0026CK framework, aiding in better understanding and response to potential threats."
  },
  {
    "source": "SlimKQL",
    "name": "Cookie-Bite Detection",
    "query": "// https://www.varonis.com/blog/cookie-bite\n// https://www.bleepingcomputer.com/news/security/cookie-bite-attack-poc-uses-chrome-extension-to-steal-session-tokens/\n\nlet EPwithNewExt =\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".crx\"\n| distinct DeviceName;\nDeviceProcessEvents\n| where FileName =~ \"powershell.exe\" or InitiatingProcessFileName =~\"powershell.exe\"\n| where ProcessCommandLine has_any (\"load-extension\")\n| where DeviceName has_any(EPwithNewExt)"
  },
  {
    "source": "SlimKQL",
    "name": "Critical Identities OAuth Grant",
    "query": "// Critical Identities OAuth Grant\n// https://www.linkedin.com/posts/0x534c_defenderxdr-customdetection-exposuremanagement-activity-7182677630733725696-MF_U/\n\n// Custom DefenderXDR detection rule for critical identities marked by exposure management for performing an OAuth grant to an application. Bear in mind critical identites hold highly privilege roles, any OAuth grant to any rouge application would be disastrous. Therefore it is vital for SecOps to monitor organization's critical identities OAuth grant unless you have an OAuth Cloud App policy that blocks all grant by default. ðŸ«¡\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) \nand NodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4\n| extend AccountID = tostring(NodeProperties.rawData.accountObjectId)\n| distinct AccountID;\nCloudAppEvents\n| where ActivityType == \"Add\"\n| where ActionType == @\"Consent to application.\"\n| where AccountId has_any(CriticalIdentities)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// The query identifies critical accounts that might be used for legitimate access but could be leveraged by adversaries for malicious purposes.\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The detection of â€œConsent to applicationâ€ events can be related to the use of web protocols for application consent, which might be exploited by adversaries to gain access to cloud applications.\n\n// T1098 - Account Manipulation:\n// The query looks for consent to applications, which can be a form of account manipulation if adversaries are granting permissions to malicious applications."
  },
  {
    "source": "SlimKQL",
    "name": "Critical Identities Privilege Escalation on Entra Service Principal",
    "query": "// Critical Identities Privilege Escalation on Entra Service Principal\n// https://www.linkedin.com/posts/0x534c_defenderxdr-customdetection-exposuremanagement-activity-7182618135659692032-HsE5/\n\n//Custom DefenderXDR privilege escalation detection rule for critical identities marked by exposure management for adding Entra service principal credentials. It is vital for SecOps to monitor organization's critical identities for any potential privilege escalation in Entra service principals.\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) \nand NodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4\n| extend AccountID = tostring(NodeProperties.rawData.accountObjectId)\n| distinct AccountID;\nCloudAppEvents\n| where ActivityType == \"Add\"\n| where ActionType == @\"Add service principal credentials.\"\n| where AccountId has_any(CriticalIdentities)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1078.004 - Valid Accounts: Cloud Accounts:\n// The query is looking for the addition of service principal credentials, which can be associated with the use of valid cloud accounts to gain unauthorized access.\n\n// T1098 - Account Manipulation:\n// Adding service principal credentials can be seen as a form of account manipulation, where adversaries modify accounts to maintain access.\n\n// T1078 - Valid Accounts:\n// The use of valid accounts, especially those with elevated privileges, is a common technique for maintaining persistence and accessing resources."
  },
  {
    "source": "SlimKQL",
    "name": "Critical Monitor for Critical Assets",
    "query": "// Critical Monitor for Critical Assets\n// https://www.linkedin.com/posts/activity-7189844353610088448-BajA/\n\n// Custom DefenderXDR KQL Monitor for Tier 0 Critical Identities on High Security Alerts:\n\nlet HighlyPrivilegedAdmins =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and \nNodeProperties.rawData.criticalityLevel.criticalityLevel==0 \n| extend EntraObjectID = NodeProperties.rawData.accountObjectId\n| project EntraObjectID;\nAlertInfo\n| join AlertEvidence on AlertId\n| extend ReportId = AlertId\n| where Severity == \"High\"\n| where AccountObjectId has_any(HighlyPrivilegedAdmins)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query identifies highly privileged accounts, which could be used by adversaries to gain unauthorized access.\n\n// T1087 - Account Discovery:\n// The process of identifying highly privileged accounts aligns with account discovery techniques.\n\n// T1071 - Application Layer Protocol:\n// The query joins alert information, which could involve detecting communication over application layer protocols.\n\n// T1566 - Phishing:\n// High severity alerts could be related to phishing attempts targeting privileged accounts.\n\n// T1210 - Exploitation of Remote Services:\n// High severity alerts involving privileged accounts could indicate exploitation attempts on remote services."
  },
  {
    "source": "SlimKQL",
    "name": "Critical OpenSSH Vulnerabilities â€“ Patch Prioritization",
    "query": "// Critical OpenSSH Vulnerabilities â€“ Patch Prioritization\n\n// The following KQL identified all your internet facing OpenSSH servers vulnerable to CVE-2025-26466 and CVE-2025-26465. You should get your IT infra engineers to prioritize patching these servers to version 9.9p2 that is released on 18th Feb 2025. Let's Go ! ðŸ›¡ï¸\n\n// https://www.openwall.com/lists/oss-security/2025/02/18/1\n// https://www.openssh.com/releasenotes.html\n\nlet InternetFacingEP =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nlet OpenSSHFixedVersion = dynamic([\"9.9p2\"]); // https://www.openssh.com/releasenotes.html\nDeviceTvmSoftwareInventory\n| where SoftwareName has \"openssh\"\n| where not (SoftwareVersion has_any(OpenSSHFixedVersion))\n| where DeviceId has_any(InternetFacingEP)"
  },
  {
    "source": "SlimKQL",
    "name": "Critical identities with zero-day Chrome vulnerability",
    "query": "// Critical identities with zero-day Chrome vulnerability\n// CVE-2025-4664 Chrome flaw with public exploit\n// https://www.bleepingcomputer.com/news/security/cisa-tags-recently-patched-chrome-bug-as-actively-exploited-zero-day/\n// https://www.bleepingcomputer.com/news/security/google-fixes-high-severity-chrome-flaw-with-public-exploit/\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet AdminDevices =\nExposureGraphEdges \n| where EdgeLabel == \"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nDeviceProcessEvents\n| where Timestamp \u003e ago(30d)\n| where ProcessVersionInfoProductName == \"Google Chrome\"\n| where ProcessVersionInfoProductVersion != \"136.0.7103.114\" and\nProcessVersionInfoProductVersion != \"136.0.7103.113\"\n| summarize arg_max(Timestamp, *) by DeviceId\n| where DeviceName has_any(AdminDevices)"
  },
  {
    "source": "SlimKQL",
    "name": "Custom Detection Rule for CUPS Installation in DefenderXDR",
    "query": "// Custom Detection Rule for CUPS Installation in DefenderXDR\n\n// Iâ€™ve come up with an exciting idea! ðŸ˜… How about a custom detection rule in DefenderXDR that identifies CUPS installations and automatically isolates the device if it detects an inbound UDP packet on port 631? This could serve as an auto-defense mechanism. What do you thinkâ€”could it work? ðŸ¤”\n\n\n// Custom DefenderXDR Rule for CUPS Installation Detection and Isolation\n\nlet EndpointwithCUPS =\nDeviceTvmSoftwareInventory\n| where SoftwareName has \"cups\"\n| project DeviceName;\nDeviceNetworkEvents\n| where DeviceName has_any(EndpointwithCUPS)\n| where Protocol has \"Udp\" \n| where LocalPort in (631)\n| where ActionType == \"InboundConnectionAttempt\"\nor ActionType == \"ConnectionFailed\"\n\n//"
  },
  {
    "source": "SlimKQL",
    "name": "Custom Detection for CVE-2024-38200 NTLMv2 Hash Exposure",
    "query": "// Custom Detection for CVE-2024-38200 NTLMv2 Hash Exposure ðŸŽ«\n\n// https://github.com/passtheticket/CVE-2024-38200\n\n// CVE-2024-38200 is a high-severity spoofing vulnerability in Microsoft Office. This flaw allows attackers to exploit a weakness in Microsoft Office, potentially exposing sensitive information such as NTLM hashes (NTLMv2) to unauthorized actors. The vulnerability affects multiple versions of Microsoft Office, including Office 2016, Office 2019, and the Office Long Term Servicing Channel (LTSC) 2021. It was discovered by Metin Yunus Kandemir (passtheticket), and the proof of concept (POC) and details are shared below.\n// Although the vulnerability was addressed in the August 2024 security updates for Microsoft Office, organizations without automated patching solutions may still be exposed. If you use Microsoft Defender for Office 365, you can create a custom detection on DefenderXDR to identify potential abuse of this vulnerability. I have shared the KQL for this detection on my GitHub.\n\nlet OfficeURIs = dynamic([\"ms-word:\", \"ms-powerpoint:\", \"ms-excel:\", \"ms-visio:\", \"ms-access:\", \"ms-project:\", \"ms-publisher:\", \"ms-spd:\", \"ms-infopath:\"]);\nlet OfficeURICommands = dynamic([\"ofv\", \"ofe\"]);\nUrlClickEvents\n| where ActionType == @\"ClickAllowed\"\n| where UrlChain has_any (OfficeURIs) and UrlChain has_any (OfficeURICommands)\n| project Timestamp, ReportId, AccountUpn, IPAddress,  Workload, UrlChain\n\n// MITRE ATT\u0026CK\n// Technique: User Execution (T1204)\n// Sub-technique: Malicious File (T1204.002)\n// Technique: Application Layer Protocol (T1071)\n// Sub-technique: Web Protocols (T1071.001)"
  },
  {
    "source": "SlimKQL",
    "name": "Data Exfiltration via Microsoft Teams",
    "query": "// Data Exfiltration via Microsoft Teams\n// https://www.linkedin.com/posts/activity-7202676905441964032-Qi3m/\n\n// Should a malicious actor gain access to an Office 365 user account and initiate the unauthorized transfer of email content by utilizing Power Automate to trigger an Office 365 Outlook flow that sends a Teams message to an external domain upon the arrival of a new email, do you possess the detection capabilities for such unauthorized data transfers? The KQL script provided leverages Microsoft Defenderâ€™s CloudAppEvents to identify unusual patterns in the volume of Teams messages directed to specific external domains. Upon activation of the monitoring alert, the security team is prompted to conduct a thorough investigation to verify the authenticity of the Teams communications. In instances where your users frequently collaborate with known external partner tenants, implementing a whitelist can help avert unwarranted rule activations.\n\nCloudAppEvents\n| where Application == \"Microsoft Teams\"\n| where ActionType == \"MessageSent\"\n| extend AccountUPN = RawEventData.UserId\n| extend CommsType = RawEventData.CommunicationType\n| extend ExternalTenant = RawEventData.ParticipantInfo.HasForeignTenantUsers\n| extend ExtUserDomain = tostring(split(AccountUPN, '@')[1])\n| where CommsType == \"OneOnOne\" or CommsType == \"GroupChat\"\n| where ExternalTenant == \"true\"\n| where ExtUserDomain != \"\"\n| summarize Count=count() by ExtUserDomain\n| sort by Count desc\n// Set your Teams msg trigger threshold to external tenant \n| where Count \u003e 20\n// Whitelist External Partner Domain\n| where ExtUserDomain !contains \"trusteddomain.com\"\n\n\n// MITRE ATT\u0026CK Mapping\n\n// This query can be mapped to several MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// Detects the use of web protocols for communication, which in this case is Microsoft Teams1.\n\n// T1102.002 - Web Service: Application Deployment Software:\n// Identifies the use of web services for application deployment, relevant to the detection of messages sent via Teams2.\n\n// T1078 - Valid Accounts:\n// Detects the use of valid accounts, especially focusing on external tenants which might indicate compromised or unauthorized access3.\n\n// T1087.001 - Account Discovery: Local Account:\n// Involves discovering accounts, here focusing on external user domains4."
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR - Threat Hunting DNS Tunneling",
    "query": "// DefenderXDR - Threat Hunting DNS Tunneling\n\n// DNS tunneling use either A records or TXT records for an infected host to receive data\n// To exfiltrate data to a C2 server, the DNS queries for infected host will spike with long queried hostname\n\nlet DNSHostnameLengthCheck = 40;\nDeviceEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == @\"DnsQueryResponse\"\n| extend DNSHostQuery = tostring(parse_json(AdditionalFields).DnsQueryString)\n| where strlen(DNSHostQuery) \u003e DNSHostnameLengthCheck\n| summarize DNSQueriedHost=dcount(DNSHostQuery) by DeviceName\n| sort by DNSQueriedHost desc\n\n// Query 2 - Analyze suspected DNS tunneling top host\n// Look for sample generated DNS request like below:\n// 0018786966.96428380.04.5E43287B03114C04A64F68C0C23E44F4.n.156.887.empty.6_1._t_i.3000.explorer_exe.156.rc2.a4h9uploading[.]com"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Advanced Hunting All-In-One IP Search",
    "query": "// DefenderXDR Advanced Hunting All-In-One IP Search\n// https://www.linkedin.com/pulse/defenderxdr-advanced-hunting-all-in-one-ip-search-steven-lim-a2j7c/\n\n// This KQL query searches across these DefenderXDR log tables for the ip variable that is defined at the start:\n// AADSignInEventsBeta, AADSignInEventsBeta, CloudAppEvents, IdentityLogonEvents, UrlClickEvents, DeviceNetworkInfo, CloudAuditEvents, DeviceFileEvents, AlertEvidence, BehaviorEntities, DeviceEvents, DeviceLogonEvents, DeviceNetworkEvents, EmailEvents, DeviceInfo and ExposureGraphNodes\n\nlet ip = \"223.171.89.199\"; // Sample Malicious IP\nsearch in (AADSignInEventsBeta, AADSignInEventsBeta, CloudAppEvents, IdentityLogonEvents, CloudAuditEvents, UrlClickEvents, DeviceNetworkInfo, CloudAuditEvents, DeviceFileEvents, AlertEvidence, ExposureGraphNodes, BehaviorEntities, DeviceEvents, DeviceLogonEvents, DeviceNetworkEvents, EmailEvents, DeviceInfo)\nTimestamp between (ago(7d) .. now())\nand (\n// AADSignInEventsBeta AADSpnSignInEventsBeta CloudAppEvents IdentityLogonEvents\n// UrlClickEvents DeviceNetworkInfo CloudAuditEvents\nIPAddress == ip\n// DeviceFileEvents\nor RequestSourceIP == ip\n// AlertEvidence BehaviorEntities DeviceEvents DeviceLogonEvents DeviceNetworkEvents\nor RemoteIP == ip\n// DeviceEvents DeviceFileEvents\nor FileOriginIP == ip\n// EmailEvents\nor SenderIPv4 == ip\n// IdentityLogonEvents\nor DestinationIPAddress == ip\n// DeviceInfo\nor PublicIP == ip\n// AlertEvidence BehaviorEntities DeviceEvents DeviceNetworkEvents\nor LocalIP == ip\n// ExposureGraphNodes\nor NodeProperties.rawData.publicIP == ip\n) \n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the fields and data sources used in the KQL query, here are some potential MITRE ATT\u0026CK techniques that could be detected:\n\n// T1071.001 - Application Layer Protocol: Web Protocols\n// Data Source: CloudAppEvents, UrlClickEvents\n// Field: IPAddress, RequestSourceIP, RemoteIP\n\n// T1078 - Valid Accounts\n// Data Source: AADSignInEventsBeta, IdentityLogonEvents\n// Field: IPAddress, RequestSourceIP, RemoteIP\n\n// T1040 - Network Sniffing\n// Data Source: DeviceNetworkInfo, DeviceNetworkEvents\n// Field: IPAddress, RemoteIP, LocalIP\n\n// T1105 - Ingress Tool Transfer\n// Data Source: DeviceFileEvents, CloudAuditEvents\n// Field: FileOriginIP, RequestSourceIP\n\n// T1566.001 - Phishing: Spearphishing Attachment\n// Data Source: EmailEvents\n// Field: SenderIPv4\n\n// T1071.004 - Application Layer Protocol: DNS\n// Data Source: DeviceNetworkEvents\n// Field: DestinationIPAddress, PublicIP\n\n// T1087.001 - Account Discovery: Local Account\n// Data Source: DeviceLogonEvents\n// Field: IPAddress, RemoteIP\n\n// T1136.001 - Create Account: Local Account\n// Data Source: IdentityLogonEvents\n// Field: IPAddress, RequestSourceIP"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Advanced Hunting All-In-One UPN Search",
    "query": "// DefenderXDR Advanced Hunting All-In-One UPN Search\n// https://www.linkedin.com/pulse/defenderxdr-advanced-hunting-all-in-one-upn-search-steven-lim-zdlic/\n\n// This KQL query searches across these DefenderXDR log tables for the UPN variable that is defined at the start:\n// AlertEvidence, BehaviorEntities, BehaviorInfo, AADSignInEventsBeta, IdentityInfo, IdentityLogonEvents, UrlClickEvents, DeviceEvents, DeviceFileEvents, DeviceImageLoadEvents, DeviceLogonEvents, DeviceNetworkEvents, DeviceProcessEvents, DeviceRegistryEvents, CloudAppEvents, EmailAttachmentInfo, EmailEvents, EmailPostDeliveryEvents, CloudAuditEvents, ExposureGraphNodes\n\nlet upn = \"John.Doe@Microsoft.com\"; // Enter Your Search UPN\nsearch in (AlertEvidence, BehaviorEntities, BehaviorInfo, AADSignInEventsBeta,\nIdentityInfo, IdentityLogonEvents, UrlClickEvents, DeviceEvents, DeviceFileEvents,\nDeviceImageLoadEvents, DeviceLogonEvents, DeviceNetworkEvents, DeviceProcessEvents,\nDeviceRegistryEvents, CloudAppEvents, EmailAttachmentInfo, EmailEvents, \nEmailPostDeliveryEvents, CloudAuditEvents, ExposureGraphNodes)\nTimestamp between (ago(1d) .. now())\nand (\n// AlertEvidence BehaviorEntities BehaviorInfo DeviceProcessEvents\n// AADSignInEventsBeta IdentityInfo IdentityLogonEvents UrlClickEvents \nAccountUpn == upn\n// DeviceEvents DeviceFileEvents DeviceImageLoadEvents DeviceLogonEvents\n// DeviceNetworkEvents DeviceProcessEvents DeviceRegistryEvents \nor InitiatingProcessAccountUpn == upn\n// CloudAppEvents\nor tostring(RawEventData.UserId) == upn\n// EmailAttachmentInfo EmailEvents EmailPostDeliveryEvents  \nor SenderFromAddress == upn\nor RecipientEmailAddress == upn\n// CloudAuditEvents \nor RawEventData contains upn\n//ExposureGraphNodes\nor NodeProperties.rawData contains upn\n)\n\n// MITRE ATT\u0026CK Mapping\n\n// The query can be associated with several MITRE ATT\u0026CK techniques based on the data sources and fields being queried:\n\n// Credential Access:\n// T1078: Valid Accounts - Searching for AccountUpn and InitiatingProcessAccountUpn can help detect unauthorized use of valid accounts.\n\n// Initial Access:\n// T1071: Application Layer Protocol - UrlClickEvents and EmailEvents can be used to detect phishing attempts or malicious links.\n\n// Execution:\n// T1059: Command and Scripting Interpreter - DeviceProcessEvents can help detect suspicious script execution.\n\n// Persistence:\n// T1078: Valid Accounts - Repeated logon events (DeviceLogonEvents) can indicate persistence mechanisms.\n\n// Privilege Escalation:\n// T1055: Process Injection - DeviceProcessEvents can be used to detect process injection techniques.\n\n// Defense Evasion:\n// T1070: Indicator Removal on Host - DeviceRegistryEvents can help detect attempts to modify registry keys to evade detection.\n\n// Discovery:\n// T1083: File and Directory Discovery - DeviceFileEvents can be used to detect file and directory discovery activities.\n\n// Lateral Movement:\n// T1021: Remote Services - DeviceNetworkEvents can help detect lateral movement through remote services.\n\n// Collection:\n// T1114: Email Collection - EmailEvents and EmailAttachmentInfo can be used to detect email collection activities.\n\n// Exfiltration:\n// T1041: Exfiltration Over C2 Channel - CloudAppEvents can help detect data exfiltration over cloud applications.\n\n// Impact:\n// T1486: Data Encrypted for Impact - DeviceFileEvents can help detect ransomware activities."
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Exposure Management for CVE-2024-3094",
    "query": "//DefenderXDR Exposure Management for CVE-2024-3094\n//https://www.linkedin.com/posts/activity-7180041278829580288-I4hU/\n\n//After reading so many infosec posts relating XZ, I decided to build this high precision KQL detection using the latest DefenderXDR exposure management capability to determine Azure internet facing Linux machines that has vulnerable compromised XZ and running SSHD which are susceptible to RCE attack. If you have this rule triggered, I would strongly suggest you quickly remediate your Linux VM.ðŸ«¡\n\nlet DeviceWithVulnerableXZ =\nDeviceTvmSoftwareInventory \n| where SoftwareName contains \"xz\"\n| where SoftwareVersion contains \"5.6.\"\n| distinct DeviceName;\nlet DevicewithSSHD =\nDeviceNetworkEvents\n| where ActionType == \"ListeningConnectionCreated\"\n| where LocalPort == 22\n| distinct DeviceName;\nExposureGraphNodes\n| where NodeLabel == 'device' or (Categories has 'virtual_machine' and set_has_element(Categories, 'virtual_machine'))\n// Condition: Internet Facing with vulnerable XZ and running SSHD\n| where NodeProperties.rawData.isInternetFacing == true\n| where NodeName has_any (DeviceWithVulnerableXZ)\n| where NodeName has_any (DevicewithSSHD)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1190 - Exploit Public-Facing Application:\n// The query identifies internet-facing devices with vulnerable software, which could be exploited by attackers.\n\n// T1078 - Valid Accounts:\n// The presence of SSHD (port 22) suggests potential use of valid accounts for remote access.\n\n// T1046 - Network Service Scanning:\n// Identifying devices with specific services running (like SSHD) can be part of network service scanning activities.\n\n// T1210 - Exploitation of Remote Services:\n// Exploiting vulnerabilities in remote services (like SSHD) to gain unauthorized access."
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Exposure Management for hashtag#RegreSSHion",
    "query": "// DefenderXDR Exposure Management for hashtag#RegreSSHion\n// https://www.linkedin.com/posts/activity-7214788756237639680-rGkW/\n\n//Use below KQL to determine your internet facing VM with OpenSSH and prioritize the following:\n// - Access Control\n// - Host-based Intrusion Prevention (E.g fail2ban)\n// - SSH Configuration Hardening\n// (E.g LoginGraceTime/MaxStartups/PerSourceMaxStartups)\n\n// Refer to Splunk Mitigation Strategies for CVE-2024-6387\n// Link: https://lnkd.in/gFPsbcaW\n\nlet InternetFacingVM=\nExposureGraphNodes\n| where NodeLabel == 'device' or (Categories has 'virtual_machine' and set_has_element(Categories, 'virtual_machine'))\n| where NodeProperties.rawData.isInternetFacing == true\n| extend InternetFacingDeviceName=tostring(NodeProperties.rawData.deviceName)\n| project InternetFacingDeviceName;\nDeviceTvmSoftwareInventory\n| where SoftwareName contains \"openssh\"\n| where DeviceName has_any(InternetFacingVM)\n\n \n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations performed in the KQL code, here are the relevant MITRE ATT\u0026CK techniques:\n\n// T1133 - External Remote Services:\n// Description: Adversaries may leverage external remote services to access and control systems over the internet.\n// Relevance: The query identifies internet-facing devices, which could be targeted for remote access via services like OpenSSH.\n\n// T1210 - Exploitation of Remote Services:\n// Description: Adversaries may exploit vulnerabilities in remote services to gain unauthorized access.\n// Relevance: By identifying devices with OpenSSH, the query highlights potential targets for exploitation.\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to gain access to remote services.\n// Relevance: OpenSSH is often used for secure remote access, and valid accounts could be used to log in to these services.\n\n// T1046 - Network Service Scanning:\n// Description: Adversaries may scan for network services to identify potential entry points.\n// Relevance: The queryâ€™s focus on internet-facing devices and specific software (OpenSSH) aligns with the reconnaissance phase of identifying exploitable services."
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR LDAP Enumeration Detection",
    "query": "// DefenderXDR LDAP Enumeration Detection\n\nlet ADAdministrator = dynamic([\"Jack.Sparrow@acme.org\"]);\nIdentityQueryEvents\n| where ActionType == \"LDAP query\"\n| where QueryType == \"AllObjects\"\n| extend LDAPQueryCount = toint(parse_json(AdditionalFields)[\"Count\"])\n| where LDAPQueryCount \u003e 500\n| where not (TargetAccountUpn has_any(ADAdministrator))"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR M365 Copilot Extensions Threat Monitoring",
    "query": "// DefenderXDR M365 Copilot Extensions Threat Monitoring\n\n// This morning, I posted on LinkedIn about the ConfusedPilot attack vector and shared a Sentinel analytic rule to monitor Copilot extensionsâ€™ external data access for potential malicious data poisoning. A community member mentioned they donâ€™t have Sentinel and asked if this can be done in DefenderXDR. The short answer is yes. You just need to access an external data feed of malicious domains. In my KQL code example, I used Romain Marcouxâ€™s feed of malicious domains, but you can replace the URL with your preferred external data feed.\n\n// ConfusedPilot Attack Vector:\n// https://www.linkedin.com/posts/0x534c_confusedpilot-activity-7252113628470943744-BgxN/\n\n// M365 Copilot Extensions Threat Monitoring (Sentinel)\n// https://www.linkedin.com/posts/0x534c_cybersecurity-generativeai-copilot-activity-7251091656249090048-GfSg/\n\n// Malicious Domain Feed\n// https://github.com/romainmarcoux/malicious-domains\n\nlet MaliciousDomainTable=externaldata(RawData:string)[h'https://raw.githubusercontent.com/romainmarcoux/malicious-domains/main/full-domains-aa.txt']\n| parse RawData with MaliciousDomain:string;\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotPlugin = tostring(CopilotData.AISystemPlugin[0].Id)\n| where isnotempty(CopilotPlugin)\n| extend PluginAccessURL = tostring(CopilotData.AccessedResources)\n| mv-expand todynamic(PluginAccessURL)\n| where PluginAccessURL has \"SiteUrl\"\n| extend Url = tostring(PluginAccessURL.SiteUrl)\n| extend Domain = tostring(parse_url(Url).Host)\n| extend Action = tostring(PluginAccessURL.Action)\n| join MaliciousDomainTable on $left.Domain == $right.MaliciousDomain\n\n// MITRE ATT\u0026CK\n// T1116 Browser Extensions"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR MITRE ATT\u0026CK Technique Analysis",
    "query": "// DefenderXDR MITRE ATT\u0026CK Technique Analysis\n\nAlertEvidence\n|where Timestamp \u003e ago(30d)\n| mv-expand parse_json(AttackTechniques)\n| where isnotempty(AttackTechniques)\n| summarize TechniqueCount=count() by tostring(AttackTechniques)\n| sort by TechniqueCount\n\n// Export the result as a CSV\n// Copilot Prompt:\n// Can you help me generate MITRE ATT\u0026CK Techniques heatmap using standard MITRE ATT\u0026CK Enterprise framework with the attached CSV data?"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Medusa Ransomware Detection",
    "query": "// DefenderXDR: Medusa Ransomware Detection\n\n// https://www.cisa.gov/sites/default/files/2025-03/aa25-071a-stopransomware-medusa-ransomware.pdf\n\nlet MedusaDiscovery = dynamic([\"21\", \"22\", \"23\", \"80\", \"115\", \"443\", \"1433\", \"3050\", \"3128\", \"3306\", \"3389\"]);\nDeviceNetworkEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == @\"ConnectionAttempt\"\n| where parse_json(AdditionalFields)[\"direction\"] == 'In'\n| where LocalPort in (MedusaDiscovery)\n| summarize TargetDevice=dcount(DeviceName), TargetPort=dcount(LocalPort) by RemoteIP\n| where TargetPort == 11 // Matched all the MedusaDiscovery ports"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Weekly OSINT Indicators Scan 05052025",
    "query": "// https://security.microsoft.com/intel-explorer/articles/cd8a2200\n// DefenderXDR Weekly OSINT Indicators Scan 05052025\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/WeeklyOSINT05May2025.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Weekly OSINT Indicators Scan 10032025",
    "query": "// DefenderXDR Weekly OSINT Indicators Scan 10032025\n\n// https://www.linkedin.com/posts/0x534c_cybersecurity-osint-defenderxdr-activity-7297886477198180353-K_0Y/\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/WeeklyOSINTHightlights10Mar2025.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Weekly OSINT Indicators Scan 12052025",
    "query": "// https://security.microsoft.com/intel-explorer/articles/bc23c9d3\n// DefenderXDR Weekly OSINT Indicators Scan 12052025\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/WeeklyOSINT12May2025.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Weekly OSINT Indicators Scan 19052025",
    "query": "// https://security.microsoft.com/intel-explorer/articles/eb2f0669\n// DefenderXDR Weekly OSINT Indicators Scan 19052025\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/WeeklyOSINT19May2025.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Weekly OSINT Indicators Scan 24022025",
    "query": "// DefenderXDR Weekly OSINT Indicators Scan\n\n// https://www.linkedin.com/posts/0x534c_cybersecurity-osint-defenderxdr-activity-7297886477198180353-K_0Y/\n// https://security.microsoft.com/intel-explorer/articles/681e9886\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/WeeklyOSINTHightlights24Feb2025.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR Weekly OSINT Indicators Scan",
    "query": "// DefenderXDR Weekly OSINT Indicators Scan\n\n// https://www.linkedin.com/posts/0x534c_cybersecurity-osint-defenderxdr-activity-7297886477198180353-K_0Y/\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/WeeklyOSINTHightlights17Feb2025.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "DefenderXDR exposure management for CVE-2024-38021",
    "query": "// DefenderXDR exposure management for CVE-2024-38021\n// https://www.linkedin.com/posts/activity-7216965236816297984-sJRu/\n\n// July's Patch Tuesday unveiled critical Outlook moniker RCE dubbed as CVE-2024-38021. Do you know who are your Entra organization critical identities running a vulnerable Outlook that susceptible moniker RCE ? Prioritize on your Entra critical identities Outlook remediation as they hold keys to your Entra kingdom!\n\n// Advance Hunting KQL to check Entra critical identities running vulnerable outlook:\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet CriticalDevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-38021\"\n| where DeviceName has_any (CriticalDevices)\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL code is designed to identify critical identities and devices, and then find devices with a specific vulnerability. The associated MITRE ATT\u0026CK techniques include:\n\n// T1078: Valid Accounts\n// T1077: Windows Admin Shares\n// T1190: Exploit Public-Facing Application\n// T1203: Exploitation for Client Execution"
  },
  {
    "source": "SlimKQL",
    "name": "Defending against CVE-2024-21413 Outlook MonikerLink Bug Abuse",
    "query": "//Defending against CVE-2024-21413 Outlook MonikerLink Bug Abuse\n//https://www.linkedin.com/pulse/defending-against-cve-2024-21413-outlook-monikerlink-bug-steven-lim-wesac/\n\nlet VulnerableEndpoints =\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-21413\"\n| project DeviceId;\nDeviceProcessEvents\n| where FileName==\"OUTLOOK.EXE\"\n| join DeviceNetworkEvents on DeviceId\n| where DeviceId has_any(VulnerableEndpoints)\n| where RemotePort == 445\n| where RemoteIPType==\"Public\"\n| where ActionType1==\"ConnectionSuccess\"\n| project Timestamp, DeviceName, AccountUpn, ActionType1, RemoteIP\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The query checks for network connections, which can be associated with the use of application layer protocols.\n\n// T1047 - Windows Management Instrumentation:\n// Monitoring OUTLOOK.EXE could be related to the use of legitimate software for malicious purposes.\n\n// T1078 - Valid Accounts:\n// The query projects AccountUpn, indicating a focus on user accounts, which could be related to the use of valid accounts for malicious activities.\n\n// T1049 - System Network Connections Discovery:\n// The query checks for network connections, which aligns with discovering network connections on the system.\n\n// T1105 - Ingress Tool Transfer:\n// The focus on successful connections to public IPs on port 445 could indicate data transfer or tool ingress."
  },
  {
    "source": "SlimKQL",
    "name": "Defending against Windows Internet Shortcut Files Security Feature Bypass Vulnerability (CVE-2024-21412)",
    "query": "//Defending against Windows Internet Shortcut Files Security Feature Bypass Vulnerability (CVE-2024-21412)\n//https://www.linkedin.com/pulse/defending-against-windows-internet-shortcut-files-security-steven-lim-tbnoe/\n\nUrlClickEvents\n| where Timestamp \u003e ago (1h)\n| where UrlChain matches regex \"https?://.+\\\\.url(\\\\?.*)?(#.*)?$\" \n\n// MITRE ATT\u0026CK Mapping\n\n// The query seems to focus on detecting potentially malicious URL clicks, which can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// This technique involves adversaries using web protocols to communicate with compromised systems. Detecting specific URL patterns can help identify such communications1.\n\n// T1204.001 - User Execution: Malicious Link:\n// This technique involves users executing malicious links. By filtering URL click events, you can detect instances where users might have clicked on suspicious or malicious URLs2.\n\n// T1566.002 - Phishing: Spearphishing Link:\n// This technique involves adversaries sending emails with malicious links. Monitoring URL click events can help detect when users click on links that might be part of a phishing campaign3."
  },
  {
    "source": "SlimKQL",
    "name": "Defending against dot zip domain phishing attack",
    "query": "// Defending against dot zip domain phishing attack with Microsoft 365 Defender Advanced Hunting\n// https://www.linkedin.com/pulse/defending-against-zip-domain-phishing-attack-microsoft-steven-lim/\n\nEmailUrlInfo\n| where Timestamp \u003e ago(1h)\n| where UrlDomain endswith \".zip\"\n| where Url contains \"@\"\n| join EmailEvents on $left.NetworkMessageId == $right.NetworkMessageId\n| project Timestamp, NetworkMessageId, SenderFromAddress, RecipientEmailAddress, Subject, Url, UrlDomain, ThreatTypes, EmailAction, ReportId\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// Phishing (T1566):\n// The query is designed to detect phishing attempts by identifying suspicious URLs in emails.\n// Sub-technique: Spearphishing Link (T1566.002).\n\n// Command and Control (T1071):\n// The use of URLs that end with â€œ.zipâ€ and contain â€œ@â€ could be indicative of command and control communication attempts.\n// Sub-technique: Application Layer Protocol (T1071.001).\n\n// Exfiltration Over Web Service (T1567):\n// The presence of URLs in emails might indicate attempts to exfiltrate data via web services.\n// Sub-technique: Exfiltration Over Web Service (T1567.002)."
  },
  {
    "source": "SlimKQL",
    "name": "Detect \u0026 mitigate potential Specula Exploitation",
    "query": "// Detect \u0026 mitigate potential Specula Exploitation\n// https://www.linkedin.com/posts/activity-7223926720356044800-fxX2/\n\nCustom NRT DefenderXDR detection \u0026 isolation of endpoint to prevent exploitation of red team post-exploitation framework (Specula)\n\nDeviceRegistryEvents\n| where RegistryKey contains \"\\\\Software\\\\Microsoft\\\\Office\" and RegistryKey contains \"\\\\Outlook\\\\webview\"\n| where RegistryValueName contains \"URL\"\n| where RegistryValueData contains \"http://\" or RegistryValueData contains \"https://\"\n\n// MITRE ATT\u0026CK Mapping\n\n// This query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1112 - Modify Registry:\n// The query detects changes to the registry, which is a common technique used by adversaries to maintain persistence or execute malicious code1.\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// By looking for URLs in registry values, the query can help identify the use of web protocols for command and control or data exfiltration2.\n\n// T1137.001 - Office Application Startup: Outlook:\n// The focus on Outlookâ€™s webview settings suggests a potential technique where adversaries manipulate Office application settings to execute malicious code or scripts3."
  },
  {
    "source": "SlimKQL",
    "name": "Detect Active Exploitation of Critical Apache Tomcat RCE Vulnerability",
    "query": "// https://www.greynoise.io/blog/active-exploitation-critical-apache-tomcat-rce-vulnerability-cve-2025-24813\n\nlet GreyNoiseMaliciousIPs = dynamic([\"176.65.138.172\",\"38.126.114.186\",\n\"188.213.161.98\",\"140.143.182.115\",\"196.240.54.120\"]);\nlet InternetFacing =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nlet PublicFacingTomcatInstances =\nDeviceProcessEvents\n| where TimeGenerated \u003e ago(30d)\n| where InitiatingProcessFileName has \"tomcat\"\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where DeviceId has_any(InternetFacing)\n| project DeviceId;\nDeviceNetworkEvents\n| where Timestamp \u003e ago(7d)\n| where DeviceId has_any(PublicFacingTomcatInstances)\n| where RemoteIP has_any(GreyNoiseMaliciousIPs)"
  },
  {
    "source": "SlimKQL",
    "name": "Detect Black Basta Ransomware Campaign RMMTools Deployment",
    "query": "// Detect Black Basta Ransomware Campaign\n// Social Engineering Attack via Teams\n\n// https://www.rapid7.com/blog/post/2024/12/04/black-basta-ransomware-campaign-drops-zbot-darkgate-and-custom-malware/\n\n// Exclude Corporate Sharepoint\nlet CorporateSharepoint = \"xxx.sharepoint.com\";\nCloudAppEvents\n| where Application == @\"Microsoft Teams\"\n| where ActionType == @\"MessageSent\"\n| where AccountId contains \"@\"\n| where parse_json(RawEventData)[\"CommunicationType\"] == 'OneOnOne'\n| where isnotempty(parse_json(RawEventData)[\"MessageURLs\"])\n| where (parse_json(RawEventData)[\"MessageURLs\"]) contains \".sharepoint.com\"\n// External Teams Tenant sending a sharepoint link to download RMM tools to evade detections\n| where (parse_json(RawEventData)[\"MessageURLs\"]) !contains CorporateSharepoint"
  },
  {
    "source": "SlimKQL",
    "name": "Detect CVE-2024-31497",
    "query": "// Detect CVE-2024-31497\n//  https://www.linkedin.com/posts/activity-7185927077483708416-qNtB/\n\n// To check if you have a 521-bit ECDSA key in PuTTY, you can use the following command in the PuTTY terminal (Look for ecdsa-sha2-nistp521)\n// ssh-keygen -l -f ~/.ssh/id_ecdsa\n\n// KQL to check for impacted putty installation.\n\nDeviceTvmSoftwareInventory\n| where SoftwareName contains \"putty\"\n| where SoftwareVersion contains \"0.68\" or SoftwareVersion contains \"0.69\" or SoftwareVersion contains \"0.70\" or SoftwareVersion contains \"0.71\" or SoftwareVersion contains \"0.72\" or SoftwareVersion contains \"0.73\" or SoftwareVersion contains \"0.74\" or SoftwareVersion contains \"0.75\" or \nSoftwareVersion contains \"0.76\" or SoftwareVersion contains \"0.77\" or SoftwareVersion contains \"0.78\" or SoftwareVersion contains \"0.79\" or SoftwareVersion contains \"0.80\"\n\n// MITRE ATT\u0026CK Mapping\n// The detection of specific software versions, especially those known to have vulnerabilities, can be associated with several MITRE ATT\u0026CK techniques. Here are some relevant techniques:\n\n// T1082 - System Information Discovery: Adversaries may attempt to get a listing of software installed on a system to identify potential vulnerabilities1.\n\n// T1518.001 - Software Discovery: This technique involves adversaries querying the software installed on a system to find vulnerabilities they can exploit2.\n\n// T1070.004 - File Deletion: If an adversary identifies vulnerable software, they might attempt to delete logs or other files to cover their tracks3."
  },
  {
    "source": "SlimKQL",
    "name": "Detect CVE-2024-43572 Abuse",
    "query": "// Detect CVE-2024-43572 Abuse\n\n// In Microsoftâ€™s October security update, they highlighted that attackers are actively exploiting CVE-2024-43572, a remote code execution (RCE) flaw in the Microsoft Management Console (MMC). The patch released by Microsoft aims to prevent â€œuntrusted Microsoft Saved Console (MSC) files from being opened,â€ thereby protecting customers from the associated risks.\n\n// Security researchers at Elastic Security have observed threat actors using specially crafted MMC files, named GrimResource, for initial access and defense evasion. Although Microsoft did not address this specific point in their latest patch update, I took it upon myself to investigate the extent of this .msc vulnerability abuse using the SHA1 of GrimResource. To my astonishment, this .msc file has been detected in 260 organizations worldwide from June 26 to September 2. This significant number of affected organizations underscores the importance of Microsoftâ€™s patch to block untrusted .msc files.\n\n// While waiting for the October patch to be applied to all Windows servers and workstations, hereâ€™s an MDE KQL to detect unknown .msc files created on endpoints (excluding servers and admin endpoints where MMC is frequently run):\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet AdminDevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nlet ServerDevice =\nDeviceInfo \n| where OSPlatform contains \"server\"\n| distinct DeviceName;\nDeviceFileEvents\n| where ActionType == @\"FileCreated\"\n| where FileName endswith \".msc\"\n| where not (DeviceName has_any(AdminDevices))\n| where not (DeviceName has_any (ServerDevice))\n\n// MITRE ATT\u0026CK Technique\n// T1210 - Exploitation of Remote Services"
  },
  {
    "source": "SlimKQL",
    "name": "Detect Copilot Exfiltration arises from AiTM Token Theft",
    "query": "// Detect Copilot Exfiltration arises from AiTM Token Theft\n// https://www.linkedin.com/posts/activity-7217887769744793601-JUeb/\n\n// Identify token theft through AiTM phishing attacks, where stolen tokens are exploited for Copilot activities involving data summarization and extraction from a \"non-malicious\" IP. Leverage Sentinel Behavior Analytics to detect initial logins from new ISP with investigation score set (potentially threat actors) and correlate this IP data with Copilot activities from CloudAppEvents. This KQL is primarily targeted at threat actors using clean IP to perform Copilot exfiltration.\n\nlet FirstTimeUserConnectedISPIP =\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(7d)\n// Behaviour Analytics detecting user first time connected to a new ISP\n| where tostring(ActivityInsights.FirstTimeUserConnectedViaISP) == \"True\"\n| where ActivityType == \"LogOn\"\n| where SourceDevice == \"\"     // Non-corporate endpoint\n| where InvestigationPriority \u003e 0  // Suspicious Session\n| project SourceIPAddress;\nCloudAppEvents\n| where ActionType == \"CopilotInteraction\"\n// Correlating copilot activities from the new ISP IP\n| where IPAddress has_any(FirstTimeUserConnectedISPIP)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Initial Access:\n// Technique T1078 - Valid Accounts: The detection of a new ISP connection and logon activity could indicate the use of valid accounts from an unusual location.\n\n// Persistence:\n// Technique T1078 - Valid Accounts: Repeated logon activities from a new ISP might suggest persistence using valid credentials.\n\n// Defense Evasion:\n// Technique T1078 - Valid Accounts: Using a non-corporate endpoint and a new ISP can be a method to evade detection.\n\n// Credential Access:\n// Technique T1078 - Valid Accounts: Suspicious logon activities might indicate attempts to access credentials.\n\n// Command and Control:\n// Technique T1071 - Application Layer Protocol: Correlating Copilot interactions from the new ISP IP could indicate command and control activities using legitimate services."
  },
  {
    "source": "SlimKQL",
    "name": "Detect Copilot Plugin Installation",
    "query": "//Detect Copilot Plugin Installation\n//https://www.linkedin.com/feed/update/urn:li:activity:7176504602702356481/\n\nCloudAppEvents\n| where ActionType == \"AppInstalled\"\n| extend AppName = tostring(RawEventData.AddOnName)\n| summarize by AppName , AccountType, AccountDisplayName\n| sort by AppName asc\n\n// MITRE ATT\u0026CK Mapping\n\n//The query focuses on detecting application installations, which can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078: Valid Accounts - Adversaries may use valid accounts to install applications as part of their operations.\n// T1136: Create Account - Creating new accounts might be part of the process when installing certain applications.\n// T1087: Account Discovery - Adversaries may enumerate accounts to understand which ones have the necessary permissions to install applications.\n// T1203: Exploitation for Client Execution - Exploiting vulnerabilities to install applications."
  },
  {
    "source": "SlimKQL",
    "name": "Detect LNK Stomping",
    "query": "//Detecting LNK stompingðŸ¦¶\n// https://www.linkedin.com/posts/0x534c_windows-smart-app-control-smartscreen-bypass-activity-7226483357625282560-2kOU/\n\n//A bug in the handling of LNK files, can help threat actors bypass Smart App Control security controls designed to block untrusted applications. The below KQL should detect the behavioral signal of LNK stomping.\n\nDeviceFileEvents\n| where ActionType == \"FileModified\"\n| where FileName endswith \".lnk\"\n| where InitiatingProcessFileName has \"explorer.exe\"\n\n// #MDE #DefenderXDR #BypassSmartAppControl #MotW\n\n// MITRE ATT\u0026CK Mapping\n\n// This query is related to the MITRE ATT\u0026CK technique T1547.009 - Boot or Logon Autostart Execution: Shortcut Modification1. This technique involves adversaries creating or modifying shortcuts that can execute a program during system boot or user login. By monitoring for modifications to .lnk files initiated by explorer.exe, this query helps detect potential malicious activities where shortcuts are altered to execute unwanted programs."
  },
  {
    "source": "SlimKQL",
    "name": "Detect Malicious Impersonation of Deepseek Domains in Email URLs",
    "query": "// Detect Malicious Impersonation of Deepseek Domains in Email URLs\n\n// Utilize this straightforward KQL tool for inbound email URL analysis to identify domains potentially impersonating Deepseek for malicious purposes. This empowers SecOps to verify domain authenticity and block threats at the tenant level.\n\nEmailUrlInfo\n| join EmailEvents on NetworkMessageId\n| where UrlDomain has \"deepseek\" and (UrlDomain !endswith \"deepseek.com\" or SenderFromDomain != \"deepseek.com\")\n| where EmailDirection == \"Inbound\" and LatestDeliveryAction != \"Blocked\"\n| summarize Count=count() by UrlDomain\n| where Count \u003e= 3"
  },
  {
    "source": "SlimKQL",
    "name": "Detect Personal OneDrive Sync on corporate endpoints",
    "query": "// https://www.microsoft.com/en-us/microsoft-365/roadmap?id=490064\n\nDeviceRegistryEvents \n| where TimeGenerated \u003e ago(1h)\n| where ActionType == \"RegistryKeyCreated\" or ActionType == \"RegistryValueSet\"\n| where RegistryKey has \"HKEY_CURRENT_USER\\\\SOFTWARE\\\\Microsoft\\\\OneDrive\\\\Personal\""
  },
  {
    "source": "SlimKQL",
    "name": "Detect Power Pwn (aka LOLCopilot) Red Team Tool ",
    "query": "// Detect Power Pwn (aka LOLCopilot) Red Team Tool \n\n// DefenderXDR custom detection and isolation of machine if caught running LOLCopilot ðŸ˜‰\n\n// Running at NRT (near-realtime)\n\nDeviceNetworkEvents \n| where InitiatingProcessVersionInfoProductName == \"Node.js\"\n| where RemoteUrl startswith \"https://www.office.com\" or \nRemoteUrl startswith \"https://teams.microsoft.com\"\n\n// Sentinel detection on Entra Signin for possible LOLCopilot usage on non MDE endpoints\n\nSigninLogs\n| where TimeGenerated \u003e ago(1h)\n| where UserAgent contains \"headless\"\n\n// Note: The above will no longer work if threat actor changes the Power Pwn Puppeteer script's setUserAgent value \n\n// Reference: https://www.wired.com/story/microsoft-copilot-phishing-data-extraction/\n\n// MITRE ATT\u0026CK Mapping\n\n// T1071.001 - Application Layer Protocol: Web Protocols: This technique involves using web protocols for command and control communication1.\n// T1105 - Ingress Tool Transfer: This technique involves transferring tools or files from an external system into a compromised environment2.\n\n// T1078 - Valid Accounts: This technique involves the use of valid accounts to gain access to systems3.\n// T1202 - Indirect Command Execution: This technique involves executing commands through a legitimate interface, such as a headless browser4."
  },
  {
    "source": "SlimKQL",
    "name": "Detect Spear Phishing using Copilot for Microsoft 365",
    "query": "// Detect Spear Phishing using Copilot for Microsoft 365\n// Linkedin Post: https://www.linkedin.com/posts/0x534c_phishing-is-dead-long-live-spear-phishing-activity-7228358230286950400-j0C_/\n\n//At #BHUSA, Zenity Labs CTO Michael Bargury showcased how a compromised Copilot user account can be leveraged for spear phishing attacks using the userâ€™s profiling data. For detailed steps on conducting these attacks, refer to the article â€œPhishing is Dead, Long Live Spear Phishing.â€\n\n//The following DefenderXDR custom detection KQL utilizes Microsoft Defender Cloud Apps (MDCA) User Entity and Behavior Analytics (UEBA) capabilities to detect unusual Copilot bizchat (user prompting) sessions and correlate them with Microsoft Defender for Office 365 (MDO) email sending activities. This approach aims to identify the abused Copilot spear phishing scenario mentioned in the article and immediately quarantine the email messages. After validation by SecOps, if deemed safe, SecOps can release the emails from quarantine.\n\n// ** VERSION 1 **\n\nlet UncommonCopilotPromptUpn =\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where Application == @\"Microsoft Copilot for Microsoft 365\"\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotAppHost = tostring(CopilotData.AppHost)\n| where CopilotAppHost == \"bizchat\"\n| where UncommonForUser has \"ISP\" or UncommonForUser has \"CountryCode\"\n| distinct UserID;\nEmailEvents\n| where SenderFromAddress has_any (UncommonCopilotPromptUpn)\n| where EmailDirection == \"Outbound\"\n| where AttachmentCount \u003e 0 or UrlCount \u003e 0\n\n// ** Version 2 - Improve detection on PowerPwn **\n\nlet UncommonCopilotPromptUpn =\nCloudAppEvents\n| where Application == @\"Microsoft Copilot for Microsoft 365\"\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotAppHost = tostring(CopilotData.AppHost)\n| where CopilotAppHost == \"bizchat\"\n| where UncommonForUser has \"ISP\" or UncommonForUser has \"CountryCode\"\n| distinct UserID;\nlet PowerPwnUpn =\nAADSignInEventsBeta\n| where AccountUpn has_any (UncommonCopilotPromptUpn)\n| where ResourceDisplayName == \"Office 365 Exchange Online\"\n| where UserAgent contains \"python\"\n| distinct AccountUpn;\nEmailEvents\n| where SenderFromAddress has_any (PowerPwnUpn)\n| where EmailDirection == \"Outbound\"\n| where AttachmentCount \u003e 0 or UrlCount \u003e 0\n\n// Reference Link:\n// https://labs.zenity.io/p/phishing-dead-long-live-spear-phishing\n\n// MITRE ATT\u0026CK Mapping\n\n// Initial Access:\n// Technique T1078: Valid Accounts: The query looks for unusual user accounts interacting with Microsoft Copilot, which could indicate compromised accounts being used for initial access1.\n\n// Execution:\n// Technique T1059: Command and Scripting Interpreter: The use of python in the UserAgent field suggests script-based execution2.\n\n// Persistence:\n// Technique T1078: Valid Accounts: Continued use of valid accounts for maintaining access1.\n\n// Defense Evasion:\n// Technique T1078: Valid Accounts: Using legitimate credentials to avoid detection1.\n\n// Credential Access:\n// Technique T1078: Valid Accounts: Accessing accounts to gather credentials1.\n\n// Discovery:\n// Technique T1083: File and Directory Discovery: The query checks for outbound emails with attachments or URLs, which could be part of data discovery and exfiltration3.\n\n// Exfiltration:\n// Technique T1041: Exfiltration Over C2 Channel: Outbound emails with attachments or URLs could indicate data exfiltration3."
  },
  {
    "source": "SlimKQL",
    "name": "Detect anomalous external OAuthApp activity using ActorInfoString",
    "query": "// Detect anomalous external OAuthApp activity using ActorInfoString\n// https://techcommunity.microsoft.com/blog/microsoft-security-blog/introducing-actorinfostring-a-new-era-of-audit-log-accuracy-in-exchange-online/4408093\n\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where Application == @\"Microsoft Exchange Online\"\n| where isnotempty(parse_json(RawEventData)[\"ActorInfoString\"])\n| extend ActorInfoString = tostring(parse_json(RawEventData)[\"ActorInfoString\"])\n| where UncommonForUser has \"CountryCode\" and UncommonForUser has \"UserAgent\"\n| where isnotempty(OAuthAppId)\n| join OAuthAppInfo on OAuthAppId\n| where AppOrigin == @\"External\""
  },
  {
    "source": "SlimKQL",
    "name": "Detect human-operated ransomware attacks that use RDP",
    "query": "// Detect human-operated ransomware attacks that use RDP\n\n// Microsoft Defender for Endpoint is now enhancing RDP data by adding a detailed layer of session information. This enhancement allows you to more easily identify potentially compromised devices within your organization. The new layer provides additional details about RDP sessions in the context of initiated activities, simplifying correlation and increasing the accuracy of threat detection and proactive hunting.\n// This update introduces 8 extra fields, represented as new columns in Advanced Hunting, and expands the schema across various tables: DeviceEvents, DeviceFileEvents, DeviceImageLoadEvents, DeviceLogonEvents, DeviceNetworkEvents, DeviceProcessEvents, and DeviceRegistryEvents.\n// The following KQL query detects the IsInitiatingProcessRemoteSession == true field across 7 schema tables for all your MDE devices over the last hour. It then correlates this data against the ProcessRemoteSessionIP (the IP address of the remote device from which the created processâ€™s RDP session was initiated). In a typical ransomware attack, a threat actor might use compromised admin credentials to launch RDP attacks against workstations reachable by the compromised endpoint. This KQL query helps identify any remote IPs that exceed the threshold for conducting RDP attacks.\n\n// Define your Privileged Access Workstations (PAWs) IPs below\nlet PAW = dynamic (['127.0.0.1', '10.0.0.1', '10.0.0.2']);\nlet flag = \"true\"; // Initiating process was run under a remote desktop protocol (RDP) session = True\nlet TriggerThreshold = 5; // Define your threshold where a remote IP can initate RDP to perform the in below schema table \nsearch in (DeviceEvents, DeviceFileEvents, DeviceImageLoadEvents, \nDeviceLogonEvents, DeviceNetworkEvents, DeviceProcessEvents, DeviceRegistryEvents)\nTimestamp between (ago(1h) .. now())\nand (\nIsInitiatingProcessRemoteSession == flag\n)\n| where not (ProcessRemoteSessionIP has_any (PAW))\n| where ProcessRemoteSessionIP != \"\"\n| summarize RemoteActivityIP=count() by ProcessRemoteSessionIP\n| where RemoteActivityIP \u003e TriggerThreshold\n\n// #MicrosoftDefender #DefenderforCloud #Security #MicrosoftSecurity #Cybersecurity #DefenderXDR #MicrosoftThreatIntelligence\n\n// MITRE ATT\u0026CK Mapping\n// The KQL query primarily focuses on detecting suspicious remote desktop protocol (RDP) activities. Here are the relevant MITRE ATT\u0026CK techniques:\n\n// T1076 - Remote Desktop Protocol:\n// The query detects RDP sessions, which is directly related to this technique. It identifies when RDP is used to access systems, especially from non-PAW IPs.\n// T1021 - Remote Services:\n// This technique involves using remote services like RDP to move laterally within a network. The query helps identify unusual remote access patterns.\n// T1078 - Valid Accounts:\n// The use of valid accounts for remote access is a common tactic. The query can help detect when valid accounts are used from unexpected IP addresses.\n// T1087 - Account Discovery:\n// By monitoring RDP sessions, the query can indirectly assist in identifying account discovery activities, where adversaries attempt to find valid accounts for lateral movement.\n// T1566 - Phishing:\n// Although not directly related, detecting unusual RDP activity can sometimes be a follow-up to successful phishing attacks where credentials are compromised."
  },
  {
    "source": "SlimKQL",
    "name": "Detect privilege escalation to The Most Dangerous Entra Admin Role via compromised service principal",
    "query": "// Detect privilege escalation to The Most Dangerous Entra Admin Role via compromised service principal\n// https://www.linkedin.com/posts/activity-7223370832763351040-TieO/\n\n// Hourly Sentinel Analytics Rule:\n\nlet PTS = dynamic(['PTS1@acme.com', 'PTS2@acme.com', 'PTS3@acme.com']);\nAuditLogs \n| where TimeGenerated \u003e ago(1h)\n| where Category == \"RoleManagement\"\n| where ActivityDisplayName == \"Add member to role\"\n| where TargetResources contains \"Partner Tier2 Support\"\n| extend UPN = tostring(TargetResources[0].userPrincipalName)\n| where not (UPN has_any(PTS))\n\n// Custom DefenderXDR KQL (Exposure Management) detecting this dangerous role activation: \n\nlet DangerousAdmin =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| extend AccountUPN = NodeProperties.rawData.accountUpn\n| extend AdminRoles = NodeProperties.rawData.assignedRoles\n| where AdminRoles contains \"Partner Tier2 Support\"\n| project AccountUPN;\nIdentityLogonEvents\n| where AccountUpn has_any(DangerousAdmin)\n\n// MITRE ATT\u0026CK Mapping\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to gain access to and maintain persistence on systems.\n// Relevance: The query detects the addition of members to a high-privilege role, which could indicate the use of valid accounts for privilege escalation.\n// T1098 - Account Manipulation:\n// Description: Adversaries may manipulate accounts to maintain access to credentials and permissions.\n// Relevance: The detection of adding members to a role aligns with account manipulation activities.\n// T1071 - Application Layer Protocol:\n// Description: Adversaries may use application layer protocols to communicate with remote systems.\n// Relevance: The logon events detection part of the query can help identify suspicious logon activities using valid accounts.\n// T1110 - Brute Force:\n// Description: Adversaries may use brute force techniques to attempt to gain access to accounts.\n// Relevance: Although not directly related to brute force, monitoring logon events for high-privilege accounts can help detect potential brute force attempts."
  },
  {
    "source": "SlimKQL",
    "name": "Detect threat actor abuse CloudFlare tunnels to deliver RATS",
    "query": "// Detect threat actor abuse CloudFlare tunnels to deliver RATS\n// https://www.linkedin.com/posts/activity-7225744862875152384-whO8/\n\nUrlClickEvents\n| where Timestamp \u003e ago(30d)\n| extend domain = tostring(parse_url(Url).Host)\n| where domain endswith \".trycloudflare.com\"\n| join EmailEvents on NetworkMessageId\n| project Timestamp, Url, RecipientEmailAddress, SenderMailFromAddress, SenderFromAddress, Subject, AttachmentCount, UrlCount\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The query is analyzing URL click events, which involves web protocols.\n// T1566.002 - Phishing: Spearphishing Link:\n// The query filters for specific domains and joins with email events, indicating an investigation into potential phishing attempts via malicious links.\n// T1071.003 - Application Layer Protocol: Email Protocols:\n// The join with EmailEvents suggests the use of email protocols to identify malicious activities.\n// T1204.001 - User Execution: Malicious Link:\n// The focus on URL clicks and specific domains indicates detection of user execution of potentially malicious links."
  },
  {
    "source": "SlimKQL",
    "name": "Detect vulnerable device with Global Admin browser cookie credential",
    "query": "// Detect vulnerable device with Global Admin browser cookie credential\n// https://www.linkedin.com/posts/0x534c_exposuremanagement-attackpaths-critical-activity-7227325225493803009-o5te/\n//Thanks to Marko Laurenâ€™s recent insights on how #ExposureManagement customers can identify #attackpaths that originate in non-cloud environments and target #critical cloud assets using Entra cloud credentials.\n\n//Leveraging DefenderXDR Exposure Management, I developed a KQL query that replicates this attack path functionality. The following KQL checks all Critical Identities (in my use case, line 6 limits to GA accounts only; removing this line will include all critical identities) and identifies which devices have their Entra browser cookie credentials stored, then checks if these devices have any critical vulnerabilities.\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) \nand NodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4\n| where NodeProperties has \"Global Administrator\" // Remove this line to include all Critical Identities\n| distinct NodeName;\nlet VulnerableEndPointwithBCookie =\nExposureGraphEdges\n| where EdgeLabel == @\"has credentials of\"\n| where EdgeProperties has \"BrowserCookies\"\n| where TargetNodeName has_any (CriticalIdentities)\n// SourceNodeName = Devices that contains GA browser cookie \n| distinct SourceNodeName;\nDeviceTvmSoftwareVulnerabilities\n| where VulnerabilitySeverityLevel == \"Critical\"\n| where DeviceName has_any (VulnerableEndPointwithBCookie)\n\n// Bridging the On-premises to Cloud Security Gap: Cloud Credentials Detection\n// Link: https://techcommunity.microsoft.com/t5/security-compliance-and-identity/bridging-the-on-premises-to-cloud-security-gap-cloud-credentials/ba-p/4211794\n\n// MITRE ATT\u0026CK Mapping\n\n//The KQL code is designed to identify critical identities, endpoints with browser cookies of these identities, and devices with critical vulnerabilities. The associated MITRE ATT\u0026CK techniques include:\n\n// T1078: Valid Accounts\n// T1078.004: Valid Accounts: Cloud Accounts\n// T1539: Steal Web Session Cookie\n// T1190: Exploit Public-Facing Application"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Abuse of Wevtutil.exe in LOLBAS Attacks",
    "query": "// Detecting Abuse of Wevtutil.exe in LOLBAS Attacks\n\n// https://denwp.com/unexplored-lolbas-technique-wevtutil-exe/\n// The article discusses how attackers exploit the Windows event log utility, wevtutil.exe, in Living Off the Land Binaries and Scripts (LOLBAS) attacks. This tool, typically used for managing event logs, can be misused to export, query, or clear logs, aiding in data exfiltration and evasion of detection. By leveraging wevtutil.exe, attackers can hide their tracks and extract sensitive information, making it a potent tool for post-exploitation activities. Enhanced monitoring and audit policies are recommended to mitigate these risks. I will be sharing a KQL to detect this type of abuse.\n\nDeviceProcessEvents \n| where TimeGenerated \u003e ago(1h)\n| where FileName == \"wevtutil.exe\"\n| where ProcessTokenElevation == \"TokenElevationTypeFull\" or \nInitiatingProcessCommandLine in (\"cl\", \"qe\")\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting BYOVDLL Abuse",
    "query": "// Detecting BYOVDLL Abuse\n// https://blog.scrt.ch/2024/08/09/ghost-in-the-ppl-part-1-byovdll/\n// Today, I discovered an intriguing blog post from Orange CyberDefense titled â€œGhost in the PPL Part 1: BYOVDLL.â€ The article presents a proof-of-concept and explores innovative techniques for loading arbitrary DLLs into LSASS and even dumping its memory. Previously, I developed several KQL queries to detect BYOVD abuse. By incorporating similar behavioral detection methods and tweaking digital signatures detection, the following KQL query could potentially detect BYOVDLL abuse if the attack methods align with those described in the proof-of-concept.\n\nlet NewLPUnsignedDLL =\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".dll\"\n| invoke FileProfile(SHA1,10000)\n| where GlobalPrevalence \u003c= 150\n| join kind=leftouter DeviceFileCertificateInfo on SHA1\n| where SignatureState == \"Unsigned\"\n| distinct FileName;\nDeviceEvents\n| where ActionType == @\"DriverLoad\"\n| where FileName endswith \".dll\"\n| join kind=leftouter DeviceFileCertificateInfo on SHA1\n| where IsSigned == \"1\"\n| where FileName has_any(NewLPUnsignedDLL)\n\n// MITRE ATT\u0026CK Mapping\n// T1036.005 - Masquerading: Match Legitimate Name or Location:\n// The query looks for DLL files that are unsigned and have low global prevalence, which could indicate masquerading as legitimate files.\n// T1070.004 - Indicator Removal on Host: File Deletion:\n// The detection of newly created DLL files and their profiling can help identify attempts to remove or replace legitimate files with malicious ones.\n// T1218.011 - Signed Binary Proxy Execution: Rundll32:\n// The query checks for driver load events involving DLLs, which could be used in proxy execution techniques.\n// T1547.001 - Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder:\n// Unsigned DLLs being loaded as drivers could indicate persistence mechanisms via autostart execution.\n// T1027 - Obfuscated Files or Information:\n// The use of unsigned DLLs with low prevalence might indicate attempts to obfuscate malicious activity."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting BrazenBamboo's FortiClient Exploit - A KQL Approach",
    "query": "// Detecting BrazenBamboo's FortiClient Exploit: A KQL Approach\n\n// Volexity has identified and reported a vulnerability in Fortinet's Windows VPN client, FortiClient, where user credentials remain in process memory post-authentication. This flaw has been exploited by the threat actor BrazenBamboo through their DEEPDATA malware. BrazenBamboo is also known for the LIGHTSPY malware family. Volexity reported this vulnerability to Fortinet on July 18, 2024, and it was acknowledged on July 24, 2024. However, as of November 15, 2024, the issue remains unresolved, and no CVE number has been assigned.\n// The SHA1 file hash of the FortiClient VPN client indicates that nearly 22.8K organizations using Microsoft Defender for Endpoint (MDE) are at risk, highlighting a significant attack surface. To assist defenders, I have included the Volexity blog with comprehensive Indicators of Compromise (IOCs) in the comment section, enabling them to update their monitoring tools for potential BrazenBamboo threat activity. Additionally, I have developed a KQL detection for the DEEPDATA loader.\n\n// https://www.volexity.com/blog/2024/11/15/brazenbamboo-weaponizes-forticlient-vulnerability-to-steal-vpn-credentials-via-deepdata/\n\nlet EndpointWithFortiClient =\nDeviceTvmSoftwareInventory\n| where SoftwareName has \"forticlient\"\n| distinct DeviceId;\nlet NewCreatedLowPrevalenceDLL =\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".dll\"\n| invoke FileProfile(SHA1,10000)\n| where GlobalPrevalence \u003c= 50\n| join kind=leftouter DeviceFileCertificateInfo on SHA1\n| where SignatureState == \"Unsigned\"\n| distinct FileName;\nDeviceEvents\n| where ActionType == @\"DriverLoad\"\n| where FileName endswith \".dll\"\n| where FileName has_any(NewCreatedLowPrevalenceDLL)\n| where DeviceId has_any(EndpointWithFortiClient)"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Copilot Studio Bot Creation",
    "query": "// Detecting Copilot Studio Bot Creation\n// https://www.linkedin.com/posts/0x534c_copilotstudiobots-securityconfiguration-dlp-activity-7230083382682992641-dLMZ/\n// The below KQL will detect the list of Copilot Studio bots created in your tenant and your can correlate the NodeName (id) against the AuditLogs TargetResources for more information.\n\nExposureGraphNodes\n| where NodeLabel == @\"serviceprincipal\"\n| where NodeProperties.rawData.accountDisplayName contains \"Microsoft Copilot Studio\"\n| where NodeProperties.rawData.accountEnabled == \"true\"\n| where NodeProperties.rawData.tags startswith \"power-virtual-agents-\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, here are the potential MITRE ATT\u0026CK techniques that could be relevant:\n\n// T1078 - Valid Accounts: The query is identifying service principals (a type of account) that are enabled and have specific tags. This technique involves adversaries using valid accounts to maintain access to a network.\n// T1087 - Account Discovery: The query is discovering accounts with specific properties, which aligns with the technique where adversaries attempt to enumerate user or service accounts.\n// T1098 - Account Manipulation: If the query is used to monitor or detect changes in service principal accounts, it could relate to this technique, which involves adversaries manipulating accounts to maintain access."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting EDR-killing Tool",
    "query": "// Detecting EDR-killing Tool\n\n// Recent reports indicate that a cybercrime group associated with the RansomHub ransomware has been utilizing a new tool designed to disable endpoint detection and response (EDR) software on compromised systems. This tool, known as EDRKillShifter, functions as a loader executable and serves as a delivery mechanism for a legitimate driver that is vulnerable to exploitation. This technique is commonly referred to as a â€˜bring your own vulnerable driverâ€™ (BYOVD) attack.\n// The following KQL script is an enhancement of my previous threat hunting efforts to detect BYOVD scenarios. It is important to note that threat actors may modify your driver system files for malicious purposes. This modification can trigger low prevalence detections. If further analysis confirms that the driver is being loaded and tampered with, it is highly likely that an EDR-Killing tool is present in your environment.\n\n// RansomHub Group Deploys New EDR-Killing Tool in Latest Cyber Attacks\n// https://thehackernews.com/2024/08/ransomhub-group-deploys-new-edr-killing.html\n\n// Ransomware attackers introduce new EDR killer to their arsenal\n// https://news.sophos.com/en-us/2024/08/14/edr-kill-shifter/\n\n// Itâ€™ll be back: Attackers still abusing Terminator tool and variants\n// https://news.sophos.com/en-us/2024/03/04/itll-be-back-attackers-still-abusing-terminator-tool-and-variants/\n\nlet DriverwithLowPrevalence =\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".sys\"\n| invoke FileProfile(SHA1,10000)\n| where GlobalPrevalence \u003c= 150\n| invoke FileProfile(SHA1,1000)\n| where GlobalPrevalence \u003c= 150 or isempty(GlobalPrevalence)\n| join kind=leftouter DeviceFileCertificateInfo on SHA1\n| project FileName;\nlet DevicewithLPDriverActivated =\nDeviceEvents\n// Event ID 3004 â€” Kernel-mode Driver Validation\n//| where ReportId == \"3004\"\n| where ActionType == @\"DriverLoad\"\n| where FileName has_any(DriverwithLowPrevalence)\n| distinct DeviceName;\nDeviceEvents\n//| where ReportId == \"5013\"\n| where ActionType == @\"TamperingAttempt\"\n| where DeviceName has_any(DevicewithLPDriverActivated)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// File Creation and Prevalence Check:\n// Tactic: Defense Evasion\n// Technique: T1036.005 - Masquerading: Match Legitimate Name or Location\n// Description: The query identifies newly created .sys files (drivers) and checks their global prevalence to detect potentially rare or suspicious drivers.\n\n// Driver Load Event:\n// Tactic: Execution\n// Technique: T1547.001 - Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder\n// Description: The query monitors for driver load events (Event ID 3004) to detect the activation of low-prevalence drivers, which could indicate malicious activity.\n\n// Tampering Attempt Detection:\n// Tactic: Defense Evasion\n// Technique: T1562.001 - Impair Defenses: Disable or Modify Tools\n// Description: The query looks for tampering attempts (Event ID 5013) on devices where low-prevalence drivers have been activated, indicating potential attempts to disable security tools or modify system"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting External Microsoft Teams Spray",
    "query": "// Detecting External Microsoft Teams Spray\n\n// In late October, the ransomware group Black Basta introduced a new social engineering technique. Initially, they bombarded users with email spam, leading them to create help-desk tickets. The attackers then impersonated help-desk staff to gain access. Recently, they have shifted to using Microsoft Teams chat messages and malicious QR codes to communicate with targets. These tactics are designed to convince users to download remote monitoring tools, ultimately resulting in ransomware deployment. This campaign is particularly notable for its intensity and high volume of activity, posing a significant threat to organizations that do not restrict Teams communications with external entities.\n\n// The KQL code below helps defenders detect anomalous external inbound Teams chats to your Entra tenant, allowing them to take immediate action to block the external tenant if necessary. The KQL code can be downloaded from my SlimKQL GitHub Repository, which is featured on my LinkedIn profile. (Search for â€œDetecting External Microsoft Teams Sprayâ€)\n\n// External Tenant Teams Spray Threshold\nlet SprayCounter = 3;\n\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where Application == \"Microsoft Teams\"\n| where ActionType == \"ChatCreated\"\n| where tostring(RawEventData.CommunicationType)==\"OneOnOne\" // Inbound 1:1 Chat\n| where AccountId has \"@\"                                    // External Tenant Teams User\n| extend ExtUserDomain = tostring(split(AccountId, '@')[1])\n| where UncommonForUser != \"[]\"                              // Behaviour Analytics to improve detection accuracy\n| summarize InboundChat=count() by ExtUserDomain\n| where InboundChat \u003e SprayCounter or ExtUserDomain contains \".onmicrosoft.com\""
  },
  {
    "source": "SlimKQL",
    "name": "Detecting GOLDEN SAML Attack",
    "query": "// Detecting GOLDEN SAML Attack\n// https://www.linkedin.com/posts/activity-7197102964581310464-5lwT/\n\n// The AADInternals toolkit can be used to perform a Golden SAML attack. This type of attack involves an adversary gaining privileged access to a network, stealing the AD FS certificate, and then using it to impersonate any user within an organization to gain access to resources across various services that use SAML (Security Assertion Markup Language) for authentication\n// Custom Defender KQL detection for possible AADInternals toolkit usage:\n\nDeviceNetworkEvents \n| where ActionType == @\"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost contains \"any.sts\" or HttpHost contains \"korvatunturi.fi\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, this query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// This technique involves adversaries using web protocols to communicate with compromised systems to avoid detection/network filtering by blending in with normal traffic1.\n// T1071 - Application Layer Protocol:\n// This broader category includes the use of application layer protocols for command and control1.\n// T1040 - Network Sniffing:\n// The inspection of HTTP connections can be related to network sniffing, where adversaries capture network traffic to obtain information1.\n// T1070.004 - Indicator Removal on Host: File Deletion:\n// Although not directly related to the query, inspecting HTTP connections might be part of a broader strategy to detect and prevent adversaries from removing indicators on the host1."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting M365 Copilot Shared Agent",
    "query": "// Detecting M365 Copilot Shared Agent\n\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where Application == @\"Microsoft 365\"\n| where ActionType in (\"BotCreate\", \"BotUpdateOperation-BotPublish\")"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Misconfigured EXO Transport Rules",
    "query": "// Detecting Misconfigured EXO Transport Rules\n\nEmailEvents\n| where EmailDirection == \"Inbound\"\n| where isnotempty(ThreatClassification)\n| where LatestDeliveryAction == \"Delivered\"\n| where DeliveryLocation != \"Junk folder\"\n| summarize Count=count() by tostring(parse_json(AdditionalFields)[\"TransportRuleGuid\"])"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting New Copilot Extensions",
    "query": "// Detecting New Copilot Extensions\n// https://www.linkedin.com/posts/0x534c_cybersecurity-generativeai-m365-activity-7250789113249837056-D6rZ/\n\n// I refuse to accept Message Center MC908119, which states that â€œAdmins will lose tenant-level control over who can use Copilot agentsâ€ ðŸ˜¤. To counter this, Iâ€™ve developed a custom KQL detection in DefenderXDR. This detection identifies any newly installed, non-whitelisted Copilot extensions and alerts the M365 Admin for review. The M365 Admin can then block these extensions in the Integrated Apps section of the admin portal, reclaiming some control.ðŸ’ª\n\n// Added your whitelisted extensions or plugins to WLExtensions\nlet WLExtensions = dynamic([\"BingWebSearch\"]);\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotPlugin = tostring(CopilotData.AISystemPlugin[0].Id)\n| where isnotempty(CopilotPlugin)\n| where not (CopilotPlugin has_any (WLExtensions))\n| project Timestamp, AccountObjectId, UserID, CopilotPlugin, ReportId\n\n// MITRE ATT\u0026CK\n// T1116 Browser Extensions"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Port Scanning on Internet-Facing Devices",
    "query": "// Detecting Port Scanning on Internet-Facing Devices\n\n// Are you aware of when your endpoints or servers are exposed to the internet? Whether intentional or accidental, itâ€™s crucial to have the capability to detect port scans or attacks and take necessary defensive actions. Iâ€™ve developed a custom DefenderXDR detection KQL that provides this visibility for your fleet of MDE devices.\n// When this custom detection is triggered, you should verify if the device firewall is enabled, check for any critical or high vulnerabilities that could be exploited, and identify the hostile country performing the scan (e.g., Russia - something might be off!). This is an enhanced version of the KQL function InboundExternalNetworkEvents(X), where X is the DeviceID.\n\nlet InternetFacingDevice=\nDeviceInfo\n| where Timestamp \u003e ago(1h)\n| where IsInternetFacing\n| summarize arg_max(Timestamp, *) by DeviceId\n| project DeviceId;\nDeviceNetworkEvents\n| where DeviceId has_any(InternetFacingDevice)\n| where ActionType == @\"InboundConnectionAttempt\"\n| where not(ipv4_is_private(RemoteIP))\n| extend IPLocation = geo_info_from_ip_address(RemoteIP)\n| summarize Connections=count() by RemoteIP, tostring(IPLocation.country)\n| sort by Connections desc\n| where Connections \u003e= 3\n\n// MITRE ATT\u0026CK\n// T1049: System Network Connections Discovery"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Social Engineering Attacks in Teams with KQL",
    "query": "// https://redcanary.com/blog/threat-intelligence/storm-1811-black-basta/\n// https://techcommunity.microsoft.com/blog/microsoftsecurityexperts/phish-click-breach-hunting-for-a-sophisticated-cyber-attack/4267916\n\n// E.g Approved Corporate RMM - Whitelisting\nlet SanctionRMM = dynamic(\"bomgarcloud.com\");\n// Lookup list of RMM Tools Url from Microsoft\nlet RMMList=externaldata(URI: string, RMMTool: string)\n[h'https://raw.githubusercontent.com/jischell-msft/RemoteManagementMonitoringTools/refs/heads/main/Network%20Indicators/RMM_SummaryNetworkURI.csv'];\nlet RMMUrl =\nRMMList\n| project URI;\nMessageUrlInfo\n| where Timestamp \u003e ago(1h)\n// Scan all external inbound Teams message for RMM Tools URL\n// For example: Storm-1811 exploits RMM tools to drop Black Basta ransomware \n| where Url has_any(RMMUrl)\n| where not (Url has_any(SanctionRMM))\n| join MessageEvents on TeamsMessageId\n| where IsExternalThread == \"1\"\n| where ThreadType == \"chat\"\n| where DeliveryLocation == \"Teams\""
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Teams Red Team Tool ConvoC2",
    "query": "// Detecting Teams Red Team Tool ConvoC2\n\n// https://cybersecuritynews.com/red-team-tool-to-executes-commands-via-ms-teams/amp/\n\n// DefendXDR Detection\n\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where Application == @\"Microsoft Teams\"\n| where ActionType == @\"AppInstalled\"\n| where parse_json(RawEventData)[\"AddOnName\"] == 'Workflows'"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Twill Typhoon VSCode Exploit",
    "query": "// Detecting Twill Typhoon VSCode Exploit\n\n// The Mustang Panda group, a Chinese hacking collective, has leveraged Visual Studio Codeâ€™s reverse shell feature to infiltrate Southeast Asian government systems. This method enables unauthorized access, malware deployment, and data exfiltration, marking a notable advancement in cyber espionage techniques. The following KQL detects the VS Code tunnel exploit within an MDE environment.\n\nlet deviceVScodeTunnel = \nDeviceEvents\n| where InitiatingProcessCommandLine contains \"code.exe\"\nand InitiatingProcessCommandLine contains \"tunnel\"\n| distinct DeviceName;\nDeviceNetworkEvents\n| where RemoteUrl contains \"tunnels.api.visualstudio.com\"\nor RemoteUrl contains \"devtunnels.ms\"\n| where DeviceName has_any (deviceVScodeTunnel)\n\n// Based on the behavior described in your query, the associated MITRE ATT\u0026CK techniques are:\n\n// Protocol Tunneling (T1572): This technique involves encapsulating one protocol within another to avoid detection and enable access to otherwise unreachable systems1. Your query is looking for network events that suggest tunneling, which aligns with this technique.\n// Command and Control (TA0011): This tactic involves adversaries trying to communicate with compromised systems to control them. The use of tunneling and specific URLs in your query suggests an attempt to establish a command and control channel."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting WafflesExploits Shellcode in Image Files",
    "query": "// Detecting WafflesExploits Shellcode in Image Files\n// https://wafflesexploits.github.io/posts/Hide_a_Payload_in_Plain_Sight_Embedding_Shellcode_in_a_Image_file/\n\nlet ImageExtension = dynamic([\".apng\", \".png\", \".avif\", \".gif\", \".jpg\", \".jpeg\", \".jfif\", \".pjpeg\", \".pjp\", \".png\", \".svg\", \".webp\", \".bmp\", \".tif\", \".tiff\"]);\nlet CPPId = dynamic([\"Microsoft Visual C++\"]);\nlet WhiteListedFileName = dynamic([\"logo.png\",\"vcredist.bmp\",\"watermark.bmp\",\"header.bmp\",\"SplashScreen.bmp\"]);\nDeviceFileEvents\n| where InitiatingProcessVersionInfoFileDescription has_any(CPPId)\n| where ActionType == @\"FileCreated\"\n| where FileName has_any(ImageExtension)\n| where not(FileName has_any(WhiteListedFileName))"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Windows Downdate Abuse",
    "query": "// Detecting Windows Downdate Abuse\n// https://www.blackhat.com/us-24/briefings/schedule/#windows-downdate-downgrade-attacks-using-windows-updates-38963\n// https://www.bleepingcomputer.com/news/microsoft/windows-downdate-tool-lets-you-unpatch-windows-systems/\n\n// Detect the cloning of Windows Downdate python with Python PSUtil \u0026 Git presence\nlet EndpointwithPythonPSUtilGit =\nDeviceTvmSoftwareInventory \n| where (SoftwareName contains \"psutil\" and SoftwareName contains \"python\")\nor (SoftwareName contains \"git\" and SoftwareVendor == \"github\")\n| distinct DeviceName;\nDeviceFileEvents \n| where ActionType==\"FileCreated\"\n| where FolderPath contains \"downdate\"\n| where DeviceName has_any(EndpointwithPythonPSUtilGit)\n\n// Detected Windows Downdate Binary\nDeviceFileEvents \n| where ActionType==\"FileCreated\"\n| where SHA256 == \"a34e71ededf334d3d6a480e3738c91fccbb4d2c1fbeec7192db9793a2541e8ca\"\n\n// The Windows Downdate tool primarily maps to the following MITRE ATT\u0026CK techniques:\n// T1078 - Valid Accounts: By downgrading components, attackers can exploit older vulnerabilities to gain unauthorized access using valid accounts1.\n// T1543 - Create or Modify System Process: Downgrading critical OS components can involve creating or modifying system processes to reintroduce vulnerabilities1.\n// T1562 - Impair Defenses: Downgrading security components like Credential Guard can impair defenses, making it easier for attackers to bypass security measures1.\n// T1218 - Signed Binary Proxy Execution: Using legitimate tools and binaries to execute malicious actions, which can be facilitated by downgrading to vulnerable versions1."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Windows Side-Loading DLL attacks",
    "query": "// Detecting Windows Side-Loading DLL attacks\n// https://x.com/0gtweet/status/1827991604918890968\n// Grzegorz Tworek recently highlighted on X that the Windows command line tool licensingdiag.exe poses a potential security risk. This tool, categorized as a â€œliving off the landâ€ utility, can be exploited for side-loading DLL attacks. If a threat actor gains local administrative rights, they can modify the registry under HKLM to side-load DLLs using licensingdiag.exe. To address this, I have developed a KQL detection rule to identify such side-loading DLL attacks. You can find this rule in my GitHub repository.\n\nlet DLLLoaded =\nDeviceEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == @\"DriverLoad\"\n| where FileName endswith \".dll\"\n| distinct FileName;\nDeviceRegistryEvents\n| where ActionType == @\"RegistryKeyCreated\" or ActionType == @\"RegistryValueSet\"\n| where RegistryKey has_any(DLLLoaded)\n\n// MITRE ATT\u0026CK MAPPING\n// Technique: T1547.006 - Boot or Logon Autostart Execution: Kernel Modules and Extensions\n// Technique: T1112 - Modify Registry\n// Technique: T1055.001 - Process Injection: Dynamic-link Library Injection"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Zero-Day CVE-2025-21333 Privilege Escalation",
    "query": "// Detecting Zero-Day CVE-2025-21333 Privilege Escalation\n\n// https://securityonline.info/windows-hyper-v-zero-day-cve-2025-21333-poc-drops-system-access-exposed/\n// https://github.com/MrAle98/CVE-2025-21333-POC\n\nlet QueryPeriod = 30d;\nlet DetectionPeriod = 1h;\nlet HyperVEnabledEndpoint =\nDeviceProcessEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where FileName == \"WindowsSandboxServer.exe\"\n| distinct DeviceId;\nlet VulnerableEndpoint =\nDeviceTvmSoftwareVulnerabilities\n| where CveId == \"CVE-2025-21333\"\n| distinct DeviceId;\nlet NewExePOCCreation =\nDeviceFileEvents\n| where Timestamp \u003e ago(DetectionPeriod)\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".exe\"\n| distinct FileName;\nDeviceEvents\n| where Timestamp \u003e ago(DetectionPeriod)\n| where ActionType == \"ProcessPrimaryTokenModified\"\n| where FileName has_any(NewExePOCCreation)\n| where DeviceId has_any(HyperVEnabledEndpoint) and DeviceId has_any(VulnerableEndpoint)"
  },
  {
    "source": "SlimKQL",
    "name": "Device or VM with critical CVSS and ExploitIsVerified",
    "query": "// Device or VM with critical CVSS and ExploitIsVerified \n// https://www.linkedin.com/posts/activity-7193835506164469761-_1ty/\n\n// The â€˜MDE DeviceTvmSoftwareVulnerabilitiesKBâ€™ table includes the â€˜IsExploitAvailableâ€™ column, which simply indicates the public availability of an exploit. In contrast, the â€˜Exposure Management ExposureGraphNodesâ€™ table features the â€˜ExploitabilityLevelâ€™ column, offering more detailed information about the exploit, such as whether â€˜ExploitIsVerifiedâ€™. Bearing this in mind, we have crafted a KQL query to isolate Critical CVEs that are verified as exploitable. This query is then combined with the â€˜ExposureGraphEdgeâ€™ to identify all devices and virtual machines that are vulnerable to critical, exploitable CVEs. The goal is to prioritize the remediation of these machines urgently, thereby minimizing the potential attack surface.\n\nExposureGraphNodes \n| where NodeLabel == \"Cve\"\n| extend CVSSScore = tostring(NodeProperties.rawData.cvssScore)\n| extend Severity = tostring(NodeProperties.rawData.severity)\n| extend HasExploit = tostring(NodeProperties.rawData.hasExploit)\n| extend ExploitabilityLevel = tostring(NodeProperties.rawData.exploitabilityLevel)\n| where ExploitabilityLevel == \"ExploitIsVerified\" and Severity == \"Critical\"\n| join ExposureGraphEdges on $left.NodeId == $right.SourceNodeId\n| project TargetNodeName, TargetNodeLabel, SourceNodeName, CVSSScore, NodeProperties\n| sort by CVSSScore desc\n\n// MITRE ATT\u0026CK Mapping\n\n//The query focuses on identifying critical vulnerabilities with verified exploits, which aligns with several MITRE ATT\u0026CK techniques related to vulnerability exploitation. Here are some relevant techniques:\n\n// T1190 - Exploit Public-Facing Application: This technique involves exploiting vulnerabilities in public-facing applications. Your query identifies critical vulnerabilities that could be exploited in such a manner1.\n// T1210 - Exploitation of Remote Services: This technique involves exploiting vulnerabilities in remote services. The queryâ€™s focus on verified exploits and critical severity aligns with detecting such exploitation attempts1.\n// T1068 - Exploitation for Privilege Escalation: This technique involves exploiting vulnerabilities to gain higher privileges. Critical vulnerabilities with verified exploits could be used for privilege escalation1."
  },
  {
    "source": "SlimKQL",
    "name": "Direct Send Abuse Detection",
    "query": "// https://www.bleepingcomputer.com/news/security/microsoft-365-direct-send-abused-to-send-phishing-as-internal-users/\n\nDeviceEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == \"DnsQueryResponse\"\n| extend QueryName = tolower(tostring(parse_json(AdditionalFields)[\"DnsQueryString\"]))\n| where QueryName endswith \"-com.mail.protection.outlook.com\""
  },
  {
    "source": "SlimKQL",
    "name": "Discord Invite Hijacking Detection",
    "query": "// Discord Invite Hijacking Detection\n// https://darkatlas.io/blog/discord-invite-hijacking-how-fake-links-are-delivering-infostealers\n\nlet QueryPeriod = 1h;\nlet MonitorURLs = dynamic([\"discord.com\",\"discord.gg\"]);\nlet DiscordAccess =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where isnotempty(RemoteUrl)\n| where ActionType == @\"ConnectionSuccess\"\n| where RemoteUrl has_any (MonitorURLs)\n| distinct DeviceName;\nDeviceNetworkEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where isnotempty(RemoteUrl)\n| where ActionType == @\"ConnectionSuccess\"\n| where DeviceName has_any(DiscordAccess) and RemoteUrl =~ \"captchaguard.me\""
  },
  {
    "source": "SlimKQL",
    "name": "DocuShield - NRT Anti-Impersonation Email Purge",
    "query": "// DocuShield: NRTâ€™s Anti-Impersonation Email Purge! ðŸ¤£\n\n// Christmas comes early! Hereâ€™s my near real-time custom detection for DocuSign impersonation emails âž¡ï¸ ðŸ—‘ï¸ A simple and effective filter.\n\nEmailEvents\n| where Subject startswith \"Complete with Docusign\"\n| where SenderFromDomain !endswith \"docusign.net\"\n| where DeliveryAction != \"Blocked\""
  },
  {
    "source": "SlimKQL",
    "name": "EDR Evasion - Inject Shellcode via MSSQL CLR Assembly Detection",
    "query": "// EDR Evasion - Inject Shellcode via MSSQL CLR Assembly Detection\n\n// Blog: https://blog.pyn3rd.com/2024/11/22/How-to-use-MSSQL-CLR-assembly-to-bypass-EDR/\n\nlet VSId = dynamic([\"Microsoft Visual Studio\"]);\nlet Condition1 =\nDeviceFileEvents\n| where InitiatingProcessVersionInfoFileDescription has_any(VSId)\n| where ActionType == \"FileCreated\" and tolower(FileName) endswith \".sql\"\n| distinct DeviceName;\nlet SQLStudioId = dynamic([\"Microsoft SQL Server Management Studio\"]);\nlet Condition2 =\nDeviceFileEvents\n| where InitiatingProcessVersionInfoFileDescription has_any(SQLStudioId)\n| distinct DeviceName;\nDeviceProcessEvents\n| where ActionType == \"ProcessCreated\"\n| where FileName == \"sqlservr.exe\"\n| where DeviceName has_any (Condition1) and DeviceName has_any(Condition2)"
  },
  {
    "source": "SlimKQL",
    "name": "EchoSpoofing",
    "query": "//By leveraging Defender threat intelligence data to first identify abused Proofpoint email gateways and correlating this with emails that have passed authentication checks (SPF/DKIM/DMARC) from these gateways, you can quickly spot abnormal inbound email counts from legitimate non-business partner domains by reviewing the email statistics. (E.g Disney.com)\n\nlet HighRiskProofpointEmailGateways =\nCloudAppEvents \n| where ActionType == @\"TIMailData-Inline\"\n| where RawEventData has \"pphosted.com\" or ISP == @\"proofpoint inc.\"\n| extend SenderIP = tostring(RawEventData.SenderIp)\n| distinct SenderIP;\nEmailEvents\n| where SenderIPv4 has_any(HighRiskProofpointEmailGateways)\n| extend SenderInfo = geo_info_from_ip_address(SenderIPv4)\n| extend AuthDetail = parse_json(AuthenticationDetails)\n| where AuthDetail.SPF==\"pass\" and AuthDetail.DKIM==\"pass\" and AuthDetail.DMARC==\"pass\"\n| summarize Count=count() by SenderFromDomain\n| sort by Count desc\n\n// https://labs.guard.io/echospoofing-a-massive-phishing-campaign-exploiting-proofpoints-email-protection-to-dispatch-3dd6b5417db6\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL code is designed to detect potentially malicious email activities by focusing on high-risk Proofpoint email gateways and ensuring the emails pass key authentication checks. The associated MITRE ATT\u0026CK techniques include:\n\n// T1071.001: Application Layer Protocol - Web Protocols\n// T1071.003: Application Layer Protocol - Email Protocols\n// T1589.002: Gather Victim Network Information - DNS\n// T1078.003: Valid Accounts - Cloud Accounts"
  },
  {
    "source": "SlimKQL",
    "name": "Email Campaign - Exploiting SVG Files and trycloudflare.com to Spread Malware",
    "query": "// Email Campaign: Exploiting SVG Files and trycloudflare.com to Spread Malware\n\n// According to a Deutsche Telekom CERT advisory (link in the comments), an email campaign has been detected that delivers malware by exploiting SVG files and trycloudflare.com.\n// 1. The attack begins with an email ðŸ“§ containing an SVG file. When opened, this file drops an HTML file that displays a spoofed PDF, tricking the victim into clicking an \"Open\" button.\n// 2. Clicking this button triggers JavaScript code that attempts to connect to the TryCloudflare domain via WebDAV and create a network share. Opening this share executes a VBS file, continuing the infection chain.\n// I have developed a DefenderXDR MDO + MDE + ExposureManagement KQL detection to hunt for potential abuse involving SVG files and trycloudflare.com.\n\n// Deutsche Telekom CERT\n// https://x.com/DTCERT/status/1858890116137099581\n\nlet TargetSVGRecipients =\nEmailAttachmentInfo\n| where FileName endswith \".pdf.svg\"\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| join IdentityInfo on $left.RecipientEmailAddress == $right.AccountUpn\n| summarize arg_max(Timestamp, *) by AccountUpn\n| distinct AccountDisplayName;\nlet TargetSVGdevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| where SourceNodeName has_any(TargetSVGRecipients)\n| distinct TargetNodeName;\nDeviceNetworkEvents\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has \".trycloudflare.com\"\n| where DeviceName has_any(TargetSVGdevices)"
  },
  {
    "source": "SlimKQL",
    "name": "Endpoint SMB exposed on Public Internet",
    "query": "// Endpoint SMB exposed on Public Internet\n\n// Actor Profile: Seashell Blizzard\n\n// Seashell Blizzard (IRIDIUM) is a Russian cyber threat actor linked to the GRU. Active since 2013, they have conducted high-profile cyber attacks, including KillDisk, NotPetya, and FoxBlade. Their operations target critical infrastructure and support geopolitical objectives, using tools like Cobalt Strike and DarkCrystalRAT for espionage and sabotage.\n\n// The following list has some of the vulnerabilities this group has exploited recently.\n\n// CVE-2017-0143-Microsoft Server Message Block 1.0 (SMBv1)\n// CVE-2017-0145-Microsoft Server Message Block 1.0 (SMBv1)\n\n// I have provided a KQL detection for Endpoint SMB exposed on Public Internet for defenders to tighten their attack surface area against IRIDIUM\n\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == @\"InboundConnectionAccepted\"\n| where LocalPort == \"445\"\n| where RemoteIPType == @\"Public\"\n| where not (ipv4_is_private(LocalIP))\n\n\n\n// Mitre ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Enhanced Cloudflare Phishing Email Detections",
    "query": "// Enhanced Cloudflare Phishing Email Detections\n// https://www.fortra.com/blog/cloudflare-pages-workers-domains-increasingly-abused-for-phishing\n// Fortra has observed a rising trend in legitimate service abuse, with a significant volume of attacks targeting Cloudflare Pages. Workers.dev is a domain used by Cloudflare Workersâ€™ deployment services, while Pages.dev is used by Cloudflareâ€™s Pages platform that facilitates the development of web pages and sites. Fortraâ€™s SEA team has observed a 198% increase in phishing attacks on Cloudflare Pages, rising from 460 incidents in 2023 to 1,370 incidents as of mid-October 2024. With an average of approximately 137 incidents per month, the total volume of attacks is expected to surpass 1,600 by year-end, representing a projected year-over-year increase of 257%.\n\n// The below KQL is a second layer detection on top of existing MDO detection for abused Cloudflare pages.dev and workers.dev Domains.\n\n// Custom DefenderXDR Detection - Moved to deleted/junk\n// Detect Cloudflare pages.dev and workers.dev Domains Abused for Phishing\n\nlet MaliciousDomainTable=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/romainmarcoux/malicious-domains/main/full-domains-aa.txt']\n| parse RawData with MaliciousDomain:string;\nEmailUrlInfo\n| where Timestamp \u003e ago(1h)\n| where UrlDomain endswith \".pages.dev\" or UrlDomain endswith \".workers.dev\"\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction != \"Blocked\"\n| join MaliciousDomainTable on $left.UrlDomain == $right.MaliciousDomain\n\n// MITRE ATTACK"
  },
  {
    "source": "SlimKQL",
    "name": "Entra Admin Roles Query",
    "query": "// Exposure Management - Entra Admin Roles Query\n// https://www.linkedin.com/posts/activity-7189252312106700800-boXn/\n\n\n// This KQL is even better than Entra PIM Dashboard! ðŸ˜Ž Just run this KQL in DefenderXDR Advanced Hunting, it will instantly tell you how many admin roles has been assigned out. If you comment out the last line of the KQL code, it will give you a comprehensive view of each admin and the number of roles assigned to him/her. Now with this roles assignment information available, you can also combine composite threat hunting KQL inclusive of admin roles ðŸ¤¯\n\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| extend AccountUPN = NodeProperties.rawData.accountUpn\n| extend AdminRoles = NodeProperties.rawData.assignedRoles\n| extend NumberofRoles = array_length(AdminRoles)\n| where NumberofRoles \u003e 0\n| summarize TotalRolesAssigned = sum(NumberofRoles)\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query focuses on identifying accounts with administrative roles, which can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// This technique involves the use of valid accounts to gain access to systems. The query identifies accounts with administrative roles, which could be targeted by adversaries to gain elevated privileges1.\n// T1078.004 - Valid Accounts: Cloud Accounts:\n// If the accounts are cloud-based, this sub-technique is relevant. Adversaries may target cloud accounts with administrative roles to gain access to cloud resources1.\n// T1087 - Account Discovery:\n// This technique involves discovering accounts and their roles. The query helps in identifying accounts with administrative roles, which is a form of account discovery1."
  },
  {
    "source": "SlimKQL",
    "name": "Entra Cross-Tenant Activity Monitoring",
    "query": "// Entra Cross-Tenant Activity Monitoring\n\n// The AADSpnSignInEventsBeta table is currently in beta and available for a limited time, enabling you to explore Microsoft Entra sign-in events. To collect and view activities in this table, a Microsoft Entra ID P2 license is required. This table, part of the advanced hunting schema, contains details about sign-ins by Microsoft Entra service principals and managed identities. Below is a custom KQL detection for DefenderXDR to monitor cross-tenant activity, which can help detect potential OAUTH app compromises. (E.g Midnight Blizzard Case)\n\n// Entra Cross-Tenant Activity (Potential App Compromise)\n// Please set your Entra Home Tenant ID\n\nlet EntraHomeTenantID = \"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\";\nAADSpnSignInEventsBeta\n| where Timestamp \u003e ago (1h)\n| where ResourceTenantId != EntraHomeTenantID\n| project Timestamp, ReportId, Application, ApplicationId, ServicePrincipalName, ServicePrincipalId, ResourceTenantId, IPAddress, Country\n\n// After you obtained the target tenant ID\n// Use Microsoft Graph to gather more info on the tenant ID\n// https://learn.microsoft.com/en-us/graph/api/tenantrelationship-findtenantinformationbytenantid?view=graph-rest-1.0\u0026tabs=http"
  },
  {
    "source": "SlimKQL",
    "name": "Exposure Management + Defender for Office 365",
    "query": "//Exposure Management + Defender for Office 365\n//https://www.linkedin.com/posts/activity-7178261918795649024-cah8/\n\n//Custom DefenderXDR detection rule for critical identities marked by exposure management clicking on malicious email link. This would triggered the isolation of the user account and devices impacted to minimize lateral movement.\n\n//KQL Detection Code:\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and NodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4\n| extend AccountUPN = tostring(NodeProperties.rawData.accountUpn)\n| distinct AccountUPN;\nAlertInfo\n| where Title == \"A potentially malicious URL click was detected\"\n| join AlertEvidence on AlertId\n| join EmailEvents on NetworkMessageId\n| where RecipientEmailAddress has_any (CriticalIdentities)\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols\n// The detection of a potentially malicious URL click involves monitoring web protocols, which falls under this technique.\n// T1566.002 - Phishing: Spearphishing Link\n// The alert for a potentially malicious URL click is indicative of spearphishing attempts, where attackers use malicious links to compromise targets.\n// T1078 - Valid Accounts\n// The focus on critical identities and their email addresses suggests monitoring for the use of valid accounts, which is relevant to this technique.\n// T1087.002 - Account Discovery: Domain Account\n// The queryâ€™s identification of critical identities involves discovering domain accounts, aligning with this technique."
  },
  {
    "source": "SlimKQL",
    "name": "Exposure Management - Slim's Metric (MaxCVSS-DAW)",
    "query": "//Exposure Management - Slim's Metric (MaxCVSS-DAW)\n//https://www.linkedin.com/posts/activity-7178429122094772224-aK3e/\n\n//Maximum CVSS for Domain Admin Workstations. A favorite KQL wish list for all CISO ðŸ˜œ Secure your \"keys\" to your kingdom before it gets breached!\n\n//KQL Code:\n\nExposureGraphNodes\n| where NodeProperties.rawData.criticalityLevel contains \"Domain Admin Workstations\"\n| where isnotnull(NodeProperties.rawData.highRiskVulnerabilityInsights)\n| extend MaxCvssScore = toreal(NodeProperties.rawData.highRiskVulnerabilityInsights.maxCvssScore)\n| sort by MaxCvssScore desc\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query focuses on identifying high-risk vulnerabilities on Domain Admin Workstations, which can be mapped to several MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to maintain access to systems.\n// Relevance: Domain Admin Workstations are critical assets, and vulnerabilities here could be exploited to gain or maintain access.\n// T1068 - Exploitation for Privilege Escalation:\n// Description: Adversaries may exploit vulnerabilities to elevate their privileges.\n// Relevance: High-risk vulnerabilities with high CVSS scores could be exploited for privilege escalation.\n// T1210 - Exploitation of Remote Services:\n// Description: Adversaries may exploit vulnerabilities in remote services to execute code.\n// Relevance: Vulnerabilities on Domain Admin Workstations could be targeted to exploit remote services.\n// T1190 - Exploit Public-Facing Application:\n// Description: Adversaries may exploit vulnerabilities in public-facing applications.\n// Relevance: If Domain Admin Workstations have public-facing applications, these vulnerabilities could be exploited."
  },
  {
    "source": "SlimKQL",
    "name": "Exposure Management: Cloud or On-Prem VDI Platform Blast Radius",
    "query": "// Exposure Management: Cloud or On-Prem VDI Blast Radius\n// https://www.linkedin.com/posts/0x534c_defenderxdr-exposuremanagement-attackpath-activity-7228066647335387137-dDBd/\n// The following KQL query leverages the DefenderXDR ExposureGraphEdges schema to analyze workstations that permit multiple user logons. After identifying cloud or on-premises virtual desktop infrastructure (VDI), it scans the DeviceTvmSoftwareVulnerabilities for critical and high CVEs linked to these multi-user logons. Remember, unpatched workstations with numerous users significantly increase your attack surface. This KQL query helps you assess the associated blast radius of your VDI attack surface if not managed properly.ðŸŽ¯\n\nlet AVDs =\nExposureGraphEdges\n| where EdgeLabel == \"can authenticate as\"\n| summarize UserLogonCount=count() by SourceNodeName\n| where UserLogonCount \u003e 3\n| distinct SourceNodeName;\nDeviceTvmSoftwareVulnerabilities\n| where VulnerabilitySeverityLevel == \"Critical\" \nor VulnerabilitySeverityLevel == \"High\"\n| where DeviceName has_any (AVDs)\n\n// #DefenderXDR #ExposureManagement #AttackPath #BlastRadius\n\n// MITRE ATT\u0026CK Mapping\n\n// T1078 - Valid Accounts:\n// The query looks for users who can authenticate as other users, which aligns with the use of valid accounts for lateral movement or persistence.\n// T1078.001 - Valid Accounts: Local Accounts:\n// If the accounts identified are local accounts, this sub-technique is relevant.\n// T1078.002 - Valid Accounts: Domain Accounts:\n// If the accounts identified are domain accounts, this sub-technique is relevant.\n// T1078.003 - Valid Accounts: Cloud Accounts:\n// If the accounts identified are cloud accounts, this sub-technique is relevant.\n// T1087 - Account Discovery:\n// The process of identifying accounts that can authenticate as other users can be seen as account discovery.\n// T1087.001 - Account Discovery: Local Account:\n// If the accounts are local, this sub-technique is relevant.\n// T1087.002 - Account Discovery: Domain Account:\n// If the accounts are domain accounts, this sub-technique is relevant.\n// T1087.003 - Account Discovery: Cloud Account:\n// If the accounts are cloud accounts, this sub-technique is relevant.\n// T1210 - Exploitation of Remote Services:\n// The query identifies devices with critical or high vulnerabilities, which could be exploited for remote access.\n// T1069 - Permission Groups Discovery:\n// Identifying users with specific permissions can be related to discovering permission groups."
  },
  {
    "source": "SlimKQL",
    "name": "External Attack Surface Monitoring KQL",
    "query": "// External Attack Surface Monitoring (EASM) KQL\n// \"The one KQL query that unveils the entire external surface of your MDE device fleet\"\n\nlet InternetFacingDevices =\n   ExposureGraphNodes\n   | where NodeLabel == 'device' or (Categories has 'virtual_machine' and set_has_element(Categories, 'virtual_machine'))\n   | where NodeProperties.rawData.isInternetFacing == true\n   | distinct NodeName;\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ListeningConnectionCreated\"\n| where DeviceName has_any(InternetFacingDevices)\n| where LocalIP != @\"127.0.0.1\"\n| summarize ListeningPortExposed=dcount(LocalPort) by DeviceName\n| sort by ListeningPortExposed desc"
  },
  {
    "source": "SlimKQL",
    "name": "FileFix Detection",
    "query": "// FileFix - Social Engineering Attack Detection\n// https://mrd0x.com/filefix-clickfix-alternative/\n\nlet MonitoredCommands = dynamic([\"powershell\",\"pwsh\",\"regsvr32\",\"bitsadmin\",\"certutil\", \"mshta\"]);\nlet BrowserList = dynamic([\"chrome\",\"msedge\",\"firefox\",\"brave\"]);\nDeviceProcessEvents\n| where Timestamp \u003e ago(1h)\n| where FileName has_any(MonitoredCommands) and InitiatingProcessFileName has_any(BrowserList)"
  },
  {
    "source": "SlimKQL",
    "name": "Finding internet facing device with CUPS",
    "query": "// Finding internet facing device with CUPS\n\n// My feed was buzzing with CUPS disclosures (CVSS 9.9) this morning, and itâ€™s only Friday! Time to bring out my DefenderXDR Exposure Management toolkit and cast this magical KQL spell to identify all internet-connected devices with CUPS for a swift search and rescue operation.\n\n// Attacking UNIX Systems via CUPS, Part I\n// Link: https://www.evilsocket.net/2024/09/26/Attacking-UNIX-systems-via-CUPS-Part-I/\n\n// DefenderXDR Exposure Management\n\nlet InternetFacingDevices =\nExposureGraphNodes\n| where NodeLabel == 'device' or \n(Categories has 'virtual_machine' and set_has_element(Categories, 'virtual_machine'))\n| where NodeProperties.rawData.isInternetFacing == true\n| project NodeName;\nDeviceTvmSoftwareInventory\n| where DeviceName has_any (InternetFacingDevices)\n| where SoftwareName has \"cups\"\n\n// Mitre ATT\u0026CK\nTechnique: T1518.001 - Software Discovery: Security Software Discovery"
  },
  {
    "source": "SlimKQL",
    "name": "Git Critical Vulnerability CVE-2024-32002",
    "query": "// Git Critical Vulnerability CVE-2024-32002\n// https://www.linkedin.com/posts/activity-7197478049729110016-TGar/\n\n// Git is a widely-popular distributed version control system for collaborative software development. Critical Git vulnerability allows RCE when cloning repositories with submodules (CVE-2024-32002).\n\n// Privilege Role Admin with vulnerable Git:\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet CriticalDevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-32002\"\n| where DeviceName has_any (CriticalDevices)\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query is designed to identify critical identities and devices, and then find devices with a specific vulnerability. The associated MITRE ATT\u0026CK techniques include:\n\n// T1078: Valid Accounts\n// T1078.001: Valid Accounts: Local Accounts\n// T1078.003: Valid Accounts: Local Administrator Account\n// T1190: Exploit Public-Facing Application\n// T1210: Exploitation of Remote Services"
  },
  {
    "source": "SlimKQL",
    "name": "GitLab Threat Intelligence Identified 16 Malicious Chrome extensions",
    "query": "// GitLab Threat Intelligence Identified 16 Malicious Chrome extensions\n\n// https://gitlab-com.gitlab.io/gl-security/security-tech-notes/threat-intelligence-tech-notes/malicious-browser-extensions-feb-2025/\n\nlet GitLabTI=externaldata(MaliciousChromeID:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/GitLabTI-MaliciousChromeExtID.csv'];\nlet MID =\nGitLabTI\n| project MaliciousChromeID;\nDeviceFileEvents\n| where ActionType == \"FileCreated\" or ActionType == \"FileModified\" or ActionType == \"FileRenamed\"\n| where FileName endswith \".crx\"\n| where FileName has_any(MID)"
  },
  {
    "source": "SlimKQL",
    "name": "Global Admin Entra Cookie with Chrome ZeroDay",
    "query": "// Global Admin Entra Cookie with Chrome Zero-Day\n// CVE-2025-4664 Chrome flaw with public exploit\n// https://www.bleepingcomputer.com/news/security/cisa-tags-recently-patched-chrome-bug-as-actively-exploited-zero-day/\n// https://www.bleepingcomputer.com/news/security/google-fixes-high-severity-chrome-flaw-with-public-exploit/\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) \nand NodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4\n| where NodeProperties has \"Global Administrator\" // Remove this line to include all Critical Identities\n| distinct NodeName;\nlet VulnerableEndPointwithBCookie =\nExposureGraphEdges\n| where EdgeLabel == @\"has credentials of\"\n| where EdgeProperties has \"BrowserCookies\"\n| where TargetNodeName has_any (CriticalIdentities)\n// SourceNodeName = Devices that contains GA browser cookie \n| distinct SourceNodeName;\nDeviceProcessEvents\n| where Timestamp \u003e ago(30d)\n| where ProcessVersionInfoProductName == \"Google Chrome\"\n| where ProcessVersionInfoProductVersion != \"136.0.7103.114\" and\nProcessVersionInfoProductVersion != \"136.0.7103.113\"\n| summarize arg_max(Timestamp, *) by DeviceId\n| where DeviceName has_any(VulnerableEndPointwithBCookie)"
  },
  {
    "source": "SlimKQL",
    "name": "Golden Chickens TerraLogger Detection",
    "query": "// https://www.recordedfuture.com/research/terrastealerv2-and-terralogger\n\nDeviceFileEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".txt\"\n| where FolderPath startswith \"c:\\\\programdata\\\\\"\n| where InitiatingProcessCommandLine has \"regsvr32\" and\nInitiatingProcessCommandLine has \".ocx\""
  },
  {
    "source": "SlimKQL",
    "name": "Golden Chickens TerraStealerV2 Malware Detection",
    "query": "// https://www.recordedfuture.com/research/terrastealerv2-and-terralogger\n\n// ðŸ¤£ Golden Chickens ðŸ¤£ \n// TerraStealerV2 Malware Detection\n//\nlet QueryPeriod = 1d;\nlet MonitorExtension = dynamic([\".lnk\", \".exe\", \".dll\", \".msi\"]);\nlet EPwithLowFP =\nDeviceFileEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where ActionType == @\"FileCreated\"\n| where FileName has_any (MonitorExtension)\n| invoke FileProfile(\"SHA1\", 500) \n| where GlobalPrevalence \u003c 5\n| distinct DeviceName;\nDeviceNetworkEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where ActionType == \"ConnectionSuccess\" and RemoteUrl == \"wetransfers.io\"\n| where DeviceName has_any (EPwithLowFP)"
  },
  {
    "source": "SlimKQL",
    "name": "Hackers Exploit Cloudflare Tunnels to Infect Windows Systems With Python Malware",
    "query": "// Hackers Exploit Cloudflare Tunnels to Infect Windows Systems With Python Malware\n// https://security.microsoft.com/intel-explorer/articles/1a2db1aa?view=description\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/trycloudflare.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "High Precision KQL to detect MuddyWater BugSleep Backdoor",
    "query": "// High Precision KQL to detect MuddyWater BugSleep Backdoor\n// https://www.linkedin.com/posts/activity-7219263422280945664-JfyY/\n\nlet DeviceAccessIOCDomain =\nDeviceFileEvents\n| where TimeGenerated \u003e (90d)\n| where ActionType == \"FileCreated\"\n| where FileOriginUrl contains \"egnyte.com\" and FileName contains \"zip\"\n| distinct DeviceName;\nlet DevicewithScheduledTask =\nDeviceEvents\n| where ActionType == \"ScheduledTaskCreated\"\n| where DeviceName has_any(DeviceAccessIOCDomain)\n| distinct DeviceName;\nDeviceNetworkEvents\n| where RemoteIP == \"146.19.143.14\" or RemoteIP == \"91.235.234.202\" or RemoteIP == \"85.239.61.97\"\n| where DeviceName has_any(DevicewithScheduledTask)\n\n// CheckPoint: New Bugsleep backdoor deployed in recent MuddyWater Campaigns\n// Link: https://lnkd.in/grK6knuU\n\n// MITRE ATT\u0026CK Mapping\n\n// File Creation with Specific Origin and Name:\n// Technique: T1071.001 - Application Layer Protocol: Web Protocols\n// Description: The query looks for files created from a specific URL (egnyte.com) and with a specific file type (zip). This can be associated with data exfiltration or staging.\n// Scheduled Task Creation:\n// Technique: T1053.005 - Scheduled Task/Job: Scheduled Task\n// Description: The query identifies devices where a scheduled task has been created. This is a common persistence mechanism used by adversaries.\n// Network Communication with Specific IPs:\n// Technique: T1071.001 - Application Layer Protocol: Web Protocols\n// Description: The query filters network events for communication with specific IP addresses. This can be indicative of command and control (C2) communication."
  },
  {
    "source": "SlimKQL",
    "name": "High-Risk assets with command line credentials",
    "query": "// High-Risk assets with command line credentials\n\n// DefenderXDRâ€™s critical asset management uses behavior-based logic to automatically identify assets of interest. However, there may be instances where not all relevant assets are detected. In this post, I will share a KQL query to identify servers and workstations that frequently run command line commands with username/password parameters. These systems often store administrative credentials due to command line execution. If compromised, the blast radius could be significant, as stored credentials could be exposed, accelerating lateral movement attacks. SecOps should run this KQL query to identify device names and create a new classification in DefenderXDRâ€™s critical management, tagging these devices as high criticality. This ensures that when an incident or alert is triggered, correlations can be made quickly, leading to faster triaging and containment.\n\n// High-Risk assets with command line credentials\n\nlet MonitoredCommands = dynamic(['net', 'wmic', 'schtasks', 'psexec', 'cmdkey', 'winrs', 'pscp', 'winscp']);\nDeviceEvents\n| where Timestamp \u003e ago(30d)\n| where InitiatingProcessCommandLine has_any(MonitoredCommands) \n| where InitiatingProcessCommandLine matches regex '(?:(?:(?:-p)|(?:-password)|(?:-passwd)|(?:--password)|(?:--passwd)|(?:/P)|(?:/PASSWD)|(?:/PASSWORD))(?:\\\\s+|\\\\:)(?\u003cpassword\u003e(?:\"((?:\\\\\\\\.|[^\"\\\\\\\\])*)\")|(?:[^\\\\s\"]+)))'\nor InitiatingProcessCommandLine matches regex '(?:(?:(?:-u)|(?:-user)|(?:-username)|(?:--user)|(?:--username)|(?:/u)|(?:/USER)|(?:/USERNAME))(?:\\\\s+|\\\\:)(?\u003cusername\u003e(?:\"((?:\\\\\\\\.|[^\"\\\\\\\\])*)\")|(?:[^\\\\s\"]+)))'\n| distinct DeviceName;\n\n// MITRE ATT\u0026CK technique mapping for your KQL code:\n\n// Command and Scripting Interpreter (T1059): The query monitors commands like net, wmic, schtasks, psexec, cmdkey, winrs, pscp, and winscp, which are commonly used for scripting and command execution.\n// Credential Dumping (T1003): The regex patterns in your query are designed to detect the use of passwords and usernames in command lines, which is indicative of credential dumping activities.\n// Remote Services (T1021): Commands like psexec, winrs, pscp, and winscp are used for remote service execution and file transfer, aligning with lateral movement techniques.\n// Scheduled Task/Job (T1053): The use of schtasks indicates the creation or modification of scheduled tasks, which is a common persistence technique.\n// Windows Management Instrumentation (T1047): The wmic command is used for remote management and execution, which falls under this technique."
  },
  {
    "source": "SlimKQL",
    "name": "Hunt for High Volume Phish ISP",
    "query": "//During my routine threat hunting, I observed that the ISP \"kuroit limited,\" which operates in the USA, London, and Amsterdam, is sending a significant number of malicious emails from gmail.com domains. This is something defenders should monitor and filter as necessary.ðŸ¤\n\nCloudAppEvents\n| where Application == \"Microsoft Exchange Online\"\n| where ActionType == \"TIMailData-Inline\"\n| where ActivityType == \"Securityevent\"\n| where ISP == \"kuroit limited\"\n| extend CAInternetMessageId = tostring(parse_json(RawEventData)[\"InternetMessageId\"])\n| join EmailEvents on $left.CAInternetMessageId == $right.InternetMessageId\n| where EmailDirection == \"Inbound\""
  },
  {
    "source": "SlimKQL",
    "name": "Hunting AI Recall on Windows 11 24H2",
    "query": "// Hunting AI Recall on Windows 11 24H2\n// https://www.linkedin.com/posts/activity-7204333401787572226-jFYe/\n\n// The Windows 11 AI Recall feature, which has sparked considerable debate since its introduction by Microsoft on May 20th, operates on ARM CPU architecture. Despite the security communityâ€™s concerns, Microsoft has yet to provide comprehensive explanations. Meanwhile, this feature is now accessible in the Windows 11 24H2 update as a preview. For SecOps, particularly within large organizations, itâ€™s crucial to track whether this function is being activated on corporate endpoints, considering the potential risks highlighted in the shared articles. Below is a KQL hunting query designed for security analysts to detect any activations of the Windows 11 recall function within your corporate network, assuming the use of Microsoft Defender for Endpoint. \n\nlet Windows11_24H2 =\nDeviceInfo\n| where OSPlatform == \"Windows11\" and OSVersionInfo == \"24H2\"\n| project DeviceName;\nDeviceFileEvents\n| where FolderPath contains \"CoreAIPlatform\"\n| where DeviceName has_any(Windows11_24H2)\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// Description: This technique involves using web protocols for command and control.\n// Relevance: If â€œCoreAIPlatformâ€ involves web-based interactions, monitoring file events in this folder could help detect suspicious activities.\n// T1083 - File and Directory Discovery:\n// Description: Adversaries may search for files and directories to find information.\n// Relevance: Filtering file events in specific folders can help detect unauthorized access or discovery activities.\n// T1566.001 - Phishing: Spearphishing Attachment:\n// Description: Adversaries may send spearphishing emails with malicious attachments.\n// Relevance: If â€œCoreAIPlatformâ€ is a target for spearphishing, monitoring file events can help detect such attempts.\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to maintain access.\n// Relevance: Monitoring file events on specific devices can help detect unauthorized use of valid accounts."
  },
  {
    "source": "SlimKQL",
    "name": "Hunting CVE-2025-31324",
    "query": "// https://www.bleepingcomputer.com/news/security/over-1-200-sap-netweaver-servers-vulnerable-to-actively-exploited-flaw/\n\nlet InternetFacing =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nDeviceProcessEvents\n| where TimeGenerated \u003e ago(90d)\n| where InitiatingProcessVersionInfoProductName has \"netweaver\"\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where DeviceId has_any(InternetFacing)"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting DragonForce with ANY.RUN Threat Intelligence",
    "query": "// Hunting DragonForce with ANY.RUN Threat Intelligence\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/DragonForce_AnyRun.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where SHA256 has_any(OSINTSHA256);\nunion ScanEmailAttachments, ScanEndpointFiles"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting IngressNightmare (CVSS 9.8)",
    "query": "// https://www.wiz.io/blog/ingress-nginx-kubernetes-vulnerabilities\n\nlet InternetFacing =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nDeviceProcessEvents\n| where InitiatingProcessCommandLine has \"nginx-ingress\"\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where DeviceId has_any(InternetFacing)"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting Malicious Chrome Extension",
    "query": "// Hunting Malicious Chrome Extension\n\n// A new attack campaign has targeted known Chrome browser extensions, leading to at least 16 extensions being compromised and exposing over 600,000 users to data exposure and credential theft.\n// https://thehackernews.com/2024/12/16-chrome-extensions-hacked-exposing.html\n\n// https://www.extensiontotal.com/cyberhaven-incident-live\n// 11:08 UTC January 1st, 2025 - Total 36 malicious extensions\n\nlet MaliciousChromeExtensionID = dynamic([\"emedckhdnioeieppmeojgegjfkhdlaeo\",\"eaijffijbobmnonfhilihbejadplhddo\",\"lbneaaedflankmgmfbmaplggbmjjmbae\",\n\"hmiaoahjllhfgebflooeeefeiafpkfde\",\"pdkmmfdfggfpibdjbbghggcllhhainjo\",\"jiofmdifioeejeilfkpegipdjiopiekl\",\n\"acmfnomgphggonodopogfbmkneepfgnh\",\"hihblcmlaaademjlakdpicchbjnnnkbo\",\"ndlbedplllcgconngcnfmkadhokfaaln\",\n\"bibjgkidgpfbblifamdlkdlhgihmfohh\",\"pkgciiiancapdlpcbppfkmeaieppikkk\",\"epdjhgbipjpbbhoccdeipghoihibnfja\",\n\"bbdnohkpnbkdkmnkddobeafboooinpla\",\"befflofjcniongenjmbkgkoljhgliihe\",\"cedgndijpacnfbdggppddacngjfdkaca\",\n\"nnpnnpemnckcfdebeekibpiijlicmpom\",\"dpggmcodlahmljkhlmpgpdcffdaoccni\",\"cplhlgabfijoiabgkigdafklbhhdkahj\",\n\"egmennebgadmncfjafcemlecimkepcle\",\"mnhffkhmpnefgklngfmlndmkimimbphc\",\"oaikpkmjciadfpddlpjjdapglcihgdle\",\n\"fbmlcbhdmilaggedifpihjgkkmdgeljh\",\"kkodiihpgodmdankclfibbiphjkfdenh\",\"oeiomhmbaapihbilkfkhmlajkeegnjhe\",\n\"igbodamhgjohafcenbcljfegbipdfjpk\",\"bgejafhieobnfpjlpcjjggoboebonfcg\",\"llimhhconnjiflfimocjggfjdlmlhblm\",\n\"hodiladlefdpcbemnbbcpclbmknkiaem\",\"epikoohpebngmakjinphfiagogjcnddm\",\"pajkjnmeojmbapicmbpliphjmcekeaac\",\n\"ogbhbgkiojdollpjbhbamafmedkeockb\",\"eanofdhdfbcalhflpbdipkjjkoimeeod\",\"ekpkdmohpdnebfedjjfklhpefgpgaaji\",\n\"miglaibdlgminlepgeifekifakochlka\",\"mbindhfolmpijhodmgkloeeppmkhpmhc\",\"didhgeamncokiaegffipckhhcpnmlcbl\",\n\"bibjgkidgpfbblifamdlkdlhgihmfohh\",\"pkgciiiancapdlpcbppfkmeaieppikkk\",\"epdjhgbipjpbbhoccdeipghoihibnfja\",\n\"bbdnohkpnbkdkmnkddobeafboooinpla\",\"befflofjcniongenjmbkgkoljhgliihe\",\"cedgndijpacnfbdggppddacngjfdkaca\",\n\"nnpnnpemnckcfdebeekibpiijlicmpom\",\"dpggmcodlahmljkhlmpgpdcffdaoccni\",\"cplhlgabfijoiabgkigdafklbhhdkahj\",\n\"egmennebgadmncfjafcemlecimkepcle\",\"mnhffkhmpnefgklngfmlndmkimimbphc\",\"oaikpkmjciadfpddlpjjdapglcihgdle\",\n\"fbmlcbhdmilaggedifpihjgkkmdgeljh\",\"kkodiihpgodmdankclfibbiphjkfdenh\",\"oeiomhmbaapihbilkfkhmlajkeegnjhe\",\n\"igbodamhgjohafcenbcljfegbipdfjpk\",\"bgejafhieobnfpjlpcjjggoboebonfcg\",\"llimhhconnjiflfimocjggfjdlmlhblm\",\n\"hodiladlefdpcbemnbbcpclbmknkiaem\",\"epikoohpebngmakjinphfiagogjcnddm\",\"pajkjnmeojmbapicmbpliphjmcekeaac\",\n\"ogbhbgkiojdollpjbhbamafmedkeockb\",\"eanofdhdfbcalhflpbdipkjjkoimeeod\",\"ekpkdmohpdnebfedjjfklhpefgpgaaji\",\n\"miglaibdlgminlepgeifekifakochlka\",\"mbindhfolmpijhodmgkloeeppmkhpmhc\"]);\nDeviceFileEvents\n| where ActionType == \"FileCreated\" and FileName endswith \".crx\"\n| where FileName has_any(MaliciousChromeExtensionID)\n| where isnotempty(SHA1)"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting New Variant of Snake Keylogger",
    "query": "// Hunting New Variant of Snake Keylogger\n\n// https://www.fortinet.com/blog/threat-research/fortisandbox-detects-evolving-snake-keylogger-variant\n\n// FortiGuard Labs has identified a new variant of the Snake Keylogger, also known as 404 Keylogger, using FortiSandbox v5.0. This malware, classified as AutoIt/Injector.GTY!tr, has been responsible for over 280 million blocked infection attempts. The Snake Keylogger typically spreads through phishing emails and targets Windows users to steal sensitive information such as credentials and data from web browsers. Its capabilities include keystroke logging, credential harvesting from popular browsers, clipboard monitoring, and exfiltration of stolen data via SMTP and Telegram bots. Additionally, it employs persistence mechanisms to maintain access, process hollowing to evade detection, and retrieves the victim's IP address and geolocation.\n\n// Utilizing the file hash of the keylogger and the FileProfile KQL enrichment function, the keylogger has been detected in 1,110 MDE organizations worldwide, first appearing on January 14, 2025. I have extracted the IOCs from the FortiGuard blog and uploaded them to my GitHub. Leveraging my DefenderXDR All-In-One KQL Weekly OSINT Scan, I can hunt against your EmailAttachmentInfo, EmailUrlInfo, DeviceFileEvents, and DeviceNetworkEvents schemas for the past 30 days. (FortiGuard Blog and KQL available in the comment section)\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/SnakeLogger.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting NonEuclid RAT",
    "query": "// ð—¡ð—¼ð—»ð—˜ð˜‚ð—°ð—¹ð—¶ð—± ð—¥ð—”ð—§\n// https://www.cyfirma.com/research/noneuclid-rat/\n// NonEuclid Remote Access Trojan (RAT) is a powerful malware designed for unauthorized remote access and control of computers. Developed using C# for the .NET Framework 4.8, it employs advanced evasion techniques such as antivirus bypass, privilege escalation, anti-detection, and ransomware encryption. Its stealth, dynamic DLL loading, anti-VM checks, and AES encryption have made it popular among cybercriminals.\n\n// Currently, the IOC hash for NonEuclid.exe and Client.exe shows zero detections on VirusTotal and no global prevalence. Defenders should begin searching for the file hash and use KQL to detect file renames to the â€œ.NonEuclidâ€ extension. (Threat intelligence report in comment section)\n\n// You may need to do a one time exclusion of your corporate developed exe running as a task, after that you should catch the ðŸ€ ðŸ¤£\n\n// KQL Code:\n\nlet WhitelistExe = dynamic([\"Iamclean.exe\"]);\nlet MaliciousLPExe =\nDeviceFileEvents\n| where isnotempty(SHA1)\n| where ActionType == @\"FileCreated\" and FileName endswith \".exe\"\n| invoke FileProfile(\"SHA1\",1000)\n| where GlobalPrevalence \u003c 50\n| distinct FileName;\nDeviceEvents\n| where ActionType == @\"ScheduledTaskCreated\"\n| where AdditionalFields has_any(MaliciousLPExe)\n| where not (AdditionalFields has_any(WhitelistExe))"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting Rogue Endpoints via SMB Detection",
    "query": "// Hunting Rogue Endpoints via SMB Detection\n\n// In recent ransomware attacks, many adversaries leverage the SMB service to initiate attacks and conduct lateral movement. Therefore, a simple and effective control measure is to block SMB traffic between clients using Windows Firewall. If you have a firewall policy in place and are using Microsoft Defender for Endpoint (MDE), running the following Kusto Query Language (KQL) script will help you identify potential rogue endpoints plugged into your network that are attempting to attack other endpoints or an endpoint EDR that has been disabled by ransomware and is launching attacks within your network environment.\n\n//Additionally, Iâ€™ve included the latest blog post from Seqrite, \"Exposed SMB: The Hidden Risk Behind â€˜WannaCryâ€™ Ransomware Attacks,\" in the comments section. This post will help you understand the ransomware attack methodology and demonstrate how my KQL script can serve as an early warning detection mechanism.\n\n// https://www.seqrite.com/blog/wanttocry-ransomware-smb-vulnerability/\n\nDeviceEvents\n| where ActionType == @\"FirewallInboundConnectionBlocked\"\n| where LocalPort == \"445\"\n| summarize TargetDevice=dcount(DeviceName) by RemoteIP\n| where TargetDevice \u003e 3"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting Zloader DNS Tunneling",
    "query": "// Hunting Zloader DNS Tunneling\n// https://www.zscaler.com/blogs/security-research/inside-zloader-s-latest-trick-dns-tunneling\n\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(90d)\n| where ActionType == \"DnsConnectionInspected\"\n| where AdditionalFields.query contains \"bigdealcenter.world\" or AdditionalFields.query contains \"unitedcommunity.world\" or AdditionalFields.query contains \"ns1.brownswer.com\""
  },
  {
    "source": "SlimKQL",
    "name": "Hunting chrome extension with hidden tracking",
    "query": "// KQL 1 - First Version\nlet SecureAnnex=externaldata(extension_id:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/SecureAnnexIOCs.csv'];\nlet MID =\nSecureAnnex\n| project extension_id;\nDeviceFileEvents\n| where ActionType == \"FileCreated\" or ActionType == \"FileModified\" or ActionType == \"FileRenamed\"\n| where FileName endswith \".crx\"\n| where FileName has_any(MID)\n\n// KQL 2 - Optimized Version\n\nlet SecureAnnex=externaldata(extension_id:string, extension_name:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/SecureAnnexIOCs.csv']\nwith (format='csv', ignoreFirstRecord=true);\nDeviceFileEvents\n| where ActionType == \"FileCreated\" or ActionType == \"FileModified\"\n| where FileName endswith \".crx\"\n| extend ExtensionIDVersion = tostring(split(FileName, '.')[0])\n| extend ExtensionID = tolower(split(ExtensionIDVersion, '_')[0])\n| summarize arg_max(TimeGenerated, *) by DeviceName, ExtensionID\n| join SecureAnnex on $left.ExtensionID == $right.extension_id"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting fake Reddit sites push Lumma Stealer malware - Part 2",
    "query": "// Hunting fake Reddit sites push Lumma Stealer malware - Part 2\n\n// https://www.bleepingcomputer.com/news/security/hundreds-of-fake-reddit-sites-push-lumma-stealer-malware/\n\n// A recent cybersecurity threat where hackers have created nearly 1,000 fake websites mimicking Reddit and WeTransfer. These fraudulent sites are used to distribute the Lumma Stealer malware, which is designed to steal sensitive information such as passwords and session tokens. The campaign highlights the ongoing risks posed by info-stealer malware, which can compromise both individual and organizational data. These fake websites were found by Sekoia researcher crep1x, who shared a complete list of web pages participating in the scheme. Using this list as a threat hunting basis, here is my second MDE  threat hunting KQL.\n\nlet FakeRedditLummaS=externaldata(RawData:string)\n[h'https://gist.githubusercontent.com/qbourgue/071c333ff5182f031da3ba55cc7da1ec/raw/ec4ba396c0d1052cc8b0a69c1bad1e0e5aef2ab6/malicious_domains_impersonating_reddit_wetransfer_selfau3_dropper_lumma_stealer_20012025.txt']\n| parse RawData with FRDdomains:string;\nlet FakedRedditDomain =\nFakeRedditLummaS\n| distinct FRDdomains;\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == @\"HttpConnectionInspected\"\n| extend Host = parse_json(AdditionalFields)[\"host\"]\n| extend Direction = parse_json(AdditionalFields)[\"direction\"]\n| where Direction == \"Out\" and Host has_any(FakedRedditDomain)"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting fasthttp Bruteforce Campaign",
    "query": "// Hunting fasthttp Bruteforce Campaign\n// https://www.speartip.com/fasthttp-used-in-new-bruteforce-campaign/\n\n// A new brute-force campaign identified by SpearTip Security Operations Center, which leverages the fasthttp library. This high-performance HTTP server and client library for the Go programming language is being used to gain unauthorized access to accounts through brute-force login attempts and spamming multi-factor authentication (MFA) requests. The attacks primarily target the Azure Active Directory Graph API and have been observed originating mainly from Brazil, with other sources including Turkey, Argentina, Uzbekistan, Pakistan, and Iraq.\n\n// I ran similar KQL queries on both Sentinel and DefenderXDR but only detected this brute force campaign in the AADSignInEventsBeta schema of DefenderXDR. The below KQL will help detect if the brute force campaign has attack your tenant using the long IOCs provided by SpearTip. Happy Hunting ðŸ«¡\n\nlet FastHttpIOCTable=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/fasthttpIOCs.txt']\n| parse RawData with FastHttpIPs:string;\nlet IOCs =\nFastHttpIOCTable\n| distinct FastHttpIPs;\nAADSignInEventsBeta \n| where Timestamp \u003e ago(30d)\n| where ApplicationId == \"00000002-0000-0000-c000-000000000000\" and UserAgent == \"fasthttp\"\n| where IPAddress has_any(IOCs)"
  },
  {
    "source": "SlimKQL",
    "name": "Hð—¼ð˜„ ð—ºð—®ð—»ð˜† ð—–ð—¿ð—¼ð˜„ð—±ð—¦ð˜ð—¿ð—¶ð—¸ð—² ð—°ð—¹ð—¶ð—²ð—»ð˜ð˜€ ð—¿ð˜‚ð—»ð—»ð—¶ð—»ð—´ ð—¼ð—» ð— ð—¶ð—°ð—¿ð—¼ð˜€ð—¼ð—³ð˜ ð—”ð˜‡ð˜‚ð—¿ð—² ð—´ð—¹ð—¼ð—¯ð—®ð—¹ð—¹ð˜†",
    "query": "// Hð—¼ð˜„ ð—ºð—®ð—»ð˜† ð—–ð—¿ð—¼ð˜„ð—±ð—¦ð˜ð—¿ð—¶ð—¸ð—² ð—°ð—¹ð—¶ð—²ð—»ð˜ð˜€ ð—¿ð˜‚ð—»ð—»ð—¶ð—»ð—´ ð—¼ð—» ð— ð—¶ð—°ð—¿ð—¼ð˜€ð—¼ð—³ð˜ ð—”ð˜‡ð˜‚ð—¿ð—² ð—´ð—¹ð—¼ð—¯ð—®ð—¹ð—¹ð˜†\n// Linkedin Post: https://www.linkedin.com/posts/0x534c_fileprofile-function-in-advanced-hunting-activity-7232990010898010112-G2Lg/\n// While brainstorming on how to KQL detect Bring Your Own Vulnerable Driver (BYOVD) exploits in recent Zero Day CVE-2024-38193 by APT North Korean Lazarus, I was exploring the recent addition of FileProfile() enrichment function that adds the following data to files found by the query.\n\n// Advance Hunting - FileProfile()\n// https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-fileprofile-function\n\nDeviceFileEvents\n| where ActionType == \"FileCreated\" or ActionType == \"FileModified\"\n| where FileName endswith \".sys\"\n| where FolderPath contains \"CrowdStrike\"\n| invoke FileProfile(SHA1,10000)\n| project FileName, FolderPath, GlobalPrevalence, GlobalFirstSeen, GlobalLastSeen\n| sort by GlobalPrevalence desc \n\n// Note:  GlobalPrevalence - Number of instances of the entity observed by Microsoft globally\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the actions and filters in your KQL query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1070.004 - Indicator Removal on Host: File Deletion:\n// Detecting file creation or modification events, especially for .sys files, can help identify attempts to delete or modify system files to evade detection.\n// T1562.001 - Impair Defenses: Disable or Modify Tools:\n// Monitoring files in the CrowdStrike folder can help detect attempts to disable or tamper with security tools.\n// T1105 - Ingress Tool Transfer:\n// The creation of new .sys files in specific directories could indicate the transfer of malicious tools or payloads.\n// T1027 - Obfuscated Files or Information:\n// .sys files are often used to hide malicious payloads. Monitoring their creation and modification can help detect obfuscation techniques."
  },
  {
    "source": "SlimKQL",
    "name": "Identity Blast Radius",
    "query": "//Identity Blast Radius KQL\n//https://www.linkedin.com/feed/update/urn:li:activity:7174327431485431808/\n\n//Assessing high risk identity account blast radius by using risk data from AADSignInEventsBeta and edge/nodes data from ExposureGraphEdges and ExposureGraphNodes to determine the list of assets that can be potentially impacted in the event of account compromised.\n\nlet HighRiskAccounts =\nAADSignInEventsBeta\n| where RiskLevelAggregated \u003e 50\n| distinct AccountDisplayName;\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| where SourceNodeName has_any (HighRiskAccounts)\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| summarize by SourceNodeName, TargetNodeName\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the KQL query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// The query identifies accounts that have a high risk level and can authenticate to other nodes, which aligns with the use of valid accounts for lateral movement or persistence1.\n// T1071 - Application Layer Protocol:\n// The query involves analyzing authentication events, which can be related to the use of application layer protocols for command and control2.\n// T1087 - Account Discovery:\n// The query discovers high-risk accounts and their authentication capabilities, which is related to account discovery techniques3."
  },
  {
    "source": "SlimKQL",
    "name": "Infrastructure Vulnerability Exposure to Volt Typhoon",
    "query": "// Infrastructure Vulnerability Exposure to Volt Typhoon\n\n// Expert analysis from last year revealed that PRC APT groups, such as Volt Typhoon, frequently exploit known vulnerabilities in TP-Link routers during their malicious campaigns. These campaigns have included targeting government officials in European countries. In these attacks, modified firmware images have so far been found exclusively on TP-Link routers.\n// Given the portability of user laptops, there is a risk that a laptop used for work might connect to a TP-Link wireless router at home, in a cafÃ©, or at another mobile working location. This connection increases the security risk for both the endpoint and the TP-Link router, potentially making them vulnerable to exploitation.\n// By leveraging Microsoftâ€™s endpoint discovery capabilities, you can identify if any of your endpoints have connected to or detected a TP-Link router. Additionally, correlating the vulnerabilities present on these endpoints can help estimate the exposure risk to APT groups exploiting TP-Link routers.\n\n// The below KQL query will provide you a summary of your total endpoints vulnerabilities count (High, Medium \u0026 Low) that are exposed to a TP-Link router environment.\n\nlet DeviceExposedToTPLinkRouter =\nDeviceInfo\n| summarize arg_max(Timestamp, *) by DeviceId\n| where isempty(MergedToDeviceId)\n| where OnboardingStatus != \"Onboarded\"\n| where Vendor contains \"TP-LINK\"\n| invoke SeenBy()\n| extend parsedJson = parse_json(SeenBy)\n| extend SeenByDeviceID = tostring(parsedJson[0].DeviceId)\n| project SeenByDeviceID;\nDeviceTvmSoftwareVulnerabilities\n| where DeviceId has_any(DeviceExposedToTPLinkRouter)\n| summarize VulnerabilityCount=count() by VulnerabilitySeverityLevel\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query aligns with several MITRE ATT\u0026CK techniques, particularly those related to vulnerability scanning and device identification:\n\n// T1082 - System Information Discovery:\n// The query gathers detailed information about devices, including their onboarding status and vendor details.\n// T1592 - Gather Victim Host Information:\n// By identifying devices exposed to TP-Link routers, the query gathers information about potential targets.\n// T1518 - Software Discovery:\n// The query checks for software vulnerabilities on the identified devices, which is a form of software discovery.\n// T1046 - Network Service Scanning:\n// The use of SeenBy() function can be related to network service scanning to identify devices on the network."
  },
  {
    "source": "SlimKQL",
    "name": "Innovative Detection Techniques Against ZIP Concatenation Attacks",
    "query": "// Unmasking New Malware Threats: Innovative Detection Techniques Against ZIP Concatenation Attacks\n// https://perception-point.io/blog/evasive-concatenated-zip-trojan-targets-windows-users/\n// A new malware technique using ZIP file concatenation has been identified, targeting Windows users. Attackers exploit the differences in how various ZIP readers process these concatenated files, allowing them to hide malicious payloads and evade detection by security solutions. This method has been observed in recent phishing attacks, underscoring the need for more advanced detection tools. Credit to Perception Point for uncovering this critical information. (Blog to be shared in the comment section)\n// I developed a custom KQL detection to identify such potential abuse by gathering all ZIP file names received from inbound emails and using MDE DeviceFileEvents to check for ZIP file decompression that creates new additional .exe files, which might evade detection at the mail gateway level. Devices can be isolated for further action if required.\n\nlet EmailZipFile =\nEmailEvents\n| where Timestamp \u003e ago(30d)\n| join EmailAttachmentInfo on NetworkMessageId\n| where EmailDirection == \"Inbound\" and AttachmentCount == 1\n| where FileType == @\"rar\" or FileType == @\"zip\"\n| where DeliveryAction == \"Delivered\"\n| distinct FileName;\nlet UncompressTools = dynamic([\"7z.exe\", \"7za.exe\", \"7zfm.exe\", \"winzip64.exe\", \"winrar.exe\", \"unzip.exe\"]);\nDeviceFileEvents\n| where ActionType == @\"FileCreated\"\n| where InitiatingProcessFileName has_any(UncompressTools)\n| where InitiatingProcessCommandLine has_any(EmailZipFile)\n| where FileName endswith \".exe\""
  },
  {
    "source": "SlimKQL",
    "name": "Insider Threat Monitoring - Exfiltrate data via Link to Windows app",
    "query": "// Insider Threat Monitoring - Exfiltrate data via Link to Windows app\n// https://www.linkedin.com/posts/activity-7222581799716016128-7Nww/\n\n// Microsoft has simplified accessing Android phones from a PC on Windows 11. However, this convenience could potentially allow critical identities to exfiltrate data, as it lacks logging via browser or network access. By utilizing DefenderXDR exposure management, the following KQL can detect the installation of the â€˜Link to Windowsâ€™ app on endpoints associated with critical identities for DLP monitoring.\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet CriticalDevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where FileName contains \"YourPhoneAppProxy\"\n| where DeviceName has_any (CriticalDevices)\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query is designed to identify critical identities and devices, and then monitor for specific file creation events on those devices. This approach helps in detecting potential unauthorized access and suspicious activities, aligning with several MITRE ATT\u0026CK techniques such as Valid Accounts (T1078), Permission Groups Discovery (T1069), Ingress Tool Transfer (T1105), and Application Layer Protocol (T1071).\n\n// T1078: Valid Accounts - Identifying critical accounts that could be targeted for unauthorized access.\n// T1078: Valid Accounts - Identifying devices that critical accounts can access.\n// T1069: Permission Groups Discovery - Discovering devices and their associated permissions.\n// T1105: Ingress Tool Transfer - Detecting the creation of files that might be used for transferring tools or data.\n// T1071: Application Layer Protocol - Monitoring for suspicious file creation that could indicate data exfiltration or command and control."
  },
  {
    "source": "SlimKQL",
    "name": "Internet facing devices vulnerablility report",
    "query": "// https://www.greynoise.io/resources/how-resurgent-vulnerabilities-jeopardize-organizational-security\n\n// Internet facing devices vulnerablility report\n\nlet InternetFacing =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nDeviceTvmSoftwareVulnerabilities\n| where DeviceId has_any(InternetFacing)\n| summarize VulnerabilityCount=count() by DeviceName, VulnerabilitySeverityLevel\n| sort by VulnerabilityCount desc"
  },
  {
    "source": "SlimKQL",
    "name": "KQL query to oversee the privileged OAuth grants allocated to the Microsoft Graph Command Line Tools OAuth App",
    "query": "// KQL query to oversee the privileged OAuth grants allocated to the Microsoft Graph Command Line Tools OAuth App\n// https://www.linkedin.com/posts/activity-7212728685601116161-qmd4/\n\n// The Microsoft Graph Command Line Tools OAuth App, which possesses a High permission level, has received verification from Microsoft. Itâ€™s crucial for Security Operations teams to monitor the usage and consent of this tool within your organizationâ€™s M365/Azure admin framework to guarantee compliance with established change control procedures. Utilize the following KQL query to oversee the privileged OAuth grants allocated to this tool.\n\nCloudAppEvents\n| where TimeGenerated \u003e ago(90d)\n| where ActionType == \"Consent to application.\" and AccountType == \"Admin\"\n| where ObjectName contains \"Microsoft Graph\"\n\n// MITRE ATT\u0026CK Mapping\n\n// This query is related to the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts: The use of valid accounts to gain access to resources. In this case, an admin account consenting to an application.\n// T1098 - Account Manipulation: The consent to an application by an admin could be seen as a form of account manipulation, especially if the consent is unauthorized.\n// T1071 - Application Layer Protocol: The use of Microsoft Graph API, which is an application layer protocol."
  },
  {
    "source": "SlimKQL",
    "name": "KQL to calculate Tenant External Recipient Rate Limit",
    "query": "// Tenant External Recipient Rate Limit or TERR\n// https://techcommunity.microsoft.com/blog/exchange/introducing-exchange-online-tenant-outbound-email-limits/4372797\n\nEmailEvents\n| where Timestamp \u003e ago(30d)\n| where EmailDirection == \"Outbound\"\n| summarize OutboundEmailVol=count() by bin(Timestamp,1d)\n| sort by OutboundEmailVol desc"
  },
  {
    "source": "SlimKQL",
    "name": "KQL to detect if Polyfill malicious payload was loaded",
    "query": "// KQL to detect if Polyfill malicious payload was loaded\n// https://www.linkedin.com/posts/activity-7211650346522173440-988L/\n\n// Polyfill supply chain attack hits 100K+ sites.The polyfill.js is a popular open source library to support older browsers. 100K+ sites embed it using the cdn.polyfill.io domain.\n\n// KQL to detect if Polyfill malicious payload was loaded.\n\nDeviceNetworkEvents \n| where ActionType == @\"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost contains \"googie-anaiytics.com\" or HttpHost contains \"kuurza.com\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the KQL query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The query inspects HTTP connections, which falls under the use of web protocols for communication1.\n// T1071 - Application Layer Protocol:\n// More broadly, the query is looking at network traffic using application layer protocols1.\n// T1566.002 - Phishing: Spearphishing Link:\n// The suspicious domains (â€œgoogie-anaiytics.comâ€ and â€œkuurza.comâ€) suggest potential phishing attempts1.\n// T1071.003 - Application Layer Protocol: Mail Protocols:\n// If the suspicious domains are used in email communications, this technique might also be relevant1."
  },
  {
    "source": "SlimKQL",
    "name": "KQL to detect new chromium browser extension installation on MDE endpoints by Emerald Sleet (APT43)",
    "query": "// KQL to detect new chromium browser extension installation on MDE endpoints by Emerald Sleet (APT43)\n// https://www.linkedin.com/posts/activity-7212205082002513922-WGt4/\n\n// Emerald Sleet (APT43) deploying faked google translate extension to exfiltrate user email, password and cookie data. Targeting users in the U.S., Europe, and South Korea.\n\n// KQL to detect new chromium browser extension installation on MDE endpoints.\n\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FolderPath contains \"Webstore Downloads\" and FileName endswith \".crx\"\n| extend ExtensionId = extract(@\"(?i)Downloads[\\\\/]|Webstore Downloads[\\\\/](.+?)_\\d+\\.crx\", 1, FolderPath)\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the KQL query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The detection of .crx files in the â€œWebstore Downloadsâ€ folder indicates potential use of web protocols to download and install browser extensions.\n// T1036.005 - Masquerading: Match Legitimate Name or Location:\n// The use of legitimate folder names like â€œWebstore Downloadsâ€ can be a technique to masquerade malicious files as legitimate downloads.\n// T1204.002 - User Execution: Malicious File:\n// The creation of .crx files could be part of a social engineering attack where users are tricked into executing malicious browser extensions."
  },
  {
    "source": "SlimKQL",
    "name": "KQLObfusGuard - Detecting ArgFuscator Obfuscation",
    "query": "// KQLObfusGuard - Detecting ArgFuscator Obfuscation\n// https://argfuscator.net/\n\nlet KQLObfusGuard=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/argfuscator.txt']\n| parse RawData with ArgfuscatorCommand :string;\nlet ArgfuscatorCmds =\nKQLObfusGuard\n| project ArgfuscatorCommand;\nDeviceEvents\n| where Timestamp \u003e ago(1h)\n| extend ParsedCommandLine = parse_command_line(tolower(InitiatingProcessCommandLine), \"windows\")\n| extend IPCL_Length = strlen(InitiatingProcessCommandLine)\n| extend PCL_Length = strlen(tostring(ParsedCommandLine))-2-(2*array_length(ParsedCommandLine))+(array_length(ParsedCommandLine)-1)\n| where (IPCL_Length - PCL_Length \u003e 1) and ParsedCommandLine has_any(ArgfuscatorCmds)"
  },
  {
    "source": "SlimKQL",
    "name": "KQLWiz PDF NTLM Leak Detector",
    "query": "// KQLWiz PDF NTLM Leak Detector\n// https://cybersecuritynews.com/zero-day-vulnerability-in-pdf-files-leaking-ntlm-data-in-adobe-foxit-reader/\n\nDeviceFileEvents \n| where ActionType == \"FileCreated\" and FileName endswith \".pdf\"\n| where parse_json(AdditionalFields)[\"FileType\"] == 'PDF'\n| where InitiatingProcessUniqueId != 0\n| join DeviceNetworkEvents on InitiatingProcessUniqueId\n| where RemotePort == \"445\" and Protocol == \"Tcp\""
  },
  {
    "source": "SlimKQL",
    "name": "Kerberos Roasting Detection",
    "query": "// Kerberos Roasting Detection ðŸ•µï¸â€â™€ï¸ðŸ”¥\n\n// Built a KQL detection with the IdentityLogonEvents table to outsmart attackers. Bonus? A VIP whitelist entry: Wendy@Wendy.com, roasting bad actors with style!ðŸ”ðŸ¤£\n\nlet WhitelistAdminAccount = dynamic([\"Wendy@Wendy.com\"]);\nIdentityLogonEvents \n| where Timestamp \u003e ago(1h)\n| where Protocol == \"Kerberos\"\n| where parse_json(AdditionalFields)[\"AttackTechniques\"] has 'T1558.003'\n| where parse_json(AdditionalFields)[\"EncryptionType\"] has \"rc4hmac\"\n| extend SPNs = tostring(parse_json(AdditionalFields)[\"Spns\"])\n| summarize Target_SPN=dcount(SPNs) by AccountUpn\n| where not (AccountUpn has_any(WhitelistAdminAccount))\n| where Target_SPN \u003e 3"
  },
  {
    "source": "SlimKQL",
    "name": "LLM Hunting in a MDE Environment",
    "query": "// LLM Hunting in a MDE Environment\n\nlet LLM_ModelName =\nExposureGraphNodes\n| where NodeLabel == \"baseModel\"\n| project parse_json(NodeProperties)[\"rawData\"][\"aiModelMetadata\"][\"modelName\"];\nDeviceFileEvents\n| where Timestamp \u003e ago (30d)\n| where InitiatingProcessVersionInfoFileDescription has_any (LLM_ModelName) \nor InitiatingProcessFolderPath has_any (LLM_ModelName)\nor InitiatingProcessFileName has_any (LLM_ModelName)"
  },
  {
    "source": "SlimKQL",
    "name": "LockBit Black Ransomware",
    "query": "// LockBit Black Ransomware (Phorpiex botnet) KQL Detect\n// https://www.linkedin.com/posts/activity-7196135968318353408-SN3l/\n\n// Proofpoint has observed Phorpiex botnet sending millions of phishing emails to deliver LockBit Black ransomware beginning April 24, 2024 and continuing daily for about a week. I just checked my Defender and indeed I received 81 of them but they were all stop by my antimalware policy block by file type. You may want to check if you are impacted and any slipped through your defense.\n\n// Security Brief: Millions of Messages Distribute LockBit Black Ransomware\n// https://lnkd.in/dAmupJ6n\n\nDefenderXDR KQL:\n\nEmailEvents\n| where Timestamp \u003e ago(30d)\n| where SenderDisplayName == \"Jenny Green\"\nor SenderFromAddress == \"Jenny@gsd.com\"\nor SenderFromAddress ==\"JennyBrown3422@gmail.com\"\n| summarize Count=count() by LatestDeliveryAction\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1566.001 - Phishing: Spearphishing Attachment:\n// The query filters emails based on specific sender details, which could be indicative of spearphishing attempts where an attacker uses a known or trusted sender to deliver malicious content.\n// T1071.003 - Application Layer Protocol: Mail Protocols:\n// The use of email as a communication channel for potential malicious activity aligns with this technique, where attackers use mail protocols to communicate with their targets.\n// T1087.002 - Account Discovery: Email Accounts:\n// Filtering by specific email addresses can be related to discovering and targeting specific email accounts within an organization.\n// T1114 - Email Collection:\n// Summarizing email events by delivery action can help in identifying patterns related to email collection activities, where attackers gather information from email communications."
  },
  {
    "source": "SlimKQL",
    "name": "M365 Copilot Chat SafeLink Monitoring",
    "query": "// M365 Copilot Chat SafeLink Monitoring\n// https://admin.microsoft.com/AdminPortal/home?#/MessageCenter/:/messages/MC1013453\n\nlet M365CopilotChatURL =\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotAccessResources = (CopilotData.AccessedResources)\n| extend CopilotAppHost = tostring(CopilotData.AppHost)\n| extend CopilotContexts = tostring(CopilotData.Contexts)\n| extend CopilotType = tostring(CopilotData.Type)\n| extend CopilotMessageIds = tostring(CopilotData.MessageIds)\n| extend CopilotThreadId = tostring(CopilotData.ThreadId)\n| mv-expand CopilotAccessResources\n| where CopilotAppHost == \"Bing\" and isnotempty(CopilotAccessResources.SiteUrl)\n| project CopilotAccessResources.SiteUrl;\nUrlClickEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == \"ClickBlocked\"\n| where Url has_any(M365CopilotChatURL)"
  },
  {
    "source": "SlimKQL",
    "name": "M365 Copilot Gone Rouge",
    "query": "// https://www.linkedin.com/posts/0x534c_cybersecurity-safelinkprotection-maliciousurl-activity-7325956438965518337-JV3o\n\nUrlClickEvents\n| where Timestamp \u003e ago(1h)\n| where Workload == \"Copilot\"\n| where ActionType == \"ClickBlocked\"\n| project Timestamp, AccountUpn, Url, UrlChain, IPAddress"
  },
  {
    "source": "SlimKQL",
    "name": "MDE KQL to detect TA571 socialengineering abuse",
    "query": "// MDE KQL to detect TA571 socialengineering abuse\n// https://www.linkedin.com/posts/activity-7208705552833478656-8xUz/\n\nDeviceEvents\n| where ActionType == \"GetClipboardData\"\n| where InitiatingProcessFileName == \"powershell.exe\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// Technique: T1115 - Clipboard Data1\n// Description: Adversaries may collect data stored in the clipboard from users copying information within or between applications. This can include sensitive data such as passwords or other confidential information.\n// Technique: T1059.001 - Command and Scripting Interpreter: PowerShell2\n// Description: Adversaries may abuse PowerShell commands and scripts for execution. PowerShell is a powerful interactive command-line interface and scripting environment included in the Windows operating system."
  },
  {
    "source": "SlimKQL",
    "name": "MDE KQL to detect UAC bypass of Fickle Stealer",
    "query": "// MDE KQL to detect UAC bypass of Fickle Stealer\n// https://www.linkedin.com/posts/activity-7209814018230738945-6413/\n\n// The article discusses â€œFickle Stealer,â€ a new malware that uses the Rust programming language to steal sensitive information from Windows users. It is distributed through various methods, including VBA and PowerShell scripts, making it a versatile and dangerous threat.\n\n// KQL to detect UAC bypass of Fickle Stealer\n\nDeviceFileEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == \"FileCreated\"\n| where FileName == \"WmiMgmt.msc\"\n| where FolderPath contains \"\\Windows\\System32\\en-US\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the detection can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1070.004: Indicator Removal on Host - File Deletion: The creation of a specific file in the System32 directory could be an attempt to replace or hide malicious files, which is a common tactic for evading detection1.\n// T1059.001: Command and Scripting Interpreter - PowerShell: The WmiMgmt.msc file is related to Windows Management Instrumentation (WMI), which can be used for executing scripts and commands2.\n// T1569.002: System Services - Service Execution: The creation of files in the System32 directory can be related to the execution of system services, which is a technique used to maintain persistence3."
  },
  {
    "source": "SlimKQL",
    "name": "MDE: Detecting Quick Assist Usage",
    "query": "// MDE: Detecting Quick Assist Usage\n// https://www.linkedin.com/posts/activity-7196570896965287936-jut0/\n\n// SecOps can configure below custom KQL Defender detection to monitor Quick Assist usage in the organization\n\nDeviceNetworkEvents\n| where ActionType == \"HttpConnectionInspected\"\n| where RemotePort == \"443\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost == \"remoteassistance.support.services.microsoft.com:443\"\n\n// MITRE ATT\u0026CK Mapping\n\n// This query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols\n// Description: This technique involves adversaries using web protocols to communicate with compromised systems to avoid detection/network filtering by blending in with normal web traffic.\n// Relevance: The query inspects HTTP connections on port 443, which is commonly used for HTTPS traffic, a typical web protocol.\n// T1071.004 - Application Layer Protocol: DNS\n// Description: Adversaries may use DNS to communicate with systems under their control within a victim network.\n// Relevance: The query inspects connections to a specific host, which could be part of a DNS-based communication strategy.\n// T1071.003 - Application Layer Protocol: Mail Protocols\n// Description: Adversaries may use mail protocols to communicate with systems under their control.\n// Relevance: While this query does not directly inspect mail protocols, the concept of inspecting specific protocols for communication is similar."
  },
  {
    "source": "SlimKQL",
    "name": "MDO - Enhancing Email Security with NRD Filtering",
    "query": "// DefenderXDR Custom Detection Rule\n// Newly Registered Domains (NRD) A daily updated list of newly registered domains from the past 14 and 30 days\n// All inbound email URL domains scanned against NRD, if found move to junk first wait for analyst further triage\n\nlet NRDTable=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/xRuffKez/NRD/refs/heads/main/lists/30-day_phishing/domains-only/nrd-phishing-30day.txt']\n| parse RawData with NRD:string;\nEmailUrlInfo\n| where Timestamp \u003e ago(1h)\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\" and DeliveryAction != \"Blocked\"\n| join NRDTable on $left.UrlDomain == $right.NRD\n\n// MITRE ATT\u0026CK Technique\n// Acquire Infrastructure: Domains technique, specifically T1583.0011"
  },
  {
    "source": "SlimKQL",
    "name": "MDO Email Threat Classification By Country",
    "query": "// MDO Email Threat Classification By Country\n\n// https://admin.microsoft.com/AdminPortal/Home?#/MessageCenter/:/messages/MC973503\n\nEmailEvents \n| where isnotempty(ThreatClassification)\n| extend IPInfo = iff(isnotempty(SenderIPv4),\ngeo_info_from_ip_address(SenderIPv4),\ngeo_info_from_ip_address(SenderIPv6))\n| summarize Count=count() by ThreatClassification, tostring(IPInfo.country)\n| sort by Count desc"
  },
  {
    "source": "SlimKQL",
    "name": "MDO Email Threat Classification By ISP",
    "query": "// MDO Email Threat Classification By ISP\n\n// Microsoft announce the new integration of threat classification through advanced large language models (LLMs) and machine learning (ML) models in the EmailEvents schema. By leveraging this crucial data along with CloudAppEvents Exchange workload, you can now pinpoint the origin of various email threats by ISP!ðŸ¤¯ This enhancement provides a clearer understanding of email threats categorized by ISP.ðŸ«¡\n\nCloudAppEvents\n| where Application == \"Microsoft Exchange Online\"\n| where ActionType == \"TIMailData-Inline\"\n| where ActivityType == \"Securityevent\"\n| extend CAInternetMessageId = tostring(parse_json(RawEventData)[\"InternetMessageId\"])\n| join EmailEvents on $left.CAInternetMessageId == $right.InternetMessageId\n| where isnotempty(ThreatClassification)\n| summarize Count=count() by ThreatClassification, ISP\n| sort by Count desc"
  },
  {
    "source": "SlimKQL",
    "name": "MS Teams DLP Playbook",
    "query": "// MS Teams DLP Playbook\n// https://www.linkedin.com/posts/activity-7196076361977847808-JGST/\n\n// The document (Teams DLP Playbook 2024.pdf) in the blog provides an overview of how enterprise customers can deploy Microsoft Teams-DLP for protecting sensitive information.\n\n// Using Defender Custom Detection, the below KQL allow you to detect real-time DLP rules triggered:\n\nCloudAppEvents\n| where Application == \"Microsoft Teams\"\n| where ActionType contains \"DlpRuleMatch\"\n\n// The detection of DLP rule matches in Microsoft Teams can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1070.004 - Indicator Removal on Host: File Deletion: DLP rules often trigger when sensitive data is being moved or deleted to prevent data exfiltration1.\n// T1567 - Exfiltration Over Web Service: If the DLP rule is triggered by an attempt to exfiltrate data via Teams, this technique is relevant2.\n// T1071.001 - Application Layer Protocol: Web Protocols: Microsoft Teams uses web protocols for communication, and DLP rules can help detect suspicious activities over these protocols3."
  },
  {
    "source": "SlimKQL",
    "name": "MailItemsAccessed Defense",
    "query": "// MailItemsAccessed Defense\n// https://www.linkedin.com/posts/0x534c_microsoft365-exchangeonline-defenderxdr-activity-7183335339061620738-ztfq/\n\n// Simple \u0026 effective custom DefenderXDR hourly rule to detect threat actors accessing Exchange mailboxes via MailItemsAccessed log entry and marked user as compromised.\n\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where IPTags has_any (\"Brute force attacker\",\n\"Password spray attacker\", \"Malicious\", \"Tor\")\n| where ActionType == \"MailItemsAccessed\"\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Your KQL query is effectively filtering for events that could indicate various forms of credential access and email collection attacks, which are mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1110 - Brute Force\n// T1110.003 - Password Spraying\n// T1078 - Valid Accounts\n// T1071 - Application Layer Protocol\n// T1090.003 - Proxy: Multi-hop Proxy\n// T1114 - Email Collection"
  },
  {
    "source": "SlimKQL",
    "name": "Malware C2 Comms over Azure Blob Metadata",
    "query": "// Detect Malware C2 Comms over Azure Blob Metadata\n// https://security.microsoft.com/threatanalytics3/8d8a9fa0-4408-47be-8a07-7ce3d21eb827/analystreport\n\nDeviceNetworkEvents\n| where Timestamp \u003e ago(1h)\n| where RemoteUrl has \".blob.core.windows.net\"\n| where InitiatingProcessCommandLine has \"comp=metadata\""
  },
  {
    "source": "SlimKQL",
    "name": "Microsoft Defender Advanced Hunting Copilot Activities",
    "query": "//Microsoft Defender Advanced Hunting Copilot Activities\n//https://www.linkedin.com/pulse/microsoft-defender-advanced-hunting-copilot-activities-steven-lim-cudyc/\n\nCloudAppEvents\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotAccessResources = (CopilotData.AccessedResources)\n| extend CopilotAppHost = tostring(CopilotData.AppHost)\n| extend CopilotContexts = tostring(CopilotData.Contexts)\n| extend CopilotType = tostring(CopilotData.Type)\n| extend CopilotMessageIds = tostring(CopilotData.MessageIds)\n| extend CopilotThreadId = tostring(CopilotData.ThreadId)\n| project Timestamp, UserID, CopilotAccessResources, CopilotAppHost, \nCopilotContexts, CopilotType, CopilotMessageIds, CopilotThreadId\n// Copilot Interaction Data Formatted\n// Insert your hunting query for copilot related activities.\n\n//The below Defender custom KQL detection rule detects potential Copilot abuse by threat actors at regular interval.\n\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where IPTags has_any (\"Brute force attacker\", \"Password spray attacker\", \"malicious\", \"Possible Hackers\", \"Tor\")\n| where ActionType == \"CopilotInteraction\" \n\n//Detect token theft via AiTM phishing attack whereby token is then used to conduct copilot activities for data summarization and extraction.\n\nlet AnomalousTokenRequestId=\nSecurityAlert\n| where TimeGenerated \u003e ago(30d)\n| where AlertName == \"Anomalous Token\"\n| mv-expand todynamic(Entities)\n| project Entities\n| extend RequestId = tostring(Entities.RequestId)\n| distinct RequestId;\nlet CopilotClientIP=\nSigninLogs\n| where TimeGenerated \u003e ago(30d)\n| where AppDisplayName contains \"copilot\"\n| distinct IPAddress;\nAADUserRiskEvents\n| where TimeGenerated \u003e ago(30d)\n| where RequestId has_any(AnomalousTokenRequestId)\n| where IpAddress has_any(CopilotClientIP) \n| project TimeGenerated, UserPrincipalName, RiskEventType, RiskLevel, DetectionTimingType, IpAddress, Location\n\n//Detect malicious Copilot external data search via Microsoft Graph Connectors. This detection is useful when your Copilot has external plugin enabled and access external corporate data via plugin through graph connectors.\n\nlet CopilotIPs =\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(30d)\n| where RequestUri contains \"Microsoft365Copilot@communication.microsoft.com\"\n| distinct IPAddress;\nSigninLogs\n| where TimeGenerated \u003e ago(30d)\n| where RiskEventTypes contains \"maliciousIPAddress\" \n| where IPAddress has_any (CopilotIPs)\n\n//Microsoft Defender for Cloud App added the application \"Microsoft Copilot for Microsoft 365\", it will be easier to threat hunt using the activity log or using advance hunting KQL.\n\nCloudAppEvents\n| where Application == \"Microsoft Copilot for Microsoft 365\"\n\n//Identify token theft through AiTM phishing attacks, where stolen tokens are exploited for Copilot activities involving data summarization and extraction from a non-malicious IP. Leverage Sentinel Behavior Analytics to detect initial logins from new ISPs (potentially threat actors) and correlate this IP data with Copilot activities from CloudAppEvents.\n\nlet FirstTimeUserConnectedISPIP =\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(7d)\n// Behaviour Analytics detecting user first time connected to a new ISP\n| where tostring(ActivityInsights.FirstTimeUserConnectedViaISP) == \"True\"\n| where ActivityType == \"LogOn\"\n| where SourceDevice == \"\"          // Non-corporate endpoint\n| where InvestigationPriority \u003e 0   // Suspicious Session\n| project SourceIPAddress;\nCloudAppEvents\n| where ActionType == \"CopilotInteraction\"\n// Correlating copilot activities from the new ISP IP\n| where IPAddress has_any(FirstTimeUserConnectedISPIP)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Initial Access\n// T1078: Valid Accounts - Detecting anomalous token usage and new ISP connections can indicate compromised accounts.\n// Execution\n// T1059: Command and Scripting Interpreter - Copilot interactions can be seen as automated scripting activities.\n// Persistence\n// T1078: Valid Accounts - Persistent access through stolen tokens.\n// Privilege Escalation\n// T1078: Valid Accounts - Using stolen tokens to escalate privileges.\n// Defense Evasion\n// T1078: Valid Accounts - Using valid accounts to evade detection.\n// Credential Access\n// T1550: Use Alternate Authentication Material - Token theft via AiTM phishing attacks.\n// Discovery\n// T1083: File and Directory Discovery - Accessing resources and contexts via Copilot.\n// Collection\n// T1114: Email Collection - Data summarization and extraction activities.\n// Command and Control\n// T1071: Application Layer Protocol - Copilot interactions over application protocols.\n// Exfiltration\n// T1041: Exfiltration Over C2 Channel - Data extraction via Copilot activities."
  },
  {
    "source": "SlimKQL",
    "name": "Mitigating security risks in MCP implementations",
    "query": "// Mitigating security risks in MCP implementations\n\n// https://www.linkedin.com/posts/0x534c_cybersecurity-azuremcp-securitycompliance-activity-7319697806321938432-xRXh?utm_source=share\u0026utm_medium=member_desktop\u0026rcm=ACoAABpDyEoBICouOcdQOH4JkFdMxQhTXfnQe2w\n// https://techcommunity.microsoft.com/blog/microsoft-security-blog/understanding-and-mitigating-security-risks-in-mcp-implementations/4404667\n\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(1h)\n| where ActionType == \"ListeningConnectionCreated\"\n| where LocalPort == 5008\n| where InitiatingProcessCommandLine has \"azure/mcp\""
  },
  {
    "source": "SlimKQL",
    "name": "Monitor Copilot Agent for SharePoint",
    "query": "// https://www.pentestpartners.com/security-blog/exploiting-copilot-ai-for-sharepoint/\n\n// Monitoring excessive prompts, a potential sign of prompt testing.\n\nlet MonitorThreshold = 8;\nCloudAppEvents\n| where Timestamp \u003e ago(1d)\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotPlugin = tostring(CopilotData.AISystemPlugin[0].Id)\n| where CopilotPlugin == \"EnterpriseSearch\"\n| where parse_json(CopilotData)[\"Messages\"][0][\"isPrompt\"] == 'true'\n| extend AccountUPN = UserID\n| summarize PromptCount=count() by AccountUPN\n| where PromptCount \u003e MonitorThreshold"
  },
  {
    "source": "SlimKQL",
    "name": "Monitoring Microsoft 365 Copilot Web Search Queries with DefenderXDR",
    "query": "// Monitoring Microsoft 365 Copilot Web Search Queries with DefenderXDR\n\n// What happens if your Microsoft 365 Copilot user account is compromised and used to exfiltrate data via web search queries? Can you check the queries performed through the compromised Copilot interaction?\n// Microsoft has introduced web search query transparency for Microsoft 365 Copilot, allowing users to see the exact web search queries generated from their prompts. This feature enhances user understanding and prompt improvement by providing visibility into how queries are formed and used. Additionally, admins will gain capabilities for search, audit, and eDiscovery on these web queries.\n// However, you donâ€™t need to use eDiscovery. Instead, you can leverage DefenderXDR Advanced Hunting with the KQL I will share to extract all associated BingWebSearch URLs related to Copilot interactions for forensic investigation.\n\nCloudAppEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotAccessResources = (CopilotData.AccessedResources)\n| extend CopilotAppHost = tostring(CopilotData.AppHost)\n| extend CopilotContexts = tostring(CopilotData.Contexts)\n| extend CopilotType = tostring(CopilotData.Type)\n| extend CopilotMessageIds = tostring(CopilotData.MessageIds)\n| extend CopilotThreadId = tostring(CopilotData.ThreadId)\n| extend CopilotPlugin = tostring(CopilotData.AISystemPlugin)\n| where CopilotPlugin has \"BingWebSearch\" and RawEventData contains \"http://\"\n// Copilot Web Search Url located in CopilotAccessResources\n\n// MITRE ATT\u0026CK Mapping\n// Technique: Exfiltration Over Web Service (T1567)"
  },
  {
    "source": "SlimKQL",
    "name": "Monthly Report Entra Eligible Role Activation",
    "query": "// Monthly Report Entra Eligible Role Activation\n// https://www.linkedin.com/posts/activity-7195656523899965442-aZTj/\n\n// Entra offers an â€œAlert detailâ€ view that monitors whether eligible administrators are activating their privileged roles. However, it lacks a built-in feature to measure the frequency of these activations. To overcome this, you can schedule the following KQL query to run every 30 days. This will generate a report detailing the activation history of eligible administratorsâ€™ roles over a specified timeframe. Itâ€™s important to adhere to the principle of least privilege and revoke any roles that are excessively provisioned and not necessary. ðŸ˜Ž\n\nIdentityInfo\n| where Timestamp \u003e ago(30d)\n| where AssignedRoles != \"\"\n| mv-expand AssignedRoles\n| extend EntraAdminRole = tostring(AssignedRoles)\n| distinct EntraAdminRole, AccountUpn\n| where AccountUpn != \"\"\n| sort by EntraAdminRole asc\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the KQL query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// The query identifies accounts with assigned roles, which can help detect unauthorized or suspicious account usage.\n// T1087 - Account Discovery:\n// By listing distinct roles and associated accounts, the query aids in discovering accounts and their privileges.\n// T1098 - Account Manipulation:\n// Monitoring changes in assigned roles can help detect potential account manipulation activities."
  },
  {
    "source": "SlimKQL",
    "name": "Multi-Cloud DefenderXDR KQL Threat Detection",
    "query": "// Multi-Cloud DefenderXDR KQL Threat Detection\n// https://www.linkedin.com/posts/activity-7198893996356640769-cow0/\n\n// A composite detection using MDCA threat intelligence to hunt for activities in various cloud environments and resources covered by MDC. ðŸ¤¯\n\nlet MaliciousIPs =\nCloudAppEvents\n| where Timestamp \u003e ago(30d)\n| where IPTags has_any (\"Brute force attacker\", \"Password spray attacker\", \"Malicious\", \"Tor\", \"Botnet\", \"Darknet scanning IP\", \"Malware C\u0026C server\") or IPCategory == \"Risky\"\n| distinct IPAddress;\nCloudAuditEvents\n| where Timestamp \u003e ago(30d)\n| where IPAddress has_any(MaliciousIPs)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the activities and tags mentioned, here are the relevant MITRE ATT\u0026CK techniques:\n\n// Brute Force Attacker:\n// T1110: Brute Force - Attempting to gain access to accounts by repeatedly trying different passwords.\n// Password Spray Attacker:\n// T1110.003: Password Spraying - Trying commonly used passwords against many accounts.\n// Malicious IPs (General):\n// T1071: Application Layer Protocol - Using standard application layer protocols to communicate with command and control servers.\n// T1090: Proxy - Using proxies to obscure the origin of malicious traffic.\n// Tor:\n// T1090.003: Multi-hop Proxy - Using multiple proxies to hide the origin of traffic, often associated with Tor.\n// Botnet:\n// T1071.001: Web Protocols - Using web protocols for command and control communication.\n// T1102: Web Service - Using web services for command and control.\n// Darknet Scanning IP:\n// T1046: Network Service Scanning - Scanning for open ports and services on the network.\n// Malware C\u0026C Server:\n// T1071: Application Layer Protocol - Communicating with command and control servers using standard protocols.\n// T1105: Ingress Tool Transfer - Transferring tools or files from an external system into a compromised environment."
  },
  {
    "source": "SlimKQL",
    "name": "NTLMv2 Hash Leak via COM Detection",
    "query": "// NTLMv2 Hash Leak via COM Detection\n// https://medium.com/@andreabocchetti88/ntlmv2-hash-leak-via-com-auto-execution-543919e577cb\n\nlet QueryPeriod = 1h;\nlet UserDeviceLogon =\nDeviceLogonEvents \n| where Timestamp \u003e ago(QueryPeriod)\n| where ActionType == \"LogonSuccess\" and LogonType == \"Interactive\"\n| where parse_json(AdditionalFields)[\"IsLocalLogon\"] == 'true'\n| distinct DeviceName;\nDeviceNetworkEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where RemotePort == \"445\" and RemoteIPType == \"Public\"\n| where ActionType == \"ConnectionSuccess\"\n| where DeviceName has_any (UserDeviceLogon)"
  },
  {
    "source": "SlimKQL",
    "name": "Near real-time (NRT) custom DefenderXDR detection \u0026 isolation for Windows Whatsapp security risk",
    "query": "// Near real-time (NRT) custom DefenderXDR detection \u0026 isolation for Windows Whatsapp security risk\n// https://www.linkedin.com/posts/activity-7222989513491460096-7M9Y/\n\nTrigger \u0026 isolate device: \n\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where InitiatingProcessFileName contains \"WhatsApp.exe\"\n| where FileName endswith \".pyz\" or FileName endswith \".pyzw\" or FileName endswith \".php\"\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1059.007 - Command and Scripting Interpreter: JavaScript/JScript: The detection of file extensions like .pyz and .pyzw suggests the creation of Python-related files, which can be used for scripting and automation1.\n// T1105 - Ingress Tool Transfer: The creation of .php files could indicate the transfer of web shells or other malicious scripts onto the system2.\n// T1071.001 - Application Layer Protocol: Web Protocols: WhatsApp.exe initiating these file creations might indicate the use of web protocols for communication or data transfer3."
  },
  {
    "source": "SlimKQL",
    "name": "New Information Stealer - SamsStealer (By CYFIRMA)",
    "query": "// New Information Stealer - SamsStealer (By CYFIRMA)\n// https://www.linkedin.com/posts/activity-7198215669711052801-kQSk/\n\n// SamsStealer: Unveiling the Information Stealer Targeting Windows Systems\n// Link: https://lnkd.in/gF949sei\n\nlet WebTelegramPC =\nDeviceNetworkEvents \n| where ActionType == @\"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost contains \"web.telegram.org\"\n| distinct DeviceName;\nDeviceEvents\n| where DeviceName has_any(WebTelegramPC)\n| where MD5==\"83f94302ae92909bc3b2834a5342d4a5\" or MD5==\"824e149b9c2bdd5dbe37f472533230af\"\nor MD5==\"1f913f8d71f0f4d65858b5ba0ea94a9c\" or MD5==\"56acc1496d8e5bbc0e412c683971b809\"\nor MD5==\"631eacb4519fd49048491c9b5ec6bda5\" or MD5==\"64410e06f80e75b6503e5525c323243b\"\nor MD5==\"7d63047a48fa8984f11544149c2f0e70\" or MD5==\"da493648ca3b8fd9dbad7bbca659b796\"\nor MD5==\"02fe599ed41cc4bd54a1d6a3cc2d830a\" or MD5==\"cb95c77750732c0a4dd29c1d4feb6f69\"\nor MD5==\"11751f8d847764936b7bf014302da87f\" or MD5==\"31c73ad35b23e4d98ed974e604b85e00\"\n\n// MITRE ATT\u0026CK Mapping\n\n//The KQL query is designed to detect devices connecting to Telegram Web and then filter events based on specific MD5 hashes, which could indicate the presence of known malicious files. The associated MITRE ATT\u0026CK techniques include:\n\n// T1071.001: Application Layer Protocol - Web Protocols\n// T1027: Obfuscated Files or Information\n// T1036.005: Masquerading - Match Legitimate Name or Location\n// T1070.004: Indicator Removal on Host - File Deletion"
  },
  {
    "source": "SlimKQL",
    "name": "New URL File NTLM Hash Disclosure Vulnerability Detection (0day)",
    "query": "// New URL File NTLM Hash Disclosure Vulnerability Detection (0day)\n// https://blog.0patch.com/2024/12/url-file-ntlm-hash-disclosure.html\n// A highly accurate DefenderXDR exposure management detection for URL File NTLM Hash Disclosure Vulnerability (0day):\n\n// 1. NTLM hash presence on endpoint\n// 2. New .LNK file creation\n// 3. NTLM authentication over SMB connection to Internet IP\n\n// Conditions 1 + 2 + 3 =\u003e ðŸ’¥\n\nlet EndpointWithNTLMHash = \nExposureGraphEdges\n| where EdgeLabel == @\"has credentials of\"\n| where EdgeProperties.rawData.ntlmHash.ntlmHash == \"true\"\n// Endpoint with NTLM hash stored\n| distinct SourceNodeName;\nlet DeviceLNKCreation =\nDeviceFileEvents\n| where ActionType == @\"FileCreated\"\n| where FileName endswith \".lnk\"\n| where DeviceName has_any(EndpointWithNTLMHash)\n| distinct DeviceName;\n// Endpoint with NTLM hash and LNK creation\nDeviceNetworkEvents\n// NTLM authentication over SMB connection\n| where RemotePort == \"445\" and RemoteIPType == \"Public\"\n| where ActionType == \"ConnectionSuccess\"\n| where DeviceName has_any (DeviceLNKCreation)"
  },
  {
    "source": "SlimKQL",
    "name": "OAuth App for BEC \u0026 Phishing Detection",
    "query": "// The new OAuthAppInfo table now included in DefenderXDR, enabling SecOps to monitor potential rogue OAuth app activity related to BEC and phishing threats. The custom hourly DefenderXDR detection outlined below ensures comprehensive detection coverage.\n\nOAuthAppInfo\n| where AddedOnTime \u003e ago(1h)\n| where AppOrigin == \"External\"\n| where VerifiedPublisher == \"{}\"\n| where Permissions has \"mail.readwrite\""
  },
  {
    "source": "SlimKQL",
    "name": "OAuth app using the OD file picker permission",
    "query": "// OAuth app using the OD file picker permission\n// https://thehackernews.com/2025/05/microsoft-onedrive-file-picker-flaw.html\n\nOAuthAppInfo\n| where Timestamp \u003e ago(30d) \n| where AppStatus == \"Enabled\"\n| mv-expand Permissions\n| where parse_json(Permissions)[\"TargetAppDisplayName\"] == 'Microsoft Graph'\n| where parse_json(Permissions)[\"PermissionValue\"] == 'MyFiles.Write' or\nparse_json(Permissions)[\"PermissionValue\"] == 'Files.ReadWrite.All' or\nparse_json(Permissions)[\"PermissionValue\"] == 'Sites.ReadWrite.All' or\nparse_json(Permissions)[\"PermissionValue\"] == 'AllSites.Write'"
  },
  {
    "source": "SlimKQL",
    "name": "One-Click ANY RUN Storm-1747 KQL Scan",
    "query": "// One-Click ANY RUN Storm-1747 KQL Scan\n\nlet WeeklyOSINT=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/Storm-1747.csv'];\nlet OSINTSHA256 =\nWeeklyOSINT\n| where Type == \"hash_sha256\"\n| project Value;\nlet OSINTSHA1 =\nWeeklyOSINT\n| where Type == \"hash_sha1\"\n| project Value;\nlet OSINTMD5 =\nWeeklyOSINT\n| where Type == \"hash_md5\"\n| project Value;\nlet OSINTDOMAIN =\nWeeklyOSINT\n| where Type == \"domain\"\n| project Value;\nlet OSINTURL =\nWeeklyOSINT\n| where Type == \"url\"\n| project Value;\nlet OSINTIP =\nWeeklyOSINT\n| where Type == \"ip\"\n| project Value;\nlet ScanEmailAttachments =\nEmailAttachmentInfo\n| where Timestamp \u003e ago(30d)\n| where SHA256 has_any(OSINTSHA256);\nlet ScanEmailURLs =\nEmailUrlInfo\n| where Timestamp \u003e ago(30d)\n| where UrlDomain has_any(OSINTDOMAIN) or Url has_any(OSINTURL);\nlet ScanEndpointFiles =\nDeviceFileEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"FileCreated\"\n| where MD5 has_any(OSINTMD5) or SHA1 has_any(OSINTSHA1) or SHA256 has_any(OSINTSHA256);\nlet ScanEndpointNetwork1 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"ConnectionSuccess\"\n| where RemoteIP has_any (OSINTIP) or RemoteUrl has_any (OSINTDOMAIN);\nlet ScanEndpointNetwork2 =\nDeviceNetworkEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where HttpHost has_any(OSINTDOMAIN);\nunion ScanEmailAttachments, ScanEmailURLs, ScanEndpointFiles, ScanEndpointNetwork1, ScanEndpointNetwork2"
  },
  {
    "source": "SlimKQL",
    "name": "Ottercookie Detection",
    "query": "// https://any.run/cybersecurity-blog/ottercookie-malware-analysis/\n\nlet QueryLookup = 1h;\nlet CompressData =\nDeviceFileEvents\n| where Timestamp \u003e ago(QueryLookup)\n| where ActionType == \"FileCreated\"\n| where InitiatingProcessFileName has \"tar\"\n| distinct DeviceName;\nDeviceNetworkEvents\n| where Timestamp \u003e ago(QueryLookup)\n| where ActionType == \"HttpConnectionInspected\"\n| where parse_json(AdditionalFields)[\"direction\"] == 'Out'\n| where parse_json(AdditionalFields)[\"status_code\"] == '200'\n| extend GeoCtry = tostring(geo_info_from_ip_address(RemoteIP).country)\n| where GeoCtry == \"United States\"\n| where RemotePort == \"1224\"\n| where DeviceName has_any(CompressData)"
  },
  {
    "source": "SlimKQL",
    "name": "Outlook New Requirements for Highâ€Volume Senders",
    "query": "// https://techcommunity.microsoft.com/blog/microsoftdefenderforoffice365blog/strengthening-email-ecosystem-outlook%e2%80%99s-new-requirements-for-high%e2%80%90volume-senders/4399730\n\nEmailEvents\n| where Timestamp \u003e ago(3d) // Enforcement started on 5th May 2025\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Blocked\"\n| where DeliveryLocation == @\"Failed\"\n| where SenderFromAddress == @\"postmaster@outlook.com\"\n| summarize RejectionCount=count() by RecipientEmailAddress // Impacted Users\n| sort by RejectionCount desc"
  },
  {
    "source": "SlimKQL",
    "name": "Overprivileged Admin-Consented OAuth Applications",
    "query": "// Following the principle of least privilege, have you reviewed the permissions granted to your admin-consented OAuth applications? Itâ€™s important to identify applications with permissions that are no longer utilized after being consented. Use the KQL query below to audit and analyze the overprivileged permissions assigned to these applications.\n\nOAuthAppInfo\n| mv-expand Permissions\n| where Permissions.InUse == false\n| where IsAdminConsented == 1\n| where AppStatus == \"Enabled\"\n| summarize UnUsedPermission=count() by AppName,\ntostring(Permissions.TargetAppDisplayName),\ntostring(Permissions.PermissionValue)"
  },
  {
    "source": "SlimKQL",
    "name": "Perimeter Defense - Attack Surface Reduction",
    "query": "// Perimeter Defense - Attack Surface Reduction\n// https://www.linkedin.com/posts/activity-7188046653184991232-JLS6/\n\n// In these days cyberattacks are mostly conducted through email attacks, adversary would spray your tenant and if one of your users who happened to click on the link and with vulnerable endpoint then threat actor would probably start to gain a foothold in your environment. The below KQL checks for your organization top 10 most attack email users and query their corporate endpoints for list of vulnerabilities. I believe if you addressed those critical \u0026 high vulnerabilities of these endpoints, potentially this will help you reduce your attack surface. ðŸ«¡ \n\nlet Top10AttackEmailUsers=\nEmailEvents\n| where Timestamp \u003e ago(30d)\n| where EmailDirection == \"Inbound\" and DeliveryAction == \"Blocked\"\n| summarize Count=count() by RecipientEmailAddress\n| sort by Count desc\n| take 10\n| project RecipientEmailAddress;\nlet Top10AttackUserDevices=\nAADSignInEventsBeta\n| where Timestamp \u003e ago(7d)\n| where DeviceTrustType == \"Azure AD registered\" or DeviceTrustType == \"Hybrid Azure AD joined\"\n| where AccountUpn has_any(Top10AttackEmailUsers)\n| distinct DeviceName;\nDeviceTvmSoftwareVulnerabilities\n| where DeviceName has_any(Top10AttackUserDevices)\n| sort by VulnerabilitySeverityLevel asc \n\n// MITRE ATT\u0026CK Mapping\n\n// T1566: Phishing - The blocked emails likely contain phishing attempts.\n// Top10AttackUserDevices:\n// Purpose: Finds devices associated with the top 10 email recipients from the previous query, focusing on devices that are either Azure AD registered or Hybrid Azure AD joined, within the last 7 days.\n// MITRE ATT\u0026CK Techniques:\n// T1078: Valid Accounts - Identifying devices that might be used by compromised accounts.\n// T1082: System Information Discovery - Gathering information about devices.\n// DeviceTvmSoftwareVulnerabilities:\n// Purpose: Lists software vulnerabilities on the identified devices, sorted by severity.\n// MITRE ATT\u0026CK Techniques:\n// T1203: Exploitation for Client Execution - Exploiting software vulnerabilities.\n// T1190: Exploit Public-Facing Application - Potential exploitation of known vulnerabilities."
  },
  {
    "source": "SlimKQL",
    "name": "Phishing by Design Two-Step Attacks Using vsdx Files",
    "query": "// Phishing by Design: Two-Step Attacks Using .vsdx Files\n\n// A recent blog from Perception Point details a sophisticated phishing attack using Microsoft Visio files hosted on SharePoint. Attackers embed malicious URLs in these files, which are sent via compromised email accounts with attached .eml files. Victims are tricked into clicking these links, leading to fake Microsoft login pages designed to steal credentials. This method leverages trusted platforms to evade detection, highlighting the need for advanced security measures. The Perception Point blog link has been shared in the comment section for awareness.\n// I have crafted a precise KQL using Microsoft Defender for Office 365 and Endpoint to detect such abuse scenarios, helping defenders mitigate the risk of these two-step attacks that leverage trusted platforms to evade detection.  The KQL code can be downloaded from my SlimKQL GitHub Repository, which is featured on my LinkedIn profile. (Search for â€œPhishing by Design Two-Step Attacks Using vsdx Filesâ€)\n\nlet WhiteListSharepointDomain = dynamic([\"XXX.sharepoint.com\"]);\nlet EMLSharepointDomain =\nEmailAttachmentInfo \n| where FileName endswith \".eml\" or FileName endswith \".msg\"\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"Attachment\"\n| extend URLDomain = tostring(parse_url(Url).Host)\n| where URLDomain has \".sharepoint.com\"\n| where not (URLDomain has_any (WhiteListSharepointDomain))\n| distinct URLDomain;\n//Consolidated all external sharepoint domains from all .eml .msg attachment\nDeviceNetworkEvents\n| where ActionType == @\"HttpConnectionInspected\"\n| extend Host = parse_json(AdditionalFields)[\"host\"]\n| extend Direction = parse_json(AdditionalFields)[\"direction\"]\n| where Direction == \"Out\" and Host has_any(EMLSharepointDomain)\n// MDE Endpoint click on external sharepoint links that was embedded in .eml .msg attachment\n\n// T1566.001 - Phishing: Spearphishing Attachment:"
  },
  {
    "source": "SlimKQL",
    "name": "PowerShell Self-Pwn",
    "query": "// PowerShell Self-Pwn\n\n// https://www.proofpoint.com/us/blog/threat-insight/clipboard-compromise-powershell-self-pwn\n// The Proofpoint blog outlines a social engineering tactic where threat actors deceive users into copying and pasting malicious PowerShell scripts, causing malware infections. Groups like TA571 use fake error messages to prompt script execution, delivering malware such as DarkGate and NetSupport. Despite needing significant user interaction, the attack's success hinges on sophisticated social engineering. I have developed a custom detection PowerShell Self-Pwn KQL to identify such scenarios and assist SecOps in isolating affected devices.\n\nlet NaiveUser =\nIdentityInfo\n| where isempty(AssignedRoles) // Non Technical Naive Users ;P\n| summarize arg_max(Timestamp, *) by AccountUpn\n| distinct AccountUpn;\nlet UserEPPSExec =\nDeviceEvents \n| where ActionType == @\"GetClipboardData\" // Execute PowerShell command from clipboard paste\n| where InitiatingProcessFileName == @\"powershell.exe\"\n| join NaiveUser on $left.InitiatingProcessAccountUpn == $right.AccountUpn\n| distinct DeviceName;\nDeviceProcessEvents\n| where InitiatingProcessFileName has \"powershell.exe\" and InitiatingProcessCommandLine has \"-EncodedCommand\"\n| where AccountName != \"system\" and AccountName !=\"local service\" and AccountName !=\"administrator\"\n| where DeviceName has_any(UserEPPSExec) // User execute a encoded powershell command to evade detection\n\n\n//"
  },
  {
    "source": "SlimKQL",
    "name": "RID Hijacking Technique and Detection",
    "query": "// RID Hijacking Technique and Detection\n\n// https://asec.ahnlab.com/en/85942/\n\nlet EPwithNewLocalAccount =\nDeviceEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == \"UserAccountCreated\" and AccountName has \"$\"\n| distinct DeviceName;\nDeviceRegistryEvents\n| where RegistryKey has \"HKEY_LOCAL_MACHINE\\\\SAM\\\\SAM\\\\Domains\\\\Account\\\\Users\"\n| where DeviceName has_any(EPwithNewLocalAccount)"
  },
  {
    "source": "SlimKQL",
    "name": "Remote code execution exploit chain in OpenVPN",
    "query": "// Remote code execution exploit chain in OpenVPN\n\n// CVE-2024-24974, CVE-2024-27903, CVE-2024-27459, and CVE-2024-1305 are four vulnerabilities affecting OpenVPN prior to version 2.6.10. A threat actor could exploit these vulnerabilities to launch arbitrary code with SYSTEM privileges in kernel mode on a target system running a vulnerable version of OpenVPN. Many VPN services, network hardware, and other VPN software implement the open-source OpenVPN system. These services include ExpressVPN, NordVPN, Surfshark, ProtonVPN, and tunnelblick. All implementations of OpenVPN prior to version 2.6.10 are affected by these vulnerabilities, including downstream software and hardware.\n\n// KQL to check DeviceTvmSoftwareInventory for any impacted endpoints:\n\nDeviceTvmSoftwareInventory \n| where SoftwareVendor contains \"vpn\" \nor SoftwareVendor contains \"Surfshark\"\nor SoftwareVendor contains \"tunnelblick\"\n\n// MITRE ATT\u0026CK Mapping\n\n// The query focuses on detecting VPN software, which can be associated with several MITRE ATT\u0026CK techniques, particularly those related to Defense Evasion and Command and Control. Here are some relevant techniques:\n\n// T1070.004 - Indicator Removal on Host: File Deletion\n// VPN software can be used to hide network traffic, making it harder to detect malicious activities.\n// T1090 - Proxy\n// VPNs are often used to route traffic through intermediary servers to obfuscate the origin of the traffic.\n// T1573 - Encrypted Channel\n// VPNs encrypt traffic, which can be used to secure communications and evade network monitoring.\n// T1568 - Dynamic Resolution\n// VPN services may use dynamic DNS to manage their infrastructure, which can be leveraged by attackers to evade detection."
  },
  {
    "source": "SlimKQL",
    "name": "SAP NetWeaver Attack by Chinese Threat Actor Impact Assessment",
    "query": "// SAP NetWeaver Attack by Chinese Threat Actor Impact Assessment\n// https://www.forescout.com/blog/threat-analysis-sap-vulnerability-exploited-in-the-wild-by-chinese-threat-actor/\n\nlet InternetFacing =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nlet SAPNetweaver =\nDeviceProcessEvents\n| where TimeGenerated \u003e ago(90d)\n| where InitiatingProcessVersionInfoProductName has \"netweaver\"\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where DeviceId has_any(InternetFacing);\nlet ForescoutIOC=externaldata(Type:string, Value:string, Source:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/Chaya_004-IOC10May2025.csv'];\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(30d)\n| join ForescoutIOC on $left.RemoteIP == $right.Value\n| where ActionType has \"ConnectionSuccess\" or ActionType has \"InboundConnectionAccepted\"\n| where DeviceId has_any(SAPNetweaver)\n| summarize NoOfHits=count() by DeviceName, ActionType, RemoteIP\n| sort by NoOfHits desc"
  },
  {
    "source": "SlimKQL",
    "name": "Seashell Blizzard (IRIDIUM) - PWS:Win64-HighCount",
    "query": "// Seashell Blizzard (IRIDIUM) - PWS:Win64-HighCount\n// https://www.linkedin.com/posts/activity-7198555614627651584-z6C7/\n\n// Seashell Blizzard (IRIDIUM) is high-impact threat actor linked to the Russian Federation and conducts global activities on behalf of Russian Military Intelligence Unit 74455 (GRU). Below are some KQL detections to complement the Threat Analytics Report.\n\n// Persistance KQL Detection:\n\nDeviceRegistryEvents \n| where ActionType == @\"RegistryKeyCreated\"\n| where RegistryValueData contains \"win32msa.exe\"\n\n\n// PWS:Win64/HighCount KQL Detection:\n\nDeviceFileEvents \n| where SHA256 == \"e62e418ffa87fdcfe14125ab8b429cb9d91a07088e13cd15423bd084c713564e\" or FileName == \"win32msa.exe\"\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Registry Key Creation Detection: Maps to T1547.001.\n// File Event Detection: Maps to T1036.005."
  },
  {
    "source": "SlimKQL",
    "name": "Securing Your Azure Cloud - Finding the Weakest Link in Admin Endpoints",
    "query": "// Securing Your Azure Cloud: Finding the Weakest Link in Admin Endpoints\n\n// Who holds the key vault secrets to your Azure cloud? Are you aware of any critical vulnerabilities in these cloud admin endpoints? By running the DefenderXDR Exposure Management KQL below, you can identify your Azure Admin's weakest link, highlighting the most critical vulnerabilities and their susceptibility to external attacks and compromises.\n\nlet AzureAdminWithKeyVaultAccess =\nExposureGraphEdges\n| where SourceNodeLabel == \"user\" \n| where EdgeLabel == \"has permissions to\"\n| where TargetNodeLabel == \"microsoft.keyvault/vaults\"\n| where parse_json(TargetNodeCategories)[0] == 'secret'\n| distinct SourceNodeName;\nlet AzureAdminEP=\nExposureGraphEdges\n| where EdgeLabel == \"frequently logged in by\"\n| where TargetNodeName has_any(AzureAdminWithKeyVaultAccess)\n| distinct SourceNodeName;\nExposureGraphNodes  \n| where NodeLabel == \"Cve\"\n| extend Severity = tostring(NodeProperties.rawData.severity)\n| where Severity == \"Critical\"\n| join ExposureGraphEdges on $left.NodeId == $right.SourceNodeId\n| where TargetNodeName has_any(AzureAdminEP)"
  },
  {
    "source": "SlimKQL",
    "name": "Sneaky 2FA MDO Detection",
    "query": "// Sneaky 2FA MDO Detection\n// https://blog.sekoia.io/sneaky-2fa-exposing-a-new-aitm-phishing-as-a-service/\n\nlet Sneaky2FATable=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/Sneaky2FA.txt']\n| parse RawData with Sneaky2FADomains:string;\nlet IOCs =\nSneaky2FATable\n| distinct Sneaky2FADomains;\nlet InboundEmailReceipient =\nEmailUrlInfo\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| distinct RecipientEmailAddress;\nlet InboundEncodedEmailReceipient =\nEmailUrlInfo\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| extend EncodeEmail = base64_encode_tostring(RecipientEmailAddress)\n| distinct EncodeEmail;\nEmailUrlInfo\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| where Url has_any(IOCs) and (Url has_any(InboundEmailReceipient) or Url has_any(InboundEncodedEmailReceipient))"
  },
  {
    "source": "SlimKQL",
    "name": "Sniffing Out UNC3944 on Teams",
    "query": "// Spidey Senses Tingling: Sniffing Out UNC3944 on Teams\n\nlet M365Domains =\nIdentityInfo\n| summarize arg_max(Timestamp, *) by AccountUpn\n| where isnotempty(AccountDomain)\n| distinct tolower(AccountDomain);\nlet MonitorDomainKeyword =dynamic([\"connect\",\"corp\",\"duo\",\"help\",\"he1p\",\"helpdesk\",\n\"helpnow\",\"info\",\"internal\",\"mfa\",\"my\",\"okta\",\"onelogin\",\"schedule\",\"service\",\"servicedesk\",\"servicenow\",\n\"rci\",\"rsa\",\"sso\",\"ssp\",\"support\",\"usa\",\"vpn\",\"work\",\"dev\",\"workspace\",\"it\",\"ops\"]);\nMessageEvents\n| where Timestamp \u003e ago(1h)\n| join MessageUrlInfo on TeamsMessageId\n| extend SenderDomain = tolower(tostring(split(SenderEmailAddress, '@')[1]))\n| where not(SenderDomain has_any(M365Domains))        // External Teams Inbound Message Detected\n| where SenderDomain has_any(MonitorDomainKeyword)    // Check domain keyword match for Scattered Spider TTPs"
  },
  {
    "source": "SlimKQL",
    "name": "Social Engineering Attack Detection",
    "query": "// Social Engineering Attack (Mail Bomb followed by Social Engineered Call - Initial access via RMM Tool)\n// https://admin.microsoft.com/?ref=MessageCenter/:/messages/MC1096885\n\nlet MailBombVictim =\nEmailEvents\n| where TimeGenerated \u003e ago(1h)\n| where isnotempty(DetectionMethods)\n| where tostring(DetectionMethods) has \"Mail Bombing\"\n| distinct RecipientEmailAddress;\nlet ApprovedRMM = dynamic(\"bomgarcloud.com\"); // E.g Approved Corporate RMM - Whitelisting\nlet RMMList=externaldata(URI: string, RMMTool: string) // Lookup list of RMM Tools Url from Microsoft\n[h'https://raw.githubusercontent.com/jischell-msft/RemoteManagementMonitoringTools/refs/heads/main/Network%20Indicators/RMM_SummaryNetworkURI.csv'];\nlet RMMUrl =\nRMMList\n| project URI;\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(1h)\n| where ActionType == @\"ConnectionSuccess\"\n| where RemoteUrl has_any(RMMUrl)\n| where not (RemoteUrl has_any(ApprovedRMM)) // Unauthorized Outbound RMM Tool Connection\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where InitiatingProcessAccountUpn has_any(MailBombVictim) // RMM Tool Connection made by Mail Bomb Victim"
  },
  {
    "source": "SlimKQL",
    "name": "Social Engineering Attack Monitor - Teams \u0026 Emails",
    "query": "// Social Engineering Attack Monitor - Teams \u0026 Emails\n\n// Yesterday, Kevin Beaumont (known as the \"Cyber Weatherman\") shared his experience assisting several organizations in recovering from successful ransomware attacks. A common thread in these incidents was the use of social engineering tactics. Attackers conducted initial reconnaissance over the phone to gather contact details, then bombarded users with a flood of emails and Teams messagesâ€”sometimes thousands per hour. The custom KQL detection script below for DefenderXDR can provide early warnings of this type of social engineering attack.\n\n// External Teams Tenant Spray Monitor\n\nlet TeamsTriggerThreshold = 5;\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where Application == @\"Microsoft Teams\"\n| where ActionType == @\"MessageSent\"\n| where AccountDisplayName has \"@\"\n| where tostring(UncommonForUser) != \"[]\"\n| extend ExternalTeamsTenantID = tostring(parse_json(RawEventData)[\"UserTenantId\"])\n| where isnotempty(ExternalTeamsTenantID)\n| summarize Count=count() by ExternalTeamsTenantID\n| where Count \u003e TeamsTriggerThreshold\n\n// External Inbound Email Spray Monitor\n\nlet EmailTriggerThreshold = 150;\nEmailEvents\n| where Timestamp \u003e ago(1h)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Delivered\"\n| summarize Count=count() by SenderFromAddress\n| where Count \u003e EmailTriggerThreshold\n\n// Mitre ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Suspicious CLI Obfuscation",
    "query": "// Goal is to catch powershell and bash obfuscation techniques. Mostly powershell.\n// If the intention is to use this as a detection, it will most likely need tuned to your environment but it has been succesful in mine though multiple tests.\n// If you have questions or reccomendations, please email me at eatinsundip@ccaves.net\n\nDeviceProcessEvents\n| where ProcessCommandLine matches regex @\"'[^']+'\\s*\\+\\s*'[^']+'\" or //Checking for 'A'+'B' style obfuscation\n    ProcessCommandLine matches regex @'\"[^\"]+\"\\s*\\+\\s*\"[^\"]+\"' or //Checking for \"A\"+\"B\" style obfuscation\n    ProcessCommandLine matches regex @\".Replace\\s*\\(\" // Checking for .replace obfuscation\n| project Timestamp, AccountName, InitiatingProcessFileName, ProcessCommandLine, DeviceId, ReportId\n| sort by Timestamp desc"
  },
  {
    "source": "SlimKQL",
    "name": "Suspicious MSHTA Usage",
    "query": "// I have found in the various environments I have been in that mshta in the modern world is far and few between. \n// More often than not, it is used for malicious activity over odd edge cases.\n// Edge cases can be tuned out and this could become an effective detection for most environments.\n\nDeviceProcessEvents\n| where ProcessCommandLine contains \"mshta.exe\"\n| project Timestamp, AccountName, InitiatingProcessFileName, ProcessCommandLine, DeviceId, ReportId\n| sort by Timestamp desc"
  },
  {
    "source": "SlimKQL",
    "name": "Suspicious OAuth applications used to retrieve and send emails",
    "query": "// Suspicious OAuth applications used to retrieve and send emails\n// https://security.microsoft.com/threatanalytics3/ba008625-320a-4c71-b996-977049575144/analystreport\n\nlet MonitoredScope = dynamic([\"Files.ReadWrite\",\"IMAP.AccessAsUser.All\",\"Mail.Read\",\"Mail.ReadBasic\",\"Mail.ReadWrite\",\"Mail.Send\",\"POP.AccessAsUser.All\",\"SMTP.Send\",\"User.Read\"]);\nOAuthAppInfo\n| where AddedOnTime \u003e ago(1h)\n| where AppOrigin == \"External\"\n| where VerifiedPublisher == \"{}\"\n| where Permissions has_any(MonitoredScope)"
  },
  {
    "source": "SlimKQL",
    "name": "Sysinternals Tools Zero Day Vulnerability Detection",
    "query": "// Sysinternals Tools Zero Day Vulnerability Detection\n\n// https://www.foto-video-it.de/2025/allgemein/disclosure-sysinternals/\n\nlet SysinternalsTools=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/SysinternalsTools.txt']\n| parse RawData with BinariesName:string;\nlet SysinternalsToolsBinaries =\nSysinternalsTools\n| project BinariesName;\nlet SuspiciousSysInternalsEP =\nDeviceEvents\n| where FolderPath startswith \"\\\\\\\\\"\n| where FileName has_any(SysinternalsToolsBinaries)\n| distinct DeviceName;\nDeviceEvents\n| where ActionType == @\"DriverLoad\"\n| where FileName endswith \".dll\"\n| where FolderPath startswith \"\\\\\\\\\"\n| where DeviceName has_any(SuspiciousSysInternalsEP)"
  },
  {
    "source": "SlimKQL",
    "name": "TA4557 drops More_Eggs",
    "query": "// TA4557 drops More_Eggs\n// https://www.proofpoint.com/au/blog/threat-insight/security-brief-ta4557-targets-recruiters-directly-email\n\nlet MonitoredCommands = dynamic([\"ie4uinit\",\"ie4uinit.exe\"]);\nDeviceEvents\n| where Timestamp \u003e ago(1hr)\n| where ActionType == \"ShellLinkCreateFileEvent\"\n| where tostring(AdditionalFields) contains \"ShellLink\"\n| where parse_json(AdditionalFields)[\"ShellLinkShowCommand\"] != 'SW_SHOWNORMAL'\n| extend ShellLinkCommandLine = parse_json(AdditionalFields)[\"ShellLinkCommandLine\"]\n| extend ShellLinkIconPath = parse_json(AdditionalFields)[\"ShellLinkIconPath\"]\n| where ShellLinkCommandLine != \"\"\n| where ShellLinkCommandLine has_any (MonitoredCommands)"
  },
  {
    "source": "SlimKQL",
    "name": "Technique profile eDiscovery misuse detection",
    "query": "// Technique profile eDiscovery misuse detection\n\n// Microsoft has recently identified multiple threat actors exploiting the eDiscovery feature, particularly targeting email data. When misused, this feature allows threat actors to swiftly export emails and other data from Microsoft services like OneDrive, SharePoint, and Teams. This enables them to analyze the data later without the risk of losing access prematurely. Although the methods of misuse can vary, organizations should vigilantly monitor eDiscovery for potential exfiltration activities. The Threat Analytics Report provided KQL detections cover standard eDiscovery activity detection via Microsoft DefenderXDR. My enhanced detections below incorporate CloudApp UEBA for more precise identification of suspicious eDiscovery activities.\n\n// Threat Analytics Report (Technique Profile: eDiscovery misuse)\n// Link: https://security.microsoft.com/threatanalytics3/28a90de8-bd26-4aa5-8597-acdffdebaeb0/analystreport\n\nlet eDiscoveryActions = pack_array(\"SearchStarted\", \"SearchExported\", \"SearchReport\", \n\"SearchResultExported\", \"SearchResultDownloaded\",\"PreviewItemDownloaded\");\nlet UEBADetection = dynamic([\"ActionType\", \"CountryCode\", \"ISP\", \"OSPlatform\", \"UserAgent\"]);\nCloudAppEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType in (eDiscoveryActions)\n| where UncommonForUser has_any (UEBADetection)\n\n// MITRE ATT\u0026CK\n// Exfiltration Over Web Service (T1567)"
  },
  {
    "source": "SlimKQL",
    "name": "The Hunt for QR Phisher",
    "query": "// The Hunt for QR Phisher\n// https://www.linkedin.com/posts/0x534c_defenderxdr-qrcode-phishing-activity-7180838667928678400-72U-/\n\n// 1. Determine the most frequently used QR-Code for phishing\n\nEmailEvents\n| where Timestamp \u003e ago(30d)\n| where EmailDirection == \"Inbound\"\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"QRCode\"\n| where LatestDeliveryAction == \"Blocked\"\n| where ThreatTypes contains \"phish\"\n| summarize Count=count() by UrlDomain\n| sort by Count desc\n\n// 2. Determine the mail domains or IP addresses associated with QR Phisher\n\nEmailEvents\n| where Timestamp \u003e ago(30d)\n| where EmailDirection == \"Inbound\"\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"QRCode\"\n| where LatestDeliveryAction == \"Blocked\"\n| where ThreatTypes contains \"phish\"\n| where UrlDomain contains \"wap.lovetothenations.org\"\n| distinct SenderMailFromDomain\n\n// Visualize QR-Phishing Attack with ADX Interactive Map\n\nEmailEvents\n| where Timestamp \u003e ago(30d)\n| where EmailDirection == \"Inbound\"\n| join EmailUrlInfo on NetworkMessageId\n| where UrlLocation == \"QRCode\"\n| where LatestDeliveryAction == \"Blocked\"\n| where ThreatTypes contains \"phish\"\n| project SenderIPv4 \n\n//From ADX (Azure Data Explorer) import the IPaddress.csv into a newly created Table called QRPhish, run the below KQL query\n\nQRPhish\n| extend ip_location=geo_info_from_ip_address(SenderIPv4)\n| parse ip_location with \"latitude\\\":\" latitude \",\\\"longitude\\\":\" longitude \"}\" blank\n\n// Hunting for QR Code AiTM Phishing\n\nlet AnomalousTokenRequestId=\nSecurityAlert\n| where AlertName == \"Anomalous Token\"\n| mv-expand todynamic(Entities)\n| project Entities\n| extend RequestId = tostring(Entities.RequestId)\n| distinct RequestId;\nlet UPNAnomalousToken=\nAADUserRiskEvents\n| where RequestId has_any(AnomalousTokenRequestId)\n| where DetectionTimingType == \"realtime\"\n| where RiskLevel == \"medium\" or RiskLevel == \"high\"\n| where RiskState == \"atRisk\"\n| distinct UserPrincipalName;\nEmailUrlInfo\n| where UrlLocation == \"QRCode\"\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| where RecipientEmailAddress has_any(UPNAnomalousToken)\n\n// MITRE ATT\u0026CK Mapping\n\n// T1566.002: Phishing: Spearphishing Link\n// T1204.001: User Execution: Malicious Link\n// T1590.005: Gather Victim Network Information: IP Addresses\n// T1592.001: Gather Victim Host Information: IP Address\n// T1071.001: Application Layer Protocol: Web Protocols\n// T1589.002: Gather Victim Network Information: Email Addresses\n// T1078.003: Valid Accounts: Cloud Accounts"
  },
  {
    "source": "SlimKQL",
    "name": "The Hunt for Top 10 Self Hosted AI",
    "query": "// The Hunt for Top 10 Self Hosted AI\n\n// https://www.wiz.io/state-of-ai-in-the-cloud\n\nlet Top10AIModels = dynamic([\"BERT\",\"DistilBERT\",\"RoBERTa\",\"T5\",\"Llama\",\"MPNet\",\"GPT-2\",\n\"XLM-RoBERTa\",\"CLIP\",\"BART\",\"Mistral\",\"DeBERTa-v2\",\"Qwen2\"]);\nlet LLM_ModelName =\nExposureGraphNodes\n| where NodeLabel == \"baseModel\"\n| extend ModelName = parse_json(NodeProperties)[\"rawData\"][\"aiModelMetadata\"][\"modelName\"]\n| where ModelName has_any(Top10AIModels)\n| project ModelName;\nDeviceFileEvents\n| where Timestamp \u003e ago (30d)\n| where InitiatingProcessVersionInfoFileDescription has_any (LLM_ModelName) \nor InitiatingProcessFolderPath has_any (LLM_ModelName)\nor InitiatingProcessFileName has_any (LLM_ModelName)\nor InitiatingProcessVersionInfoFileDescription has_any (Top10AIModels) \nor InitiatingProcessFolderPath has_any (Top10AIModels)\nor InitiatingProcessFileName has_any (Top10AIModels)"
  },
  {
    "source": "SlimKQL",
    "name": "Threat Hunting - MDE Network Intrusion Discovery",
    "query": "// Threat Hunting - MDE Network Intrusion Discovery\n\n// Did you know that if your Microsoft Defender for Endpoint (MDE) endpoints have the endpoint firewall enabled, you can use its telemetry data to identify potential rogue hosts in your network? During the WannaCry outbreak, I used to deploy honeypots to detect infected machines via port 445 connectivity, allowing me to trace back to the source of infection.\n// With the MDE endpoint firewall enabled, any inbound firewall connection block is logged as ActionType == \"FirewallInboundConnectionBlocked\" in the DeviceEvents schema. Using this data, you can create a query to summarize the number of TargetDevices and local TargetPorts that blocked each RemoteIP. By sorting the TargetDevices and TargetPorts in descending order, you can identify the top RemoteIPs with the highest number of blocks. These RemoteIPs likely indicate port scanning activity, which warrants further investigation by your SecOps team to determine the function of the host at the RemoteIP.\n\nDeviceEvents\n| where Timestamp \u003e ago(30d)\n| where ActionType == @\"FirewallInboundConnectionBlocked\"\n| summarize TargetDevice=dcount(DeviceName), TargetPort=dcount(LocalPort) by RemoteIP\n| where TargetDevice \u003e 20\n| where TargetPort \u003e 10\n| sort by TargetDevice, TargetPort desc \n\n// MITRE ATT\u0026CK MAPPING\n// T1049 - System Network Connections Discovery\n// T1071 - Application Layer Protocol\n// T1133 - External Remote Services"
  },
  {
    "source": "SlimKQL",
    "name": "Threat Hunting BYOVD Scenarios",
    "query": "// Threat Hunting BYOVD Scenarios\n\n// This query identifies recently created driver files on an endpoint with low global prevalence. It then cross-references these files with Windows Event ID 3004, where Windows Code Integrity validates the digital signature of kernel-mode drivers during memory loading. This detection can potentially highlight BYOVD (Bring Your Own Vulnerable Driver) scenarios.\n\nlet DriverwithLowPrevalence =\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName endswith \".sys\"\n| invoke FileProfile(SHA1,1000)\n| where GlobalPrevalence \u003c= 150 or isempty(GlobalPrevalence)\n| join kind=leftouter DeviceFileCertificateInfo on SHA1\n| project FileName;\nDeviceEvents\n// Event ID 3004 â€” Kernel-mode Driver Validation\n| where ReportId == \"3004\"\n| where ActionType == @\"DriverLoad\"\n| where FileName has_any(DriverwithLowPrevalence)\n\n\n// #DefenderXDR #MDE #BYOVD #ThreatHunting #FileProfile #KQL\n\n// MITRE ATT\u0026CK Mapping\n\n// Initial Access:\n// Technique: T1190 (Exploit Public-Facing Application)\n// The query may help detect exploitation attempts against public-facing applications.\n// Technique: T1566.001 (Phishing: Spearphishing Attachment)\n// The query could be relevant for detecting malicious attachments in spear-phishing emails.\n// Execution:\n// Technique: T1047 (Windows Management Instrumentation)\n// The query involves using WMI for remote command execution.\n// Persistence:\n// Technique: T1136.001 (Create Account: Local Account)\n// The query identifies local account creations.\n// Defense Evasion:\n// Technique: T1556 (Modify Authentication Process)\n// The query may be related to conditional access policy changes."
  },
  {
    "source": "SlimKQL",
    "name": "Threat Hunting with MDE Device Discovery and SeenBy Enrichment Function",
    "query": "// Threat Hunting with MDE Device Discovery and SeenBy() Enrichment Function\n\n// Devices discovered but not onboarded and secured by Defender for Endpoint are listed in the device inventory. You can use KQL to query these non-onboarded endpoints and leverage the SeenBy() enrichment function to identify which MDE endpoints have detected these devices in the private network. The IP addresses of non-onboarded devices are then cross-referenced against the AlertEvidence and BehaviourEntities schemasâ€™ LocalIP fields to check for any associated security alerts. If a detection rule is triggered, SecOps should promptly locate and remove the device from the network.\n\nlet SuspiciousDeviceIPs =\nDeviceInfo\n| summarize arg_max(Timestamp, *) by DeviceId\n| where isempty(MergedToDeviceId)\n| where OnboardingStatus != \"Onboarded\"\n| where DeviceCategory == \"Endpoint\" and DeviceType == \"Workstation\" and DeviceName == \"\"\n| join DeviceNetworkInfo on DeviceId\n| extend UnidentifiedDeviceIP = tostring(parse_json(IPAddresses)[0].IPAddress)\n| invoke SeenBy()\n| mv-expand parse_json(SeenBy)\n| extend SeenByDeviceID = SeenBy.DeviceId\n| project DeviceId, OSPlatform, OSBuild, OSVersion, MacAddress, UnidentifiedDeviceIP, SeenByDeviceID\n| distinct UnidentifiedDeviceIP;\nsearch in (AlertEvidence, BehaviorEntities)\nTimestamp between (ago(7d) .. now())\nand (\nLocalIP has_any(SuspiciousDeviceIPs)\n)\n\n// MITRE ATT\u0026CK Mapping\n\n// Initial Access:\n// T1078.004: Valid Accounts - The query checks for devices that are not onboarded, which could indicate unauthorized access.\n// Discovery:\n// T1082: System Information Discovery - Gathering information about the deviceâ€™s OS, build, version, and MAC address.\n// T1016: System Network Configuration Discovery - Extracting network information and IP addresses.\n// Lateral Movement:\n// T1021: Remote Services - The SeenBy() function indicates devices that have seen the suspicious device, which could be used for lateral movement detection.\n// Defense Evasion:\n// T1070: Indicator Removal on Host - Devices with no name and not onboarded might be trying to evade detection.\n//Command and Control:\n// T1071: Application Layer Protocol - The query looks for network activity involving suspicious IPs, which could be used for command and control."
  },
  {
    "source": "SlimKQL",
    "name": "Threat hunting voice phishing for Teams",
    "query": "//Threat hunting voice phishing for Teams\n//https://www.linkedin.com/feed/update/urn:li:activity:7168258404447186945/\n\n//Threat hunting voice phishing ðŸ‘„ðŸŸ (or \"vishing\") with Copilot ðŸ¤– for Microsoft 365 (Mitre Technique T1598.004)\n\n//Download your Teams PSTN usage report and open your report with Copilot Excel. Enter the prompt:\n//Which \"caller number\" appear the most time with different unique \"Display Name\" where the \"Call Direction\" is inbound and \"Success\" is No ?\n\n//As shown below (right side), Copilot identified the vishing number \"XXXXXXX2650\" with distinct count of 23 times. Most of these calls will be ended up in voicemail and transcript as email voice email back to the user.\n\n//To validate Copilot identified the correct vishing number \"XXXXXXX2650\", in DefenderXDR Advanced Hunting run the below KQL:\nEmailEvents\n| where SenderMailFromAddress contains \"noreply_skype_voicemail\"\n| where SenderFromAddress !contains \"@\"\n| where SenderFromAddress contains \"XXXXXXX2650\"\n| project SenderFromAddress, Subject\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the filtering criteria, this query is likely aimed at detecting phishing or suspicious email activities. Here are the relevant MITRE ATT\u0026CK techniques:\n\n// Phishing (T1566):\n// T1566.001: Spearphishing Attachment - The query looks for specific patterns in email addresses that could indicate phishing attempts.\n// T1566.002: Spearphishing Link - The absence of â€œ@â€ in the senderâ€™s address and the presence of specific patterns might indicate attempts to deceive recipients.\n// Command and Control (T1071):\n// T1071.003: Application Layer Protocol - The use of email as a communication channel for malicious activities.\n// Credential Access (T1110):\n// T1110.001: Password Guessing - The query might help identify attempts to use compromised email accounts."
  },
  {
    "source": "SlimKQL",
    "name": "Tracking The Most Dangerous Entra Admin Role",
    "query": "// Tracking The Most Dangerous Entra Admin Role \n// https://www.linkedin.com/posts/activity-7189502682628349952-Uc9z/\n\n// Custom DefenderXDR KQL detecting this dangerous role activation: \n\nlet DangerousAdmin =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| extend AccountUPN = NodeProperties.rawData.accountUpn\n| extend AdminRoles = NodeProperties.rawData.assignedRoles\n| where AdminRoles contains \"Partner Tier2 Support\"\n| project AccountUPN;\nIdentityLogonEvents\n| where AccountUpn has_any(DangerousAdmin)\n\n// MITRE ATT\u0026CK Mapping\n\n// T1078.004: Valid Accounts: Cloud Accounts - Identifying and monitoring privileged accounts in cloud environments.\n// T1078: Valid Accounts - Monitoring logon events for suspicious activity.\n// T1078.001: Valid Accounts: Domain Accounts - Tracking logon events for domain accounts."
  },
  {
    "source": "SlimKQL",
    "name": "UNIT42 - Abuse Microsoft OneNote files on the rise",
    "query": "// UNIT42 - Abuse Microsoft OneNote files on the rise\n// https://www.linkedin.com/posts/activity-7199081015439495168-zjvc/\n\n// Analyzing onenote files sent into your tenant as email attachment.\n\nEmailAttachmentInfo\n| where TimeGenerated \u003e ago(90d)\n| where FileType==\"one;onenote\"\n| join EmailEvents on NetworkMessageId\n\n// MITRE ATT\u0026CK Mapping\n\n// T1566.001 - Phishing: Spearphishing Attachment:\n// This technique involves adversaries sending emails with malicious attachments to gain access to victim systems. Your query filters for specific file types in email attachments, which can be used to detect spearphishing attempts.\n// T1071.003 - Application Layer Protocol: Mail Protocols:\n// This technique involves using email protocols for command and control. By joining email events, your query can help identify suspicious email activities that might be part of a command and control operation.\n// T1114.002 - Email Collection: Remote Email Collection:\n// This technique involves adversaries collecting emails from remote servers. Your query can help detect unusual email attachment activities that might indicate email collection efforts."
  },
  {
    "source": "SlimKQL",
    "name": "Vulnerability Profile: CVE-2024-30040 (Zero-day)",
    "query": "// Vulnerability Profile: CVE-2024-30040 (Zero-day)\n// https://www.linkedin.com/posts/activity-7196377520647090178-Ya18/\n\n// CVE-2024-30040 is a security feature bypass zero-day vulnerability affecting Microsoft 365 and Office apps which is actively exploited. Using DefenderXDR Exposure Management to determine the list of devices accessible by critical identities holding highly privilege roles and that the devices are also vulnerable to CVE-2024-30040. As critical identities are part of your organization attack surface areas holding keys to your tenant, plugging this hole significantly reduce your organization risk against the Zero-Day exploits.\n\n// Exposure Management KQL:\n\nlet CriticalIdentities =\nExposureGraphNodes\n| where set_has_element(Categories, \"identity\")\n| where isnotnull(NodeProperties.rawData.criticalityLevel) and\nNodeProperties.rawData.criticalityLevel.criticalityLevel \u003c 4 \n| distinct NodeName;\nlet CriticalDevices =\nExposureGraphEdges \n| where EdgeLabel == @\"can authenticate to\"\n| join ExposureGraphNodes on $left.TargetNodeId==$right.NodeId\n| extend DName = tostring(NodeProperties.rawData.deviceName)\n| extend isLocalAdmin = EdgeProperties.rawData.userRightsOnDevice.isLocalAdmin\n| where SourceNodeName has_any (CriticalIdentities)\n| distinct DName;\nDeviceTvmSoftwareVulnerabilities \n| where CveId == \"CVE-2024-30040\"\n| where DeviceName has_any (CriticalDevices)\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL code is designed to identify critical identities and devices, and then find vulnerabilities in those devices. The associated MITRE ATT\u0026CK techniques include:\n\n// T1078: Valid Accounts\n// T1078.001: Valid Accounts: Local Accounts\n// T1078.003: Valid Accounts: Local Administrator Accounts\n// T1190: Exploit Public-Facing Application\n// T1210: Exploitation of Remote Services"
  },
  {
    "source": "SlimKQL",
    "name": "ZDI-CAN-25373 Windows Shortcut Exploit Abused Detection",
    "query": "// https://www.trendmicro.com/en_us/research/25/c/windows-shortcut-zero-day-exploit.html\n\nlet MonitoredCommands = dynamic([\"cmd\",\"powershell\"]);\nDeviceEvents\n| where Timestamp \u003e ago(1h)\n| where ActionType == \"ShellLinkCreateFileEvent\"\n| where tostring(AdditionalFields) contains \"ShellLink\"\n| where parse_json(AdditionalFields)[\"ShellLinkShowCommand\"] != 'SW_SHOWNORMAL'\n| extend ShellLinkCommandLine = parse_json(AdditionalFields)[\"ShellLinkCommandLine\"]\n| extend ShellLinkIconPath = parse_json(AdditionalFields)[\"ShellLinkIconPath\"]\n| where ShellLinkCommandLine != \"\"\n| where ShellLinkCommandLine has_any (MonitoredCommands)"
  },
  {
    "source": "SlimKQL",
    "name": "defendnot detection",
    "query": "// https://emsroute.com/2025/05/23/why-defendnot-is-a-wakeup-call-a-ground-level-analysis/\n// https://github.com/es3n1n/defendnot\n// https://www.huntress.com/blog/defendnot-detecting-malicious-security-product-bypass-techniques\n\n// Remember to set the query period - v2 detection \n\nlet AvModeDescription = dynamic({\"0\":\"Normal\", \"1\":\"Passive\", \"4\":\"EDR Block\"});\nlet DeviceEDRPassive =\nDeviceTvmInfoGathering\n| extend AdditionalFields = parse_json(AdditionalFields)\n| extend AvEngineVersion = tostring(AdditionalFields.[\"AvEngineVersion\"])\n| extend AvPlatformVersion = tostring(AdditionalFields.[\"AvPlatformVersion\"])\n| extend AvMode =  tostring(AvModeDescription[tostring(AdditionalFields.[\"AvMode\"])])\n| where isnotempty( AvMode ) and AvMode == \"Passive\"\n| distinct DeviceName;\nDeviceFileEvents\n| where ActionType == \"FileCreated\"\n| where FileName has \"ctx.bin\"\n| where DeviceName has_any(DeviceEDRPassive)"
  },
  {
    "source": "SlimKQL",
    "name": "glibc critical vulnerability (CVSS 9.8)",
    "query": "// https://cybersecuritynews.com/glibc-vulnerability/\n// https://nvd.nist.gov/vuln/detail/CVE-2025-4802\n\nDeviceFileEvents\n| where TimeGenerated \u003e ago(90d)\n| where ActionType == \"FileCreated\"\n| where FileName == \"libc.so.6\""
  },
  {
    "source": "SlimKQL",
    "name": "psexecsvc.py detection",
    "query": "// Detecting psexecsvc.py\n// https://sensepost.com/blog/2025/psexecing-the-right-way-and-why-zero-trust-is-mandatory/\n// https://github.com/sensepost/susinternals\n\nlet QueryPeriod = 1h;\nlet DeviceWithPSEXECSVC =\nDeviceFileEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where FolderPath has \"\\\\ADMIN$\"\n| where ActionType == \"FileCreated\"\n| where FileName has \"PSEXECSVC\"\n| project DeviceId;\nDeviceEvents\n| where Timestamp \u003e ago(QueryPeriod)\n| where ActionType == \"ServiceInstalled\"\n| where parse_json(AdditionalFields)[\"ServiceName\"] has \"PSEXECSVC\" \nor InitiatingProcessVersionInfoOriginalFileName == \"PSEXECSVC1.9.exe\"\n| where DeviceId has_any(DeviceWithPSEXECSVC)"
  },
  {
    "source": "SlimKQL",
    "name": "AWS NoSuchBucket Check",
    "query": "// AWS NoSuchBucket Check\n\n// https://labs.watchtowr.com/8-million-requests-later-we-made-the-solarwinds-supply-chain-attack-look-amateur/\n\nAWSCloudTrail\n| where TimeGenerated \u003e ago(90d)\n| where ErrorCode == \"NoSuchBucketPolicy\"\n| extend BucketName = tostring(parse_json(RequestParameters).bucketName)\n| extend Host = tostring(parse_json(RequestParameters).Host)\n| project TimeGenerated, BucketName, Host"
  },
  {
    "source": "SlimKQL",
    "name": "Add Passkey device-bound MS Authenticator Windows Hello detection",
    "query": "// Add Passkey device-bound MS Authenticator Windows Hello detection\n// https://www.linkedin.com/posts/activity-7191839187543728128-DQ02/\n\n// With the public preview of expanding Entra passkey options, Entra admins will now need to make sure passkeys are properly managed as part of the security key life cycle management for both privilege and non-privilege roles. Security operations will also need to have detection on *NEW* passkey added from both malicious or non-malicious perspectives so that threat can be monitor and mitigated when required.ðŸ«¡ \n\nAuditLogs\n| where ActivityDisplayName contains \"Add Passkey\"\n| where Result == \"success\"\n| extend AccountUPN = TargetResources[0].userPrincipalName\n| extend AAGUID = AdditionalDetails[1].value\n| extend WebAuthnInfo = AdditionalDetails[0].value\n| project TimeGenerated, AccountUPN, ActivityDisplayName, AAGUID, WebAuthnInfo\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the activities and data being extracted, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query is identifying successful additions of passkeys, which can be related to the use of valid accounts for authentication purposes.\n// T1556 - Modify Authentication Process:\n// Adding a passkey can be seen as modifying the authentication process, which falls under this technique.\n// T1589 - Gather Victim Identity Information:\n// Extracting user principal names and WebAuthn information can be related to gathering identity information."
  },
  {
    "source": "SlimKQL",
    "name": "Analyzing Malicious Microsoft Graph API Rate Limit Count",
    "query": "// Analyzing Malicious Microsoft Graph API Rate Limit Count\n// https://www.linkedin.com/posts/activity-7218488532250546178-zAMf/\n\n// Utilizing Sentinelâ€™s BehaviourAnalytics with MicrosoftGraphActivityLogs to pinpoint Entra app IDs that are abusing the Microsoft Graph API and causing throttling due to malicious activities. Once the throttling operation resource is identified, additional KQLs can be further deployed to detect specific use case misuse. ðŸŽ¯\n\nlet AttackerIPs =\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| extend ThreatIntelIndicatorDescription = tostring(DevicesInsights.ThreatIntelIndicatorDescription)\n| where ThreatIntelIndicatorDescription contains \"proxy\"\n| distinct SourceIPAddress;\nMicrosoftGraphActivityLogs \n| where TimeGenerated \u003e ago(90d) \n| where IPAddress has_any(AttackerIPs)\n| extend path = replace_string(replace_string(replace_regex(tostring(parse_url(RequestUri).Path), @'(\\/)+','//'),'v1.0/',''),'beta/','') \n| extend UriSegments = extract_all(@'\\/([A-z2]+|\\$batch)($|\\/|\\(|\\$)',dynamic([1]),tolower(path))\n| extend OperationResource = strcat_array(UriSegments,'/')| summarize RateLimitedCount=count() by AppId, OperationResource, RequestMethod \n| sort by RateLimitedCount desc\n\n// MITRE ATT\u0026CK Mapping\n\n// T1071.001 - Application Layer Protocol: Web Protocols\n// The query looks for suspicious activity in web protocols, specifically targeting proxy-related indicators.\n// T1070.004 - Indicator Removal on Host: File Deletion\n// By analyzing logs for specific IPs and paths, the query can help detect attempts to remove or hide indicators on the host.\n// T1087.001 - Account Discovery: Local Account\n// The query extends and normalizes paths to identify operations on resources, which can be related to account discovery activities.\n// T1040 - Network Sniffing\n// The use of BehaviorAnalytics to identify proxy-related activities can be linked to network sniffing techniques.\n// T1078 - Valid Accounts\n// By summarizing and sorting activities by AppId and RequestMethod, the query can help detect the use of valid accounts for malicious purposes."
  },
  {
    "source": "SlimKQL",
    "name": "AppSheet.com abused to send Phish",
    "query": "// AppSheet.com abused to send Phish\n// https://blog.knowbe4.com/impersonating-meta-powered-by-appsheet-a-rising-phishing-campaign-exploits-trusted-platforms-to-evade-detection\n\nlet MonitorKeywords = dynamic([\"intellectual property\", \"campaign\", \"infringement\", \"disabled\"]);\nEmailEvents\n| where TimeGenerated \u003e ago(90d)\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction != \"Blocked\"\n| where SenderFromAddress == \"noreply@appsheet.com\"\n| where SenderDisplayName has \"facebook\" or SenderDisplayName has \"meta\"\n| where Subject has_any(MonitorKeywords)"
  },
  {
    "source": "SlimKQL",
    "name": "Attacker in the Middle Precision Detection",
    "query": "// Attacker in the Middle Precision Detection\n\n//** A premium detection requiring Entra P2 license **\n\n// Beginning in July 2024, the â€˜Attacker in the Middleâ€™ detection is now generally available in Identity Protection. By combining this offline detection with â€˜Anomalous Tokenâ€™ detection, it provides high-precision detection when a malicious actor attempts to replay a token. AAD Identity Protection will raise a security alert under â€˜Anomalous Tokenâ€™ with the â€˜attackerInTheMiddleâ€™ risk event type, ensuring reliable detection.\n\nlet AnomalousTokenRequestId=\nSecurityAlert\n| where AlertName == \"Anomalous Token\"\n| mv-expand todynamic(Entities)\n| project Entities\n| extend RequestId = tostring(Entities.RequestId)\n| distinct RequestId;\nAADUserRiskEvents\n| where RequestId has_any(AnomalousTokenRequestId)\n| where RiskEventType == \"attackerinTheMiddle\"\n\n// #Sentinel #AiTM #AnomalousToken #IdentityProtection #Entra #PremiumDetection\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL code is designed to detect anomalous token activities and correlate them with specific risk events. The associated MITRE ATT\u0026CK techniques are:\n\n// T1550.004 - Use Alternate Authentication Material: Web Session Cookie:\n// This technique involves using stolen web session cookies to authenticate to web applications.\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// This technique involves using web protocols for command and control.\n// T1078 - Valid Accounts:\n// This technique involves using valid accounts to gain access to systems.\n// T1556.004 - Modify Authentication Process: Network Device Authentication:\n// This technique involves modifying the authentication process to gain unauthorized access.\n\n// The specific detection of â€œattackerinTheMiddleâ€ suggests a focus on T1557.002 - Adversary-in-the-Middle: Man-in-the-Middle attacks, where attackers intercept and manipulate communications between two parties."
  },
  {
    "source": "SlimKQL",
    "name": "Azure CLI Spray - ASN 53667",
    "query": "// Azure CLI Spray - ASN 53667\n// https://www.linkedin.com/posts/activity-7216141179648716800-703J/\n\n// Defenders take note of this ASN using IPV6 to conduct Azure CLI Spray on your Entra Tenant. Use the below KQL to check against you Sentinel.ðŸ¤\n\n// ASN 53667 Lookup - https://lnkd.in/gAVK5htd\n\nSigninLogs\n| where TimeGenerated \u003e ago(30d)\n| where ResultType == \"50126\" or ResultType == \"50053\"\n| where UserAgent == \"node-fetch\"\n| where AutonomousSystemNumber == \"53667\"\n| where AppDisplayName == \"Microsoft Azure CLI\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the criteria in the KQL query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts: The query is looking for failed sign-in attempts, which can indicate attempts to use valid accounts with incorrect credentials.\n// T1071.001 - Application Layer Protocol: Web Protocols: The use of â€œnode-fetchâ€ suggests web-based communication, which falls under this technique.\n// T1586.001 - Compromise Infrastructure: Botnet: The specific ASN and user agent might indicate the use of compromised infrastructure or botnets for automated sign-in attempts.\n// T1078.004 - Valid Accounts: Cloud Accounts: The use of â€œMicrosoft Azure CLIâ€ indicates attempts to access cloud resources, which is relevant to this technique."
  },
  {
    "source": "SlimKQL",
    "name": "Azure cloud account takeover (ATO) Reconnaissance Detection",
    "query": "//Azure cloud account takeover (ATO) Reconnaissance Detection\n//https://www.linkedin.com/posts/activity-7179350804431085569-CcT_/\n\n//In Feb, Proofpoint published \"Ongoing Malicious Campaign Impacting Microsoft Azure Cloud Environments\"\n//https://lnkd.in/d7A_evhi\n\n//Based on the published blog data, I was able to construct a KQL threat hunting query to correlate against Microsoft Graph commands used by threat actors to conduct tenant resource reconnaissance. Do make sure you send Microsoft Graph activity logs to a Log Analytics workspace (https://lnkd.in/ghqQiiEg) in order to be able to detect this type of reconnaissance.\n\n//Below are the two types of graph commands your KQL needs to check in the RequestUri for potential tenant reconnaissance activity.\n\n//List Tenants\n//https://lnkd.in/gtPB_Mvq\n\n//List subscribedSkus\n//https://lnkd.in/gmi8uEa8 \n\n//The below KQL help you check if you are potentially impacted by this ATO campaign.\n\nlet ATOIPs =\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where UserAgent == \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n| where AppDisplayName == \"OfficeHome\"\n| distinct IPAddress;\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(90d)\n| where IPAddress has_any (ATOIPs)\n| where RequestUri contains \"tenantRelationships\" or RequestUri contains \"subscribedSkus\"\n\n// MITRE ATT\u0026CK Mapping\n\n// KQL code is designed to detect suspicious activities related to specific user agents and application usage, and then correlate these activities with specific Microsoft Graph API requests. The associated MITRE ATT\u0026CK techniques primarily involve the use of valid cloud accounts and web protocols for communication and discovery activities.\n\n// T1087.004: Account Discovery: Cloud Account - Identifying cloud accounts and their roles.\n// T1078.004: Valid Accounts: Cloud Accounts - Continued use of valid credentials to access cloud services.\n// T1071.001: Application Layer Protocol: Web Protocols - The use of web protocols for communication."
  },
  {
    "source": "SlimKQL",
    "name": "Azure cloud account takeover",
    "query": "//Azure cloud account takeover\n//https://www.linkedin.com/feed/update/urn:li:activity:7163049034528481281/\n\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where UserAgent == \"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\"\n| where AppDisplayName == \"OfficeHome\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts: The query is filtering sign-in logs, which can be used to detect the use of valid accounts, especially if the user agent is unusual or unexpected for the environment1.\n// T1071.001 - Application Layer Protocol: Web Protocols: The specific user agent string indicates web-based access, which falls under the use of web protocols2.\n// T1204.002 - User Execution: Malicious File: If the user agent is associated with a known malicious browser or script, it could indicate an attempt to execute malicious files3."
  },
  {
    "source": "SlimKQL",
    "name": "BadSuccessor Detection",
    "query": "// BadSuccessor Detection\n// Abusing dMSA to escalate privileges in Active Directory\n// https://www.akamai.com/blog/security-research/abusing-dmsa-for-privilege-escalation-in-active-directory\n\nlet QueryPeriod = 1h;\nlet dMSARegKey = dynamic([\"DelegatedMSAEnabled\"]);\nlet dMSAMonitor =\nSecurityEvent\n| where TimeGenerated \u003e ago(QueryPeriod)\n| where EventID == 307 or // dMSA Migration\nEventID == 308 or // dMSA Permission Add\nEventID == 309; // dMSA Key Fetch\nDeviceRegistryEvents\n| where TimeGenerated \u003e ago(QueryPeriod)\n| where ActionType == @\"RegistryKeyCreated\" or ActionType  == @\"RegistryValueSet\"\n| where RegistryKey has_any(dMSARegKey)\n| union dMSAMonitor"
  },
  {
    "source": "SlimKQL",
    "name": "Blob URIs creation trend analysis",
    "query": "// https://hackread.com/phishing-attack-blob-uri-fake-login-pages-browser/\n\n// Switch to Chart Mode to visualize\n\nDeviceFileEvents\n| where TimeGenerated \u003e ago(90d)\n| where FileOriginUrl startswith \"blob:https://\"\n| summarize Count=count() by bin(TimeGenerated,1d)"
  },
  {
    "source": "SlimKQL",
    "name": "Brands Impersonation Phishing Trend",
    "query": "// Brands Impersonation Phishing Trend\n\n// Are you aware of the types of brand impersonation targeting your Entra users? Threat actors are exploiting SaaS platforms to evade detection and phish your users. Iâ€™ve developed a KQL to analyze MDO email threats and summarized the impersonation threats facing your Entra tenant. Educating your users about these threats is crucial for cyber defense. Keeping them informed about the specific threats your organization faces is vital.\n\nlet BrandAbuse = dynamic([\"Docusign\", \"Sharepoint\", \"Norton\", \"Microsoft\", \"OneDrive\", \"CloudFlare\", \"Adobe\"]);\nEmailEvents\n| where TimeGenerated \u003e ago(90d)\n| where EmailDirection == \"Inbound\" and ThreatNames != \"\"\n| where ThreatNames has_any(BrandAbuse)\n| extend IPLocation = tostring(geo_info_from_ip_address(SenderIPv4).country)\n| summarize Count=count() by SenderIPv4, IPLocation, ThreatNames\n| sort by Count desc"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-0012 PAN-OS - Authentication Bypass in the Management Web Interface",
    "query": "// CVE-2024-0012 PAN-OS - Authentication Bypass in the Management Web Interface\n\n// An authentication bypass in Palo Alto Networks PAN-OS software enables an unauthenticated attacker with network access to the management web interface to gain PAN-OS administrator privileges to perform administrative actions, tamper with the configuration, or exploit other authenticated privilege escalation vulnerabilities. The following detects for version affected by CVE-2024-0012\n\nlet AffectedPANOS = dynamic([\"11.2.0-h1\",\"11.2.1-h1\",\"11.2.2-h2\",\"11.2.3-h3\",\"11.1.0-h4\",\"11.1.1-h2\",\"11.1.2-h15\",\"11.1.3-h11\",\"11.1.4-h7\",\"11.0.0-h4\",\"11.0.1-h5\",\"11.0.2-h5\",\"11.0.3-h13\",\"11.0.4-h6\",\"11.0.5-h2\",\"11.0.0-h4\",\"11.0.1-h5\",\"11.0.2-h5\",\"11.0.3-h13\",\"11.0.4-h6\",\"11.0.5-h2\",\"10.2.0-h4\",\"10.2.1-h3\",\"10.2.2-h6\",\"10.2.3-h14\",\"10.2.4-h32\",\"10.2.5-h9\",\"10.2.6-h6\",\"10.2.7-h18\",\"10.2.8-h15\",\"10.2.9-h16\",\"10.2.10-h9\",\"10.2.11-h6\"]);\nCommonSecurityLog\n| where DeviceProduct == \"PAN-OS\"\n| where DeviceVersion has_any(AffectedPANOS)\n| distinct Computer                           //Vulnerable Palo Alto Firewall"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-10443 Hunting: RISK:STATION",
    "query": "// CVE-2024-10443 Hunting: RISK:STATION\n\n// Synology has addressed a critical security flaw impacting DiskStation and BeePhotos that could lead to remote code execution. RISK:STATION is an unauthenticated zero-click vulnerability allowing attackers to obtain root-level code execution on the popular Synology DiskStation and BeeStation NAS devices, affecting millions of devices.\n\n// Do you know where all your corporate Synology NAS boxes are? The following Sentinel KQL will scan through your DeviceNetworkEvents table for the past 90 days and prepare a list of Synology NAS quick connect hosts and your Microsoft Defender for Endpoints connection. This allows SecOps to work with Infra Ops to ensure all NAS boxes are patched.\n\n// Synology Urges Patch for Critical Zero-Click RCE Flaw Affecting Millions of NAS Devices\n// Link: https://thehackernews.com/2024/11/synology-urges-patch-for-critical-zero.html\n\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(90d)\n| where ActionType == @\"HttpConnectionInspected\"\n| extend Host = tostring(parse_json(AdditionalFields)[\"host\"])\n| where Host contains \":5001\" // Synology DSM secure port\n| distinct Host, DeviceName\n| sort by Host desc"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2024-3393 DDOS Detection",
    "query": "// CVE-2024-3393 DDOS Detection\n\n// https://securityadvisories.paloaltonetworks.com/CVE-2024-3393\n// https://thehackernews.com/2024/12/palo-alto-releases-patch-for-pan-os-dos.html\n\nlet FixedVersion = dynamic([\"11.2.3\",\"11.1.5\",\"10.2.8\",\"10.2.10-h12\",\"10.2.13-h2\",\"10.1.14\",\"10.1.14-h8\"]);\nCommonSecurityLog\n| where DeviceVendor == \"Palo Alto Networks\"\n| where Computer != \"\"\n| where TimeGenerated \u003e ago(1h)\n| summarize LastLogReceived=max(TimeGenerated) by Computer, DeviceVendor, DeviceVersion\n| project LastLogReceived, Computer, DeviceVendor, DeviceVersion\n| where LastLogReceived \u003c ago(15m)\n| where not (tostring(DeviceVersion) has_any(FixedVersion))"
  },
  {
    "source": "SlimKQL",
    "name": "CVE-2025-33073 Detection",
    "query": "// CVE-2025-33073 Detection\n// https://www.synacktiv.com/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025\n\nlet QueryPeriod = 1h;\nlet HostList =\n    DeviceInfo\n    | extend Hostname = tostring(split(DeviceName, '.')[0])\n    | distinct Hostname;\nDnsEvents\n| where TimeGenerated \u003e ago(QueryPeriod)\n| extend DNSQuery = tolower(Name)\n| where DNSQuery startswith \"localhost\" or DNSQuery has_any(HostList)\n| where not (DNSQuery has \".\")\n| where DNSQuery matches regex @\"[A-Za-z0-9+\\/]{20,}={0,2}\""
  },
  {
    "source": "SlimKQL",
    "name": "Conditional Access Report",
    "query": "// Conditional Access Report\n// https://www.linkedin.com/posts/activity-7192037878783205377-lq27/\n\n// Do you know you can access all these CA statistics from Signin Logs table using KQL? ðŸ˜Ž\n\n// Using Sentinel and the below KQL will provide you the statistics (\"Success\"/\"Failure\"/\"Not applied\") of all your conditional access rules based on certain number of days. You can further summarize these set of data to better understand your conditional access rule trigger and tweak it to improve the security controls. ðŸ›¡\n\nSigninLogs\n| where TimeGenerated \u003e ago(30d)\n// Additional Toggle to determine CA result for success/failure login\n//| where ResultType == \"0\"\n| where ConditionalAccessPolicies != \"[]\"\n| mv-expand ConditionalAccessPolicies\n| extend CADisplayName = tostring(ConditionalAccessPolicies.displayName)\n| extend CAResult = tostring(ConditionalAccessPolicies.result)\n| summarize Count=count() by CADisplayName, CAResult\n| sort by CADisplayName asc \n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query primarily focuses on analyzing Conditional Access Policies, which can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to gain initial access, persist, escalate privileges, or evade detection.\n// Relevance: The query checks for Conditional Access Policies, which are often used to enforce multi-factor authentication (MFA) and other security measures to protect valid accounts.\n// T1110 - Brute Force:\n// Description: Adversaries may use brute force techniques to attempt to gain access to accounts.\n// Relevance: The query can be adapted to filter for failed login attempts (e.g., by uncommenting the ResultType == \"0\" line), which can help detect brute force attempts.\n// T1190 - Exploit Public-Facing Application:\n// Description: Adversaries may exploit vulnerabilities in public-facing applications to gain access.\n// Relevance: Conditional Access Policies can help mitigate the risk of exploitation by enforcing additional authentication requirements.\n// T1071 - Application Layer Protocol:\n// Description: Adversaries may use application layer protocols to communicate with systems under their control.\n// Relevance: Monitoring Conditional Access Policies can help detect unusual or unauthorized access patterns that may indicate the use of such protocols."
  },
  {
    "source": "SlimKQL",
    "name": "Critical Vulnerability in Elastic Kibana",
    "query": "// Critical Vulnerability in Elastic Kibana\n// https://www.csa.gov.sg/alerts-and-advisories/alerts/al-2025-022\n\n// Locate internet facing Elastic Kibana with upmost priority\n\nlet InternetFacing =\nDeviceInfo\n| where IsInternetFacing == true and isnotempty(PublicIP)\n| distinct DeviceId;\nDeviceProcessEvents\n| where TimeGenerated \u003e ago(90d)\n| where InitiatingProcessCommandLine has \"kibana\"\n| summarize arg_max(TimeGenerated, *) by DeviceId\n| where DeviceId has_any(InternetFacing)"
  },
  {
    "source": "SlimKQL",
    "name": "Custom DefenderXDR KQL detection for fake CrowdStrike email domain using Regex",
    "query": "// Custom DefenderXDR KQL detection for fake CrowdStrike email domain using Regex\n// https://www.linkedin.com/posts/activity-7222081026011885568-giCs/\n\n// Configure as Detect \u0026 Purge:\n\nEmailEvents\n| where Timestamp \u003e ago(1h)\n| where EmailDirection == \"Inbound\"\n| where LatestDeliveryAction == \"Delivered\"\n| where SenderFromDomain matches regex \"^{a-z0-9\\\\-]{0,}cr[0oO]wdstr[i1l]ke[a-z0-9\\\\-]{0,}\\\\.[a-z]{1,}$\"\n| where SenderFromDomain !endswith \"crowdstrike.com\" and\nSenderFromDomain !endswith \"litmos.com\" and\nSenderFromDomain !endswith \"zoom.us\"\n\n// MITRE ATT\u0026CK Mapping\n\n// The query primarily focuses on detecting phishing attempts, which can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// Phishing (T1566):\n// The query aims to identify phishing emails by detecting domains that mimic legitimate ones1.\n// Spearphishing Link (T1566.002):\n// By focusing on inbound emails with specific domain patterns, the query helps detect spearphishing attempts where attackers use lookalike domains1.\n// Spearphishing Attachment (T1566.001):\n// Although the query doesnâ€™t explicitly check for attachments, it can be extended to do so, thereby detecting spearphishing emails with malicious attachments1."
  },
  {
    "source": "SlimKQL",
    "name": "DISCOVERY: Obsolete device connecting to Entra",
    "query": "// DISCOVERY: Obsolete device connecting to Entra\n// https://www.linkedin.com/posts/activity-7222163567834230785-BgVr/\n\n// Detect unpatched Windows 10 and 11 clients connecting to your Entra tenant via AADSTS5000611 (Symmetric Key Derivation Function version 'KDFV1' is invalid)\n\nunion isfuzzy=true SigninLogs, AADNonInteractiveUserSignInLogs\n| where ResultType != 0 and ResultDescription == \"Other\"\n| where ResultType == \"500061\"\n| distinct Category, Identity\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// This technique involves adversaries using valid accounts to gain access to systems. The query focuses on non-successful sign-ins, which could indicate attempts to use valid accounts with // incorrect credentials or other issues.\n// T1110 - Brute Force:\n// The query could be used to detect brute force attempts where multiple sign-in attempts fail. Filtering by ResultType != 0 and specific ResultType == \"500061\" can help identify such patterns.\n// T1556 - Modify Authentication Process:\n// The query looks at non-interactive user sign-ins, which could be related to attempts to modify or bypass the authentication process."
  },
  {
    "source": "SlimKQL",
    "name": "Defending Cyber Threats Leveraging Microsoft Graph API ",
    "query": "// Defending Cyber Threats Leveraging Microsoft Graph API \n// https://www.linkedin.com/posts/activity-7201866283464679424-Jf-5/\n\n// Using Sentinel User and Entity Behavior Analytics (UEBA) threat intelligence data to triangulate attacker launching Graph API attacks on your Entra tenant. Prerequisites: Sentinel UEBA and MicrosoftGraphActivityLogs enabled.\n\nlet AttackerIP =\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| where DevicesInsights contains \"ThreatIntelIndicatorType\" and SourceDevice == \"\"\n| extend ThreatIntel=tostring(DevicesInsights.ThreatIntelIndicatorDescription)\n| where InvestigationPriority \u003e 0 and ThreatIntel contains \"hashtag#AttackerIP\"\n| distinct SourceIPAddress;\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(90d)\n| where IPAddress has_any (AttackerIP)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The query checks for IP addresses involved in suspicious activities, which could be related to the use of web protocols for command and control.\n// T1070.004 - Indicator Removal on Host: File Deletion:\n// The query looks for threat intelligence indicators, which might include attempts to remove or alter logs to evade detection.\n// T1040 - Network Sniffing:\n// By analyzing network activity logs, the query could help detect attempts to capture network traffic.\n// T1078 - Valid Accounts:\n// The queryâ€™s focus on MicrosoftGraphActivityLogs might help identify the use of compromised accounts.\n// T1020 - Automated Exfiltration:\n// The query could detect automated data exfiltration attempts by monitoring suspicious IP addresses."
  },
  {
    "source": "SlimKQL",
    "name": "Defending malicious MS graph activity with MS Sentinel Threat Intelligence",
    "query": "//Defending malicious MS graph activity with MS Sentinel Threat Intelligence\n//https://www.linkedin.com/pulse/defending-malicious-ms-graph-activity-sentinel-threat-steven-lim-yorjc/\n\n//This article assumed you have already configured your Microsoft Graph Activity Logs through Diagnostic Setting in the Entra Portal and you have the Microsoft data connector for Microsoft Sentinel (Threat Intelligence - TAXII) enabled and fully configured to receive a good cyber threat intelligence feed.\n\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(1h)\n| distinct IPAddress\n| join ThreatIntelligenceIndicator on $left.IPAddress == $right.NetworkIP\n\n//Microsoft have released a new premium user risk detection in Identity Protection called Suspicious API Traffic. This detection is reported when Identity Protection detects anomalous Graph traffic by a user. Suspicious API traffic might suggest that a user is compromised and conducting reconnaissance in their environment. \n\nSigninLogs\n| where RiskEventTypes contains \"suspiciousAPITraffic\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols: The use of Microsoft Graph API can be associated with web protocols.\n// T1071.003 - Application Layer Protocol: Mail Protocols: If the Graph API is used for email-related activities.\n// T1595.002 - Active Scanning: Vulnerability Scanning: If the IP addresses are involved in scanning activities.\n// T1078 - Valid Accounts: Suspicious API traffic might indicate the use of compromised accounts.\n// T1587.001 - Develop Capabilities: Malware: If the suspicious traffic is related to malware activities.\n// T1589.002 - Gather Victim Network Information: DNS: If the suspicious traffic involves DNS queries."
  },
  {
    "source": "SlimKQL",
    "name": "Detect API Spray Attack on your Entra High Value Assets",
    "query": "// Detect API Spray Attack on your Entra High Value Assets\n\n// In recent months, a threat actor has been leveraging Amazon Data Services Nova (Ashburn, US) to perform API spray attacks on corporate Entra accounts. This activity can be identified in your sign-in logs by filtering for the user agent â€˜AmazonAPIGateway_â€™. The following KQL query utilizes Sentinel UEBA behavior analytics to pinpoint which high-value Entra assets (BlastRadius = High) are involved in the API spray attack. You can then apply a conditional access rule to block this IP, enhancing protection for your high-value assets.\n\nlet APISpray =\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where ResultType == \"50126\" or ResultType == \"50053\"\n| where UserAgent has \"AmazonAPIGateway_\"\n| distinct IPAddress;\nBehaviorAnalytics\n| where SourceIPAddress has_any (APISpray)\n| extend BlastRadius = UsersInsights.BlastRadius\n| where BlastRadius == \"High\"\n\n// #Sentinel #UEBA #BehaviourAnalytics #APISpray #BlastRadius #AWS #APIGateway\n\n// MITRE ATT\u0026ACK Mapping\n\n// Tactic: Credential Access\n// Technique: Valid Accounts (T1078)\n// Sub-technique: Cloud Accounts (T1078.004)\n\n// Tactic: Initial Access\n// Technique: Exploit Public-Facing Application (T1190)\n// Reason: The presence of â€œAmazonAPIGateway_â€ in the UserAgent string suggests interaction with a public-facing API, which could be exploited.\n\n// Tactic: Discovery\n// Technique: Account Discovery (T1087)\n// Reason: The query is looking for behaviors associated with specific IP addresses, which could indicate reconnaissance activities.\n\n// Tactic: Impact\n// Technique: Data Destruction (T1485)\n// Reason: High blast radius indicates a significant impact, potentially related to destructive actions."
  },
  {
    "source": "SlimKQL",
    "name": "Detect CVE-2025-27607 (CVSS 8.8)",
    "query": "// CVE-2025-27607 (CVSS 8.8)\n// The â€˜python-json-loggerâ€™ package has over 43 million downloads per month, making this vulnerability a significant threat to a large number of users.\n// https://securityonline.info/popular-python-logging-library-vulnerable-to-remote-code-execution-cve-2025-27607/#google_vignette\n\nDeviceProcessEvents\n| where TimeGenerated \u003e ago(90d)\n| where InitiatingProcessCommandLine has \"install python-json-logger\"\n| summarize arg_max(TimeGenerated, *) by DeviceName"
  },
  {
    "source": "SlimKQL",
    "name": "Detect Microsoft Graph API Abuse",
    "query": "// Detect Microsoft Graph API Abuse\n// Linkedin Post: https://www.linkedin.com/posts/0x534c_nation-state-attackers-increasingly-abuse-activity-7227945393827815424-QMVG/\n// This offline risk detection is reported when abnormal GraphAPI traffic or directory enumeration is observed. Suspicious API traffic might suggest that a user is compromised and conducting reconnaissance in the environment.\n\n// ** A premium detection requiring Entra P2 license **\n\nsearch in (SigninLogs, AADUserRiskEvents, AADNonInteractiveUserSignInLogs)\nTimeGenerated between (ago(48h) .. now())\nand (\nRiskEventTypes == \"suspiciousAPITraffic\"\n)\n\n// Reference: https://learn.microsoft.com/en-us/entra/id-protection/concept-identity-protection-risks#suspicious-api-traffic\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts: Attackers may use valid accounts to access and interact with systems, which can generate suspicious API traffic.\n// T1071 - Application Layer Protocol: Suspicious API traffic might indicate the use of application layer protocols for command and control.\n// T1070 - Indicator Removal on Host: Attackers might try to hide their tracks by generating suspicious API traffic to remove indicators from logs.\n// T1059 - Command and Scripting Interpreter: Suspicious API traffic could be a result of scripts or commands executed by the attacker."
  },
  {
    "source": "SlimKQL",
    "name": "Detect Privilege Admin under AiTM attack",
    "query": "// Detect Privilege Admin under AiTM attack\n// https://www.linkedin.com/posts/0x534c_sentinel-privilegeadmin-aitm-activity-7227603649688952832--1Id/\n//Sentinel rule trigger =\u003e Run Playbook \"Disable User Account\"\n//A simple and effective offline detection and mitigation strategy.\n\nlet PrivilegeAdmin =\nIdentityInfo\n| where AssignedRoles != \"[]\" and isnotnull(AssignedRoles)\n| distinct AccountUPN;\nAADUserRiskEvents\n| where RiskEventType == \"attackerinTheMiddle\"\n| where UserPrincipalName has_any(PrivilegeAdmin)\n\n// #Sentinel #PrivilegeAdmin #AiTM #IdentityProtection #Entra #PremiumDetection\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1557 - Man-in-the-Middle:\n// The RiskEventType == \"attackerinTheMiddle\" directly maps to the MITRE ATT\u0026CK technique T1557, which involves adversaries positioning themselves between two or more networked devices to intercept or alter communications.\n// T1078 - Valid Accounts:\n// The query focuses on privileged accounts (PrivilegeAdmin), which aligns with T1078. Adversaries may use valid accounts to maintain access to systems and networks."
  },
  {
    "source": "SlimKQL",
    "name": "Detect privilege escalation to Global Admin role via compromised service principal",
    "query": "// Detect privilege escalation to Global Admin role via compromised service principal\n// https://www.linkedin.com/posts/activity-7223370832763351040-TieO/\n\n// The below Sentinel KQL analytics rule is able to detect potential privilege escalation to Global Admin role via compromised service principal in view of the recent blog from Emilien Socchi (Abusing PIM-related application permissions in Microsoft Graph - Part 1)\nLink: https://lnkd.in/gmFqY4Hm\n\n//Hourly Sentinel Analytics Rule:\n\nlet GA = dynamic(['GA1@acme.com', 'GA2@acme.com', 'GA3@acme.com']);\nAuditLogs \n| where TimeGenerated \u003e ago(1h)\n| where Category == \"RoleManagement\"\n| where ActivityDisplayName == \"Add member to role\"\n| where TargetResources contains \"Global Administrator\"\n| extend UPN = tostring(TargetResources[0].userPrincipalName)\n| where not (UPN has_any(GA))\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078.004 - Valid Accounts: Cloud Accounts:\n// This technique involves adversaries gaining access to cloud accounts to perform actions such as adding new members to privileged roles1.\n// T1098 - Account Manipulation:\n// This technique includes actions like adding users to privileged groups or roles, which is exactly what this query is designed to detect2.\n// T1078 - Valid Accounts:\n// More generally, this technique involves the use of valid accounts to maintain access to systems, which can include adding new accounts to privileged roles3."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting FIDO2 Passkey Abuse",
    "query": "// Detecting FIDO2 Passkey AbuseðŸ”¥\n\n// Max Rozendaal from Secura has penned an insightful blog titled â€œAbusing FIDO2 Passkeys to Take Over Global Administrators in Entra ID.â€ In this post, he delves into a critical attack vector, demonstrating how Microsoftâ€™s Graph API for provisioning FIDO2 passkeys could be exploited to gain control over accounts with high-level privileges. (Blog link will be shared in the comments.)\n// To address this issue, Iâ€™ve developed a Sentinel Graph API KQL threat detection script inspired by Maxâ€™s findings. You can download the KQL code from my SlimKQL GitHub Repository, which is highlighted on my LinkedIn profile. Just search for â€œDetecting FIDO2 Passkey Abuse.â€\n\nlet AbusedRoleMonitor = dynamic([\"Privileged Role Administrator\", \"Global Administrator\"]);\nlet FIDOAccountObjID =\nMicrosoftGraphActivityLogs\n| where RequestUri has \"/authentication/fido2Methods/creationOptions\"\n| where RequestMethod == \"GET\" and ResponseStatusCode == 200\n| parse RequestUri with \"https://graph.microsoft.com/beta/users/\" \nUserObjectID \"/authentication/fido2Methods/creationOptions\"\n| distinct UserObjectID;\nIdentityInfo\n| where AccountObjectId has_any(FIDOAccountObjID)\n| summarize arg_max(TimeGenerated, *) by AccountObjectId\n| where AssignedRoles has_any(AbusedRoleMonitor)\n\n//  T1111: Multi-Factor Authentication Interception"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting High Risk Passkey Users",
    "query": "// Detecting High Risk Passkey Users\n// https://www.linkedin.com/posts/activity-7193644152645959682-ylGM/\n\n// As the use of passkeys becomes more popular due to their phishing-resistant advantages and their additional security through device biometrics, itâ€™s important to recognize that there is still a risk of device compromise or potential compromise of the password manager storing the sync-able passkey. Consequently, security operations must actively monitor passkey users who are considered high risk and be prepared to revoke their passkeys when necessary or exclude them from the FIDO sign in policy.\n\n// KQL for detecting High Risk Passkey Users: \n\nSigninLogs\n| where RiskEventTypes_V2 != \"[]\"\n| where RiskLevelAggregated == \"high\"\n| where RiskLevelDuringSignIn == \"high\"\n| where RiskState == \"atRisk\"\n| where AuthenticationDetails contains \"FIDO2 security key\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// This technique involves the use of valid accounts to gain access to systems. High-risk sign-ins with FIDO2 security keys could indicate an attempt to use compromised credentials.\n// T1556 - Modify Authentication Process:\n// This technique involves modifying the authentication process to bypass security controls. High-risk sign-ins with specific authentication methods like FIDO2 security keys could be part of an // attempt to manipulate the authentication process.\n// T1071 - Application Layer Protocol:\n// This technique involves the use of application layer protocols for command and control. High-risk sign-ins could be part of an adversaryâ€™s attempt to establish a foothold using legitimate protocols."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Mamba 2FA phishing-as-a-service",
    "query": "// Detecting Mamba 2FA phishing-as-a-service\n\n// Mamba 2FA is an adversary-in-the-middle (AiTM) phishing kit sold as phishing-as-a-service (PhaaS) and was discovered by Sekoia's Threat Detection \u0026 Research (TDR) team in late May 2024. Mamba 2FA mimics Microsoft 365 login pages and uses HTML attachments to trick users into entering their credentials. Once the credentials are captured, the attackers can bypass two-factor authentication (2FA) and gain access to the victim's accounts.\n\n// The article also details the architecture and capabilities of Mamba 2FA, including its use of Base64-encoded parameters, Socket.IO protocol, and relay servers to manage the stolen data. The phishing pages are designed to be highly convincing, making it difficult for users to identify them as fake.\n\n// Query 1 - User accessing from Mamba 2FA proxy IPs\n\nlet IPv4IOC = dynamic(['23.26.35.67','23.26.206.99','45.86.54.206','45.9.153.102','45.61.130.11','45.61.169.4','172.86.64.212','172.86.96.84','172.86.96.128','172.86.97.78', '172.86.97.165','172.86.104.33','172.86.104.64','172.86.104.178','172.86.105.59','172.86.105.72','172.86.106.94']);\nlet IPv6IOC = dynamic(['2607:5500:3000:1cab::2','2607:5500:3000:7bc::2','2607:5500:3000:312::2','2607:5500:3000:7a5::2','2607:5500:3000:a8c::2','2607:5500:3000:fea::2','2607:5500:3000:b16::2']);\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where IPAddress has_any (IPv4IOC) or IPAddress has_any (IPv6IOC)\n\n// Query 2 - User endpoint communicating with Mamba 2FA\n\nlet DomainsIOC = dynamic(['ccokies1cakes.com','ccokies2mangoes.com','ccokies3tomatoes.com','m1tis-apicookies.com','m2fes-apicookies.com','m3mas-apicookies.com','winss0conect.click','winstnet80nss.cfd','tenetur.top','tenetur.xyz','hypexfinancial.com','voltampereactive.com','planchereserver.com','thirdmandomavis.com','fourthmanservice.com','sithchibb.com','copelustration.xyz','copefood.xyz','seven-oranges.com','onemanforest.com','twomancake.com','threemanshop.com','fourmanchurch.com','fivemanchool.com','sixmanteams.com','sevenmanjungle.com','88mansession.com','fiveradio-newbam.com','nine9manforest.com','10decadesmen.com','11cyclesforest.com','1messisnfarm.com','2moniunesson.com','3alphabetjay.com','4sessionmoon.com','5poleanalhy.com','6treesmangle.com','7motionmansa.com','8boomandool.com','9cantronnfit.com','10trioneyue8ss.com','11beamgools.com']);\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(90d)\n| where ActionType == \"HttpConnectionInspected\"\n| extend WWWHost = AdditionalFields.host\n| where WWWHost has_any (DomainsIOC)\n\n// MITRE ATT\u0026CK\n// T1557"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Nation State Actors @ Near Realtime",
    "query": "//Detecting Nation State Actors @ Near Realtime\n//https://www.linkedin.com/feed/update/urn:li:activity:7172463683351113728/\n\n//In view of recent updates from Microsoft on Midnight Blizzard, for those on Microsoft Entra ID P2 running the below Sentinel KQL analytic rule at NRT (Near real-time) will give you the best detection if your tenant is impacted by any nation state actors based on Microsoft Security Intelligence (MSTIC) telemetry data. \n\nAADUserRiskEvents\n| where RiskEventType == \"nationStateIP\"\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// Technique ID: T1071.001 - Application Layer Protocol: Web Protocols: This technique involves adversaries using web protocols to communicate with systems under their control. Nation-state actors often use such methods to gain initial access to systems1.\n// Technique ID: T1078.004 - Valid Accounts: Cloud Accounts: This technique involves adversaries using valid cloud accounts to gain access. Nation-state actors may use compromised cloud accounts to infiltrate systems2."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Nation-State Threat Actors with Custom KQL Queries",
    "query": "// Detecting Nation-State Threat Actors with Custom KQL Queries\n\n// If you are using the default Sentinel setup, you will not receive notifications in the event of an attack by nation-state threat actors, as there are no built-in analytic rules to detect such threats. I am sharing a Sentinel detection KQL query that can identify nation-state attacks and provide detailed information about the threat actor using Behavior Analytics threat intelligence. By enabling this KQL query, you will be notified when a nation-state threat actor targets your environment and receive additional information about the specific threat actor (e.g., Storm-XXXX)\n\nlet NationStateIP = \nSigninLogs\n| where TimeGenerated \u003e ago(1h)\n| where RiskEventTypes_V2 has \"estsNationStateIP\"\n| project IPAddress;\nBehaviorAnalytics\n| where SourceIPAddress has_any(NationStateIP)\n| project TimeGenerated, UserPrincipalName, ActivityType, \nSourceIPAddress, SourceIPLocation, DevicesInsights.ThreatIntelIndicatorDescription\n\n// MITRE ATT\u0026CK Mapping\n// T1078 - Valid Accounts\n// T1049 - System Network Connections Discovery"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Palo Alto Firewall Exploits",
    "query": "// Detecting Palo Alto Firewall Exploits\n// https://www.bleepingcomputer.com/news/security/palo-alto-networks-tags-new-firewall-bug-as-exploited-in-attacks/\n\nlet GreyNoiseIPs = dynamic([\"193.143.1.65\", \"49.15.245.66\", \"146.190.147.92\", \"64.39.98.72\", \"14.145.63.144\", \"45.61.139.121\", \"72.5.42.10\", \"85.239.56.148\", \"62.204.35.249\", \"38.54.50.252\", \"43.157.45.216\", \"47.190.9.241\", \"43.159.135.197\", \"198.12.122.248\", \"139.87.112.3\", \"123.116.247.134\", \"38.54.101.65\", \"84.17.43.35\", \"1.55.112.205\", \"196.251.89.129\", \"85.31.231.183\", \"46.246.9.213\", \"194.233.96.86\", \"198.23.171.159\", \"45.88.222.89\", \"161.81.158.136\", \"93.115.0.34\", \"199.19.95.31\", \"193.27.90.90\", \"172.86.84.84\", \"47.89.242.61\", \"149.88.26.226\", \"34.121.207.116\", \"104.131.69.106\"]);\nCommonSecurityLog\n| where TimeGenerated \u003e ago(10d)\n| where DeviceVendor == \"Palo Alto Networks\"\n| where DeviceProduct == \"PAN-OS\"\n| where SourceIP has_any(GreyNoiseIPs)\n| summarize AttackCount=count() by SourceIP, DeviceAction\n| sort by DeviceAction asc"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Phishing Emails with Cloudflare R2 URLs",
    "query": "// Detecting Phishing Emails with Cloudflare R2 URLs â˜ï¸ðŸ§¨\n// https://medium.com/trac-labs/aitm-phishing-hold-the-gabagool-analyzing-the-gabagool-phishing-kit-531f5bbaf0e4\n// The TRAC Labs team has uncovered a phishing campaign called \"Gabagool\" that targets corporate and government employees. This campaign leverages Cloudflare R2 buckets to host malicious content and uses compromised email accounts to distribute phishing emails. These emails contain links that lead to credential harvesting pages. The phishing kit employs various evasion techniques, including bot detection and obfuscated JavaScript. (TRAC Labs Case Study link can be found at the comment section)\n\n//I have created two threat hunting KQLs to identify the following:\n\n// Micrososft Defender for Office KQL - Malicious Cloudflare R2 URLs not blocked\n\nlet MaliciousDomainTable=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/romainmarcoux/malicious-domains/main/full-domains-aa.txt']\n| parse RawData with MaliciousDomain:string;\nEmailUrlInfo\n| where TimeGenerated \u003e ago(90d)\n| where Url matches regex \"pub-[0-9a-fA-F]{32}\\\\.r2\\\\.dev\\\\/[a-zA-Z0-9_-]+\\\\.html\"\n| join MaliciousDomainTable on $left.UrlDomain == $right.MaliciousDomain\n| join EmailEvents on NetworkMessageId\n| where DeliveryAction != \"Blocked\"\n\n// Microsoft Defender for Endpoint KQL - Malicious Cloudflare R2 Outbound Connection\n\nlet MaliciousDomainTable=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/romainmarcoux/malicious-domains/main/full-domains-aa.txt']\n| parse RawData with MaliciousDomain:string;\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(90d)\n| where ActionType == @\"HttpConnectionInspected\"\n| extend Host = parse_json(AdditionalFields)[\"host\"]\n| parse Host with R2Host \":\" Port\n| extend Direction = parse_json(AdditionalFields)[\"direction\"]\n| where Direction == \"Out\" and Host has \".r2.dev\"\n| join MaliciousDomainTable on $left.R2Host == $right.MaliciousDomain"
  },
  {
    "source": "SlimKQL",
    "name": "Detecting TeamsPhisher attack with Azure Sentinel",
    "query": "//Detecting TeamsPhisher attack with Azure Sentinel\n//https://www.linkedin.com/pulse/detecting-teamsphisher-attack-azure-sentinel-steven-lim/\n\nOfficeActivity\n| where TimeGenerated \u003e ago(1h)\n| where RecordType =~ 'MicrosoftTeams'\n| where Operation == \"MessageCreatedHasLink\"\n| where CommunicationType == \"OneOnOne\" or CommunicationType == \"GroupChat\"\n| where UserId !endswith \"your_corporate_domain_1\"     // Filter off all internal teams user 1-to-1 message\nand UserId !endswith \"your_corporate_domain_2\"\nand UserId !endswith \"your_corporate_domain_3\"\n| extend UserDomains = tostring(split(UserId, '@')[1])\n| extend UserIPs = tostring(split(ClientIP, '::ffff:')[1])\n| where UserIPs != \"\"\n| distinct UserIPs\n| join ThreatIntelligenceIndicator on $left.UserIPs == $right.NetworkIP\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The query looks for messages with links, which can be used for command and control via web protocols.\n// T1071.003 - Application Layer Protocol: Mail Protocols:\n// Although this is specific to email, the concept of using communication platforms for malicious purposes is similar.\n// T1071.004 - Application Layer Protocol: Remote Services:\n// External communication via Microsoft Teams can be considered a form of remote service.\n// T1071.005 - Application Layer Protocol: Web Protocols:\n// Detecting links in messages aligns with identifying potential web-based command and control.\n// T1071.006 - Application Layer Protocol: Web Protocols:\n// The use of external IP addresses and domains can indicate external command and control.\n// T1071.007 - Application Layer Protocol: Web Protocols:\n// Correlating with threat intelligence indicators helps identify known malicious infrastructure."
  },
  {
    "source": "SlimKQL",
    "name": "Detecting Unauthorized RMM Instances in Your MDE Environment",
    "query": "// Detecting Unauthorized RMM Instances in Your MDE Environment\n\nlet SanctionRMM = dynamic(\"bomgarcloud.com\"); // E.g Approved RMM - whitelisting\nlet RMMList=externaldata(URI: string, RMMTool: string)\n    [h'https://raw.githubusercontent.com/jischell-msft/RemoteManagementMonitoringTools/refs/heads/main/Network%20Indicators/RMM_SummaryNetworkURI.csv'];\nlet RMMUrl =\n    RMMList\n    | project URI;\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(1h)\n| where ActionType == @\"ConnectionSuccess\"\n| where RemoteUrl has_any(RMMUrl)\n| where not (RemoteUrl has_any(SanctionRMM))\n| summarize arg_max(TimeGenerated, *) by DeviceId"
  },
  {
    "source": "SlimKQL",
    "name": "EDR and AV Killer - A Large Scale Driver Exploitation Detection",
    "query": "// EDR and AV Killer - A Large Scale Driver Exploitation Detection\n// https://research.checkpoint.com/2025/large-scale-exploitation-of-legacy-driver/\n\nlet Truesight202Variants=externaldata(FileHash:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/SHA-256-Truesight-Driver-Variants-Ver202.txt'];\nlet EDRKillerFileHashes =\nTruesight202Variants\n| project FileHash;\nDeviceFileEvents\n| where TimeGenerated \u003e ago(90d)\n| where InitiatingProcessSHA256 has_any(EDRKillerFileHashes) or SHA256 has_any(EDRKillerFileHashes)\n//\n// EDR \u0026 AV Killer\n// The legacy Truesight.sys driver (version 2.0.2) has 2,500+ variants bypassing the latest\n// Microsoft Vulnerable Driver Blocklist and common detection mechanisms. The above KQL scan\n// across DeviceFileEvents for the past 90 days for potential truesight.sys variant presence."
  },
  {
    "source": "SlimKQL",
    "name": "Entra ID Administrative Role (AD-Sync)",
    "query": "// Entra ID Administrative Role (AD-Sync)\n\nIdentityInfo\n| where Timestamp \u003e ago(30d)\n| where AssignedRoles != \"\"\n| mv-expand AssignedRoles\n| extend EntraAdminRole = tostring(AssignedRoles)\n| where OnPremSid != \"\"\n| distinct EntraAdminRole, AccountUpn\n| where AccountUpn != \"\"\n| sort by EntraAdminRole asc\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query filters and expands assigned roles, which can help identify the use of valid accounts with specific roles.\n// T1087 - Account Discovery:\n// The query retrieves distinct combinations of roles and UPNs, which aligns with discovering accounts and their associated roles.\n// T1071 - Application Layer Protocol:\n// Filtering by OnPremSid and AccountUpn can help detect unusual or unauthorized use of application layer protocols for accessing resources.\n// T1556 - Modify Authentication Process:\n// The queryâ€™s focus on assigned roles and on-premises SIDs can help detect modifications to authentication processes or roles."
  },
  {
    "source": "SlimKQL",
    "name": "Entra Passkey Addition Threat Detection",
    "query": "// Entra Passkey Addition Threat Detection\n// https://www.linkedin.com/posts/activity-7184406157707390977-6N3C/\n\n//Entra Passkey Addition Threat Detection KQL:\n\nAuditLogs\n| where ActivityDisplayName == \"Add Passkey (device-bound) security key\"\n| where Result == \"success\"\n| extend AccountUPN = TargetResources[0].userPrincipalName\n| extend AAGUID = AdditionalDetails[1].value\n| extend WebAuthnInfo = AdditionalDetails[0].value\n| project TimeGenerated, AccountUPN, ActivityDisplayName, AAGUID, WebAuthnInfo\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and objectives of the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to maintain access to victim systems.\n// Relevance: Adding a passkey could be part of an adversaryâ€™s attempt to maintain access using legitimate credentials.\n// T1556.004 - Unsecured Credentials: Web Session Cookie:\n// Description: Adversaries may steal or forge web session cookies to gain access to web applications.\n// Relevance: The extraction of WebAuthn information could be related to securing or exploiting web session credentials.\n// T1556 - Modify Authentication Process:\n// Description: Adversaries may modify authentication mechanisms to bypass security controls.\n// Relevance: Adding a new passkey could be an attempt to modify the authentication process."
  },
  {
    "source": "SlimKQL",
    "name": "Entra QR Code Sign-In KQL Detection",
    "query": "// Entra QR Code Sign-In KQL Detection\n\nAuditLogs\n| where TimeGenerated \u003e ago(1h)\n| where Category == \"UserManagement\"\n| where ActivityDisplayName == \"Admin updated security info\"\n| where ResultDescription == \"Admin changed QRcode Pin Authentication Method for user\""
  },
  {
    "source": "SlimKQL",
    "name": "Entra Risk Events \u0026 MITRE ATT\u0026CK Analysis",
    "query": "// Entra Risk Events \u0026 MITRE ATT\u0026CK Analysis\n// https://www.linkedin.com/posts/activity-7195030571205476352-a2RE/\n\n// Are you aware of which MITRE ATT\u0026CK techniques correspond to the Entra identity protection risk events linked to your tenant? Executing the following KQL query will reveal the most prevalent technique utilized by adversaries or the risk encountered by your users upon the triggering of an identity alert. Assess the techniques that trigger most frequently in relation to your Microsoft Sentinel MITRE ATT\u0026CK (preview) coverage to ascertain whether your analytics rules are robust enough to detect these commonly occurring techniques.\n\nAADUserRiskEvents\n| where TimeGenerated \u003e ago(90d)\n| mv-expand AdditionalInfo\n| where AdditionalInfo contains \"mitreTechniques\"\n| extend MitreAttack = tostring(parse_json(tostring(AdditionalInfo)).Value)\n| summarize Count=count() by MitreAttack\n| sort by Count desc\n\n// MITRE ATT\u0026CK Mapping\n//The query is designed to identify and count the occurrences of different MITRE ATT\u0026CK techniques found in the AADUserRiskEvents. The MitreAttack field will contain the specific techniques, such as T1078 (Valid Accounts), T1110 (Brute Force), etc."
  },
  {
    "source": "SlimKQL",
    "name": "Entra User Account Compromised by C2",
    "query": "// Entra User Account Compromised by C2\n\n// A high precision detection using Sentinel Behaviour Analytics threat intelligence information to gathered successful Entra account login from C2 IP address from a unidentified source device. You should link this analytic rule trigger to a logic app playbook to mark this account as compromised.\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(1h)\n| where DevicesInsights.ThreatIntelIndicatorType == \"C2\"\n| where ActionType == \"Sign-in\"\n| where isempty(SourceDevice)\n| where ActivityInsights.CountryUncommonlyConnectedFromAmongPeers == \"True\"\n\n// MITRE ATT\u0026CK\n// T1078.003 - Valid Accounts: Cloud Accounts"
  },
  {
    "source": "SlimKQL",
    "name": "EntraFalcon Detection",
    "query": "// https://blog.compass-security.com/2025/04/introducing-entrafalcon-a-tool-to-enumerate-entra-id-objects-and-assignments/\n\nlet QueryPeriod = 1h;\nlet InteractiveSignin =\nSigninLogs \n| where TimeGenerated \u003e ago(QueryPeriod)\n| where (AppId == \"1b730954-1685-4b74-9bfd-dac224a7b894\" and\nResourceIdentity == \"00000003-0000-0000-c000-000000000000\") or \n(AppId == \"04b07795-8ddb-461a-bbee-02f9e1bf7b46\" and\nResourceIdentity == \"00000003-0000-0000-c000-000000000000\");\nAADNonInteractiveUserSignInLogs\n| where TimeGenerated \u003e ago(QueryPeriod)\n| where (AppId == \"eb20f3e3-3dce-4d2c-b721-ebb8d4414067\" and\nResourceIdentity == \"00000003-0000-0000-c000-000000000000\") or \n(AppId == \"04b07795-8ddb-461a-bbee-02f9e1bf7b46\" and\nResourceIdentity == \"797f4846-ba00-4fd7-ba43-dac1f8f63013\")\n| union InteractiveSignin"
  },
  {
    "source": "SlimKQL",
    "name": "Exploring M365 Accounts Investigation",
    "query": "// Exploring M365 Accounts Investigation\n\n// https://www.linkedin.com/posts/0x534c_cybersecurity-m365investigation-kql-activity-7300859391950344192-xedq/\n\nlet UserSSPR =\nAuditLogs\n| where TimeGenerated \u003e ago(90d)\n| where OperationName has \"Self-service password reset\"\n| distinct tostring(TargetResources[0].userPrincipalName);\nlet UserEPNonManaged =\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where UserPrincipalName has_any(UserSSPR)\n| extend DeviceName = tostring(DeviceDetail.displayName)\n| extend TrustType = tostring(DeviceDetail.trustType)\n| extend OS = tostring(DeviceDetail.operatingSystem)\n| where OS !has \"ios\" and OS !has \"android\"\n| where TrustType !has \"AD\"\n| distinct UserPrincipalName;\nCloudAppEvents\n| where TimeGenerated \u003e ago(90d)\n| where IPCategory has \"VPN\" or IPTags has \"Anonymous proxy\"\n| where tostring(RawEventData.UserId) has_any(UserEPNonManaged)\n| summarize Count=count() by ActionType, UserAgent, tostring(RawEventData.UserId)\n| sort by Count desc"
  },
  {
    "source": "SlimKQL",
    "name": "Fortigate Belsen Leak KQL Check",
    "query": "// Fortigate Belsen Leak KQL Check\n\n// In 2022, Fortinet revealed a critical authentication bypass vulnerability (CVE-2022-40684) impacting FortiOS, FortiProxy, and FortiSwitchManager. By January 2025, the Belsen Group had publicly released configurations from around 15,000 affected devices. The following KQL query scans your Fortinet firewall's Destination and Source IP logs within the CommonSecurityLog schema, matching them against the 15K+ leaked IPs from the Belsen Group.\n\nlet FortiBelsenLeakTable=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/fortigate-belsen-leak-15K-IPs.txt']\n| parse RawData with LeakIP:string;\nlet MatchedDestinationIP =\nCommonSecurityLog\n| where TimeGenerated \u003e ago(7d)\n| where DeviceVendor has \"fortinet\"\n| summarize arg_max(TimeGenerated, *) by DestinationIP\n| join FortiBelsenLeakTable on $left.DestinationIP == $right.LeakIP;\nCommonSecurityLog\n| where TimeGenerated \u003e ago(7d)\n| where DeviceVendor has \"fortinet\"\n| summarize arg_max(TimeGenerated, *) by SourceIP\n| join FortiBelsenLeakTable on $left.SourceIP == $right.LeakIP\n| union MatchedDestinationIP"
  },
  {
    "source": "SlimKQL",
    "name": "GraphRunner Recon Detection \u0026 Response",
    "query": "// GraphRunner Recon Detection \u0026 Response\n// https://www.linkedin.com/posts/activity-7186279751127334912-zjwN/\n\n// We create a Sentinel NRT rule to detect the \"Get-GraphTokens\" and perform an automation rule of revoking the token. ðŸ”¥ \n\nSigninLogs\n| where AuthenticationProtocol == \"deviceCode\"\n| where ResourceDisplayName == \"Microsoft Graph\"\n| extend DeviceName = tostring(DeviceDetail.displayName)\n| extend TrustType = tostring(DeviceDetail.trustType)\n| where TrustType != \"Hybrid Azure AD joined\" and TrustType != \"Azure AD joined\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts: The query focuses on authentication logs, which can help detect the use of valid accounts for unauthorized access.\n// T1078.004 - Cloud Accounts: Specifically, the query targets Azure AD logs, which are related to cloud accounts.\n// T1078.001 - Default Accounts: By filtering out specific trust types, the query might help identify the use of default or less secure accounts.\n// T1556 - Modify Authentication Process: The use of â€œdeviceCodeâ€ as an authentication protocol could be related to attempts to modify or bypass standard authentication processes."
  },
  {
    "source": "SlimKQL",
    "name": "HTTP Client Tools Exploitation for ATO Detection",
    "query": "// HTTP Client Tools Exploitation for ATO Detection\n\n// https://www.proofpoint.com/us/blog/threat-insight/http-client-tools-exploitation-account-takeover-attacks\n\nlet HTTPClientTools=externaldata(RawData:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/Proofpoint_HTTPClientTools_ATO.txt']\n| parse RawData with IOC:string;\nlet HTTPClientToolsIOC =\nHTTPClientTools\n| project IOC;\nCloudAppEvents\n| where TimeGenerated \u003e ago(1h)\n| where UserAgent has_any(HTTPClientToolsIOC) and ISP has_any(HTTPClientToolsIOC)"
  },
  {
    "source": "SlimKQL",
    "name": "Honeypot Threat Intelligence (TI) Data",
    "query": "// Honeypot Threat Intelligence (TI) Data\n\n// Mastering the Art of Cyber Deception: Turning the Tables on Attackers with Honeypot Intelligence\n//Deception is an active defense strategy designed to mislead attackers through the use of traps, lures, decoys, and other tactics. Its purpose is to increase the attackersâ€™ costs and reduce the defendersâ€™ workload. The objective is to gather actionable Threat Intelligence (TI) and utilize this intelligence in our detection processes. The provided KQL sample extracts Honeypot TI from Sentinel UEBA associated with your Entra Tenant.\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| where EventSource == \"Azure AD\"\n| where tostring(DevicesInsights.ThreatIntelIndicatorType) has \"HoneypotAccess\"\n| summarize arg_max(TimeGenerated, *) by SourceIPAddress\n| project TimeGenerated, SourceIPAddress, tostring(DevicesInsights.ThreatIntelIndicatorDescription)\n\n// MITRE ATT\u0026CK\n// Network Service Discovery (T1046)"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting Aqua Blizzards",
    "query": "// ð—”ð—°ð˜ð—¶ð˜ƒð—¶ð˜ð˜† ð—£ð—¿ð—¼ð—³ð—¶ð—¹ð—²: ð—”ð—¾ð˜‚ð—® ð—•ð—¹ð—¶ð˜‡ð˜‡ð—®ð—¿ð—± ð—¶ð—ºð—½ð—¹ð—²ð—ºð—²ð—»ð˜ð—¶ð—»ð—´ ð—–ð—¹ð—¼ð˜‚ð—±ð—³ð—¹ð—®ð—¿ð—² ð—§ð˜‚ð—»ð—»ð—²ð—¹ ð˜€ð—²ð—¿ð˜ƒð—¶ð—°ð—² ð˜ð—¼ ð—°ð—¼ð—»ð—°ð—²ð—®ð—¹ ð—–2\n// https://security.microsoft.com/threatanalytics3/48213822-f322-424f-9f0d-c619cefad8c9/analystreport\n\n// âºï¸T1572 Protocol Tunneling | Aqua Blizzard uses Cloudflare Tunnel to tunnel network communications to and from a target system within a separate protocol to avoid detection or network filtering\n// âºï¸T1102 Web Service | Aqua Blizzard uses Cloudflare services for C2 communications\n// âºï¸T1090 Proxy | Aqua Blizzard uses Cloudflare Tunnel to obfuscate the host IP address of HTTP GET requests for malicious scripts/payloads\n\n// ð—žð—¤ð—Ÿ ð˜ð—¼ ð—°ð—µð—²ð—°ð—¸ ð—³ð—¼ð—¿ ð—”ð—¾ð˜‚ð—® ð—•ð—¹ð—¶ð˜‡ð˜‡ð—®ð—¿ð—± ð—®ð—°ð˜ð—¶ð˜ƒð—¶ð˜ð—¶ð—²ð˜€:\n\nlet AquaBlizzardIPs = dynamic([\"167.71.193.19\",\"146.190.129.82\",\"137.184.50.238\",\"146.190.173.21\",\"143.244.162.106\",\"128.199.170.197\",\"147.182.245.94\",\"167.99.73.109\",\"139.59.227.7\",\"159.65.226.187\",\"137.184.86.236\",\"137.184.142.176\",\"146.190.33.206\",\"68.183.185.84\",\"68.183.226.96\",\"157.230.83.122\",\"67.205.171.195\",\"139.59.236.13\",\"147.182.235.190\",\"146.190.129.82\"]);\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(90d) \n| where ActionType == @\"HttpConnectionInspected\"\n| extend ConnectInfo = todynamic(AdditionalFields)\n| extend HttpHost = ConnectInfo.host\n| where RemoteIP has_any(AquaBlizzardIPs)\n| project TimeGenerated, DeviceId, DeviceName, LocalIP, RemoteIP, HttpHost, AdditionalFields, ConnectInfo"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting Malicious Copilot Agent",
    "query": "// Hunting Malicious Copilot Agent\n\n// The \"Copilot Agent\" was a highlight at the recent Microsoft Ignite event. This AI-powered assistant is designed to help with a variety of tasks, such as answering questions, providing information, assisting with productivity tasks, and engaging in meaningful conversations.\n\n// Consider a scenario where a user account is compromised, and a threat actor uses this account to create a Copilot Agent on a highly sensitive SharePoint site that the compromised user has access to. The threat actor could then exfiltrate data by accessing the private link created by the Copilot Agent, slowly extracting information as needed by providing the relevant prompts.\n\n// To address such threats, I have created a KQL detection using Sentinel Behaviour Analytics and Power Platform solutions to monitor any potential malicious Copilot Agent creation.\n\nlet HighRiskUsers =\nBehaviorAnalytics\n| where InvestigationPriority \u003e 0\n| where UsersInsights.BlastRadius == \"High\"\n| where ActivityType == \"LogOn\"\n| where ActionType == \"ResourceAccess\"\n| distinct UserPrincipalName;\nPowerPlatformAdminActivity\n| where EventOriginalType in (\"BotCreate\", \"BotComponentCreate\", \"BotUpdateOperation-BotPublish\")\n| where ActorName has_any(HighRiskUsers)\n\n\n\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting Rockstar 2FA",
    "query": "// Hunting Rockstar 2FA: A Key Player in Phishing-as-a-Service (PaaS)\n\n// Trustwave SpiderLabs highlights the rise of Phishing-as-a-Service (PaaS) platforms, focusing on the Rockstar 2FA phishing kit. This kit uses adversary-in-the-middle (AiTM) attacks to bypass MFA, targeting Microsoft 365 credentials. The blog (link provided at comment section) provides insights into the attack flow and techniques used in the phishing campaign.\n//  I've crafted a Sentinel KQL to check if your Entra tenant is impacted by Rockstar 2FA.\n\nlet NationStateIP = \nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where RiskEventTypes_V2 has \"estsNationStateIP\"\n| project IPAddress;\nBehaviorAnalytics\n| where SourceIPAddress has_any(NationStateIP)\n| where DevicesInsights.ThreatIntelIndicatorDescription has \"Storm-1575\"\n| project TimeGenerated, UserPrincipalName, ActivityType, \nSourceIPAddress, SourceIPLocation, DevicesInsights.ThreatIntelIndicatorDescription\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting VEILDrive C2",
    "query": "// Hunting VEILDrive C2\n// https://www.hunters.security/en/blog/veildrive-microsoft-services-malware-c2\n// The analysis of ROMServer.exe using SHA256 FileProfile() revealed that the binary was first detected on September 30 and last observed on October 17, affecting 7 MDE organizations globally. According to DefendeXDR data, 22 out of 72 security vendors (approximately 30%) have identified this binary. If you are using Sentinel, the following Hunting KQL query can help determine if your organizationâ€™s endpoints are impacted by VEILDrive.\n\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(90d)  // 30 Sep First Seen and Oct 17 Last Seen\n| where ActionType == @\"HttpConnectionInspected\"\n| extend Host = parse_json(AdditionalFields)[\"host\"]\n| extend Direction = parse_json(AdditionalFields)[\"direction\"]\n| where Direction == \"Out\" and Host has \"safeshift390-my.sharepoint.com\"\n\n// MITRE ATT\u0026CK technique T1071.001: Application Layer Protocol: Web Protocols"
  },
  {
    "source": "SlimKQL",
    "name": "Hunting fake Reddit sites push Lumma Stealer malware - Part 1",
    "query": "// Hunting fake Reddit sites push Lumma Stealer malware - Part 1\n\n// https://www.bleepingcomputer.com/news/security/hundreds-of-fake-reddit-sites-push-lumma-stealer-malware/\n// https://x.com/crep1x/status/1881404758843699402\n\n// A recent cybersecurity threat where hackers have created nearly 1,000 fake websites mimicking Reddit and WeTransfer. These fraudulent sites are used to distribute the Lumma Stealer malware, which is designed to steal sensitive information such as passwords and session tokens. The campaign highlights the ongoing risks posed by info-stealer malware, which can compromise both individual and organizational data. These fake websites were found by Sekoia researcher crep1x, who shared a complete list of web pages participating in the scheme. Using this list as a threat hunting basis, here is my first MDO  threat hunting KQL.\n\nlet FakeRedditLummaS=externaldata(RawData:string)\n[h'https://gist.githubusercontent.com/qbourgue/071c333ff5182f031da3ba55cc7da1ec/raw/ec4ba396c0d1052cc8b0a69c1bad1e0e5aef2ab6/malicious_domains_impersonating_reddit_wetransfer_selfau3_dropper_lumma_stealer_20012025.txt']\n| parse RawData with FRDdomains:string;\nEmailUrlInfo\n| where TimeGenerated \u003e ago(60d)\n| join FakeRedditLummaS on $left.UrlDomain == $right.FRDdomains\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\" and LatestDeliveryAction  != \"Blocked\""
  },
  {
    "source": "SlimKQL",
    "name": "Hunting malicious oauth grant by phished user",
    "query": "// 'Tis the season â€“ Hunting Season!ðŸ˜‚\n\n// With the rise in phishing campaigns ðŸ“ˆ, threat actors are stealing tokens from phished users to deploy malicious OAuth applications on compromised cloud tenants. These applications are then used to control Exchange Online settings and spread spam. Can you swiftly detect and lock down the compromised user and OAuth app? The following KQL query leverages Sentinel UEBA identity risk information and cloudapp events to check for OAuth grants for high-risk users.\n\nlet OauthRiskLevel = dynamic([\"High\", \"Medium\"]);\nlet OauthBlastRadius = dynamic([\"High\",\"Medium\"]);\nlet RiskUsers =\nIdentityInfo\n| where RiskLevel has_any(OauthRiskLevel)\n| where BlastRadius has_any(OauthBlastRadius)\n| where RiskState == \"AtRisk\"\n| summarize arg_max(TimeGenerated, *) by AccountUPN\n| distinct AccountUPN;\nCloudAppEvents\n| where ActionType == @\"Add app role assignment grant to user.\"\n| extend OauthApp = parse_json(RawEventData)[\"Target\"][3][\"ID\"]\n| extend UPN = parse_json(RawEventData)[\"UserId\"]\n| where UPN has_any(RiskUsers)\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Identity Blast Radius 2",
    "query": "//Identity Blast Radius 2 KQL\n//https://www.linkedin.com/feed/update/urn:li:activity:7177358332662337536/\n\n//A different approach of deriving identity blast radius, instead of using DefenderXDR schema we now use Sentinel User and Entity Behavior Analytics (UEBA) IdentityInfo schema to derive the high blast radius \u0026 risk user and their associated logon devices to trace the potential attack path for remediation purposes.\n\nlet HighRiskUsers =\nIdentityInfo\n| where BlastRadius == \"High\" and ChangeSource == \"UEBA\"\n| where RiskLevel == \"High\" and RiskState == \"AtRisk\"\n| distinct AccountSID;\nDeviceLogonEvents\n| where AccountSid has_any(HighRiskUsers)\n| summarize by AccountName, DeviceName\n| sort by AccountName\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query is identifying high-risk user accounts, which could be indicative of compromised or misused valid accounts.\n// T1078.001 - Valid Accounts: Default Accounts:\n// If the high-risk users include default accounts, this technique would be relevant.\n// T1078.002 - Valid Accounts: Domain Accounts:\n// If the high-risk users include domain accounts, this technique would be relevant.\n// T1078.003 - Valid Accounts: Local Accounts:\n// If the high-risk users include local accounts, this technique would be relevant.\n// T1078.004 - Valid Accounts: Cloud Accounts:\n// If the high-risk users include cloud accounts, this technique would be relevant.\n// T1059 - Command and Scripting Interpreter:\n// The use of KQL itself can be mapped to this technique as it involves scripting and querying.\n// T1087 - Account Discovery:\n// The query is effectively performing account discovery by identifying high-risk accounts.\n// T1110 - Brute Force:\n// If the high-risk users were identified due to brute force attempts, this technique would be relevant."
  },
  {
    "source": "SlimKQL",
    "name": "Insider Threat - Monitor sensitive bulk download data email to external ",
    "query": "// Insider Threat - Monitor sensitive bulk download data email to external \n// https://www.linkedin.com/posts/activity-7193119880718520320-RO72/\n\n// This scheduled hourly Sentinel analytic rule is particular useful in detecting O365/Azure/Entra admins performing bulk download of users/groups/devices information from portal and sending that piece of information out to external via email.\n\nlet BulkDataFileNames =\nAuditLogs\n| where TimeGenerated \u003e ago(90d)\n| where OperationName == \"Download group members - finished (bulk)\" or  OperationName == \"Download devices - finished (bulk)\" or  OperationName == \"Download service principals - finished (bulk)\" or  OperationName == \"started (bulk)\"\n| where ResultDescription contains \"Filename\"\n| extend AccountUPN = tostring(InitiatedBy.user.userPrincipalName)\n| parse ResultDescription with * \"Filename:\" Filename \". Activity\" Blank\n| project Filename;\nEmailAttachmentInfo\n| where TimeGenerated \u003e ago(1h)\n| where FileName has_any(BulkDataFileNames)\n| where RecipientEmailAddress !contains \"contoso.com\" // Corporate Domain\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and data involved, the following MITRE ATT\u0026CK techniques are relevant:\n\n// Data from Information Repositories (T1213):\n// The query identifies bulk downloads of group members, devices, and service principals, which aligns with adversaries accessing data from information repositories1.\n// Exfiltration Over Web Service (T1567):\n// The query checks for email attachments sent outside the corporate domain, indicating potential data exfiltration via email2.\n// Automated Collection (T1119):\n// The use of automated scripts to download bulk data suggests automated collection techniques3."
  },
  {
    "source": "SlimKQL",
    "name": "KQL Sniper for Compromised Account (Sentinel UEBA) ",
    "query": "// KQL Sniper for Compromised Account (Sentinel UEBA) \n// https://www.linkedin.com/posts/activity-7199442661735374850-GqAK/\n\n// The KQL script provided demonstrates a high level of precision in detecting a breached account by employing Sentinel UEBA analytics, given that every criterion within the conditions is satisfied. ðŸŽ¯\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| where DevicesInsights contains \"ThreatIntelIndicatorType\"\n| extend ThreatIntel=tostring(DevicesInsights.ThreatIntelIndicatorDescription)\n| where ThreatIntel contains \"IP Address used for validating compromised Entra ID credentials\"\n| where SourceDevice == \"\" and ActivityType != \"FailedLogOn\"\n| where InvestigationPriority \u003e 0\n| project TimeGenerated, InvestigationPriority, UserPrincipalName, SourceIPAddress, SourceIPLocation, UsersInsights, DevicesInsights, ActivityInsights\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query looks for IP addresses used for validating compromised Entra ID credentials, which aligns with the use of valid accounts by adversaries.\n// T1071 - Application Layer Protocol:\n// The use of IP addresses for validation may involve application layer protocols.\n// T1087 - Account Discovery:\n// The query involves identifying user principal names, which is related to account discovery.\n// T1057 - Process Discovery:\n// Although not directly mentioned, the investigation of devices and activities can relate to process discovery.\n// T1589 - Gather Victim Identity Information:\n// The query gathers information about user identities and their associated activities."
  },
  {
    "source": "SlimKQL",
    "name": "KQL URL Protection Report",
    "query": "// KQL URL Protection Report\n// https://www.linkedin.com/posts/activity-7190735644749426691-SQlH/\n\n// For organization subscribed to Defender for Office 365, M365 or security admin would most of time go to DefenderXDR portal \"Reports\" \u003e \"Email \u0026 Collaboration\" \u003e \"URL protection report\" to check if a particular user has click on a malicious link and if it was blocked by Office 365 ATP.\n\n// Do you know you can access all these Threat Intelligence URL Click Data in CloudAppEvents table? ðŸ˜Ž\n\n// Using DefenderXDR Advanced Hunting and the below KQL will provide information similar to the \"URL Protection Report\", you can further summarize these set of data to allow you to better understand the threats currently faced by your suite of Office 365 applications that support SafeLinks and possibly tweak your SafeLinks configuration to improve your organization Office 365 application protection.ðŸ›¡ï¸\n\nCloudAppEvents\n| where ActionType == \"TIUrlClickData\"\n| where RawEventData.Workload==\"ThreatIntelligence\"\n| extend AppName = RawEventData.AppName\n| extend AccountUpn = RawEventData.UserId\n| extend UserIP = RawEventData.UserIp\n| extend ClickURL = RawEventData.Url\n| extend UrlClickAction = RawEventData.UrlClickAction\n| extend TimeOfClick = RawEventData.TimeOfClick\n| where ActivityType==\"Basic\"\n| project AppName, AccountUpn, UserIP, ClickURL, UrlClickAction, TimeOfClick\n| where UrlClickAction == 2 //User blocked from navigating to the URL\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the query is primarily focused on detecting events where users interact with potentially malicious URLs and are blocked from accessing them. This can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The query monitors URL clicks, which involves web protocols.\n// T1204.001 - User Execution: Malicious Link:\n// The detection of URL clicks and blocking access to malicious URLs aligns with detecting user execution of malicious links.\n// T1566.002 - Phishing: Spearphishing Link:\n// The query can help identify spearphishing attempts where users click on malicious links."
  },
  {
    "source": "SlimKQL",
    "name": "KQL for detecting potential hashtag#RegreSSHion abuse",
    "query": "// KQL for detecting potential hashtag#RegreSSHion abuse\n// https://www.linkedin.com/posts/activity-7214588446722465792-FwFr/\n\n// ** Assumption **\n// Firewall logs stream to CommonSecurityLog \n// 6 OpenSSH connections per min for minimum 6 hours\n// 6x60x6 = 2160 connections for past 6 hours\n// Attack source is non-distributed, triangulate by country level\n// Feel free to adjust the assumption parameters to your environment needs\n\nCommonSecurityLog\n| where TimeGenerated \u003e= ago (6h)\n| where DestinationPort == \"22\"\n| extend ip_location=geo_info_from_ip_address(SourceIP)\n| extend Country=tostring(ip_location.country)\n| where Country != \"\"\n| summarize SSH_Connection=count() by Country \n| sort by SSH_Connection desc\n| where SSH_Connection \u003e 2160\n\n// If analytics rule get triggered, this probably warrant a deeper investigation\n\n// MITRE ATT\u0026CK Mapping\n\n// This query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// Detecting SSH connections can help identify the use of valid accounts for unauthorized access.\n// T1021 - Remote Services:\n// SSH is a remote service, and monitoring connections can help detect unauthorized remote access.\n// T1036 - Masquerading:\n// High volumes of SSH connections from unexpected countries might indicate attempts to masquerade as legitimate users.\n// T1040 - Network Sniffing:\n// Although not directly related, monitoring SSH connections can help identify potential network sniffing activities if attackers are trying to capture credentials."
  },
  {
    "source": "SlimKQL",
    "name": "KQL to check Azure API spray attacks",
    "query": "// KQL to check Azure API spray attacks\n// https://www.linkedin.com/posts/activity-7197794002526457857-Y09J/\n\nApiManagementGatewayLogs\n| where TimeGenerated \u003e ago(1d)\n| where IsRequestSuccess == \"false\"\n| summarize Count=count() by CallerIpAddress\n| sort by Count desc\n\n// Block the attack IPs on your Azure Application Gateway WAF\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the following MITRE ATT\u0026CK techniques could be relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// This technique involves adversaries using web protocols to communicate with systems under their control. Failed API requests could indicate attempts to exploit web protocols.\n// T1078 - Valid Accounts:\n// Failed requests might be due to the use of invalid or compromised accounts. This technique involves adversaries using valid accounts to gain access to systems.\n// T1190 - Exploit Public-Facing Application:\n// The query could help detect attempts to exploit vulnerabilities in public-facing applications, as failed requests might indicate unsuccessful exploitation attempts.\n// T1040 - Network Sniffing:\n// If the failed requests are part of reconnaissance activities, this technique involves adversaries capturing network traffic to gather information."
  },
  {
    "source": "SlimKQL",
    "name": "KQL to check Privilege Admin failing Microsoft CA MFA enforcement",
    "query": "// KQL to check Privilege Admin failing Microsoft CA MFA enforcement\n\nlet PrivilegeAdmin =\nIdentityInfo\n| where TimeGenerated \u003e ago(14d)\n| where AssignedRoles != \"[]\" and isnotnull(AssignedRoles)\n| distinct AccountUPN;\nSigninLogs\n| where UserPrincipalName has_any(PrivilegeAdmin)\n| where ResultType == \"0\"\n| where ConditionalAccessPolicies != \"[]\"\n| mv-expand ConditionalAccessPolicies\n| extend CADisplayName = tostring(ConditionalAccessPolicies.displayName)\n| extend CAResult = tostring(ConditionalAccessPolicies.result)\n| where CADisplayName == \"Microsoft-managed: Multifactor authentication for admins accessing Microsoft Admin Portals\"\n| where CAResult == \"reportOnlyFailure\"\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// The query identifies privileged accounts and monitors their sign-in activities, which aligns with the use of valid accounts for persistence or privilege escalation1.\n// T1078.003 - Valid Accounts: Cloud Accounts:\n// Specifically focuses on cloud accounts, as it deals with Azure AD sign-in logs and conditional access policies1.\n// T1110 - Brute Force:\n// Monitoring failed conditional access policies can help detect brute force attempts where attackers try to bypass multi-factor authentication1.\n// T1556 - Modify Authentication Process:\n// The query checks for failures in multi-factor authentication policies, which could indicate attempts to modify or bypass the authentication process1."
  },
  {
    "source": "SlimKQL",
    "name": "LDAPNightmare POC Detection",
    "query": "// LDAPNightmare POC Detection\n\n// https://www.safebreach.com/blog/ldapnightmare-safebreach-labs-publishes-first-proof-of-concept-exploit-for-cve-2024-49113/\n\n// SafeBreach Labs Researchers developed a zero-click PoC exploit that crashes unpatched Windows Servers using the Windows Lightweight Directory Access Protocol (LDAP) remote code execution vulnerability.\n\nDnsEvents\n| where TimeGenerated \u003e ago(1h)\n| where Name has \"_ldap._tcp.dc._msdcs.\" or Name has \"_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.\"\n| extend LDAPQueryHost = iff((Name has \"_ldap._tcp.dc._msdcs.\"),\ntostring(split(Name, \"_ldap._tcp.dc._msdcs.\", 1)),\ntostring(split(Name, \"_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.\", 1)))\n| where isnotempty(LDAPQueryHost)\n| where not (LDAPQueryHost has \".local\" or LDAPQueryHost has \"workgroup\" or LDAPQueryHost has \"-DC\")\n| where QueryType == \"33\"\n| where ResultCode == 0\n\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Leveraging Sentinel UEBA to safeguard against OpenSSH vulnerability exploits",
    "query": "// Leveraging Sentinel UEBA to safeguard against OpenSSH vulnerability exploits \n// https://www.linkedin.com/posts/activity-7217745435635900416-ZIa7/\n\n// Using Sentinel UEBA threat intelligence data, you can identify the IP addresses of SSH BruteForce attackers targeting your cloud or on-premises environment. By adding these IPs to your firewall block list, you can enhance protection against OpenSSH vulnerability exploits, specifically CVE-2024-6387 (hashtag#RegreSSHion) and CVE-2024-6409 (hashtag#Privsep).\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| extend ThreatIntelIndicatorDescription = DevicesInsights.ThreatIntelIndicatorDescription\n| where isnotempty( ThreatIntelIndicatorDescription ) \n| where ThreatIntelIndicatorDescription contains \"destination_port_numbers: 22\" and \nThreatIntelIndicatorDescription contains \"A BruteForce indicator\"\n| distinct SourceIPAddress, SourceIPLocation\n| sort by SourceIPLocation asc\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query is designed to detect brute force attacks on SSH (port 22). This can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1110.001 - Brute Force: Password Guessing:\n// The query looks for indicators of brute force attacks, which aligns with the technique of attempting to guess passwords to gain unauthorized access.\n// T1040 - Network Sniffing:\n// While not directly related to brute force, monitoring port 22 can also help detect network sniffing activities aimed at capturing credentials.\n// T1078 - Valid Accounts:\n// Successful brute force attacks may lead to the use of valid accounts, which is another technique in the MITRE ATT\u0026CK framework."
  },
  {
    "source": "SlimKQL",
    "name": "M365 Copilot Extensions Threat Monitoring",
    "query": "// M365 Copilot Extensions Threat Monitoring\n\n// https://www.linkedin.com/posts/0x534c_cybersecurity-generativeai-m365-activity-7250789113249837056-D6rZ/\n// This just keeps getting better and better! ðŸ˜‚ I absolutely refuse to accept Message Center MC908119, which claims that â€˜Admins will lose tenant-level control over who can use Copilot agents.â€™ ðŸ˜¤ As a countermeasure, Iâ€™ve developed a Sentinel analytics rule that monitors all external URLs accessed by M365 Copilot extensions against my Threat Intelligence database for potential malicious activities. This rule is linked with a logic playbook automation to mark the user as compromised and isolate their access. ðŸ’¯ðŸ˜˜\n\n// ConfusedPilot Attack Vector:\n// https://www.linkedin.com/posts/0x534c_confusedpilot-activity-7252113628470943744-BgxN/\n\n// M365 Copilot Extensions Threat Monitoring (Sentinel)\n// https://www.linkedin.com/posts/0x534c_cybersecurity-generativeai-copilot-activity-7251091656249090048-GfSg/\n\nCloudAppEvents\n| where TimeGenerated \u003e ago(1h)\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotPlugin = tostring(CopilotData.AISystemPlugin[0].Id)\n| where isnotempty(CopilotPlugin)\n| extend PluginAccessURL = tostring(CopilotData.AccessedResources)\n| mv-expand todynamic(PluginAccessURL)\n| where PluginAccessURL has \"SiteUrl\"\n| extend Url = tostring(PluginAccessURL.SiteUrl)\n| extend Domain = tostring(parse_url(Url).Host)\n| extend Action = tostring(PluginAccessURL.Action)\n| join ThreatIntelligenceIndicator on $left.Domain == $right.DomainName\n\n\n// MITRE ATT\u0026CK\n// T1116 Browser Extensions"
  },
  {
    "source": "SlimKQL",
    "name": "M365 Copilot Plugins Inventory Analysis",
    "query": "// M365 Copilot Plugins Inventory Analysis\n\n//Is your organization overseeing who can use Copilot with installed apps and plugins from Microsoft or other providers? If so, are you aware of the plugins your Copilot users are utilizing and their usage frequency from a security risk perspective? The following KQL query offers the Security Operations team an inventory of Copilot usersâ€™ plugins and their usage frequency for analysis:\n\nCloudAppEvents\n| where TimeGenerated \u003e ago(90d)\n| where ActionType == @\"CopilotInteraction\"\n| extend UserID = tostring(RawEventData.UserId)\n| extend CopilotData = todynamic(RawEventData.CopilotEventData)\n| extend CopilotAccessResources = (CopilotData.AccessedResources)\n| extend CopilotAppHost = tostring(CopilotData.AppHost)\n| extend CopilotContexts = tostring(CopilotData.Contexts)\n| extend CopilotType = tostring(CopilotData.Type)\n| extend CopilotMessageIds = tostring(CopilotData.MessageIds)\n| extend CopilotThreadId = tostring(CopilotData.ThreadId)\n| extend CopilotPlugin = tostring(CopilotData.AISystemPlugin)\n| where CopilotPlugin != \"[]\"\n| summarize Plugin_Usage=count() by CopilotPlugin\n\n// MITRE ATT\u0026CK Mapping\n\n// Tactic: Collection (TA0009)\n// Technique: Data from Information Repositories (T1213)\n// The query extracts data from CloudAppEvents related to CopilotInteraction, which can be considered as collecting data from information repositories.\n// Tactic: Discovery (TA0007)\n// Technique: Account Discovery (T1087)\n// The extend UserID = tostring(RawEventData.UserId) line is used to identify user accounts involved in the interactions.\n// Tactic: Credential Access (TA0006)\n// Technique: Unsecured Credentials (T1552)\n// The query extends and processes various fields like CopilotData, CopilotAccessResources, and CopilotAppHost, which could potentially include sensitive information.\n// Tactic: Execution (TA0002)\n// Technique: Command and Scripting Interpreter (T1059)\n// The use of KQL itself falls under scripting and command-line interpretation for executing queries.\n// Tactic: Exfiltration (TA0010)\n// Technique: Exfiltration Over Web Service (T1567)\n// The CopilotPlugin data could be used to understand interactions with external services, which might be relevant for exfiltration activities."
  },
  {
    "source": "SlimKQL",
    "name": "MC847884 - Check iOS 16 mobile outlook users due to out of support in Sep 2024",
    "query": "// MC847884 - Check iOS 16 mobile outlook users due to out of support in Sep 2024\n\n// With iOS 18 releasing in mid September, the minimum supported iOS version would be iOS 17 as over time, Outlook for iOS on iOS 16 devices will eventually stop synchronizing email and calendar data. Do you know how many of your organization users are impacted by this new iOS released ? Use the below KQL to determine the list of impacted users.\n\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where ResultType == \"0\"\n| extend OS = tostring(DeviceDetail.operatingSystem)\n| where OS contains \"Ios 16.\"\n| where AppDisplayName == \"Outlook Mobile\"\n| distinct UserPrincipalName, OS\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query focuses on successful sign-ins, which involves the use of valid accounts1.\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// Since the query filters for the Outlook Mobile app, it involves web protocols for communication2.\n// T1087 - Account Discovery:\n// By identifying distinct user principal names, the query aligns with account discovery techniques3.\n// T1201 - Password Policy Discovery:\n// Although not directly related, successful sign-ins can imply adherence to password policies4."
  },
  {
    "source": "SlimKQL",
    "name": "Malicious FIDO2 Registration Threat Detection",
    "query": "// Malicious FIDO2 Registration Threat Detection\n// https://www.linkedin.com/posts/activity-7219732839422992385-FHSM/\n\n// In the event of a user account being compromised, a threat actor may attempt to register a passkey for persistence. This ensures that even if the account password is reset automatically, the passkey remains intact for ongoing malicious activities. By using audit logs, one can determine the IP address used for the threat actorâ€™s passkey registration and correlate this information with threat intelligence data from BehaviourAnalytics to identify potential malicious FIDO2 passkey registration and abuse.\n\nlet PasskeyAuthenticatorIP =\nAuditLogs\n| where ResultDescription contains \"User registered Fido2 Authentication Method\"\n| extend AuthenticatorIP = tostring(InitiatedBy.user.ipAddress)\n| distinct AuthenticatorIP;\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| extend ThreatIntelIndicatorDescription = DevicesInsights.ThreatIntelIndicatorDescription\n| where isnotempty( ThreatIntelIndicatorDescription )\n| where SourceIPAddress has_any(PasskeyAuthenticatorIP)\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// Description: The query identifies IP addresses associated with the registration of Fido2 authentication methods, which can be linked to the use of valid accounts for authentication.\n// Detection: Monitoring for unusual or unauthorized registration of authentication methods.\n// T1071 - Application Layer Protocol:\n// Description: The query involves network traffic analysis by examining IP addresses and their associated threat intelligence indicators.\n// Detection: Identifying suspicious network traffic patterns and correlating them with known threat indicators.\n// T1087 - Account Discovery:\n// Description: The query extends behavior analytics with threat intelligence descriptions, which can help in discovering accounts that may have been compromised.\n// Detection: Analyzing behavior analytics data to detect unusual account activities.\n// T1057 - Process Discovery:\n// Description: The queryâ€™s focus on behavior analytics and threat intelligence can also help in identifying processes or activities that are indicative of malicious behavior.\n// Detection: Correlating process activities with threat intelligence to detect malicious processes."
  },
  {
    "source": "SlimKQL",
    "name": "Mapping Threat Intelligence to MITRE ATT\u0026CK Using KQL",
    "query": "// Mapping Threat Intelligence to MITRE ATT\u0026CK Using KQL\n\n// Starting in April, Microsoft Sentinel will ingest all threat intelligence into the newly introduced ThreatIntelIndicator and ThreatIntelObjects tables. These tables support the STIX 2.1 schema, enabling the ingestion and querying of various threat intelligence objects, including identity, attack-patterns, threat-actors, and relationships.\n\n// To enhance threat analysis, I developed a KQL query that maps ThreatIntelIndicator IOCs to their respective MITRE ATT\u0026CK techniques. As demonstrated in the query below, Sentinel threat intelligence IOCs are most commonly associated with \"Web Protocols\" (T1071.001).\n\n// This crucial MITRE ATT\u0026CK technique information allows us to leverage specific techniques and IOC ObservableValues for targeted threat hunting, refining our approach based on adversary tactics and behaviors.\n\nThreatIntelIndicators\n| where TimeGenerated \u003e ago(365d)\n| where now() between (ValidFrom .. ValidUntil)\n| where isnotempty(Data.labels)\n| mv-expand Data.labels\n| where Data_labels has \"mitre\"\n| extend MitreID = parse_json(tostring(Data_labels)).Alias\n| extend MitreTechnique = parse_json(tostring(Data_labels)).FullName\n| extend MitreTechniqueName = parse_json(tostring(Data_labels)).Name\n| summarize TechniqueCount=count() by tostring(MitreID), tostring(MitreTechniqueName)\n| sort by TechniqueCount desc"
  },
  {
    "source": "SlimKQL",
    "name": "Measuring Sentinel WatchList Effectiveness using Behaviour Analytics",
    "query": "// Measuring Sentinel WatchList Effectiveness using Behaviour Analytics\n\n// Watchlists in Microsoft Sentinel enable you to correlate data from your provided sources with events in your Sentinel environment. For instance, you can create a watchlist containing high-value assets, terminated employees, or service accounts. These watchlists can be utilized in searches, detection rules, threat hunting, and response playbooks. If Sentinel UEBA is enabled, running the following KQL will generate a dashboard chart showing the number of watchlist triggers over the past three months. Notable spikes in watchlist hits can offer valuable insights and may indicate the need for further action.\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| where ActivityType == \"FailedLogOn\" and EventSource == \"Azure AD\"\n| where DevicesInsights has \"ThreatIntelIndicatorType\"\n| extend ThreatType = tostring(DevicesInsights.ThreatIntelIndicatorType)\n| where ThreatType has \"WatchList\"\n| summarize WatchListHits=count() by bin(TimeGenerated,1d)\n\n// Mitre ATT\u0026CK Mapping\n// Cloud Service Provider (T1078.004)\n// Brute Force (T1110)\n// Threat Intelligence (T1595)"
  },
  {
    "source": "SlimKQL",
    "name": "Microsoft Entra Identity Attack Threat Detection",
    "query": "//Microsoft Entra Identity Attack Threat Detection\n//https://www.linkedin.com/pulse/microsoft-entra-identity-attack-threat-detection-steven-lim-tycnc/\n\nlet companydomain = \"@contoso.com\"; //update your corporate domain\nAzureActivity\n| where TimeGenerated \u003e ago(1h)\n| where CategoryValue == \"Administrative\"\n| where Caller contains \"@\" and Caller !contains companydomain\n\n// MITRE ATT\u0026CK Mapping\n\n// This query can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to gain access to and perform actions within systems, networks, and services.\n//Relevance: The query detects administrative actions by users outside the corporate domain, which could indicate the use of compromised or unauthorized accounts.\n// T1087 - Account Discovery:\n// Description: Adversaries may attempt to get a listing of local system or domain accounts.\n// Relevance: Monitoring administrative activities helps in identifying unauthorized account usage.\n// T1098 - Account Manipulation:\n// Description: Adversaries may manipulate accounts to maintain access to credentials and permissions.\n// Relevance: Detecting administrative actions by external users can help identify attempts to manipulate accounts.\n// T1110 - Brute Force:\n// Description: Adversaries may use brute force techniques to attempt access to accounts.\n// Relevance: Unusual administrative activities by external users could indicate brute force attempts."
  },
  {
    "source": "SlimKQL",
    "name": "Monitor Abusing Intune Permissions for Lateral Movement",
    "query": "// Monitor Abusing Intune Permissions for Lateral Movement ðŸ”›\n// https://cloud.google.com/blog/topics/threat-intelligence/abusing-intune-permissions-entra-id-environments\n// The Mandiant blog discusses how attackers can exploit Intune permissions to move laterally and escalate privileges within Microsoft Entra ID environments. The Mandiant Red Team demonstrated this by abusing the DeviceManagementConfiguration.ReadWrite.All permission granted to Entra ID service principals. This permission allows the creation and modification of Intune management scripts, which can run with administrative privileges on devices. The blog also provides recommendations for preventing and detecting such attacks.\n\nAuditLogs\n| where TimeGenerated \u003e ago(1h)\n| where OperationName has \"Add app role assignment to service principal\"\n| extend InitiatedByUPN = parse_json(tostring(InitiatedBy.user)).userPrincipalName\n| extend AppRole = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[1].newValue))\n| extend ServicePrincipalName = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[6].newValue))\n| extend ServicePrincipalObjectID = parse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[5].newValue))\n| where AppRole has \"DeviceManagementConfiguration.ReadWrite.All\" or AppRole has \"RoleManagement.ReadWrite.Directory\" or AppRole has \"AppRoleAssignment.ReadWrite.All\" or AppRole has \"Application.ReadWrite.All\"\n| project TimeGenerated, OperationName, InitiatedByUPN, AppRole, ServicePrincipalName, ServicePrincipalObjectID\n\n// MITRE ATT\u0026CK Technique\n// T1098.003 - Account Manipulation: Additional Cloud Roles"
  },
  {
    "source": "SlimKQL",
    "name": "Monitor Privilege User SSPR",
    "query": "// Monitor Privilege User SSPR\n\n// In todayâ€™s post by Merill, he explains how to use Maester to monitor SSPR settings for admin accounts. I agree that administrators with sensitive roles should exclusively use phishing-resistant authentication methods, which would prevent them from resetting their passwords. However, not all organizations have the cyber maturity to transition all admins to phishing-resistant authentication. Therefore, SecOps should continue to monitor SSPR for privileged users in the Entra tenant. The KQL below provides the necessary monitoring \n\nlet queryperiod = 30d;\nlet queryfrequency = 1h;\nlet PrivilegeUsers = (\n    IdentityInfo\n    | where TimeGenerated \u003e ago(queryperiod)\n    | mv-expand AssignedRoles\n    | where AssignedRoles matches regex 'Admin'\n    | summarize by tolower(AccountUPN));\nAuditLogs\n| where TimeGenerated \u003e ago(queryfrequency)\n| where ResultDescription == \"User started self-service password reset operation.\"\n| extend AccountUPN = tolower(InitiatedBy.user.userPrincipalName)\n| extend IPAdress = InitiatedBy.user.ipAddress\n| where AccountUPN in (PrivilegeUsers)\n\n// MITRE ATT\u0026CK Mapping\n// Privilege Escalation (T1078.004 - Valid Accounts: Cloud Accounts):\n// The query identifies privileged users by checking for roles that match â€˜Adminâ€™. This is related to the use of valid accounts with elevated privileges.\n// Credential Access (T1110.001 - Brute Force):\n// Monitoring self-service password reset operations can help detect potential brute force attempts or misuse of password reset functionalities.\n// Defense Evasion (T1078 - Valid Accounts):\n// By focusing on privileged accounts, the query helps in identifying if legitimate accounts are being used to evade detection mechanisms.\n// Initial Access (T1078.004 - Valid Accounts: Cloud Accounts):\n// The detection of self-service password reset operations by privileged users can indicate an initial access attempt using valid credentials."
  },
  {
    "source": "SlimKQL",
    "name": "Monitoring Copilot Data Exfiltration via Graph API",
    "query": "// Monitoring Copilot Data Exfiltration via Graph API\n\nlet CopilotGraphExfilCmds = dynamic([\"interactionHistory\",\"getAllEnterpriseInteractions\"]);\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(1h)\n| extend ParseData = parse_url(RequestUri)\n| where ParseData has_any (CopilotGraphExfilCmds)"
  },
  {
    "source": "SlimKQL",
    "name": "Monitoring Cross-Tenant Abuse by Threat Actors",
    "query": "// Monitoring Cross-Tenant Abuse by Threat Actors\n\n// Lina Lauâ€™s blog post on Xintra.org provides an insightful look into how attackers can misuse Microsoft Entra IDâ€™s cross-tenant synchronization feature to move laterally between tenants with P1 and P2 licenses. By exploiting this feature, attackers can create new accounts in a victimâ€™s tenant, enabling them to persist or move laterally even if their initial access is revoked. (The blog post link will be shared in the comment section.)\n\n// Defenders with P1 or P2 licenses should use the Sentinel KQL provided below to monitor for any changes to their Entra Cross-Tenant settings, helping to detect potential abuse of the cross-tenant synchronization. The KQL code can be downloaded from my SlimKQL GitHub Repository, which is featured on my LinkedIn profile (search for â€œMonitoring Cross-Tenant Abuse by Threat Actorsâ€).\n\n// https://www.xintra.org/blog/lateral-movement-entraid-cross-tenant-synchronization\n\nAuditLogs\n| where TimeGenerated \u003e ago(1h)\n| where Category == \"CrossTenantAccessSettings\"\n| where OperationName == \"Update the company default cross-tenant access setting\" or \nOperationName == \"Add a partner to cross-tenant access setting\" or\nOperationName == \"Update a partner cross-tenant access setting\""
  },
  {
    "source": "SlimKQL",
    "name": "Monitoring restricted management administrative units abuse",
    "query": "// Monitoring restricted management administrative units abuse\n// https://securitylabs.datadoghq.com/articles/abusing-entra-id-administrative-units/\n\n// Yesterday, I read an insightful article by Katie Knowles on the potential abuse of the new Entra Restricted Management Units (currently in preview) for sticky persistence if a global administrator or privileged role administrator is compromised. Although exploiting this feature requires a high-privileged role, it remains a significant risk for organizations that do not implement privileged role access management using PIM. The possibility of high-privileged roles being compromised through AiTM attacks, even with MFA enforced, makes this a critical issue.\n// Therefore, it is crucial for SecOps to monitor the creation of restricted AUs to detect potential sticky persistence abuses. This is particularly important due to the lack of visibility of the members and the inability of regular privileged role admins to reset user credentials within these restricted AUs. In my SlimKQL GitHub repository, I have shared a Sentinel KQL rule to monitor the creation of Restricted AUs, enabling SecOps to take necessary mitigation actions.\n\n// Hourly Sentinel Monitoring Rule\n\nAuditLogs\n| where TimeGenerated \u003e (1h)\n| where (OperationName == \"Add administrative unit\" and \nparse_json(tostring(TargetResources[0].modifiedProperties))[2].displayName == \"IsMemberManagementRestricted\" and\nparse_json(tostring(parse_json(tostring(TargetResources[0].modifiedProperties))[2].newValue))[0] == true) or\nOperationName == \"Add member to restricted management administrative unit\"\n| extend RestrictedAUs = TargetResources[0].displayName\n| extend UPN = parse_json(tostring(InitiatedBy.user)).userPrincipalName\n| extend IPAddress = parse_json(tostring(InitiatedBy.user)).ipAddress\n| project TimeGenerated, OperationName, RestrictedAUs, UPN, IPAddress, AdditionalDetails\n\n// MITRE ATT\u0026CK Technique Mapping\n\n// Tactic: Initial Access\n// Technique: Valid Accounts (T1078)\n// Sub-technique: Domain Accounts (T1078.002)\n// Description: The query identifies actions performed by specific user accounts, which could indicate the use of valid accounts to gain initial access.\n\n// Tactic: Persistence\n// Technique: Account Manipulation (T1098)\n// Sub-technique: Additional Cloud Credentials (T1098.001)\n// Description: Adding administrative units and modifying properties can be a form of account manipulation to maintain persistence within the environment.\n\n// Tactic: Privilege Escalation\n// Technique: Abuse Elevation Control Mechanism (T1548)\n// Sub-technique: Bypass User Account Control (T1548.002)\n// Description: The operation of adding administrative units with restricted member management could be an attempt to escalate privileges"
  },
  {
    "source": "SlimKQL",
    "name": "NEW Microsoft Graph API Identity Protection KQL Detection",
    "query": "// NEW Microsoft Graph API Identity Protection KQL Detection\n// https://www.linkedin.com/posts/activity-7194389287620997120-OVjs/\n\n// With the new developments from Microsoft Entra Blog, it is now possible to identify user making an abnormally high number of calls to MS Graph and AAD Graph compared to that userâ€™s baseline, which will help identify both compromised users and insider threats scavenging for intel. As this is an offline detection, it may take up to 48 hours to surface in the reports and aggregate the user graph activities.\n\nlet SuspiciousGraphUserIP =\nSigninLogs\n| where TimeGenerated \u003e ago(48h)\n| where RiskEventTypes contains \"suspiciousAPITraffic\"\n| distinct IPAddress;\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(48h)\n| where IPAddress has_any (SuspiciousGraphUserIP)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1071.001 - Application Layer Protocol: Web Protocols\n// The detection of suspicious API traffic suggests the use of web protocols for communication, which falls under this technique.\n// T1078 - Valid Accounts\n// The use of valid accounts to perform suspicious activities, such as accessing Microsoft Graph, can be inferred from the logs.\n// T1087.004 - Account Discovery: Cloud Account\n// The query involves analyzing sign-in logs and activity logs, which can be related to discovering and using cloud accounts.\n// T1070.004 - Indicator Removal on Host: File Deletion\n// If the suspicious activity involves attempts to delete logs or traces, this technique might be relevant.\n// T1020 - Automated Exfiltration\n// Suspicious API traffic might indicate automated data exfiltration attempts."
  },
  {
    "source": "SlimKQL",
    "name": "NEW Real-time Anomalous Token Detection",
    "query": "// NEW Real-time Anomalous Token Detection\n// https://www.linkedin.com/posts/activity-7194744137185701889-XCcu/\n\n// With the new developments from Microsoft Entra Blog, it is now possible to perform Real-time Anomalous Token Detection automatically disrupts token replay attacks in real-time when paired with a risk-based Conditional Access for sign-ins (E.g. RiskLevel = High)\n\nlet AnomalousTokenRequestId=\nSecurityAlert\n| where AlertName == \"Anomalous Token\"\n| mv-expand todynamic(Entities)\n| project Entities\n| extend RequestId = tostring(Entities.RequestId)\n| distinct RequestId;\nAADUserRiskEvents\n| where RequestId has_any(AnomalousTokenRequestId)\n| where DetectionTimingType == \"realtime\"\n| where RiskLevel == \"high\" and RiskState == \"atRisk\"\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL code is designed to detect anomalous token requests and high-risk user events in Azure Active Directory (AAD). Here are the relevant MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to maintain access to victim systems.\n// Relevance: The detection of anomalous tokens can indicate the use of compromised or unauthorized accounts.\n// T1071 - Application Layer Protocol:\n// Description: Adversaries may communicate using application layer protocols to avoid detection.\n// Relevance: Anomalous token requests might involve unusual or unauthorized use of application layer protocols.\n// T1556 - Modify Authentication Process:\n// Description: Adversaries may modify authentication mechanisms to gain access.\n// Relevance: High-risk events in AAD can indicate attempts to bypass or manipulate authentication processes.\n// T1110 - Brute Force:\n// Description: Adversaries may use brute force techniques to obtain valid credentials.\n// Relevance: High-risk and real-time detection of user risk events can be indicative of brute force attempts."
  },
  {
    "source": "SlimKQL",
    "name": "Nation State Actors via Microsoft Graph",
    "query": "// Nation State Actors via Microsoft Graph\n// https://www.linkedin.com/posts/activity-7194188372691607552-dtJv/\n\n// IP addresses identified by the Microsoft Threat Intelligence Center (MSTIC) as being linked to state-sponsored entities or cybercriminal organizations are reportedly exploiting the Graph API. As of April 11, Microsoft Graph activity logs have become widely accessible. It is highly recommended to begin aggregating these logs if you havenâ€™t already. The trend of malicious actors utilizing the Graph API as a platform for their illicit activities is on the rise.\n\nlet NationStateIP =\n    SigninLogs\n    | where TimeGenerated \u003e ago(90d)\n    | where RiskEventTypes_V2 contains \"estsNationStateIP\"\n    | distinct IPAddress;\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(90d)\n| where IPAddress has_any(NationStateIP)\n| count\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query is primarily focused on detecting suspicious IP addresses and their activities, which can be mapped to several MITRE ATT\u0026CK techniques:\n\n// T1071.001 - Application Layer Protocol: Web Protocols\n// The query looks for suspicious IP addresses in activity logs, which can be related to the use of web protocols for communication.\n// T1078 - Valid Accounts\n// The detection of nation-state IPs in sign-in logs can indicate the use of valid accounts by adversaries.\n// T1078.003 - Valid Accounts: Local Accounts\n// If the nation-state IPs are using local accounts, this technique is relevant.\n// T1078.004 - Valid Accounts: Cloud Accounts\n// If the nation-state IPs are using cloud accounts, this technique is relevant.\n// T1589.001 - Gather Victim Identity Information: Credentials\n// The query might help in identifying attempts to gather credentials through nation-state IPs."
  },
  {
    "source": "SlimKQL",
    "name": "New Threat Actor Group Signature",
    "query": "// New Threat Actor Group Signature\n// https://www.linkedin.com/posts/activity-7193281542645768192-9ZIM/\n\n// I just discovered a new threat actor group signature that started mounting aggressive spray about 2.5 weeks back on my tenant. If you run the below KQL on your Sentinel signin logs, you should probably see some hits on your tenant. Do shared your intel in the comment for community awareness if you observe it. ðŸ™\n\n// This particular group are abusing the \"OfficeHome\" app and has the firefox 116 as their user agent. The method is similar to earlier this year February Proofpoint post when they uncovered a malicious campaign on cloud account take over (ATO). ðŸ«¡ \n\n// Ongoing Malicious Campaign Impacting Microsoft Azure Cloud Environments\n// Link: https://lnkd.in/d7A_evhi\n\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| where ResultType == \"50053\" or ResultType == \"50126\"\n| where AppDisplayName == \"OfficeHome\"\n| where UserAgent == \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/116.0\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the filters and the context of the query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078 - Valid Accounts:\n// The query is looking for failed login attempts, which can be associated with attempts to use valid accounts with incorrect credentials.\n// T1110 - Brute Force:\n// The presence of multiple failed login attempts (ResultType 50126) suggests a brute force attack where an adversary is trying different passwords.\n// T1212 - Exploitation for Credential Access:\n// The specific user agent and application filters might indicate an attempt to exploit known vulnerabilities in the â€œOfficeHomeâ€ application or the browser to gain credential access.\n// T1071 - Application Layer Protocol:\n// The use of a specific user agent string can be related to the use of application layer protocols for communication, which might be part of the adversaryâ€™s tactics."
  },
  {
    "source": "SlimKQL",
    "name": "Part 1: Custom DefenderXDR KQL detection for fake CrowdStrike email domain",
    "query": "// Part 1: Custom DefenderXDR KQL detection for fake CrowdStrike email domain\n// https://www.linkedin.com/posts/activity-7220616094514917377-a-lR/\n\n// Configure as Detect \u0026 Purge:\n\nEmailEvents\n| where Timestamp \u003e ago(1h)\n| where EmailDirection == \"Inbound\"\n| where LatestDeliveryAction == \"Delivered\"\n| where SenderFromDomain contains \"crowdstrike\"\n| where SenderFromDomain !endswith \"crowdstrike.com\" and\nSenderFromDomain !endswith \"litmos.com\" and\nSenderFromDomain !endswith \"zoom.us\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the filtering criteria, the following MITRE ATT\u0026CK techniques are relevant:\n\n// Phishing (T1566):\n// T1566.001: Spearphishing Attachment\n// T1566.002: Spearphishing Link\n// T1566.003: Spearphishing via Service\n// The query is looking for inbound emails that might be part of a phishing campaign, especially those masquerading as legitimate emails from known domains but with slight variations.\n// Impersonation (T1071):\n// T1071.003: Application Layer Protocol\n// The query checks for emails from domains that contain â€œcrowdstrikeâ€ but are not from the legitimate â€œcrowdstrike.comâ€ domain, indicating potential impersonation attempts.\n// Command and Control (T1071):\n// T1071.001: Web Protocols\n// The query might help identify emails that could be part of a command and control communication setup, especially if the emails are from suspicious domains."
  },
  {
    "source": "SlimKQL",
    "name": "Part 2: DefenderXDR KQL detection for fake CrowdStrike domain URL",
    "query": "// Part 2: DefenderXDR KQL detection for fake CrowdStrike domain URL\n// https://www.linkedin.com/posts/activity-7220748665924042752-pRST/\n\n// Hourly custom detection: Detect \u0026 Purge\n\nEmailUrlInfo\n| where Timestamp \u003e ago(1h)\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| where LatestDeliveryAction == \"Delivered\"\n| where UrlDomain contains \"crowdstrike\"\n| where UrlDomain !endswith \"crowdstrike.com\"\n| where SenderFromDomain !endswith \"crowdstrike.com\" and\nSenderFromDomain !endswith \"litmos.com\" and\nSenderFromDomain !endswith \"zoom.us\"\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the query can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// Phishing (T1566):\n// The query is designed to detect phishing attempts by identifying suspicious URLs in inbound emails.\n// Spearphishing Link (T1566.002):\n// Specifically targets emails with links that may lead to malicious sites, excluding known legitimate domains.\n// Indicator Removal on Host (T1070):\n// By filtering out legitimate domains, the query aims to identify attempts to bypass detection mechanisms.\n// Command and Control (T1071):\n// The presence of suspicious URLs could indicate attempts to establish command and control channels."
  },
  {
    "source": "SlimKQL",
    "name": "Password Spraying Detection in Active Directory",
    "query": "// Password Spraying Detection in Active Directory\n// https://www.semperis.com/blog/password-spraying-detection-in-active-directory/\n\n// Event ID 4625\n// Mitre ATT\u0026CK T1110\n\nAnomalies\n| where TimeGenerated \u003e ago(1d)\n| where RuleName == \"Attempted user account bruteforce per logon type\"\nor RuleName == \"Attempted user account bruteforce\"\n| where Score \u003e 0.5"
  },
  {
    "source": "SlimKQL",
    "name": "Phishing campaigns leveraging Microsoft Forms",
    "query": "// Phishing campaigns leveraging Microsoft Forms\n// https://www.linkedin.com/posts/activity-7223704172028665858-99AA/\n\n// The below KQL will help you pick up some forms phisherðŸ«¡\n\nEmailUrlInfo\n| where Timestamp \u003e ago(1h)\n| join EmailEvents on NetworkMessageId\n| extend AuthDetail = parse_json(AuthenticationDetails)\n| where EmailDirection == \"Inbound\"\n| where UrlDomain == \"forms.microsoft.com\"\n| where AuthDetail.SPF == \"fail\" and AuthDetail.DKIM == \"fail\" and AuthDetail.DMARC == \"fail\"\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1566.001 - Phishing: Spearphishing Attachment:\n// The query is looking for inbound emails with specific characteristics that could indicate a phishing attempt, especially with failed authentication checks.\n// T1071.001 - Application Layer Protocol: Web Protocols:\n// The use of URLs in emails, particularly those pointing to forms.microsoft.com, can be indicative of attempts to use web protocols for malicious purposes.\n// T1589.002 - Gather Victim Identity Information: Email Addresses:\n// The focus on inbound emails and specific domains suggests an attempt to gather or exploit email addresses.\n// T1078 - Valid Accounts:\n// The failed authentication checks (SPF, DKIM, DMARC) could indicate attempts to use or spoof valid accounts."
  },
  {
    "source": "SlimKQL",
    "name": "RMM Hunting with Sentinel TI",
    "query": "ThreatIntelIndicators\n| where TimeGenerated \u003e ago(365d)\n| where now() between (ValidFrom .. ValidUntil)\n| where isnotempty(Data.labels)\n| mv-expand Data.labels\n| where Data_labels has \"mitre\"\n| extend MitreID = parse_json(tostring(Data_labels)).Alias\n| where MitreID == \"T1219\" // Remote Access Tools \n| summarize IOCcount=count() by ObservableKey, Confidence\n| sort by IOCcount desc"
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel - Threat Hunting DNS Tunneling",
    "query": "// Threat Hunting DNS Tunneling \n\n// DNS tunneling is a method used by threat actors to encode non-DNS traffic within DNS packets. This technique allows data to bypass traditional network firewalls, creating covert channels for data exfiltration and infiltration. By centralizing your enterprise DNS logging and utilizing Microsoft Sentinel SIEM, you can leverage my Sentinel KQL (DnsEvents Schema) to hunt for DNS tunneling activities. Additionally, Iâ€™ve provided a DefenderXDR KQL for Microsoft Defender for Endpoint, which uses the DeviceEvents schema for DNS tunneling threat hunting. For further context, Iâ€™m sharing an article by Palo Alto Networks Unit42 that details a DNS tunneling campaign using DNS queries for tracking and data exfiltration, highlighting the importance of the threat hunting KQL Iâ€™ve shared.\n\n// DNS tunneling use either A records or TXT records for an infected host to receive data\n// To exfiltrate data to a C2 server, the DNS queries for infected host will spike with long queried hostname\n\n// Query 1 - Locate suspicious DNS tunneling host (ClientIP)\nlet DNSHostnameLengthCheck = 40;\nDnsEvents\n| where TimeGenerated \u003e ago(90d) \n| where SubType == \"LookupQuery\"\n| where QueryType==\"A\" or QueryType==\"TXT\"\n| where strlen(Name) \u003e DNSHostnameLengthCheck\n| summarize DNSQueriedHost=dcount(Name), TotalQueryType=dcount(QueryType) by ClientIP\n| sort by TotalQueryType, DNSQueriedHost desc\n\n// Query 2 - Analyze suspected DNS tunneling top host from Query 1 by examining the DNS query in detail\n// Look for sample generated DNS request like below:\n// 0018786966.96428380.04.5E43287B03114C04A64F68C0C23E44F4.n.156.887.empty.6_1._t_i.3000.explorer_exe.156.rc2.a4h9uploading[.]com\n\nlet DNSHostnameLengthCheck = 40;\nDnsEvents\n| where TimeGenerated \u003e ago(90d) \n| where SubType == \"LookupQuery\"\n| where ClientIP == \"10.10.10.10\" // Replace top ClientIP from Query 1\n| where strlen(Name) \u003e DNSHostnameLengthCheck\n| distinct Name\n\n// MITRE ATT\u0026CK MAPPING\n// Application Layer Protocol: DNS (T1071.004)"
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel Alerts \u0026 MITRE ATT\u0026CK Analysis",
    "query": "// Sentinel Alerts \u0026 MITRE ATT\u0026CK Analysis\n// https://www.linkedin.com/posts/activity-7195301674301759488-rMQS/\n\n// The Microsoft Sentinel MITRE ATT\u0026CK (Preview) blade offers a comprehensive overview of all Sentinel detections aligned with the MITRE ATT\u0026CK technique matrix. As a Security Operations Center (SOC) analyst overseeing analytic rules, are you aware of which MITRE Techniques are activated most frequently or infrequently? Running the subsequent KQL query will unveil the technique adversaries most commonly employ. Evaluate which techniques are triggered most or least often in comparison to your Microsoft Sentinel MITRE ATT\u0026CK (preview) coverage. This analysis is crucial to determine if your analytic rules are sufficiently robust to identify these frequently used techniques.\n\n// KQL - Summarization of Techniques Triggered\n\nSecurityAlert\n| where TimeGenerated \u003e ago(90d)\n| mv-expand todynamic(Techniques)\n| extend MitreAttackTechniques = tostring(Techniques)\n| where MitreAttackTechniques != \"\"\n| summarize Technique_Count=count() by MitreAttackTechniques\n| sort by Technique_Count desc\n\n// MITRE ATT\u0026CK Mapping\n\n//The KQL code is designed to map security alerts to specific MITRE ATT\u0026CK techniques. Each technique identified in the Techniques field corresponds to a specific tactic or technique in the MITRE ATT\u0026CK framework. Here are some common techniques that might be detected:\n\n// T1078: Valid Accounts: Detection of compromised accounts.\n// T1059: Command and Scripting Interpreter: Detection of script execution.\n// T1105: Ingress Tool Transfer: Detection of tools being transferred into the environment.\n// T1027: Obfuscated Files or Information: Detection of obfuscated files or information."
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel All-In-One IP ThreatHunt",
    "query": "// Sentinel All-In-One IP ThreatHunt\n// https://www.linkedin.com/pulse/microsoft-sentinel-kql-solo-leveling-steven-lim-8hsqc/\n\n// This KQL query searches across these Sentinel log tables for the ip variable that is defined at the start:\n// Anomalies, CloudAppEvents, CommonSecurityLog, DeviceEvents, DeviceFileEvents, DeviceInfo, DeviceLogonEvents, AzureActivity DeviceNetworkEvents, EmailEvents, OfficeActivity, SecurityEvent, ThreatIntelligenceIndicator, UrlClickEvents, BehaviorAnalytics\n\nlet ip = \"127.0.0.1\";\nsearch in (Anomalies,CloudAppEvents,CommonSecurityLog,DeviceEvents,DeviceFileEvents,DeviceInfo,DeviceLogonEvents,AzureActivity,\nDeviceNetworkEvents,EmailEvents,OfficeActivity,SecurityEvent,ThreatIntelligenceIndicator,UrlClickEvents,BehaviorAnalytics)\nTimeGenerated between (ago(1d) .. now())\nand (\n// ** Events initiated by this IP **\nDestinationIpAddress == ip          // Anomalies, UrlClickEvents  \nor IPAddress == ip                  // CloudAppEvents\nor RemoteIP == ip                   // CommonSecurityLog, DeviceEvents, DeviceLogonEvents, DeviceNetworkEvents  \nor FileOriginIP == ip               // DeviceFileEvents\nor SenderIPv4 == ip                 // EmailEvents\nor ClientIP == ip                   // OfficeActivity\nor NetworkDestinationIP == ip       // ThreatIntelligenceIndicator\nor DestinationIPAddress == ip       // BehaviorAnalytics \n//\n// ** Events affecting this IP **\nor SourceIpAddress == ip            // Anomalies\nor SourceIP == ip                   // CommonSecurityLog, DeviceEvents\nor CallerIpAddress == ip            // AzureActivity\nor RequestSourceIP == ip            // DeviceFileEvents\nor PublicIP == ip                   // DeviceInfo\nor LocalIP == ip                    // DeviceNetworkEvents\nor ClientIPAddress == ip            // SecurityEvent\nor NetworkSourceIP == ip            // ThreatIntelligenceIndicator\nor SourceIPAddress == ip            // BehaviorAnalytics \n)\n\n// MITRE ATT\u0026CK Mapping\n\n// EmailEvents (SenderIPv4): Phishing (T1566)\n// UrlClickEvents (DestinationIpAddress): Drive-by Compromise (T1189) \n// DeviceLogonEvents (RemoteIP): Remote Services (T1021)\n// DeviceFileEvents (FileOriginIP): Indicator Removal on Host (T1070)\n// DeviceNetworkEvents (LocalIP): Network Service Scanning (T1046)"
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel All-In-One UPN ThreatHunt",
    "query": "// Sentinel All-In-One UPN ThreatHunt\n// https://www.linkedin.com/pulse/microsoft-sentinel-kql-solo-leveling-steven-lim-8hsqc/\n\n// This KQL query searches across these Sentinel log tables for the UPN variable that is defined at the start:\n// Anomalies, CloudAppEvents, CommonSecurityLog, DeviceEvents, DeviceFileEvents, DeviceLogonEvents, AzureActivity, EmailEvents, OfficeActivity, SecurityEvent, BehaviorAnalytics\n\nlet upn = \"FirstName.LastName@onmicrosoft.com\";\nsearch in (Anomalies,CloudAppEvents,CommonSecurityLog,DeviceEvents,DeviceFileEvents,DeviceLogonEvents,AzureActivity,\nEmailEvents,OfficeActivity,SecurityEvent,BehaviorAnalytics)\nTimeGenerated between (ago(1d) .. now())\nand (\n// ** Events initiated by this UPN **\nUserPrincipalName == upn                        // Anomalies, BehaviorAnalytics \nor tostring(RawEventData.UserId) == upn         // CloudAppEvents \nor SourceUserName == upn                        // CommonSecurityLog\nor AccountName == upn                           // DeviceEvents\nor InitiatingProcessAccountUpn  == upn          // DeviceFileEvents, DeviceLogonEvents  \nor Caller == upn                                // AzureActivity\nor RecipientEmailAddress == upn                 // EmailEvents\nor SenderMailFromAddress == upn                 // EmailEvents\nor UserId == upn                                // OfficeActivity\nor Entities contains upn                        // SecurityEvent\n) \n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the fields and data sources used in the KQL query, here are some potential MITRE ATT\u0026CK techniques that could be detected:\n\n// T1078 - Valid Accounts: The query checks for events where the UPN is used, which can help identify the use of valid accounts across different services and logs.\n// T1059 - Command and Scripting Interpreter: If the DeviceEvents or DeviceFileEvents tables include script execution logs, this technique could be relevant.\n// T1071 - Application Layer Protocol: The EmailEvents table checks for email activities, which can be mapped to this technique if emails are used for command and control.\n// T1106 - Execution: The DeviceLogonEvents and DeviceFileEvents tables can help detect execution of processes or files.\n// T1110 - Brute Force: The SecurityEvent table can be used to detect brute force attempts if it includes authentication logs.\n// T1040 - Network Sniffing: If CommonSecurityLog includes network traffic logs, this technique could be relevant.\n// T1087 - Account Discovery: The AzureActivity table can help detect account discovery activities in Azure environments."
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel KQL Detection for ShadowHound",
    "query": "// ðŸš¨ New Sentinel KQL Detection for ShadowHound ðŸš¨\n// https://blog.fndsec.net/2024/11/25/shadowhound/\n\n// I'm excited to share that I've developed a Sentinel KQL detection specifically for identifying the use of ShadowHound, a powerful tool developed by Friends-Security. While ShadowHound offers advanced enumeration capabilities for Active Directory environments, it's crucial to be aware of its potential misuse by threat actors and red teamers for reconnaissance purposes.\n// ðŸ” Key Features of ShadowHound:\n\n// - Comprehensive enumeration of Active Directory objects\n// - Utilizes both ADWS and LDAP for versatile data gathering\n// - Designed to enhance security assessments and audits\n\n// ðŸš¨ Potential Risks:\n// - Reconnaissance by Threat Actors: ShadowHound can be exploited by malicious actors to gather detailed information about your network, potentially leading to targeted attacks.\n// - Red Team Operations: While useful for security assessments, red teamers can use this tool to simulate attacks, highlighting vulnerabilities that need immediate attention.\n\n// ðŸ” My Sentinel KQL Detection: To help mitigate these risks, I've created a Sentinel KQL detection rule that identifies ShadowHound activity within your network. This detection rule enhances your ability to monitor and respond to potential threats effectively.\n\n// Sentinel detection for ShadowHound\n\n// The effective method to detect ShadowHound is to \n// track identities that read an exceptionally high number\n// of LDAP records within a specific time frame similar to SharpHound\n\nSecurityEvent\n| where TimeGenerated \u003e ago(1h)\n| where EventID == 4662\n| where not (SubjectUserSid contains \"S-1-5-18\")\n| where AccessMask == \"0x10\"\n| where strlen(Properties) \u003e= 2000\n\n// MITRE ATT\u0026CK\n// Technique: T1069 Permission Groups Discovery\n// Tactic: TA0007 Discovery"
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel Timeroasting KQL detection",
    "query": "// Sentinel Timeroasting KQL detection\n\n// https://github.com/SecuraBV/Timeroast\n// Timeroasting takes advantage of Windows' NTP authentication mechanism, allowing unauthenticated attackers to effectively request a password hash of any computer or trust account by sending an NTP request with that account's RID. This is not a problem when computer accounts are properly generated, but if a non-standard or legacy default password is set this tool allows you to brute-force those offline.\n\n// By default, Windows checks NTP (Network Time Protocol) roughly once every hour\n// Abnormal NTP connections indicate possible timeroasting activities conducted\n\nlet TimeRoastingTrigger = 3;\nlet NTPDeviceIPs =\nCommonSecurityLog\n| where TimeGenerated \u003e ago(1h)\n| where ApplicationProtocol has \"ntp\"\n| where ipv4_is_private(DestinationIP)\n| distinct DestinationIP;\nDeviceNetworkEvents\n| where LocalIP has_any(NTPDeviceIPs)\n| where Protocol == \"Udp\"\n| summarize Count=count() by RemoteIP\n| sort by Count desc\n| where Count \u003e TimeRoastingTrigger \n\n\n// MITRE ATT\u0026CK"
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel UEBA Privilege Escalation Detection",
    "query": "// Sentinel UEBA Privilege Escalation Detection\n\n// Here is a list of interesting privilege escalation articles I read over the past weeks and my thoughts on potential solution to monitor all these escalations:\n\n// UnOAuthorized: Privilege Elevation Through Microsoft Applications\n// https://www.semperis.com/blog/unoauthorized-privilege-elevation-through-microsoft-applications/\n\n// Abusing PIM-related application permissions in Microsoft Graph - Part 1\n// https://www.emiliensocchi.io/abusing-pim-related-application-permissions-in-microsoft-graph-part-1/\n\n// Abusing PIM-related application permissions in Microsoft Graph - Part 2\nhttps://www.emiliensocchi.io/abusing-pim-related-application-permissions-in-microsoft-graph-part-2/\n\n// Abusing PIM-related application permissions in Microsoft Graph - Part 3\n// https://www.emiliensocchi.io/abusing-pim-related-application-permissions-in-microsoft-graph-part-3/\n\n// Sentinel UEBA Detection:\n\nAnomalies\n| where TimeGenerated \u003e ago(1h)\n| where RuleName == \"UEBA Anomalous Privilege Granted\"\n| where ActivityInsights.ActionUncommonlyPerformedInTenant == \"True\"\n\n// #Sentinel #UEBA #PrivilegeEscalation\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// Privilege Escalation (T1078):\n// The query detects anomalous privilege grants, which can be associated with unauthorized access or privilege escalation attempts.\n// Account Manipulation (T1098):\n// The detection of uncommon actions related to privilege grants can indicate account manipulation activities.\n// Credential Access (T1078):\n// Unusual privilege grants might also be related to attempts to gain access to credentials or escalate privileges."
  },
  {
    "source": "SlimKQL",
    "name": "Sentinel analytics rule for Copilot Studio Bot creation detection",
    "query": "// Sentinel analytics rule for Copilot Studio Bot creation detection\n\nAuditLogs\n| where TimeGenerated \u003e ago(1h)\n| where Identity == \"Power Virtual Agents Service\"\n| where OperationName == \"Add application\"\n| where TargetResources contains \"(Microsoft Copilot Studio)\"\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the operations and filters used in the KQL query, the following MITRE ATT\u0026CK techniques are relevant:\n\n// T1078: Valid Accounts - The query is looking for specific identities performing operations, which can be related to the use of valid accounts to perform actions1.\n// T1098: Account Manipulation - The operation â€œAdd applicationâ€ could be associated with account manipulation activities, such as adding new applications or modifying existing ones2.\n// T1566: Phishing - If the â€œAdd applicationâ€ operation is part of a broader phishing campaign to gain access to resources, this technique might be relevant3."
  },
  {
    "source": "SlimKQL",
    "name": "T1555.003 - Credentials from Web Browsers",
    "query": "// https://www.linkedin.com/posts/0x534c_cybersecurity-t1555-credentialtheft-activity-7324667429035368448-t6om\n\nThreatIntelIndicators\n| where TimeGenerated \u003e ago(365d)\n| where now() between (ValidFrom .. ValidUntil)\n| where isnotempty(Data.labels)\n| mv-expand Data.labels\n| where Data_labels has \"mitre\"\n| extend MitreID = parse_json(tostring(Data_labels)).Alias \n| where MitreID == \"T1555.003\" // Credentials from Web Browsers\n| summarize IOCcount=count() by ObservableKey, Confidence\n| sort by IOCcount desc"
  },
  {
    "source": "SlimKQL",
    "name": "The Hunt for Blob Phishing Mail Domain",
    "query": "// ð—§ð—µð—² ð—›ð˜‚ð—»ð˜ ð—³ð—¼ð—¿ ð—•ð—¹ð—¼ð—¯ ð—£ð—µð—¶ð˜€ð—µð—¶ð—»ð—´ ð— ð—®ð—¶ð—¹ ð——ð—¼ð—ºð—®ð—¶ð—»\n\n// In some phishing kit, the attacker generated the landing page in a blob to remain stealthy and all of these emails usually passes the SPF/DKIM/DMNARC/CompAuth. However the blob URL has a URL detonation reputation. Using the below KQL to reverse find all the malicious mail domains that are sending blob phishing URLs and block these mail domains at the Tenant Block List.\n\nEmailUrlInfo\n| where TimeGenerated \u003e ago(90d)\n| where Url contains \"web.core.windows.net/\"\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\"\n| where DeliveryAction == \"Blocked\"\n| summarize Count=count() by SenderFromDomain\n| sort by Count desc"
  },
  {
    "source": "SlimKQL",
    "name": "Threat Hunting AzureHound Usage",
    "query": "// Threat Hunting AzureHound Usage\n\n// Tool Profile: AzureHound framework\n// Link: https://security.microsoft.com/threatanalytics3/ec964e9b-f365-4dc3-b5b4-44f1532198b5/\n// The DefenderXDR portal has just released a Threat Analytics Report on the AzureHound Framework. AzureHound, part of the BloodHoundAD project on GitHub, is the official tool for collecting Azure data for BloodHound and BloodHound Enterprise. This command-line tool, which can be built from source, is utilized for both offensive and defensive security testing. The report includes two advanced hunting queries focused on AzureHound cmdlets and reconnaissance activities using network logs. Additionally, I have contributed another KQL query to GitHub for detecting AzureHound usage, which is not included in the Threat Analytics Report.\n\nMicrosoftGraphActivityLogs\n| where TimeGenerated \u003e ago(90d)\n| where UserAgent has \"azurehound\"\n| extend ObjectID = iff(isempty(UserId), ServicePrincipalId, UserId)\n| join kind=leftouter IdentityInfo on $left.ObjectID == $right.AccountObjectId\n| where isnotempty(AccountUPN)\n| project-reorder TimeGenerated, AppId, IPAddress, AccountUPN, AccountCreationTime, AssignedRoles, ServicePrincipalId, RequestId, RequestMethod, ResponseStatusCode, RequestUri, ResponseSizeBytes, Roles\n\n// MITRE ATT\u0026CK Mapping\n\n// T1078 - Valid Accounts: The query filters logs based on user agents and identity information, which can help identify the use of valid accounts.\n// T1087 - Account Discovery: By joining with identity information and filtering based on AccountUPN, the query can help in discovering accounts.\n// T1071 - Application Layer Protocol: The RequestUri and RequestMethod fields can be used to analyze communication patterns, which is relevant to application layer protocols.\n// T1040 - Network Sniffing: The IPAddress field can be used to detect network sniffing activities.\n// T1057 - Process Discovery: The UserAgent field can help identify processes or tools used, such as â€œazurehoundâ€."
  },
  {
    "source": "SlimKQL",
    "name": "Threat Hunting Microsoft Sway Quishing",
    "query": "// Threat Hunting Microsoft Sway Quishing\n//  Article: https://thehackernews.com/2024/08/new-qr-code-phishing-campaign-exploits.html\n// This query summarizes all inbound emails from senders whose emails contain URLs with the new sway.cloud.microsoft domain. Additionally, it identifies the URL location (e.g., body, attachment, or QR code). A quick look at the statistics will reveal whether your tenant has been affected by the recent QR code phishing campaign exploiting Microsoft Sway to steal credentials.\n// Prequiste: MDO \n\nEmailUrlInfo\n| where TimeGenerated \u003e ago(90d)\n| join EmailEvents on NetworkMessageId\n| where EmailDirection == \"Inbound\" \n| where Url startswith \"https://sway.cloud.microsoft\"\n| summarize Count=count() by SenderFromAddress, UrlLocation\n| sort by Count desc \n\n// MITRE ATT\u0026CK Mapping\n\n// Initial Access Techniques:\n// T1078.004 (Valid Accounts - Cloud Accounts): Detection related to cloud accounts.\n// T1190 (Exploit Public-Facing Application): Detecting exploits on internet-facing devices.\n// T1566.001 (Phishing - Spearphishing Attachment): Monitoring email attachments.\n// T1566.002 (Phishing - Spearphishing Link): Analyzing safe links in emails."
  },
  {
    "source": "SlimKQL",
    "name": "Threat Hunting Mshta with Sentinel TI",
    "query": "// Threat Hunting Mshta with Sentinel TI\n\nlet QueryPeriod = 1d;\nlet T1218IOC =\nThreatIntelIndicators\n| where TimeGenerated \u003e ago(365d)\n| where now() between (ValidFrom .. ValidUntil)\n| where isnotempty(Data.labels)\n| mv-expand Data.labels\n| where Data_labels has \"mitre\"\n| extend MitreID = parse_json(tostring(Data_labels)).Alias \n| where MitreID == \"T1218.005\";\nlet NetworkTraffic =\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(QueryPeriod)\n| where ActionType == \"ConnectionSuccess\"\n| join T1218IOC on ($left.RemoteIP == $right.ObservableValue);\nlet EmailURL =\nEmailUrlInfo\n| where TimeGenerated \u003e ago(QueryPeriod)\n| join T1218IOC on $left.Url == $right.ObservableValue;\nDeviceFileEvents\n| where TimeGenerated \u003e ago(QueryPeriod)\n| join T1218IOC on $left.SHA256 == $right.ObservableValue\n| union NetworkAccessTraffic, EmailURL"
  },
  {
    "source": "SlimKQL",
    "name": "Threat Hunting Nation State Actors",
    "query": "//Threat Hunting Nation State Actors\n//https://www.linkedin.com/feed/update/urn:li:activity:7173156446581219328/\n\n//In view of recent security updates from Microsoft on the January breach by Midnight Blizzard, for those on Microsoft Entra ID P2 you can also use Signin log's riskEventsTypes_v2 to threat hunt for possible nation state actors involvement on your Entra tenant by using below KQL query.\n\nSigninLogs\n| where TimeGenerated \u003e ago(90d)\n| extend V2Risk = tostring(RiskEventTypes_V2)\n| where V2Risk contains \"estsRiskStateP\"\n\n\n// MITRE ATT\u0026CK Mapping\n\n// The query focuses on filtering sign-in logs based on risk events, which can be associated with the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts: Monitoring sign-in logs helps detect the use of valid accounts by adversaries1.\n// T1110 - Brute Force: Risk events related to sign-ins can indicate brute force attempts1.\n// T1190 - Exploit Public-Facing Application: Sign-in attempts might be part of exploiting public-facing applications1.\n// T1071 - Application Layer Protocol: Sign-in logs can reveal the use of application layer protocols for command and control1."
  },
  {
    "source": "SlimKQL",
    "name": "Threat Intelligence Data from Sentinel UEBA",
    "query": "// Threat Intelligence Data from Sentinel UEBA\n// https://www.linkedin.com/posts/activity-7199353581236338689-AJdl/\n\n// The following KQL query extracts threat intelligence data for Entra users with a score of 5 or higher. This data helps you visualize the types of threats your cloud environment might be facing.\n\n//Here's what you can potentially expect to uncover:\n//- Scanner IP addresses\n//- Malicious activity identified by honeypots\n//- Microsoft Deep Research threat intelligence\n//- Command and Control (C2) server communication attempts\n//- Port scans\n//- Phishing attempts\n//- Distributed Denial-of-Service (DDoS) attacks\n//- Hacking tools\n//- Compromised Entra credential activity\n//- Brute-force attacks\n//- Remote Code Execution (RCE) vulnerabilities\n//- Email spam campaigns\n//- Spoofing attempts\n\n//By analyzing this threat intelligence, you can gain valuable insights and take steps to protect your cloud environment. ðŸ«¡\n\n//KQL Code:\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| where DevicesInsights contains \"ThreatIntelIndicatorType\"\n| extend ThreatIntel=tostring(DevicesInsights.ThreatIntelIndicatorDescription)\n| where InvestigationPriority \u003e 5\n| distinct ThreatIntel\n\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the KQL code, the following MITRE ATT\u0026CK techniques might be relevant:\n\n// Tactic: Reconnaissance\n// Technique: Gather Victim Host Information (T1592)\n// The query looks for threat intelligence indicators, which could include information about victim hosts.\n// Tactic: Initial Access\n// Technique: Drive-by Compromise (T1189)\n// Threat intelligence indicators might include information about initial access methods like drive-by compromises.\n// Tactic: Execution\n// Technique: Command and Scripting Interpreter (T1059)\n// The presence of threat intelligence indicators could suggest the use of scripting for execution.\n// Tactic: Persistence\n// Technique: Account Manipulation (T1098)\n// High investigation priority records might indicate attempts to manipulate accounts for persistence.\n// Tactic: Defense Evasion\n// Technique: Indicator Removal on Host (T1070)\n//Filtering for high-priority investigations could reveal attempts to evade detection by removing indicators.\n// Tactic: Collection\n// Technique: Data from Local System (T1005)\n// Threat intelligence indicators might include data collection activities from local systems.\n// Tactic: Exfiltration\n// Technique: Exfiltration Over C2 Channel (T1041)\n// High-priority investigations could indicate exfiltration activities over command and control channels."
  },
  {
    "source": "SlimKQL",
    "name": "Threat Intelligence Data from Sentinel UEBA2",
    "query": "// Threat Intelligence Data from Sentinel UEBA\n// https://www.linkedin.com/posts/activity-7216452632528183298-MPGG/\n\n// Are you curious to know which ISP in the world is brute force attacking your Entra tenant the most in the past 90 days? ðŸ¤” If you have Sentinel UEBA enabled, the below KQL query will tell you the answer. I was rather surprised to see my no. 1 brute force attacker ISP when the KQL query gave me answer. ðŸ˜…\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(90d)\n| where DevicesInsights contains \"ThreatIntelIndicatorType\"\n| extend ISP = tostring(DevicesInsights.ISP)\n| extend BruteForcer = tostring(ActivityInsights.UnusualNumberOfDistinctUsersFailedSignInFromIPAddress)\n| where BruteForcer == \"True\"\n| where ISP != \"\"\n| summarize Count=count() by ISP\n| sort by Count desc\n\n// MITRE ATT\u0026CK Mapping\n\n// Based on the analysis, the KQL query is primarily focused on detecting brute force attacks. Here are the relevant MITRE ATT\u0026CK techniques:\n\n// Brute Force:\n// Technique ID: T1110\n// Description: Adversaries may use brute force techniques to attempt to gain access to accounts by systematically guessing passwords.\n// Indicator of Compromise (IOC):\n// Technique ID: T1071\n// Description: This involves detecting indicators of compromise, such as unusual numbers of failed sign-ins from a single IP address.\n// Data from Information Repositories:\n// Technique ID: T1213\n// Description: This involves extracting and analyzing data from information repositories, such as threat intelligence indicators."
  },
  {
    "source": "SlimKQL",
    "name": "Top 10 Most Sprayed UPNs by IPs and Countries using BehaviourAnalytics",
    "query": "// Top 10 Most Sprayed UPNs by IPs and Countries using BehaviourAnalytics\n\n// In the past week, my Entra tenant password spray attacks have spiked, originating from IPs marked as â€œBruteforceâ€, â€œBotnetâ€, and â€œWatchlistâ€ in BehaviourAnalytics. This observation can be easily seen from the Entra - Overview blade - Monitoring (Sign-ins) graph. Out of curiosity, I constructed the below KQL query to examine the top 10 most attacked UPNs, and the results for these top 10 UPN attacks are always consistent from approximately 96 unique IP addresses from around 66 countries. ðŸ’¡ Now, associating these IPs with a new named location, create a CA to enforce grant access with conditions: Require Microsoft Entra hybrid joined device, Require multifactor authentication, and Require authentication strength (passwordless MFA) to mitigate the sign-in risk and ensure business as usual for Entra usersâ€™ login while lowering the risk.\n\nBehaviorAnalytics\n| where TimeGenerated \u003e ago(7d)\n| where ActivityType == \"FailedLogOn\" and EventSource == \"Azure AD\"\n| where DevicesInsights has \"ThreatIntelIndicatorType\"\n| extend ThreatType = tostring(DevicesInsights.ThreatIntelIndicatorType)\n| where InvestigationPriority \u003e 0\n| where ThreatType has \"Bruteforce\" or ThreatType has \"Botnet\" or ThreatType has \"Watchlist\"\n| summarize NumofIPAttack=dcount(SourceIPAddress), NumofCountryAttack=dcount(SourceIPLocation) by UserPrincipalName\n| top 10 by NumofIPAttack desc\n\n//The MITRE ATT\u0026CK technique for password spray attacks is T1110.0031"
  },
  {
    "source": "SlimKQL",
    "name": "Tracking Proton66 Activity with KQL",
    "query": "// https://thehackernews.com/2025/04/hackers-abuse-russian-bulletproof-host.html\n\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(90d)\n| where ipv4_is_in_any_range(RemoteIP, '45.135.232.0/24', '91.212.166.0/24', '193.143.1.0/24', '45.140.17.0/24', '45.134.26.0/24')\n| where ActionType has \"ConnectionSuccess\" or ActionType has \"InboundConnectionAccepted\"\n| summarize NoOfHits=count() by DeviceName, ActionType, RemoteIP\n| sort by NoOfHits desc"
  },
  {
    "source": "SlimKQL",
    "name": "Uncovering Fast Flux with Sentinel Threat Intelligence",
    "query": "// https://www.cisa.gov/news-events/cybersecurity-advisories/aa25-093a\n\nlet FastFlux =\nThreatIntelIndicators\n| where TimeGenerated \u003e ago(365d)\n| where now() between (ValidFrom .. ValidUntil)\n| where isnotempty(Data.labels)\n| mv-expand Data.labels\n| where Data_labels has \"mitre\"\n| extend MitreID = parse_json(tostring(Data_labels)).Alias\n| where MitreID == \"T1568.001\"\n| project ObservableValue;\nDeviceNetworkEvents\n| where TimeGenerated \u003e ago(1h)\n| where ActionType == \"DnsConnectionInspected\"\n| where AdditionalFields.direction == \"Out\"\n| where AdditionalFields.query has_any (FastFlux)"
  },
  {
    "source": "SlimKQL",
    "name": "Understanding Sentinel password spray data with Copilot for Microsoft 365",
    "query": "//Understanding Sentinel password spray data with Copilot for Microsoft 365\n//https://www.linkedin.com/pulse/understanding-sentinel-password-spray-data-copilot-microsoft-lim-i7o3c/\n\nSigninLogs\n| where TimeGenerated \u003e ago(1d)\n| where ResultType == \"50126\" \n// ResultType == \"50053\" - Account is locked because user tried to sign in too many times with an incorrect user ID or password.\n// ResultType == \"50053\" - Sign-in was blocked because it came from an IP address with malicious activity\n// ResultType == \"50126\" - Invalid username or password or Invalid on-premise username or password.\n| extend City = tostring(LocationDetails.city)\n| extend State = tostring(LocationDetails.state)\n| extend Country = tostring(LocationDetails.countryOrRegion)\n| project TimeGenerated, UserPrincipalName, ResultType, ResultDescription, Country, State, City, AppDisplayName, ClientAppUsed, UserAgent\n\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL query is primarily focused on detecting failed sign-in attempts due to invalid credentials. This can be mapped to the following MITRE ATT\u0026CK techniques:\n\n// T1078 - Valid Accounts:\n// Description: Adversaries may use valid accounts to maintain access to victim systems. Valid accounts may be used to bypass access controls placed on various resources.\n// Detection: Monitoring for failed authentication attempts can help identify attempts to use stolen or guessed credentials.\n// T1110 - Brute Force:\n// Description: Adversaries may use brute force techniques to attempt to gain access to accounts by guessing passwords.\n// Detection: Monitoring for multiple failed authentication attempts can help identify brute force attempts.\n// T1071 - Application Layer Protocol:\n// Description: Adversaries may use application layer protocols to communicate with systems under their control.\n// Detection: Monitoring for unusual or unauthorized use of application layer protocols can help identify malicious activity."
  },
  {
    "source": "SlimKQL",
    "name": "Using GraphPreConsentExplorer data for Microsoft Graph Threat Hunting",
    "query": "// Using GraphPreConsentExplorer data for Microsoft Graph Threat Hunting\n\nlet GraphPreConsent=externaldata(Name:string, Client_Id:string, Enabled:string, Graph_api_permissions:string, \nAuth_code:string, Device_code:string, Brk_refresh:string, Foci:string, Reply_addresses:string)\n[h'https://raw.githubusercontent.com/SlimKQL/Hunting-Queries-Detection-Rules/refs/heads/main/IOC/GraphPreConsent.csv'];\n//\n// Microsoft Graph Threat Hunting\n// \nMicrosoftGraphActivityLogs\n| join GraphPreConsent on $left.AppId == $right.Client_Id\n// Threat hunting Query"
  },
  {
    "source": "SlimKQL",
    "name": "Visualize Entra Password Spray Attack with ADX Interactive Map",
    "query": "//Visualize Entra Password Spray Attack with ADX Interactive Map\n//https://www.linkedin.com/pulse/visualize-entra-password-spray-attack-adx-interactive-steven-lim-dfonc/\n\n//For those interested in visualizing password spray attack on the top picture chart, you can use the below KQL and view in \"Chart\" mode.\n\nSigninLogs\n| where TimeGenerated \u003e ago(7d)\n| where ResultType == \"50053\" or ResultType == \"50126\"\n| summarize PasswordSpray_Per_HalfHour=count() by bin (TimeGenerated, 30m)\n\n//Replace the above blog's KQL with the below KQL to visualize Password Spray Attack locations.\n\n SigninLogs\n| where TimeGenerated \u003e ago(7d)\n| where ResultType == \"50053\" or ResultType == \"50126\"\n| where isnotempty(LocationDetails.geoCoordinates)\n| extend Latitude = toreal(LocationDetails.geoCoordinates[\"latitude\"])\n| extend Longitude = toreal(LocationDetails.geoCoordinates[\"longitude\"])\n| summarize Count = count() by Longitude, Latitude\n| project Longitude, Latitude, Count\n| render scatterchart with (kind=map)\n\n\n// MITRE ATT\u0026CK Mapping\n\n// The KQL code you provided is designed to detect and visualize password spray attacks. Hereâ€™s a breakdown of the associated MITRE ATT\u0026CK techniques:\n\n// Password Spray Detection:\n// T1110.003 - Brute Force: Password Spraying: This technique involves attempting to gain unauthorized access to accounts by trying a few common passwords against many accounts. The first part of your KQL code detects password spray attacks by looking for specific result types (50053 and 50126) and summarizing the count of these events in 30-minute intervals.\n// Geolocation of Password Spray Attacks:\n// T1078 - Valid Accounts: The second part of your KQL code extends the detection by adding geolocation data to visualize where these password spray attempts are coming from. This helps in identifying potential sources of the attacks and can be useful for further investigation and response."
  }
]